<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />

    <!-- PWA ÈÖçÁΩÆ -->
    <link rel="manifest" href="manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="PinkyPhone" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#fce4ec" />

    <!-- ‰∏ªÂ±èÂπïÂõæÊ†á -->
    <link
      rel="apple-touch-icon"
      href="https://i.postimg.cc/8kmQwCr0/IMG-2897.jpg"
    />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="https://i.postimg.cc/8kmQwCr0/IMG-2897.jpg"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="https://i.postimg.cc/8kmQwCr0/IMG-2897.jpg"
    />
    <link
      rel="icon"
      type="image/png"
      href="https://i.postimg.cc/8kmQwCr0/IMG-2897.jpg"
    />

    <title>PinkyPhone</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=Satisfy&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js?v=1.4"></script>

    <!-- Â§ñÈÉ®Ê†∑ÂºèË°® -->
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="moment-instagram.css" />
    <link rel="stylesheet" href="music_together.css" />
    <link rel="stylesheet" href="phone_peek.css" />
    <link rel="stylesheet" href="continue_chat.css" />
    <link rel="stylesheet" href="forum_app.css" />
  </head>
  <body>
    <!-- Decorative stars -->
    <div class="star star-1"></div>
    <div class="star star-2"></div>
    <div class="star star-3"></div>
    <div class="star star-4"></div>
    <div class="star star-5"></div>

    <div class="phone-container">
      <div class="main-content">
        <div class="profile-widget-new">
          <div class="profile-bg-container" onclick="triggerBgUpload()">
            <img
              id="userProfileBg"
              src="https://images.unsplash.com/photo-1490750967868-58cb75069ed6?auto=format&fit=crop&w=800&q=80"
              alt="ËÉåÊôØÂ¢ô"
            />
            <div class="bg-edit-hint">ÁÇπÂáªÊõ¥Êç¢ËÉåÊôØ</div>
          </div>

          <div class="profile-info-card">
            <div class="profile-avatar-wrapper" onclick="triggerAvatarUpload()">
              <img
                id="userProfileAvatar"
                src='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üê∞</text></svg>'
                alt="Â§¥ÂÉè"
              />
            </div>

            <div
              class="profile-name-large"
              id="userNameDisplay"
              onclick="editUserName()"
            >
              ‰Ω†ÁöÑÂêçÂ≠ó
            </div>

            <div
              class="profile-bio-text"
              id="userBioDisplay"
              onclick="editUserBio()"
            >
              ÁÇπÂáªËøôÈáåËÆæÁΩÆ‰Ω†ÁöÑ‰∏™ÊÄßÁ≠æÂêç...
            </div>

            <div class="profile-location" onclick="editUserLocation()">
              <svg
                class="location-icon"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M12 13.43a3.12 3.12 0 1 0 0-6.24 3.12 3.12 0 0 0 0 6.24Z"
                  stroke="currentColor"
                  stroke-width="1.5"
                />
                <path
                  d="M3.62 8.49c1.97-8.66 14.8-8.65 16.76 0 1.15 5.08-2.01 9.38-4.78 12.04a5.193 5.193 0 0 1-7.2 0C5.63 17.87 2.47 13.57 3.62 8.49Z"
                  stroke="currentColor"
                  stroke-width="1.5"
                />
              </svg>
              <span id="userLocationDisplay">Ê∑ªÂä†ÂÆö‰Ωç</span>
            </div>
          </div>

          <input
            type="file"
            id="bgInput"
            hidden
            accept="image/*"
            onchange="handleBgChange(this)"
          />
          <input
            type="file"
            id="avatarInput"
            hidden
            accept="image/*"
            onchange="handleAvatarChange(this)"
          />
        </div>

        <!-- Apps -->
        <div class="apps-section">
          <div class="apps-grid">
            <!-- ÊÅãÁà±Á∫™ÂøµÊó•Â∞èÁªÑ‰ª∂ (2x2) - Â∑¶‰∏äËßí -->
            <div
              class="love-widget widget-2x2"
              id="loveWidget"
              onclick="handleLoveWidgetClick(event)"
            >
              <div class="love-widget-bg" id="loveWidgetBg"></div>
              <div
                class="love-days-row"
                onclick="openLoveEditModal('startDate')"
              >
                <span class="love-days-number" id="loveDaysNumber">0</span>
                <span class="love-days-unit">Â§©</span>
              </div>

              <div class="love-avatars-row">
                <div
                  class="love-avatar"
                  onclick="document.getElementById('loveAvatar1Input').click()"
                >
                  <img
                    class="love-avatar-placeholder-img"
                    id="loveAvatar1Placeholder"
                    src="https://www.yn12377.cn/jubao/upload/smjb/2025/12/28/b7957012b29e42bdbf237cb27f46bb91.jpg"
                  />
                  <img id="loveAvatar1Img" src="" style="display: none" />
                </div>
                <div
                  class="love-avatar"
                  onclick="document.getElementById('loveAvatar2Input').click()"
                >
                  <img
                    class="love-avatar-placeholder-img"
                    id="loveAvatar2Placeholder"
                    src="https://www.yn12377.cn/jubao/upload/smjb/2025/12/28/b7957012b29e42bdbf237cb27f46bb91.jpg"
                  />
                  <img id="loveAvatar2Img" src="" style="display: none" />
                </div>
              </div>
              <input
                type="file"
                id="loveAvatar1Input"
                class="hidden-input"
                accept="image/*"
                onchange="handleLoveAvatarUpload(1, this)"
              />
              <input
                type="file"
                id="loveAvatar2Input"
                class="hidden-input"
                accept="image/*"
                onchange="handleLoveAvatarUpload(2, this)"
              />
              <input
                type="file"
                id="loveWidgetBgInput"
                class="hidden-input"
                accept="image/*"
                onchange="handleLoveWidgetBgUpload(this)"
              />

              <div class="love-title-row" onclick="openLoveEditModal('title')">
                <span class="love-title-text" id="loveTitleText">ÊÅãÁà±Á∫™Âøµ</span>
              </div>

              <div
                class="love-date"
                id="loveDateText"
                onclick="openLoveEditModal('startDate')"
              >
                2024.01.01
              </div>
            </div>

            <!-- Âè≥‰∏äËßí4‰∏™App -->
            <div class="app-item" onclick="openPage('chatPage')">
              <div class="app-icon gradient-pink">ËÅäÂ§©</div>
              <span class="app-name">ËÅäÂ§©</span>
            </div>
            <div class="app-item" onclick="openPage('worldbookPage')">
              <div class="app-icon gradient-green">‰∏ñÁïå‰π¶</div>
              <span class="app-name">‰∏ñÁïå‰π¶</span>
            </div>
            <div class="app-item" onclick="openPage('presetPage')">
              <div class="app-icon gradient-orange">È¢ÑËÆæ</div>
              <span class="app-name">È¢ÑËÆæ</span>
            </div>
            <div class="app-item" onclick="openPage('forumPage')">
              <div class="app-icon gradient-purple">ËÆ∫Âùõ</div>
              <span class="app-name">ËÆ∫Âùõ</span>
            </div>

            <!-- Á¨¨‰∏âË°åÔºöÊÉÖ‰æ£„ÄÅÈô™‰º¥Âú®Â∑¶ËæπÔºåÊãçÁ´ãÂæóÂú®Âè≥Ëæπ -->
            <div class="app-item" onclick="openPage('coupleSpacePage')">
              <div class="app-icon gradient-pink">ÊÉÖ‰æ£</div>
              <span class="app-name">ÊÉÖ‰æ£Á©∫Èó¥</span>
            </div>
            <div class="app-item" onclick="openCompanionPage()">
              <div class="app-icon gradient-blue">Èô™‰º¥</div>
              <span class="app-name">Èô™‰º¥</span>
            </div>

            <!-- ÊãçÁ´ãÂæóÂ∞èÁªÑ‰ª∂ (2x2) - Âè≥‰∏ãËßí -->
            <div class="polaroid-widget widget-2x2" id="polaroidWidget">
              <div
                class="polaroid-photo-area"
                onclick="triggerPolaroidUpload()"
              >
                <img
                  id="polaroidImgDisplay"
                  src="https://images.unsplash.com/photo-1516961642265-531546e84af2?auto=format&fit=crop&w=400&q=80"
                  alt="ÊãçÁ´ãÂæó"
                />
              </div>
              <div
                class="polaroid-caption"
                id="polaroidTextDisplay"
                onclick="editPolaroidText(event)"
              >
                My Moment
              </div>
              <input
                type="file"
                id="polaroidInput"
                hidden
                accept="image/*"
                onchange="handlePolaroidChange(this)"
              />
            </div>
          </div>
        </div>
      </div>

      <!-- Pages -->
      <div id="chatPage" class="page chat-app">
        <!-- Chat App Header -->
        <div class="chat-header">
          <button class="back-btn" onclick="closePage('chatPage')">‚Üê</button>
          <h1 class="chat-title" id="chatAppTitle">Message</h1>
          <div class="chat-header-btns">
            <button
              class="chat-header-btn"
              id="createGroupBtn"
              onclick="openCreateGroupModal()"
              title="ÂàõÂª∫Áæ§ËÅä"
            >
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
            </button>
            <button
              class="chat-header-btn"
              id="chatHeaderBtn"
              onclick="handleHeaderBtn()"
            >
              +
            </button>
          </div>
        </div>

        <!-- Chat App Content -->
        <div class="chat-content">
          <!-- Messages Tab -->
          <div class="chat-tab-content active" id="messagesTab">
            <!-- Search bar -->
            <div class="search-bar">
              <span class="search-icon"
                ><svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <circle cx="11" cy="11" r="8"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg
              ></span>
              <input
                type="text"
                placeholder="ÊêúÁ¥¢ËÅäÂ§©ËÆ∞ÂΩï"
                class="search-input"
                id="chatSearchInput"
                oninput="searchChatHistory(this.value)"
              />
            </div>

            <!-- ÊêúÁ¥¢ÁªìÊûú -->
            <div class="search-results" id="searchResults"></div>

            <!-- Message List -->
            <div class="message-list" id="messageList">
              <!-- Empty state -->
              <div class="empty-state" id="emptyMessages">
                <div class="empty-icon">
                  <svg
                    width="48"
                    height="48"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                    ></path>
                  </svg>
                </div>
                <div class="empty-text">ËøòÊ≤°ÊúâÊ∂àÊÅØÂì¶</div>
                <div class="empty-hint">Ê∑ªÂä†AIËßíËâ≤ÂºÄÂßãËÅäÂ§©ÂêßÔΩû</div>
              </div>
            </div>
          </div>

          <!-- Moments Tab (QQÁ©∫Èó¥È£éÊ†ºÂä®ÊÄÅ) -->
          <div class="chat-tab-content" id="momentsTab">
            <!-- ‰∏™‰∫∫ÂêçÁâáÂå∫Âüü -->
            <div class="moment-profile-card">
              <div
                class="moment-cover"
                id="momentCover"
                onclick="changeMomentCover()"
              >
                <img id="momentCoverImg" src="" style="display: none" />
                <button
                  class="moment-cover-back"
                  onclick="event.stopPropagation();switchChatTab('messages')"
                >
                  ‚Äπ
                </button>
                <button
                  class="moment-cover-edit"
                  onclick="event.stopPropagation();changeMomentCover()"
                >
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"
                    ></path>
                    <circle cx="12" cy="13" r="4"></circle>
                  </svg>
                </button>
              </div>
              <div class="moment-profile-info">
                <div class="moment-avatar-row">
                  <div class="moment-avatar-wrap">
                    <div
                      class="moment-avatar"
                      id="momentAvatar"
                      onclick="changeMomentAvatar()"
                    >
                      <span id="momentAvatarEmoji">üòä</span>
                      <img id="momentAvatarImg" src="" style="display: none" />
                    </div>
                    <button
                      class="moment-avatar-edit"
                      onclick="event.stopPropagation();changeMomentAvatar()"
                    >
                      <svg
                        width="10"
                        height="10"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2.5"
                      >
                        <path
                          d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"
                        ></path>
                        <circle cx="12" cy="13" r="4"></circle>
                      </svg>
                    </button>
                  </div>
                  <div class="moment-name-area">
                    <div
                      class="moment-nickname"
                      id="momentNickname"
                      onclick="editMomentNickname()"
                    >
                      Áî®Êà∑
                    </div>
                    <div
                      class="moment-handle"
                      id="momentHandle"
                      onclick="editMomentHandle()"
                    >
                      @username
                    </div>
                  </div>
                </div>
                <div
                  class="moment-signature"
                  id="momentSignature"
                  onclick="editMomentSignature()"
                ></div>
              </div>
            </div>

            <!-- Âä®ÊÄÅÂàóË°® -->
            <div class="ig-feed" id="igFeed">
              <div class="ig-empty-state" id="igEmptyState">
                <div class="ig-empty-icon">
                  <svg
                    width="48"
                    height="48"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <rect
                      x="3"
                      y="3"
                      width="18"
                      height="18"
                      rx="2"
                      ry="2"
                    ></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                  </svg>
                </div>
                <div class="ig-empty-title">ÂàÜ‰∫´‰Ω†ÁöÑÁ≤æÂΩ©Áû¨Èó¥</div>
                <div class="ig-empty-text">ÁÇπÂáªÂè≥‰∏ãËßíÊåâÈíÆÂèëÂ∏ÉÁ¨¨‰∏ÄÊù°Âä®ÊÄÅÂêß~</div>
              </div>
            </div>

            <!-- ÂèëÂ∏ÉÊåâÈíÆ -->
            <button class="ig-fab" onclick="openPostModal()">
              <span class="ig-fab-icon">+</span>
            </button>
          </div>

          <!-- ÂèëÂ∏ÉÂä®ÊÄÅÂºπÁ™ó -->
          <div
            class="ig-post-modal"
            id="igPostModal"
            onclick="if(event.target===this)closePostModal()"
          >
            <div class="ig-post-modal-content">
              <div class="ig-modal-header">
                <button class="ig-modal-close" onclick="closePostModal()">
                  ÂèñÊ∂à
                </button>
                <span class="ig-modal-title">Êñ∞Âä®ÊÄÅ</span>
                <button
                  class="ig-modal-submit"
                  id="igPostSubmit"
                  onclick="submitPost()"
                  disabled
                >
                  ÂèëÂ∏É
                </button>
              </div>
              <div class="ig-modal-body">
                <textarea
                  class="ig-post-textarea"
                  id="igPostText"
                  placeholder="ÂàÜ‰∫´‰Ω†ÁöÑÊÉ≥Ê≥ï..."
                  oninput="checkPostValid()"
                ></textarea>
                <div class="ig-image-options">
                  <div
                    class="ig-image-option"
                    onclick="selectImageOption('album')"
                    id="imgOptionAlbum"
                  >
                    <span class="ig-image-option-icon"
                      ><svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <rect
                          x="3"
                          y="3"
                          width="18"
                          height="18"
                          rx="2"
                          ry="2"
                        ></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline></svg
                    ></span>
                    <span class="ig-image-option-text">‰ªéÁõ∏ÂÜåÈÄâÊã©</span>
                  </div>
                  <div
                    class="ig-image-option"
                    onclick="selectImageOption('text')"
                    id="imgOptionText"
                  >
                    <span class="ig-image-option-icon"
                      ><svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                        <path
                          d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"
                        ></path>
                        <path d="M2 2l7.586 7.586"></path>
                        <circle cx="11" cy="11" r="2"></circle></svg
                    ></span>
                    <span class="ig-image-option-text">ÊñáÂ≠óÈÖçÂõæ</span>
                  </div>
                </div>
                <input
                  type="file"
                  id="igImageInput"
                  accept="image/*"
                  style="display: none"
                  onchange="handleImageSelect(event)"
                />
                <input
                  type="text"
                  class="ig-text-img-input"
                  id="igTextImgInput"
                  placeholder="ËæìÂÖ•ÂõæÁâáÊèèËø∞ÔºåAIÂ∞ÜÁúãÂà∞Ëøô‰∏™ÊèèËø∞..."
                  oninput="checkPostValid()"
                />
                <div class="ig-image-preview" id="igImagePreview">
                  <img id="igPreviewImg" src="" alt="" />
                  <span class="ig-image-preview-remove" onclick="removeImage()"
                    ><svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    ÁßªÈô§ÂõæÁâá</span
                  >
                </div>

                <!-- ÂèØËßÅËåÉÂõ¥ÈÄâÊã© -->
                <div class="ig-visibility-section">
                  <div class="ig-visibility-label">
                    <svg
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                      ></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    Ë∞ÅÂèØ‰ª•Áúã
                  </div>
                  <div class="ig-visibility-options" id="visibilityOptions">
                    <div
                      class="ig-visibility-option selected"
                      data-value="all"
                      onclick="selectVisibility('all', this)"
                    >
                      <span class="check-icon">‚úì</span> ÂÖ¨ÂºÄ
                    </div>
                    <!-- ÂàÜÁªÑÈÄâÈ°π‰ºöÈÄöËøáJSÂä®ÊÄÅÊ∏≤Êüì -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ‰∏™‰∫∫ËµÑÊñôÁºñËæëÂºπÁ™ó -->
          <div
            class="ig-profile-modal"
            id="igProfileModal"
            onclick="if(event.target===this)closeProfileModal()"
          >
            <div class="ig-profile-modal-content">
              <div class="ig-profile-modal-header">
                <span class="ig-profile-modal-title">ÁºñËæë‰∏™‰∫∫ËµÑÊñô</span>
                <button
                  class="ig-profile-modal-close"
                  onclick="closeProfileModal()"
                >
                  ‚úï
                </button>
              </div>
              <div class="ig-profile-modal-body">
                <div class="ig-profile-avatar-edit">
                  <div class="ig-profile-avatar-preview" id="igAvatarPreview">
                    A
                  </div>
                  <div class="ig-profile-avatar-btns">
                    <button
                      class="ig-profile-avatar-btn"
                      onclick="document.getElementById('igAvatarInput').click()"
                    >
                      ‰∏ä‰º†ÁÖßÁâá
                    </button>
                    <button
                      class="ig-profile-avatar-btn"
                      onclick="openEmojiPicker()"
                    >
                      ÈÄâÊã©Ë°®ÊÉÖ
                    </button>
                  </div>
                  <input
                    type="file"
                    id="igAvatarInput"
                    accept="image/*"
                    style="display: none"
                    onchange="handleAvatarSelect(event)"
                  />
                </div>
                <div class="ig-profile-form-group">
                  <label class="ig-profile-form-label">ÊòµÁß∞</label>
                  <input
                    type="text"
                    class="ig-profile-form-input"
                    id="igEditName"
                    placeholder="ËæìÂÖ•‰Ω†ÁöÑÊòµÁß∞"
                  />
                </div>
                <div class="ig-profile-form-group">
                  <label class="ig-profile-form-label">Áî®Êà∑Âêç</label>
                  <input
                    type="text"
                    class="ig-profile-form-input"
                    id="igEditHandle"
                    placeholder="@username"
                  />
                </div>
                <div class="ig-profile-form-group">
                  <label class="ig-profile-form-label">‰∏™ÊÄßÁ≠æÂêç</label>
                  <textarea
                    class="ig-profile-form-textarea"
                    id="igEditBio"
                    placeholder="ÂÜôÁÇπ‰ªÄ‰πà‰ªãÁªç‰∏Ä‰∏ãËá™Â∑±Âêß~"
                  ></textarea>
                </div>
                <button class="ig-profile-save-btn" onclick="saveProfile()">
                  ‰øùÂ≠ò
                </button>
              </div>
            </div>
          </div>

          <!-- ËØÑËÆ∫ÂºπÁ™ó -->
          <div
            class="ig-comments-modal"
            id="igCommentsModal"
            onclick="if(event.target===this)closeCommentsModal()"
          >
            <div class="ig-comments-modal-content">
              <div class="ig-comments-header">
                <span class="ig-comments-title">ËØÑËÆ∫</span>
                <button
                  class="ig-comments-close"
                  onclick="closeCommentsModal()"
                >
                  ‚úï
                </button>
              </div>
              <div class="ig-comments-list" id="igCommentsList">
                <!-- ËØÑËÆ∫‰ºöÂä®ÊÄÅÊ∏≤Êüì -->
              </div>
              <div class="ig-comments-input-area">
                <input
                  type="text"
                  class="ig-comments-input"
                  id="igCommentInput"
                  placeholder="Ê∑ªÂä†ËØÑËÆ∫..."
                />
                <button class="ig-comments-send" onclick="sendComment()">
                  ÂèëÈÄÅ
                </button>
              </div>
            </div>
          </div>

          <!-- ËΩ¨ÂèëÈÄâÊã©ÂºπÁ™ó -->
          <div
            class="ig-share-modal"
            id="igShareModal"
            onclick="if(event.target===this)closeShareModal()"
          >
            <div class="ig-share-modal-content">
              <div class="ig-share-header">
                <span class="ig-share-title">ËΩ¨ÂèëÁªô</span>
                <button class="ig-share-close" onclick="closeShareModal()">
                  ‚úï
                </button>
              </div>
              <div class="ig-share-list" id="igShareList">
                <!-- ËßíËâ≤ÂàóË°®‰ºöÂä®ÊÄÅÊ∏≤Êüì -->
              </div>
            </div>
          </div>

          <!-- Âä®ÊÄÅÊìç‰ΩúËèúÂçï -->
          <div
            class="ig-post-menu"
            id="igPostMenu"
            onclick="if(event.target===this)closePostMenu()"
          >
            <div class="ig-post-menu-content">
              <div class="ig-post-menu-item" onclick="deletePost()">
                <span class="ig-post-menu-icon"
                  ><svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path
                      d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                    ></path></svg
                ></span>
                <span>Âà†Èô§Âä®ÊÄÅ</span>
              </div>
              <div class="ig-post-menu-cancel" onclick="closePostMenu()">
                ÂèñÊ∂à
              </div>
            </div>
          </div>

          <!-- Todo Tab - ÁÆÄÁ∫¶ËÆæËÆ° -->
          <div class="chat-tab-content" id="todoTab">
            <div class="todo-container">
              <!-- Â§¥ÈÉ® -->
              <div class="todo-header">
                <div class="todo-header-left">
                  <div class="todo-date-card">
                    <div class="todo-date-day" id="todoDateDay">1</div>
                    <div class="todo-date-info" id="todoDateInfo">1Êúà Âë®‰∏â</div>
                  </div>
                  <div class="todo-greeting">
                    <div class="todo-greeting-main" id="todoGreeting">
                      ‰ªäÂ§©‰πüË¶ÅÂä†Ê≤π
                    </div>
                    <div class="todo-greeting-sub" id="todoGreetingSub">
                      Êñ∞ÁöÑ‰∏ÄÂ§©ÔºåÊñ∞ÁöÑÂºÄÂßã
                    </div>
                  </div>
                </div>
              </div>

              <!-- ÁªüËÆ° -->
              <div class="todo-stats">
                <div class="todo-stat-item">
                  <div class="todo-stat-num" id="todoStatTotal">0</div>
                  <div class="todo-stat-label">ÂÖ®ÈÉ®</div>
                </div>
                <div class="todo-stat-item">
                  <div class="todo-stat-num" id="todoStatDone">0</div>
                  <div class="todo-stat-label">ÂÆåÊàê</div>
                </div>
                <div class="todo-stat-item">
                  <div class="todo-stat-num" id="todoStatPending">0</div>
                  <div class="todo-stat-label">ÂæÖÂäû</div>
                </div>
              </div>

              <!-- Á≠õÈÄâÊ†è -->
              <div class="todo-filter-bar" id="todoFilterBar">
                <!-- Âä®ÊÄÅÊ∏≤Êüì -->
              </div>

              <!-- ÂæÖÂäûÂàóË°® -->
              <div class="todo-list" id="todoListContainer">
                <!-- Âä®ÊÄÅÊ∏≤Êüì -->
              </div>

              <!-- Ê∑ªÂä†ÊåâÈíÆ -->
              <button class="todo-add-btn" onclick="openTodoModal()">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                Ê∑ªÂä†ÂæÖÂäû
              </button>

              <!-- AIÁù£‰øÉÂå∫Âüü -->
              <div class="todo-ai-section">
                <div class="todo-ai-header">
                  <div class="todo-ai-icon">
                    <svg
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
                      ></path>
                      <circle cx="9" cy="7" r="4"></circle>
                      <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                      <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                  </div>
                  <div>
                    <div class="todo-ai-title">Áù£‰øÉÂä©Êâã</div>
                    <div class="todo-ai-subtitle">ÈÄâÊã©ËßíËâ≤Êù•Áù£‰øÉ‰Ω†ÂÆåÊàêÂæÖÂäû</div>
                  </div>
                </div>
                <div class="todo-ai-list" id="todoAiCharList">
                  <!-- Âä®ÊÄÅÊ∏≤Êüì -->
                </div>
              </div>
            </div>
          </div>

          <!-- Ê∑ªÂä†ÂæÖÂäûÂºπÁ™ó -->
          <div
            class="todo-modal-overlay"
            id="todoModalOverlay"
            onclick="if(event.target===this)closeTodoModal()"
          >
            <div class="todo-modal">
              <div class="todo-modal-header">
                <div class="todo-modal-title">
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  Ê∑ªÂä†ÂæÖÂäû
                </div>
                <button class="todo-modal-close" onclick="closeTodoModal()">
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              <div class="todo-modal-body">
                <div class="todo-input-group">
                  <label class="todo-input-label">ÂæÖÂäûÂÜÖÂÆπ</label>
                  <input
                    type="text"
                    class="todo-input"
                    id="todoInputText"
                    placeholder="Ë¶ÅÂÅö‰ªÄ‰πàÔºü"
                    maxlength="100"
                  />
                </div>
                <div class="todo-input-group">
                  <label class="todo-input-label">ÈÄâÊã©ÂàÜÁ±ª</label>
                  <div class="todo-category-grid" id="todoTagSelect">
                    <!-- Âä®ÊÄÅÊ∏≤Êüì -->
                  </div>
                </div>
                <div class="todo-input-group">
                  <label class="todo-input-label">ÈáçÂ§çÂë®Êúü</label>
                  <div class="todo-repeat-grid" id="todoRepeatSelect">
                    <div
                      class="todo-repeat-item selected"
                      data-repeat="none"
                      onclick="selectTodoRepeat(this)"
                    >
                      <div class="todo-repeat-name">‰∏çÈáçÂ§ç</div>
                    </div>
                    <div
                      class="todo-repeat-item"
                      data-repeat="daily"
                      onclick="selectTodoRepeat(this)"
                    >
                      <div class="todo-repeat-name">ÊØèÂ§©</div>
                    </div>
                    <div
                      class="todo-repeat-item"
                      data-repeat="weekday"
                      onclick="selectTodoRepeat(this)"
                    >
                      <div class="todo-repeat-name">Â∑•‰ΩúÊó•</div>
                    </div>
                    <div
                      class="todo-repeat-item"
                      data-repeat="weekly"
                      onclick="selectTodoRepeat(this)"
                    >
                      <div class="todo-repeat-name">ÊØèÂë®</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="todo-modal-footer">
                <button class="todo-save-btn" onclick="saveTodoItem()">
                  Ê∑ªÂä†
                </button>
              </div>
            </div>
          </div>

          <!-- ÂæÖÂäûËÆæÁΩÆÂºπÁ™ó -->
          <div
            class="todo-modal-overlay"
            id="todoSettingsOverlay"
            onclick="if(event.target===this)closeTodoSettingsModal()"
          >
            <div class="todo-settings-modal">
              <div class="todo-modal-header">
                <div class="todo-modal-title">
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                      d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                    ></path>
                  </svg>
                  ËÆæÁΩÆ
                </div>
                <button
                  class="todo-modal-close"
                  onclick="closeTodoSettingsModal()"
                >
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              <div class="todo-modal-body">
                <!-- ÈóÆÂÄôËØ≠ËÆæÁΩÆ -->
                <div class="todo-settings-section">
                  <div class="todo-settings-title">ÈóÆÂÄôËØ≠</div>
                  <div class="greeting-preview">
                    <div class="greeting-preview-main" id="greetingPreviewMain">
                      ‰ªäÂ§©‰πüË¶ÅÂä†Ê≤π
                    </div>
                    <div class="greeting-preview-sub" id="greetingPreviewSub">
                      Êñ∞ÁöÑ‰∏ÄÂ§©ÔºåÊñ∞ÁöÑÂºÄÂßã
                    </div>
                  </div>
                  <div class="todo-input-group" style="margin-bottom: 8px">
                    <input
                      type="text"
                      class="todo-input"
                      id="greetingMainInput"
                      placeholder="‰∏ªÈóÆÂÄôËØ≠"
                      maxlength="20"
                    />
                  </div>
                  <div class="todo-input-group" style="margin-bottom: 8px">
                    <input
                      type="text"
                      class="todo-input"
                      id="greetingSubInput"
                      placeholder="ÂâØÊ†áÈ¢òÔºàÂèØÈÄâÔºâ"
                      maxlength="30"
                    />
                  </div>
                  <button
                    class="todo-save-btn"
                    style="padding: 10px; font-size: 0.85rem"
                    onclick="saveGreeting()"
                  >
                    ‰øùÂ≠òÈóÆÂÄôËØ≠
                  </button>
                </div>

                <!-- ÂàÜÁ±ªÁÆ°ÁêÜ -->
                <div class="todo-settings-section">
                  <div class="todo-settings-title">ÂàÜÁ±ªÁÆ°ÁêÜ</div>
                  <div
                    class="todo-category-grid"
                    id="todoCategoryList"
                    style="margin-bottom: 12px"
                  >
                    <!-- Âä®ÊÄÅÊ∏≤Êüì -->
                  </div>
                  <div style="display: flex; gap: 8px">
                    <input
                      type="text"
                      class="todo-input"
                      id="newCategoryName"
                      placeholder="Êñ∞ÂàÜÁ±ªÂêçÁß∞"
                      maxlength="10"
                      style="flex: 1"
                    />
                    <button
                      class="todo-save-btn"
                      style="
                        padding: 10px 16px;
                        font-size: 0.85rem;
                        width: auto;
                      "
                      onclick="addTodoCategory()"
                    >
                      Ê∑ªÂä†
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Profile Tab (ÊàëÁöÑ) -->
          <div class="chat-tab-content" id="profileTab">
            <!-- È°∂Ê†è -->
            <div class="tab-header">
              <button class="tab-header-back" onclick="closePage('chatPage')">
                ‚Üê
              </button>
              <span class="tab-header-title">Me</span>
              <span style="width: 36px"></span>
            </div>
            <!-- Profile Header -->
            <div class="profile-header-card">
              <div class="profile-main">
                <div
                  class="profile-avatar-large"
                  id="meProfileAvatar"
                  onclick="changeMomentAvatar()"
                >
                  <svg
                    width="32"
                    height="32"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="#f48fb1"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                </div>
                <div class="profile-info-main">
                  <div
                    class="profile-name-large"
                    id="meProfileName"
                    onclick="editMomentNickname()"
                  >
                    ÊàëÁöÑÊòµÁß∞
                  </div>
                  <div
                    class="profile-id"
                    id="meProfileHandle"
                    onclick="editMomentHandle()"
                  >
                    @username
                  </div>
                </div>
              </div>
            </div>

            <!-- Profile Menu -->
            <div class="profile-menu">
              <div class="menu-item" onclick="openWalletPage()">
                <span class="menu-icon"
                  ><svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <rect
                      x="1"
                      y="4"
                      width="22"
                      height="16"
                      rx="2"
                      ry="2"
                    ></rect>
                    <line x1="1" y1="10" x2="23" y2="10"></line></svg
                ></span>
                <span class="menu-text">ÊàëÁöÑÈí±ÂåÖ</span>
                <span class="menu-arrow">‚Ä∫</span>
              </div>
              <div class="menu-item" onclick="openFavoritesPage()">
                <span class="menu-icon"
                  ><svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <polygon
                      points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
                    ></polygon></svg
                ></span>
                <span class="menu-text">ÊàëÁöÑÊî∂Ëóè</span>
                <span class="menu-arrow">‚Ä∫</span>
              </div>
              <div class="menu-item" onclick="openBackgroundActivityPage()">
                <span class="menu-icon"
                  ><svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline></svg
                ></span>
                <span class="menu-text">ÂêéÂè∞Ê¥ªÂä®</span>
                <span class="menu-arrow" style="color: #f48fb1">‚Ä∫</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat App Bottom Tab Bar -->
        <div class="chat-tab-bar">
          <div class="chat-tab active" onclick="switchChatTab('messages')">
            <span class="tab-icon"
              ><svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                ></path></svg
            ></span>
            <span class="tab-badge" id="messagesBadge" style="display: none"
              >0</span
            >
            <span class="tab-label">Message</span>
          </div>
          <div class="chat-tab" onclick="switchChatTab('moments')">
            <span class="tab-icon"
              ><svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                <line x1="15" y1="9" x2="15.01" y2="9"></line></svg
            ></span>
            <span class="tab-badge" id="momentsBadge" style="display: none"
              >0</span
            >
            <span class="tab-label">Moment</span>
          </div>
          <div class="chat-tab" onclick="switchChatTab('todo')">
            <span class="tab-icon"
              ><svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M9 11l3 3L22 4"></path>
                <path
                  d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"
                ></path></svg
            ></span>
            <span class="tab-label">To Do</span>
          </div>
          <div class="chat-tab" onclick="switchChatTab('profile')">
            <span class="tab-icon"
              ><svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle></svg
            ></span>
            <span class="tab-label">Me</span>
          </div>
        </div>
      </div>

      <!-- È¢ÑËÆæAppÈ°µÈù¢ -->
      <div id="presetPage" class="page preset-page">
        <div class="preset-header">
          <button class="preset-back-btn" onclick="closePage('presetPage')">
            ‚Üê
          </button>
          <span class="preset-title"
            ><svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="vertical-align: middle; margin-right: 4px"
            >
              <path d="M12 20h9"></path>
              <path
                d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
              ></path></svg
            >È¢ÑËÆæÁÆ°ÁêÜ</span
          >
          <div style="display: flex; gap: 8px">
            <button
              class="preset-header-btn"
              onclick="openPresetImportModal()"
              style="background: linear-gradient(135deg, #81d4fa, #4fc3f7)"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
            </button>
            <button class="preset-header-btn" onclick="openPresetModal()">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
          </div>
        </div>

        <div class="preset-content">
          <div class="preset-tabs">
            <button class="preset-tab active" onclick="switchPresetTab('all')">
              ÂÖ®ÈÉ®
            </button>
            <button class="preset-tab" onclick="switchPresetTab('character')">
              ËßíËâ≤
            </button>
            <button class="preset-tab" onclick="switchPresetTab('style')">
              ÊñáÈ£é
            </button>
            <button class="preset-tab" onclick="switchPresetTab('scene')">
              Âú∫ÊôØ
            </button>
          </div>

          <div class="preset-list" id="presetList">
            <!-- È¢ÑËÆæÂàóË°®Â∞ÜÈÄöËøáJSÊ∏≤Êüì -->
          </div>
        </div>

        <!-- ÊâπÈáèÊìç‰ΩúÊµÆÂä®Ê†è -->
        <div class="preset-batch-bar" id="presetBatchBar">
          <button class="preset-batch-btn cancel" onclick="cancelPresetBatch()">
            ÂèñÊ∂à
          </button>
          <button
            class="preset-batch-btn delete"
            onclick="deleteSelectedPresets()"
          >
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="vertical-align: middle; margin-right: 2px"
            >
              <polyline points="3 6 5 6 21 6"></polyline>
              <path
                d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
              ></path>
            </svg>
            Âà†Èô§ÊâÄÈÄâ
          </button>
        </div>
      </div>

      <!-- È¢ÑËÆæÁºñËæëÂºπÁ™ó -->
      <div class="preset-modal" id="stylePresetModal">
        <div class="preset-modal-content">
          <div class="preset-modal-header">
            <span class="preset-modal-title" id="stylePresetModalTitle"
              >ÂàõÂª∫È¢ÑËÆæ</span
            >
            <button class="preset-modal-close" onclick="closePresetModal()">
              ‚úï
            </button>
          </div>
          <div class="preset-modal-body">
            <div class="preset-form-group">
              <label class="preset-form-label">È¢ÑËÆæÂêçÁß∞</label>
              <input
                type="text"
                class="preset-form-input"
                id="stylePresetName"
                placeholder="ÁªôÈ¢ÑËÆæËµ∑‰∏™ÂêçÂ≠ó..."
              />
            </div>

            <div class="preset-form-group">
              <label class="preset-form-label">ÂàÜÁ±ª</label>
              <select class="preset-form-input" id="stylePresetCategory">
                <option value="character">ËßíËâ≤È¢ÑËÆæ</option>
                <option value="style">ÊñáÈ£éÈ¢ÑËÆæ</option>
                <option value="scene">Âú∫ÊôØÈ¢ÑËÆæ</option>
              </select>
            </div>

            <div class="preset-form-group">
              <label class="preset-form-label">ÂõæÊ†á</label>
              <input
                type="text"
                class="preset-form-input"
                id="stylePresetIcon"
                placeholder="ËæìÂÖ•‰∏Ä‰∏™Á¨¶Âè∑ÔºåÂ¶Ç ‚òÖ"
              />
            </div>

            <div class="preset-form-group">
              <label class="preset-form-label"
                >ÊèèËø∞
                <span class="preset-form-hint">(ÁÆÄÁü≠ËØ¥ÊòéÈ¢ÑËÆæÁî®ÈÄî)</span></label
              >
              <input
                type="text"
                class="preset-form-input"
                id="stylePresetDesc"
                placeholder="‰æãÂ¶ÇÔºöÊ∏©ÊüîÂ§ßÂßêÂßêÊñáÈ£é"
              />
            </div>

            <div class="preset-form-group">
              <label class="preset-form-label">
                È¢ÑËÆæÊù°ÁõÆ
                <span class="preset-form-hint">(ÂèØÊ∑ªÂä†Â§ö‰∏™Êù°ÁõÆÔºåÂàÜÂà´ÂºÄÂÖ≥)</span>
              </label>
              <div class="preset-entries-list" id="presetEntriesList">
                <!-- Êù°ÁõÆ‰ºöÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
              </div>
              <button class="preset-add-entry-btn" onclick="addPresetEntry()">
                + Ê∑ªÂä†Êù°ÁõÆ
              </button>
            </div>
          </div>
          <div class="preset-modal-footer">
            <button
              class="preset-modal-btn cancel"
              onclick="closePresetModal()"
            >
              ÂèñÊ∂à
            </button>
            <button class="preset-modal-btn save" onclick="savePreset()">
              ‰øùÂ≠ò
            </button>
          </div>
        </div>
      </div>

      <!-- È¢ÑËÆæÂØºÂÖ•ÂºπÁ™ó -->
      <div class="preset-import-modal" id="presetImportModal">
        <div class="preset-import-content">
          <div class="preset-import-title">ÂØºÂÖ•È¢ÑËÆæ</div>
          <div class="preset-import-options">
            <div class="preset-import-option" onclick="importPresetFromFile()">
              <div class="preset-import-option-icon">üìÅ</div>
              <div class="preset-import-option-text">
                <div class="preset-import-option-title">‰ªéÊñá‰ª∂ÂØºÂÖ•</div>
                <div class="preset-import-option-desc">
                  ÊîØÊåÅJSONÊ†ºÂºèÁöÑÈ¢ÑËÆæÊñá‰ª∂
                </div>
              </div>
            </div>
            <div
              class="preset-import-option"
              onclick="importPresetFromClipboard()"
            >
              <div class="preset-import-option-icon">‚â°</div>
              <div class="preset-import-option-text">
                <div class="preset-import-option-title">‰ªéÂâ™Ë¥¥ÊùøÂØºÂÖ•</div>
                <div class="preset-import-option-desc">
                  Á≤òË¥¥Silly TavernÈ¢ÑËÆæJSON
                </div>
              </div>
            </div>
          </div>
          <button
            class="preset-import-cancel"
            onclick="closePresetImportModal()"
          >
            ÂèñÊ∂à
          </button>
        </div>
      </div>
      <input
        type="file"
        id="presetFileInput"
        accept=".json"
        style="display: none"
        onchange="handlePresetFileImport(event)"
      />

      <div id="worldbookPage" class="page worldbook-page">
        <!-- ‰∏ñÁïå‰π¶Â§¥ÈÉ® -->
        <div class="worldbook-header">
          <div class="worldbook-header-left">
            <button class="back-btn" onclick="closePage('worldbookPage')">
              ‚Üê
            </button>
            <div class="worldbook-title">‚â° ‰∏ñÁïå‰π¶</div>
          </div>
          <div class="worldbook-header-actions">
            <button
              class="worldbook-header-btn"
              onclick="openWorldbookGroupManager()"
              title="ÁÆ°ÁêÜÂàÜÁªÑ"
            >
              üìÅ
            </button>
            <button
              class="worldbook-header-btn"
              onclick="toggleWorldbookBatchMode()"
              title="ÊâπÈáèÊìç‰Ωú"
            >
              ‚òëÔ∏è
            </button>
            <button
              class="worldbook-header-btn"
              onclick="openWorldbookModal()"
              title="Êñ∞Âª∫‰∏ñÁïå‰π¶"
            >
              +
            </button>
          </div>
        </div>

        <div class="worldbook-content">
          <!-- ÂàÜÁªÑÊ†áÁ≠æÊ†è -->
          <div class="worldbook-tabs" id="worldbookTabs">
            <div
              class="worldbook-tab active"
              data-group="all"
              onclick="filterWorldbookByGroup('all')"
            >
              ÂÖ®ÈÉ® <span class="worldbook-tab-count" id="wbCountAll">0</span>
            </div>
          </div>

          <!-- ÊâπÈáèÊìç‰ΩúÊ†è -->
          <div class="worldbook-batch-bar" id="worldbookBatchBar">
            <div class="worldbook-batch-info">
              Â∑≤ÈÄâÊã© <span id="worldbookSelectedCount">0</span> È°π
            </div>
            <div class="worldbook-batch-actions">
              <button
                class="worldbook-batch-btn cancel"
                onclick="cancelWorldbookBatch()"
              >
                ÂèñÊ∂à
              </button>
              <button
                class="worldbook-batch-btn move"
                onclick="openWorldbookMoveModal()"
              >
                üìÅ ÁßªÂä®
              </button>
              <button
                class="worldbook-batch-btn delete"
                onclick="deleteSelectedWorldbooks()"
              >
                ‚úï Âà†Èô§
              </button>
            </div>
          </div>

          <!-- ‰∏ñÁïå‰π¶ÂàóË°® -->
          <div class="worldbook-list" id="worldbookList">
            <!-- Âä®ÊÄÅÊ∏≤Êüì -->
          </div>

          <!-- Á©∫Áä∂ÊÄÅ -->
          <div
            class="worldbook-empty"
            id="worldbookEmpty"
            style="display: none"
          >
            <div class="worldbook-empty-icon">
              <svg
                width="48"
                height="48"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path
                  d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"
                ></path>
              </svg>
            </div>
            <div class="worldbook-empty-title">ËøòÊ≤°Êúâ‰∏ñÁïå‰π¶</div>
            <div class="worldbook-empty-text">
              ÂàõÂª∫‰∏ñÁïå‰π¶ÔºåËÆ©AIËßíËâ≤Êã•ÊúâÊõ¥‰∏∞ÂØåÁöÑËÉåÊôØËÆæÂÆö
            </div>
            <button class="worldbook-empty-btn" onclick="openWorldbookModal()">
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                style="vertical-align: middle; margin-right: 2px"
              >
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              ÂàõÂª∫Á¨¨‰∏ÄÊú¨‰∏ñÁïå‰π¶
            </button>
          </div>
        </div>
      </div>

      <!-- ‰∏ñÁïå‰π¶ÁºñËæëÂºπÁ™ó -->
      <div
        class="worldbook-modal"
        id="worldbookModal"
        onclick="if(event.target===this)closeWorldbookModal()"
      >
        <div class="worldbook-modal-content">
          <div class="worldbook-modal-header">
            <div class="worldbook-modal-title" id="worldbookModalTitle">
              Êñ∞Âª∫‰∏ñÁïå‰π¶
            </div>
            <button
              class="worldbook-modal-close"
              onclick="closeWorldbookModal()"
            >
              ‚úï
            </button>
          </div>
          <div class="worldbook-modal-body">
            <div class="worldbook-form-group">
              <label class="worldbook-form-label"
                >‰∏ñÁïå‰π¶ÂêçÁß∞ <span style="color: #f48fb1">*</span></label
              >
              <input
                type="text"
                class="worldbook-form-input"
                id="worldbookNameInput"
                placeholder="‰æãÂ¶ÇÔºöÁé∞‰ª£ÈÉΩÂ∏Ç‰∏ñÁïåËßÇ"
              />
            </div>
            <div class="worldbook-form-group">
              <label class="worldbook-form-label">ÂàÜÁªÑ</label>
              <select
                class="worldbook-form-input worldbook-form-select"
                id="worldbookGroupSelect"
              >
                <option value="">Êú™ÂàÜÁªÑ</option>
              </select>
            </div>
            <div class="worldbook-form-group">
              <label class="worldbook-form-label"
                >ÊèèËø∞ <span class="worldbook-form-hint">(ÈÄâÂ°´)</span></label
              >
              <textarea
                class="worldbook-form-input worldbook-form-textarea"
                id="worldbookDescInput"
                placeholder="ÁÆÄË¶ÅÊèèËø∞ËøôÊú¨‰∏ñÁïå‰π¶ÁöÑÂÜÖÂÆπ..."
              ></textarea>
            </div>
            <div class="worldbook-form-group">
              <label class="worldbook-form-label">Êù°ÁõÆÂàóË°®</label>
              <div class="worldbook-entries" id="worldbookEntries">
                <!-- Âä®ÊÄÅÊ∏≤ÊüìÊù°ÁõÆ -->
              </div>
              <button
                class="worldbook-add-entry-btn"
                onclick="addWorldbookEntry()"
              >
                + Ê∑ªÂä†Êñ∞Êù°ÁõÆ
              </button>
            </div>
          </div>
          <div class="worldbook-modal-footer">
            <button
              class="worldbook-modal-btn cancel"
              onclick="closeWorldbookModal()"
            >
              ÂèñÊ∂à
            </button>
            <button class="worldbook-modal-btn save" onclick="saveWorldbook()">
              ‰øùÂ≠ò
            </button>
          </div>
        </div>
      </div>

      <!-- Êù°ÁõÆÁºñËæëÂºπÁ™ó -->
      <div
        class="worldbook-modal"
        id="worldbookEntryModal"
        onclick="if(event.target===this)closeWorldbookEntryModal()"
      >
        <div class="worldbook-modal-content">
          <div class="worldbook-modal-header">
            <div class="worldbook-modal-title" id="worldbookEntryModalTitle">
              ÁºñËæëÊù°ÁõÆ
            </div>
            <button
              class="worldbook-modal-close"
              onclick="closeWorldbookEntryModal()"
            >
              ‚úï
            </button>
          </div>
          <div class="worldbook-modal-body">
            <div class="worldbook-form-group">
              <label class="worldbook-form-label"
                >Â§áÊ≥®
                <span class="worldbook-form-hint">(ÈÄâÂ°´Ôºå‰æø‰∫éÁÆ°ÁêÜ)</span></label
              >
              <input
                type="text"
                class="worldbook-form-input"
                id="entryCommentInput"
                placeholder="‰æãÂ¶ÇÔºöÂÖ≥‰∫é‰∏ªËßíÁöÑÁ´•Âπ¥"
              />
            </div>
            <div class="worldbook-form-group">
              <label class="worldbook-form-label"
                >ÂÖ≥ÈîÆËØç
                <span class="worldbook-form-hint">(Áî®Ëã±ÊñáÈÄóÂè∑ÂàÜÈöî)</span></label
              >
              <input
                type="text"
                class="worldbook-form-input"
                id="entryKeywordsInput"
                placeholder="‰æãÂ¶ÇÔºöÁ´•Âπ¥, Â∞èÊó∂ÂÄô, ËøáÂéª"
              />
            </div>
            <div class="worldbook-form-group">
              <label class="worldbook-form-label"
                >ÂÜÖÂÆπ <span style="color: #f48fb1">*</span></label
              >
              <textarea
                class="worldbook-form-input worldbook-form-textarea"
                id="entryContentInput"
                placeholder="ÂΩìËÅäÂ§©‰∏≠Âá∫Áé∞ÂÖ≥ÈîÆËØçÊó∂ÔºåËøôÊÆµÂÜÖÂÆπ‰ºöË¢´Ê≥®ÂÖ•Âà∞AIÁöÑËÆ∞ÂøÜ‰∏≠..."
                style="min-height: 150px"
              ></textarea>
            </div>
          </div>
          <div class="worldbook-modal-footer">
            <button
              class="worldbook-modal-btn cancel"
              onclick="closeWorldbookEntryModal()"
            >
              ÂèñÊ∂à
            </button>
            <button
              class="worldbook-modal-btn save"
              onclick="saveWorldbookEntry()"
            >
              ‰øùÂ≠ò
            </button>
          </div>
        </div>
      </div>

      <!-- ÂàÜÁªÑÁÆ°ÁêÜÂºπÁ™ó -->
      <div
        class="worldbook-group-modal"
        id="worldbookGroupModal"
        onclick="if(event.target===this)closeWorldbookGroupManager()"
      >
        <div class="worldbook-group-modal-content">
          <div class="worldbook-group-title">üìÅ ÁÆ°ÁêÜÂàÜÁªÑ</div>
          <div class="worldbook-group-list" id="worldbookGroupList">
            <!-- Âä®ÊÄÅÊ∏≤Êüì -->
          </div>
          <div class="worldbook-group-add-row">
            <input
              type="text"
              class="worldbook-group-add-input"
              id="worldbookNewGroupInput"
              placeholder="ËæìÂÖ•Êñ∞ÂàÜÁªÑÂêçÁß∞..."
            />
            <button
              class="worldbook-group-add-btn"
              onclick="addWorldbookGroup()"
            >
              Ê∑ªÂä†
            </button>
          </div>
          <button
            class="worldbook-group-close"
            onclick="closeWorldbookGroupManager()"
          >
            ÂÖ≥Èó≠
          </button>
        </div>
      </div>

      <!-- ÁßªÂä®ÂàÜÁªÑÂºπÁ™ó -->
      <div
        class="worldbook-move-modal"
        id="worldbookMoveModal"
        onclick="if(event.target===this)closeWorldbookMoveModal()"
      >
        <div class="worldbook-move-modal-content">
          <div class="worldbook-move-title">üìÅ ÁßªÂä®Âà∞ÂàÜÁªÑ</div>
          <div class="worldbook-move-list" id="worldbookMoveList">
            <!-- Âä®ÊÄÅÊ∏≤Êüì -->
          </div>
          <button
            class="worldbook-move-cancel"
            onclick="closeWorldbookMoveModal()"
          >
            ÂèñÊ∂à
          </button>
        </div>
      </div>

      <div id="forumPage" class="page">
        <div class="page-header">
          <button class="back-btn" onclick="closePage('forumPage')">‚Üê</button>
          <h1 class="page-title">ËÆ∫Âùõ</h1>
          <div class="forum-header-right">
            <button class="forum-header-btn" onclick="openForumSettings()">
              ‚öôÔ∏è
            </button>
          </div>
        </div>
        <div class="page-content" id="forumPageContent" style="padding: 0">
          <!-- Áî±JSÂä®ÊÄÅÊ∏≤Êüì -->
        </div>
      </div>

      <div id="coupleSpacePage" class="page">
        <div class="page-header">
          <button class="back-btn" onclick="closePage('coupleSpacePage')">
            ‚Üê
          </button>
          <h1 class="page-title">ÊÉÖ‰æ£Á©∫Èó¥</h1>
        </div>
        <div class="page-content">ÊÉÖ‰æ£Á©∫Èó¥ÂäüËÉΩÂºÄÂèë‰∏≠...</div>
      </div>

      <div id="companionPage" class="page">
        <div class="page-header companion-header">
          <button class="back-btn" onclick="closeCompanionPage()">‚Üê</button>
          <h1 class="page-title">Èô™‰º¥</h1>
          <span style="width: 40px"></span>
        </div>

        <!-- TabÂàáÊç¢ -->
        <div class="companion-tabs">
          <div
            class="companion-tab active"
            onclick="switchCompanionTab('setup')"
            id="companionTabSetup"
          >
            ÂºÄÂßãÈô™‰º¥
          </div>
          <div
            class="companion-tab"
            onclick="switchCompanionTab('history')"
            id="companionTabHistory"
          >
            Èô™‰º¥ËÆ∞ÂΩï
          </div>
        </div>

        <!-- Êú™ÂºÄÂßãÈô™‰º¥Êó∂ÁöÑËÆæÁΩÆÁïåÈù¢ -->
        <div class="companion-setup" id="companionSetup">
          <!-- Êï∞ÊçÆÁªüËÆ°Âç°Áâá -->
          <div class="companion-stats-card" id="companionStatsCard">
            <div class="companion-stat-item">
              <div class="companion-stat-value" id="companionTotalTimes">0</div>
              <div class="companion-stat-label">Èô™‰º¥Ê¨°Êï∞</div>
            </div>
            <div class="companion-stat-divider"></div>
            <div class="companion-stat-item">
              <div class="companion-stat-value" id="companionTotalHours">0</div>
              <div class="companion-stat-label">ÊÄªÊó∂Èïø(Â∞èÊó∂)</div>
            </div>
            <div class="companion-stat-divider"></div>
            <div class="companion-stat-item">
              <div class="companion-stat-value" id="companionStreak">0</div>
              <div class="companion-stat-label">ËøûÁª≠Â§©Êï∞</div>
            </div>
          </div>

          <!-- ÈÄâÊã©AIËßíËâ≤ -->
          <div class="companion-section">
            <div class="companion-section-title">üë§ ÈÄâÊã©Èô™‰º¥ËßíËâ≤</div>
            <div class="companion-char-select" id="companionCharSelect">
              <!-- Âä®ÊÄÅÊ∏≤ÊüìËßíËâ≤ÂàóË°® -->
            </div>
          </div>

          <!-- Èô™‰º¥È°πÁõÆ -->
          <div class="companion-section">
            <div class="companion-section-title">üìù Èô™‰º¥È°πÁõÆ</div>
            <input
              type="text"
              class="companion-input"
              id="companionTaskInput"
              placeholder="ËæìÂÖ•‰Ω†ÊÉ≥ÂÅöÁöÑ‰∫ãÊÉÖÔºå‰æãÂ¶ÇÔºöÂ≠¶‰π†Ëã±ËØ≠„ÄÅÂÜôËÆ∫Êñá..."
            />
          </div>

          <!-- Èô™‰º¥Êó∂Èïø -->
          <div class="companion-section">
            <div class="companion-section-title">‚è±Ô∏è Èô™‰º¥Êó∂ÈïøÔºàÂàÜÈíüÔºâ</div>
            <input
              type="number"
              class="companion-input"
              id="companionDurationInput"
              placeholder="ËæìÂÖ•Êó∂Èïø"
              value="45"
              min="1"
              max="480"
            />
          </div>

          <!-- ÈºìÂä±È¢ëÁéá -->
          <div class="companion-section">
            <div class="companion-section-title">üí¨ ÈºìÂä±È¢ëÁéá</div>
            <div class="companion-freq-select">
              <span class="companion-freq-tag" onclick="setEncourageFreq(3)"
                >È¢ëÁπÅ(3ÂàÜÈíü)</span
              >
              <span
                class="companion-freq-tag active"
                onclick="setEncourageFreq(5)"
                >ÈÄÇ‰∏≠(5ÂàÜÈíü)</span
              >
              <span class="companion-freq-tag" onclick="setEncourageFreq(10)"
                >ÂÅ∂Â∞î(10ÂàÜÈíü)</span
              >
              <span class="companion-freq-tag" onclick="setEncourageFreq(0)"
                >ÂÆâÈùôÈô™‰º¥</span
              >
            </div>
          </div>

          <!-- ËØ≠Èü≥ÈºìÂä± -->
          <div class="companion-section">
            <div
              style="
                display: flex;
                align-items: center;
                justify-content: space-between;
              "
            >
              <div>
                <div class="companion-section-title" style="margin-bottom: 4px">
                  üîä ËØ≠Èü≥ÈºìÂä±
                </div>
                <div style="font-size: 0.75rem; color: #999">
                  ÂºÄÂêØÂêéAI‰ºöÁî®ËØ≠Èü≥Áªô‰Ω†Âä†Ê≤π
                </div>
              </div>
              <div
                id="companionVoiceToggle"
                onclick="toggleCompanionVoice()"
                style="
                  width: 50px;
                  height: 28px;
                  border-radius: 14px;
                  background: #e0e0e0;
                  position: relative;
                  cursor: pointer;
                  transition: all 0.3s;
                "
              >
                <div
                  style="
                    width: 24px;
                    height: 24px;
                    border-radius: 50%;
                    background: #fff;
                    position: absolute;
                    top: 2px;
                    left: 2px;
                    transition: all 0.3s;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                  "
                ></div>
              </div>
            </div>
          </div>

          <!-- ËÉåÊôØËÆæÁΩÆ -->
          <div class="companion-section">
            <div class="companion-section-title">üñºÔ∏è Èô™‰º¥ËÉåÊôØ</div>
            <div class="companion-bg-list" id="companionBgList">
              <!-- Â∑≤Ê∑ªÂä†ÁöÑËÉåÊôØÈ¢ÑËßà -->
            </div>
            <div
              class="companion-bg-add"
              onclick="document.getElementById('companionBgInput').click()"
            >
              <span>+</span>
              <span>Ê∑ªÂä†ÂõæÁâá/ËßÜÈ¢ë</span>
            </div>
            <input
              type="file"
              id="companionBgInput"
              accept="image/*,video/*"
              multiple
              style="display: none"
              onchange="handleCompanionBgSelect(event)"
            />
            <div style="font-size: 0.75rem; color: #999; margin-top: 8px">
              ÊîØÊåÅÂ§öÂº†ÂõæÁâáËΩÆÊí≠ÔºàÊØè10ÁßíÂàáÊç¢ÔºâÊàñÂçï‰∏™ËßÜÈ¢ë
            </div>

            <!-- ËΩÆÊí≠Èó¥ÈöîËÆæÁΩÆ -->
            <div
              id="companionBgIntervalSetting"
              style="display: none; margin-top: 12px"
            >
              <div style="font-size: 0.85rem; color: #666; margin-bottom: 6px">
                ËΩÆÊí≠Èó¥ÈöîÔºàÁßíÔºâ
              </div>
              <input
                type="number"
                class="companion-input"
                id="companionBgInterval"
                value="10"
                min="3"
                max="60"
                style="width: 100px"
              />
            </div>
          </div>

          <!-- ÂºÄÂßãÊåâÈíÆ -->
          <button class="companion-start-btn" onclick="startCompanion()">
            ÂºÄÂßãÈô™‰º¥ ‚ú®
          </button>
        </div>

        <!-- Èô™‰º¥ËÆ∞ÂΩïÈ°µÈù¢ -->
        <div
          class="companion-history"
          id="companionHistory"
          style="display: none"
        >
          <!-- ÊúàÂ∫¶Êó•ÂéÜ -->
          <div class="companion-calendar-section">
            <div class="companion-calendar-header">
              <button
                class="companion-calendar-nav"
                onclick="changeCompanionMonth(-1)"
              >
                ‚Äπ
              </button>
              <span id="companionCalendarTitle">2025Âπ¥1Êúà</span>
              <button
                class="companion-calendar-nav"
                onclick="changeCompanionMonth(1)"
              >
                ‚Ä∫
              </button>
            </div>
            <div class="companion-calendar-weekdays">
              <span>Êó•</span><span>‰∏Ä</span><span>‰∫å</span><span>‰∏â</span
              ><span>Âõõ</span><span>‰∫î</span><span>ÂÖ≠</span>
            </div>
            <div class="companion-calendar-days" id="companionCalendarDays">
              <!-- Âä®ÊÄÅÊ∏≤ÊüìÊó•Êúü -->
            </div>
          </div>

          <!-- ËÆ∞ÂΩïÂàóË°® -->
          <div class="companion-history-list" id="companionHistoryList">
            <!-- Âä®ÊÄÅÊ∏≤ÊüìËÆ∞ÂΩï -->
          </div>

          <!-- Á©∫Áä∂ÊÄÅ -->
          <div
            class="companion-history-empty"
            id="companionHistoryEmpty"
            style="display: none"
          >
            <div class="empty-icon">üìù</div>
            <div class="empty-text">ËøòÊ≤°ÊúâÈô™‰º¥ËÆ∞ÂΩï</div>
            <div class="empty-hint">ÂºÄÂßã‰Ω†ÁöÑÁ¨¨‰∏ÄÊ¨°Èô™‰º¥ÂêßÔºÅ</div>
          </div>
        </div>

        <!-- Èô™‰º¥ËøõË°å‰∏≠ÁïåÈù¢ÔºàÂÖ®Â±èÊ≤âÊµ∏ÂºèÔºâ -->
        <div
          class="companion-active"
          id="companionActive"
          style="display: none"
        >
          <!-- ÂÖ®Â±èËÉåÊôØÔºàÊîØÊåÅËΩÆÊí≠Ôºâ -->
          <div class="companion-fullscreen-bg" id="companionFullscreenBg">
            <div class="companion-bg-slide active" id="companionBgSlide1"></div>
            <div class="companion-bg-slide" id="companionBgSlide2"></div>
            <video
              id="companionBgVideo"
              style="display: none"
              muted
              loop
              autoplay
              playsinline
            ></video>
            <div class="companion-bg-overlay"></div>
          </div>

          <!-- AIËßíËâ≤ÊòæÁ§∫ -->
          <div class="companion-char-display">
            <div class="companion-char-avatar" id="companionCharAvatar">üòä</div>
            <div class="companion-char-name" id="companionCharName">AI</div>
          </div>

          <!-- ÁøªÈ°µËÆ°Êó∂Âô® -->
          <div class="companion-timer-section">
            <div class="flip-clock" id="flipClock">
              <div class="flip-unit">
                <div class="flip-card" id="flipMin1">
                  <div class="flip-card-inner">
                    <div class="flip-card-front">0</div>
                    <div class="flip-card-back">0</div>
                  </div>
                </div>
              </div>
              <div class="flip-unit">
                <div class="flip-card" id="flipMin2">
                  <div class="flip-card-inner">
                    <div class="flip-card-front">0</div>
                    <div class="flip-card-back">0</div>
                  </div>
                </div>
              </div>
              <div class="flip-colon">:</div>
              <div class="flip-unit">
                <div class="flip-card" id="flipSec1">
                  <div class="flip-card-inner">
                    <div class="flip-card-front">0</div>
                    <div class="flip-card-back">0</div>
                  </div>
                </div>
              </div>
              <div class="flip-unit">
                <div class="flip-card" id="flipSec2">
                  <div class="flip-card-inner">
                    <div class="flip-card-front">0</div>
                    <div class="flip-card-back">0</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="companion-task-name" id="companionTaskName">
              Â≠¶‰π†‰∏≠...
            </div>
            <div class="companion-progress-bar">
              <div
                class="companion-progress-fill"
                id="companionProgressFill"
              ></div>
            </div>
          </div>

          <!-- AIÈºìÂä±Ê∂àÊÅØ -->
          <div class="companion-message-area" id="companionMessageArea">
            <div class="companion-message" id="companionMessage">
              Âä†Ê≤πÔºÅÊàë‰ºö‰∏ÄÁõ¥Èô™ÁùÄ‰Ω†~
            </div>
          </div>

          <!-- Â∫ïÈÉ®Êìç‰Ωú -->
          <div class="companion-actions">
            <button
              class="companion-action-btn chat"
              onclick="openCompanionChat()"
            >
              üí¨ ËÅäËÅäÂ§©
            </button>
            <button
              class="companion-action-btn pause"
              id="companionPauseBtn"
              onclick="toggleCompanionPause()"
            >
              ‚è∏Ô∏è ÊöÇÂÅú
            </button>
            <button
              class="companion-action-btn complete"
              onclick="completeCompanion()"
            >
              ‚úÖ ÂÆåÊàê
            </button>
            <button class="companion-action-btn quit" onclick="quitCompanion()">
              ‚ùå ÊîæÂºÉ
            </button>
          </div>
        </div>

        <!-- ËÅäÂ§©ÂºπÁ™ó -->
        <div class="companion-chat-modal" id="companionChatModal">
          <div class="companion-chat-container">
            <div class="companion-chat-header">
              <span>Âíå <span id="companionChatCharName">AI</span> ËÅäËÅä</span>
              <button onclick="closeCompanionChat()">‚úï</button>
            </div>
            <div class="companion-chat-messages" id="companionChatMessages">
              <!-- ËÅäÂ§©Ê∂àÊÅØ -->
            </div>
            <div class="companion-chat-input-area">
              <input
                type="text"
                id="companionChatInput"
                placeholder="Á¥Ø‰∫ÜÂ∞±ÂíåÊàëËØ¥ËØ¥ËØùÂêß~"
                onkeypress="if(event.key==='Enter')sendCompanionChat()"
              />
              <button onclick="sendCompanionChat()">ÂèëÈÄÅ</button>
            </div>
          </div>
        </div>
      </div>

      <div id="apiPage" class="page api-settings-page">
        <div class="page-header">
          <button class="back-btn" onclick="closePage('apiPage')">‚Üê</button>
          <h1 class="page-title">APIËÆæÁΩÆ</h1>
          <button class="page-header-add" onclick="openApiPresetModal()">
            +
          </button>
        </div>

        <div class="api-settings-content">
          <!-- API Presets List -->
          <div class="api-section">
            <div class="api-section-title">API È¢ÑËÆæÁÆ°ÁêÜ</div>
            <div class="api-preset-list" id="apiPresetList">
              <!-- Presets will be rendered here -->
              <div class="empty-state" id="emptyPresets">
                <div class="empty-icon">
                  <svg
                    width="48"
                    height="48"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                    <line x1="12" y1="2" x2="12" y2="12"></line>
                  </svg>
                </div>
                <div class="empty-text">ËøòÊ≤°ÊúâAPIÈ¢ÑËÆæ</div>
                <div class="empty-hint">ÁÇπÂáªÂè≥‰∏äËßí + ÂàõÂª∫È¢ÑËÆæ</div>
              </div>
            </div>
          </div>

          <!-- Current Active Config -->
          <div
            class="api-section"
            id="activeConfigSection"
            style="display: none"
          >
            <div class="api-section-title">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                style="vertical-align: middle; margin-right: 4px"
              >
                <polyline points="20 6 9 17 4 12"></polyline></svg
              >ÂΩìÂâç‰ΩøÁî®
            </div>
            <div class="active-config-card">
              <div class="active-config-row">
                <span class="active-label">È¢ÑËÆæÂêçÁß∞</span>
                <span class="active-value" id="activePresetName">-</span>
              </div>
              <div class="active-config-row">
                <span class="active-label">Ê®°Âûã</span>
                <span class="active-value" id="activeModelName">-</span>
              </div>
              <div class="active-config-row">
                <span class="active-label">Áä∂ÊÄÅ</span>
                <span class="active-status">Â∑≤ËøûÊé•</span>
              </div>
            </div>
          </div>
          <div class="api-section">
            <div class="api-section-title">üéôÔ∏è ËØ≠Èü≥ËÆæÁΩÆ (MiniMax)</div>
            <div
              class="active-config-card"
              style="background: #fff; padding: 16px"
            >
              <div class="form-group">
                <label class="form-label">Group ID</label>
                <input
                  type="text"
                  class="form-input"
                  id="voiceGroupId"
                  placeholder="Â°´ÂÜô MiniMax Group ID"
                />
              </div>

              <div class="form-group">
                <label class="form-label">API Key</label>
                <input
                  type="password"
                  class="form-input"
                  id="voiceApiKey"
                  placeholder="Â°´ÂÜô MiniMax API Key"
                />
              </div>
              <div class="form-group">
                <label class="form-label">API Á∫øË∑Ø</label>
                <div class="radio-group">
                  <div
                    class="radio-option active"
                    onclick="switchVoiceUrl('cn')"
                    id="voiceUrlCN"
                  >
                    ÂõΩÂÜÖÁâà
                  </div>
                  <div
                    class="radio-option"
                    onclick="switchVoiceUrl('intl')"
                    id="voiceUrlIntl"
                  >
                    Êµ∑Â§ñÁâà
                  </div>
                </div>
                <div class="form-hint" style="margin-top: 6px">
                  ÂõΩÂÜÖÁâà: api.minimax.chat | Êµ∑Â§ñÁâà: api.minimaxi.com
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">ËØ≠Èü≥Ê®°Âûã</label>
                <div class="form-select-wrapper">
                  <select class="form-select" id="voiceModelSelect">
                    <option value="speech-2.6-hd">
                      speech-2.6-hd (ÊúÄÊñ∞¬∑Ë∂ÖÊ∏Ö)
                    </option>
                    <option value="speech-2.6-turbo">
                      speech-2.6-turbo (ÊúÄÊñ∞¬∑ÊûÅÈÄü)
                    </option>

                    <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>

                    <option value="speech-02-hd">speech-02-hd (È´òÊ∏Ö)</option>
                    <option value="speech-02-turbo">
                      speech-02-turbo (Âø´ÈÄü)
                    </option>
                    <option value="speech-01-turbo">
                      speech-01-turbo (ËÄÅÊóß)
                    </option>
                    <option value="speech-01-hd">speech-01-hd (ËÄÅÊóß)</option>
                  </select>
                </div>
              </div>

              <button
                class="action-btn"
                onclick="saveVoiceConfig()"
                style="width: 100%; margin-top: 10px"
              >
                üíæ ‰øùÂ≠òËØ≠Èü≥ÈÖçÁΩÆ
              </button>
            </div>
          </div>
          <!-- Tips -->
          <div class="api-tips">
            <div class="api-tips-title">üí° ÊèêÁ§∫</div>
            <div class="api-tips-content">
              ÊîØÊåÅ OpenAI ÂÖºÂÆπÊ†ºÂºèÁöÑ API„ÄÇÂ°´ÂÜôÂèç‰ª£Âú∞ÂùÄÊó∂Êó†ÈúÄÊ∑ªÂä† /v1 ÂêéÁºÄ„ÄÇ
            </div>
          </div>
        </div>
      </div>

      <!-- API Preset Modal -->
      <div class="api-modal" id="apiPresetModal">
        <div class="api-modal-content">
          <div class="api-modal-header">
            <h2 class="api-modal-title" id="apiModalTitle">ÂàõÂª∫ API È¢ÑËÆæ</h2>
            <button class="api-modal-close" onclick="closeApiPresetModal()">
              ‚úï
            </button>
          </div>
          <div class="api-modal-body">
            <div class="api-field">
              <label class="api-field-label">È¢ÑËÆæÂêçÁß∞</label>
              <input
                type="text"
                class="api-field-input"
                id="presetNameInput"
                placeholder="‰æãÂ¶Ç: OpenAI, Claude, Ëá™Áî®API"
              />
            </div>

            <div class="api-field">
              <label class="api-field-label">Âèç‰ª£Âú∞ÂùÄ</label>
              <input
                type="text"
                class="api-field-input"
                id="presetUrlInput"
                placeholder="https://api.example.com"
              />
            </div>

            <div class="api-field">
              <label class="api-field-label">API Key</label>
              <div class="api-field-key">
                <input
                  type="password"
                  class="api-field-input"
                  id="presetKeyInput"
                  placeholder="sk-xxxxxxxxxxxxxxxx"
                />
                <button
                  class="key-toggle-btn"
                  onclick="togglePresetKeyVisibility()"
                >
                  ‚óã
                </button>
              </div>
            </div>

            <div class="api-field">
              <label class="api-field-label">Ê®°Âûã</label>
              <div class="model-select-row">
                <input
                  type="text"
                  class="api-field-input model-input"
                  id="presetModelInput"
                  placeholder="ËæìÂÖ•ÊàñÊãâÂèñÊ®°ÂûãÂêçÁß∞"
                />
                <button class="model-fetch-btn" onclick="fetchPresetModels()">
                  ÊãâÂèñ
                </button>
              </div>
              <div class="model-hint">
                ÂèØÁõ¥Êé•ËæìÂÖ•Ê®°ÂûãÂêçÁß∞ÔºåÂ¶Ç gpt-4o„ÄÅclaude-3-5-sonnet Á≠â
              </div>

              <div class="model-dropdown" id="modelDropdown"></div>
            </div>

            <div
              class="api-field"
              style="
                margin-top: 20px;
                padding-top: 20px;
                border-top: 1px dashed #eee;
              "
            >
              <label class="api-field-label">ÂèÇÊï∞ÂæÆË∞É (Advanced)</label>

              <div class="slider-row">
                <div style="width: 70px; font-size: 0.85rem; color: #666">
                  Ê∏©Â∫¶<br /><span style="font-size: 0.7rem; color: #999"
                    >(ÈöèÊú∫ÊÄß)</span
                  >
                </div>
                <input
                  type="range"
                  id="presetTempInput"
                  min="0"
                  max="2"
                  step="0.1"
                  value="1.0"
                  oninput="document.getElementById('valTemp').textContent = this.value"
                />
                <span class="slider-value" id="valTemp">1.0</span>
              </div>

              <div class="slider-row">
                <div style="width: 70px; font-size: 0.85rem; color: #666">
                  È¢ëÁéáÊÉ©ÁΩö<br /><span style="font-size: 0.7rem; color: #999"
                    >(ÂéªÈáç)</span
                  >
                </div>
                <input
                  type="range"
                  id="presetFreqInput"
                  min="-2"
                  max="2"
                  step="0.1"
                  value="0"
                  oninput="document.getElementById('valFreq').textContent = this.value"
                />
                <span class="slider-value" id="valFreq">0.0</span>
              </div>

              <div class="slider-row">
                <div style="width: 70px; font-size: 0.85rem; color: #666">
                  Â≠òÂú®ÊÉ©ÁΩö<br /><span style="font-size: 0.7rem; color: #999"
                    >(ÂàõÊñ∞)</span
                  >
                </div>
                <input
                  type="range"
                  id="presetPresInput"
                  min="-2"
                  max="2"
                  step="0.1"
                  value="0"
                  oninput="document.getElementById('valPres').textContent = this.value"
                />
                <span class="slider-value" id="valPres">0.0</span>
              </div>
            </div>
          </div>

          <div class="api-modal-footer">
            <button
              class="api-modal-btn btn-delete"
              id="presetDeleteBtn"
              onclick="deleteApiPreset()"
              style="display: none"
            >
              Âà†Èô§
            </button>
            <div class="api-modal-btn-group">
              <button
                class="api-modal-btn btn-cancel"
                onclick="closeApiPresetModal()"
              >
                ÂèñÊ∂à
              </button>
              <button class="api-modal-btn btn-save" onclick="saveApiPreset()">
                ‰øùÂ≠ò
              </button>
            </div>
          </div>
        </div>
      </div>

      <div
        id="fontPage"
        class="page chat-settings-page"
        style="background: #f5f5f5"
      >
        <div
          class="page-header"
          style="background: white; border-bottom: 1px solid #eee"
        >
          <button class="back-btn" onclick="closePage('fontPage')">‚Üê</button>
          <h1 class="page-title">Â≠ó‰ΩìËÆæÁΩÆ</h1>
        </div>

        <div class="settings-content">
          <div class="settings-section">
            <div class="section-header">
              <div class="section-icon purple">üî§</div>
              <span class="section-title">Ê∑ªÂä†Êñ∞Â≠ó‰Ωì</span>
            </div>
            <div class="section-body">
              <div class="form-group">
                <div class="radio-group">
                  <div
                    class="radio-option active"
                    onclick="switchFontSource('url')"
                    id="tabFontUrl"
                  >
                    ÁΩëÁªúÈìæÊé•
                  </div>
                  <div
                    class="radio-option"
                    onclick="switchFontSource('file')"
                    id="tabFontFile"
                  >
                    Êú¨Âú∞‰∏ä‰º†
                  </div>
                </div>
              </div>

              <div id="fontSourceUrl" class="form-group">
                <label class="form-label">Â≠ó‰Ωì URL (.woff2, .ttf)</label>
                <input
                  type="text"
                  class="form-input"
                  id="fontUrlInput"
                  placeholder="https://example.com/font.woff2"
                />
              </div>

              <div id="fontSourceFile" class="form-group" style="display: none">
                <label class="form-label">‰∏ä‰º†Â≠ó‰ΩìÊñá‰ª∂</label>
                <div
                  class="bg-upload-btn"
                  onclick="document.getElementById('fontFileInput').click()"
                >
                  üìÇ ÁÇπÂáªÈÄâÊã©Â≠ó‰ΩìÊñá‰ª∂
                </div>
                <input
                  type="file"
                  id="fontFileInput"
                  class="hidden-input"
                  accept=".ttf,.otf,.woff,.woff2"
                  onchange="handleFontFileUpload(this)"
                />
                <div
                  class="form-hint"
                  id="fontFileName"
                  style="margin-top: 8px"
                >
                  Êú™ÈÄâÊã©Êñá‰ª∂
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">È¢ÑËÆæÂêçÁß∞</label>
                <input
                  type="text"
                  class="form-input"
                  id="fontNameInput"
                  placeholder="‰æãÂ¶Ç: Â∞ëÂ•≥‰Ωì, ÂÉèÁ¥†È£é..."
                />
              </div>

              <div class="form-group">
                <label class="form-label">ÊïàÊûúÈ¢ÑËßà</label>
                <div
                  id="fontPreviewBox"
                  style="
                    padding: 16px;
                    background: white;
                    border: 1px solid #e5ddd3;
                    border-radius: 12px;
                    font-size: 16px;
                    line-height: 1.6;
                    color: #5d4e37;
                    transition: all 0.3s;
                  "
                >
                  The quick brown fox jumps over the lazy dog.<br />
                  ËøôÊòØ‰∏ÄÊÆµ‰∏≠ÊñáÊµãËØïÊñáÊú¨ÔºåÁî®‰∫éÈ¢ÑËßàÂ≠ó‰ΩìÊïàÊûú„ÄÇ<br />
                  1234567890 !@#$%^&*()
                </div>
              </div>

              <div class="action-buttons-grid">
                <button class="action-btn" onclick="previewCustomFont()">
                  ‚óã È¢ÑËßà
                </button>
                <button
                  class="action-btn"
                  style="
                    background: linear-gradient(135deg, #a18cd1, #fbc2eb);
                    color: white;
                    border: none;
                  "
                  onclick="saveFontPreset()"
                >
                  üíæ ‰øùÂ≠òÂπ∂Â∫îÁî®
                </button>
              </div>
            </div>
          </div>

          <div class="settings-section">
            <div class="section-header">
              <div class="section-icon orange">üìö</div>
              <span class="section-title">ÊàëÁöÑÂ≠ó‰ΩìÂ∫ì</span>
            </div>
            <div class="section-body">
              <div class="api-preset-list" id="fontPresetList">
                <div class="api-preset-item active" onclick="applySystemFont()">
                  <div class="preset-radio" id="radio-system"></div>
                  <div class="preset-info">
                    <div class="preset-name">Á≥ªÁªüÈªòËÆ§</div>
                    <div class="preset-detail">System Default</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="appearancePage" class="page">
        <div class="page-header">
          <button class="back-btn" onclick="closePage('appearancePage')">
            ‚Üê
          </button>
          <h1 class="page-title">Â§ñËßÇËÆæÁΩÆ</h1>
        </div>
        <div
          class="page-content"
          style="
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
          "
        >
          <!-- Â£ÅÁ∫∏ËÆæÁΩÆ -->
          <div class="appearance-section">
            <h3>‚ñ£ ‰∏ªÂ±èÂπïÂ£ÅÁ∫∏</h3>
            <div
              class="wallpaper-preview"
              id="wallpaperPreview"
              onclick="document.getElementById('wallpaperInput').click()"
            >
              <div class="wallpaper-placeholder">ÁÇπÂáªÊõ¥Êç¢Â£ÅÁ∫∏</div>
            </div>
            <input
              type="file"
              id="wallpaperInput"
              accept="image/*"
              style="display: none"
              onchange="previewWallpaper(this)"
            />
            <button class="appearance-btn secondary" onclick="resetWallpaper()">
              ÊÅ¢Â§çÈªòËÆ§
            </button>
          </div>

          <!-- Â≠ó‰ΩìÈ¢úËâ≤ËÆæÁΩÆ -->
          <div class="appearance-section">
            <h3>üé® Â≠ó‰ΩìÈ¢úËâ≤</h3>
            <div class="color-options">
              <div
                class="color-option"
                style="background: #37474f"
                onclick="setFontColor('#37474f')"
                data-color="#37474f"
              ></div>
              <div
                class="color-option"
                style="background: #ffffff; border: 1px solid #ddd"
                onclick="setFontColor('#ffffff')"
                data-color="#ffffff"
              ></div>
              <div
                class="color-option"
                style="background: #f48fb1"
                onclick="setFontColor('#f48fb1')"
                data-color="#f48fb1"
              ></div>
              <div
                class="color-option"
                style="background: #90caf9"
                onclick="setFontColor('#90caf9')"
                data-color="#90caf9"
              ></div>
              <div
                class="color-option"
                style="background: #a5d6a7"
                onclick="setFontColor('#a5d6a7')"
                data-color="#a5d6a7"
              ></div>
              <div
                class="color-option"
                style="background: #ffcc80"
                onclick="setFontColor('#ffcc80')"
                data-color="#ffcc80"
              ></div>
              <div
                class="color-option custom-color"
                id="customColorOption"
                onclick="openCustomColorPicker()"
              >
                <span>+</span>
              </div>
            </div>
            <input
              type="color"
              id="customColorInput"
              style="position: absolute; width: 1px; height: 1px; opacity: 0"
              onchange="applyCustomFontColor(this.value)"
            />
          </div>

          <!-- APPÂõæÊ†áÂíåÂêçÁß∞ËÆæÁΩÆ -->
          <div class="appearance-section">
            <h3>‚ñ° APPËá™ÂÆö‰πâ</h3>
            <div class="app-customize-list">
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_chat"
                  onclick="document.getElementById('iconInput_chat').click()"
                >
                  ËÅäÂ§©
                </div>
                <input
                  type="file"
                  id="iconInput_chat"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('chat', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_chat"
                  value="ËÅäÂ§©"
                  placeholder="APPÂêçÁß∞"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_worldbook"
                  onclick="document.getElementById('iconInput_worldbook').click()"
                >
                  ‰∏ñÁïå‰π¶
                </div>
                <input
                  type="file"
                  id="iconInput_worldbook"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('worldbook', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_worldbook"
                  value="‰∏ñÁïå‰π¶"
                  placeholder="APPÂêçÁß∞"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_preset"
                  onclick="document.getElementById('iconInput_preset').click()"
                >
                  È¢ÑËÆæ
                </div>
                <input
                  type="file"
                  id="iconInput_preset"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('preset', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_preset"
                  value="È¢ÑËÆæ"
                  placeholder="APPÂêçÁß∞"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_forum"
                  onclick="document.getElementById('iconInput_forum').click()"
                >
                  ËÆ∫Âùõ
                </div>
                <input
                  type="file"
                  id="iconInput_forum"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('forum', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_forum"
                  value="ËÆ∫Âùõ"
                  placeholder="APPÂêçÁß∞"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_api"
                  onclick="document.getElementById('iconInput_api').click()"
                >
                  API
                </div>
                <input
                  type="file"
                  id="iconInput_api"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('api', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_api"
                  value="APIËÆæÁΩÆ"
                  placeholder="APPÂêçÁß∞"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_font"
                  onclick="document.getElementById('iconInput_font').click()"
                >
                  Â≠ó‰Ωì
                </div>
                <input
                  type="file"
                  id="iconInput_font"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('font', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_font"
                  value="Â≠ó‰Ωì"
                  placeholder="APPÂêçÁß∞"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_appearance"
                  onclick="document.getElementById('iconInput_appearance').click()"
                >
                  Â§ñËßÇ
                </div>
                <input
                  type="file"
                  id="iconInput_appearance"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('appearance', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_appearance"
                  value="Â§ñËßÇËÆæÁΩÆ"
                  placeholder="APPÂêçÁß∞"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_couple"
                  onclick="document.getElementById('iconInput_couple').click()"
                >
                  ÊÉÖ‰æ£
                </div>
                <input
                  type="file"
                  id="iconInput_couple"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('couple', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_couple"
                  value="ÊÉÖ‰æ£Á©∫Èó¥"
                  placeholder="APPÂêçÁß∞"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_companion"
                  onclick="document.getElementById('iconInput_companion').click()"
                >
                  Èô™‰º¥
                </div>
                <input
                  type="file"
                  id="iconInput_companion"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('companion', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_companion"
                  value="Èô™‰º¥"
                  placeholder="APPÂêçÁß∞"
                />
              </div>
            </div>
          </div>

          <!-- ‰øùÂ≠òÊåâÈíÆ -->
          <button
            class="appearance-save-btn"
            onclick="saveAppearanceSettings()"
          >
            ‚òÖ ‰øùÂ≠òËÆæÁΩÆ
          </button>
        </div>
      </div>

      <!-- Bottom Dock -->
      <div class="dock">
        <div class="dock-item" onclick="openPage('apiPage')">
          <div class="dock-icon dock-blue">APIËÆæÁΩÆ</div>
          <span class="dock-label">APIËÆæÁΩÆ</span>
        </div>
        <div class="dock-item" onclick="openPage('fontPage')">
          <div class="dock-icon dock-purple">Â≠ó‰Ωì</div>
          <span class="dock-label">Â≠ó‰Ωì</span>
        </div>
        <div class="dock-item" onclick="openPage('appearancePage')">
          <div class="dock-icon dock-orange">Â§ñËßÇËÆæÁΩÆ</div>
          <span class="dock-label">Â§ñËßÇËÆæÁΩÆ</span>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div class="edit-modal" id="editModal">
      <div class="edit-modal-content">
        <div class="edit-modal-title" id="editModalTitle">ÁºñËæë</div>
        <input
          type="text"
          class="edit-input"
          id="editInput"
          placeholder="ËØ∑ËæìÂÖ•..."
        />
        <div class="edit-buttons">
          <button class="edit-btn edit-btn-cancel" onclick="closeEditModal()">
            ÂèñÊ∂à
          </button>
          <button class="edit-btn edit-btn-save" onclick="saveEdit()">
            ‰øùÂ≠ò
          </button>
        </div>
      </div>
    </div>

    <!-- ÂêçÁâáÊ†áÁ≠æÁºñËæëÂºπÁ™ó -->
    <div class="edit-modal" id="tagEditModal">
      <div class="edit-modal-content">
        <div class="edit-modal-title" id="tagEditTitle">ÁºñËæëÊ†áÁ≠æ</div>
        <input
          type="text"
          class="edit-input"
          id="tagEditInput"
          placeholder="ËØ∑ËæìÂÖ•..."
          maxlength="10"
        />
        <div class="edit-buttons">
          <button
            class="edit-btn edit-btn-cancel"
            onclick="closeTagEditModal()"
          >
            ÂèñÊ∂à
          </button>
          <button class="edit-btn edit-btn-save" onclick="saveTagEdit()">
            ‰øùÂ≠ò
          </button>
        </div>
      </div>
    </div>

    <!-- ÊÅãÁà±Á∫™ÂøµÁºñËæëÂºπÁ™ó -->
    <div class="edit-modal" id="loveEditModal">
      <div class="edit-modal-content">
        <div class="edit-modal-title" id="loveEditTitle">ÁºñËæë</div>
        <input
          type="text"
          class="edit-input"
          id="loveEditInput"
          placeholder="ËØ∑ËæìÂÖ•..."
        />
        <div class="edit-buttons">
          <button
            class="edit-btn edit-btn-cancel"
            onclick="closeLoveEditModal()"
          >
            ÂèñÊ∂à
          </button>
          <button class="edit-btn edit-btn-save" onclick="saveLoveEdit()">
            ‰øùÂ≠ò
          </button>
        </div>
      </div>
    </div>

    <!-- ÊÅãÁà±Â∞èÁªÑ‰ª∂ÈÄâÈ°πÂºπÁ™ó -->
    <div class="edit-modal" id="loveWidgetOptionsModal">
      <div class="edit-modal-content" style="padding: 16px">
        <div class="edit-modal-title">Â∞èÁªÑ‰ª∂ËÆæÁΩÆ</div>
        <div class="love-widget-options">
          <div class="love-widget-option" onclick="triggerLoveWidgetBgUpload()">
            <span class="love-widget-option-icon">üñºÔ∏è</span>
            <span>Êõ¥Êç¢ËÉåÊôØÂõæ</span>
          </div>
          <div
            class="love-widget-option"
            onclick="setLoveWidgetTextColor('dark')"
          >
            <span class="love-widget-option-icon">‚¨õ</span>
            <span>Â≠ó‰ΩìÊîπÈªëËâ≤</span>
          </div>
          <div
            class="love-widget-option"
            onclick="setLoveWidgetTextColor('light')"
          >
            <span class="love-widget-option-icon">‚¨ú</span>
            <span>Â≠ó‰ΩìÊîπÁôΩËâ≤</span>
          </div>
        </div>
        <button
          class="edit-btn edit-btn-cancel"
          style="width: 100%; margin-top: 12px"
          onclick="closeLoveWidgetOptionsModal()"
        >
          ÂèñÊ∂à
        </button>
      </div>
    </div>

    <!-- ÂàÜÁªÑÁÆ°ÁêÜÂºπÁ™ó -->
    <div
      class="edit-modal"
      id="groupManagerModal"
      style="z-index: var(--z-toast)"
    >
      <div class="edit-modal-content" style="max-width: 320px">
        <div class="edit-modal-title">ÁÆ°ÁêÜÂàÜÁªÑ</div>
        <div class="group-list" id="groupList">
          <!-- Âä®ÊÄÅÊ∏≤ÊüìÂàÜÁªÑÂàóË°® -->
        </div>
        <div class="group-add-row">
          <input
            type="text"
            class="edit-input"
            id="newGroupInput"
            placeholder="ËæìÂÖ•Êñ∞ÂàÜÁªÑÂêçÁß∞..."
            style="flex: 1; margin-bottom: 0"
          />
          <button
            class="edit-btn edit-btn-save"
            onclick="addNewGroup()"
            style="margin-left: 8px; width: 60px"
          >
            Ê∑ªÂä†
          </button>
        </div>
        <div class="edit-buttons" style="margin-top: 16px">
          <button
            class="edit-btn edit-btn-cancel"
            onclick="closeGroupManager()"
          >
            ÂÖ≥Èó≠
          </button>
        </div>
      </div>
    </div>

    <!-- Create Character Modal -->
    <div class="edit-modal" id="createCharModal">
      <div class="create-char-content">
        <div class="create-char-title">ÂàõÂª∫Êñ∞ËßíËâ≤</div>

        <!-- Avatar upload -->
        <div
          class="create-avatar-section"
          onclick="document.getElementById('charAvatarInput').click()"
        >
          <div class="create-avatar">
            <span class="create-avatar-placeholder" id="charAvatarPlaceholder"
              ><svg
                width="32"
                height="32"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline></svg
            ></span>
            <img id="charAvatarPreview" src="" alt="" style="display: none" />
          </div>
          <span class="create-avatar-hint">ÁÇπÂáª‰∏ä‰º†Â§¥ÂÉè</span>
        </div>
        <input
          type="file"
          id="charAvatarInput"
          class="hidden-input"
          accept="image/*"
          onchange="previewCharAvatar(this)"
        />

        <!-- Name input -->
        <div class="create-input-group">
          <label class="create-label"
            >ËßíËâ≤ÂêçÁß∞ <span class="required">*</span></label
          >
          <input
            type="text"
            class="create-input"
            id="charNameInput"
            placeholder="ËØ∑ËæìÂÖ•ËßíËâ≤ÂêçÁß∞"
          />
        </div>

        <!-- Note input -->
        <div class="create-input-group">
          <label class="create-label"
            >Â§áÊ≥® <span class="optional">(ÈÄâÂ°´)</span></label
          >
          <input
            type="text"
            class="create-input"
            id="charNoteInput"
            placeholder="Ê∑ªÂä†Â§áÊ≥®‰ø°ÊÅØ"
          />
        </div>

        <!-- Buttons -->
        <div class="create-buttons">
          <button
            class="create-btn create-btn-cancel"
            onclick="closeCreateCharModal()"
          >
            ÂèñÊ∂à
          </button>
          <button
            class="create-btn create-btn-confirm"
            onclick="createCharacter()"
          >
            ÂàõÂª∫
          </button>
        </div>
      </div>
    </div>

    <!-- Create Group Chat Modal -->
    <div
      class="create-group-modal"
      id="createGroupModal"
      onclick="if(event.target===this)closeCreateGroupModal()"
    >
      <div class="create-group-content">
        <div class="create-group-header">
          <span class="create-group-title">ÂàõÂª∫Áæ§ËÅä</span>
          <button class="create-group-close" onclick="closeCreateGroupModal()">
            ‚úï
          </button>
        </div>
        <div class="create-group-body">
          <!-- Áæ§ËÅäÂ§¥ÂÉè -->
          <div class="create-group-avatar-section">
            <div
              class="create-group-avatar"
              id="groupAvatarPreview"
              onclick="document.getElementById('groupAvatarInput').click()"
            >
              <span id="groupAvatarPlaceholder">üë•</span>
              <img id="groupAvatarImg" src="" style="display: none" />
            </div>
            <div class="create-group-avatar-hint">ÁÇπÂáª‰∏ä‰º†Áæ§Â§¥ÂÉèÔºàÂèØÈÄâÔºâ</div>
            <input
              type="file"
              id="groupAvatarInput"
              accept="image/*"
              style="display: none"
              onchange="previewGroupAvatar(this)"
            />
          </div>

          <!-- Áæ§ËÅäÂêçÁß∞ -->
          <div class="create-group-input-section">
            <label class="create-group-label"
              >Áæ§ËÅäÂêçÁß∞ <span style="color: #f48fb1">*</span></label
            >
            <input
              type="text"
              class="create-group-input"
              id="groupNameInput"
              placeholder="ËæìÂÖ•Áæ§ËÅäÂêçÁß∞..."
              oninput="checkGroupCreateValid()"
            />
          </div>

          <!-- ÈÄâÊã©ÊàêÂëò -->
          <div class="create-group-members-title">
            <span>ÈÄâÊã©Áæ§ÊàêÂëò</span>
            <span class="create-group-members-count" id="selectedMembersCount"
              >Â∑≤ÈÄâ 0 ‰∫∫</span
            >
          </div>
          <div class="create-group-members-list" id="groupMembersList">
            <!-- ËßíËâ≤ÂàóË°®‰ºöÂä®ÊÄÅÊ∏≤Êüì -->
          </div>
        </div>
        <div class="create-group-footer">
          <button
            class="create-group-btn cancel"
            onclick="closeCreateGroupModal()"
          >
            ÂèñÊ∂à
          </button>
          <button
            class="create-group-btn confirm"
            id="createGroupConfirmBtn"
            onclick="createGroupChat()"
            disabled
          >
            ÂàõÂª∫Áæ§ËÅä
          </button>
        </div>
      </div>
    </div>

    <!-- Group Settings Modal (Ê∑ªÂä†Áæ§ÊàêÂëò) -->
    <div
      class="create-group-modal"
      id="addGroupMemberModal"
      onclick="if(event.target===this)closeAddGroupMemberModal()"
    >
      <div class="create-group-content">
        <div class="create-group-header">
          <span class="create-group-title">Ê∑ªÂä†Áæ§ÊàêÂëò</span>
          <button
            class="create-group-close"
            onclick="closeAddGroupMemberModal()"
          >
            ‚úï
          </button>
        </div>
        <div class="create-group-body">
          <div class="create-group-members-title">
            <span>ÈÄâÊã©Ë¶ÅÊ∑ªÂä†ÁöÑÊàêÂëò</span>
            <span class="create-group-members-count" id="addMembersCount"
              >Â∑≤ÈÄâ 0 ‰∫∫</span
            >
          </div>
          <div class="create-group-members-list" id="addMembersList">
            <!-- ÂèØÊ∑ªÂä†ÁöÑËßíËâ≤ÂàóË°® -->
          </div>
        </div>
        <div class="create-group-footer">
          <button
            class="create-group-btn cancel"
            onclick="closeAddGroupMemberModal()"
          >
            ÂèñÊ∂à
          </button>
          <button
            class="create-group-btn confirm"
            id="addMemberConfirmBtn"
            onclick="confirmAddGroupMembers()"
            disabled
          >
            Ê∑ªÂä†
          </button>
        </div>
      </div>
    </div>

    <!-- Áæ§ËÅä‰∏ìÁî®ËÆæÁΩÆÈ°µÈù¢ -->
    <!-- Áæ§ÊàêÂëòÁÆ°ÁêÜÂºπÁ™ó -->
    <div
      class="create-group-modal"
      id="groupMemberManagerModal"
      onclick="if(event.target===this)closeGroupMemberManager()"
    >
      <div class="create-group-content">
        <div class="create-group-header">
          <span class="create-group-title">ÁÆ°ÁêÜÁæ§ÊàêÂëò</span>
          <button
            class="create-group-close"
            onclick="closeGroupMemberManager()"
          >
            ‚úï
          </button>
        </div>
        <div class="create-group-body">
          <div class="create-group-members-title">
            <span>Áæ§ÊàêÂëòÂàóË°®</span>
            <span class="create-group-members-count" id="manageMembersCount"
              >ÂÖ± 0 ‰∫∫</span
            >
          </div>
          <div class="create-group-members-list" id="manageMembersList">
            <!-- Áæ§ÊàêÂëòÂàóË°®‰ºöÂä®ÊÄÅÊ∏≤Êüì -->
          </div>
          <div
            style="
              margin-top: 16px;
              padding-top: 16px;
              border-top: 1px dashed rgba(0, 0, 0, 0.1);
            "
          >
            <button
              class="create-group-btn confirm"
              onclick="closeGroupMemberManager();setTimeout(openAddGroupMemberModal, 300);"
              style="width: 100%"
            >
              ‚ûï Ê∑ªÂä†Êñ∞ÊàêÂëò
            </button>
          </div>
        </div>
        <div class="create-group-footer">
          <button
            class="create-group-btn cancel"
            onclick="closeGroupMemberManager()"
            style="width: 100%"
          >
            ÂÆåÊàê
          </button>
        </div>
      </div>
    </div>

    <!-- Áæ§ËÅä‰∏ìÁî®ËÆæÁΩÆÈ°µÈù¢ -->
    <div class="chat-settings-page" id="groupChatSettingsPage">
      <div class="settings-header">
        <button class="settings-back-btn" onclick="closeGroupChatSettings()">
          ‚Äπ
        </button>
        <div class="settings-header-title">Áæ§ËÅäËÆæÁΩÆ</div>
        <button
          class="settings-save-btn"
          onclick="saveGroupChatSettingsAndClose()"
        >
          ‰øùÂ≠ò
        </button>
      </div>
      <div class="settings-content" id="groupSettingsContent">
        <!-- Âä®ÊÄÅÁîüÊàêÂÜÖÂÆπ -->
      </div>
    </div>

    <div class="chat-conversation-page" id="chatConversationPage">
      <div class="conv-header">
        <button class="conv-back-btn" onclick="closeConversation()">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <div class="conv-title-section">
          <div class="conv-avatar" id="convAvatar">AI</div>
          <span class="conv-name" id="convName">ËßíËâ≤ÂêçÁß∞</span>
        </div>
        <div class="conv-header-btns">
          <button
            class="conv-heart-btn"
            id="heartVoiceBtn"
            onclick="showHeartVoice()"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
              ></path>
            </svg>
          </button>
          <button class="conv-menu-btn" onclick="openChatSettings()">
            <svg
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="12" cy="12" r="3"></circle>
              <path
                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
              ></path>
            </svg>
          </button>
        </div>
      </div>

      <div class="conv-menu" id="convMenu">
        <div class="conv-menu-item" onclick="clearChatHistory()">
          ‚úï Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï
        </div>
        <div class="conv-menu-item" onclick="deleteCharacter()">
          ‚úï Âà†Èô§Ê≠§ËßíËâ≤
        </div>
      </div>

      <!-- Áæ§ÂÖ¨ÂëäÊ†è - ‰ªÖÁæ§ËÅäÊòæÁ§∫ -->
      <div
        class="group-announcement-bar"
        id="groupAnnouncementBar"
        style="display: none"
        onclick="openGroupAnnouncementModal()"
      >
        <span class="group-announcement-icon">üì¢</span>
        <span class="group-announcement-text" id="groupAnnouncementText"
          >ÁÇπÂáªËÆæÁΩÆÁæ§ÂÖ¨Âëä</span
        >
        <span class="group-announcement-arrow">‚Ä∫</span>
      </div>

      <div class="conv-messages" id="convMessages" onclick="closeChatPanel()">
        <div class="conv-empty">
          <div class="conv-empty-icon">
            <svg
              width="48"
              height="48"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
              ></path>
            </svg>
          </div>
          <div class="conv-empty-text">ÂºÄÂßãÂíåTAËÅäÂ§©ÂêßÔΩû</div>
        </div>
      </div>

      <div class="conv-input-area" id="inputArea">
        <!-- ÂºïÁî®È¢ÑËßàÂå∫Âüü -->
        <div class="quote-preview" id="quotePreview" style="display: none">
          <div class="quote-preview-content">
            <div class="quote-preview-sender" id="quotePreviewSender"></div>
            <div class="quote-preview-text" id="quotePreviewText"></div>
          </div>
          <button class="quote-preview-close" onclick="cancelQuote()">‚úï</button>
        </div>

        <!-- Áæ§ËÅäÂºïÁî®È¢ÑËßàÂå∫Âüü -->
        <div class="group-quote-preview" id="groupQuotePreview">
          <div class="group-quote-preview-content">
            <div
              class="group-quote-preview-sender"
              id="groupQuotePreviewSender"
            ></div>
            <div
              class="group-quote-preview-text"
              id="groupQuotePreviewText"
            ></div>
          </div>
          <button
            class="group-quote-preview-close"
            onclick="cancelGroupQuote()"
          >
            ‚úï
          </button>
        </div>

        <!-- @ÈÄâÊã©Âô®ÂºπÁ™ó -->
        <div class="at-selector-popup" id="atSelectorPopup"></div>

        <div class="conv-input-bar">
          <button class="tool-btn icon-btn" onclick="toggleChatPanel('plus')">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>

          <div class="conv-input-wrapper">
            <textarea
              class="conv-input"
              id="convInput"
              placeholder="ËæìÂÖ•Ê∂àÊÅØ..."
              rows="1"
              oninput="autoResizeTextarea(this)"
              onfocus="closeChatPanel()"
            ></textarea>
            <button class="emoji-btn-inner" onclick="toggleChatPanel('emoji')">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
              >
                <circle cx="12" cy="12" r="10" />
                <path d="M8 14s1.5 2 4 2 4-2 4-2" />
                <line x1="9" y1="9" x2="9.01" y2="9" />
                <line x1="15" y1="9" x2="15.01" y2="9" />
              </svg>
            </button>
          </div>

          <button class="ai-magic-btn" onclick="requestAIReply()" id="replyBtn">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M12 3l1.5 4.5L18 9l-4.5 1.5L12 15l-1.5-4.5L6 9l4.5-1.5L12 3z"
              ></path>
              <path d="M5 19l1 3 1-3 3-1-3-1-1-3-1 3-3 1 3 1z"></path>
              <path
                d="M18 14l.5 1.5 1.5.5-1.5.5-.5 1.5-.5-1.5-1.5-.5 1.5-.5.5-1.5z"
              ></path>
            </svg>
          </button>

          <button class="conv-send-btn" onclick="sendUserMessage()">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="12" y1="19" x2="12" y2="5"></line>
              <polyline points="5 12 12 5 19 12"></polyline>
            </svg>
          </button>
        </div>

        <div class="chat-panel" id="plusPanel">
          <div class="panel-grid">
            <div class="panel-item" onclick="rerollAIReply()">
              <div class="panel-icon-box bg-reroll">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <polyline points="23 4 23 10 17 10"></polyline>
                  <polyline points="1 20 1 14 7 14"></polyline>
                  <path
                    d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
                  ></path>
                </svg>
              </div>
              <span class="panel-label">Èáçroll</span>
            </div>
            <div class="panel-item" onclick="openSendImageModal()">
              <div class="panel-icon-box bg-camera">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <circle cx="8.5" cy="8.5" r="1.5"></circle>
                  <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
              </div>
              <span class="panel-label">ÁÖßÁâá</span>
            </div>
            <div class="panel-item" onclick="startVoiceCall()">
              <div class="panel-icon-box bg-call">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                  ></path>
                </svg>
              </div>
              <span class="panel-label">ËØ≠Èü≥ÈÄöËØù</span>
            </div>
            <div class="panel-item" onclick="startVideoCall()">
              <div class="panel-icon-box bg-video">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <polygon points="23 7 16 12 23 17 23 7"></polygon>
                  <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                </svg>
              </div>
              <span class="panel-label">ËßÜÈ¢ëÈÄöËØù</span>
            </div>
            <div class="panel-item" onclick="sendFakeLocation()">
              <div class="panel-icon-box bg-location">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"
                  ></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
              </div>
              <span class="panel-label">‰ΩçÁΩÆ</span>
            </div>
            <div class="panel-item" onclick="openVoiceMessageModal()">
              <div class="panel-icon-box bg-voice-msg">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"
                  ></path>
                  <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                  <line x1="12" y1="19" x2="12" y2="23"></line>
                  <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
              </div>
              <span class="panel-label">ËØ≠Èü≥</span>
            </div>
            <div class="panel-item" onclick="openTransferModal()">
              <div class="panel-icon-box bg-transfer">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <line x1="12" y1="1" x2="12" y2="23"></line>
                  <path
                    d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
                  ></path>
                </svg>
              </div>
              <span class="panel-label">ËΩ¨Ë¥¶</span>
            </div>
            <div class="panel-item" onclick="openReadTogether()">
              <div class="panel-icon-box bg-book">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                  <path
                    d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"
                  ></path>
                </svg>
              </div>
              <span class="panel-label">‰∏ÄËµ∑ËØª‰π¶</span>
            </div>
            <div class="panel-item" onclick="openMusicTogether()">
              <div class="panel-icon-box bg-music">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M9 18V5l12-2v13"></path>
                  <circle cx="6" cy="18" r="3"></circle>
                  <circle cx="18" cy="16" r="3"></circle>
                </svg>
              </div>
              <span class="panel-label">‰∏ÄËµ∑Âê¨Ê≠å</span>
            </div>
            <div class="panel-item" onclick="openPhonePeek()">
              <div class="panel-icon-box bg-phone">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                >
                  <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
                  <line x1="12" y1="18" x2="12.01" y2="18"></line>
                </svg>
              </div>
              <span class="panel-label">Êü•ÊâãÊú∫</span>
            </div>
          </div>
          <input
            type="file"
            id="chatImgInput"
            hidden
            accept="image/*"
            onchange="handleChatImageUpload(this)"
          />
          <div class="panel-item" onclick="continueChat()">
            <div class="panel-icon-box bg-continue">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M5 12h14"></path>
                <path d="M12 5l7 7-7 7"></path>
              </svg>
            </div>
            <span class="panel-label">Áª≠ÂÜô</span>
          </div>
        </div>

        <div class="chat-panel" id="emojiPanel">
          <!-- ÊêúÁ¥¢Ê°Ü -->
          <div class="sticker-search-bar">
            <input
              type="text"
              class="sticker-search-input"
              id="stickerSearchInput"
              placeholder="ÊêúÁ¥¢Ë°®ÊÉÖÂåÖ..."
              oninput="handleStickerSearch(this.value)"
            />
            <span
              class="sticker-search-clear"
              id="stickerSearchClear"
              onclick="clearStickerSearch()"
              >‚úï</span
            >
          </div>

          <div class="sticker-category-bar" id="stickerCategoryBar"></div>

          <div class="emoji-grid" id="stickerGrid"></div>

          <input
            type="file"
            id="stickerInput"
            hidden
            accept="image/*,.txt"
            multiple
            onchange="handleStickerImport(this)"
          />
        </div>
      </div>
    </div>

    <!-- ‰∏ÄËµ∑ËØª‰π¶È°µÈù¢ -->
    <div class="read-together-page" id="readTogetherPage">
      <div class="read-header">
        <button class="read-header-back" onclick="closeReadTogether()">
          ‚Üê
        </button>
        <div class="read-header-title">üìñ ‰∏ÄËµ∑ËØª‰π¶</div>
        <div style="width: 36px"></div>
      </div>
      <div class="read-content">
        <!-- ÊàëÁöÑ‰π¶Êû∂ -->
        <div class="bookshelf-section">
          <div class="bookshelf-title">‚â° ÊàëÁöÑ‰π¶Êû∂</div>
          <div class="bookshelf-grid" id="bookshelfGrid">
            <!-- ‰π¶Á±çÂç°Áâá‰ºöÂä®ÊÄÅÁîüÊàê -->
            <div
              class="book-card add-book-card"
              onclick="document.getElementById('bookFileInput').click()"
            >
              <div style="font-size: 32px; margin-bottom: 8px">+</div>
              <div>ÂØºÂÖ•Êñ∞‰π¶</div>
            </div>
          </div>
          <input
            type="file"
            id="bookFileInput"
            hidden
            accept=".txt"
            onchange="handleBookImport(this)"
          />
        </div>

        <!-- ÂΩìÂâçÈòÖËØª -->
        <div id="currentReadingSection" style="display: none">
          <div class="bookshelf-title">‚â° ÂΩìÂâçÈòÖËØª</div>
          <div class="read-book-info">
            <div class="read-book-title">
              <span>‚â°</span>
              <span id="readBookName">‰π¶Âêç</span>
              <span class="read-status-badge" id="readStatusBadge">
                <span>‚úì</span> ÈòÖËØª‰∏≠
              </span>
            </div>
            <div class="read-book-progress" id="readBookProgress">
              ËøõÂ∫¶ÔºöÁ¨¨ 1 È°µ / ÂÖ± 100 È°µ
            </div>
            <div class="read-progress-bar">
              <div
                class="read-progress-fill"
                id="readProgressFill"
                style="width: 0%"
              ></div>
            </div>
          </div>

          <div class="read-current-section">
            <div class="read-section-label">üìç ÂΩìÂâçÈ°µÂÜÖÂÆπ</div>
            <div class="read-section-text" id="readSectionText">
              ËøôÈáåÊòæÁ§∫ÂΩìÂâçÈ°µÁöÑÂÜÖÂÆπ...
            </div>
            <div class="read-controls">
              <button class="read-ctrl-btn prev" onclick="readPrevSection()">
                ‚Üê ‰∏ä‰∏ÄÈ°µ
              </button>
              <button class="read-ctrl-btn next" onclick="readNextSection()">
                ‰∏ã‰∏ÄÈ°µ ‚Üí
              </button>
            </div>
          </div>

          <div class="read-settings">
            <div class="read-setting-row">
              <span class="read-setting-label">Ë∑≥ËΩ¨Âà∞Á¨¨</span>
              <div class="read-setting-value">
                <input
                  type="number"
                  class="read-setting-input"
                  id="readJumpTo"
                  value="1"
                  min="1"
                />
                <span>È°µ</span>
                <button
                  class="read-ctrl-btn next"
                  style="flex: none; padding: 6px 12px"
                  onclick="jumpToSection()"
                >
                  Ë∑≥ËΩ¨
                </button>
              </div>
            </div>
            <div class="read-setting-row">
              <span class="read-setting-label">ÂºÄÂêØÊÇ¨ÊµÆÁ™ó</span>
              <div class="read-setting-value">
                <button
                  class="read-ctrl-btn next"
                  style="flex: none; padding: 8px 16px"
                  onclick="startFloatingMode()"
                >
                  ‚Ä¢ ÊÇ¨ÊµÆÈòÖËØª
                </button>
              </div>
            </div>
            <div class="read-setting-row">
              <button
                class="read-ctrl-btn prev"
                style="width: 100%; background: #fff3e0; color: #ff9800"
                onclick="stopCurrentReading()"
              >
                ‚è∏Ô∏è ÊöÇÂÅúÈòÖËØªÔºàÂõûÂà∞‰π¶Êû∂Ôºâ
              </button>
            </div>
          </div>
        </div>

        <!-- ÂØºÂÖ•ËÆæÁΩÆ -->
        <div class="read-settings" style="margin-top: 16px">
          <div class="bookshelf-title" style="margin-bottom: 12px">
            üì• ÂØºÂÖ•ËÆæÁΩÆ
          </div>
          <div class="read-setting-row">
            <span class="read-setting-label">ÊØèÈ°µÂ≠óÊï∞</span>
            <div class="read-setting-value">
              <input
                type="number"
                class="read-setting-input"
                id="readChunkSize"
                value="500"
                min="100"
                max="3000"
                style="width: 70px"
              />
              <span>Â≠ó</span>
            </div>
          </div>
          <div style="font-size: 0.8rem; color: #888; margin-top: 8px">
            ÊèêÁ§∫ÔºöÂØºÂÖ•Êñ∞‰π¶Êó∂ÁîüÊïà„ÄÇÂ≠óÊï∞Ë∂äÂ∞ëÁøªÈ°µË∂äÈ¢ëÁπÅÔºåÂ≠óÊï∞Ë∂äÂ§öÊØèÈ°µÂÜÖÂÆπË∂äÈïø„ÄÇ
          </div>
        </div>

        <!-- ‰ΩøÁî®ËØ¥Êòé -->
        <div class="read-settings" style="margin-top: 16px">
          <div
            class="read-setting-row"
            style="flex-direction: column; align-items: flex-start; gap: 8px"
          >
            <span class="read-setting-label">üìñ ‰ΩøÁî®ËØ¥Êòé</span>
            <div style="font-size: 0.85rem; color: #666; line-height: 1.6">
              1. ËÆæÁΩÆÊØèÈ°µÂ≠óÊï∞ÔºåÁÑ∂ÂêéÂØºÂÖ•TXT‰π¶Á±ç<br />
              2. ÁÇπÂáª‰π¶Á±çÂç°ÁâáÂºÄÂßãÈòÖËØª<br />
              3. ÁÇπÂáª„Äå‚Ä¢ ÊÇ¨ÊµÆÈòÖËØª„ÄçÂºÄÂêØÊÇ¨ÊµÆÁ™ó<br />
              4. ÊÇ¨ÊµÆÁ™óÂèØ‰ª•ÊãñÂä®„ÄÅÁº©ÊîæÔºåËæπÁúã‰π¶ËæπËÅäÂ§©<br />
              5. AI‰ºöÊ†πÊçÆÂΩìÂâçÈòÖËØªÂÜÖÂÆπ‰∏é‰Ω†‰∫íÂä®
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ÊÇ¨ÊµÆÈòÖËØªÊåâÈíÆ -->
    <button
      class="read-floating-btn"
      id="readFloatingBtn"
      onclick="toggleFloatingPanel()"
    >
      ‚â°
    </button>

    <!-- ÊÇ¨ÊµÆÈòÖËØªÈù¢Êùø -->
    <div class="read-floating-panel" id="readFloatingPanel">
      <div class="read-float-header" id="floatPanelHeader">
        <span class="read-float-drag-hint">‚ãÆ‚ãÆ</span>
        <div class="read-float-title" id="floatBookTitle">‰π¶Âêç</div>
        <div class="read-float-progress" id="floatProgress">Á¨¨1È°µ</div>
        <button class="read-float-close" onclick="toggleFloatingPanel()">
          ‚úï
        </button>
      </div>
      <div class="read-float-content" id="floatContent">ÂΩìÂâçÈ°µÂÜÖÂÆπ...</div>
      <div class="read-float-controls">
        <button
          class="read-float-btn"
          onclick="readPrevSection();updateFloatingPanel();"
        >
          ‚Üê ‰∏ä‰∏ÄÈ°µ
        </button>
        <button
          class="read-float-btn primary"
          onclick="readNextSection();updateFloatingPanel();"
        >
          ‰∏ã‰∏ÄÈ°µ ‚Üí
        </button>
        <button
          class="read-float-btn"
          onclick="openReadTogether();hideFloatingPanel();"
        >
          üìñ ‰π¶Êû∂
        </button>
      </div>
      <div class="read-float-resize-handle" id="floatResizeHandle"></div>
    </div>

    <!-- Chat Settings Page -->
    <div class="chat-settings-page" id="chatSettingsPage">
      <div class="settings-header">
        <button class="settings-back-btn" onclick="closeChatSettings()">
          ‚Äπ
        </button>
        <div class="settings-header-title">ËÅäÂ§©ËÆæÁΩÆ</div>
        <button class="settings-save-btn" onclick="saveChatSettingsAndClose()">
          ‰øùÂ≠ò
        </button>
      </div>

      <div class="settings-content">
        <!-- Section 1: Basic Info -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon brown">üìù</div>
            <span class="section-title">Âü∫Á°ÄËµÑÊñô</span>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label"
                >ËßíËâ≤ÁúüÂêç / Áæ§ËÅäÂêçÁß∞
                <span class="form-hint">(AIÂè™ËÆ§Ëøô‰∏™)</span></label
              >
              <input
                type="text"
                class="form-input"
                id="settingsCharName"
                placeholder="ËæìÂÖ•ËßíËâ≤ÂêçÁß∞..."
              />
            </div>
            <div class="form-group">
              <label class="form-label"
                >Â§áÊ≥®Âêç
                <span class="form-hint">(‰ªÖÊòæÁ§∫Áî®ÔºåAI‰∏çÁü•ÈÅì)</span></label
              >
              <input
                type="text"
                class="form-input"
                id="settingsCharNote"
                placeholder="ËæìÂÖ•Â§áÊ≥®Âêç..."
              />
            </div>
            <div class="form-group">
              <label class="form-label">Â•ΩÂèãÂàÜÁªÑ</label>
              <div class="form-select-wrapper">
                <select class="form-select" id="settingsGroup">
                  <option value="none">Êú™ÂàÜÁªÑ</option>
                </select>
                <button class="form-btn-small" onclick="openGroupManager()">
                  ÁÆ°ÁêÜ
                </button>
              </div>
            </div>

            <!-- ÁΩÆÈ°∂ËÅîÁ≥ª‰∫∫ -->
            <div class="form-group">
              <label class="form-label">ËÅäÂ§©ÂàóË°®ËÆæÁΩÆ</label>
              <div class="avatar-toggle-group">
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="settingsPinned"
                    onchange="togglePinContact()"
                  />
                  <span class="toggle-label">‚Ä¢ ÁΩÆÈ°∂Ê≠§ËÅîÁ≥ª‰∫∫</span>
                </label>
              </div>
            </div>

            <!-- Avatar Upload -->
            <div class="avatar-upload-row">
              <div class="avatar-upload-col">
                <div class="avatar-upload-label">ÂØπÊñπÂ§¥ÂÉè</div>
                <div
                  class="avatar-preview"
                  id="settingsOtherAvatar"
                  onclick="document.getElementById('otherAvatarInput').click()"
                >
                  <span id="otherAvatarPlaceholder"
                    ><svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <rect
                        x="3"
                        y="3"
                        width="18"
                        height="18"
                        rx="2"
                        ry="2"
                      ></rect>
                      <circle cx="8.5" cy="8.5" r="1.5"></circle>
                      <polyline points="21 15 16 10 5 21"></polyline></svg
                  ></span>
                  <img id="otherAvatarImg" src="" style="display: none" />
                </div>
                <input
                  type="file"
                  id="otherAvatarInput"
                  class="hidden-input"
                  accept="image/*"
                  onchange="previewSettingsAvatar(this, 'other')"
                />
                <div class="avatar-actions">
                  <button
                    class="avatar-action-btn"
                    onclick="document.getElementById('otherAvatarInput').click()"
                  >
                    ‰∏ä‰º†
                  </button>
                  <button
                    class="avatar-action-btn"
                    onclick="clearSettingsAvatar('other')"
                  >
                    Ê∏ÖÈô§
                  </button>
                </div>
              </div>
              <div class="avatar-upload-col">
                <div class="avatar-upload-label">ÊàëÁöÑÂ§¥ÂÉè</div>
                <div
                  class="avatar-preview"
                  id="settingsMyAvatar"
                  onclick="document.getElementById('myAvatarInput').click()"
                >
                  <span id="myAvatarPlaceholder"
                    ><svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <rect
                        x="3"
                        y="3"
                        width="18"
                        height="18"
                        rx="2"
                        ry="2"
                      ></rect>
                      <circle cx="8.5" cy="8.5" r="1.5"></circle>
                      <polyline points="21 15 16 10 5 21"></polyline></svg
                  ></span>
                  <img id="myAvatarImg" src="" style="display: none" />
                </div>
                <input
                  type="file"
                  id="myAvatarInput"
                  class="hidden-input"
                  accept="image/*"
                  onchange="previewSettingsAvatar(this, 'my')"
                />
                <div class="avatar-actions">
                  <button
                    class="avatar-action-btn"
                    onclick="document.getElementById('myAvatarInput').click()"
                  >
                    ‰∏ä‰º†
                  </button>
                  <button
                    class="avatar-action-btn"
                    onclick="clearSettingsAvatar('my')"
                  >
                    Ê∏ÖÈô§
                  </button>
                </div>
              </div>
            </div>

            <!-- Â§¥ÂÉèÊòæÁ§∫ÂºÄÂÖ≥ -->
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">Â§¥ÂÉèÊòæÁ§∫ËÆæÁΩÆ</label>
              <div class="avatar-toggle-group">
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="showAiAvatar"
                    checked
                    onchange="toggleAvatarDisplay()"
                  />
                  <span class="toggle-label">ÊòæÁ§∫AIÂ§¥ÂÉè</span>
                </label>
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="showUserAvatar"
                    checked
                    onchange="toggleAvatarDisplay()"
                  />
                  <span class="toggle-label">ÊòæÁ§∫ÊàëÁöÑÂ§¥ÂÉè</span>
                </label>
              </div>
            </div>

            <!-- Â§¥ÂÉèÂ§ßÂ∞èË∞ÉËäÇ -->
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">Â§¥ÂÉèÂ§ßÂ∞è</label>
              <div style="display: flex; align-items: center; gap: 12px">
                <input
                  type="range"
                  id="avatarSizeSlider"
                  min="28"
                  max="56"
                  value="40"
                  style="flex: 1; accent-color: #f48fb1"
                  oninput="updateAvatarSizePreview(this.value)"
                  onchange="saveAvatarSize(this.value)"
                />
                <span
                  id="avatarSizeValue"
                  style="
                    min-width: 45px;
                    text-align: center;
                    font-size: 0.9rem;
                    color: #666;
                  "
                  >40px</span
                >
              </div>
            </div>

            <!-- Ê∞îÊ≥°Èó¥Ë∑ùË∞ÉËäÇ -->
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">Ê∞îÊ≥°Èó¥Ë∑ù</label>
              <div style="display: flex; align-items: center; gap: 12px">
                <input
                  type="range"
                  id="bubbleGapSlider"
                  min="2"
                  max="20"
                  value="6"
                  style="flex: 1; accent-color: #f48fb1"
                  oninput="updateBubbleGapPreview(this.value)"
                  onchange="saveBubbleGap(this.value)"
                />
                <span
                  id="bubbleGapValue"
                  style="
                    min-width: 45px;
                    text-align: center;
                    font-size: 0.9rem;
                    color: #666;
                  "
                  >6px</span
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Section 2: AI Brain & Persona -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon purple">üß†</div>
            <span class="section-title">ËÆæÂÆö</span>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label">ÂØπÊñπ‰∫∫ËÆæ (Persona)</label>
              <textarea
                class="form-input form-textarea"
                id="settingsPersona"
                placeholder="ÊèèËø∞AIËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅËÉåÊôØ„ÄÅËØ¥ËØùÊñπÂºèÁ≠â..."
              ></textarea>
            </div>
            <div class="form-group">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 8px;
                "
              >
                <label class="form-label" style="margin-bottom: 0"
                  >ÊàëÁöÑ‰∫∫ËÆæ (My Persona)</label
                >
                <div style="display: flex; gap: 8px">
                  <select
                    class="form-select"
                    id="userPersonaPresetSelect"
                    style="
                      padding: 6px 24px 6px 12px;
                      font-size: 0.8rem;
                      background-position: right 8px center;
                    "
                  >
                    <option value="">-- ÈÄâÊã©È¢ÑËÆæ --</option>
                  </select>
                  <button
                    class="form-btn-small"
                    onclick="saveUserPersonaPreset()"
                    style="padding: 6px 12px; font-size: 0.8rem"
                  >
                    ‰øùÂ≠òÈ¢ÑËÆæ
                  </button>
                </div>
              </div>
              <textarea
                class="form-input form-textarea"
                id="settingsMyPersona"
                placeholder="ÊèèËø∞‰Ω†Ëá™Â∑±ÁöÑËÆæÂÆöÔºåËÆ©AI‰∫ÜËß£‰Ω†..."
              ></textarea>
            </div>
            <div class="form-group">
              <label class="form-label"
                >ÂÖ≥ËÅî‰∏ñÁïå‰π¶
                <span class="form-hint">(Â§öÈÄâÔºåÂãæÈÄâÁîüÊïà)</span></label
              >
              <div class="worldbook-select-area" id="settingsWorldbookArea">
                <div class="worldbook-select-empty">
                  ËøòÊ≤°Êúâ‰∏ñÁïå‰π¶ÔºåÂéªÂàõÂª∫‰∏ÄÊú¨Âêß~
                </div>
              </div>
              <input type="hidden" id="settingsWorldbook" value="" />
            </div>
            <div
              class="form-group"
              style="
                margin-top: 18px;
                padding-top: 18px;
                border-top: 1px dashed #eee;
              "
            >
              <label class="form-label">üó£Ô∏è ËßíËâ≤Èü≥Ëâ≤ (Voice ID)</label>
              <div class="form-select-wrapper">
                <input
                  type="text"
                  class="form-input"
                  id="settingsVoiceId"
                  placeholder="‰æãÂ¶Ç: male-qn-qingse (ÈùíÊ∂©ÈùíÂπ¥)"
                />
                <button class="form-btn-small" onclick="testCharacterVoice()">
                  ËØïÂê¨
                </button>
              </div>
              <div class="form-hint">ËØ∑Â°´ÂÜô MiniMax ÁöÑÈü≥Ëâ≤ ID</div>
            </div>

            <!-- ÈÄöËØùËÆæÁΩÆ -->
            <div
              class="form-group"
              style="
                margin-top: 18px;
                padding-top: 18px;
                border-top: 1px dashed #eee;
              "
            >
              <label class="form-label"
                ><svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  style="vertical-align: middle; margin-right: 4px"
                >
                  <path
                    d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                  ></path></svg
                >ÈÄöËØùËÆæÁΩÆ</label
              >
              <div class="avatar-toggle-group" style="margin-top: 10px">
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="settingsCallVoiceEnabled"
                    onchange="saveCallSettings()"
                  />
                  <span class="toggle-label"
                    >ÈÄöËØùÊé•ÂÖ•ËØ≠Èü≥ (‰ΩøÁî®‰∏äÊñπVoice ID)</span
                  >
                </label>
              </div>
              <div class="avatar-toggle-group" style="margin-top: 8px">
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="settingsAiCallEnabled"
                    onchange="saveCallSettings()"
                  />
                  <span class="toggle-label">ÂÖÅËÆ∏TA‰∏ªÂä®ÊâìÁîµËØùÁªôÊàë</span>
                </label>
              </div>
              <div class="form-hint" style="margin-top: 8px">
                ÂºÄÂêØËØ≠Èü≥ÂêéÔºåÈÄöËØù‰∏≠AIÁöÑÂõûÂ§çÂ∞ÜËá™Âä®ÊúóËØª
              </div>

              <!-- ËßÜÈ¢ëÈÄöËØùÁîªÈù¢ËÆæÁΩÆ -->
              <div
                style="
                  margin-top: 16px;
                  padding-top: 16px;
                  border-top: 1px dashed #f0f0f0;
                "
              >
                <label class="form-label" style="font-size: 0.85rem"
                  ><svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    style="vertical-align: middle; margin-right: 4px"
                  >
                    <polygon points="23 7 16 12 23 17 23 7"></polygon>
                    <rect
                      x="1"
                      y="5"
                      width="15"
                      height="14"
                      rx="2"
                      ry="2"
                    ></rect></svg
                  >ËßÜÈ¢ëÈÄöËØùÁîªÈù¢</label
                >
                <div class="form-hint" style="margin-bottom: 10px">
                  ËÆæÁΩÆËßÜÈ¢ëÈÄöËØùÊó∂ÂØπÊñπÂíåËá™Â∑±ÁöÑÁîªÈù¢
                </div>

                <div style="display: flex; gap: 16px; margin-top: 12px">
                  <!-- ÂØπÊñπÁîªÈù¢ -->
                  <div style="flex: 1; text-align: center">
                    <div
                      style="font-size: 0.8rem; color: #666; margin-bottom: 6px"
                    >
                      TAÁöÑÁîªÈù¢
                    </div>
                    <div
                      id="videoCallPartnerPreview"
                      style="
                        width: 80px;
                        height: 110px;
                        border-radius: 8px;
                        background: #f5f5f5;
                        margin: 0 auto;
                        overflow: hidden;
                        cursor: pointer;
                        border: 2px dashed #ddd;
                      "
                      onclick="document.getElementById('videoCallPartnerInput').click()"
                    >
                      <img
                        id="videoCallPartnerImg"
                        src=""
                        style="
                          width: 100%;
                          height: 100%;
                          object-fit: cover;
                          display: none;
                        "
                      />
                      <div
                        id="videoCallPartnerPlaceholder"
                        style="
                          height: 100%;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          color: #999;
                          font-size: 0.7rem;
                        "
                      >
                        ÁÇπÂáªËÆæÁΩÆ
                      </div>
                    </div>
                    <input
                      type="file"
                      id="videoCallPartnerInput"
                      hidden
                      accept="image/*,video/*"
                      onchange="handleVideoCallImageUpload(this, 'partner')"
                    />
                    <button
                      onclick="clearVideoCallImage('partner')"
                      style="
                        margin-top: 6px;
                        font-size: 0.7rem;
                        padding: 2px 8px;
                        background: #f5f5f5;
                        border: none;
                        border-radius: 4px;
                        color: #999;
                      "
                    >
                      Ê∏ÖÈô§
                    </button>
                  </div>

                  <!-- Ëá™Â∑±ÁîªÈù¢ -->
                  <div style="flex: 1; text-align: center">
                    <div
                      style="font-size: 0.8rem; color: #666; margin-bottom: 6px"
                    >
                      ÊàëÁöÑÁîªÈù¢
                    </div>
                    <div
                      id="videoCallSelfPreview"
                      style="
                        width: 80px;
                        height: 110px;
                        border-radius: 8px;
                        background: #f5f5f5;
                        margin: 0 auto;
                        overflow: hidden;
                        cursor: pointer;
                        border: 2px dashed #ddd;
                      "
                      onclick="document.getElementById('videoCallSelfInput').click()"
                    >
                      <img
                        id="videoCallSelfImg"
                        src=""
                        style="
                          width: 100%;
                          height: 100%;
                          object-fit: cover;
                          display: none;
                        "
                      />
                      <div
                        id="videoCallSelfPlaceholder"
                        style="
                          height: 100%;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          color: #999;
                          font-size: 0.7rem;
                        "
                      >
                        ÁÇπÂáªËÆæÁΩÆ
                      </div>
                    </div>
                    <input
                      type="file"
                      id="videoCallSelfInput"
                      hidden
                      accept="image/*,video/*"
                      onchange="handleVideoCallImageUpload(this, 'self')"
                    />
                    <button
                      onclick="clearVideoCallImage('self')"
                      style="
                        margin-top: 6px;
                        font-size: 0.7rem;
                        padding: 2px 8px;
                        background: #f5f5f5;
                        border: none;
                        border-radius: 4px;
                        color: #999;
                      "
                    >
                      Ê∏ÖÈô§
                    </button>
                  </div>
                </div>
              </div>

              <!-- ÈÄöËØùÊ∞îÊ≥°È¢úËâ≤ËÆæÁΩÆ -->
              <div
                style="
                  margin-top: 16px;
                  padding-top: 16px;
                  border-top: 1px dashed #f0f0f0;
                "
              >
                <label class="form-label" style="font-size: 0.85rem"
                  >üí¨ ÈÄöËØùÊ∞îÊ≥°Ê†∑Âºè</label
                >
                <div class="form-hint" style="margin-bottom: 10px">
                  Ëá™ÂÆö‰πâÈÄöËØùÊó∂Ê∂àÊÅØÊ∞îÊ≥°ÁöÑÈ¢úËâ≤ÂíåÈÄèÊòéÂ∫¶
                </div>

                <div
                  style="
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                    margin-top: 12px;
                  "
                >
                  <!-- Áî®Êà∑Ê∞îÊ≥°È¢úËâ≤ -->
                  <div style="display: flex; align-items: center; gap: 10px">
                    <span style="font-size: 0.8rem; color: #666; width: 70px"
                      >ÊàëÁöÑÊ∞îÊ≥°</span
                    >
                    <input
                      type="color"
                      id="settingsCallUserBubbleColor"
                      value="#f48fb1"
                      style="
                        width: 36px;
                        height: 28px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                      "
                      onchange="previewCallBubbleColor()"
                    />
                    <input
                      type="range"
                      id="settingsCallUserBubbleOpacity"
                      min="30"
                      max="100"
                      value="85"
                      style="flex: 1"
                      oninput="previewCallBubbleColor()"
                    />
                    <span
                      id="callUserOpacityLabel"
                      style="font-size: 0.75rem; color: #999; width: 35px"
                      >85%</span
                    >
                  </div>

                  <!-- AIÊ∞îÊ≥°È¢úËâ≤ -->
                  <div style="display: flex; align-items: center; gap: 10px">
                    <span style="font-size: 0.8rem; color: #666; width: 70px"
                      >TAÁöÑÊ∞îÊ≥°</span
                    >
                    <input
                      type="color"
                      id="settingsCallAiBubbleColor"
                      value="#ffffff"
                      style="
                        width: 36px;
                        height: 28px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                      "
                      onchange="previewCallBubbleColor()"
                    />
                    <input
                      type="range"
                      id="settingsCallAiBubbleOpacity"
                      min="30"
                      max="100"
                      value="85"
                      style="flex: 1"
                      oninput="previewCallBubbleColor()"
                    />
                    <span
                      id="callAiOpacityLabel"
                      style="font-size: 0.75rem; color: #999; width: 35px"
                      >85%</span
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Section 3: Memory Settings -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon teal">üíæ</div>
            <span class="section-title">ËÆ∞ÂøÜ‰∏é‰∏ä‰∏ãÊñá</span>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label"
                >ËÆ∞ÂøÜ‰∫íÈÄö <span class="form-hint">(ÂèØÂ§öÈÄâ)</span></label
              >
              <div class="memory-link-dropdown" id="memoryLinkDropdown">
                <div
                  class="memory-link-select"
                  onclick="toggleMemoryLinkDropdown()"
                >
                  <span class="memory-link-text" id="memoryLinkText"
                    >ÁÇπÂáªÈÄâÊã©Ë¶Å‰∫íÈÄöÁöÑËßíËâ≤...</span
                  >
                  <span class="memory-link-arrow">‚ñº</span>
                </div>
                <div class="memory-link-options" id="memoryLinkOptions">
                  <!-- Âä®ÊÄÅÁîüÊàê -->
                </div>
              </div>
              <div class="memory-link-tags" id="memoryLinkTags">
                <!-- Â∑≤ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æ -->
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">‰∫íÈÄöÊù°Êï∞</label>
              <div class="number-input-row">
                <input
                  type="number"
                  class="number-input"
                  id="settingsMemoryCount"
                  value="5"
                  min="1"
                  max="50"
                />
                <span class="form-hint">Êù°ÊúÄËøëÊ∂àÊÅØ</span>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">‰∏ä‰∏ãÊñáËÆ∞ÂøÜÊù°Êï∞</label>
              <div class="number-input-row">
                <input
                  type="number"
                  class="number-input"
                  id="settingsContextCount"
                  value="150"
                  min="10"
                  max="500"
                />
                <span class="form-hint">Êù°</span>
              </div>
            </div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 12px;
                padding: 10px 12px;
                background: #faf8f5;
                border-radius: 10px;
              "
            >
              <span style="font-size: 0.82rem; color: #9a8b7a"
                >ÊÄªÊ∂àÊÅØÔºö<strong id="settingsTotalMsg">0</strong> Êù°</span
              >
              <span style="font-size: 0.82rem; color: #c4a87c"
                >tokenÔºö<strong id="settingsTokenCount">0</strong></span
              >
            </div>
          </div>
        </div>

        <!-- Section 4: Play Mode -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon orange">üéÆ</div>
            <span class="section-title">Áé©Ê≥ï‰∏éÊ®°Âºè</span>
          </div>
          <div class="section-body">
            <div class="toggle-row">
              <div>
                <div class="toggle-label">Á∫ø‰∏ãÊ®°Âºè (Online Dating)</div>
                <div class="toggle-sublabel">Ê®°ÊãüÁúüÂÆûÁ∫¶‰ºöÂú∫ÊôØ</div>
              </div>
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  id="settingsOnlineDating"
                  onchange="toggleOfflineSettings()"
                />
                <span class="toggle-slider"></span>
              </label>
            </div>

            <!-- Á∫ø‰∏ãÊ®°ÂºèÈ´òÁ∫ßËÆæÁΩÆ -->
            <div class="offline-word-settings" id="offlineWordSettings">
              <div class="offline-word-title">‚òÖ Á∫ø‰∏ãÊ®°ÂºèËÆæÁΩÆ</div>
              <div class="offline-word-row">
                <span
                  style="font-size: 0.82rem; color: #8d6e63; min-width: 60px"
                  >ÂõûÂ§çÂ≠óÊï∞</span
                >
                <input
                  type="number"
                  class="offline-word-input"
                  id="offlineMinWords"
                  value="100"
                  min="10"
                  max="5000"
                />
                <span class="offline-word-sep">ÔΩû</span>
                <input
                  type="number"
                  class="offline-word-input"
                  id="offlineMaxWords"
                  value="500"
                  min="10"
                  max="5000"
                />
                <span class="offline-word-unit">Â≠ó</span>
              </div>
              <div class="offline-preset-select">
                <label
                  style="
                    font-size: 0.82rem;
                    color: #8d6e63;
                    display: block;
                    margin-bottom: 8px;
                  "
                  >Â∫îÁî®È¢ÑËÆæ</label
                >
                <select
                  class="offline-preset-dropdown"
                  id="offlinePresetSelect"
                >
                  <option value="">-- ‰∏ç‰ΩøÁî®È¢ÑËÆæ --</option>
                </select>
              </div>
            </div>

            <div class="toggle-row">
              <div>
                <div class="toggle-label">ÈïøÊúüËÆ∞ÂøÜÊÄªÁªì</div>
                <div class="toggle-sublabel">Ëá™Âä®ÊÄªÁªìÈáçË¶ÅÂØπËØù</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="settingsLongMemory" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">ÊÄªÁªìÊ®°Âºè</label>
              <div class="radio-group">
                <div
                  class="radio-option"
                  data-value="auto"
                  onclick="selectRadio(this, 'summaryMode')"
                >
                  Ëá™Âä®ÊÄªÁªì
                </div>
                <div
                  class="radio-option active"
                  data-value="manual"
                  onclick="selectRadio(this, 'summaryMode')"
                >
                  ÊâãÂä®ÊÄªÁªì
                </div>
              </div>
              <input type="hidden" id="settingsSummaryMode" value="manual" />
            </div>
            <div class="form-group">
              <label class="form-label">Ëß¶ÂèëÊù°Êï∞</label>
              <div class="number-input-row">
                <input
                  type="number"
                  class="number-input"
                  id="settingsTriggerCount"
                  value="500"
                  min="50"
                  max="2000"
                />
                <span class="form-hint">Êù°Ê∂àÊÅØÂêéËß¶ÂèëÊÄªÁªì</span>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">ÊÄªÁªìÊèêÁ§∫ËØç</label>
              <textarea
                class="form-input form-textarea"
                id="settingsSummaryPrompt"
                placeholder="ËØ∑‰ª•Á¨¨‰∏â‰∫∫Áß∞ÁöÑËßÜËßíÔºåÂÆ¢ËßÇ„ÄÅÂÜ∑Èùô„ÄÅ‰∏çÂ∏¶‰ªª‰ΩïÊÑüÊÉÖËâ≤ÂΩ©Âú∞ÊÄªÁªì‰ª•‰∏ãÂØπËØùÁöÑÊ†∏ÂøÉ‰∫ã‰ª∂Âíå‰ø°ÊÅØ„ÄÇÁ¶ÅÊ≠¢ËøõË°å‰ªª‰ΩïËßíËâ≤ÊâÆÊºîÊàñÊ∑ªÂä†‰∏ªËßÇËØÑËÆ∫„ÄÇ"
              ></textarea>
            </div>
            <div class="action-buttons-grid" style="margin-top: 12px">
              <button class="action-btn" onclick="viewSummaries()">
                ‚â° Êü•Áúã/ÁÆ°ÁêÜÊÄªÁªì
              </button>
              <button class="action-btn" onclick="triggerManualSummary()">
                ‚úé Á´ãÂç≥ÊâãÂä®ÊÄªÁªì
              </button>
            </div>
            <div class="toggle-row" style="margin-top: 12px">
              <div>
                <div class="toggle-label">Áª≠ÁÅ´Ëä±Á≥ªÁªü</div>
                <div class="toggle-sublabel">‰øùÊåÅÂØπËØùÁÉ≠Â∫¶</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="settingsFlame" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="toggle-row">
              <div>
                <div class="toggle-label">ÂÆûÊó∂Êó∂Èó¥ÊÑüÁü•</div>
                <div class="toggle-sublabel">AI‰∫ÜËß£ÂΩìÂâçÊó∂Èó¥</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="settingsTimeAware" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>

        <!-- Section 5: Visual Customization -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon blue">üé®</div>
            <span class="section-title">ÁæéÂåñ</span>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label">ËÅäÂ§©ËÉåÊôØ</label>
              <div class="bg-preview-container">
                <div class="bg-preview-phone" id="bgPreview">
                  <span id="bgPreviewPlaceholder">Êó†ËÉåÊôØ</span>
                  <img id="bgPreviewImg" src="" style="display: none" />
                </div>
                <button
                  class="bg-upload-btn"
                  onclick="document.getElementById('bgUploadInput').click()"
                >
                  ‚Üë ÁÇπÂáª‰∏ä‰º†ËÉåÊôØÂõæÁâá
                </button>
                <input
                  type="file"
                  id="bgUploadInput"
                  class="hidden-input"
                  accept="image/*"
                  onchange="previewBackground(this)"
                />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Â≠ó‰ΩìÂ§ßÂ∞è</label>
              <div class="slider-row">
                <span class="slider-value" id="fontSizeValue">14px</span>
                <input
                  type="range"
                  id="settingsFontSize"
                  min="12"
                  max="20"
                  value="14"
                  oninput="updateFontSizePreview(this.value)"
                />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">ËÅäÂ§©Ê∞îÊ≥°Ê†∑Âºè</label>
              <div class="form-hint" style="margin-bottom: 12px">
                Ëá™ÂÆö‰πâÊ∞îÊ≥°ËÉåÊôØ„ÄÅÈÄèÊòéÂ∫¶ÂíåÂ≠ó‰ΩìÈ¢úËâ≤
              </div>

              <!-- ÊàëÁöÑÊ∞îÊ≥° -->
              <div
                style="
                  background: rgba(244, 143, 177, 0.1);
                  padding: 12px;
                  border-radius: 12px;
                  margin-bottom: 12px;
                "
              >
                <div
                  style="
                    font-size: 0.85rem;
                    color: #333;
                    font-weight: 500;
                    margin-bottom: 10px;
                  "
                >
                  üí¨ ÊàëÁöÑÊ∞îÊ≥°
                </div>

                <!-- ËÉåÊôØÈ¢úËâ≤ -->
                <div style="margin-bottom: 10px">
                  <span
                    style="
                      font-size: 0.75rem;
                      color: #666;
                      display: block;
                      margin-bottom: 6px;
                    "
                    >ËÉåÊôØÈ¢úËâ≤</span
                  >
                  <div
                    style="
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      flex-wrap: wrap;
                    "
                  >
                    <div
                      class="color-preset-grid"
                      style="display: flex; gap: 4px; flex-wrap: wrap"
                    >
                      <div
                        class="color-preset"
                        style="background: #fce4ec"
                        onclick="setChatUserBubbleBg('#fce4ec')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #f8bbd9"
                        onclick="setChatUserBubbleBg('#f8bbd9')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #f48fb1"
                        onclick="setChatUserBubbleBg('#f48fb1')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #e1bee7"
                        onclick="setChatUserBubbleBg('#e1bee7')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #bbdefb"
                        onclick="setChatUserBubbleBg('#bbdefb')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #b2ebf2"
                        onclick="setChatUserBubbleBg('#b2ebf2')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #c8e6c9"
                        onclick="setChatUserBubbleBg('#c8e6c9')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #fff9c4"
                        onclick="setChatUserBubbleBg('#fff9c4')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #ffe0b2"
                        onclick="setChatUserBubbleBg('#ffe0b2')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #d7ccc8"
                        onclick="setChatUserBubbleBg('#d7ccc8')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #ffffff"
                        onclick="setChatUserBubbleBg('#ffffff')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #37474f"
                        onclick="setChatUserBubbleBg('#37474f')"
                      ></div>
                    </div>
                    <input
                      type="color"
                      id="settingsChatUserBubbleBg"
                      value="#f8bbd9"
                      class="color-picker-input"
                      onchange="previewChatBubbleStyle()"
                    />
                  </div>
                </div>

                <!-- ÈÄèÊòéÂ∫¶ -->
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    margin-bottom: 10px;
                  "
                >
                  <span style="font-size: 0.75rem; color: #666; width: 50px"
                    >ÈÄèÊòéÂ∫¶</span
                  >
                  <input
                    type="range"
                    id="settingsChatUserBubbleOpacity"
                    min="30"
                    max="100"
                    value="100"
                    style="flex: 1"
                    oninput="previewChatBubbleStyle(); document.getElementById('chatUserOpacityLabel').textContent=this.value+'%'"
                  />
                  <span
                    id="chatUserOpacityLabel"
                    style="font-size: 0.7rem; color: #999; width: 35px"
                    >100%</span
                  >
                </div>

                <!-- Â≠ó‰ΩìÈ¢úËâ≤ -->
                <div>
                  <span
                    style="
                      font-size: 0.75rem;
                      color: #666;
                      display: block;
                      margin-bottom: 6px;
                    "
                    >Â≠ó‰ΩìÈ¢úËâ≤</span
                  >
                  <div
                    style="
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      flex-wrap: wrap;
                    "
                  >
                    <div
                      class="color-preset-grid"
                      style="display: flex; gap: 4px; flex-wrap: wrap"
                    >
                      <div
                        class="color-preset"
                        style="background: #c2185b"
                        onclick="setChatUserTextColor('#c2185b')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #e91e63"
                        onclick="setChatUserTextColor('#e91e63')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #7b1fa2"
                        onclick="setChatUserTextColor('#7b1fa2')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #512da8"
                        onclick="setChatUserTextColor('#512da8')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #1976d2"
                        onclick="setChatUserTextColor('#1976d2')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #0097a7"
                        onclick="setChatUserTextColor('#0097a7')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #388e3c"
                        onclick="setChatUserTextColor('#388e3c')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #f57c00"
                        onclick="setChatUserTextColor('#f57c00')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #5d4037"
                        onclick="setChatUserTextColor('#5d4037')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #37474f"
                        onclick="setChatUserTextColor('#37474f')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #ffffff"
                        onclick="setChatUserTextColor('#ffffff')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #000000"
                        onclick="setChatUserTextColor('#000000')"
                      ></div>
                    </div>
                    <input
                      type="color"
                      id="settingsChatUserTextColor"
                      value="#c2185b"
                      class="color-picker-input"
                      onchange="previewChatBubbleStyle()"
                    />
                  </div>
                </div>
              </div>

              <!-- TAÁöÑÊ∞îÊ≥° -->
              <div
                style="
                  background: rgba(0, 0, 0, 0.03);
                  padding: 12px;
                  border-radius: 12px;
                "
              >
                <div
                  style="
                    font-size: 0.85rem;
                    color: #333;
                    font-weight: 500;
                    margin-bottom: 10px;
                  "
                >
                  üí≠ TAÁöÑÊ∞îÊ≥°
                </div>

                <!-- ËÉåÊôØÈ¢úËâ≤ -->
                <div style="margin-bottom: 10px">
                  <span
                    style="
                      font-size: 0.75rem;
                      color: #666;
                      display: block;
                      margin-bottom: 6px;
                    "
                    >ËÉåÊôØÈ¢úËâ≤</span
                  >
                  <div
                    style="
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      flex-wrap: wrap;
                    "
                  >
                    <div
                      class="color-preset-grid"
                      style="display: flex; gap: 4px; flex-wrap: wrap"
                    >
                      <div
                        class="color-preset"
                        style="background: #ffffff"
                        onclick="setChatAiBubbleBg('#ffffff')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #f5f5f5"
                        onclick="setChatAiBubbleBg('#f5f5f5')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #eeeeee"
                        onclick="setChatAiBubbleBg('#eeeeee')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #e0e0e0"
                        onclick="setChatAiBubbleBg('#e0e0e0')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #fce4ec"
                        onclick="setChatAiBubbleBg('#fce4ec')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #e3f2fd"
                        onclick="setChatAiBubbleBg('#e3f2fd')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #e8f5e9"
                        onclick="setChatAiBubbleBg('#e8f5e9')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #fff8e1"
                        onclick="setChatAiBubbleBg('#fff8e1')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #efebe9"
                        onclick="setChatAiBubbleBg('#efebe9')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #eceff1"
                        onclick="setChatAiBubbleBg('#eceff1')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #37474f"
                        onclick="setChatAiBubbleBg('#37474f')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #212121"
                        onclick="setChatAiBubbleBg('#212121')"
                      ></div>
                    </div>
                    <input
                      type="color"
                      id="settingsChatAiBubbleBg"
                      value="#ffffff"
                      class="color-picker-input"
                      onchange="previewChatBubbleStyle()"
                    />
                  </div>
                </div>

                <!-- ÈÄèÊòéÂ∫¶ -->
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    margin-bottom: 10px;
                  "
                >
                  <span style="font-size: 0.75rem; color: #666; width: 50px"
                    >ÈÄèÊòéÂ∫¶</span
                  >
                  <input
                    type="range"
                    id="settingsChatAiBubbleOpacity"
                    min="30"
                    max="100"
                    value="100"
                    style="flex: 1"
                    oninput="previewChatBubbleStyle(); document.getElementById('chatAiOpacityLabel').textContent=this.value+'%'"
                  />
                  <span
                    id="chatAiOpacityLabel"
                    style="font-size: 0.7rem; color: #999; width: 35px"
                    >100%</span
                  >
                </div>

                <!-- Â≠ó‰ΩìÈ¢úËâ≤ -->
                <div>
                  <span
                    style="
                      font-size: 0.75rem;
                      color: #666;
                      display: block;
                      margin-bottom: 6px;
                    "
                    >Â≠ó‰ΩìÈ¢úËâ≤</span
                  >
                  <div
                    style="
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      flex-wrap: wrap;
                    "
                  >
                    <div
                      class="color-preset-grid"
                      style="display: flex; gap: 4px; flex-wrap: wrap"
                    >
                      <div
                        class="color-preset"
                        style="background: #333333"
                        onclick="setChatAiTextColor('#333333')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #37474f"
                        onclick="setChatAiTextColor('#37474f')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #455a64"
                        onclick="setChatAiTextColor('#455a64')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #616161"
                        onclick="setChatAiTextColor('#616161')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #212121"
                        onclick="setChatAiTextColor('#212121')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #1565c0"
                        onclick="setChatAiTextColor('#1565c0')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #2e7d32"
                        onclick="setChatAiTextColor('#2e7d32')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #ad1457"
                        onclick="setChatAiTextColor('#ad1457')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #6a1b9a"
                        onclick="setChatAiTextColor('#6a1b9a')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #5d4037"
                        onclick="setChatAiTextColor('#5d4037')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #ffffff"
                        onclick="setChatAiTextColor('#ffffff')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #000000"
                        onclick="setChatAiTextColor('#000000')"
                      ></div>
                    </div>
                    <input
                      type="color"
                      id="settingsChatAiTextColor"
                      value="#333333"
                      class="color-picker-input"
                      onchange="previewChatBubbleStyle()"
                    />
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Ê∞îÊ≥°Ê†∑ÂºèÈ¢ÑËÆæ</label>
              <div class="form-select-wrapper">
                <select class="form-select" id="settingsBubbleStyle">
                  <option value="none">-- Êó†È¢ÑËÆæ --</option>
                  <option value="simple">ÁÆÄÁ∫¶È£éÊ†º</option>
                  <option value="bubble">Ê∞îÊ≥°È£éÊ†º</option>
                  <option value="modern">Áé∞‰ª£È£éÊ†º</option>
                  <option value="retro">Â§çÂè§È£éÊ†º</option>
                </select>
                <button class="form-btn-small" onclick="manageBubbleStyles()">
                  ÁÆ°ÁêÜ
                </button>
              </div>
            </div>
            <div class="action-buttons-grid">
              <button class="action-btn" onclick="exportBubbleStyle()">
                ‚Üë ÂØºÂá∫
              </button>
              <button class="action-btn" onclick="importBubbleStyle()">
                ‚Üì ÂØºÂÖ•
              </button>
            </div>
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">Ëá™ÂÆö‰πâCSS</label>
              <button
                class="form-btn-small"
                onclick="resetCustomCSS()"
                style="float: right; margin-top: -28px"
              >
                ÈáçÁΩÆ
              </button>
              <div class="css-editor-container">
                <textarea
                  class="css-editor"
                  id="settingsCustomCSS"
                  placeholder="/* Âú®Ê≠§ËæìÂÖ•Ëá™ÂÆö‰πâCSS‰ª£Á†Å */"
                ></textarea>
              </div>
            </div>

            <!-- Chat Preview -->
            <div class="chat-preview-container">
              <div class="preview-label">ÂÆûÊó∂È¢ÑËßà</div>
              <div class="preview-msg-row">
                <div class="preview-avatar" id="previewOtherAvatar">AI</div>
                <div>
                  <div class="preview-bubble" id="previewOtherBubble">
                    ÂØπÊñπÊ∂àÊÅØÈ¢ÑËßà
                  </div>
                  <div class="preview-time">10:00</div>
                </div>
              </div>
              <div class="preview-msg-row right">
                <div class="preview-avatar" id="previewMyAvatar">Êàë</div>
                <div>
                  <div class="preview-bubble" id="previewMyBubble">
                    ÊàëÁöÑÊ∂àÊÅØÈ¢ÑËßà
                  </div>
                  <div class="preview-time">10:00</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Section 6: Data & Operations -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon brown">üíæ</div>
            <span class="section-title">Êï∞ÊçÆ‰∏éÊìç‰Ωú</span>
          </div>
          <div class="section-body">
            <div class="action-buttons-grid">
              <button class="action-btn" onclick="importChatHistory()">
                üì• ÂØºÂÖ•ËÅäÂ§©ËÆ∞ÂΩï
              </button>
              <button class="action-btn" onclick="exportChatHistory()">
                üì§ ÂØºÂá∫ËÅäÂ§©ËÆ∞ÂΩï
              </button>
            </div>
            <div style="border-top: 1px dashed #e5ddd3; margin: 20px 0"></div>
            <div class="action-buttons-grid">
              <button
                class="action-btn danger"
                onclick="clearChatHistoryFromSettings()"
              >
                üßπ Ê∏ÖÁ©∫ËÅäÂ§©
              </button>
              <button class="action-btn danger" onclick="blockCharacter()">
                üö´ ÊãâÈªëÂØπÊñπ
              </button>
            </div>
            <button
              class="action-btn danger"
              style="width: 100%; margin-top: 12px"
              onclick="deleteCharacterCompletely()"
            >
              üóëÔ∏è Âà†Èô§Ê≠§ËÅîÁ≥ª‰∫∫
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Â§ñÈÉ®ËÑöÊú¨ -->
    <script src="app.js"></script>
    <div
      class="context-menu-overlay"
      id="contextMenuOverlay"
      onclick="hideContextMenu()"
    >
      <div class="context-menu" id="contextMenu"></div>
    </div>

    <div class="selection-footer" id="selectionFooter">
      <button class="selection-btn cancel" onclick="exitSelectionMode()">
        ÂèñÊ∂à
      </button>
      <span
        style="font-size: 0.9rem; font-weight: 600; color: #333"
        id="selectionCount"
        >Â∑≤ÈÄâ 0 Êù°</span
      >
      <button
        class="selection-btn forward"
        onclick="showForwardModal()"
        style="
          background: linear-gradient(135deg, #81d4fa, #4fc3f7);
          color: #fff;
          padding: 8px 12px;
          border-radius: 8px;
          font-size: 0.85rem;
        "
      >
        ‚û§ ËΩ¨Âèë
      </button>
      <button
        class="selection-btn favorite"
        onclick="favoriteSelectedMessages()"
        style="
          background: linear-gradient(135deg, #f48fb1, #ec407a);
          color: #fff;
          padding: 8px 12px;
          border-radius: 8px;
          font-size: 0.85rem;
        "
      >
        ‚òÖ Êî∂Ëóè
      </button>
      <button
        class="selection-btn delete"
        id="multiDeleteBtn"
        onclick="deleteSelectedMessages()"
        style="padding: 8px 12px; font-size: 0.85rem"
      >
        ‚úï Âà†Èô§
      </button>
    </div>

    <!-- ËΩ¨ÂèëÂºπÁ™ó -->
    <div
      class="forward-modal-overlay"
      id="forwardModalOverlay"
      onclick="hideForwardModal()"
    >
      <div class="forward-modal" onclick="event.stopPropagation()">
        <div class="forward-modal-header">
          <span class="forward-modal-title">ÈÄâÊã©ËΩ¨ÂèëÂØπË±°</span>
          <button class="forward-modal-close" onclick="hideForwardModal()">
            ‚úï
          </button>
        </div>
        <div class="forward-modal-content" id="forwardModalContent">
          <!-- Âä®ÊÄÅÁîüÊàêËÅäÂ§©ÂàóË°® -->
        </div>
      </div>
    </div>

    <!-- ËΩ¨ÂèëËØ¶ÊÉÖÂºπÁ™ó -->
    <div
      class="forward-detail-overlay"
      id="forwardDetailOverlay"
      onclick="hideForwardDetail()"
    >
      <div class="forward-detail-modal" onclick="event.stopPropagation()">
        <div class="forward-detail-header">
          <span class="forward-detail-title" id="forwardDetailTitle"
            >ËÅäÂ§©ËÆ∞ÂΩï</span
          >
          <button class="forward-detail-close" onclick="hideForwardDetail()">
            ‚úï
          </button>
        </div>
        <div class="forward-detail-content" id="forwardDetailContent">
          <!-- Âä®ÊÄÅÁîüÊàêÊ∂àÊÅØÂàóË°® -->
        </div>
      </div>
    </div>

    <!-- ÂøÉÂ£∞ÂºπÁ™ó -->
    <div
      class="heart-voice-overlay"
      id="heartVoiceOverlay"
      onclick="hideHeartVoice()"
    >
      <div class="heart-voice-modal" onclick="event.stopPropagation()">
        <div class="heart-voice-header">
          <span class="heart-voice-title">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
              ></path>
            </svg>
            ÂÜÖÂøÉÁã¨ÁôΩ
          </span>
          <button class="heart-voice-close" onclick="hideHeartVoice()">
            ‚úï
          </button>
        </div>
        <div class="heart-voice-tabs">
          <button
            class="heart-voice-tab active"
            onclick="switchHeartTab('current')"
          >
            Ê≠§Âàª
          </button>
          <button class="heart-voice-tab" onclick="switchHeartTab('history')">
            ÂæÄÊòî
          </button>
        </div>
        <div class="heart-voice-content" id="heartVoiceContent">
          <!-- Âä®ÊÄÅÁîüÊàêÂøÉÂ£∞ÂÜÖÂÆπ -->
        </div>
      </div>
    </div>

    <!-- Êî∂ËóèÈ°µÈù¢ -->
    <div class="favorites-page" id="favoritesPage">
      <div class="favorites-header">
        <button class="favorites-back" onclick="closeFavoritesPage()">‚Äπ</button>
        <span class="favorites-title">ÊàëÁöÑÊî∂Ëóè</span>
        <button class="favorites-add-group" onclick="addFavoriteGroup()">
          + Êñ∞Âª∫ÂàÜÁªÑ
        </button>
      </div>
      <div class="favorites-tabs" id="favoritesTabs">
        <!-- Âä®ÊÄÅÁîüÊàêÂàÜÁªÑÊ†áÁ≠æ -->
      </div>
      <div class="favorites-content">
        <div class="favorites-list" id="favoritesList">
          <!-- Âä®ÊÄÅÁîüÊàêÊî∂ËóèÂàóË°® -->
        </div>
      </div>
    </div>

    <!-- ÂêéÂè∞Ê¥ªÂä®ËÆæÁΩÆÈ°µÈù¢ -->
    <div class="favorites-page" id="backgroundActivityPage">
      <div class="favorites-header">
        <button class="favorites-back" onclick="closeBackgroundActivityPage()">
          ‚Äπ
        </button>
        <span class="favorites-title">ÂêéÂè∞Ê¥ªÂä®</span>
        <span style="width: 80px"></span>
      </div>
      <div
        style="
          padding: 16px;
          overflow-y: auto;
          height: calc(100% - 56px);
          background: linear-gradient(180deg, #fef8fa 0%, #fff 100%);
        "
      >
        <!-- ÊÄªÂºÄÂÖ≥ -->
        <div
          style="
            background: linear-gradient(135deg, #fff 0%, #fff5f8 100%);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 14px;
            box-shadow: 0 2px 12px rgba(236, 64, 122, 0.1);
            border: 1px solid rgba(236, 64, 122, 0.08);
          "
        >
          <div
            style="
              display: flex;
              align-items: center;
              justify-content: space-between;
            "
          >
            <div>
              <div style="font-weight: 600; color: #ad1457; font-size: 1rem">
                ÂêØÁî®ÂêéÂè∞Ê¥ªÂä®
              </div>
              <div
                style="
                  font-size: 0.8rem;
                  color: #e91e63;
                  margin-top: 6px;
                  opacity: 0.7;
                "
              >
                AIËßíËâ≤‰ºö‰∏ªÂä®ÂèëÊ∂àÊÅØ„ÄÅÂèëÂä®ÊÄÅ„ÄÅ‰∫íÂä®
              </div>
            </div>
            <div
              id="bgActivityToggleBtn"
              onclick="toggleBackgroundActivityEnabled()"
              style="
                width: 52px;
                height: 30px;
                border-radius: 15px;
                background: #e0e0e0;
                position: relative;
                cursor: pointer;
                transition: all 0.3s;
                box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
              "
            >
              <div
                style="
                  width: 26px;
                  height: 26px;
                  border-radius: 50%;
                  background: #fff;
                  position: absolute;
                  top: 2px;
                  left: 2px;
                  transition: all 0.3s;
                  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
                "
              ></div>
            </div>
          </div>
        </div>

        <!-- Ê£ÄÊü•Èó¥Èöî -->
        <div
          style="
            background: linear-gradient(135deg, #fff 0%, #fff5f8 100%);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 14px;
            box-shadow: 0 2px 12px rgba(236, 64, 122, 0.1);
            border: 1px solid rgba(236, 64, 122, 0.08);
          "
        >
          <div style="font-weight: 600; color: #ad1457; margin-bottom: 12px">
            ‚è±Ô∏è Ê£ÄÊü•Èó¥ÈöîÔºàÁßíÔºâ
          </div>
          <input
            type="number"
            id="bgActivityInterval"
            value="60"
            min="30"
            max="600"
            style="
              width: 100%;
              padding: 14px;
              border: 2px solid rgba(236, 64, 122, 0.2);
              border-radius: 12px;
              font-size: 1rem;
              box-sizing: border-box;
              background: #fff;
              color: #333;
              transition: all 0.2s;
            "
            onfocus="this.style.borderColor='#f48fb1';this.style.boxShadow='0 0 0 3px rgba(244,143,177,0.2)'"
            onblur="this.style.borderColor='rgba(236,64,122,0.2)';this.style.boxShadow='none'"
            onchange="updateBackgroundActivityInterval()"
          />
          <div
            style="
              font-size: 0.75rem;
              color: #e91e63;
              margin-top: 10px;
              opacity: 0.7;
            "
          >
            ÊØèÈöîÂ§öÂ∞ëÁßíÊ£ÄÊü•‰∏ÄÊ¨°ÊòØÂê¶Ëß¶ÂèëÂêéÂè∞Ê¥ªÂä®Ôºà30-600ÁßíÔºâ
          </div>
        </div>

        <!-- ËßíËâ≤È¢ëÁéáËÆæÁΩÆ -->
        <div
          style="
            background: linear-gradient(135deg, #fff 0%, #fff5f8 100%);
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 2px 12px rgba(236, 64, 122, 0.1);
            border: 1px solid rgba(236, 64, 122, 0.08);
          "
        >
          <div style="font-weight: 600; color: #ad1457; margin-bottom: 10px">
            üë• ËßíËâ≤Ê¥ªÂä®È¢ëÁéá
          </div>
          <div
            style="
              font-size: 0.75rem;
              color: #666;
              margin-bottom: 16px;
              line-height: 1.6;
              background: rgba(236, 64, 122, 0.05);
              padding: 12px;
              border-radius: 10px;
            "
          >
            <span style="color: #e91e63">‚óè</span> ÂÖ≥Èó≠ = ‰∏çÂèÇ‰∏éÂêéÂè∞Ê¥ªÂä®<br />
            <span style="color: #f48fb1">‚óè</span> ‰ΩéÈ¢ë = ÊØèÊ¨°Ê£ÄÊü•20%Ê¶ÇÁéá<br />
            <span style="color: #ec407a">‚óè</span> ‰∏≠È¢ë = ÊØèÊ¨°Ê£ÄÊü•40%Ê¶ÇÁéá<br />
            <span style="color: #c2185b">‚óè</span> È´òÈ¢ë = ÊØèÊ¨°Ê£ÄÊü•70%Ê¶ÇÁéá
          </div>
          <div
            id="bgActivityCharList"
            style="display: flex; flex-direction: column; gap: 12px"
          >
            <!-- Âä®ÊÄÅÁîüÊàêËßíËâ≤ÂàóË°® -->
          </div>
        </div>

        <!-- ÊâãÂä®ÊµãËØïÊåâÈíÆ -->
        <div
          style="
            background: linear-gradient(135deg, #fff 0%, #fff5f8 100%);
            border-radius: 16px;
            padding: 18px;
            margin-top: 14px;
            box-shadow: 0 2px 12px rgba(236, 64, 122, 0.1);
            border: 1px solid rgba(236, 64, 122, 0.08);
          "
        >
          <div style="font-weight: 600; color: #ad1457; margin-bottom: 12px">
            üß™ ÊµãËØï
          </div>
          <button
            onclick="testBackgroundActivity()"
            style="
              width: 100%;
              padding: 14px;
              background: linear-gradient(135deg, #f48fb1, #ec407a);
              color: #fff;
              border: none;
              border-radius: 12px;
              font-size: 1rem;
              font-weight: 500;
              cursor: pointer;
              box-shadow: 0 4px 12px rgba(236, 64, 122, 0.3);
              transition: all 0.2s;
            "
            onmousedown="this.style.transform='scale(0.98)';this.style.boxShadow='0 2px 6px rgba(236,64,122,0.3)'"
            onmouseup="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(236,64,122,0.3)'"
            ontouchstart="this.style.transform='scale(0.98)';this.style.boxShadow='0 2px 6px rgba(236,64,122,0.3)'"
            ontouchend="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(236,64,122,0.3)'"
          >
            ‚ú® Á´ãÂç≥Ëß¶Âèë‰∏ÄÊ¨°ÂêéÂè∞Ê¥ªÂä®
          </button>
          <div
            style="
              font-size: 0.75rem;
              color: #e91e63;
              margin-top: 10px;
              text-align: center;
              opacity: 0.7;
            "
          >
            ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™Â∑≤ÂêØÁî®ÁöÑËßíËâ≤ÊâßË°åÂêéÂè∞Ê¥ªÂä®
          </div>
        </div>
      </div>
    </div>

    <!-- Êî∂ËóèÂàÜÁªÑÈÄâÊã©ÂºπÁ™ó -->
    <div
      class="favorite-group-modal"
      id="favoriteGroupModal"
      onclick="if(event.target===this)closeFavoriteGroupModal()"
    >
      <div class="favorite-group-content">
        <div class="favorite-group-header">ÈÄâÊã©Êî∂ËóèÂàÜÁªÑ</div>
        <div class="favorite-group-list" id="favoriteGroupList">
          <!-- Âä®ÊÄÅÁîüÊàêÂàÜÁªÑÂàóË°® -->
        </div>
        <div class="favorite-group-add" onclick="addNewGroupInModal()">
          <span>+</span>
          <span>Êñ∞Âª∫ÂàÜÁªÑ</span>
        </div>
        <div class="favorite-group-footer">
          <button
            class="favorite-group-btn cancel"
            onclick="closeFavoriteGroupModal()"
          >
            ÂèñÊ∂à
          </button>
          <button
            class="favorite-group-btn confirm"
            onclick="confirmFavorite()"
          >
            Á°ÆÂÆö
          </button>
        </div>
      </div>
    </div>

    <!-- Êñ∞Ê∂àÊÅØÈÄöÁü•ÂºπÁ™ó -->
    <div
      class="message-notification"
      id="messageNotification"
      onclick="handleNotificationClick()"
    >
      <div class="notification-avatar" id="notificationAvatar">AI</div>
      <div class="notification-content">
        <div class="notification-name" id="notificationName">ËßíËâ≤Âêç</div>
        <div class="notification-text" id="notificationText">Ê∂àÊÅØÂÜÖÂÆπ</div>
      </div>
      <div class="notification-time" id="notificationTime">ÂàöÂàö</div>
    </div>

    <!-- Èí±ÂåÖËØ¶ÊÉÖÈ°µ -->
    <div class="wallet-page" id="walletPage">
      <div class="wallet-page-header">
        <button class="wallet-page-back" onclick="closeWalletPage()">‚Äπ</button>
        <span>ÊàëÁöÑÈí±ÂåÖ</span>
        <span style="width: 30px"></span>
      </div>
      <div class="wallet-page-content">
        <div class="wallet-balance-card">
          <div class="wallet-balance-label">Ë¥¶Êà∑‰ΩôÈ¢ùÔºàÂÖÉÔºâ</div>
          <div class="wallet-balance-value" id="walletBalanceDisplay">0.00</div>
          <div class="wallet-balance-actions">
            <button class="wallet-action-btn" onclick="openRechargeModal()">
              <span>üí≥</span>
              <span>ÂÖÖÂÄº</span>
            </button>
          </div>
        </div>
        <div class="wallet-history-section">
          <div class="wallet-history-title">‰∫§ÊòìËÆ∞ÂΩï</div>
          <div class="wallet-history-list" id="walletHistoryListPage">
            <div class="wallet-history-empty">ÊöÇÊó†‰∫§ÊòìËÆ∞ÂΩï</div>
          </div>
        </div>
      </div>
    </div>
    <!-- Âà†Èô§‰∫§ÊòìËÆ∞ÂΩïÂºπÁ™ó -->
    <div
      class="recharge-modal"
      id="deleteHistoryModal"
      onclick="if(event.target===this)closeDeleteHistoryModal()"
    >
      <div class="recharge-modal-content" style="padding: 20px">
        <div class="recharge-modal-title" style="margin-bottom: 16px">
          üóëÔ∏è Âà†Èô§‰∫§ÊòìËÆ∞ÂΩï
        </div>
        <div
          id="deleteHistoryInfo"
          style="
            background: #f5f5f5;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-size: 0.9rem;
          "
        >
          <!-- Âä®ÊÄÅÂ°´ÂÖÖ -->
        </div>
        <div style="margin-bottom: 16px">
          <label
            style="
              display: flex;
              align-items: center;
              gap: 10px;
              padding: 12px;
              background: #fff5f5;
              border-radius: 10px;
              cursor: pointer;
            "
          >
            <input
              type="checkbox"
              id="deleteAdjustBalance"
              style="width: 18px; height: 18px; accent-color: #ec407a"
            />
            <div>
              <div style="font-weight: 500; color: #333">ÂêåÊó∂Ë∞ÉÊï¥‰ΩôÈ¢ù</div>
              <div style="font-size: 0.8rem; color: #999">
                ÂãæÈÄâÂêéÂ∞ÜÊí§ÈîÄËøôÁ¨î‰∫§ÊòìÂØπ‰ΩôÈ¢ùÁöÑÂΩ±Âìç
              </div>
            </div>
          </label>
        </div>
        <div style="display: flex; gap: 12px">
          <button
            onclick="closeDeleteHistoryModal()"
            style="
              flex: 1;
              padding: 12px;
              border-radius: 10px;
              border: 1px solid #ddd;
              background: #fff;
              font-size: 0.95rem;
              cursor: pointer;
            "
          >
            ÂèñÊ∂à
          </button>
          <button
            onclick="confirmDeleteHistory()"
            style="
              flex: 1;
              padding: 12px;
              border-radius: 10px;
              border: none;
              background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
              color: #fff;
              font-size: 0.95rem;
              cursor: pointer;
            "
          >
            Âà†Èô§
          </button>
        </div>
      </div>
    </div>

    <!-- ÂÖÖÂÄºÂºπÁ™ó -->
    <div
      class="recharge-modal"
      id="rechargeModal"
      onclick="if(event.target===this)closeRechargeModal()"
    >
      <div class="recharge-modal-content">
        <div class="recharge-modal-title">¬• Èí±ÂåÖÂÖÖÂÄº</div>
        <div class="recharge-amount-grid">
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(10)"
          >
            ¬•10
          </button>
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(50)"
          >
            ¬•50
          </button>
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(100)"
          >
            ¬•100
          </button>
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(200)"
          >
            ¬•200
          </button>
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(500)"
          >
            ¬•500
          </button>
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(1000)"
          >
            ¬•1000
          </button>
        </div>
        <input
          type="number"
          class="recharge-custom-input"
          id="rechargeCustomAmount"
          placeholder="Ëá™ÂÆö‰πâÈáëÈ¢ù"
          oninput="clearRechargeSelection()"
        />
        <div class="recharge-modal-btns">
          <button
            class="recharge-modal-btn cancel"
            onclick="closeRechargeModal()"
          >
            ÂèñÊ∂à
          </button>
          <button
            class="recharge-modal-btn confirm"
            onclick="confirmRecharge()"
          >
            Á°ÆËÆ§ÂÖÖÂÄº
          </button>
        </div>
      </div>
    </div>

    <!-- ËΩ¨Ë¥¶ÂºπÁ™ó -->
    <div
      class="send-transfer-modal"
      id="sendTransferModal"
      onclick="if(event.target===this)closeTransferModal()"
    >
      <div class="send-transfer-modal-content">
        <div class="send-transfer-title">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="vertical-align: middle; margin-right: 6px"
          >
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path
              d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
            ></path></svg
          >ËΩ¨Ë¥¶ÁªôTA
        </div>
        <div class="send-transfer-to" id="transferToName">ËΩ¨ÁªôÔºöËßíËâ≤Âêç</div>
        <!-- Áæ§ËÅäÊàêÂëòÈÄâÊã©ÂàóË°® -->
        <div
          id="transferMemberSelect"
          style="
            display: none;
            margin: 12px 0;
            max-height: 150px;
            overflow-y: auto;
          "
        ></div>
        <input
          type="number"
          class="send-transfer-input"
          id="transferAmountInput"
          placeholder="0.00"
        />
        <div class="send-transfer-balance" id="transferBalanceHint">
          ÂèØÁî®‰ΩôÈ¢ùÔºö¬•0.00
        </div>
        <input
          type="text"
          class="send-transfer-note-input"
          id="transferNoteInput"
          placeholder="Ê∑ªÂä†ËΩ¨Ë¥¶ËØ¥ÊòéÔºàÂèØÈÄâÔºâ"
        />
        <div class="recharge-modal-btns">
          <button
            class="recharge-modal-btn cancel"
            onclick="closeTransferModal()"
          >
            ÂèñÊ∂à
          </button>
          <button
            class="recharge-modal-btn confirm"
            onclick="confirmTransfer()"
          >
            Á°ÆËÆ§ËΩ¨Ë¥¶
          </button>
        </div>
      </div>
    </div>

    <!-- ‰ΩçÁΩÆÈÄâÊã©ÂºπÁ™ó -->
    <div
      class="send-transfer-modal"
      id="locationModal"
      onclick="if(event.target===this)closeLocationModal()"
    >
      <div class="send-transfer-modal-content">
        <div class="send-transfer-title">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="vertical-align: middle; margin-right: 6px"
          >
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle></svg
          >ÂèëÈÄÅ‰ΩçÁΩÆ
        </div>
        <div style="margin-bottom: 16px">
          <input
            type="text"
            class="send-transfer-note-input"
            id="locationNameInput"
            placeholder="‰ΩçÁΩÆÂêçÁß∞ÔºåÂ¶ÇÔºöÊòüÂ∑¥ÂÖãÂíñÂï°"
            style="margin-bottom: 8px"
          />
          <input
            type="text"
            class="send-transfer-note-input"
            id="locationAddressInput"
            placeholder="ËØ¶ÁªÜÂú∞ÂùÄÔºàÂèØÈÄâÔºâ"
          />
        </div>
        <div class="recharge-modal-btns">
          <button
            class="recharge-modal-btn cancel"
            onclick="closeLocationModal()"
          >
            ÂèñÊ∂à
          </button>
          <button
            class="recharge-modal-btn confirm"
            onclick="confirmSendLocation()"
          >
            ÂèëÈÄÅ‰ΩçÁΩÆ
          </button>
        </div>
      </div>
    </div>

    <!-- ÈÄöËØùÊÇ¨ÊµÆÁêÉ -->
    <div
      class="call-floating-bubble"
      id="callFloatingBubble"
      onclick="restoreCall()"
    >
      <span id="floatingBubbleAvatar"
        ><svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
          ></path></svg
      ></span>
      <img id="floatingBubbleImg" src="" style="display: none" />
    </div>

    <!-- ÈÄöËØùÁïåÈù¢ -->
    <div class="call-overlay voice-call" id="callOverlay">
      <!-- ËßÜÈ¢ëÈÄöËØù - ÂØπÊñπÁîªÈù¢ÔºàÂÖ®Â±èÔºâ -->
      <div class="video-main" id="videoMain" onclick="toggleVideoSelf()">
        <img id="videoMainImg" src="" style="display: none" />
        <div class="video-main-placeholder" id="videoMainPlaceholder">
          <div class="avatar-large">
            <span id="videoMainAvatarPlaceholder">AI</span>
            <img id="videoMainAvatarImg" src="" style="display: none" />
          </div>
          <span id="videoMainName">Á≠âÂæÖÊé•ÈÄö...</span>
        </div>
      </div>

      <!-- ËßÜÈ¢ëÈÄöËØù - ÊàëÁöÑÁîªÈù¢ÔºàÂ∞èÁ™óÂè£ÔºåÂèØÁÇπÂáªÂàáÊç¢Ôºâ -->
      <div class="video-self" id="videoSelf" onclick="toggleVideoSelf()">
        <img id="videoSelfImg" src="" style="display: none" />
        <div class="video-self-placeholder" id="videoSelfPlaceholder">Êàë</div>
      </div>

      <!-- Êñ∞ÁöÑÈ°∂ÈÉ®Ê†è - Â∑¶ËæπÊúÄÂ∞èÂåñÊåâÈíÆÔºå‰∏≠Èó¥Â§¥ÂÉè+ÂêçÂ≠ó+Êó∂Èó¥ -->
      <div class="call-top-bar" id="callTopBar">
        <button
          class="call-minimize-btn"
          onclick="minimizeCall()"
          title="ÊúÄÂ∞èÂåñ"
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="4 14 10 14 10 20"></polyline>
            <polyline points="20 10 14 10 14 4"></polyline>
            <line x1="14" y1="10" x2="21" y2="3"></line>
            <line x1="3" y1="21" x2="10" y2="14"></line>
          </svg>
        </button>
        <div class="call-top-info">
          <div class="call-top-avatar" id="callTopAvatar">
            <span id="callTopAvatarPlaceholder">AI</span>
            <img id="callTopAvatarImg" src="" style="display: none" />
          </div>
          <div class="call-top-name" id="callTopName">ËßíËâ≤Âêç</div>
          <div class="call-top-timer" id="callTopTimer">Ê≠£Âú®ÂëºÂè´...</div>
        </div>
      </div>

      <!-- ÊóßÁöÑÂ§¥ÂÉèÂå∫ÂüüÔºàÈöêËóèÔºâ -->
      <div
        class="call-avatar-section"
        id="callAvatarSection"
        style="display: none"
      >
        <div class="call-avatar" id="callAvatar">
          <span id="callAvatarPlaceholder">AI</span>
          <img id="callAvatarImg" src="" style="display: none" />
        </div>
        <div class="call-name" id="callName">ËßíËâ≤Âêç</div>
        <div class="call-status" id="callStatus">Ê≠£Âú®ÂëºÂè´...</div>
        <div class="call-timer" id="callTimer" style="display: none">00:00</div>
      </div>

      <!-- ÈöêËóèÁöÑÂÖºÂÆπÂÖÉÁ¥† -->
      <span id="videoCallTimer" style="display: none">00:00</span>
      <span id="videoCallName" style="display: none"></span>

      <!-- ÂØπËØùÂå∫Âüü -->
      <div class="call-conversation" id="callConversation">
        <div class="call-messages-wrapper" id="callMessagesWrapper">
          <!-- Ê∂àÊÅØ‰ºöÂä®ÊÄÅÊ∑ªÂä†Âà∞ËøôÈáå -->
        </div>
        <!-- AIÊ≠£Âú®ËæìÂÖ•ÊåáÁ§∫Âô® -->
        <div class="call-typing-indicator" id="callTypingIndicator">
          <span></span><span></span><span></span>
        </div>
      </div>

      <!-- ËæìÂÖ•Âå∫Âüü -->
      <div class="call-input-area" id="callInputArea">
        <div class="call-input-row">
          <textarea
            class="call-input"
            id="callInput"
            placeholder="ËØ¥ÁÇπ‰ªÄ‰πà..."
            rows="1"
            onkeydown="handleCallInputKeydown(event)"
          ></textarea>
          <button class="call-send-btn" onclick="sendCallMessage()">
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </div>
      </div>

      <!-- ÊåâÈíÆÂå∫Âüü -->
      <div class="call-buttons-area">
        <!-- ÂëºÂè´‰∏≠ÁöÑÊåâÈíÆ -->
        <div class="call-buttons" id="callCallingBtns">
          <button class="call-btn end-call" onclick="endCall()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
        </div>

        <!-- Êù•ÁîµÁöÑÊåâÈíÆ -->
        <div
          class="call-incoming-buttons"
          id="callIncomingBtns"
          style="display: none"
        >
          <button class="call-btn end-call" onclick="declineCall()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
          <button class="call-btn accept-call" onclick="acceptCall()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
        </div>

        <!-- ÈÄöËØù‰∏≠ÁöÑÊåâÈíÆ - ÈáçÂõû„ÄÅÊåÇÊñ≠„ÄÅÊâ¨Â£∞Âô® -->
        <div class="call-buttons" id="callInCallBtns" style="display: none">
          <button
            class="call-btn reroll-btn"
            onclick="rerollCallResponse()"
            title="ÈáçÊñ∞ÂõûÂ§ç"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="23 4 23 10 17 10"></polyline>
              <polyline points="1 20 1 14 7 14"></polyline>
              <path
                d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
              ></path>
            </svg>
          </button>
          <button class="call-btn end-call" onclick="endCall()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
          <button
            class="call-btn speaker-btn"
            id="speakerBtn"
            onclick="toggleSpeaker()"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
              <path
                d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Êù•ÁîµÂÖ®Â±èÁïåÈù¢ -->
    <div class="incoming-call-overlay" id="incomingCallOverlay">
      <div class="incoming-call-top">
        <div class="incoming-call-label">Êù•Áîµ</div>
        <div class="incoming-call-avatar-wrap">
          <div class="incoming-call-ring"></div>
          <div class="incoming-call-ring"></div>
          <div class="incoming-call-ring"></div>
          <div class="incoming-call-avatar" id="incomingCallAvatar">
            <span id="incomingCallAvatarPlaceholder">AI</span>
            <img id="incomingCallAvatarImg" src="" style="display: none" />
          </div>
        </div>
        <div class="incoming-call-name" id="incomingCallName">ËßíËâ≤Âêç</div>
        <div class="incoming-call-type" id="incomingCallType">
          <span class="incoming-call-type-icon" id="incomingCallTypeIcon"
            ><svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path></svg
          ></span>
          <span id="incomingCallTypeText">ËØ≠Èü≥ÈÄöËØù</span>
        </div>
      </div>

      <div class="incoming-call-actions">
        <div class="incoming-call-btn-wrap">
          <button
            class="incoming-call-btn decline"
            onclick="declineIncomingCall()"
          >
            <svg
              width="28"
              height="28"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
          <span class="incoming-call-btn-label">ÊãíÁªù</span>
        </div>
        <div class="incoming-call-btn-wrap">
          <button
            class="incoming-call-btn accept"
            onclick="acceptIncomingCall()"
          >
            <svg
              width="28"
              height="28"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
          <span class="incoming-call-btn-label">Êé•Âê¨</span>
        </div>
      </div>
    </div>

    <!-- ÂèëÈÄÅÂõæÁâáÈÄâÊã©ÂºπÁ™ó -->
    <div
      class="send-image-modal"
      id="sendImageModal"
      onclick="if(event.target===this)closeSendImageModal()"
    >
      <div class="send-image-options">
        <div class="send-image-title">ÂèëÈÄÅÂõæÁâá</div>
        <div class="send-image-grid two-cols">
          <div class="send-image-item" onclick="selectRealImage()">
            <div class="send-image-icon album">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
            </div>
            <span class="send-image-label">ÈÄâÊã©ÂõæÁâá</span>
            <span class="send-image-hint">Áõ∏ÂÜå/ÊãçÁÖß/Êñá‰ª∂</span>
          </div>
          <div class="send-image-item" onclick="openDescImageModal()">
            <div class="send-image-icon desc">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                ></path>
                <path
                  d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                ></path>
              </svg>
            </div>
            <span class="send-image-label">ÊèèËø∞Âõæ</span>
            <span class="send-image-hint">Áî®ÊñáÂ≠óÊèèËø∞ÂõæÁâá</span>
          </div>
        </div>
        <button class="send-image-cancel" onclick="closeSendImageModal()">
          ÂèñÊ∂à
        </button>
      </div>
    </div>

    <!-- ËØ≠Èü≥Ê∂àÊÅØÂºπÁ™ó -->
    <div
      class="send-image-modal"
      id="voiceMessageModal"
      onclick="if(event.target===this)closeVoiceMessageModal()"
    >
      <div class="send-image-options" style="max-width: 320px">
        <div class="send-image-title">üé§ ÂèëÈÄÅËØ≠Èü≥Ê∂àÊÅØ</div>
        <div style="padding: 0 20px 20px">
          <div
            style="
              width: 60px;
              height: 60px;
              margin: 0 auto 16px;
              background: linear-gradient(135deg, #fce4ec, #f8bbd9);
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            <svg
              width="30"
              height="30"
              viewBox="0 0 24 24"
              fill="none"
              stroke="#ec407a"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"
              ></path>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
              <line x1="12" y1="19" x2="12" y2="23"></line>
              <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
          </div>
          <textarea
            id="voiceMessageInput"
            placeholder="ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑËØù..."
            style="
              width: 100%;
              height: 80px;
              border: 2px solid rgba(236, 64, 122, 0.2);
              border-radius: 12px;
              padding: 12px;
              font-size: 1rem;
              resize: none;
              box-sizing: border-box;
              outline: none;
              font-family: inherit;
            "
            onfocus="this.style.borderColor='#f48fb1'"
            onblur="this.style.borderColor='rgba(236,64,122,0.2)'"
          ></textarea>
          <div
            style="
              text-align: center;
              font-size: 0.8rem;
              color: #999;
              margin: 10px 0 16px;
            "
          >
            ËæìÂÖ•ÂÜÖÂÆπ‰ºöËΩ¨Êç¢ÊàêËØ≠Èü≥Ê∂àÊÅØÂèëÈÄÅ
          </div>
          <div style="display: flex; gap: 12px">
            <button
              onclick="closeVoiceMessageModal()"
              style="
                flex: 1;
                padding: 12px;
                border-radius: 12px;
                font-size: 1rem;
                background: #f5f5f5;
                color: #666;
                border: none;
                cursor: pointer;
              "
            >
              ÂèñÊ∂à
            </button>
            <button
              onclick="sendVoiceMessage()"
              style="
                flex: 1;
                padding: 12px;
                border-radius: 12px;
                font-size: 1rem;
                background: linear-gradient(135deg, #f48fb1, #ec407a);
                color: #fff;
                border: none;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(236, 64, 122, 0.3);
              "
            >
              ÂèëÈÄÅËØ≠Èü≥
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ÂõæÁâáÊèèËø∞Êü•Áúã/ÁºñËæëÂºπÁ™ó -->
    <div
      class="image-desc-modal"
      id="imageDescModal"
      onclick="if(event.target===this)closeImageDescModal()"
    >
      <div class="image-desc-content">
        <div class="image-desc-header">
          <span class="image-desc-title" id="imageDescTitle">ÂõæÁâáÊèèËø∞</span>
          <button class="image-desc-close" onclick="closeImageDescModal()">
            ‚úï
          </button>
        </div>
        <div class="image-desc-body">
          <div class="image-desc-preview" id="imageDescPreview">
            <div class="image-desc-preview-icon">
              <svg
                width="40"
                height="40"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
              <span style="font-size: 0.8rem">ÁÇπÂáªÊü•ÁúãÊèèËø∞</span>
            </div>
          </div>
          <!-- Êü•ÁúãÊ®°Âºè -->
          <div
            class="image-desc-text"
            id="imageDescText"
            style="display: none"
          ></div>
          <!-- ÁºñËæëÊ®°Âºè -->
          <textarea
            class="image-desc-input"
            id="imageDescInput"
            placeholder="ÊèèËø∞ËøôÂº†ÂõæÁâáÁöÑÂÜÖÂÆπ...&#10;‰æãÂ¶ÇÔºö‰∏ÄÂº†Â§ïÈò≥‰∏ãÊµ∑ËæπÁöÑÁÖßÁâáÔºåÈáëËâ≤ÁöÑÈò≥ÂÖâÊ¥íÂú®Êµ∑Èù¢‰∏ä..."
            style="display: none"
          ></textarea>
        </div>
        <div
          class="image-desc-footer"
          id="imageDescFooter"
          style="display: none"
        >
          <button class="image-desc-btn cancel" onclick="closeImageDescModal()">
            ÂèñÊ∂à
          </button>
          <button
            class="image-desc-btn confirm"
            onclick="confirmSendDescImage()"
          >
            ÂèëÈÄÅ
          </button>
        </div>
      </div>
    </div>

    <!-- ÂõæÁâáÊü•ÁúãÂºπÁ™ó -->
    <div
      class="image-desc-modal"
      id="imageViewModal"
      onclick="closeImageViewModal()"
    >
      <div style="max-width: 90%; max-height: var(--vh-80)">
        <img
          id="imageViewImg"
          src=""
          style="max-width: 100%; max-height: var(--vh-80); border-radius: 12px"
        />
      </div>
    </div>

    <!-- ÈöêËóèÁöÑÂõæÁâáËæìÂÖ• -->
    <input
      type="file"
      id="realImageInput"
      hidden
      accept="image/*"
      onchange="handleRealImageSelect(this)"
    />

    <!-- Áæ§ÂÖ¨ÂëäÂºπÁ™ó -->
    <div
      class="group-announcement-modal"
      id="groupAnnouncementModal"
      onclick="if(event.target===this)closeGroupAnnouncementModal()"
    >
      <div class="group-announcement-content">
        <div class="group-announcement-header">
          <span class="group-announcement-title">üì¢ Áæ§ÂÖ¨Âëä</span>
          <button
            class="group-announcement-close"
            onclick="closeGroupAnnouncementModal()"
          >
            ‚úï
          </button>
        </div>
        <div class="group-announcement-body">
          <textarea
            class="group-announcement-input"
            id="groupAnnouncementInput"
            placeholder="ËæìÂÖ•Áæ§ÂÖ¨ÂëäÂÜÖÂÆπ...&#10;Áæ§ÊàêÂëòÂíåAIÈÉΩÂèØ‰ª•ÁúãÂà∞Ëøô‰∏™ÂÖ¨Âëä"
          ></textarea>
        </div>
        <div class="group-announcement-footer">
          <button
            class="group-announcement-btn cancel"
            onclick="closeGroupAnnouncementModal()"
          >
            ÂèñÊ∂à
          </button>
          <button
            class="group-announcement-btn confirm"
            onclick="saveGroupAnnouncement()"
          >
            ‰øùÂ≠ò
          </button>
        </div>
      </div>
    </div>
    <!-- ‰∏ÄËµ∑Âê¨Ê≠åÈ°µÈù¢ -->
    <div class="music-together-page" id="musicTogetherPage">
      <div class="music-header">
        <button class="music-header-back" onclick="closeMusicTogether()">
          ‚Üê
        </button>
        <div class="music-header-title">üéµ ‰∏ÄËµ∑Âê¨Ê≠å</div>
        <div style="width: 36px"></div>
      </div>

      <div class="music-content">
        <!-- ÂΩìÂâçÊí≠Êîæ -->
        <div
          class="current-music-section"
          id="currentMusicSection"
          style="display: none"
        >
          <div class="music-player-info">
            <div class="music-cover-wrapper">
              <span class="music-cover-placeholder">üéµ</span>
            </div>
            <div class="music-meta">
              <div id="musicName">Ê≠åÊõ≤ÂêçÁß∞</div>
              <div id="musicArtist">Ê≠åÊâã</div>
            </div>
          </div>

          <!-- Êí≠ÊîæÊéßÂà∂ -->
          <div class="music-controls">
            <button
              class="music-ctrl-btn small"
              id="playModeBtn"
              onclick="togglePlayMode()"
              title="Êí≠ÊîæÊ®°Âºè"
            >
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="17 1 21 5 17 9"></polyline>
                <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                <polyline points="7 23 3 19 7 15"></polyline>
                <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
              </svg>
            </button>
            <button class="music-ctrl-btn" onclick="playPrevMusic()">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <polygon points="19 20 9 12 19 4 19 20"></polygon>
                <line
                  x1="5"
                  y1="19"
                  x2="5"
                  y2="5"
                  stroke="currentColor"
                  stroke-width="2"
                ></line>
              </svg>
            </button>
            <button
              class="music-ctrl-btn music-play-btn"
              id="musicPlayBtn"
              onclick="toggleMusicPlay()"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
            </button>
            <button class="music-ctrl-btn" onclick="playNextMusic()">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <polygon points="5 4 15 12 5 20 5 4"></polygon>
                <line
                  x1="19"
                  y1="5"
                  x2="19"
                  y2="19"
                  stroke="currentColor"
                  stroke-width="2"
                ></line>
              </svg>
            </button>
            <button
              class="music-ctrl-btn small"
              onclick="stopMusic()"
              title="ÂÅúÊ≠¢"
            >
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <rect x="6" y="6" width="12" height="12" rx="1"></rect>
              </svg>
            </button>
          </div>

          <!-- ËøõÂ∫¶Êù° -->
          <div class="music-progress-section">
            <div class="music-progress-bar" onclick="seekMusic(event)">
              <div class="music-progress-fill" id="musicProgressFill"></div>
            </div>
            <div class="music-time">
              <span id="musicCurrentTime">0:00</span>
              <span id="musicDuration">0:00</span>
            </div>
          </div>

          <!-- Ê≠åËØçÂå∫Âüü -->
          <div class="music-lyrics-section">
            <div class="music-lyrics-header">
              <span class="music-lyrics-title">üìù Ê≠åËØç</span>
              <button class="music-lyrics-edit" onclick="openEditLyricsModal()">
                ÁºñËæëÊ≠åËØç
              </button>
            </div>
            <div class="music-lyrics-container" id="musicLyricsContainer">
              <div class="lyric-empty">ÊöÇÊó†Ê≠åËØç</div>
            </div>
          </div>

          <!-- Êìç‰ΩúÊåâÈíÆ -->
          <div class="music-actions">
            <button
              class="music-action-btn primary"
              onclick="startFloatingLyric()"
            >
              üé§ Ê°åÈù¢Ê≠åËØç
            </button>
          </div>
        </div>

        <!-- Èü≥‰πêÂ∫ì -->
        <div class="music-library-section">
          <div class="music-library-header">
            <div class="music-section-title">üéß ÊàëÁöÑÈü≥‰πêÂ∫ì</div>
            <button class="music-add-btn" onclick="openMusicImportModal()">
              + ÂØºÂÖ•
            </button>
          </div>
          <div class="music-library-list" id="musicLibraryList">
            <!-- Âä®ÊÄÅÊ∏≤Êüì -->
          </div>
        </div>
      </div>
    </div>

    <!-- ÂØºÂÖ•Èü≥‰πêÂºπÁ™ó -->
    <div
      class="music-import-modal"
      id="musicImportModal"
      onclick="if(event.target===this)closeMusicImportModal()"
    >
      <div class="music-import-content">
        <div class="music-import-header">
          <div class="music-import-title">üéµ ÂØºÂÖ•Èü≥‰πê</div>
        </div>
        <div class="music-import-body">
          <div class="import-form-group">
            <label class="import-form-label"
              >Ê≠åÊõ≤ÂêçÁß∞ <span class="required">*</span></label
            >
            <input
              type="text"
              class="import-form-input"
              id="importMusicName"
              placeholder="ËæìÂÖ•Ê≠åÊõ≤ÂêçÁß∞"
              oninput="checkImportValid()"
            />
          </div>
          <div class="import-form-group">
            <label class="import-form-label">Ê≠åÊâã/Ëâ∫ÊúØÂÆ∂</label>
            <input
              type="text"
              class="import-form-input"
              id="importMusicArtist"
              placeholder="ËæìÂÖ•Ê≠åÊâãÂêçÔºàÂèØÈÄâÔºâ"
            />
          </div>
          <div class="import-form-group">
            <label class="import-form-label"
              >Èü≥È¢ëÊñá‰ª∂ <span class="required">*</span></label
            >
            <div
              class="file-select-btn"
              onclick="document.getElementById('audioFileInput').click()"
            >
              <div class="file-select-icon">üéµ</div>
              <div class="file-select-info">
                <div class="file-select-name" id="selectedAudioName">
                  ÁÇπÂáªÈÄâÊã©Èü≥È¢ëÊñá‰ª∂
                </div>
                <div class="file-select-hint">ÊîØÊåÅ MP3„ÄÅM4A„ÄÅWAV Ê†ºÂºè</div>
              </div>
            </div>
            <input
              type="file"
              id="audioFileInput"
              hidden
              accept=".mp3,.m4a,.wav,.flac,.ogg,audio/*"
              onchange="handleAudioFileSelect(this)"
            />
          </div>
          <div class="import-form-group">
            <label class="import-form-label">Ê≠åËØçÊñá‰ª∂ÔºàÂèØÈÄâÔºâ</label>
            <div
              class="file-select-btn"
              onclick="document.getElementById('lrcFileInput').click()"
            >
              <div class="file-select-icon">üìù</div>
              <div class="file-select-info">
                <div class="file-select-name" id="selectedLrcName">
                  ÁÇπÂáªÈÄâÊã©ÔºàÂèØÈÄâÔºâ
                </div>
                <div class="file-select-hint">ÊîØÊåÅ LRC Ê†ºÂºèÊ≠åËØçÊñá‰ª∂</div>
              </div>
              <button
                class="file-clear-btn"
                onclick="event.stopPropagation(); clearSelectedLrc()"
              >
                ‚úï
              </button>
            </div>
            <input
              type="file"
              id="lrcFileInput"
              hidden
              accept=".lrc,.txt"
              onchange="handleLrcFileSelect(this)"
            />
          </div>
        </div>
        <div class="music-import-footer">
          <button class="import-btn cancel" onclick="closeMusicImportModal()">
            ÂèñÊ∂à
          </button>
          <button
            class="import-btn confirm"
            id="importMusicConfirmBtn"
            onclick="confirmImportMusic()"
            disabled
          >
            ÂØºÂÖ•
          </button>
        </div>
      </div>
    </div>

    <!-- Ê°åÈù¢Ê≠åËØçÔºàÁ∫ØÊñáÂ≠óÊÇ¨ÊµÆÔºâ -->
    <div class="desktop-lyric" id="desktopLyric">
      <div class="desktop-lyric-text" id="desktopLyricText">‚ô™ ‚ô™ ‚ô™</div>
      <button class="desktop-lyric-close" onclick="hideFloatingLyric()">
        ‚úï
      </button>
    </div>

    <!-- ÁºñËæëÊ≠åËØçÂºπÁ™ó -->
    <div
      class="edit-lyrics-modal"
      id="editLyricsModal"
      onclick="if(event.target===this)closeEditLyricsModal()"
    >
      <div class="edit-lyrics-content">
        <div class="edit-lyrics-header">
          <span class="edit-lyrics-title">üìù ÁºñËæëÊ≠åËØç</span>
          <button class="edit-lyrics-close" onclick="closeEditLyricsModal()">
            ‚úï
          </button>
        </div>
        <div class="edit-lyrics-body">
          <div class="lyrics-format-hint">
            ÊîØÊåÅ LRC Ê†ºÂºèÔºå‰æãÂ¶ÇÔºö<br />
            [00:00.00] Ê≠åËØçÁ¨¨‰∏ÄÂè•<br />
            [00:05.20] Ê≠åËØçÁ¨¨‰∫åÂè•
          </div>
          <button
            class="lyrics-import-btn"
            onclick="document.getElementById('editLrcFileInput').click()"
          >
            üìÇ ÂØºÂÖ• LRC Êñá‰ª∂
          </button>
          <input
            type="file"
            id="editLrcFileInput"
            hidden
            accept=".lrc,.txt"
            onchange="importLyricsToEdit(this)"
          />
          <textarea
            id="editLyricsTextarea"
            placeholder="Âú®Ê≠§Á≤òË¥¥ÊàñËæìÂÖ•Ê≠åËØç..."
          ></textarea>
        </div>
        <div class="edit-lyrics-footer">
          <button class="lyrics-btn cancel" onclick="closeEditLyricsModal()">
            ÂèñÊ∂à
          </button>
          <button class="lyrics-btn save" onclick="saveEditedLyrics()">
            ‰øùÂ≠ò
          </button>
        </div>
      </div>
    </div>
    <script src="phone_peek.js"></script>
    <script src="music_together.js"></script>
    <!-- ËÆ∫ÂùõÂ∏ñÂ≠êËØ¶ÊÉÖ -->
    <div class="forum-detail-overlay" id="forumDetailOverlay">
      <div class="forum-detail-header">
        <button class="forum-detail-back" onclick="closeForumPostDetail()">
          ‚Üê
        </button>
        <div class="forum-detail-title">Â∏ñÂ≠êËØ¶ÊÉÖ</div>
        <div style="width: 36px"></div>
      </div>
      <div class="forum-detail-content" id="forumDetailContent"></div>
      <div
        class="forum-reply-indicator"
        id="forumReplyIndicator"
        style="display: none"
      ></div>
      <div class="forum-comment-bar">
        <input
          type="text"
          class="forum-comment-input"
          id="forumCommentInput"
          placeholder="ÂÜôËØÑËÆ∫..."
        />
        <button
          class="forum-comment-refresh"
          onclick="generateMoreComments()"
          title="ÁîüÊàêÊõ¥Â§ö‰∫íÂä®"
        >
          üí¨
        </button>
        <button class="forum-comment-send" onclick="submitForumComment()">
          ÂèëÈÄÅ
        </button>
      </div>
    </div>

    <!-- ËÆ∫ÂùõËÆæÁΩÆ -->
    <div class="forum-settings-overlay" id="forumSettingsOverlay">
      <div class="forum-settings-header">
        <button class="forum-settings-back" onclick="closeForumSettings()">
          ‚Üê
        </button>
        <div class="forum-settings-title">ËÆ∫ÂùõËÆæÁΩÆ</div>
        <div style="width: 36px"></div>
      </div>
      <div class="forum-settings-content" id="forumSettingsContent"></div>
    </div>

    <!-- ËÆ∫ÂùõÂèëÂ∏ñ -->
    <div class="forum-compose-overlay" id="forumComposeOverlay">
      <div class="forum-compose-header">
        <button class="forum-compose-cancel" onclick="closeForumCompose()">
          ÂèñÊ∂à
        </button>
        <div class="forum-compose-title">ÂèëÂ∏ñ</div>
        <button class="forum-compose-submit" onclick="submitForumPost()">
          ÂèëÂ∏É
        </button>
      </div>
      <div class="forum-compose-body">
        <div
          class="forum-compose-author"
          id="forumComposeAuthor"
          onclick="showForumAuthorPicker()"
        ></div>
        <textarea
          class="forum-compose-textarea"
          id="forumComposeTextarea"
          placeholder="ÂàÜ‰∫´‰Ω†ÁöÑÊÉ≥Ê≥ï..."
        ></textarea>
      </div>
    </div>

    <script src="continue_chat.js"></script>
    <script src="forum_app.js"></script>
    <!-- Êü•ÊâãÊú∫È°µÈù¢ -->
    <div class="phone-peek-page" id="phonePeekPage">
      <button class="phone-peek-close" onclick="closePhonePeek()">‚úï</button>

      <!-- ÊâãÊú∫Â§ñÂ£≥ -->
      <div class="phone-device">
        <div class="phone-screen">
          <!-- ÁÅµÂä®Â≤õ -->
          <div class="phone-dynamic-island"></div>

          <!-- Áä∂ÊÄÅÊ†è -->
          <div class="phone-statusbar">
            <div class="phone-statusbar-left" id="phoneTime">9:41</div>
            <div class="phone-statusbar-center"></div>
            <div class="phone-statusbar-right">
              <span class="status-icon">
                <svg width="18" height="12" viewBox="0 0 18 12" fill="white">
                  <path
                    d="M1 4.5C1 3.67 1.67 3 2.5 3h2C5.33 3 6 3.67 6 4.5v3C6 8.33 5.33 9 4.5 9h-2C1.67 9 1 8.33 1 7.5v-3z"
                    fill-opacity="0.35"
                  />
                  <path
                    d="M1 4.5C1 3.67 1.67 3 2.5 3h2C5.33 3 6 3.67 6 4.5v3C6 8.33 5.33 9 4.5 9h-2C1.67 9 1 8.33 1 7.5v-3z"
                  />
                  <path
                    d="M7 5C7 4.17 7.67 3.5 8.5 3.5h2c.83 0 1.5.67 1.5 1.5v2.5c0 .83-.67 1.5-1.5 1.5h-2C7.67 9 7 8.33 7 7.5V5z"
                    fill-opacity="0.35"
                  />
                  <path
                    d="M7 5C7 4.17 7.67 3.5 8.5 3.5h2c.83 0 1.5.67 1.5 1.5v2.5c0 .83-.67 1.5-1.5 1.5h-2C7.67 9 7 8.33 7 7.5V5z"
                  />
                  <path
                    d="M13 5.5c0-.83.67-1.5 1.5-1.5h1c.83 0 1.5.67 1.5 1.5v2c0 .83-.67 1.5-1.5 1.5h-1c-.83 0-1.5-.67-1.5-1.5v-2z"
                    fill-opacity="0.35"
                  />
                  <path
                    d="M13 5.5c0-.83.67-1.5 1.5-1.5h1c.83 0 1.5.67 1.5 1.5v2c0 .83-.67 1.5-1.5 1.5h-1c-.83 0-1.5-.67-1.5-1.5v-2z"
                  />
                </svg>
              </span>
              <span class="status-icon">
                <svg width="25" height="12" viewBox="0 0 25 12" fill="white">
                  <rect
                    x="0.5"
                    y="0.5"
                    width="21"
                    height="11"
                    rx="2.5"
                    stroke="white"
                    stroke-opacity="0.35"
                    fill="none"
                  />
                  <rect
                    x="2"
                    y="2"
                    width="17"
                    height="8"
                    rx="1.5"
                    fill="white"
                  />
                  <path
                    d="M23 4v4c.83-.6 1.33-1.5 1.33-2s-.5-1.4-1.33-2z"
                    fill="white"
                    fill-opacity="0.4"
                  />
                </svg>
              </span>
            </div>
          </div>

          <!-- ÊâãÊú∫‰∏ª‰Ωì -->
          <div class="phone-body">
            <!-- AppÂ§¥ÈÉ®ÔºàËøõÂÖ•AppÂêéÊòæÁ§∫Ôºâ -->
            <div class="phone-app-header" id="phoneAppHeader">
              <button class="phone-app-back" onclick="showPhoneHome()">
                ‚Äπ
              </button>
              <div class="phone-app-title">App</div>
              <div class="phone-app-header-spacer"></div>
            </div>

            <!-- ÂÜÖÂÆπÂå∫ -->
            <div class="phone-content" id="phoneContent">
              <!-- Âä®ÊÄÅÊ∏≤Êüì -->
            </div>
          </div>

          <!-- Â∫ïÈÉ®Ê®™Êù° -->
          <div class="phone-home-indicator"></div>
        </div>
      </div>
    </div>
    <script>
      // Ê≥®ÂÜå Service Worker
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("./sw.js")
            .then((registration) => {
              console.log("Service Worker Ê≥®ÂÜåÊàêÂäüÔºåËåÉÂõ¥:", registration.scope);
            })
            .catch((err) => {
              console.log("Service Worker Ê≥®ÂÜåÂ§±Ë¥•:", err);
            });
        });
      }

      // ËØ∑Ê±ÇÈÄöÁü•ÊùÉÈôêÔºàÂøÖÈ°ªÁÇπ‚ÄúÂÖÅËÆ∏‚ÄùÊâçËÉΩÂºπÁ™óÔºâ
      function requestNotificationPermission() {
        if ("Notification" in window) {
          Notification.requestPermission().then((permission) => {
            if (permission === "granted") {
              console.log("ÈÄöÁü•ÊùÉÈôêÂ∑≤Ëé∑Âèñ");
              if (window.showToast) window.showToast("ÈÄöÁü•ÊùÉÈôêÂ∑≤ÂºÄÂêØ");
            }
          });
        }
      }

      // ÂèØ‰ª•Âú®Áî®Êà∑È¶ñÊ¨°ÁÇπÂáªÈ°µÈù¢‰ªªÊÑè‰ΩçÁΩÆÊó∂Ëß¶ÂèëÁî≥ËØ∑ÊùÉÈôêÔºåÊàñËÄÖÂÅö‰∏Ä‰∏™‰∏ìÈó®ÁöÑÊåâÈíÆ
      document.body.addEventListener("click", requestNotificationPermission, {
        once: true,
      });
    </script>
  </body>
</html>
