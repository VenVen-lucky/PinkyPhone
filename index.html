<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />

    <!-- PWA é…ç½® -->
    <link rel="manifest" href="manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="PinkyPhone" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#fce4ec" />

    <!-- ä¸»å±å¹•å›¾æ ‡ -->
    <link
      rel="apple-touch-icon"
      href="https://i.postimg.cc/8kmQwCr0/IMG-2897.jpg"
    />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="https://i.postimg.cc/8kmQwCr0/IMG-2897.jpg"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="https://i.postimg.cc/8kmQwCr0/IMG-2897.jpg"
    />
    <link
      rel="icon"
      type="image/png"
      href="https://i.postimg.cc/8kmQwCr0/IMG-2897.jpg"
    />

    <title>PinkyPhone</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=Satisfy&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js?v=1.4"></script>

    <!-- å¤–éƒ¨æ ·å¼è¡¨ -->
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="moment-instagram.css" />
    <link rel="stylesheet" href="music_together.css" />
    <link rel="stylesheet" href="phone_peek.css" />
    <link rel="stylesheet" href="continue_chat.css" />
    <link rel="stylesheet" href="forum_app.css" />
    <link rel="stylesheet" href="companion.css" />
    <link rel="stylesheet" href="couple_space.css" />
  
    <style>
    /* ============ ä¸»å±å¹•åŒé¡µæ»‘åŠ¨æ ·å¼ ============ */
    .home-wallpaper {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 0;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      pointer-events: none;
    }

    .home-pages-container {
      display: flex;
      width: 200%;
      height: 100%;
      transition: transform 0.3s ease-out;
      position: relative;
      z-index: 1;
    }

    .home-page {
      width: 50%;
      height: 100%;
      flex-shrink: 0;
      overflow: hidden;
      position: relative;
    }

    .home-page .main-content {
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      background: transparent;
    }

    .widgets-page-content {
      padding: 16px;
      padding-top: calc(50px + env(safe-area-inset-top, 0px));
      padding-bottom: calc(120px + env(safe-area-inset-bottom, 0px));
      min-height: 100%;
    }

    .widgets-page-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: rgba(60, 60, 60, 0.85);
      margin-bottom: 20px;
      text-align: center;
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
    }

    .widgets-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .widget-placeholder {
      grid-column: span 2;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.6), rgba(255, 255, 255, 0.3));
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
      border-radius: 24px;
      padding: 40px 20px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    .widget-placeholder-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.6;
    }

    .widget-placeholder-text {
      font-size: 1.1rem;
      font-weight: 600;
      color: rgba(60, 60, 60, 0.7);
      margin-bottom: 8px;
    }

    .widget-placeholder-hint {
      font-size: 0.85rem;
      color: rgba(60, 60, 60, 0.5);
    }

    .home-page-indicator {
      position: fixed;
      bottom: calc(85px + env(safe-area-inset-bottom, 0px));
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 100;
      padding: 6px 12px;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 20px;
    }

    .indicator-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(100, 100, 100, 0.3);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .indicator-dot.active {
      background: rgba(244, 143, 177, 0.9);
      width: 20px;
      border-radius: 4px;
    }
    </style>

  </head>
  <body>
    <!-- Decorative stars -->
    <div class="star star-1"></div>
    <div class="star star-2"></div>
    <div class="star star-3"></div>
    <div class="star star-4"></div>
    <div class="star star-5"></div>

    <div class="phone-container">
      <!-- ä¸»å±å¹•å£çº¸èƒŒæ™¯å±‚ -->
      <div class="home-wallpaper" id="homeWallpaper"></div>
      
      <!-- åŒé¡µæ»‘åŠ¨å®¹å™¨ -->
      <div class="home-pages-container" id="homePagesContainer">
        <!-- ç¬¬ä¸€é¡µï¼šåŸä¸»å±å¹•å†…å®¹ -->
        <div class="home-page home-page-1" id="homePage1">
          <div class="main-content">
        <div class="profile-widget-new">
          <div class="profile-bg-container" onclick="triggerBgUpload()">
            <img
              id="userProfileBg"
              src="https://images.unsplash.com/photo-1490750967868-58cb75069ed6?auto=format&fit=crop&w=800&q=80"
              alt="èƒŒæ™¯å¢™"
            />
            <div class="bg-edit-hint">ç‚¹å‡»æ›´æ¢èƒŒæ™¯</div>
          </div>

          <div class="profile-info-card">
            <div class="profile-avatar-wrapper" onclick="triggerAvatarUpload()">
              <img
                id="userProfileAvatar"
                src='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸ°</text></svg>'
                alt="å¤´åƒ"
              />
            </div>

            <div
              class="profile-name-large"
              id="userNameDisplay"
              onclick="editUserName()"
            >
              ä½ çš„åå­—
            </div>

            <div
              class="profile-bio-text"
              id="userBioDisplay"
              onclick="editUserBio()"
            >
              ç‚¹å‡»è¿™é‡Œè®¾ç½®ä½ çš„ä¸ªæ€§ç­¾å...
            </div>

            <div class="profile-location" onclick="editUserLocation()">
              <svg
                class="location-icon"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M12 13.43a3.12 3.12 0 1 0 0-6.24 3.12 3.12 0 0 0 0 6.24Z"
                  stroke="currentColor"
                  stroke-width="1.5"
                />
                <path
                  d="M3.62 8.49c1.97-8.66 14.8-8.65 16.76 0 1.15 5.08-2.01 9.38-4.78 12.04a5.193 5.193 0 0 1-7.2 0C5.63 17.87 2.47 13.57 3.62 8.49Z"
                  stroke="currentColor"
                  stroke-width="1.5"
                />
              </svg>
              <span id="userLocationDisplay">æ·»åŠ å®šä½</span>
            </div>
          </div>

          <input
            type="file"
            id="bgInput"
            hidden
            accept="image/*"
            onchange="handleBgChange(this)"
          />
          <input
            type="file"
            id="avatarInput"
            hidden
            accept="image/*"
            onchange="handleAvatarChange(this)"
          />
        </div>

        <!-- Apps -->
        <div class="apps-section">
          <div class="apps-grid">
            <!-- å·¦ä¾§åŒºåŸŸ -->
            <div class="apps-left">
              <!-- ç¥ç§˜å¡ç‰‡å°ç»„ä»¶ (å ä¸¤åˆ—) -->
              <div class="mystery-widget widget-2x2" id="mysteryWidget">
                <!-- æ‰‹å†™ä½“æ ‡é¢˜ -->
                <div
                  class="mystery-title"
                  id="mysteryTitle"
                  onclick="editMysteryTitle()"
                >
                  Pinky Phone
                </div>

                <!-- ç¬¬ä¸€ä¸ªèƒ¶å›Šå¡ç‰‡ï¼šå›¾ç‰‡åœ¨å·¦ -->
                <div
                  class="mystery-capsule capsule-img-left"
                  onclick="handleMysteryCard1Click(event)"
                >
                  <div
                    class="mystery-capsule-img"
                    onclick="event.stopPropagation(); document.getElementById('mysteryImg1Input').click()"
                  >
                    <span class="mystery-emoji" id="mysteryEmoji1">ğŸ°</span>
                    <img id="mysteryImg1" src="" style="display: none" alt="" />
                  </div>
                  <div
                    class="mystery-capsule-text"
                    id="mysteryText1"
                    onclick="event.stopPropagation(); editMysteryText(1)"
                  >
                    è¯·è¾“å…¥æ–‡å­—
                  </div>
                </div>

                <!-- ç¬¬äºŒä¸ªèƒ¶å›Šå¡ç‰‡ï¼šå›¾ç‰‡åœ¨å³ -->
                <div
                  class="mystery-capsule capsule-img-right"
                  onclick="handleMysteryCard2Click(event)"
                >
                  <div
                    class="mystery-capsule-text"
                    id="mysteryText2"
                    onclick="event.stopPropagation(); editMysteryText(2)"
                  >
                    è¯·è¾“å…¥æ–‡å­—
                  </div>
                  <div
                    class="mystery-capsule-img"
                    onclick="event.stopPropagation(); document.getElementById('mysteryImg2Input').click()"
                  >
                    <span class="mystery-emoji" id="mysteryEmoji2">ğŸ°</span>
                    <img id="mysteryImg2" src="" style="display: none" alt="" />
                  </div>
                </div>

                <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
                <input
                  type="file"
                  id="mysteryImg1Input"
                  class="hidden-input"
                  accept="image/*"
                  onchange="handleMysteryImgUpload(1, this)"
                />
                <input
                  type="file"
                  id="mysteryImg2Input"
                  class="hidden-input"
                  accept="image/*"
                  onchange="handleMysteryImgUpload(2, this)"
                />
              </div>

              <!-- å·¦ä¾§APP -->
              <div class="app-item" onclick="openCoupleSpace()">
                <div class="app-icon gradient-pink">æƒ…ä¾£</div>
                <span class="app-name">æƒ…ä¾£ç©ºé—´</span>
              </div>
              <div class="app-item" onclick="openCompanionPage()">
                <div class="app-icon gradient-blue">é™ªä¼´</div>
                <span class="app-name">é™ªä¼´</span>
              </div>
              <div class="app-item" onclick="openPhonePeekSelector()">
                <div class="app-icon gradient-cyan" id="appIcon_phonepeek">
                  <svg
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                  >
                    <rect
                      x="5"
                      y="2"
                      width="14"
                      height="20"
                      rx="2"
                      ry="2"
                    ></rect>
                    <line x1="12" y1="18" x2="12.01" y2="18"></line>
                  </svg>
                </div>
                <span class="app-name">æŸ¥æ‰‹æœº</span>
              </div>
            </div>

            <!-- å³ä¾§åŒºåŸŸ -->
            <div class="apps-right">
              <div class="app-item" onclick="openPage('chatPage')">
                <div class="app-icon gradient-pink">èŠå¤©</div>
                <span class="app-name">èŠå¤©</span>
              </div>
              <div class="app-item" onclick="openPage('worldbookPage')">
                <div class="app-icon gradient-green">ä¸–ç•Œä¹¦</div>
                <span class="app-name">ä¸–ç•Œä¹¦</span>
              </div>
              <div class="app-item" onclick="openPage('presetPage')">
                <div class="app-icon gradient-orange">é¢„è®¾</div>
                <span class="app-name">é¢„è®¾</span>
              </div>
              <div class="app-item" onclick="openPage('forumPage')">
                <div class="app-icon gradient-purple">è®ºå›</div>
                <span class="app-name">è®ºå›</span>
              </div>

              <!-- æ‹ç«‹å¾—å°ç»„ä»¶ -->
              <div class="polaroid-widget widget-2x2" id="polaroidWidget">
                <div
                  class="polaroid-photo-area"
                  onclick="triggerPolaroidUpload()"
                >
                  <img
                    id="polaroidImgDisplay"
                    src="https://images.unsplash.com/photo-1516961642265-531546e84af2?auto=format&fit=crop&w=400&q=80"
                    alt="æ‹ç«‹å¾—"
                  />
                </div>
                <div
                  class="polaroid-caption"
                  id="polaroidTextDisplay"
                  onclick="editPolaroidText(event)"
                >
                  My Moment
                </div>
                <input
                  type="file"
                  id="polaroidInput"
                  hidden
                  accept="image/*"
                  onchange="handlePolaroidChange(this)"
                />
              </div>
            </div>
          </div>
        </div>
          </div>
        </div>
        
        <!-- ç¬¬äºŒé¡µï¼šå°ç»„ä»¶é¡µé¢ -->
        <div class="home-page home-page-2" id="homePage2">
          <div class="main-content">
            <div class="widgets-page-content">
              <div class="widgets-page-title">ğŸ¨ å°ç»„ä»¶</div>
              <div class="widgets-grid" id="widgetsGrid">
                <!-- å°ç»„ä»¶å ä½æç¤º -->
                <div class="widget-placeholder">
                  <div class="widget-placeholder-icon">ğŸ“¦</div>
                  <div class="widget-placeholder-text">å³å°†æ·»åŠ æ›´å¤šå°ç»„ä»¶</div>
                  <div class="widget-placeholder-hint">æ•¬è¯·æœŸå¾…...</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- é¡µé¢æŒ‡ç¤ºå™¨ -->
      <div class="home-page-indicator" id="homePageIndicator">
        <div class="indicator-dot active" data-page="0"></div>
        <div class="indicator-dot" data-page="1"></div>
      </div>

      <!-- Pages -->
      <div id="chatPage" class="page chat-app">
        <!-- Chat App Header -->
        <div class="chat-header">
          <button class="back-btn" onclick="closePage('chatPage')">â†</button>
          <h1 class="chat-title" id="chatAppTitle">Message</h1>
          <div class="chat-header-btns">
            <button
              class="chat-header-btn"
              id="createGroupBtn"
              onclick="openCreateGroupModal()"
              title="åˆ›å»ºç¾¤èŠ"
            >
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
            </button>
            <button
              class="chat-header-btn"
              id="chatHeaderBtn"
              onclick="handleHeaderBtn()"
            >
              +
            </button>
          </div>
        </div>

        <!-- Chat App Content -->
        <div class="chat-content">
          <!-- Messages Tab -->
          <div class="chat-tab-content active" id="messagesTab">
            <!-- Search bar -->
            <div class="search-bar">
              <span class="search-icon"
                ><svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <circle cx="11" cy="11" r="8"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg
              ></span>
              <input
                type="text"
                placeholder="æœç´¢èŠå¤©è®°å½•"
                class="search-input"
                id="chatSearchInput"
                oninput="searchChatHistory(this.value)"
              />
            </div>

            <!-- æœç´¢ç»“æœ -->
            <div class="search-results" id="searchResults"></div>

            <!-- Message List -->
            <div class="message-list" id="messageList">
              <!-- Empty state -->
              <div class="empty-state" id="emptyMessages">
                <div class="empty-icon">
                  <svg
                    width="48"
                    height="48"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                    ></path>
                  </svg>
                </div>
                <div class="empty-text">è¿˜æ²¡æœ‰æ¶ˆæ¯å“¦</div>
                <div class="empty-hint">æ·»åŠ AIè§’è‰²å¼€å§‹èŠå¤©å§ï½</div>
              </div>
            </div>
          </div>

          <!-- Moments Tab (QQç©ºé—´é£æ ¼åŠ¨æ€) -->
          <div class="chat-tab-content" id="momentsTab">
            <!-- ä¸ªäººåç‰‡åŒºåŸŸ -->
            <div class="moment-profile-card">
              <div
                class="moment-cover"
                id="momentCover"
                onclick="changeMomentCover()"
              >
                <img id="momentCoverImg" src="" style="display: none" />
                <button
                  class="moment-cover-back"
                  onclick="event.stopPropagation();switchChatTab('messages')"
                >
                  â€¹
                </button>
                <button
                  class="moment-cover-edit"
                  onclick="event.stopPropagation();changeMomentCover()"
                >
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"
                    ></path>
                    <circle cx="12" cy="13" r="4"></circle>
                  </svg>
                </button>
              </div>
              <div class="moment-profile-info">
                <div class="moment-avatar-row">
                  <div class="moment-avatar-wrap">
                    <div
                      class="moment-avatar"
                      id="momentAvatar"
                      onclick="changeMomentAvatar()"
                    >
                      <span id="momentAvatarEmoji">ğŸ˜Š</span>
                      <img id="momentAvatarImg" src="" style="display: none" />
                    </div>
                    <button
                      class="moment-avatar-edit"
                      onclick="event.stopPropagation();changeMomentAvatar()"
                    >
                      <svg
                        width="10"
                        height="10"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2.5"
                      >
                        <path
                          d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"
                        ></path>
                        <circle cx="12" cy="13" r="4"></circle>
                      </svg>
                    </button>
                  </div>
                  <div class="moment-name-area">
                    <div
                      class="moment-nickname"
                      id="momentNickname"
                      onclick="editMomentNickname()"
                    >
                      ç”¨æˆ·
                    </div>
                    <div
                      class="moment-handle"
                      id="momentHandle"
                      onclick="editMomentHandle()"
                    >
                      @username
                    </div>
                  </div>
                </div>
                <div
                  class="moment-signature"
                  id="momentSignature"
                  onclick="editMomentSignature()"
                ></div>
              </div>
            </div>

            <!-- åŠ¨æ€åˆ—è¡¨ -->
            <div class="ig-feed" id="igFeed">
              <div class="ig-empty-state" id="igEmptyState">
                <div class="ig-empty-icon">
                  <svg
                    width="48"
                    height="48"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <rect
                      x="3"
                      y="3"
                      width="18"
                      height="18"
                      rx="2"
                      ry="2"
                    ></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                  </svg>
                </div>
                <div class="ig-empty-title">åˆ†äº«ä½ çš„ç²¾å½©ç¬é—´</div>
                <div class="ig-empty-text">ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®å‘å¸ƒç¬¬ä¸€æ¡åŠ¨æ€å§~</div>
              </div>
            </div>

            <!-- å‘å¸ƒæŒ‰é’® -->
            <button class="ig-fab" onclick="openPostModal()">
              <span class="ig-fab-icon">+</span>
            </button>
          </div>

          <!-- å‘å¸ƒåŠ¨æ€å¼¹çª— -->
          <div
            class="ig-post-modal"
            id="igPostModal"
            onclick="if(event.target===this)closePostModal()"
          >
            <div class="ig-post-modal-content">
              <div class="ig-modal-header">
                <button class="ig-modal-close" onclick="closePostModal()">
                  å–æ¶ˆ
                </button>
                <span class="ig-modal-title">æ–°åŠ¨æ€</span>
                <button
                  class="ig-modal-submit"
                  id="igPostSubmit"
                  onclick="submitPost()"
                  disabled
                >
                  å‘å¸ƒ
                </button>
              </div>
              <div class="ig-modal-body">
                <textarea
                  class="ig-post-textarea"
                  id="igPostText"
                  placeholder="åˆ†äº«ä½ çš„æƒ³æ³•..."
                  oninput="checkPostValid()"
                ></textarea>
                <div class="ig-image-options">
                  <div
                    class="ig-image-option"
                    onclick="selectImageOption('album')"
                    id="imgOptionAlbum"
                  >
                    <span class="ig-image-option-icon"
                      ><svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <rect
                          x="3"
                          y="3"
                          width="18"
                          height="18"
                          rx="2"
                          ry="2"
                        ></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline></svg
                    ></span>
                    <span class="ig-image-option-text">ä»ç›¸å†Œé€‰æ‹©</span>
                  </div>
                  <div
                    class="ig-image-option"
                    onclick="selectImageOption('text')"
                    id="imgOptionText"
                  >
                    <span class="ig-image-option-icon"
                      ><svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                        <path
                          d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"
                        ></path>
                        <path d="M2 2l7.586 7.586"></path>
                        <circle cx="11" cy="11" r="2"></circle></svg
                    ></span>
                    <span class="ig-image-option-text">æ–‡å­—é…å›¾</span>
                  </div>
                </div>
                <input
                  type="file"
                  id="igImageInput"
                  accept="image/*"
                  style="display: none"
                  onchange="handleImageSelect(event)"
                />
                <input
                  type="text"
                  class="ig-text-img-input"
                  id="igTextImgInput"
                  placeholder="è¾“å…¥å›¾ç‰‡æè¿°ï¼ŒAIå°†çœ‹åˆ°è¿™ä¸ªæè¿°..."
                  oninput="checkPostValid()"
                />
                <div class="ig-image-preview" id="igImagePreview">
                  <img id="igPreviewImg" src="" alt="" />
                  <span class="ig-image-preview-remove" onclick="removeImage()"
                    ><svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    ç§»é™¤å›¾ç‰‡</span
                  >
                </div>

                <!-- å¯è§èŒƒå›´é€‰æ‹© -->
                <div class="ig-visibility-section">
                  <div class="ig-visibility-label">
                    <svg
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                      ></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    è°å¯ä»¥çœ‹
                    <button
                      class="ig-manage-groups-btn"
                      onclick="openGroupManageModal()"
                      title="ç®¡ç†åˆ†ç»„"
                    >
                      <svg
                        width="14"
                        height="14"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <circle cx="12" cy="12" r="3"></circle>
                        <path
                          d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                        ></path>
                      </svg>
                    </button>
                  </div>
                  <div class="ig-visibility-options" id="visibilityOptions">
                    <div
                      class="ig-visibility-option selected"
                      data-value="all"
                      onclick="selectVisibility('all', this)"
                    >
                      <span class="check-icon">âœ“</span> å…¬å¼€
                    </div>
                    <!-- åˆ†ç»„é€‰é¡¹ä¼šé€šè¿‡JSåŠ¨æ€æ¸²æŸ“ -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- è‡ªå®šä¹‰åˆ†ç»„ç®¡ç†å¼¹çª— -->
          <div
            class="ig-group-manage-modal"
            id="igGroupManageModal"
            onclick="if(event.target===this)closeGroupManageModal()"
          >
            <div class="ig-group-manage-content">
              <div class="ig-group-manage-header">
                <button
                  class="ig-group-manage-close"
                  onclick="closeGroupManageModal()"
                >
                  å…³é—­
                </button>
                <span class="ig-group-manage-title">ç®¡ç†è‡ªå®šä¹‰åˆ†ç»„</span>
                <button
                  class="ig-group-manage-add"
                  onclick="openIgGroupModal()"
                >
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                </button>
              </div>
              <div class="ig-group-manage-list" id="customGroupList">
                <!-- åˆ†ç»„åˆ—è¡¨é€šè¿‡JSæ¸²æŸ“ -->
              </div>
            </div>
          </div>

          <!-- åˆ›å»º/ç¼–è¾‘åˆ†ç»„å¼¹çª— -->
          <div
            class="ig-create-group-modal"
            id="igCreateGroupModal"
            onclick="if(event.target===this)closeIgGroupModal()"
          >
            <div class="ig-create-group-content">
              <div class="ig-create-group-header">
                <button
                  class="ig-create-group-back"
                  onclick="closeIgGroupModal()"
                >
                  å–æ¶ˆ
                </button>
                <span class="ig-create-group-title" id="igGroupTitle"
                  >æ–°å»ºåˆ†ç»„</span
                >
                <button
                  class="ig-create-group-save"
                  onclick="saveCustomGroup()"
                >
                  ä¿å­˜
                </button>
              </div>
              <div class="ig-create-group-body">
                <div class="ig-create-group-name-section">
                  <label>åˆ†ç»„åç§°</label>
                  <input
                    type="text"
                    id="customGroupNameInput"
                    placeholder="ä¾‹å¦‚ï¼šä»…é—ºèœœå¯è§ã€ä¸ç»™è°çœ‹..."
                    maxlength="20"
                  />
                </div>
                <div class="ig-create-group-type-section">
                  <label>åˆ†ç»„ç±»å‹</label>
                  <div class="ig-group-type-options">
                    <div
                      class="ig-group-type-option selected"
                      data-type="include"
                      onclick="selectGroupType('include', this)"
                    >
                      <div class="ig-group-type-info">
                        <div class="ig-group-type-name">éƒ¨åˆ†å¯è§</div>
                        <div class="ig-group-type-desc">åªæœ‰é€‰ä¸­çš„äººå¯ä»¥çœ‹</div>
                      </div>
                    </div>
                    <div
                      class="ig-group-type-option"
                      data-type="exclude"
                      onclick="selectGroupType('exclude', this)"
                    >
                      <div class="ig-group-type-info">
                        <div class="ig-group-type-name">ä¸ç»™è°çœ‹</div>
                        <div class="ig-group-type-desc">é€‰ä¸­çš„äººçœ‹ä¸åˆ°</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="ig-create-group-members-section">
                  <div class="ig-members-header">
                    <label id="membersLabel">é€‰æ‹©å¯è§çš„äºº</label>
                    <div class="ig-members-actions">
                      <button onclick="selectAllGroupMembers()">å…¨é€‰</button>
                      <button onclick="deselectAllGroupMembers()">æ¸…ç©º</button>
                    </div>
                  </div>
                  <div class="ig-members-search">
                    <input
                      type="text"
                      id="groupMemberSearch"
                      placeholder="æœç´¢å¥½å‹..."
                      oninput="filterGroupMemberList(this.value)"
                    />
                  </div>
                  <div class="ig-members-list" id="groupMemberList">
                    <!-- å¥½å‹åˆ—è¡¨é€šè¿‡JSæ¸²æŸ“ -->
                  </div>
                  <div class="ig-members-count">
                    å·²é€‰æ‹© <span id="groupMemberCount">0</span> äºº
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ä¸ªäººèµ„æ–™ç¼–è¾‘å¼¹çª— -->
          <div
            class="ig-profile-modal"
            id="igProfileModal"
            onclick="if(event.target===this)closeProfileModal()"
          >
            <div class="ig-profile-modal-content">
              <div class="ig-profile-modal-header">
                <span class="ig-profile-modal-title">ç¼–è¾‘ä¸ªäººèµ„æ–™</span>
                <button
                  class="ig-profile-modal-close"
                  onclick="closeProfileModal()"
                >
                  âœ•
                </button>
              </div>
              <div class="ig-profile-modal-body">
                <div class="ig-profile-avatar-edit">
                  <div class="ig-profile-avatar-preview" id="igAvatarPreview">
                    A
                  </div>
                  <div class="ig-profile-avatar-btns">
                    <button
                      class="ig-profile-avatar-btn"
                      onclick="document.getElementById('igAvatarInput').click()"
                    >
                      ä¸Šä¼ ç…§ç‰‡
                    </button>
                    <button
                      class="ig-profile-avatar-btn"
                      onclick="openEmojiPicker()"
                    >
                      é€‰æ‹©è¡¨æƒ…
                    </button>
                  </div>
                  <input
                    type="file"
                    id="igAvatarInput"
                    accept="image/*"
                    style="display: none"
                    onchange="handleAvatarSelect(event)"
                  />
                </div>
                <div class="ig-profile-form-group">
                  <label class="ig-profile-form-label">æ˜µç§°</label>
                  <input
                    type="text"
                    class="ig-profile-form-input"
                    id="igEditName"
                    placeholder="è¾“å…¥ä½ çš„æ˜µç§°"
                  />
                </div>
                <div class="ig-profile-form-group">
                  <label class="ig-profile-form-label">ç”¨æˆ·å</label>
                  <input
                    type="text"
                    class="ig-profile-form-input"
                    id="igEditHandle"
                    placeholder="@username"
                  />
                </div>
                <div class="ig-profile-form-group">
                  <label class="ig-profile-form-label">ä¸ªæ€§ç­¾å</label>
                  <textarea
                    class="ig-profile-form-textarea"
                    id="igEditBio"
                    placeholder="å†™ç‚¹ä»€ä¹ˆä»‹ç»ä¸€ä¸‹è‡ªå·±å§~"
                  ></textarea>
                </div>
                <button class="ig-profile-save-btn" onclick="saveProfile()">
                  ä¿å­˜
                </button>
              </div>
            </div>
          </div>

          <!-- è¯„è®ºå¼¹çª— -->
          <div
            class="ig-comments-modal"
            id="igCommentsModal"
            onclick="if(event.target===this)closeCommentsModal()"
          >
            <div class="ig-comments-modal-content">
              <div class="ig-comments-header">
                <span class="ig-comments-title">è¯„è®º</span>
                <button
                  class="ig-comments-close"
                  onclick="closeCommentsModal()"
                >
                  âœ•
                </button>
              </div>
              <div class="ig-comments-list" id="igCommentsList">
                <!-- è¯„è®ºä¼šåŠ¨æ€æ¸²æŸ“ -->
              </div>
              <div class="ig-comments-input-area">
                <input
                  type="text"
                  class="ig-comments-input"
                  id="igCommentInput"
                  placeholder="æ·»åŠ è¯„è®º..."
                />
                <button class="ig-comments-send" onclick="sendComment()">
                  å‘é€
                </button>
              </div>
            </div>
          </div>

          <!-- è½¬å‘é€‰æ‹©å¼¹çª— -->
          <div
            class="ig-share-modal"
            id="igShareModal"
            onclick="if(event.target===this)closeShareModal()"
          >
            <div class="ig-share-modal-content">
              <div class="ig-share-header">
                <span class="ig-share-title">è½¬å‘ç»™</span>
                <button class="ig-share-close" onclick="closeShareModal()">
                  âœ•
                </button>
              </div>
              <div class="ig-share-list" id="igShareList">
                <!-- è§’è‰²åˆ—è¡¨ä¼šåŠ¨æ€æ¸²æŸ“ -->
              </div>
            </div>
          </div>

          <!-- åŠ¨æ€æ“ä½œèœå• -->
          <div
            class="ig-post-menu"
            id="igPostMenu"
            onclick="if(event.target===this)closePostMenu()"
          >
            <div class="ig-post-menu-content">
              <div class="ig-post-menu-item" onclick="deletePost()">
                <span class="ig-post-menu-icon"
                  ><svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path
                      d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                    ></path></svg
                ></span>
                <span>åˆ é™¤åŠ¨æ€</span>
              </div>
              <div class="ig-post-menu-cancel" onclick="closePostMenu()">
                å–æ¶ˆ
              </div>
            </div>
          </div>

          <!-- Todo Tab - å››è±¡é™æ—¥å†è®¾è®¡ -->
          <div class="chat-tab-content" id="todoTab">
            <div class="todo-container">
              <!-- iOSå®‰å…¨åŒºåŸŸ -->
              <div class="todo-safe-area"></div>

              <!-- æœˆä»½å’Œå¹´ä»½æ˜¾ç¤º -->
              <div class="todo-month-header">
                <div class="todo-month-nav">
                  <button class="todo-nav-btn" onclick="todoNavMonth(-1)">
                    <svg
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                  </button>
                  <div
                    class="todo-month-text"
                    id="todoMonthText"
                    onclick="openTodoDatePicker()"
                  >
                    2024å¹´1æœˆ
                  </div>
                  <button class="todo-nav-btn" onclick="todoNavMonth(1)">
                    <svg
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                  </button>
                </div>
                <button class="todo-today-btn" onclick="todoGoToday()">
                  ä»Šå¤©
                </button>
              </div>

              <!-- å¯æ»‘åŠ¨çš„æœˆæ—¥å† -->
              <div class="todo-calendar-wrapper">
                <div class="todo-calendar-scroll" id="todoCalendarScroll">
                  <!-- åŠ¨æ€æ¸²æŸ“å½“æœˆæ‰€æœ‰æ—¥æœŸ -->
                </div>
              </div>

              <!-- å››è±¡é™åŒºåŸŸ -->
              <div class="todo-quadrants">
                <!-- é‡è¦ä¸”ç´§æ€¥ -->
                <div class="todo-quadrant q1" data-quadrant="q1">
                  <div class="quadrant-header">
                    <div class="quadrant-dot"></div>
                    <span class="quadrant-title">é‡è¦ä¸”ç´§æ€¥</span>
                  </div>
                  <div class="quadrant-list" id="todoQ1List">
                    <!-- åŠ¨æ€æ¸²æŸ“ -->
                  </div>
                </div>

                <!-- é‡è¦ä¸ç´§æ€¥ -->
                <div class="todo-quadrant q2" data-quadrant="q2">
                  <div class="quadrant-header">
                    <div class="quadrant-dot"></div>
                    <span class="quadrant-title">é‡è¦ä¸ç´§æ€¥</span>
                  </div>
                  <div class="quadrant-list" id="todoQ2List">
                    <!-- åŠ¨æ€æ¸²æŸ“ -->
                  </div>
                </div>

                <!-- ç´§æ€¥ä¸é‡è¦ -->
                <div class="todo-quadrant q3" data-quadrant="q3">
                  <div class="quadrant-header">
                    <div class="quadrant-dot"></div>
                    <span class="quadrant-title">ç´§æ€¥ä¸é‡è¦</span>
                  </div>
                  <div class="quadrant-list" id="todoQ3List">
                    <!-- åŠ¨æ€æ¸²æŸ“ -->
                  </div>
                </div>

                <!-- ä¸é‡è¦ä¸ç´§æ€¥ -->
                <div class="todo-quadrant q4" data-quadrant="q4">
                  <div class="quadrant-header">
                    <div class="quadrant-dot"></div>
                    <span class="quadrant-title">ä¸é‡è¦ä¸ç´§æ€¥</span>
                  </div>
                  <div class="quadrant-list" id="todoQ4List">
                    <!-- åŠ¨æ€æ¸²æŸ“ -->
                  </div>
                </div>
              </div>

              <!-- æµ®åŠ¨æ·»åŠ æŒ‰é’® -->
              <button class="todo-fab" onclick="openTodoModal()">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
              </button>

              <!-- AIç£ä¿ƒåŒºåŸŸ -->
              <div class="todo-ai-section">
                <div class="todo-ai-header">
                  <div class="todo-ai-icon">
                    <svg
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
                      ></path>
                      <circle cx="9" cy="7" r="4"></circle>
                      <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                      <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                  </div>
                  <div>
                    <div class="todo-ai-title">ç£ä¿ƒåŠ©æ‰‹</div>
                    <div class="todo-ai-subtitle">é€‰æ‹©è§’è‰²æ¥ç£ä¿ƒä½ å®Œæˆå¾…åŠ</div>
                  </div>
                </div>
                <div class="todo-ai-list" id="todoAiCharList">
                  <!-- åŠ¨æ€æ¸²æŸ“ -->
                </div>
              </div>
            </div>
          </div>

          <!-- å¹´æœˆé€‰æ‹©å™¨å¼¹çª— -->
          <div
            class="todo-datepicker-overlay"
            id="todoDatePickerOverlay"
            onclick="if(event.target===this)closeTodoDatePicker()"
          >
            <div class="todo-datepicker">
              <div class="todo-datepicker-header">
                <button
                  class="todo-datepicker-cancel"
                  onclick="closeTodoDatePicker()"
                >
                  å–æ¶ˆ
                </button>
                <span class="todo-datepicker-title">é€‰æ‹©æ—¥æœŸ</span>
                <button
                  class="todo-datepicker-confirm"
                  onclick="confirmTodoDatePicker()"
                >
                  ç¡®å®š
                </button>
              </div>
              <div class="todo-datepicker-body">
                <div class="todo-picker-column" id="todoYearPicker">
                  <!-- åŠ¨æ€æ¸²æŸ“å¹´ä»½ -->
                </div>
                <div class="todo-picker-column" id="todoMonthPicker">
                  <!-- åŠ¨æ€æ¸²æŸ“æœˆä»½ -->
                </div>
              </div>
            </div>
          </div>

          <!-- æ·»åŠ å¾…åŠå¼¹çª— -->
          <div
            class="todo-modal-overlay"
            id="todoModalOverlay"
            onclick="if(event.target===this)closeTodoModal()"
          >
            <div class="todo-modal">
              <div class="todo-modal-header">
                <div class="todo-modal-title">
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  æ·»åŠ å¾…åŠ
                </div>
                <button class="todo-modal-close" onclick="closeTodoModal()">
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              <div class="todo-modal-body">
                <div class="todo-input-group">
                  <label class="todo-input-label">å¾…åŠå†…å®¹</label>
                  <input
                    type="text"
                    class="todo-input"
                    id="todoInputText"
                    placeholder="è¦åšä»€ä¹ˆï¼Ÿ"
                    maxlength="100"
                  />
                </div>
                <div class="todo-input-group">
                  <label class="todo-input-label">ä¼˜å…ˆçº§ï¼ˆå››è±¡é™ï¼‰</label>
                  <div class="todo-quadrant-select" id="todoQuadrantSelect">
                    <div
                      class="todo-quadrant-option selected"
                      data-quadrant="q1"
                      onclick="selectTodoQuadrant(this)"
                    >
                      <div class="quadrant-option-dot q1"></div>
                      <span>é‡è¦ä¸”ç´§æ€¥</span>
                    </div>
                    <div
                      class="todo-quadrant-option"
                      data-quadrant="q2"
                      onclick="selectTodoQuadrant(this)"
                    >
                      <div class="quadrant-option-dot q2"></div>
                      <span>é‡è¦ä¸ç´§æ€¥</span>
                    </div>
                    <div
                      class="todo-quadrant-option"
                      data-quadrant="q3"
                      onclick="selectTodoQuadrant(this)"
                    >
                      <div class="quadrant-option-dot q3"></div>
                      <span>ç´§æ€¥ä¸é‡è¦</span>
                    </div>
                    <div
                      class="todo-quadrant-option"
                      data-quadrant="q4"
                      onclick="selectTodoQuadrant(this)"
                    >
                      <div class="quadrant-option-dot q4"></div>
                      <span>ä¸é‡è¦ä¸ç´§æ€¥</span>
                    </div>
                  </div>
                </div>
                <div class="todo-input-group">
                  <label class="todo-input-label">é‡å¤å‘¨æœŸ</label>
                  <div class="todo-repeat-grid" id="todoRepeatSelect">
                    <div
                      class="todo-repeat-item selected"
                      data-repeat="none"
                      onclick="selectTodoRepeat(this)"
                    >
                      <div class="todo-repeat-name">ä¸é‡å¤</div>
                    </div>
                    <div
                      class="todo-repeat-item"
                      data-repeat="daily"
                      onclick="selectTodoRepeat(this)"
                    >
                      <div class="todo-repeat-name">æ¯å¤©</div>
                    </div>
                    <div
                      class="todo-repeat-item"
                      data-repeat="weekday"
                      onclick="selectTodoRepeat(this)"
                    >
                      <div class="todo-repeat-name">å·¥ä½œæ—¥</div>
                    </div>
                    <div
                      class="todo-repeat-item"
                      data-repeat="weekly"
                      onclick="selectTodoRepeat(this)"
                    >
                      <div class="todo-repeat-name">æ¯å‘¨</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="todo-modal-footer">
                <button class="todo-save-btn" onclick="saveTodoItem()">
                  æ·»åŠ 
                </button>
              </div>
            </div>
          </div>

          <!-- å¾…åŠè®¾ç½®å¼¹çª— -->
          <div
            class="todo-modal-overlay"
            id="todoSettingsOverlay"
            onclick="if(event.target===this)closeTodoSettingsModal()"
          >
            <div class="todo-settings-modal">
              <div class="todo-modal-header">
                <div class="todo-modal-title">
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                      d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                    ></path>
                  </svg>
                  è®¾ç½®
                </div>
                <button
                  class="todo-modal-close"
                  onclick="closeTodoSettingsModal()"
                >
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              <div class="todo-modal-body">
                <!-- é—®å€™è¯­è®¾ç½® -->
                <div class="todo-settings-section">
                  <div class="todo-settings-title">é—®å€™è¯­</div>
                  <div class="greeting-preview">
                    <div class="greeting-preview-main" id="greetingPreviewMain">
                      ä»Šå¤©ä¹Ÿè¦åŠ æ²¹
                    </div>
                    <div class="greeting-preview-sub" id="greetingPreviewSub">
                      æ–°çš„ä¸€å¤©ï¼Œæ–°çš„å¼€å§‹
                    </div>
                  </div>
                  <div class="todo-input-group" style="margin-bottom: 8px">
                    <input
                      type="text"
                      class="todo-input"
                      id="greetingMainInput"
                      placeholder="ä¸»é—®å€™è¯­"
                      maxlength="20"
                    />
                  </div>
                  <div class="todo-input-group" style="margin-bottom: 8px">
                    <input
                      type="text"
                      class="todo-input"
                      id="greetingSubInput"
                      placeholder="å‰¯æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰"
                      maxlength="30"
                    />
                  </div>
                  <button
                    class="todo-save-btn"
                    style="padding: 10px; font-size: 0.85rem"
                    onclick="saveGreeting()"
                  >
                    ä¿å­˜é—®å€™è¯­
                  </button>
                </div>

                <!-- åˆ†ç±»ç®¡ç† -->
                <div class="todo-settings-section">
                  <div class="todo-settings-title">åˆ†ç±»ç®¡ç†</div>
                  <div
                    class="todo-category-grid"
                    id="todoCategoryList"
                    style="margin-bottom: 12px"
                  >
                    <!-- åŠ¨æ€æ¸²æŸ“ -->
                  </div>
                  <div style="display: flex; gap: 8px">
                    <input
                      type="text"
                      class="todo-input"
                      id="newCategoryName"
                      placeholder="æ–°åˆ†ç±»åç§°"
                      maxlength="10"
                      style="flex: 1"
                    />
                    <button
                      class="todo-save-btn"
                      style="
                        padding: 10px 16px;
                        font-size: 0.85rem;
                        width: auto;
                      "
                      onclick="addTodoCategory()"
                    >
                      æ·»åŠ 
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Profile Tab (æˆ‘çš„) -->
          <div class="chat-tab-content" id="profileTab">
            <!-- é¡¶æ  -->
            <div class="tab-header">
              <button class="tab-header-back" onclick="closePage('chatPage')">
                â†
              </button>
              <span class="tab-header-title">Me</span>
              <span style="width: 36px"></span>
            </div>
            <!-- Profile Header -->
            <div class="profile-header-card">
              <div class="profile-main">
                <div
                  class="profile-avatar-large"
                  id="meProfileAvatar"
                  onclick="changeMomentAvatar()"
                >
                  <svg
                    width="32"
                    height="32"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="#f48fb1"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                </div>
                <div class="profile-info-main">
                  <div
                    class="profile-name-large"
                    id="meProfileName"
                    onclick="editMomentNickname()"
                  >
                    æˆ‘çš„æ˜µç§°
                  </div>
                  <div
                    class="profile-id"
                    id="meProfileHandle"
                    onclick="editMomentHandle()"
                  >
                    @username
                  </div>
                </div>
              </div>
            </div>

            <!-- Profile Menu -->
            <div class="profile-menu">
              <div class="menu-item" onclick="openWalletPage()">
                <span class="menu-icon"
                  ><svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <rect
                      x="1"
                      y="4"
                      width="22"
                      height="16"
                      rx="2"
                      ry="2"
                    ></rect>
                    <line x1="1" y1="10" x2="23" y2="10"></line></svg
                ></span>
                <span class="menu-text">Wallet</span>
                <span class="menu-arrow">â€º</span>
              </div>
              <div class="menu-item" onclick="openFavoritesPage()">
                <span class="menu-icon"
                  ><svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <polygon
                      points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
                    ></polygon></svg
                ></span>
                <span class="menu-text">Collect</span>
                <span class="menu-arrow">â€º</span>
              </div>
              <div class="menu-item" onclick="openBackgroundActivityPage()">
                <span class="menu-icon"
                  ><svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline></svg
                ></span>
                <span class="menu-text">Background activity</span>
                <span class="menu-arrow" style="color: #f48fb1">â€º</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat App Bottom Tab Bar -->
        <div class="chat-tab-bar">
          <div class="chat-tab active" onclick="switchChatTab('messages')">
            <span class="tab-icon"
              ><svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                ></path></svg
            ></span>
            <span class="tab-badge" id="messagesBadge" style="display: none"
              >0</span
            >
            <span class="tab-label">Message</span>
          </div>
          <div class="chat-tab" onclick="switchChatTab('moments')">
            <span class="tab-icon"
              ><svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                <line x1="15" y1="9" x2="15.01" y2="9"></line></svg
            ></span>
            <span class="tab-badge" id="momentsBadge" style="display: none"
              >0</span
            >
            <span class="tab-label">Moment</span>
          </div>
          <div class="chat-tab" onclick="switchChatTab('todo')">
            <span class="tab-icon"
              ><svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M9 11l3 3L22 4"></path>
                <path
                  d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"
                ></path></svg
            ></span>
            <span class="tab-label">To Do</span>
          </div>
          <div class="chat-tab" onclick="switchChatTab('profile')">
            <span class="tab-icon"
              ><svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle></svg
            ></span>
            <span class="tab-label">Me</span>
          </div>
        </div>
      </div>

      <!-- é¢„è®¾Appé¡µé¢ -->
      <div id="presetPage" class="page preset-page">
        <div class="preset-header">
          <button class="preset-back-btn" onclick="closePage('presetPage')">
            â†
          </button>
          <span
            class="preset-title"
            onclick="handlePresetTitleClick(event)"
            data-click-count="0"
            ><svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="vertical-align: middle; margin-right: 4px"
            >
              <path d="M12 20h9"></path>
              <path
                d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
              ></path></svg
            >é¢„è®¾ç®¡ç†</span
          >
          <div style="display: flex; gap: 8px">
            <button
              class="preset-header-btn"
              onclick="openPresetImportModal()"
              style="background: linear-gradient(135deg, #81d4fa, #4fc3f7)"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
            </button>
            <button class="preset-header-btn" onclick="openPresetModal()">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
          </div>
        </div>

        <div class="preset-content">
          <div class="preset-tabs">
            <button class="preset-tab active" onclick="switchPresetTab('all')">
              å…¨éƒ¨
            </button>
            <button class="preset-tab" onclick="switchPresetTab('character')">
              è§’è‰²
            </button>
            <button class="preset-tab" onclick="switchPresetTab('style')">
              æ–‡é£
            </button>
            <button class="preset-tab" onclick="switchPresetTab('scene')">
              åœºæ™¯
            </button>
          </div>

          <div class="preset-list" id="presetList">
            <!-- é¢„è®¾åˆ—è¡¨å°†é€šè¿‡JSæ¸²æŸ“ -->
          </div>
        </div>

        <!-- æ‰¹é‡æ“ä½œæµ®åŠ¨æ  -->
        <div class="preset-batch-bar" id="presetBatchBar">
          <button class="preset-batch-btn cancel" onclick="cancelPresetBatch()">
            å–æ¶ˆ
          </button>
          <button
            class="preset-batch-btn delete"
            onclick="deleteSelectedPresets()"
          >
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="vertical-align: middle; margin-right: 2px"
            >
              <polyline points="3 6 5 6 21 6"></polyline>
              <path
                d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
              ></path>
            </svg>
            åˆ é™¤æ‰€é€‰
          </button>
        </div>
      </div>

      <!-- é¢„è®¾ç¼–è¾‘å¼¹çª— -->
      <div class="preset-modal" id="stylePresetModal">
        <div class="preset-modal-content">
          <div class="preset-modal-header">
            <span class="preset-modal-title" id="stylePresetModalTitle"
              >åˆ›å»ºé¢„è®¾</span
            >
            <button class="preset-modal-close" onclick="closePresetModal()">
              âœ•
            </button>
          </div>
          <div class="preset-modal-body">
            <div class="preset-form-group">
              <label class="preset-form-label">é¢„è®¾åç§°</label>
              <input
                type="text"
                class="preset-form-input"
                id="stylePresetName"
                placeholder="ç»™é¢„è®¾èµ·ä¸ªåå­—..."
              />
            </div>

            <div class="preset-form-group">
              <label class="preset-form-label">åˆ†ç±»</label>
              <select class="preset-form-input" id="stylePresetCategory">
                <option value="character">è§’è‰²é¢„è®¾</option>
                <option value="style">æ–‡é£é¢„è®¾</option>
                <option value="scene">åœºæ™¯é¢„è®¾</option>
              </select>
            </div>

            <div class="preset-form-group">
              <label class="preset-form-label">å›¾æ ‡</label>
              <input
                type="text"
                class="preset-form-input"
                id="stylePresetIcon"
                placeholder="è¾“å…¥ä¸€ä¸ªç¬¦å·ï¼Œå¦‚ â˜…"
              />
            </div>

            <div class="preset-form-group">
              <label class="preset-form-label"
                >æè¿°
                <span class="preset-form-hint">(ç®€çŸ­è¯´æ˜é¢„è®¾ç”¨é€”)</span></label
              >
              <input
                type="text"
                class="preset-form-input"
                id="stylePresetDesc"
                placeholder="ä¾‹å¦‚ï¼šæ¸©æŸ”å¤§å§å§æ–‡é£"
              />
            </div>

            <div class="preset-form-group">
              <label class="preset-form-label">
                é¢„è®¾æ¡ç›®
                <span class="preset-form-hint">(å¯æ·»åŠ å¤šä¸ªæ¡ç›®ï¼Œåˆ†åˆ«å¼€å…³)</span>
              </label>
              <div class="preset-entries-list" id="presetEntriesList">
                <!-- æ¡ç›®ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
              </div>
              <button class="preset-add-entry-btn" onclick="addPresetEntry()">
                + æ·»åŠ æ¡ç›®
              </button>
            </div>
          </div>
          <div class="preset-modal-footer">
            <button
              class="preset-modal-btn cancel"
              onclick="closePresetModal()"
            >
              å–æ¶ˆ
            </button>
            <button class="preset-modal-btn save" onclick="savePreset()">
              ä¿å­˜
            </button>
          </div>
        </div>
      </div>

      <!-- é¢„è®¾å¯¼å…¥å¼¹çª— -->
      <div class="preset-import-modal" id="presetImportModal">
        <div class="preset-import-content">
          <div class="preset-import-title">å¯¼å…¥é¢„è®¾</div>
          <div class="preset-import-options">
            <div class="preset-import-option" onclick="importPresetFromFile()">
              <div class="preset-import-option-icon">ğŸ“</div>
              <div class="preset-import-option-text">
                <div class="preset-import-option-title">ä»æ–‡ä»¶å¯¼å…¥</div>
                <div class="preset-import-option-desc">
                  æ”¯æŒJSONæ ¼å¼çš„é¢„è®¾æ–‡ä»¶
                </div>
              </div>
            </div>
            <div
              class="preset-import-option"
              onclick="importPresetFromClipboard()"
            >
              <div class="preset-import-option-icon">â‰¡</div>
              <div class="preset-import-option-text">
                <div class="preset-import-option-title">ä»å‰ªè´´æ¿å¯¼å…¥</div>
                <div class="preset-import-option-desc">
                  ç²˜è´´Silly Taverné¢„è®¾JSON
                </div>
              </div>
            </div>
          </div>
          <button
            class="preset-import-cancel"
            onclick="closePresetImportModal()"
          >
            å–æ¶ˆ
          </button>
        </div>
      </div>

      <!-- æ¿€æ´»ç å¼¹çª— -->
      <div class="activation-modal" id="activationModal">
        <div class="activation-modal-content">
          <div class="activation-modal-header">
            <span class="activation-modal-title">ğŸ” å¯¼å…¥åŠŸèƒ½æ¿€æ´»</span>
            <button
              class="activation-modal-close"
              onclick="closeActivationModal()"
            >
              âœ•
            </button>
          </div>
          <div class="activation-modal-body">
            <div class="activation-device-section">
              <div class="activation-label">æ‚¨çš„è®¾å¤‡ç </div>
              <div class="activation-device-code" id="activationDeviceCode">
                åŠ è½½ä¸­...
              </div>
              <button class="activation-copy-btn" onclick="copyDeviceCode()">
                ğŸ“‹ å¤åˆ¶è®¾å¤‡ç 
              </button>
              <div class="activation-hint">
                è¯·å°†æ­¤è®¾å¤‡ç å‘é€ç»™ç®¡ç†å‘˜è·å–æ¿€æ´»ç 
              </div>
            </div>
            <div class="activation-input-section">
              <div class="activation-label">è¾“å…¥æ¿€æ´»ç </div>
              <input
                type="text"
                class="activation-input"
                id="activationCodeInput"
                placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜æä¾›çš„æ¿€æ´»ç ..."
                maxlength="32"
              />
            </div>
          </div>
          <div class="activation-modal-footer">
            <button
              class="activation-btn cancel"
              onclick="closeActivationModal()"
            >
              å–æ¶ˆ
            </button>
            <button
              class="activation-btn confirm"
              onclick="verifyActivationCode()"
            >
              æ¿€æ´»
            </button>
          </div>
        </div>
      </div>

      <!-- ç®¡ç†å‘˜æ¿€æ´»ç ç”Ÿæˆå¼¹çª— -->
      <div class="activation-modal" id="adminActivationModal">
        <div class="activation-modal-content">
          <div class="activation-modal-header">
            <span class="activation-modal-title">ğŸ”‘ ç®¡ç†å‘˜ - ç”Ÿæˆæ¿€æ´»ç </span>
            <button
              class="activation-modal-close"
              onclick="closeAdminActivationModal()"
            >
              âœ•
            </button>
          </div>
          <div class="activation-modal-body">
            <div class="activation-input-section">
              <div class="activation-label">ç®¡ç†å‘˜å¯†é’¥</div>
              <input
                type="password"
                class="activation-input"
                id="adminSecretKey"
                placeholder="è¾“å…¥æ‚¨è®¾ç½®çš„ç®¡ç†å‘˜å¯†é’¥..."
              />
              <div class="activation-hint">é¦–æ¬¡ä½¿ç”¨ä¼šè‡ªåŠ¨è®¾ç½®ä¸ºç®¡ç†å‘˜å¯†é’¥</div>
            </div>
            <div class="activation-input-section">
              <div class="activation-label">ç”¨æˆ·è®¾å¤‡ç </div>
              <input
                type="text"
                class="activation-input"
                id="userDeviceCodeInput"
                placeholder="ç²˜è´´ç”¨æˆ·å‘é€çš„è®¾å¤‡ç ..."
                maxlength="16"
              />
            </div>
            <div
              class="activation-result-section"
              id="generatedCodeSection"
              style="display: none"
            >
              <div class="activation-label">ç”Ÿæˆçš„æ¿€æ´»ç </div>
              <div
                class="activation-generated-code"
                id="generatedActivationCode"
              ></div>
              <button class="activation-copy-btn" onclick="copyGeneratedCode()">
                ğŸ“‹ å¤åˆ¶æ¿€æ´»ç 
              </button>
            </div>
          </div>
          <div class="activation-modal-footer">
            <button
              class="activation-btn cancel"
              onclick="closeAdminActivationModal()"
            >
              å–æ¶ˆ
            </button>
            <button
              class="activation-btn confirm"
              onclick="generateActivationCode()"
            >
              ç”Ÿæˆæ¿€æ´»ç 
            </button>
          </div>
        </div>
      </div>

      <input
        type="file"
        id="presetFileInput"
        accept=".json"
        style="display: none"
        onchange="handlePresetFileImport(event)"
      />

      <div id="worldbookPage" class="page worldbook-page">
        <!-- ä¸–ç•Œä¹¦å¤´éƒ¨ -->
        <div class="worldbook-header">
          <div class="worldbook-header-left">
            <button class="back-btn" onclick="closePage('worldbookPage')">
              â†
            </button>
            <div class="worldbook-title">â‰¡ ä¸–ç•Œä¹¦</div>
          </div>
          <div class="worldbook-header-actions">
            <button
              class="worldbook-header-btn"
              onclick="openWorldbookGroupManager()"
              title="ç®¡ç†åˆ†ç»„"
            >
              ğŸ“
            </button>
            <button
              class="worldbook-header-btn"
              onclick="toggleWorldbookBatchMode()"
              title="æ‰¹é‡æ“ä½œ"
            >
              â˜‘ï¸
            </button>
            <button
              class="worldbook-header-btn"
              onclick="openWorldbookModal()"
              title="æ–°å»ºä¸–ç•Œä¹¦"
            >
              +
            </button>
          </div>
        </div>

        <div class="worldbook-content">
          <!-- åˆ†ç»„æ ‡ç­¾æ  -->
          <div class="worldbook-tabs" id="worldbookTabs">
            <div
              class="worldbook-tab active"
              data-group="all"
              onclick="filterWorldbookByGroup('all')"
            >
              å…¨éƒ¨ <span class="worldbook-tab-count" id="wbCountAll">0</span>
            </div>
          </div>

          <!-- æ‰¹é‡æ“ä½œæ  -->
          <div class="worldbook-batch-bar" id="worldbookBatchBar">
            <div class="worldbook-batch-info">
              å·²é€‰æ‹© <span id="worldbookSelectedCount">0</span> é¡¹
            </div>
            <div class="worldbook-batch-actions">
              <button
                class="worldbook-batch-btn cancel"
                onclick="cancelWorldbookBatch()"
              >
                å–æ¶ˆ
              </button>
              <button
                class="worldbook-batch-btn move"
                onclick="openWorldbookMoveModal()"
              >
                ğŸ“ ç§»åŠ¨
              </button>
              <button
                class="worldbook-batch-btn delete"
                onclick="deleteSelectedWorldbooks()"
              >
                âœ• åˆ é™¤
              </button>
            </div>
          </div>

          <!-- ä¸–ç•Œä¹¦åˆ—è¡¨ -->
          <div class="worldbook-list" id="worldbookList">
            <!-- åŠ¨æ€æ¸²æŸ“ -->
          </div>

          <!-- ç©ºçŠ¶æ€ -->
          <div
            class="worldbook-empty"
            id="worldbookEmpty"
            style="display: none"
          >
            <div class="worldbook-empty-icon">
              <svg
                width="48"
                height="48"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path
                  d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"
                ></path>
              </svg>
            </div>
            <div class="worldbook-empty-title">è¿˜æ²¡æœ‰ä¸–ç•Œä¹¦</div>
            <div class="worldbook-empty-text">
              åˆ›å»ºä¸–ç•Œä¹¦ï¼Œè®©AIè§’è‰²æ‹¥æœ‰æ›´ä¸°å¯Œçš„èƒŒæ™¯è®¾å®š
            </div>
            <button class="worldbook-empty-btn" onclick="openWorldbookModal()">
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                style="vertical-align: middle; margin-right: 2px"
              >
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              åˆ›å»ºç¬¬ä¸€æœ¬ä¸–ç•Œä¹¦
            </button>
          </div>
        </div>
      </div>

      <!-- ä¸–ç•Œä¹¦ç¼–è¾‘å¼¹çª— -->
      <div
        class="worldbook-modal"
        id="worldbookModal"
        onclick="if(event.target===this)closeWorldbookModal()"
      >
        <div class="worldbook-modal-content">
          <div class="worldbook-modal-header">
            <div class="worldbook-modal-title" id="worldbookModalTitle">
              æ–°å»ºä¸–ç•Œä¹¦
            </div>
            <button
              class="worldbook-modal-close"
              onclick="closeWorldbookModal()"
            >
              âœ•
            </button>
          </div>
          <div class="worldbook-modal-body">
            <div class="worldbook-form-group">
              <label class="worldbook-form-label"
                >ä¸–ç•Œä¹¦åç§° <span style="color: #f48fb1">*</span></label
              >
              <input
                type="text"
                class="worldbook-form-input"
                id="worldbookNameInput"
                placeholder="ä¾‹å¦‚ï¼šç°ä»£éƒ½å¸‚ä¸–ç•Œè§‚"
              />
            </div>
            <div class="worldbook-form-group">
              <label class="worldbook-form-label">åˆ†ç»„</label>
              <select
                class="worldbook-form-input worldbook-form-select"
                id="worldbookGroupSelect"
              >
                <option value="">æœªåˆ†ç»„</option>
              </select>
            </div>
            <div class="worldbook-form-group">
              <label class="worldbook-form-label"
                >æè¿° <span class="worldbook-form-hint">(é€‰å¡«)</span></label
              >
              <textarea
                class="worldbook-form-input worldbook-form-textarea"
                id="worldbookDescInput"
                placeholder="ç®€è¦æè¿°è¿™æœ¬ä¸–ç•Œä¹¦çš„å†…å®¹..."
              ></textarea>
            </div>
            <div class="worldbook-form-group">
              <label class="worldbook-form-label">æ¡ç›®åˆ—è¡¨</label>
              <div class="worldbook-entries" id="worldbookEntries">
                <!-- åŠ¨æ€æ¸²æŸ“æ¡ç›® -->
              </div>
              <button
                class="worldbook-add-entry-btn"
                onclick="addWorldbookEntry()"
              >
                + æ·»åŠ æ–°æ¡ç›®
              </button>
            </div>
          </div>
          <div class="worldbook-modal-footer">
            <button
              class="worldbook-modal-btn cancel"
              onclick="closeWorldbookModal()"
            >
              å–æ¶ˆ
            </button>
            <button class="worldbook-modal-btn save" onclick="saveWorldbook()">
              ä¿å­˜
            </button>
          </div>
        </div>
      </div>

      <!-- æ¡ç›®ç¼–è¾‘å¼¹çª— -->
      <div
        class="worldbook-modal"
        id="worldbookEntryModal"
        onclick="if(event.target===this)closeWorldbookEntryModal()"
      >
        <div class="worldbook-modal-content">
          <div class="worldbook-modal-header">
            <div class="worldbook-modal-title" id="worldbookEntryModalTitle">
              ç¼–è¾‘æ¡ç›®
            </div>
            <button
              class="worldbook-modal-close"
              onclick="closeWorldbookEntryModal()"
            >
              âœ•
            </button>
          </div>
          <div class="worldbook-modal-body">
            <div class="worldbook-form-group">
              <label class="worldbook-form-label"
                >å¤‡æ³¨
                <span class="worldbook-form-hint">(é€‰å¡«ï¼Œä¾¿äºç®¡ç†)</span></label
              >
              <input
                type="text"
                class="worldbook-form-input"
                id="entryCommentInput"
                placeholder="ä¾‹å¦‚ï¼šå…³äºä¸»è§’çš„ç«¥å¹´"
              />
            </div>
            <div class="worldbook-form-group">
              <label class="worldbook-form-label"
                >å…³é”®è¯
                <span class="worldbook-form-hint">(ç”¨è‹±æ–‡é€—å·åˆ†éš”)</span></label
              >
              <input
                type="text"
                class="worldbook-form-input"
                id="entryKeywordsInput"
                placeholder="ä¾‹å¦‚ï¼šç«¥å¹´, å°æ—¶å€™, è¿‡å»"
              />
            </div>
            <div class="worldbook-form-group">
              <label class="worldbook-form-label"
                >å†…å®¹ <span style="color: #f48fb1">*</span></label
              >
              <textarea
                class="worldbook-form-input worldbook-form-textarea"
                id="entryContentInput"
                placeholder="å½“èŠå¤©ä¸­å‡ºç°å…³é”®è¯æ—¶ï¼Œè¿™æ®µå†…å®¹ä¼šè¢«æ³¨å…¥åˆ°AIçš„è®°å¿†ä¸­..."
                style="min-height: 150px"
              ></textarea>
            </div>
          </div>
          <div class="worldbook-modal-footer">
            <button
              class="worldbook-modal-btn cancel"
              onclick="closeWorldbookEntryModal()"
            >
              å–æ¶ˆ
            </button>
            <button
              class="worldbook-modal-btn save"
              onclick="saveWorldbookEntry()"
            >
              ä¿å­˜
            </button>
          </div>
        </div>
      </div>

      <!-- åˆ†ç»„ç®¡ç†å¼¹çª— -->
      <div
        class="worldbook-group-modal"
        id="worldbookGroupModal"
        onclick="if(event.target===this)closeWorldbookGroupManager()"
      >
        <div class="worldbook-group-modal-content">
          <div class="worldbook-group-title">ğŸ“ ç®¡ç†åˆ†ç»„</div>
          <div class="worldbook-group-list" id="worldbookGroupList">
            <!-- åŠ¨æ€æ¸²æŸ“ -->
          </div>
          <div class="worldbook-group-add-row">
            <input
              type="text"
              class="worldbook-group-add-input"
              id="worldbookNewGroupInput"
              placeholder="è¾“å…¥æ–°åˆ†ç»„åç§°..."
            />
            <button
              class="worldbook-group-add-btn"
              onclick="addWorldbookGroup()"
            >
              æ·»åŠ 
            </button>
          </div>
          <button
            class="worldbook-group-close"
            onclick="closeWorldbookGroupManager()"
          >
            å…³é—­
          </button>
        </div>
      </div>

      <!-- ç§»åŠ¨åˆ†ç»„å¼¹çª— -->
      <div
        class="worldbook-move-modal"
        id="worldbookMoveModal"
        onclick="if(event.target===this)closeWorldbookMoveModal()"
      >
        <div class="worldbook-move-modal-content">
          <div class="worldbook-move-title">ğŸ“ ç§»åŠ¨åˆ°åˆ†ç»„</div>
          <div class="worldbook-move-list" id="worldbookMoveList">
            <!-- åŠ¨æ€æ¸²æŸ“ -->
          </div>
          <button
            class="worldbook-move-cancel"
            onclick="closeWorldbookMoveModal()"
          >
            å–æ¶ˆ
          </button>
        </div>
      </div>

      <div id="forumPage" class="page">
        <div class="page-header">
          <button class="back-btn" onclick="closePage('forumPage')">â†</button>
          <h1 class="page-title">è®ºå›</h1>
          <div class="forum-header-right">
            <button class="forum-header-btn" onclick="openForumSettings()">
              âš™ï¸
            </button>
          </div>
        </div>
        <div class="page-content" id="forumPageContent" style="padding: 0">
          <!-- ç”±JSåŠ¨æ€æ¸²æŸ“ -->
        </div>
      </div>

      <div id="companionPage" class="page">
        <div class="page-header companion-header">
          <button class="back-btn" onclick="closeCompanionPage()">â†</button>
          <h1 class="page-title">é™ªä¼´</h1>
          <span style="width: 40px"></span>
        </div>

        <!-- Tabåˆ‡æ¢ -->
        <div class="companion-tabs">
          <div
            class="companion-tab active"
            onclick="switchCompanionTab('setup')"
            id="companionTabSetup"
          >
            å¼€å§‹é™ªä¼´
          </div>
          <div
            class="companion-tab"
            onclick="switchCompanionTab('history')"
            id="companionTabHistory"
          >
            é™ªä¼´è®°å½•
          </div>
        </div>

        <!-- æœªå¼€å§‹é™ªä¼´æ—¶çš„è®¾ç½®ç•Œé¢ -->
        <div class="companion-setup" id="companionSetup">
          <!-- æ•°æ®ç»Ÿè®¡å¡ç‰‡ -->
          <div class="companion-stats-card" id="companionStatsCard">
            <div class="companion-stat-item">
              <div class="companion-stat-value" id="companionTotalTimes">0</div>
              <div class="companion-stat-label">é™ªä¼´æ¬¡æ•°</div>
            </div>
            <div class="companion-stat-divider"></div>
            <div class="companion-stat-item">
              <div class="companion-stat-value" id="companionTotalHours">0</div>
              <div class="companion-stat-label">æ€»æ—¶é•¿(å°æ—¶)</div>
            </div>
            <div class="companion-stat-divider"></div>
            <div class="companion-stat-item">
              <div class="companion-stat-value" id="companionStreak">0</div>
              <div class="companion-stat-label">è¿ç»­å¤©æ•°</div>
            </div>
          </div>

          <!-- é€‰æ‹©AIè§’è‰² -->
          <div class="companion-section">
            <div class="companion-section-title">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
              é€‰æ‹©é™ªä¼´è§’è‰²
            </div>
            <div class="companion-char-select" id="companionCharSelect">
              <!-- åŠ¨æ€æ¸²æŸ“è§’è‰²åˆ—è¡¨ -->
            </div>
          </div>

          <!-- é™ªä¼´é¡¹ç›® -->
          <div class="companion-section">
            <div class="companion-section-title">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                ></path>
                <path
                  d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                ></path>
              </svg>
              é™ªä¼´é¡¹ç›®
            </div>
            <input
              type="text"
              class="companion-input"
              id="companionTaskInput"
              placeholder="è¾“å…¥ä½ æƒ³åšçš„äº‹æƒ…ï¼Œä¾‹å¦‚ï¼šå­¦ä¹ è‹±è¯­ã€å†™è®ºæ–‡..."
            />

            <!-- ä»å¾…åŠäº‹é¡¹é€‰æ‹© -->
            <div class="companion-todo-select" id="companionTodoSelect">
              <div class="companion-todo-label">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <polyline points="9 11 12 14 22 4"></polyline>
                  <path
                    d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"
                  ></path>
                </svg>
                æˆ–ä»å¾…åŠäº‹é¡¹ä¸­é€‰æ‹©
              </div>
              <div class="companion-todo-list" id="companionTodoList">
                <!-- åŠ¨æ€æ¸²æŸ“å¾…åŠäº‹é¡¹ -->
              </div>
            </div>
          </div>

          <!-- é™ªä¼´æ—¶é•¿ -->
          <div class="companion-section">
            <div class="companion-section-title">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              é™ªä¼´æ—¶é•¿
            </div>
            <div class="companion-duration-row">
              <input
                type="number"
                class="companion-duration-input"
                id="companionDurationInput"
                placeholder="45"
                value="45"
                min="1"
                max="480"
              />
              <span class="companion-duration-unit">åˆ†é’Ÿ</span>
            </div>
            <div class="companion-duration-hint">
              å¯è¾“å…¥1-480åˆ†é’Ÿï¼ˆæœ€é•¿8å°æ—¶ï¼‰
            </div>
            <div class="companion-duration-presets">
              <span
                class="companion-duration-preset"
                onclick="setCompanionDuration(15)"
                >15åˆ†é’Ÿ</span
              >
              <span
                class="companion-duration-preset"
                onclick="setCompanionDuration(25)"
                >25åˆ†é’Ÿ</span
              >
              <span
                class="companion-duration-preset active"
                onclick="setCompanionDuration(45)"
                >45åˆ†é’Ÿ</span
              >
              <span
                class="companion-duration-preset"
                onclick="setCompanionDuration(60)"
                >1å°æ—¶</span
              >
              <span
                class="companion-duration-preset"
                onclick="setCompanionDuration(90)"
                >1.5å°æ—¶</span
              >
              <span
                class="companion-duration-preset"
                onclick="setCompanionDuration(120)"
                >2å°æ—¶</span
              >
            </div>
          </div>

          <!-- é¼“åŠ±é¢‘ç‡ -->
          <div class="companion-section">
            <div class="companion-section-title">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                ></path>
              </svg>
              é¼“åŠ±é¢‘ç‡
            </div>
            <div class="companion-freq-select">
              <span class="companion-freq-tag" onclick="setEncourageFreq(3)"
                >é¢‘ç¹(3åˆ†é’Ÿ)</span
              >
              <span
                class="companion-freq-tag active"
                onclick="setEncourageFreq(5)"
                >é€‚ä¸­(5åˆ†é’Ÿ)</span
              >
              <span class="companion-freq-tag" onclick="setEncourageFreq(10)"
                >å¶å°”(10åˆ†é’Ÿ)</span
              >
              <span class="companion-freq-tag" onclick="setEncourageFreq(0)"
                >å®‰é™é™ªä¼´</span
              >
            </div>
          </div>

          <!-- è¯­éŸ³é¼“åŠ± -->
          <div class="companion-section">
            <div class="companion-toggle-row">
              <div class="companion-toggle-info">
                <div class="companion-section-title" style="margin-bottom: 4px">
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <polygon
                      points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"
                    ></polygon>
                    <path
                      d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"
                    ></path>
                  </svg>
                  è¯­éŸ³é¼“åŠ±
                </div>
                <div class="companion-toggle-desc">
                  å¼€å¯åAIä¼šç”¨è¯­éŸ³ç»™ä½ åŠ æ²¹
                </div>
              </div>
              <div
                class="companion-toggle"
                id="companionVoiceToggle"
                onclick="toggleCompanionVoice()"
              >
                <div class="companion-toggle-handle"></div>
              </div>
            </div>
          </div>

          <!-- èƒŒæ™¯è®¾ç½® -->
          <div class="companion-section">
            <div class="companion-section-title">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
              é™ªä¼´èƒŒæ™¯
            </div>
            <div class="companion-bg-list" id="companionBgList">
              <!-- å·²æ·»åŠ çš„èƒŒæ™¯é¢„è§ˆ -->
            </div>
            <div
              class="companion-bg-add"
              onclick="document.getElementById('companionBgInput').click()"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              <span>æ·»åŠ å›¾ç‰‡/è§†é¢‘</span>
            </div>
            <input
              type="file"
              id="companionBgInput"
              accept="image/*,video/*"
              multiple
              style="display: none"
              onchange="handleCompanionBgSelect(event)"
            />
            <div class="companion-bg-hint">
              æ”¯æŒå¤šå¼ å›¾ç‰‡è½®æ’­ï¼ˆæ¯10ç§’åˆ‡æ¢ï¼‰æˆ–å•ä¸ªè§†é¢‘
            </div>

            <!-- è½®æ’­é—´éš”è®¾ç½® -->
            <div
              id="companionBgIntervalSetting"
              style="display: none; margin-top: 12px"
            >
              <div style="font-size: 0.85rem; color: #666; margin-bottom: 6px">
                è½®æ’­é—´éš”ï¼ˆç§’ï¼‰
              </div>
              <input
                type="number"
                class="companion-input"
                id="companionBgInterval"
                value="10"
                min="3"
                max="60"
                style="width: 100px"
              />
            </div>
          </div>

          <!-- å¼€å§‹æŒ‰é’® -->
          <button class="companion-start-btn" onclick="startCompanion()">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polygon points="5 3 19 12 5 21 5 3"></polygon>
            </svg>
            å¼€å§‹é™ªä¼´
          </button>
        </div>

        <!-- é™ªä¼´è®°å½•é¡µé¢ -->
        <div
          class="companion-history"
          id="companionHistory"
          style="display: none"
        >
          <!-- æœˆåº¦æ—¥å† -->
          <div class="companion-calendar-section">
            <div class="companion-calendar-header">
              <button
                class="companion-calendar-nav"
                onclick="changeCompanionMonth(-1)"
              >
                â€¹
              </button>
              <span id="companionCalendarTitle">2025å¹´1æœˆ</span>
              <button
                class="companion-calendar-nav"
                onclick="changeCompanionMonth(1)"
              >
                â€º
              </button>
            </div>
            <div class="companion-calendar-weekdays">
              <span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span
              ><span>å››</span><span>äº”</span><span>å…­</span>
            </div>
            <div class="companion-calendar-days" id="companionCalendarDays">
              <!-- åŠ¨æ€æ¸²æŸ“æ—¥æœŸ -->
            </div>
          </div>

          <!-- è®°å½•åˆ—è¡¨ -->
          <div class="companion-history-list" id="companionHistoryList">
            <!-- åŠ¨æ€æ¸²æŸ“è®°å½• -->
          </div>

          <!-- ç©ºçŠ¶æ€ -->
          <div
            class="companion-history-empty"
            id="companionHistoryEmpty"
            style="display: none"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
              ></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <p>è¿˜æ²¡æœ‰é™ªä¼´è®°å½•</p>
            <p style="font-size: 12px; color: #ccc">å¼€å§‹ä½ çš„ç¬¬ä¸€æ¬¡é™ªä¼´å§ï¼</p>
          </div>
        </div>

        <!-- é™ªä¼´è¿›è¡Œä¸­ç•Œé¢ï¼ˆå…¨å±æ²‰æµ¸å¼ï¼‰ -->
        <div
          class="companion-active"
          id="companionActive"
          style="display: none"
        >
          <!-- å…¨å±èƒŒæ™¯ï¼ˆæ”¯æŒè½®æ’­ï¼‰ -->
          <div class="companion-fullscreen-bg" id="companionFullscreenBg">
            <div class="companion-bg-slide active" id="companionBgSlide1"></div>
            <div class="companion-bg-slide" id="companionBgSlide2"></div>
            <video
              id="companionBgVideo"
              style="display: none"
              muted
              loop
              autoplay
              playsinline
            ></video>
            <div class="companion-bg-overlay"></div>
          </div>

          <!-- AIè§’è‰²æ˜¾ç¤º -->
          <div class="companion-char-display">
            <div class="companion-char-avatar" id="companionCharAvatar"></div>
            <div class="companion-char-name" id="companionCharName">AI</div>
          </div>

          <!-- ç¿»é¡µè®¡æ—¶å™¨ -->
          <div class="companion-timer-section">
            <div class="flip-clock" id="flipClock">
              <div class="flip-unit">
                <div class="flip-card" id="flipMin1">
                  <div class="flip-card-inner">
                    <div class="flip-card-front">0</div>
                    <div class="flip-card-back">0</div>
                  </div>
                </div>
              </div>
              <div class="flip-unit">
                <div class="flip-card" id="flipMin2">
                  <div class="flip-card-inner">
                    <div class="flip-card-front">0</div>
                    <div class="flip-card-back">0</div>
                  </div>
                </div>
              </div>
              <div class="flip-colon">:</div>
              <div class="flip-unit">
                <div class="flip-card" id="flipSec1">
                  <div class="flip-card-inner">
                    <div class="flip-card-front">0</div>
                    <div class="flip-card-back">0</div>
                  </div>
                </div>
              </div>
              <div class="flip-unit">
                <div class="flip-card" id="flipSec2">
                  <div class="flip-card-inner">
                    <div class="flip-card-front">0</div>
                    <div class="flip-card-back">0</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="companion-task-name" id="companionTaskName">
              å­¦ä¹ ä¸­...
            </div>
            <div class="companion-progress-bar">
              <div
                class="companion-progress-fill"
                id="companionProgressFill"
              ></div>
            </div>
          </div>

          <!-- AIé¼“åŠ±æ¶ˆæ¯ -->
          <div class="companion-message-area" id="companionMessageArea">
            <div class="companion-message" id="companionMessage">
              åŠ æ²¹ï¼æˆ‘ä¼šä¸€ç›´é™ªç€ä½ ~
            </div>
          </div>

          <!-- åº•éƒ¨æ“ä½œ -->
          <div class="companion-actions">
            <button
              class="companion-action-btn chat"
              onclick="openCompanionChat()"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                ></path>
              </svg>
              èŠå¤©
            </button>
            <button
              class="companion-action-btn pause"
              id="companionPauseBtn"
              onclick="toggleCompanionPause()"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="6" y="4" width="4" height="16"></rect>
                <rect x="14" y="4" width="4" height="16"></rect>
              </svg>
              æš‚åœ
            </button>
            <button
              class="companion-action-btn complete"
              onclick="completeCompanion()"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
              å®Œæˆ
            </button>
            <button class="companion-action-btn quit" onclick="quitCompanion()">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
              æ”¾å¼ƒ
            </button>
          </div>
        </div>

        <!-- èŠå¤©å¼¹çª— -->
        <div class="companion-chat-modal" id="companionChatModal">
          <div class="companion-chat-container">
            <div class="companion-chat-header">
              <span>å’Œ <span id="companionChatCharName">AI</span> èŠèŠ</span>
              <button onclick="closeCompanionChat()">Ã—</button>
            </div>
            <div class="companion-chat-messages" id="companionChatMessages">
              <!-- èŠå¤©æ¶ˆæ¯ -->
            </div>
            <div class="companion-chat-input-area">
              <input
                type="text"
                id="companionChatInput"
                placeholder="ç´¯äº†å°±å’Œæˆ‘è¯´è¯´è¯å§~"
                onkeypress="if(event.key==='Enter')sendCompanionChat()"
              />
              <button onclick="sendCompanionChat()">å‘é€</button>
            </div>
          </div>
        </div>
      </div>

      <div id="apiPage" class="page api-settings-page">
        <div class="page-header">
          <button class="back-btn" onclick="closePage('apiPage')">â†</button>
          <h1 class="page-title">APIè®¾ç½®</h1>
          <button class="page-header-add" onclick="openApiPresetModal()">
            +
          </button>
        </div>

        <div class="api-settings-content">
          <!-- API Presets List -->
          <div class="api-section">
            <div class="api-section-title">API é¢„è®¾ç®¡ç†</div>
            <div class="api-preset-list" id="apiPresetList">
              <!-- Presets will be rendered here -->
              <div class="empty-state" id="emptyPresets">
                <div class="empty-icon">
                  <svg
                    width="48"
                    height="48"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                    <line x1="12" y1="2" x2="12" y2="12"></line>
                  </svg>
                </div>
                <div class="empty-text">è¿˜æ²¡æœ‰APIé¢„è®¾</div>
                <div class="empty-hint">ç‚¹å‡»å³ä¸Šè§’ + åˆ›å»ºé¢„è®¾</div>
              </div>
            </div>
          </div>

          <!-- Current Active Config -->
          <div
            class="api-section"
            id="activeConfigSection"
            style="display: none"
          >
            <div class="api-section-title">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                style="vertical-align: middle; margin-right: 4px"
              >
                <polyline points="20 6 9 17 4 12"></polyline></svg
              >å½“å‰ä½¿ç”¨
            </div>
            <div class="active-config-card">
              <div class="active-config-row">
                <span class="active-label">é¢„è®¾åç§°</span>
                <span class="active-value" id="activePresetName">-</span>
              </div>
              <div class="active-config-row">
                <span class="active-label">æ¨¡å‹</span>
                <span class="active-value" id="activeModelName">-</span>
              </div>
              <div class="active-config-row">
                <span class="active-label">çŠ¶æ€</span>
                <span class="active-status">å·²è¿æ¥</span>
              </div>
            </div>
          </div>
          <div class="api-section">
            <div class="api-section-title">ğŸ™ï¸ è¯­éŸ³è®¾ç½® (MiniMax)</div>
            <div
              class="active-config-card"
              style="background: #fff; padding: 16px"
            >
              <div class="form-group">
                <label class="form-label">Group ID</label>
                <input
                  type="text"
                  class="form-input"
                  id="voiceGroupId"
                  placeholder="å¡«å†™ MiniMax Group ID"
                />
              </div>

              <div class="form-group">
                <label class="form-label">API Key</label>
                <input
                  type="password"
                  class="form-input"
                  id="voiceApiKey"
                  placeholder="å¡«å†™ MiniMax API Key"
                />
              </div>
              <div class="form-group">
                <label class="form-label">API çº¿è·¯</label>
                <div class="radio-group">
                  <div
                    class="radio-option active"
                    onclick="switchVoiceUrl('cn')"
                    id="voiceUrlCN"
                  >
                    å›½å†…ç‰ˆ
                  </div>
                  <div
                    class="radio-option"
                    onclick="switchVoiceUrl('intl')"
                    id="voiceUrlIntl"
                  >
                    æµ·å¤–ç‰ˆ
                  </div>
                </div>
                <div class="form-hint" style="margin-top: 6px">
                  å›½å†…ç‰ˆ: api.minimax.chat | æµ·å¤–ç‰ˆ: api.minimaxi.com
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">è¯­éŸ³æ¨¡å‹</label>
                <div class="form-select-wrapper">
                  <select class="form-select" id="voiceModelSelect">
                    <option value="speech-2.6-hd">
                      speech-2.6-hd (æœ€æ–°Â·è¶…æ¸…)
                    </option>
                    <option value="speech-2.6-turbo">
                      speech-2.6-turbo (æœ€æ–°Â·æé€Ÿ)
                    </option>

                    <option disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>

                    <option value="speech-02-hd">speech-02-hd (é«˜æ¸…)</option>
                    <option value="speech-02-turbo">
                      speech-02-turbo (å¿«é€Ÿ)
                    </option>
                    <option value="speech-01-turbo">
                      speech-01-turbo (è€æ—§)
                    </option>
                    <option value="speech-01-hd">speech-01-hd (è€æ—§)</option>
                  </select>
                </div>
              </div>

              <button
                class="action-btn"
                onclick="saveVoiceConfig()"
                style="width: 100%; margin-top: 10px"
              >
                ğŸ’¾ ä¿å­˜è¯­éŸ³é…ç½®
              </button>
            </div>
          </div>
          <!-- Tips -->
          <div class="api-tips">
            <div class="api-tips-title">ğŸ’¡ æç¤º</div>
            <div class="api-tips-content">
              æ”¯æŒ OpenAI å…¼å®¹æ ¼å¼çš„ APIã€‚å¡«å†™åä»£åœ°å€æ—¶æ— éœ€æ·»åŠ  /v1 åç¼€ã€‚
            </div>
          </div>
        </div>
      </div>

      <!-- API Preset Modal -->
      <div class="api-modal" id="apiPresetModal">
        <div class="api-modal-content">
          <div class="api-modal-header">
            <h2 class="api-modal-title" id="apiModalTitle">åˆ›å»º API é¢„è®¾</h2>
            <button class="api-modal-close" onclick="closeApiPresetModal()">
              âœ•
            </button>
          </div>
          <div class="api-modal-body">
            <div class="api-field">
              <label class="api-field-label">é¢„è®¾åç§°</label>
              <input
                type="text"
                class="api-field-input"
                id="presetNameInput"
                placeholder="ä¾‹å¦‚: OpenAI, Claude, è‡ªç”¨API"
              />
            </div>

            <div class="api-field">
              <label class="api-field-label">åä»£åœ°å€</label>
              <input
                type="text"
                class="api-field-input"
                id="presetUrlInput"
                placeholder="https://api.example.com"
              />
            </div>

            <div class="api-field">
              <label class="api-field-label">API Key</label>
              <div class="api-field-key">
                <input
                  type="password"
                  class="api-field-input"
                  id="presetKeyInput"
                  placeholder="sk-xxxxxxxxxxxxxxxx"
                />
                <button
                  class="key-toggle-btn"
                  onclick="togglePresetKeyVisibility()"
                >
                  â—‹
                </button>
              </div>
            </div>

            <div class="api-field">
              <label class="api-field-label">æ¨¡å‹</label>
              <div class="model-select-row">
                <input
                  type="text"
                  class="api-field-input model-input"
                  id="presetModelInput"
                  placeholder="è¾“å…¥æˆ–æ‹‰å–æ¨¡å‹åç§°"
                />
                <button class="model-fetch-btn" onclick="fetchPresetModels()">
                  æ‹‰å–
                </button>
              </div>
              <div class="model-hint">
                å¯ç›´æ¥è¾“å…¥æ¨¡å‹åç§°ï¼Œå¦‚ gpt-4oã€claude-3-5-sonnet ç­‰
              </div>

              <div class="model-dropdown" id="modelDropdown"></div>
            </div>

            <div
              class="api-field"
              style="
                margin-top: 20px;
                padding-top: 20px;
                border-top: 1px dashed #eee;
              "
            >
              <label class="api-field-label">å‚æ•°å¾®è°ƒ (Advanced)</label>

              <div class="slider-row">
                <div style="width: 70px; font-size: 0.85rem; color: #666">
                  æ¸©åº¦<br /><span style="font-size: 0.7rem; color: #999"
                    >(éšæœºæ€§)</span
                  >
                </div>
                <input
                  type="range"
                  id="presetTempInput"
                  min="0"
                  max="2"
                  step="0.1"
                  value="1.0"
                  oninput="document.getElementById('valTemp').textContent = this.value"
                />
                <span class="slider-value" id="valTemp">1.0</span>
              </div>

              <div class="slider-row">
                <div style="width: 70px; font-size: 0.85rem; color: #666">
                  é¢‘ç‡æƒ©ç½š<br /><span style="font-size: 0.7rem; color: #999"
                    >(å»é‡)</span
                  >
                </div>
                <input
                  type="range"
                  id="presetFreqInput"
                  min="-2"
                  max="2"
                  step="0.1"
                  value="0"
                  oninput="document.getElementById('valFreq').textContent = this.value"
                />
                <span class="slider-value" id="valFreq">0.0</span>
              </div>

              <div class="slider-row">
                <div style="width: 70px; font-size: 0.85rem; color: #666">
                  å­˜åœ¨æƒ©ç½š<br /><span style="font-size: 0.7rem; color: #999"
                    >(åˆ›æ–°)</span
                  >
                </div>
                <input
                  type="range"
                  id="presetPresInput"
                  min="-2"
                  max="2"
                  step="0.1"
                  value="0"
                  oninput="document.getElementById('valPres').textContent = this.value"
                />
                <span class="slider-value" id="valPres">0.0</span>
              </div>
            </div>
          </div>

          <div class="api-modal-footer">
            <button
              class="api-modal-btn btn-delete"
              id="presetDeleteBtn"
              onclick="deleteApiPreset()"
              style="display: none"
            >
              åˆ é™¤
            </button>
            <div class="api-modal-btn-group">
              <button
                class="api-modal-btn btn-cancel"
                onclick="closeApiPresetModal()"
              >
                å–æ¶ˆ
              </button>
              <button class="api-modal-btn btn-save" onclick="saveApiPreset()">
                ä¿å­˜
              </button>
            </div>
          </div>
        </div>
      </div>

      <div
        id="fontPage"
        class="page chat-settings-page"
        style="background: #f5f5f5"
      >
        <div
          class="page-header"
          style="background: white; border-bottom: 1px solid #eee"
        >
          <button class="back-btn" onclick="closePage('fontPage')">â†</button>
          <h1 class="page-title">å­—ä½“è®¾ç½®</h1>
        </div>

        <div class="settings-content">
          <div class="settings-section">
            <div class="section-header">
              <div class="section-icon purple">ğŸ”¤</div>
              <span class="section-title">æ·»åŠ æ–°å­—ä½“</span>
            </div>
            <div class="section-body">
              <div class="form-group">
                <div class="radio-group">
                  <div
                    class="radio-option active"
                    onclick="switchFontSource('url')"
                    id="tabFontUrl"
                  >
                    ç½‘ç»œé“¾æ¥
                  </div>
                  <div
                    class="radio-option"
                    onclick="switchFontSource('file')"
                    id="tabFontFile"
                  >
                    æœ¬åœ°ä¸Šä¼ 
                  </div>
                </div>
              </div>

              <div id="fontSourceUrl" class="form-group">
                <label class="form-label">å­—ä½“ URL (.woff2, .ttf)</label>
                <input
                  type="text"
                  class="form-input"
                  id="fontUrlInput"
                  placeholder="https://example.com/font.woff2"
                />
              </div>

              <div id="fontSourceFile" class="form-group" style="display: none">
                <label class="form-label">ä¸Šä¼ å­—ä½“æ–‡ä»¶</label>
                <div
                  class="bg-upload-btn"
                  onclick="document.getElementById('fontFileInput').click()"
                >
                  ğŸ“‚ ç‚¹å‡»é€‰æ‹©å­—ä½“æ–‡ä»¶
                </div>
                <input
                  type="file"
                  id="fontFileInput"
                  class="hidden-input"
                  accept=".ttf,.otf,.woff,.woff2"
                  onchange="handleFontFileUpload(this)"
                />
                <div
                  class="form-hint"
                  id="fontFileName"
                  style="margin-top: 8px"
                >
                  æœªé€‰æ‹©æ–‡ä»¶
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">é¢„è®¾åç§°</label>
                <input
                  type="text"
                  class="form-input"
                  id="fontNameInput"
                  placeholder="ä¾‹å¦‚: å°‘å¥³ä½“, åƒç´ é£..."
                />
              </div>

              <div class="form-group">
                <label class="form-label">æ•ˆæœé¢„è§ˆ</label>
                <div
                  id="fontPreviewBox"
                  style="
                    padding: 16px;
                    background: white;
                    border: 1px solid #e5ddd3;
                    border-radius: 12px;
                    font-size: 16px;
                    line-height: 1.6;
                    color: #5d4e37;
                    transition: all 0.3s;
                  "
                >
                  The quick brown fox jumps over the lazy dog.<br />
                  è¿™æ˜¯ä¸€æ®µä¸­æ–‡æµ‹è¯•æ–‡æœ¬ï¼Œç”¨äºé¢„è§ˆå­—ä½“æ•ˆæœã€‚<br />
                  1234567890 !@#$%^&*()
                </div>
              </div>

              <div class="action-buttons-grid">
                <button class="action-btn" onclick="previewCustomFont()">
                  â—‹ é¢„è§ˆ
                </button>
                <button
                  class="action-btn"
                  style="
                    background: linear-gradient(135deg, #a18cd1, #fbc2eb);
                    color: white;
                    border: none;
                  "
                  onclick="saveFontPreset()"
                >
                  ğŸ’¾ ä¿å­˜å¹¶åº”ç”¨
                </button>
              </div>
            </div>
          </div>

          <div class="settings-section">
            <div class="section-header">
              <div class="section-icon orange">ğŸ“š</div>
              <span class="section-title">æˆ‘çš„å­—ä½“åº“</span>
            </div>
            <div class="section-body">
              <div class="api-preset-list" id="fontPresetList">
                <div class="api-preset-item active" onclick="applySystemFont()">
                  <div class="preset-radio" id="radio-system"></div>
                  <div class="preset-info">
                    <div class="preset-name">ç³»ç»Ÿé»˜è®¤</div>
                    <div class="preset-detail">System Default</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="appearancePage" class="page">
        <div class="page-header">
          <button class="back-btn" onclick="closePage('appearancePage')">
            â†
          </button>
          <h1 class="page-title">å¤–è§‚è®¾ç½®</h1>
        </div>
        <div
          class="page-content"
          style="
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
          "
        >
          <!-- å£çº¸è®¾ç½® -->
          <div class="appearance-section">
            <h3>â–£ ä¸»å±å¹•å£çº¸</h3>
            <div
              class="wallpaper-preview"
              id="wallpaperPreview"
              onclick="document.getElementById('wallpaperInput').click()"
            >
              <div class="wallpaper-placeholder">ç‚¹å‡»æ›´æ¢å£çº¸</div>
            </div>
            <input
              type="file"
              id="wallpaperInput"
              accept="image/*"
              style="display: none"
              onchange="previewWallpaper(this)"
            />
            <button class="appearance-btn secondary" onclick="resetWallpaper()">
              æ¢å¤é»˜è®¤
            </button>
          </div>

          <!-- å­—ä½“é¢œè‰²è®¾ç½® -->
          <div class="appearance-section">
            <h3>ğŸ¨ å­—ä½“é¢œè‰²</h3>
            <div class="color-options">
              <div
                class="color-option"
                style="background: #37474f"
                onclick="setFontColor('#37474f')"
                data-color="#37474f"
              ></div>
              <div
                class="color-option"
                style="background: #ffffff; border: 1px solid #ddd"
                onclick="setFontColor('#ffffff')"
                data-color="#ffffff"
              ></div>
              <div
                class="color-option"
                style="background: #f48fb1"
                onclick="setFontColor('#f48fb1')"
                data-color="#f48fb1"
              ></div>
              <div
                class="color-option"
                style="background: #90caf9"
                onclick="setFontColor('#90caf9')"
                data-color="#90caf9"
              ></div>
              <div
                class="color-option"
                style="background: #a5d6a7"
                onclick="setFontColor('#a5d6a7')"
                data-color="#a5d6a7"
              ></div>
              <div
                class="color-option"
                style="background: #ffcc80"
                onclick="setFontColor('#ffcc80')"
                data-color="#ffcc80"
              ></div>
              <div
                class="color-option custom-color"
                id="customColorOption"
                onclick="openCustomColorPicker()"
              >
                <span>+</span>
              </div>
            </div>
            <input
              type="color"
              id="customColorInput"
              style="position: absolute; width: 1px; height: 1px; opacity: 0"
              onchange="applyCustomFontColor(this.value)"
            />
          </div>

          <!-- APPå›¾æ ‡å’Œåç§°è®¾ç½® -->
          <div class="appearance-section">
            <h3>â–¡ APPè‡ªå®šä¹‰</h3>
            <div class="app-customize-list">
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_chat"
                  onclick="document.getElementById('iconInput_chat').click()"
                >
                  èŠå¤©
                </div>
                <input
                  type="file"
                  id="iconInput_chat"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('chat', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_chat"
                  value="èŠå¤©"
                  placeholder="APPåç§°"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_worldbook"
                  onclick="document.getElementById('iconInput_worldbook').click()"
                >
                  ä¸–ç•Œä¹¦
                </div>
                <input
                  type="file"
                  id="iconInput_worldbook"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('worldbook', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_worldbook"
                  value="ä¸–ç•Œä¹¦"
                  placeholder="APPåç§°"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_preset"
                  onclick="document.getElementById('iconInput_preset').click()"
                >
                  é¢„è®¾
                </div>
                <input
                  type="file"
                  id="iconInput_preset"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('preset', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_preset"
                  value="é¢„è®¾"
                  placeholder="APPåç§°"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_forum"
                  onclick="document.getElementById('iconInput_forum').click()"
                >
                  è®ºå›
                </div>
                <input
                  type="file"
                  id="iconInput_forum"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('forum', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_forum"
                  value="è®ºå›"
                  placeholder="APPåç§°"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_api"
                  onclick="document.getElementById('iconInput_api').click()"
                >
                  API
                </div>
                <input
                  type="file"
                  id="iconInput_api"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('api', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_api"
                  value="APIè®¾ç½®"
                  placeholder="APPåç§°"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_font"
                  onclick="document.getElementById('iconInput_font').click()"
                >
                  å­—ä½“
                </div>
                <input
                  type="file"
                  id="iconInput_font"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('font', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_font"
                  value="å­—ä½“"
                  placeholder="APPåç§°"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_appearance"
                  onclick="document.getElementById('iconInput_appearance').click()"
                >
                  å¤–è§‚
                </div>
                <input
                  type="file"
                  id="iconInput_appearance"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('appearance', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_appearance"
                  value="å¤–è§‚è®¾ç½®"
                  placeholder="APPåç§°"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_couple"
                  onclick="document.getElementById('iconInput_couple').click()"
                >
                  æƒ…ä¾£
                </div>
                <input
                  type="file"
                  id="iconInput_couple"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('couple', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_couple"
                  value="æƒ…ä¾£ç©ºé—´"
                  placeholder="APPåç§°"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_companion"
                  onclick="document.getElementById('iconInput_companion').click()"
                >
                  é™ªä¼´
                </div>
                <input
                  type="file"
                  id="iconInput_companion"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('companion', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_companion"
                  value="é™ªä¼´"
                  placeholder="APPåç§°"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_phonepeek"
                  onclick="document.getElementById('iconInput_phonepeek').click()"
                >
                  æŸ¥æ‰‹æœº
                </div>
                <input
                  type="file"
                  id="iconInput_phonepeek"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('phonepeek', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_phonepeek"
                  value="æŸ¥æ‰‹æœº"
                  placeholder="APPåç§°"
                />
              </div>
            </div>
          </div>

          <!-- ä¿å­˜æŒ‰é’® -->
          <button
            class="appearance-save-btn"
            onclick="saveAppearanceSettings()"
          >
            â˜… ä¿å­˜è®¾ç½®
          </button>
        </div>
      </div>

      <!-- Bottom Dock -->
      <div class="dock">
        <div class="dock-item" onclick="openPage('apiPage')">
          <div class="dock-icon dock-blue">APIè®¾ç½®</div>
          <span class="dock-label">APIè®¾ç½®</span>
        </div>
        <div class="dock-item" onclick="openPage('fontPage')">
          <div class="dock-icon dock-purple">å­—ä½“</div>
          <span class="dock-label">å­—ä½“</span>
        </div>
        <div class="dock-item" onclick="openPage('appearancePage')">
          <div class="dock-icon dock-orange">å¤–è§‚è®¾ç½®</div>
          <span class="dock-label">å¤–è§‚è®¾ç½®</span>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div class="edit-modal" id="editModal">
      <div class="edit-modal-content">
        <div class="edit-modal-title" id="editModalTitle">ç¼–è¾‘</div>
        <input
          type="text"
          class="edit-input"
          id="editInput"
          placeholder="è¯·è¾“å…¥..."
        />
        <div class="edit-buttons">
          <button class="edit-btn edit-btn-cancel" onclick="closeEditModal()">
            å–æ¶ˆ
          </button>
          <button class="edit-btn edit-btn-save" onclick="saveEdit()">
            ä¿å­˜
          </button>
        </div>
      </div>
    </div>

    <!-- åç‰‡æ ‡ç­¾ç¼–è¾‘å¼¹çª— -->
    <div class="edit-modal" id="tagEditModal">
      <div class="edit-modal-content">
        <div class="edit-modal-title" id="tagEditTitle">ç¼–è¾‘æ ‡ç­¾</div>
        <input
          type="text"
          class="edit-input"
          id="tagEditInput"
          placeholder="è¯·è¾“å…¥..."
          maxlength="10"
        />
        <div class="edit-buttons">
          <button
            class="edit-btn edit-btn-cancel"
            onclick="closeTagEditModal()"
          >
            å–æ¶ˆ
          </button>
          <button class="edit-btn edit-btn-save" onclick="saveTagEdit()">
            ä¿å­˜
          </button>
        </div>
      </div>
    </div>

    <!-- æ‹çˆ±çºªå¿µç¼–è¾‘å¼¹çª— -->
    <div class="edit-modal" id="loveEditModal">
      <div class="edit-modal-content">
        <div class="edit-modal-title" id="loveEditTitle">ç¼–è¾‘</div>
        <input
          type="text"
          class="edit-input"
          id="loveEditInput"
          placeholder="è¯·è¾“å…¥..."
        />
        <div class="edit-buttons">
          <button
            class="edit-btn edit-btn-cancel"
            onclick="closeLoveEditModal()"
          >
            å–æ¶ˆ
          </button>
          <button class="edit-btn edit-btn-save" onclick="saveLoveEdit()">
            ä¿å­˜
          </button>
        </div>
      </div>
    </div>

    <!-- æ‹çˆ±å°ç»„ä»¶é€‰é¡¹å¼¹çª— -->
    <div class="edit-modal" id="loveWidgetOptionsModal">
      <div class="edit-modal-content" style="padding: 16px">
        <div class="edit-modal-title">å°ç»„ä»¶è®¾ç½®</div>
        <div class="love-widget-options">
          <div class="love-widget-option" onclick="triggerLoveWidgetBgUpload()">
            <span class="love-widget-option-icon">ğŸ–¼ï¸</span>
            <span>æ›´æ¢èƒŒæ™¯å›¾</span>
          </div>
          <div
            class="love-widget-option"
            onclick="setLoveWidgetTextColor('dark')"
          >
            <span class="love-widget-option-icon">â¬›</span>
            <span>å­—ä½“æ”¹é»‘è‰²</span>
          </div>
          <div
            class="love-widget-option"
            onclick="setLoveWidgetTextColor('light')"
          >
            <span class="love-widget-option-icon">â¬œ</span>
            <span>å­—ä½“æ”¹ç™½è‰²</span>
          </div>
        </div>
        <button
          class="edit-btn edit-btn-cancel"
          style="width: 100%; margin-top: 12px"
          onclick="closeLoveWidgetOptionsModal()"
        >
          å–æ¶ˆ
        </button>
      </div>
    </div>

    <!-- åˆ†ç»„ç®¡ç†å¼¹çª— -->
    <div
      class="edit-modal"
      id="groupManagerModal"
      style="z-index: var(--z-toast)"
    >
      <div class="edit-modal-content" style="max-width: 320px">
        <div class="edit-modal-title">ç®¡ç†åˆ†ç»„</div>
        <div class="group-list" id="groupList">
          <!-- åŠ¨æ€æ¸²æŸ“åˆ†ç»„åˆ—è¡¨ -->
        </div>
        <div class="group-add-row">
          <input
            type="text"
            class="edit-input"
            id="newGroupInput"
            placeholder="è¾“å…¥æ–°åˆ†ç»„åç§°..."
            style="flex: 1; margin-bottom: 0"
          />
          <button
            class="edit-btn edit-btn-save"
            onclick="addNewGroup()"
            style="margin-left: 8px; width: 60px"
          >
            æ·»åŠ 
          </button>
        </div>
        <div class="edit-buttons" style="margin-top: 16px">
          <button
            class="edit-btn edit-btn-cancel"
            onclick="closeGroupManager()"
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>

    <!-- Create Character Modal -->
    <div class="edit-modal" id="createCharModal">
      <div class="create-char-content">
        <div class="create-char-title">åˆ›å»ºæ–°è§’è‰²</div>

        <!-- Avatar upload -->
        <div
          class="create-avatar-section"
          onclick="document.getElementById('charAvatarInput').click()"
        >
          <div class="create-avatar">
            <span class="create-avatar-placeholder" id="charAvatarPlaceholder"
              ><svg
                width="32"
                height="32"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline></svg
            ></span>
            <img id="charAvatarPreview" src="" alt="" style="display: none" />
          </div>
          <span class="create-avatar-hint">ç‚¹å‡»ä¸Šä¼ å¤´åƒ</span>
        </div>
        <input
          type="file"
          id="charAvatarInput"
          class="hidden-input"
          accept="image/*"
          onchange="previewCharAvatar(this)"
        />

        <!-- Name input -->
        <div class="create-input-group">
          <label class="create-label"
            >è§’è‰²åç§° <span class="required">*</span></label
          >
          <input
            type="text"
            class="create-input"
            id="charNameInput"
            placeholder="è¯·è¾“å…¥è§’è‰²åç§°"
          />
        </div>

        <!-- Note input -->
        <div class="create-input-group">
          <label class="create-label"
            >å¤‡æ³¨ <span class="optional">(é€‰å¡«)</span></label
          >
          <input
            type="text"
            class="create-input"
            id="charNoteInput"
            placeholder="æ·»åŠ å¤‡æ³¨ä¿¡æ¯"
          />
        </div>

        <!-- Buttons -->
        <div class="create-buttons">
          <button
            class="create-btn create-btn-cancel"
            onclick="closeCreateCharModal()"
          >
            å–æ¶ˆ
          </button>
          <button
            class="create-btn create-btn-confirm"
            onclick="createCharacter()"
          >
            åˆ›å»º
          </button>
        </div>
      </div>
    </div>

    <!-- Create Group Chat Modal -->
    <div
      class="create-group-modal"
      id="createGroupModal"
      onclick="if(event.target===this)closeCreateGroupModal()"
    >
      <div class="create-group-content">
        <div class="create-group-header">
          <span class="create-group-title">åˆ›å»ºç¾¤èŠ</span>
          <button class="create-group-close" onclick="closeCreateGroupModal()">
            âœ•
          </button>
        </div>
        <div class="create-group-body">
          <!-- ç¾¤èŠå¤´åƒ -->
          <div class="create-group-avatar-section">
            <div
              class="create-group-avatar"
              id="groupAvatarPreview"
              onclick="document.getElementById('groupAvatarInput').click()"
            >
              <span id="groupAvatarPlaceholder">ğŸ‘¥</span>
              <img id="groupAvatarImg" src="" style="display: none" />
            </div>
            <div class="create-group-avatar-hint">ç‚¹å‡»ä¸Šä¼ ç¾¤å¤´åƒï¼ˆå¯é€‰ï¼‰</div>
            <input
              type="file"
              id="groupAvatarInput"
              accept="image/*"
              style="display: none"
              onchange="previewGroupAvatar(this)"
            />
          </div>

          <!-- ç¾¤èŠåç§° -->
          <div class="create-group-input-section">
            <label class="create-group-label"
              >ç¾¤èŠåç§° <span style="color: #f48fb1">*</span></label
            >
            <input
              type="text"
              class="create-group-input"
              id="groupNameInput"
              placeholder="è¾“å…¥ç¾¤èŠåç§°..."
              oninput="checkGroupCreateValid()"
            />
          </div>

          <!-- é€‰æ‹©æˆå‘˜ -->
          <div class="create-group-members-title">
            <span>é€‰æ‹©ç¾¤æˆå‘˜</span>
            <span class="create-group-members-count" id="selectedMembersCount"
              >å·²é€‰ 0 äºº</span
            >
          </div>
          <div class="create-group-members-list" id="groupMembersList">
            <!-- è§’è‰²åˆ—è¡¨ä¼šåŠ¨æ€æ¸²æŸ“ -->
          </div>
        </div>
        <div class="create-group-footer">
          <button
            class="create-group-btn cancel"
            onclick="closeCreateGroupModal()"
          >
            å–æ¶ˆ
          </button>
          <button
            class="create-group-btn confirm"
            id="createGroupConfirmBtn"
            onclick="createGroupChat()"
            disabled
          >
            åˆ›å»ºç¾¤èŠ
          </button>
        </div>
      </div>
    </div>

    <!-- Group Settings Modal (æ·»åŠ ç¾¤æˆå‘˜) -->
    <div
      class="create-group-modal"
      id="addGroupMemberModal"
      onclick="if(event.target===this)closeAddGroupMemberModal()"
    >
      <div class="create-group-content">
        <div class="create-group-header">
          <span class="create-group-title">æ·»åŠ ç¾¤æˆå‘˜</span>
          <button
            class="create-group-close"
            onclick="closeAddGroupMemberModal()"
          >
            âœ•
          </button>
        </div>
        <div class="create-group-body">
          <div class="create-group-members-title">
            <span>é€‰æ‹©è¦æ·»åŠ çš„æˆå‘˜</span>
            <span class="create-group-members-count" id="addMembersCount"
              >å·²é€‰ 0 äºº</span
            >
          </div>
          <div class="create-group-members-list" id="addMembersList">
            <!-- å¯æ·»åŠ çš„è§’è‰²åˆ—è¡¨ -->
          </div>
        </div>
        <div class="create-group-footer">
          <button
            class="create-group-btn cancel"
            onclick="closeAddGroupMemberModal()"
          >
            å–æ¶ˆ
          </button>
          <button
            class="create-group-btn confirm"
            id="addMemberConfirmBtn"
            onclick="confirmAddGroupMembers()"
            disabled
          >
            æ·»åŠ 
          </button>
        </div>
      </div>
    </div>

    <!-- ç¾¤èŠä¸“ç”¨è®¾ç½®é¡µé¢ -->
    <!-- ç¾¤æˆå‘˜ç®¡ç†å¼¹çª— -->
    <div
      class="create-group-modal"
      id="groupMemberManagerModal"
      onclick="if(event.target===this)closeGroupMemberManager()"
    >
      <div class="create-group-content">
        <div class="create-group-header">
          <span class="create-group-title">ç®¡ç†ç¾¤æˆå‘˜</span>
          <button
            class="create-group-close"
            onclick="closeGroupMemberManager()"
          >
            âœ•
          </button>
        </div>
        <div class="create-group-body">
          <div class="create-group-members-title">
            <span>ç¾¤æˆå‘˜åˆ—è¡¨</span>
            <span class="create-group-members-count" id="manageMembersCount"
              >å…± 0 äºº</span
            >
          </div>
          <div class="create-group-members-list" id="manageMembersList">
            <!-- ç¾¤æˆå‘˜åˆ—è¡¨ä¼šåŠ¨æ€æ¸²æŸ“ -->
          </div>
          <div
            style="
              margin-top: 16px;
              padding-top: 16px;
              border-top: 1px dashed rgba(0, 0, 0, 0.1);
            "
          >
            <button
              class="create-group-btn confirm"
              onclick="closeGroupMemberManager();setTimeout(openAddGroupMemberModal, 300);"
              style="width: 100%"
            >
              â• æ·»åŠ æ–°æˆå‘˜
            </button>
          </div>
        </div>
        <div class="create-group-footer">
          <button
            class="create-group-btn cancel"
            onclick="closeGroupMemberManager()"
            style="width: 100%"
          >
            å®Œæˆ
          </button>
        </div>
      </div>
    </div>

    <!-- ç¾¤èŠä¸“ç”¨è®¾ç½®é¡µé¢ -->
    <div class="chat-settings-page" id="groupChatSettingsPage">
      <div class="settings-header">
        <button class="settings-back-btn" onclick="closeGroupChatSettings()">
          â€¹
        </button>
        <div class="settings-header-title">ç¾¤èŠè®¾ç½®</div>
        <button
          class="settings-save-btn"
          onclick="saveGroupChatSettingsAndClose()"
        >
          ä¿å­˜
        </button>
      </div>
      <div class="settings-content" id="groupSettingsContent">
        <!-- åŠ¨æ€ç”Ÿæˆå†…å®¹ -->
      </div>
    </div>

    <div class="chat-conversation-page" id="chatConversationPage">
      <div class="conv-header">
        <button class="conv-back-btn" onclick="closeConversation()">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <div class="conv-title-section">
          <div class="conv-avatar" id="convAvatar">AI</div>
          <div class="conv-info">
            <span class="conv-name" id="convName">è§’è‰²åç§°</span>
            <span class="conv-status" id="convStatusWrapper">
              <span class="conv-status-dot"></span>
              <span id="convStatusText">Online</span>
            </span>
          </div>
        </div>
        <div class="conv-header-btns">
          <button
            class="conv-capsule-btn"
            id="heartVoiceBtn"
            onclick="showHeartVoice()"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
              ></path>
            </svg>
          </button>
          <button
            class="conv-capsule-btn"
            id="groupAnnouncementBtn"
            style="display: none"
            onclick="openGroupAnnouncementModal()"
            title="ç¾¤å…¬å‘Š"
          >
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3z"
              ></path>
              <path d="M9.5 17v1a2.5 2.5 0 0 0 5 0v-1"></path>
            </svg>
          </button>
          <div class="conv-capsule-divider" id="convCapsuleDivider"></div>
          <button class="conv-capsule-btn" onclick="openChatSettings()">
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="12" cy="12" r="1.5"></circle>
              <circle cx="19" cy="12" r="1.5"></circle>
              <circle cx="5" cy="12" r="1.5"></circle>
            </svg>
          </button>
        </div>
      </div>

      <div class="conv-menu" id="convMenu">
        <div class="conv-menu-item" onclick="clearChatHistory()">
          âœ• æ¸…ç©ºèŠå¤©è®°å½•
        </div>
        <div class="conv-menu-item" onclick="deleteCharacter()">
          âœ• åˆ é™¤æ­¤è§’è‰²
        </div>
      </div>

      <!-- ç¾¤å…¬å‘Šæ  - ä»…ç¾¤èŠæ˜¾ç¤º -->
      <div
        class="group-announcement-bar"
        id="groupAnnouncementBar"
        style="display: none"
        onclick="openGroupAnnouncementModal()"
      >
        <span class="group-announcement-icon">ğŸ“¢</span>
        <span class="group-announcement-text" id="groupAnnouncementText"
          >ç‚¹å‡»è®¾ç½®ç¾¤å…¬å‘Š</span
        >
        <span class="group-announcement-arrow">â€º</span>
      </div>

      <div class="conv-messages" id="convMessages" onclick="closeChatPanel()">
        <div class="conv-empty">
          <div class="conv-empty-icon">
            <svg
              width="48"
              height="48"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
              ></path>
            </svg>
          </div>
          <div class="conv-empty-text">å¼€å§‹å’ŒTAèŠå¤©å§ï½</div>
        </div>
      </div>

      <div class="conv-input-area" id="inputArea">
        <!-- å¼•ç”¨é¢„è§ˆåŒºåŸŸ -->
        <div class="quote-preview" id="quotePreview" style="display: none">
          <div class="quote-preview-content">
            <div class="quote-preview-sender" id="quotePreviewSender"></div>
            <div class="quote-preview-text" id="quotePreviewText"></div>
          </div>
          <button class="quote-preview-close" onclick="cancelQuote()">âœ•</button>
        </div>

        <!-- ç¾¤èŠå¼•ç”¨é¢„è§ˆåŒºåŸŸ -->
        <div class="group-quote-preview" id="groupQuotePreview">
          <div class="group-quote-preview-content">
            <div
              class="group-quote-preview-sender"
              id="groupQuotePreviewSender"
            ></div>
            <div
              class="group-quote-preview-text"
              id="groupQuotePreviewText"
            ></div>
          </div>
          <button
            class="group-quote-preview-close"
            onclick="cancelGroupQuote()"
          >
            âœ•
          </button>
        </div>

        <!-- @é€‰æ‹©å™¨å¼¹çª— -->
        <div class="at-selector-popup" id="atSelectorPopup"></div>

        <div class="conv-input-bar">
          <button class="tool-btn icon-btn" onclick="toggleChatPanel('plus')">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>

          <div class="conv-input-wrapper">
            <textarea
              class="conv-input"
              id="convInput"
              placeholder="è¾“å…¥æ¶ˆæ¯..."
              rows="1"
              oninput="autoResizeTextarea(this)"
              onfocus="closeChatPanel()"
            ></textarea>
            <button class="emoji-btn-inner" onclick="toggleChatPanel('emoji')">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
              >
                <circle cx="12" cy="12" r="10" />
                <path d="M8 14s1.5 2 4 2 4-2 4-2" />
                <line x1="9" y1="9" x2="9.01" y2="9" />
                <line x1="15" y1="9" x2="15.01" y2="9" />
              </svg>
            </button>
          </div>

          <button class="ai-magic-btn" onclick="requestAIReply()" id="replyBtn">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M12 3l1.5 4.5L18 9l-4.5 1.5L12 15l-1.5-4.5L6 9l4.5-1.5L12 3z"
              ></path>
              <path d="M5 19l1 3 1-3 3-1-3-1-1-3-1 3-3 1 3 1z"></path>
              <path
                d="M18 14l.5 1.5 1.5.5-1.5.5-.5 1.5-.5-1.5-1.5-.5 1.5-.5.5-1.5z"
              ></path>
            </svg>
          </button>

          <button class="conv-send-btn" onclick="sendUserMessage()">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2.5"
            >
              <line x1="12" y1="19" x2="12" y2="5"></line>
              <polyline points="5 12 12 5 19 12"></polyline>
            </svg>
          </button>
        </div>

        <!-- iOSé£æ ¼æ‚¬æµ®èœå• -->
        <div
          class="plus-menu-overlay"
          id="plusMenuOverlay"
          onclick="closePlusMenu()"
        ></div>
        <div class="plus-menu" id="plusPanel">
          <div
            class="plus-menu-item"
            onclick="openSendImageModal(); closePlusMenu();"
          >
            <div class="plus-menu-icon">
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"
                ></path>
                <circle cx="12" cy="13" r="4"></circle>
              </svg>
            </div>
            <span class="plus-menu-label">Camera</span>
          </div>
          <div
            class="plus-menu-item"
            onclick="document.getElementById('chatImgInput').click(); closePlusMenu();"
          >
            <div class="plus-menu-icon">
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
            </div>
            <span class="plus-menu-label">Photos</span>
          </div>
          <div
            class="plus-menu-item"
            onclick="startVideoCall(); closePlusMenu();"
          >
            <div class="plus-menu-icon">
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polygon points="23 7 16 12 23 17 23 7"></polygon>
                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
              </svg>
            </div>
            <span class="plus-menu-label">Video</span>
          </div>
          <div
            class="plus-menu-item"
            onclick="openVoiceMessageModal(); closePlusMenu();"
          >
            <div class="plus-menu-icon">
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"
                ></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" y1="19" x2="12" y2="23"></line>
                <line x1="8" y1="23" x2="16" y2="23"></line>
              </svg>
            </div>
            <span class="plus-menu-label">Audio</span>
          </div>
          <div
            class="plus-menu-item"
            onclick="rerollAIReply(); closePlusMenu();"
          >
            <div class="plus-menu-icon">
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path
                  d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
                ></path>
              </svg>
            </div>
            <span class="plus-menu-label">Reroll</span>
          </div>
          <div
            class="plus-menu-item"
            onclick="continueChat(); closePlusMenu();"
          >
            <div class="plus-menu-icon">
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M5 12h14"></path>
                <path d="M12 5l7 7-7 7"></path>
              </svg>
            </div>
            <span class="plus-menu-label">Continue</span>
          </div>
          <div
            class="plus-menu-item"
            onclick="startVoiceCall(); closePlusMenu();"
          >
            <div class="plus-menu-icon">
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                ></path>
              </svg>
            </div>
            <span class="plus-menu-label">Call</span>
          </div>
          <div
            class="plus-menu-item"
            onclick="sendFakeLocation(); closePlusMenu();"
          >
            <div class="plus-menu-icon">
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
            </div>
            <span class="plus-menu-label">Location</span>
          </div>
          <div
            class="plus-menu-item"
            onclick="openTransferModal(); closePlusMenu();"
          >
            <div class="plus-menu-icon">
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="12" y1="1" x2="12" y2="23"></line>
                <path
                  d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
                ></path>
              </svg>
            </div>
            <span class="plus-menu-label">Transfer</span>
          </div>
          <div
            class="plus-menu-item"
            onclick="openReadTogether(); closePlusMenu();"
          >
            <div class="plus-menu-icon">
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path
                  d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"
                ></path>
              </svg>
            </div>
            <span class="plus-menu-label">Books</span>
          </div>
          <div
            class="plus-menu-item"
            onclick="openMusicTogether(); closePlusMenu();"
          >
            <div class="plus-menu-icon">
              <svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M9 18V5l12-2v13"></path>
                <circle cx="6" cy="18" r="3"></circle>
                <circle cx="18" cy="16" r="3"></circle>
              </svg>
            </div>
            <span class="plus-menu-label">Music</span>
          </div>
          <input
            type="file"
            id="chatImgInput"
            hidden
            accept="image/*"
            onchange="handleChatImageUpload(this)"
          />
        </div>

        <div class="chat-panel" id="emojiPanel">
          <!-- æœç´¢æ¡† -->
          <div class="sticker-search-bar">
            <input
              type="text"
              class="sticker-search-input"
              id="stickerSearchInput"
              placeholder="æœç´¢è¡¨æƒ…åŒ…..."
              oninput="handleStickerSearch(this.value)"
            />
            <span
              class="sticker-search-clear"
              id="stickerSearchClear"
              onclick="clearStickerSearch()"
              >âœ•</span
            >
          </div>

          <div class="sticker-category-bar" id="stickerCategoryBar"></div>

          <div class="emoji-grid" id="stickerGrid"></div>

          <input
            type="file"
            id="stickerInput"
            hidden
            accept="image/*,.txt"
            multiple
            onchange="handleStickerImport(this)"
          />
        </div>
      </div>
    </div>

    <!-- ä¸€èµ·è¯»ä¹¦é¡µé¢ -->
    <div class="read-together-page" id="readTogetherPage">
      <div class="read-header">
        <button class="read-header-back" onclick="closeReadTogether()">
          â†
        </button>
        <div class="read-header-title">ğŸ“– ä¸€èµ·è¯»ä¹¦</div>
        <div style="width: 36px"></div>
      </div>
      <div class="read-content">
        <!-- æˆ‘çš„ä¹¦æ¶ -->
        <div class="bookshelf-section">
          <div class="bookshelf-title">â‰¡ æˆ‘çš„ä¹¦æ¶</div>
          <div class="bookshelf-grid" id="bookshelfGrid">
            <!-- ä¹¦ç±å¡ç‰‡ä¼šåŠ¨æ€ç”Ÿæˆ -->
            <div
              class="book-card add-book-card"
              onclick="document.getElementById('bookFileInput').click()"
            >
              <div style="font-size: 32px; margin-bottom: 8px">+</div>
              <div>å¯¼å…¥æ–°ä¹¦</div>
            </div>
          </div>
          <input
            type="file"
            id="bookFileInput"
            hidden
            accept=".txt"
            onchange="handleBookImport(this)"
          />
        </div>

        <!-- å½“å‰é˜…è¯» -->
        <div id="currentReadingSection" style="display: none">
          <div class="bookshelf-title">â‰¡ å½“å‰é˜…è¯»</div>
          <div class="read-book-info">
            <div class="read-book-title">
              <span>â‰¡</span>
              <span id="readBookName">ä¹¦å</span>
              <span class="read-status-badge" id="readStatusBadge">
                <span>âœ“</span> é˜…è¯»ä¸­
              </span>
            </div>
            <div class="read-book-progress" id="readBookProgress">
              è¿›åº¦ï¼šç¬¬ 1 é¡µ / å…± 100 é¡µ
            </div>
            <div class="read-progress-bar">
              <div
                class="read-progress-fill"
                id="readProgressFill"
                style="width: 0%"
              ></div>
            </div>
          </div>

          <div class="read-current-section">
            <div class="read-section-label">ğŸ“ å½“å‰é¡µå†…å®¹</div>
            <div class="read-section-text" id="readSectionText">
              è¿™é‡Œæ˜¾ç¤ºå½“å‰é¡µçš„å†…å®¹...
            </div>
            <div class="read-controls">
              <button class="read-ctrl-btn prev" onclick="readPrevSection()">
                â† ä¸Šä¸€é¡µ
              </button>
              <button class="read-ctrl-btn next" onclick="readNextSection()">
                ä¸‹ä¸€é¡µ â†’
              </button>
            </div>
          </div>

          <div class="read-settings">
            <div class="read-setting-row">
              <span class="read-setting-label">è·³è½¬åˆ°ç¬¬</span>
              <div class="read-setting-value">
                <input
                  type="number"
                  class="read-setting-input"
                  id="readJumpTo"
                  value="1"
                  min="1"
                />
                <span>é¡µ</span>
                <button
                  class="read-ctrl-btn next"
                  style="flex: none; padding: 6px 12px"
                  onclick="jumpToSection()"
                >
                  è·³è½¬
                </button>
              </div>
            </div>
            <div class="read-setting-row">
              <span class="read-setting-label">å¼€å¯æ‚¬æµ®çª—</span>
              <div class="read-setting-value">
                <button
                  class="read-ctrl-btn next"
                  style="flex: none; padding: 8px 16px"
                  onclick="startFloatingMode()"
                >
                  â€¢ æ‚¬æµ®é˜…è¯»
                </button>
              </div>
            </div>
            <div class="read-setting-row">
              <button
                class="read-ctrl-btn prev"
                style="width: 100%; background: #fff3e0; color: #ff9800"
                onclick="stopCurrentReading()"
              >
                â¸ï¸ æš‚åœé˜…è¯»ï¼ˆå›åˆ°ä¹¦æ¶ï¼‰
              </button>
            </div>
          </div>
        </div>

        <!-- å¯¼å…¥è®¾ç½® -->
        <div class="read-settings" style="margin-top: 16px">
          <div class="bookshelf-title" style="margin-bottom: 12px">
            ğŸ“¥ å¯¼å…¥è®¾ç½®
          </div>
          <div class="read-setting-row">
            <span class="read-setting-label">æ¯é¡µå­—æ•°</span>
            <div class="read-setting-value">
              <input
                type="number"
                class="read-setting-input"
                id="readChunkSize"
                value="500"
                min="100"
                max="3000"
                style="width: 70px"
              />
              <span>å­—</span>
            </div>
          </div>
          <div style="font-size: 0.8rem; color: #888; margin-top: 8px">
            æç¤ºï¼šå¯¼å…¥æ–°ä¹¦æ—¶ç”Ÿæ•ˆã€‚å­—æ•°è¶Šå°‘ç¿»é¡µè¶Šé¢‘ç¹ï¼Œå­—æ•°è¶Šå¤šæ¯é¡µå†…å®¹è¶Šé•¿ã€‚
          </div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="read-settings" style="margin-top: 16px">
          <div
            class="read-setting-row"
            style="flex-direction: column; align-items: flex-start; gap: 8px"
          >
            <span class="read-setting-label">ğŸ“– ä½¿ç”¨è¯´æ˜</span>
            <div style="font-size: 0.85rem; color: #666; line-height: 1.6">
              1. è®¾ç½®æ¯é¡µå­—æ•°ï¼Œç„¶åå¯¼å…¥TXTä¹¦ç±<br />
              2. ç‚¹å‡»ä¹¦ç±å¡ç‰‡å¼€å§‹é˜…è¯»<br />
              3. ç‚¹å‡»ã€Œâ€¢ æ‚¬æµ®é˜…è¯»ã€å¼€å¯æ‚¬æµ®çª—<br />
              4. æ‚¬æµ®çª—å¯ä»¥æ‹–åŠ¨ã€ç¼©æ”¾ï¼Œè¾¹çœ‹ä¹¦è¾¹èŠå¤©<br />
              5. AIä¼šæ ¹æ®å½“å‰é˜…è¯»å†…å®¹ä¸ä½ äº’åŠ¨
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æ‚¬æµ®é˜…è¯»æŒ‰é’® -->
    <button
      class="read-floating-btn"
      id="readFloatingBtn"
      onclick="toggleFloatingPanel()"
    >
      â‰¡
    </button>

    <!-- æ‚¬æµ®é˜…è¯»é¢æ¿ -->
    <div class="read-floating-panel" id="readFloatingPanel">
      <div class="read-float-header" id="floatPanelHeader">
        <span class="read-float-drag-hint">â‹®â‹®</span>
        <div class="read-float-title" id="floatBookTitle">ä¹¦å</div>
        <div class="read-float-progress" id="floatProgress">ç¬¬1é¡µ</div>
        <button class="read-float-close" onclick="toggleFloatingPanel()">
          âœ•
        </button>
      </div>
      <div class="read-float-content" id="floatContent">å½“å‰é¡µå†…å®¹...</div>
      <div class="read-float-controls">
        <button
          class="read-float-btn"
          onclick="readPrevSection();updateFloatingPanel();"
        >
          â† ä¸Šä¸€é¡µ
        </button>
        <button
          class="read-float-btn primary"
          onclick="readNextSection();updateFloatingPanel();"
        >
          ä¸‹ä¸€é¡µ â†’
        </button>
        <button
          class="read-float-btn"
          onclick="openReadTogether();hideFloatingPanel();"
        >
          ğŸ“– ä¹¦æ¶
        </button>
      </div>
      <div class="read-float-resize-handle" id="floatResizeHandle"></div>
    </div>

    <!-- Chat Settings Page -->
    <div class="chat-settings-page" id="chatSettingsPage">
      <div class="settings-header">
        <button class="settings-back-btn" onclick="closeChatSettings()">
          â€¹
        </button>
        <div class="settings-header-title">èŠå¤©è®¾ç½®</div>
        <button class="settings-save-btn" onclick="saveChatSettingsAndClose()">
          ä¿å­˜
        </button>
      </div>

      <div class="settings-content">
        <!-- Section 1: Basic Info -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon brown">ğŸ“</div>
            <span class="section-title">åŸºç¡€èµ„æ–™</span>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label"
                >è§’è‰²çœŸå / ç¾¤èŠåç§°
                <span class="form-hint">(AIåªè®¤è¿™ä¸ª)</span></label
              >
              <input
                type="text"
                class="form-input"
                id="settingsCharName"
                placeholder="è¾“å…¥è§’è‰²åç§°..."
              />
            </div>
            <div class="form-group">
              <label class="form-label"
                >å¤‡æ³¨å
                <span class="form-hint">(ä»…æ˜¾ç¤ºç”¨ï¼ŒAIä¸çŸ¥é“)</span></label
              >
              <input
                type="text"
                class="form-input"
                id="settingsCharNote"
                placeholder="è¾“å…¥å¤‡æ³¨å..."
              />
            </div>
            <div class="form-group">
              <label class="form-label">å¥½å‹åˆ†ç»„</label>
              <div class="form-select-wrapper">
                <select class="form-select" id="settingsGroup">
                  <option value="none">æœªåˆ†ç»„</option>
                </select>
                <button class="form-btn-small" onclick="openGroupManager()">
                  ç®¡ç†
                </button>
              </div>
            </div>

            <!-- ç½®é¡¶è”ç³»äºº -->
            <div class="form-group">
              <label class="form-label">èŠå¤©åˆ—è¡¨è®¾ç½®</label>
              <div class="avatar-toggle-group">
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="settingsPinned"
                    onchange="togglePinContact()"
                  />
                  <span class="toggle-label">â€¢ ç½®é¡¶æ­¤è”ç³»äºº</span>
                </label>
              </div>
            </div>

            <!-- Avatar Upload -->
            <div class="avatar-upload-row">
              <div class="avatar-upload-col">
                <div class="avatar-upload-label">å¯¹æ–¹å¤´åƒ</div>
                <div
                  class="avatar-preview"
                  id="settingsOtherAvatar"
                  onclick="document.getElementById('otherAvatarInput').click()"
                >
                  <span id="otherAvatarPlaceholder"
                    ><svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <rect
                        x="3"
                        y="3"
                        width="18"
                        height="18"
                        rx="2"
                        ry="2"
                      ></rect>
                      <circle cx="8.5" cy="8.5" r="1.5"></circle>
                      <polyline points="21 15 16 10 5 21"></polyline></svg
                  ></span>
                  <img id="otherAvatarImg" src="" style="display: none" />
                </div>
                <input
                  type="file"
                  id="otherAvatarInput"
                  class="hidden-input"
                  accept="image/*"
                  onchange="previewSettingsAvatar(this, 'other')"
                />
                <div class="avatar-actions">
                  <button
                    class="avatar-action-btn"
                    onclick="document.getElementById('otherAvatarInput').click()"
                  >
                    ä¸Šä¼ 
                  </button>
                  <button
                    class="avatar-action-btn"
                    onclick="clearSettingsAvatar('other')"
                  >
                    æ¸…é™¤
                  </button>
                </div>
              </div>
              <div class="avatar-upload-col">
                <div class="avatar-upload-label">æˆ‘çš„å¤´åƒ</div>
                <div
                  class="avatar-preview"
                  id="settingsMyAvatar"
                  onclick="document.getElementById('myAvatarInput').click()"
                >
                  <span id="myAvatarPlaceholder"
                    ><svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <rect
                        x="3"
                        y="3"
                        width="18"
                        height="18"
                        rx="2"
                        ry="2"
                      ></rect>
                      <circle cx="8.5" cy="8.5" r="1.5"></circle>
                      <polyline points="21 15 16 10 5 21"></polyline></svg
                  ></span>
                  <img id="myAvatarImg" src="" style="display: none" />
                </div>
                <input
                  type="file"
                  id="myAvatarInput"
                  class="hidden-input"
                  accept="image/*"
                  onchange="previewSettingsAvatar(this, 'my')"
                />
                <div class="avatar-actions">
                  <button
                    class="avatar-action-btn"
                    onclick="document.getElementById('myAvatarInput').click()"
                  >
                    ä¸Šä¼ 
                  </button>
                  <button
                    class="avatar-action-btn"
                    onclick="clearSettingsAvatar('my')"
                  >
                    æ¸…é™¤
                  </button>
                </div>
              </div>
            </div>

            <!-- å¤´åƒæ˜¾ç¤ºå¼€å…³ -->
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">å¤´åƒæ˜¾ç¤ºè®¾ç½®</label>
              <div class="avatar-toggle-group">
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="showAiAvatar"
                    checked
                    onchange="toggleAvatarDisplay()"
                  />
                  <span class="toggle-label">æ˜¾ç¤ºAIå¤´åƒ</span>
                </label>
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="showUserAvatar"
                    checked
                    onchange="toggleAvatarDisplay()"
                  />
                  <span class="toggle-label">æ˜¾ç¤ºæˆ‘çš„å¤´åƒ</span>
                </label>
              </div>
            </div>

            <!-- å¤´åƒå¤§å°è°ƒèŠ‚ -->
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">å¤´åƒå¤§å°</label>
              <div style="display: flex; align-items: center; gap: 12px">
                <input
                  type="range"
                  id="avatarSizeSlider"
                  min="28"
                  max="56"
                  value="40"
                  style="flex: 1; accent-color: #f48fb1"
                  oninput="updateAvatarSizePreview(this.value)"
                  onchange="saveAvatarSize(this.value)"
                />
                <span
                  id="avatarSizeValue"
                  style="
                    min-width: 45px;
                    text-align: center;
                    font-size: 0.9rem;
                    color: #666;
                  "
                  >40px</span
                >
              </div>
            </div>

            <!-- æ°”æ³¡é—´è·è°ƒèŠ‚ -->
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">æ°”æ³¡é—´è·</label>
              <div style="display: flex; align-items: center; gap: 12px">
                <input
                  type="range"
                  id="bubbleGapSlider"
                  min="2"
                  max="20"
                  value="6"
                  style="flex: 1; accent-color: #f48fb1"
                  oninput="updateBubbleGapPreview(this.value)"
                  onchange="saveBubbleGap(this.value)"
                />
                <span
                  id="bubbleGapValue"
                  style="
                    min-width: 45px;
                    text-align: center;
                    font-size: 0.9rem;
                    color: #666;
                  "
                  >6px</span
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Section 2: AI Brain & Persona -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon purple">ğŸ§ </div>
            <span class="section-title">è®¾å®š</span>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label">å¯¹æ–¹äººè®¾ (Persona)</label>
              <textarea
                class="form-input form-textarea"
                id="settingsPersona"
                placeholder="æè¿°AIè§’è‰²çš„æ€§æ ¼ã€èƒŒæ™¯ã€è¯´è¯æ–¹å¼ç­‰..."
              ></textarea>
            </div>
            <div class="form-group">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 8px;
                "
              >
                <label class="form-label" style="margin-bottom: 0"
                  >æˆ‘çš„äººè®¾ (My Persona)</label
                >
                <div style="display: flex; gap: 8px">
                  <select
                    class="form-select"
                    id="userPersonaPresetSelect"
                    style="
                      padding: 6px 24px 6px 12px;
                      font-size: 0.8rem;
                      background-position: right 8px center;
                    "
                  >
                    <option value="">-- é€‰æ‹©é¢„è®¾ --</option>
                  </select>
                  <button
                    class="form-btn-small"
                    onclick="saveUserPersonaPreset()"
                    style="padding: 6px 12px; font-size: 0.8rem"
                  >
                    ä¿å­˜é¢„è®¾
                  </button>
                </div>
              </div>
              <textarea
                class="form-input form-textarea"
                id="settingsMyPersona"
                placeholder="æè¿°ä½ è‡ªå·±çš„è®¾å®šï¼Œè®©AIäº†è§£ä½ ..."
              ></textarea>
            </div>
            <div class="form-group">
              <label class="form-label"
                >å…³è”ä¸–ç•Œä¹¦
                <span class="form-hint">(å¤šé€‰ï¼Œå‹¾é€‰ç”Ÿæ•ˆ)</span></label
              >
              <div class="worldbook-select-area" id="settingsWorldbookArea">
                <div class="worldbook-select-empty">
                  è¿˜æ²¡æœ‰ä¸–ç•Œä¹¦ï¼Œå»åˆ›å»ºä¸€æœ¬å§~
                </div>
              </div>
              <input type="hidden" id="settingsWorldbook" value="" />
            </div>
            <div
              class="form-group"
              style="
                margin-top: 18px;
                padding-top: 18px;
                border-top: 1px dashed #eee;
              "
            >
              <label class="form-label">ğŸ—£ï¸ è§’è‰²éŸ³è‰² (Voice ID)</label>
              <div class="form-select-wrapper">
                <input
                  type="text"
                  class="form-input"
                  id="settingsVoiceId"
                  placeholder="ä¾‹å¦‚: male-qn-qingse (é’æ¶©é’å¹´)"
                />
                <button class="form-btn-small" onclick="testCharacterVoice()">
                  è¯•å¬
                </button>
              </div>
              <div class="form-hint">è¯·å¡«å†™ MiniMax çš„éŸ³è‰² ID</div>
            </div>

            <!-- é€šè¯è®¾ç½® -->
            <div
              class="form-group"
              style="
                margin-top: 18px;
                padding-top: 18px;
                border-top: 1px dashed #eee;
              "
            >
              <label class="form-label"
                ><svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  style="vertical-align: middle; margin-right: 4px"
                >
                  <path
                    d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                  ></path></svg
                >é€šè¯è®¾ç½®</label
              >
              <div class="avatar-toggle-group" style="margin-top: 10px">
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="settingsCallVoiceEnabled"
                    onchange="saveCallSettings()"
                  />
                  <span class="toggle-label"
                    >é€šè¯æ¥å…¥è¯­éŸ³ (ä½¿ç”¨ä¸Šæ–¹Voice ID)</span
                  >
                </label>
              </div>
              <div class="avatar-toggle-group" style="margin-top: 8px">
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="settingsAiCallEnabled"
                    onchange="saveCallSettings()"
                  />
                  <span class="toggle-label">å…è®¸TAä¸»åŠ¨æ‰“ç”µè¯ç»™æˆ‘</span>
                </label>
              </div>
              <div class="form-hint" style="margin-top: 8px">
                å¼€å¯è¯­éŸ³åï¼Œé€šè¯ä¸­AIçš„å›å¤å°†è‡ªåŠ¨æœ—è¯»
              </div>

              <!-- è§†é¢‘é€šè¯ç”»é¢è®¾ç½® -->
              <div
                style="
                  margin-top: 16px;
                  padding-top: 16px;
                  border-top: 1px dashed #f0f0f0;
                "
              >
                <label class="form-label" style="font-size: 0.85rem"
                  ><svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    style="vertical-align: middle; margin-right: 4px"
                  >
                    <polygon points="23 7 16 12 23 17 23 7"></polygon>
                    <rect
                      x="1"
                      y="5"
                      width="15"
                      height="14"
                      rx="2"
                      ry="2"
                    ></rect></svg
                  >è§†é¢‘é€šè¯ç”»é¢</label
                >
                <div class="form-hint" style="margin-bottom: 10px">
                  è®¾ç½®è§†é¢‘é€šè¯æ—¶å¯¹æ–¹å’Œè‡ªå·±çš„ç”»é¢
                </div>

                <div style="display: flex; gap: 16px; margin-top: 12px">
                  <!-- å¯¹æ–¹ç”»é¢ -->
                  <div style="flex: 1; text-align: center">
                    <div
                      style="font-size: 0.8rem; color: #666; margin-bottom: 6px"
                    >
                      TAçš„ç”»é¢
                    </div>
                    <div
                      id="videoCallPartnerPreview"
                      style="
                        width: 80px;
                        height: 110px;
                        border-radius: 8px;
                        background: #f5f5f5;
                        margin: 0 auto;
                        overflow: hidden;
                        cursor: pointer;
                        border: 2px dashed #ddd;
                      "
                      onclick="document.getElementById('videoCallPartnerInput').click()"
                    >
                      <img
                        id="videoCallPartnerImg"
                        src=""
                        style="
                          width: 100%;
                          height: 100%;
                          object-fit: cover;
                          display: none;
                        "
                      />
                      <div
                        id="videoCallPartnerPlaceholder"
                        style="
                          height: 100%;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          color: #999;
                          font-size: 0.7rem;
                        "
                      >
                        ç‚¹å‡»è®¾ç½®
                      </div>
                    </div>
                    <input
                      type="file"
                      id="videoCallPartnerInput"
                      hidden
                      accept="image/*,video/*"
                      onchange="handleVideoCallImageUpload(this, 'partner')"
                    />
                    <button
                      onclick="clearVideoCallImage('partner')"
                      style="
                        margin-top: 6px;
                        font-size: 0.7rem;
                        padding: 2px 8px;
                        background: #f5f5f5;
                        border: none;
                        border-radius: 4px;
                        color: #999;
                      "
                    >
                      æ¸…é™¤
                    </button>
                  </div>

                  <!-- è‡ªå·±ç”»é¢ -->
                  <div style="flex: 1; text-align: center">
                    <div
                      style="font-size: 0.8rem; color: #666; margin-bottom: 6px"
                    >
                      æˆ‘çš„ç”»é¢
                    </div>
                    <div
                      id="videoCallSelfPreview"
                      style="
                        width: 80px;
                        height: 110px;
                        border-radius: 8px;
                        background: #f5f5f5;
                        margin: 0 auto;
                        overflow: hidden;
                        cursor: pointer;
                        border: 2px dashed #ddd;
                      "
                      onclick="document.getElementById('videoCallSelfInput').click()"
                    >
                      <img
                        id="videoCallSelfImg"
                        src=""
                        style="
                          width: 100%;
                          height: 100%;
                          object-fit: cover;
                          display: none;
                        "
                      />
                      <div
                        id="videoCallSelfPlaceholder"
                        style="
                          height: 100%;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          color: #999;
                          font-size: 0.7rem;
                        "
                      >
                        ç‚¹å‡»è®¾ç½®
                      </div>
                    </div>
                    <input
                      type="file"
                      id="videoCallSelfInput"
                      hidden
                      accept="image/*,video/*"
                      onchange="handleVideoCallImageUpload(this, 'self')"
                    />
                    <button
                      onclick="clearVideoCallImage('self')"
                      style="
                        margin-top: 6px;
                        font-size: 0.7rem;
                        padding: 2px 8px;
                        background: #f5f5f5;
                        border: none;
                        border-radius: 4px;
                        color: #999;
                      "
                    >
                      æ¸…é™¤
                    </button>
                  </div>
                </div>
              </div>

              <!-- é€šè¯æ°”æ³¡é¢œè‰²è®¾ç½® -->
              <div
                style="
                  margin-top: 16px;
                  padding-top: 16px;
                  border-top: 1px dashed #f0f0f0;
                "
              >
                <label class="form-label" style="font-size: 0.85rem"
                  >ğŸ’¬ é€šè¯æ°”æ³¡æ ·å¼</label
                >
                <div class="form-hint" style="margin-bottom: 10px">
                  è‡ªå®šä¹‰é€šè¯æ—¶æ¶ˆæ¯æ°”æ³¡çš„é¢œè‰²å’Œé€æ˜åº¦
                </div>

                <div
                  style="
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                    margin-top: 12px;
                  "
                >
                  <!-- ç”¨æˆ·æ°”æ³¡é¢œè‰² -->
                  <div style="display: flex; align-items: center; gap: 10px">
                    <span style="font-size: 0.8rem; color: #666; width: 70px"
                      >æˆ‘çš„æ°”æ³¡</span
                    >
                    <input
                      type="color"
                      id="settingsCallUserBubbleColor"
                      value="#f48fb1"
                      style="
                        width: 36px;
                        height: 28px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                      "
                      onchange="previewCallBubbleColor()"
                    />
                    <input
                      type="range"
                      id="settingsCallUserBubbleOpacity"
                      min="30"
                      max="100"
                      value="85"
                      style="flex: 1"
                      oninput="previewCallBubbleColor()"
                    />
                    <span
                      id="callUserOpacityLabel"
                      style="font-size: 0.75rem; color: #999; width: 35px"
                      >85%</span
                    >
                  </div>

                  <!-- AIæ°”æ³¡é¢œè‰² -->
                  <div style="display: flex; align-items: center; gap: 10px">
                    <span style="font-size: 0.8rem; color: #666; width: 70px"
                      >TAçš„æ°”æ³¡</span
                    >
                    <input
                      type="color"
                      id="settingsCallAiBubbleColor"
                      value="#ffffff"
                      style="
                        width: 36px;
                        height: 28px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                      "
                      onchange="previewCallBubbleColor()"
                    />
                    <input
                      type="range"
                      id="settingsCallAiBubbleOpacity"
                      min="30"
                      max="100"
                      value="85"
                      style="flex: 1"
                      oninput="previewCallBubbleColor()"
                    />
                    <span
                      id="callAiOpacityLabel"
                      style="font-size: 0.75rem; color: #999; width: 35px"
                      >85%</span
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Section 3: Memory Settings -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon teal">ğŸ’¾</div>
            <span class="section-title">è®°å¿†ä¸ä¸Šä¸‹æ–‡</span>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label"
                >è®°å¿†äº’é€š <span class="form-hint">(å¯å¤šé€‰)</span></label
              >
              <div class="memory-link-dropdown" id="memoryLinkDropdown">
                <div
                  class="memory-link-select"
                  onclick="toggleMemoryLinkDropdown()"
                >
                  <span class="memory-link-text" id="memoryLinkText"
                    >ç‚¹å‡»é€‰æ‹©è¦äº’é€šçš„è§’è‰²...</span
                  >
                  <span class="memory-link-arrow">â–¼</span>
                </div>
                <div class="memory-link-options" id="memoryLinkOptions">
                  <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
              </div>
              <div class="memory-link-tags" id="memoryLinkTags">
                <!-- å·²é€‰ä¸­çš„æ ‡ç­¾ -->
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">äº’é€šæ¡æ•°</label>
              <div class="number-input-row">
                <input
                  type="number"
                  class="number-input"
                  id="settingsMemoryCount"
                  value="5"
                  min="1"
                  max="50"
                />
                <span class="form-hint">æ¡æœ€è¿‘æ¶ˆæ¯</span>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">ä¸Šä¸‹æ–‡è®°å¿†æ¡æ•°</label>
              <div class="number-input-row">
                <input
                  type="number"
                  class="number-input"
                  id="settingsContextCount"
                  value="150"
                  min="10"
                  max="500"
                />
                <span class="form-hint">æ¡</span>
              </div>
            </div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 12px;
                padding: 10px 12px;
                background: #faf8f5;
                border-radius: 10px;
              "
            >
              <span style="font-size: 0.82rem; color: #9a8b7a"
                >æ€»æ¶ˆæ¯ï¼š<strong id="settingsTotalMsg">0</strong> æ¡</span
              >
              <span style="font-size: 0.82rem; color: #c4a87c"
                >tokenï¼š<strong id="settingsTokenCount">0</strong></span
              >
            </div>
          </div>
        </div>

        <!-- Section 4: Play Mode -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon orange">ğŸ®</div>
            <span class="section-title">ç©æ³•ä¸æ¨¡å¼</span>
          </div>
          <div class="section-body">
            <div class="toggle-row">
              <div>
                <div class="toggle-label">çº¿ä¸‹æ¨¡å¼ (Online Dating)</div>
                <div class="toggle-sublabel">æ¨¡æ‹ŸçœŸå®çº¦ä¼šåœºæ™¯</div>
              </div>
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  id="settingsOnlineDating"
                  onchange="toggleOfflineSettings()"
                />
                <span class="toggle-slider"></span>
              </label>
            </div>

            <!-- çº¿ä¸‹æ¨¡å¼é«˜çº§è®¾ç½® -->
            <div class="offline-word-settings" id="offlineWordSettings">
              <div class="offline-word-title">â˜… çº¿ä¸‹æ¨¡å¼è®¾ç½®</div>
              <div class="offline-word-row">
                <span
                  style="font-size: 0.82rem; color: #8d6e63; min-width: 60px"
                  >å›å¤å­—æ•°</span
                >
                <input
                  type="number"
                  class="offline-word-input"
                  id="offlineMinWords"
                  value="100"
                  min="10"
                  max="5000"
                />
                <span class="offline-word-sep">ï½</span>
                <input
                  type="number"
                  class="offline-word-input"
                  id="offlineMaxWords"
                  value="500"
                  min="10"
                  max="5000"
                />
                <span class="offline-word-unit">å­—</span>
              </div>
              <div class="offline-preset-select">
                <label
                  style="
                    font-size: 0.82rem;
                    color: #8d6e63;
                    display: block;
                    margin-bottom: 8px;
                  "
                  >åº”ç”¨é¢„è®¾</label
                >
                <select
                  class="offline-preset-dropdown"
                  id="offlinePresetSelect"
                >
                  <option value="">-- ä¸ä½¿ç”¨é¢„è®¾ --</option>
                </select>
              </div>
            </div>

            <div class="toggle-row">
              <div>
                <div class="toggle-label">é•¿æœŸè®°å¿†æ€»ç»“</div>
                <div class="toggle-sublabel">è‡ªåŠ¨æ€»ç»“é‡è¦å¯¹è¯</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="settingsLongMemory" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">æ€»ç»“æ¨¡å¼</label>
              <div class="radio-group">
                <div
                  class="radio-option"
                  data-value="auto"
                  onclick="selectRadio(this, 'summaryMode')"
                >
                  è‡ªåŠ¨æ€»ç»“
                </div>
                <div
                  class="radio-option active"
                  data-value="manual"
                  onclick="selectRadio(this, 'summaryMode')"
                >
                  æ‰‹åŠ¨æ€»ç»“
                </div>
              </div>
              <input type="hidden" id="settingsSummaryMode" value="manual" />
            </div>
            <div class="form-group">
              <label class="form-label">è§¦å‘æ¡æ•°</label>
              <div class="number-input-row">
                <input
                  type="number"
                  class="number-input"
                  id="settingsTriggerCount"
                  value="500"
                  min="50"
                  max="2000"
                />
                <span class="form-hint">æ¡æ¶ˆæ¯åè§¦å‘æ€»ç»“</span>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">æ€»ç»“æç¤ºè¯</label>
              <textarea
                class="form-input form-textarea"
                id="settingsSummaryPrompt"
                placeholder="è¯·ä»¥ç¬¬ä¸‰äººç§°çš„è§†è§’ï¼Œå®¢è§‚ã€å†·é™ã€ä¸å¸¦ä»»ä½•æ„Ÿæƒ…è‰²å½©åœ°æ€»ç»“ä»¥ä¸‹å¯¹è¯çš„æ ¸å¿ƒäº‹ä»¶å’Œä¿¡æ¯ã€‚ç¦æ­¢è¿›è¡Œä»»ä½•è§’è‰²æ‰®æ¼”æˆ–æ·»åŠ ä¸»è§‚è¯„è®ºã€‚"
              ></textarea>
            </div>
            <div class="action-buttons-grid" style="margin-top: 12px">
              <button class="action-btn" onclick="viewSummaries()">
                â‰¡ æŸ¥çœ‹/ç®¡ç†æ€»ç»“
              </button>
              <button class="action-btn" onclick="triggerManualSummary()">
                âœ ç«‹å³æ‰‹åŠ¨æ€»ç»“
              </button>
            </div>
            <div class="toggle-row" style="margin-top: 12px">
              <div>
                <div class="toggle-label">ç»­ç«èŠ±ç³»ç»Ÿ</div>
                <div class="toggle-sublabel">ä¿æŒå¯¹è¯çƒ­åº¦</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="settingsFlame" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="toggle-row">
              <div>
                <div class="toggle-label">å®æ—¶æ—¶é—´æ„ŸçŸ¥</div>
                <div class="toggle-sublabel">AIäº†è§£å½“å‰æ—¶é—´</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="settingsTimeAware" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>

        <!-- Section 5: Visual Customization -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon blue">ğŸ¨</div>
            <span class="section-title">ç¾åŒ–</span>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label">èŠå¤©èƒŒæ™¯</label>
              <div class="bg-preview-container">
                <div class="bg-preview-phone" id="bgPreview">
                  <span id="bgPreviewPlaceholder">æ— èƒŒæ™¯</span>
                  <img id="bgPreviewImg" src="" style="display: none" />
                </div>
                <button
                  class="bg-upload-btn"
                  onclick="document.getElementById('bgUploadInput').click()"
                >
                  â†‘ ç‚¹å‡»ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡
                </button>
                <input
                  type="file"
                  id="bgUploadInput"
                  class="hidden-input"
                  accept="image/*"
                  onchange="previewBackground(this)"
                />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">å­—ä½“å¤§å°</label>
              <div class="slider-row">
                <span class="slider-value" id="fontSizeValue">14px</span>
                <input
                  type="range"
                  id="settingsFontSize"
                  min="12"
                  max="20"
                  value="14"
                  oninput="updateFontSizePreview(this.value)"
                />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">èŠå¤©æ°”æ³¡æ ·å¼</label>
              <div class="form-hint" style="margin-bottom: 12px">
                è‡ªå®šä¹‰æ°”æ³¡èƒŒæ™¯ã€é€æ˜åº¦å’Œå­—ä½“é¢œè‰²
              </div>

              <!-- æˆ‘çš„æ°”æ³¡ -->
              <div
                style="
                  background: rgba(244, 143, 177, 0.1);
                  padding: 12px;
                  border-radius: 12px;
                  margin-bottom: 12px;
                "
              >
                <div
                  style="
                    font-size: 0.85rem;
                    color: #333;
                    font-weight: 500;
                    margin-bottom: 10px;
                  "
                >
                  ğŸ’¬ æˆ‘çš„æ°”æ³¡
                </div>

                <!-- èƒŒæ™¯é¢œè‰² -->
                <div style="margin-bottom: 10px">
                  <span
                    style="
                      font-size: 0.75rem;
                      color: #666;
                      display: block;
                      margin-bottom: 6px;
                    "
                    >èƒŒæ™¯é¢œè‰²</span
                  >
                  <div
                    style="
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      flex-wrap: wrap;
                    "
                  >
                    <div
                      class="color-preset-grid"
                      style="display: flex; gap: 4px; flex-wrap: wrap"
                    >
                      <div
                        class="color-preset"
                        style="background: #fce4ec"
                        onclick="setChatUserBubbleBg('#fce4ec')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #f8bbd9"
                        onclick="setChatUserBubbleBg('#f8bbd9')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #f48fb1"
                        onclick="setChatUserBubbleBg('#f48fb1')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #e1bee7"
                        onclick="setChatUserBubbleBg('#e1bee7')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #bbdefb"
                        onclick="setChatUserBubbleBg('#bbdefb')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #b2ebf2"
                        onclick="setChatUserBubbleBg('#b2ebf2')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #c8e6c9"
                        onclick="setChatUserBubbleBg('#c8e6c9')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #fff9c4"
                        onclick="setChatUserBubbleBg('#fff9c4')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #ffe0b2"
                        onclick="setChatUserBubbleBg('#ffe0b2')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #d7ccc8"
                        onclick="setChatUserBubbleBg('#d7ccc8')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #ffffff"
                        onclick="setChatUserBubbleBg('#ffffff')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #37474f"
                        onclick="setChatUserBubbleBg('#37474f')"
                      ></div>
                    </div>
                    <input
                      type="color"
                      id="settingsChatUserBubbleBg"
                      value="#f8bbd9"
                      class="color-picker-input"
                      onchange="previewChatBubbleStyle()"
                    />
                  </div>
                </div>

                <!-- é€æ˜åº¦ -->
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    margin-bottom: 10px;
                  "
                >
                  <span style="font-size: 0.75rem; color: #666; width: 50px"
                    >é€æ˜åº¦</span
                  >
                  <input
                    type="range"
                    id="settingsChatUserBubbleOpacity"
                    min="30"
                    max="100"
                    value="100"
                    style="flex: 1"
                    oninput="previewChatBubbleStyle(); document.getElementById('chatUserOpacityLabel').textContent=this.value+'%'"
                  />
                  <span
                    id="chatUserOpacityLabel"
                    style="font-size: 0.7rem; color: #999; width: 35px"
                    >100%</span
                  >
                </div>

                <!-- å­—ä½“é¢œè‰² -->
                <div>
                  <span
                    style="
                      font-size: 0.75rem;
                      color: #666;
                      display: block;
                      margin-bottom: 6px;
                    "
                    >å­—ä½“é¢œè‰²</span
                  >
                  <div
                    style="
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      flex-wrap: wrap;
                    "
                  >
                    <div
                      class="color-preset-grid"
                      style="display: flex; gap: 4px; flex-wrap: wrap"
                    >
                      <div
                        class="color-preset"
                        style="background: #c2185b"
                        onclick="setChatUserTextColor('#c2185b')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #e91e63"
                        onclick="setChatUserTextColor('#e91e63')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #7b1fa2"
                        onclick="setChatUserTextColor('#7b1fa2')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #512da8"
                        onclick="setChatUserTextColor('#512da8')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #1976d2"
                        onclick="setChatUserTextColor('#1976d2')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #0097a7"
                        onclick="setChatUserTextColor('#0097a7')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #388e3c"
                        onclick="setChatUserTextColor('#388e3c')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #f57c00"
                        onclick="setChatUserTextColor('#f57c00')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #5d4037"
                        onclick="setChatUserTextColor('#5d4037')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #37474f"
                        onclick="setChatUserTextColor('#37474f')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #ffffff"
                        onclick="setChatUserTextColor('#ffffff')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #000000"
                        onclick="setChatUserTextColor('#000000')"
                      ></div>
                    </div>
                    <input
                      type="color"
                      id="settingsChatUserTextColor"
                      value="#c2185b"
                      class="color-picker-input"
                      onchange="previewChatBubbleStyle()"
                    />
                  </div>
                </div>
              </div>

              <!-- TAçš„æ°”æ³¡ -->
              <div
                style="
                  background: rgba(0, 0, 0, 0.03);
                  padding: 12px;
                  border-radius: 12px;
                "
              >
                <div
                  style="
                    font-size: 0.85rem;
                    color: #333;
                    font-weight: 500;
                    margin-bottom: 10px;
                  "
                >
                  ğŸ’­ TAçš„æ°”æ³¡
                </div>

                <!-- èƒŒæ™¯é¢œè‰² -->
                <div style="margin-bottom: 10px">
                  <span
                    style="
                      font-size: 0.75rem;
                      color: #666;
                      display: block;
                      margin-bottom: 6px;
                    "
                    >èƒŒæ™¯é¢œè‰²</span
                  >
                  <div
                    style="
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      flex-wrap: wrap;
                    "
                  >
                    <div
                      class="color-preset-grid"
                      style="display: flex; gap: 4px; flex-wrap: wrap"
                    >
                      <div
                        class="color-preset"
                        style="background: #ffffff"
                        onclick="setChatAiBubbleBg('#ffffff')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #f5f5f5"
                        onclick="setChatAiBubbleBg('#f5f5f5')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #eeeeee"
                        onclick="setChatAiBubbleBg('#eeeeee')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #e0e0e0"
                        onclick="setChatAiBubbleBg('#e0e0e0')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #fce4ec"
                        onclick="setChatAiBubbleBg('#fce4ec')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #e3f2fd"
                        onclick="setChatAiBubbleBg('#e3f2fd')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #e8f5e9"
                        onclick="setChatAiBubbleBg('#e8f5e9')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #fff8e1"
                        onclick="setChatAiBubbleBg('#fff8e1')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #efebe9"
                        onclick="setChatAiBubbleBg('#efebe9')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #eceff1"
                        onclick="setChatAiBubbleBg('#eceff1')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #37474f"
                        onclick="setChatAiBubbleBg('#37474f')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #212121"
                        onclick="setChatAiBubbleBg('#212121')"
                      ></div>
                    </div>
                    <input
                      type="color"
                      id="settingsChatAiBubbleBg"
                      value="#ffffff"
                      class="color-picker-input"
                      onchange="previewChatBubbleStyle()"
                    />
                  </div>
                </div>

                <!-- é€æ˜åº¦ -->
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    margin-bottom: 10px;
                  "
                >
                  <span style="font-size: 0.75rem; color: #666; width: 50px"
                    >é€æ˜åº¦</span
                  >
                  <input
                    type="range"
                    id="settingsChatAiBubbleOpacity"
                    min="30"
                    max="100"
                    value="100"
                    style="flex: 1"
                    oninput="previewChatBubbleStyle(); document.getElementById('chatAiOpacityLabel').textContent=this.value+'%'"
                  />
                  <span
                    id="chatAiOpacityLabel"
                    style="font-size: 0.7rem; color: #999; width: 35px"
                    >100%</span
                  >
                </div>

                <!-- å­—ä½“é¢œè‰² -->
                <div>
                  <span
                    style="
                      font-size: 0.75rem;
                      color: #666;
                      display: block;
                      margin-bottom: 6px;
                    "
                    >å­—ä½“é¢œè‰²</span
                  >
                  <div
                    style="
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      flex-wrap: wrap;
                    "
                  >
                    <div
                      class="color-preset-grid"
                      style="display: flex; gap: 4px; flex-wrap: wrap"
                    >
                      <div
                        class="color-preset"
                        style="background: #333333"
                        onclick="setChatAiTextColor('#333333')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #37474f"
                        onclick="setChatAiTextColor('#37474f')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #455a64"
                        onclick="setChatAiTextColor('#455a64')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #616161"
                        onclick="setChatAiTextColor('#616161')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #212121"
                        onclick="setChatAiTextColor('#212121')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #1565c0"
                        onclick="setChatAiTextColor('#1565c0')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #2e7d32"
                        onclick="setChatAiTextColor('#2e7d32')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #ad1457"
                        onclick="setChatAiTextColor('#ad1457')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #6a1b9a"
                        onclick="setChatAiTextColor('#6a1b9a')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #5d4037"
                        onclick="setChatAiTextColor('#5d4037')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #ffffff"
                        onclick="setChatAiTextColor('#ffffff')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #000000"
                        onclick="setChatAiTextColor('#000000')"
                      ></div>
                    </div>
                    <input
                      type="color"
                      id="settingsChatAiTextColor"
                      value="#333333"
                      class="color-picker-input"
                      onchange="previewChatBubbleStyle()"
                    />
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">æ°”æ³¡æ ·å¼é¢„è®¾</label>
              <div class="form-select-wrapper">
                <select class="form-select" id="settingsBubbleStyle">
                  <option value="none">-- æ— é¢„è®¾ --</option>
                </select>
                <button class="form-btn-small" onclick="manageBubbleStyles()">
                  ç®¡ç†
                </button>
              </div>
            </div>
            <div class="action-buttons-grid">
              <button class="action-btn" onclick="exportBubbleStyle()">
                â†‘ å¯¼å‡º
              </button>
              <button class="action-btn" onclick="importBubbleStyle()">
                â†“ å¯¼å…¥
              </button>
            </div>
            <div class="form-group" style="margin-top: 16px">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <label class="form-label" style="margin-bottom: 0;">è‡ªå®šä¹‰CSS</label>
                <button class="form-btn-small" onclick="resetCustomCSS()">
                  é‡ç½®
                </button>
              </div>
              <div class="css-editor-container">
                <textarea
                  class="css-editor"
                  id="settingsCustomCSS"
                  placeholder="/* åœ¨æ­¤è¾“å…¥è‡ªå®šä¹‰CSSä»£ç  */"
                ></textarea>
              </div>
              <!-- ä¿å­˜æŒ‰é’®åŒºåŸŸ -->
              <div style="margin-top: 12px; display: flex; gap: 8px;">
                <button 
                  id="bubbleSavePresetBtn"
                  class="action-btn" 
                  onclick="saveOrUpdateBubblePreset()"
                  style="flex: 1; background: linear-gradient(135deg, #f8bbd9, #f48fb1); color: white; border: none;"
                >
                  <span id="bubbleSavePresetBtnText">ğŸ’¾ ä¿å­˜ä¸ºæ–°é¢„è®¾</span>
                </button>
                <button 
                  class="action-btn" 
                  onclick="saveAsNewBubblePreset()"
                  style="padding: 10px 14px; background: #fff; color: #f48fb1; border: 2px solid #f48fb1;"
                  title="å¦å­˜ä¸ºæ–°é¢„è®¾"
                >
                  ï¼‹
                </button>
              </div>
            </div>

            <!-- Chat Preview -->
            <div class="chat-preview-container">
              <div class="preview-label">å®æ—¶é¢„è§ˆ</div>
              <div class="preview-msg-row">
                <div class="preview-avatar" id="previewOtherAvatar">AI</div>
                <div>
                  <div class="preview-bubble" id="previewOtherBubble">
                    å¯¹æ–¹æ¶ˆæ¯é¢„è§ˆ
                  </div>
                  <div class="preview-time">10:00</div>
                </div>
              </div>
              <div class="preview-msg-row right">
                <div class="preview-avatar" id="previewMyAvatar">æˆ‘</div>
                <div>
                  <div class="preview-bubble" id="previewMyBubble">
                    æˆ‘çš„æ¶ˆæ¯é¢„è§ˆ
                  </div>
                  <div class="preview-time">10:00</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Section 6: Data & Operations -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon brown">ğŸ’¾</div>
            <span class="section-title">æ•°æ®ä¸æ“ä½œ</span>
          </div>
          <div class="section-body">
            <div class="action-buttons-grid">
              <button class="action-btn" onclick="importChatHistory()">
                ğŸ“¥ å¯¼å…¥èŠå¤©è®°å½•
              </button>
              <button class="action-btn" onclick="exportChatHistory()">
                ğŸ“¤ å¯¼å‡ºèŠå¤©è®°å½•
              </button>
            </div>
            <div style="border-top: 1px dashed #e5ddd3; margin: 20px 0"></div>
            <div class="action-buttons-grid">
              <button
                class="action-btn danger"
                onclick="clearChatHistoryFromSettings()"
              >
                ğŸ§¹ æ¸…ç©ºèŠå¤©
              </button>
              <button class="action-btn danger" onclick="blockCharacter()">
                ğŸš« æ‹‰é»‘å¯¹æ–¹
              </button>
            </div>
            <button
              class="action-btn danger"
              style="width: 100%; margin-top: 12px"
              onclick="deleteCharacterCompletely()"
            >
              ğŸ—‘ï¸ åˆ é™¤æ­¤è”ç³»äºº
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- å¤–éƒ¨è„šæœ¬ -->
    <script src="app.js"></script>
    <div
      class="context-menu-overlay"
      id="contextMenuOverlay"
      onclick="hideContextMenu()"
    >
      <div class="context-menu" id="contextMenu"></div>
    </div>

    <div class="selection-footer" id="selectionFooter">
      <button class="selection-btn cancel" onclick="exitSelectionMode()">
        å–æ¶ˆ
      </button>
      <span
        style="font-size: 0.9rem; font-weight: 600; color: #333"
        id="selectionCount"
        >å·²é€‰ 0 æ¡</span
      >
      <button
        class="selection-btn forward"
        onclick="showForwardModal()"
        style="
          background: linear-gradient(135deg, #81d4fa, #4fc3f7);
          color: #fff;
          padding: 8px 12px;
          border-radius: 8px;
          font-size: 0.85rem;
        "
      >
        â¤ è½¬å‘
      </button>
      <button
        class="selection-btn favorite"
        onclick="favoriteSelectedMessages()"
        style="
          background: linear-gradient(135deg, #f48fb1, #ec407a);
          color: #fff;
          padding: 8px 12px;
          border-radius: 8px;
          font-size: 0.85rem;
        "
      >
        â˜… æ”¶è—
      </button>
      <button
        class="selection-btn delete"
        id="multiDeleteBtn"
        onclick="deleteSelectedMessages()"
        style="padding: 8px 12px; font-size: 0.85rem"
      >
        âœ• åˆ é™¤
      </button>
    </div>

    <!-- è½¬å‘å¼¹çª— -->
    <div
      class="forward-modal-overlay"
      id="forwardModalOverlay"
      onclick="hideForwardModal()"
    >
      <div class="forward-modal" onclick="event.stopPropagation()">
        <div class="forward-modal-header">
          <span class="forward-modal-title">é€‰æ‹©è½¬å‘å¯¹è±¡</span>
          <button class="forward-modal-close" onclick="hideForwardModal()">
            âœ•
          </button>
        </div>
        <div class="forward-modal-content" id="forwardModalContent">
          <!-- åŠ¨æ€ç”ŸæˆèŠå¤©åˆ—è¡¨ -->
        </div>
      </div>
    </div>

    <!-- è½¬å‘è¯¦æƒ…å¼¹çª— -->
    <div
      class="forward-detail-overlay"
      id="forwardDetailOverlay"
      onclick="hideForwardDetail()"
    >
      <div class="forward-detail-modal" onclick="event.stopPropagation()">
        <div class="forward-detail-header">
          <span class="forward-detail-title" id="forwardDetailTitle"
            >èŠå¤©è®°å½•</span
          >
          <button class="forward-detail-close" onclick="hideForwardDetail()">
            âœ•
          </button>
        </div>
        <div class="forward-detail-content" id="forwardDetailContent">
          <!-- åŠ¨æ€ç”Ÿæˆæ¶ˆæ¯åˆ—è¡¨ -->
        </div>
      </div>
    </div>

    <!-- å¿ƒå£°å¼¹çª— -->
    <div
      class="heart-voice-overlay"
      id="heartVoiceOverlay"
      onclick="hideHeartVoice()"
    >
      <div class="heart-voice-modal" onclick="event.stopPropagation()">
        <div class="heart-voice-header">
          <span class="heart-voice-title">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
              ></path>
            </svg>
            å†…å¿ƒç‹¬ç™½
          </span>
          <button class="heart-voice-close" onclick="hideHeartVoice()">
            âœ•
          </button>
        </div>
        <div class="heart-voice-tabs">
          <button
            class="heart-voice-tab active"
            onclick="switchHeartTab('current')"
          >
            æ­¤åˆ»
          </button>
          <button class="heart-voice-tab" onclick="switchHeartTab('history')">
            å¾€æ˜”
          </button>
        </div>
        <div class="heart-voice-content" id="heartVoiceContent">
          <!-- åŠ¨æ€ç”Ÿæˆå¿ƒå£°å†…å®¹ -->
        </div>
      </div>
    </div>

    <!-- æ”¶è—é¡µé¢ -->
    <div class="favorites-page" id="favoritesPage">
      <div class="favorites-header">
        <button class="favorites-back" onclick="closeFavoritesPage()">â€¹</button>
        <span class="favorites-title">æˆ‘çš„æ”¶è—</span>
        <button class="favorites-add-group" onclick="addFavoriteGroup()">
          + æ–°å»ºåˆ†ç»„
        </button>
      </div>
      <div class="favorites-tabs" id="favoritesTabs">
        <!-- åŠ¨æ€ç”Ÿæˆåˆ†ç»„æ ‡ç­¾ -->
      </div>
      <div class="favorites-content">
        <div class="favorites-list" id="favoritesList">
          <!-- åŠ¨æ€ç”Ÿæˆæ”¶è—åˆ—è¡¨ -->
        </div>
      </div>
    </div>

    <!-- åå°æ´»åŠ¨è®¾ç½®é¡µé¢ -->
    <div class="favorites-page" id="backgroundActivityPage">
      <div class="favorites-header">
        <button class="favorites-back" onclick="closeBackgroundActivityPage()">
          â€¹
        </button>
        <span class="favorites-title">åå°æ´»åŠ¨</span>
        <span style="width: 80px"></span>
      </div>
      <div
        style="
          padding: 16px;
          overflow-y: auto;
          height: calc(100% - 56px);
          background: linear-gradient(180deg, #fef8fa 0%, #fff 100%);
        "
      >
        <!-- æ€»å¼€å…³ -->
        <div
          style="
            background: linear-gradient(135deg, #fff 0%, #fff5f8 100%);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 14px;
            box-shadow: 0 2px 12px rgba(236, 64, 122, 0.1);
            border: 1px solid rgba(236, 64, 122, 0.08);
          "
        >
          <div
            style="
              display: flex;
              align-items: center;
              justify-content: space-between;
            "
          >
            <div>
              <div style="font-weight: 600; color: #ad1457; font-size: 1rem">
                å¯ç”¨åå°æ´»åŠ¨
              </div>
              <div
                style="
                  font-size: 0.8rem;
                  color: #e91e63;
                  margin-top: 6px;
                  opacity: 0.7;
                "
              >
                AIè§’è‰²ä¼šä¸»åŠ¨å‘æ¶ˆæ¯ã€å‘åŠ¨æ€ã€äº’åŠ¨
              </div>
            </div>
            <div
              id="bgActivityToggleBtn"
              onclick="toggleBackgroundActivityEnabled()"
              style="
                width: 52px;
                height: 30px;
                border-radius: 15px;
                background: #e0e0e0;
                position: relative;
                cursor: pointer;
                transition: all 0.3s;
                box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
              "
            >
              <div
                style="
                  width: 26px;
                  height: 26px;
                  border-radius: 50%;
                  background: #fff;
                  position: absolute;
                  top: 2px;
                  left: 2px;
                  transition: all 0.3s;
                  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
                "
              ></div>
            </div>
          </div>
        </div>

        <!-- æ£€æŸ¥é—´éš” -->
        <div
          style="
            background: linear-gradient(135deg, #fff 0%, #fff5f8 100%);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 14px;
            box-shadow: 0 2px 12px rgba(236, 64, 122, 0.1);
            border: 1px solid rgba(236, 64, 122, 0.08);
          "
        >
          <div style="font-weight: 600; color: #ad1457; margin-bottom: 12px">
            â±ï¸ æ£€æŸ¥é—´éš”ï¼ˆç§’ï¼‰
          </div>
          <input
            type="number"
            id="bgActivityInterval"
            value="60"
            min="30"
            max="600"
            style="
              width: 100%;
              padding: 14px;
              border: 2px solid rgba(236, 64, 122, 0.2);
              border-radius: 12px;
              font-size: 1rem;
              box-sizing: border-box;
              background: #fff;
              color: #333;
              transition: all 0.2s;
            "
            onfocus="this.style.borderColor='#f48fb1';this.style.boxShadow='0 0 0 3px rgba(244,143,177,0.2)'"
            onblur="this.style.borderColor='rgba(236,64,122,0.2)';this.style.boxShadow='none'"
            onchange="updateBackgroundActivityInterval()"
          />
          <div
            style="
              font-size: 0.75rem;
              color: #e91e63;
              margin-top: 10px;
              opacity: 0.7;
            "
          >
            æ¯éš”å¤šå°‘ç§’æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦è§¦å‘åå°æ´»åŠ¨ï¼ˆ30-600ç§’ï¼‰
          </div>
        </div>

        <!-- è§’è‰²é¢‘ç‡è®¾ç½® -->
        <div
          style="
            background: linear-gradient(135deg, #fff 0%, #fff5f8 100%);
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 2px 12px rgba(236, 64, 122, 0.1);
            border: 1px solid rgba(236, 64, 122, 0.08);
          "
        >
          <div style="font-weight: 600; color: #ad1457; margin-bottom: 10px">
            ğŸ‘¥ è§’è‰²æ´»åŠ¨é¢‘ç‡
          </div>
          <div
            style="
              font-size: 0.75rem;
              color: #666;
              margin-bottom: 16px;
              line-height: 1.6;
              background: rgba(236, 64, 122, 0.05);
              padding: 12px;
              border-radius: 10px;
            "
          >
            <span style="color: #e91e63">â—</span> å…³é—­ = ä¸å‚ä¸åå°æ´»åŠ¨<br />
            <span style="color: #f48fb1">â—</span> ä½é¢‘ = æ¯æ¬¡æ£€æŸ¥20%æ¦‚ç‡<br />
            <span style="color: #ec407a">â—</span> ä¸­é¢‘ = æ¯æ¬¡æ£€æŸ¥40%æ¦‚ç‡<br />
            <span style="color: #c2185b">â—</span> é«˜é¢‘ = æ¯æ¬¡æ£€æŸ¥70%æ¦‚ç‡
          </div>
          <div
            id="bgActivityCharList"
            style="display: flex; flex-direction: column; gap: 12px"
          >
            <!-- åŠ¨æ€ç”Ÿæˆè§’è‰²åˆ—è¡¨ -->
          </div>
        </div>

        <!-- æ‰‹åŠ¨æµ‹è¯•æŒ‰é’® -->
        <div
          style="
            background: linear-gradient(135deg, #fff 0%, #fff5f8 100%);
            border-radius: 16px;
            padding: 18px;
            margin-top: 14px;
            box-shadow: 0 2px 12px rgba(236, 64, 122, 0.1);
            border: 1px solid rgba(236, 64, 122, 0.08);
          "
        >
          <div style="font-weight: 600; color: #ad1457; margin-bottom: 12px">
            ğŸ§ª æµ‹è¯•
          </div>
          <button
            onclick="testBackgroundActivity()"
            style="
              width: 100%;
              padding: 14px;
              background: linear-gradient(135deg, #f48fb1, #ec407a);
              color: #fff;
              border: none;
              border-radius: 12px;
              font-size: 1rem;
              font-weight: 500;
              cursor: pointer;
              box-shadow: 0 4px 12px rgba(236, 64, 122, 0.3);
              transition: all 0.2s;
            "
            onmousedown="this.style.transform='scale(0.98)';this.style.boxShadow='0 2px 6px rgba(236,64,122,0.3)'"
            onmouseup="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(236,64,122,0.3)'"
            ontouchstart="this.style.transform='scale(0.98)';this.style.boxShadow='0 2px 6px rgba(236,64,122,0.3)'"
            ontouchend="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(236,64,122,0.3)'"
          >
            âœ¨ ç«‹å³è§¦å‘ä¸€æ¬¡åå°æ´»åŠ¨
          </button>
          <div
            style="
              font-size: 0.75rem;
              color: #e91e63;
              margin-top: 10px;
              text-align: center;
              opacity: 0.7;
            "
          >
            éšæœºé€‰æ‹©ä¸€ä¸ªå·²å¯ç”¨çš„è§’è‰²æ‰§è¡Œåå°æ´»åŠ¨
          </div>
        </div>
      </div>
    </div>

    <!-- æ”¶è—åˆ†ç»„é€‰æ‹©å¼¹çª— -->
    <div
      class="favorite-group-modal"
      id="favoriteGroupModal"
      onclick="if(event.target===this)closeFavoriteGroupModal()"
    >
      <div class="favorite-group-content">
        <div class="favorite-group-header">é€‰æ‹©æ”¶è—åˆ†ç»„</div>
        <div class="favorite-group-list" id="favoriteGroupList">
          <!-- åŠ¨æ€ç”Ÿæˆåˆ†ç»„åˆ—è¡¨ -->
        </div>
        <div class="favorite-group-add" onclick="addNewGroupInModal()">
          <span>+</span>
          <span>æ–°å»ºåˆ†ç»„</span>
        </div>
        <div class="favorite-group-footer">
          <button
            class="favorite-group-btn cancel"
            onclick="closeFavoriteGroupModal()"
          >
            å–æ¶ˆ
          </button>
          <button
            class="favorite-group-btn confirm"
            onclick="confirmFavorite()"
          >
            ç¡®å®š
          </button>
        </div>
      </div>
    </div>

    <!-- æ–°æ¶ˆæ¯é€šçŸ¥å¼¹çª— -->
    <div
      class="message-notification"
      id="messageNotification"
      onclick="handleNotificationClick()"
    >
      <div class="notification-avatar" id="notificationAvatar">AI</div>
      <div class="notification-content">
        <div class="notification-name" id="notificationName">è§’è‰²å</div>
        <div class="notification-text" id="notificationText">æ¶ˆæ¯å†…å®¹</div>
      </div>
      <div class="notification-time" id="notificationTime">åˆšåˆš</div>
    </div>

    <!-- é’±åŒ…è¯¦æƒ…é¡µ - Apple Wallet é£æ ¼ -->
    <div class="wallet-page" id="walletPage">
      <!-- æ‚¬æµ®å…³é—­æŒ‰é’® -->
      <button class="wallet-close-btn" onclick="closeWalletPage()">
        <svg
          width="16"
          height="16"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2.5"
          stroke-linecap="round"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>

      <div class="wallet-page-content">
        <!-- é“¶è¡Œå¡æ ·å¼ -->
        <div class="apple-wallet-card">
          <div class="card-top-row">
            <div class="card-chip">
              <svg viewBox="0 0 50 40" width="36" height="28">
                <rect
                  x="0"
                  y="0"
                  width="50"
                  height="40"
                  rx="5"
                  fill="rgba(255,255,255,0.3)"
                />
                <rect
                  x="0"
                  y="12"
                  width="50"
                  height="5"
                  fill="rgba(255,255,255,0.5)"
                />
                <rect
                  x="0"
                  y="22"
                  width="50"
                  height="5"
                  fill="rgba(255,255,255,0.5)"
                />
                <rect
                  x="18"
                  y="0"
                  width="5"
                  height="40"
                  fill="rgba(255,255,255,0.4)"
                />
                <rect
                  x="27"
                  y="0"
                  width="5"
                  height="40"
                  fill="rgba(255,255,255,0.4)"
                />
              </svg>
            </div>
            <div class="card-type-label">å‚¨è“„å¡</div>
          </div>

          <div class="card-balance-section">
            <div class="card-balance-label">è´¦æˆ·ä½™é¢</div>
            <div class="card-balance-amount">
              <span class="currency-symbol">Â¥</span>
              <span id="walletBalanceDisplay">0.00</span>
            </div>
          </div>

          <div class="card-bottom-row">
            <div class="card-number">â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ 8888</div>
            <button class="card-recharge-btn" onclick="openRechargeModal()">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              å……å€¼
            </button>
          </div>
        </div>

        <!-- äº¤æ˜“è®°å½• -->
        <div class="apple-wallet-transactions">
          <div class="transactions-title">äº¤æ˜“è®°å½•</div>
          <div class="transactions-list" id="walletHistoryListPage">
            <div class="wallet-history-empty">æš‚æ— äº¤æ˜“è®°å½•</div>
          </div>
        </div>
      </div>
    </div>
    <!-- åˆ é™¤äº¤æ˜“è®°å½•å¼¹çª— -->
    <div
      class="recharge-modal"
      id="deleteHistoryModal"
      onclick="if(event.target===this)closeDeleteHistoryModal()"
    >
      <div class="recharge-modal-content" style="padding: 20px">
        <div class="recharge-modal-title" style="margin-bottom: 16px">
          ğŸ—‘ï¸ åˆ é™¤äº¤æ˜“è®°å½•
        </div>
        <div
          id="deleteHistoryInfo"
          style="
            background: #f5f5f5;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-size: 0.9rem;
          "
        >
          <!-- åŠ¨æ€å¡«å…… -->
        </div>
        <div style="margin-bottom: 16px">
          <label
            style="
              display: flex;
              align-items: center;
              gap: 10px;
              padding: 12px;
              background: #fff5f5;
              border-radius: 10px;
              cursor: pointer;
            "
          >
            <input
              type="checkbox"
              id="deleteAdjustBalance"
              style="width: 18px; height: 18px; accent-color: #ec407a"
            />
            <div>
              <div style="font-weight: 500; color: #333">åŒæ—¶è°ƒæ•´ä½™é¢</div>
              <div style="font-size: 0.8rem; color: #999">
                å‹¾é€‰åå°†æ’¤é”€è¿™ç¬”äº¤æ˜“å¯¹ä½™é¢çš„å½±å“
              </div>
            </div>
          </label>
        </div>
        <div style="display: flex; gap: 12px">
          <button
            onclick="closeDeleteHistoryModal()"
            style="
              flex: 1;
              padding: 12px;
              border-radius: 10px;
              border: 1px solid #ddd;
              background: #fff;
              font-size: 0.95rem;
              cursor: pointer;
            "
          >
            å–æ¶ˆ
          </button>
          <button
            onclick="confirmDeleteHistory()"
            style="
              flex: 1;
              padding: 12px;
              border-radius: 10px;
              border: none;
              background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
              color: #fff;
              font-size: 0.95rem;
              cursor: pointer;
            "
          >
            åˆ é™¤
          </button>
        </div>
      </div>
    </div>

    <!-- å……å€¼å¼¹çª— -->
    <div
      class="recharge-modal"
      id="rechargeModal"
      onclick="if(event.target===this)closeRechargeModal()"
    >
      <div class="recharge-modal-content">
        <div class="recharge-modal-title">Â¥ é’±åŒ…å……å€¼</div>
        <div class="recharge-amount-grid">
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(10)"
          >
            Â¥10
          </button>
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(50)"
          >
            Â¥50
          </button>
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(100)"
          >
            Â¥100
          </button>
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(200)"
          >
            Â¥200
          </button>
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(500)"
          >
            Â¥500
          </button>
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(1000)"
          >
            Â¥1000
          </button>
        </div>
        <input
          type="number"
          class="recharge-custom-input"
          id="rechargeCustomAmount"
          placeholder="è‡ªå®šä¹‰é‡‘é¢"
          oninput="clearRechargeSelection()"
        />
        <div class="recharge-modal-btns">
          <button
            class="recharge-modal-btn cancel"
            onclick="closeRechargeModal()"
          >
            å–æ¶ˆ
          </button>
          <button
            class="recharge-modal-btn confirm"
            onclick="confirmRecharge()"
          >
            ç¡®è®¤å……å€¼
          </button>
        </div>
      </div>
    </div>

    <!-- è½¬è´¦å¼¹çª— -->
    <div
      class="send-transfer-modal"
      id="sendTransferModal"
      onclick="if(event.target===this)closeTransferModal()"
    >
      <div class="send-transfer-modal-content">
        <div class="send-transfer-title">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="vertical-align: middle; margin-right: 6px"
          >
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path
              d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
            ></path></svg
          >è½¬è´¦ç»™TA
        </div>
        <div class="send-transfer-to" id="transferToName">è½¬ç»™ï¼šè§’è‰²å</div>
        <!-- ç¾¤èŠæˆå‘˜é€‰æ‹©åˆ—è¡¨ -->
        <div
          id="transferMemberSelect"
          style="
            display: none;
            margin: 12px 0;
            max-height: 150px;
            overflow-y: auto;
          "
        ></div>
        <input
          type="number"
          class="send-transfer-input"
          id="transferAmountInput"
          placeholder="0.00"
        />
        <div class="send-transfer-balance" id="transferBalanceHint">
          å¯ç”¨ä½™é¢ï¼šÂ¥0.00
        </div>
        <input
          type="text"
          class="send-transfer-note-input"
          id="transferNoteInput"
          placeholder="æ·»åŠ è½¬è´¦è¯´æ˜ï¼ˆå¯é€‰ï¼‰"
        />
        <div class="recharge-modal-btns">
          <button
            class="recharge-modal-btn cancel"
            onclick="closeTransferModal()"
          >
            å–æ¶ˆ
          </button>
          <button
            class="recharge-modal-btn confirm"
            onclick="confirmTransfer()"
          >
            ç¡®è®¤è½¬è´¦
          </button>
        </div>
      </div>
    </div>

    <!-- ä½ç½®é€‰æ‹©å¼¹çª— -->
    <div
      class="send-transfer-modal"
      id="locationModal"
      onclick="if(event.target===this)closeLocationModal()"
    >
      <div class="send-transfer-modal-content">
        <div class="send-transfer-title">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="vertical-align: middle; margin-right: 6px"
          >
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle></svg
          >å‘é€ä½ç½®
        </div>
        <div style="margin-bottom: 16px">
          <input
            type="text"
            class="send-transfer-note-input"
            id="locationNameInput"
            placeholder="ä½ç½®åç§°ï¼Œå¦‚ï¼šæ˜Ÿå·´å…‹å’–å•¡"
            style="margin-bottom: 8px"
          />
          <input
            type="text"
            class="send-transfer-note-input"
            id="locationAddressInput"
            placeholder="è¯¦ç»†åœ°å€ï¼ˆå¯é€‰ï¼‰"
          />
        </div>
        <div class="recharge-modal-btns">
          <button
            class="recharge-modal-btn cancel"
            onclick="closeLocationModal()"
          >
            å–æ¶ˆ
          </button>
          <button
            class="recharge-modal-btn confirm"
            onclick="confirmSendLocation()"
          >
            å‘é€ä½ç½®
          </button>
        </div>
      </div>
    </div>

    <!-- é€šè¯æ‚¬æµ®çƒ -->
    <div
      class="call-floating-bubble"
      id="callFloatingBubble"
      onclick="restoreCall()"
    >
      <span id="floatingBubbleAvatar"
        ><svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
          ></path></svg
      ></span>
      <img id="floatingBubbleImg" src="" style="display: none" />
    </div>

    <!-- é€šè¯ç•Œé¢ -->
    <div class="call-overlay voice-call" id="callOverlay">
      <!-- è§†é¢‘é€šè¯ - å¯¹æ–¹ç”»é¢ï¼ˆå…¨å±ï¼‰ -->
      <div class="video-main" id="videoMain" onclick="toggleVideoSelf()">
        <img id="videoMainImg" src="" style="display: none" />
        <div class="video-main-placeholder" id="videoMainPlaceholder">
          <div class="avatar-large">
            <span id="videoMainAvatarPlaceholder">AI</span>
            <img id="videoMainAvatarImg" src="" style="display: none" />
          </div>
          <span id="videoMainName">ç­‰å¾…æ¥é€š...</span>
        </div>
      </div>

      <!-- è§†é¢‘é€šè¯ - æˆ‘çš„ç”»é¢ï¼ˆå°çª—å£ï¼Œå¯ç‚¹å‡»åˆ‡æ¢ï¼‰ -->
      <div class="video-self" id="videoSelf" onclick="toggleVideoSelf()">
        <img id="videoSelfImg" src="" style="display: none" />
        <div class="video-self-placeholder" id="videoSelfPlaceholder">æˆ‘</div>
      </div>

      <!-- æ–°çš„é¡¶éƒ¨æ  - å·¦è¾¹æœ€å°åŒ–æŒ‰é’®ï¼Œä¸­é—´å¤´åƒ+åå­—+æ—¶é—´ -->
      <div class="call-top-bar" id="callTopBar">
        <button
          class="call-minimize-btn"
          onclick="minimizeCall()"
          title="æœ€å°åŒ–"
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="4 14 10 14 10 20"></polyline>
            <polyline points="20 10 14 10 14 4"></polyline>
            <line x1="14" y1="10" x2="21" y2="3"></line>
            <line x1="3" y1="21" x2="10" y2="14"></line>
          </svg>
        </button>
        <div class="call-top-info">
          <div class="call-top-avatar" id="callTopAvatar">
            <span id="callTopAvatarPlaceholder">AI</span>
            <img id="callTopAvatarImg" src="" style="display: none" />
          </div>
          <div class="call-top-name" id="callTopName">è§’è‰²å</div>
          <div class="call-top-timer" id="callTopTimer">æ­£åœ¨å‘¼å«...</div>
        </div>
      </div>

      <!-- æ—§çš„å¤´åƒåŒºåŸŸï¼ˆéšè—ï¼‰ -->
      <div
        class="call-avatar-section"
        id="callAvatarSection"
        style="display: none"
      >
        <div class="call-avatar" id="callAvatar">
          <span id="callAvatarPlaceholder">AI</span>
          <img id="callAvatarImg" src="" style="display: none" />
        </div>
        <div class="call-name" id="callName">è§’è‰²å</div>
        <div class="call-status" id="callStatus">æ­£åœ¨å‘¼å«...</div>
        <div class="call-timer" id="callTimer" style="display: none">00:00</div>
      </div>

      <!-- éšè—çš„å…¼å®¹å…ƒç´  -->
      <span id="videoCallTimer" style="display: none">00:00</span>
      <span id="videoCallName" style="display: none"></span>

      <!-- å¯¹è¯åŒºåŸŸ -->
      <div class="call-conversation" id="callConversation">
        <div class="call-messages-wrapper" id="callMessagesWrapper">
          <!-- æ¶ˆæ¯ä¼šåŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
        </div>
        <!-- AIæ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨ -->
        <div class="call-typing-indicator" id="callTypingIndicator">
          <span></span><span></span><span></span>
        </div>
      </div>

      <!-- è¾“å…¥åŒºåŸŸ -->
      <div class="call-input-area" id="callInputArea">
        <div class="call-input-row">
          <textarea
            class="call-input"
            id="callInput"
            placeholder="è¯´ç‚¹ä»€ä¹ˆ..."
            rows="1"
            onkeydown="handleCallInputKeydown(event)"
          ></textarea>
          <button class="call-send-btn" onclick="sendCallMessage()">
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </div>
      </div>

      <!-- æŒ‰é’®åŒºåŸŸ -->
      <div class="call-buttons-area">
        <!-- å‘¼å«ä¸­çš„æŒ‰é’® -->
        <div class="call-buttons" id="callCallingBtns">
          <button class="call-btn end-call" onclick="endCall()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
        </div>

        <!-- æ¥ç”µçš„æŒ‰é’® -->
        <div
          class="call-incoming-buttons"
          id="callIncomingBtns"
          style="display: none"
        >
          <button class="call-btn end-call" onclick="declineCall()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
          <button class="call-btn accept-call" onclick="acceptCall()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
        </div>

        <!-- é€šè¯ä¸­çš„æŒ‰é’® - é‡å›ã€æŒ‚æ–­ã€æ‰¬å£°å™¨ -->
        <div class="call-buttons" id="callInCallBtns" style="display: none">
          <button
            class="call-btn reroll-btn"
            onclick="rerollCallResponse()"
            title="é‡æ–°å›å¤"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="23 4 23 10 17 10"></polyline>
              <polyline points="1 20 1 14 7 14"></polyline>
              <path
                d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
              ></path>
            </svg>
          </button>
          <button class="call-btn end-call" onclick="endCall()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
          <button
            class="call-btn speaker-btn"
            id="speakerBtn"
            onclick="toggleSpeaker()"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
              <path
                d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- æ¥ç”µå…¨å±ç•Œé¢ -->
    <div class="incoming-call-overlay" id="incomingCallOverlay">
      <div class="incoming-call-top">
        <div class="incoming-call-label">æ¥ç”µ</div>
        <div class="incoming-call-avatar-wrap">
          <div class="incoming-call-ring"></div>
          <div class="incoming-call-ring"></div>
          <div class="incoming-call-ring"></div>
          <div class="incoming-call-avatar" id="incomingCallAvatar">
            <span id="incomingCallAvatarPlaceholder">AI</span>
            <img id="incomingCallAvatarImg" src="" style="display: none" />
          </div>
        </div>
        <div class="incoming-call-name" id="incomingCallName">è§’è‰²å</div>
        <div class="incoming-call-type" id="incomingCallType">
          <span class="incoming-call-type-icon" id="incomingCallTypeIcon"
            ><svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path></svg
          ></span>
          <span id="incomingCallTypeText">è¯­éŸ³é€šè¯</span>
        </div>
      </div>

      <div class="incoming-call-actions">
        <div class="incoming-call-btn-wrap">
          <button
            class="incoming-call-btn decline"
            onclick="declineIncomingCall()"
          >
            <svg
              width="28"
              height="28"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
          <span class="incoming-call-btn-label">æ‹’ç»</span>
        </div>
        <div class="incoming-call-btn-wrap">
          <button
            class="incoming-call-btn accept"
            onclick="acceptIncomingCall()"
          >
            <svg
              width="28"
              height="28"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
          <span class="incoming-call-btn-label">æ¥å¬</span>
        </div>
      </div>
    </div>

    <!-- å‘é€å›¾ç‰‡é€‰æ‹©å¼¹çª— -->
    <div
      class="send-image-modal"
      id="sendImageModal"
      onclick="if(event.target===this)closeSendImageModal()"
    >
      <div class="send-image-options">
        <div class="send-image-title">å‘é€å›¾ç‰‡</div>
        <div class="send-image-grid two-cols">
          <div class="send-image-item" onclick="selectRealImage()">
            <div class="send-image-icon album">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
            </div>
            <span class="send-image-label">é€‰æ‹©å›¾ç‰‡</span>
            <span class="send-image-hint">ç›¸å†Œ/æ‹ç…§/æ–‡ä»¶</span>
          </div>
          <div class="send-image-item" onclick="openDescImageModal()">
            <div class="send-image-icon desc">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                ></path>
                <path
                  d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                ></path>
              </svg>
            </div>
            <span class="send-image-label">æè¿°å›¾</span>
            <span class="send-image-hint">ç”¨æ–‡å­—æè¿°å›¾ç‰‡</span>
          </div>
        </div>
        <button class="send-image-cancel" onclick="closeSendImageModal()">
          å–æ¶ˆ
        </button>
      </div>
    </div>

    <!-- è¯­éŸ³æ¶ˆæ¯å¼¹çª— -->
    <div
      class="send-image-modal"
      id="voiceMessageModal"
      onclick="if(event.target===this)closeVoiceMessageModal()"
    >
      <div class="send-image-options" style="max-width: 320px">
        <div class="send-image-title">ğŸ¤ å‘é€è¯­éŸ³æ¶ˆæ¯</div>
        <div style="padding: 0 20px 20px">
          <div
            style="
              width: 60px;
              height: 60px;
              margin: 0 auto 16px;
              background: linear-gradient(135deg, #fce4ec, #f8bbd9);
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            <svg
              width="30"
              height="30"
              viewBox="0 0 24 24"
              fill="none"
              stroke="#ec407a"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"
              ></path>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
              <line x1="12" y1="19" x2="12" y2="23"></line>
              <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
          </div>
          <textarea
            id="voiceMessageInput"
            placeholder="è¾“å…¥ä½ æƒ³è¯´çš„è¯..."
            style="
              width: 100%;
              height: 80px;
              border: 2px solid rgba(236, 64, 122, 0.2);
              border-radius: 12px;
              padding: 12px;
              font-size: 1rem;
              resize: none;
              box-sizing: border-box;
              outline: none;
              font-family: inherit;
            "
            onfocus="this.style.borderColor='#f48fb1'"
            onblur="this.style.borderColor='rgba(236,64,122,0.2)'"
          ></textarea>
          <div
            style="
              text-align: center;
              font-size: 0.8rem;
              color: #999;
              margin: 10px 0 16px;
            "
          >
            è¾“å…¥å†…å®¹ä¼šè½¬æ¢æˆè¯­éŸ³æ¶ˆæ¯å‘é€
          </div>
          <div style="display: flex; gap: 12px">
            <button
              onclick="closeVoiceMessageModal()"
              style="
                flex: 1;
                padding: 12px;
                border-radius: 12px;
                font-size: 1rem;
                background: #f5f5f5;
                color: #666;
                border: none;
                cursor: pointer;
              "
            >
              å–æ¶ˆ
            </button>
            <button
              onclick="sendVoiceMessage()"
              style="
                flex: 1;
                padding: 12px;
                border-radius: 12px;
                font-size: 1rem;
                background: linear-gradient(135deg, #f48fb1, #ec407a);
                color: #fff;
                border: none;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(236, 64, 122, 0.3);
              "
            >
              å‘é€è¯­éŸ³
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- å›¾ç‰‡æè¿°æŸ¥çœ‹/ç¼–è¾‘å¼¹çª— -->
    <div
      class="image-desc-modal"
      id="imageDescModal"
      onclick="if(event.target===this)closeImageDescModal()"
    >
      <div class="image-desc-content">
        <div class="image-desc-header">
          <span class="image-desc-title" id="imageDescTitle">å›¾ç‰‡æè¿°</span>
          <button class="image-desc-close" onclick="closeImageDescModal()">
            âœ•
          </button>
        </div>
        <div class="image-desc-body">
          <div class="image-desc-preview" id="imageDescPreview">
            <div class="image-desc-preview-icon">
              <svg
                width="40"
                height="40"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
              <span style="font-size: 0.8rem">ç‚¹å‡»æŸ¥çœ‹æè¿°</span>
            </div>
          </div>
          <!-- æŸ¥çœ‹æ¨¡å¼ -->
          <div
            class="image-desc-text"
            id="imageDescText"
            style="display: none"
          ></div>
          <!-- ç¼–è¾‘æ¨¡å¼ -->
          <textarea
            class="image-desc-input"
            id="imageDescInput"
            placeholder="æè¿°è¿™å¼ å›¾ç‰‡çš„å†…å®¹...&#10;ä¾‹å¦‚ï¼šä¸€å¼ å¤•é˜³ä¸‹æµ·è¾¹çš„ç…§ç‰‡ï¼Œé‡‘è‰²çš„é˜³å…‰æ´’åœ¨æµ·é¢ä¸Š..."
            style="display: none"
          ></textarea>
        </div>
        <div
          class="image-desc-footer"
          id="imageDescFooter"
          style="display: none"
        >
          <button class="image-desc-btn cancel" onclick="closeImageDescModal()">
            å–æ¶ˆ
          </button>
          <button
            class="image-desc-btn confirm"
            onclick="confirmSendDescImage()"
          >
            å‘é€
          </button>
        </div>
      </div>
    </div>

    <!-- å›¾ç‰‡æŸ¥çœ‹å¼¹çª— -->
    <div
      class="image-desc-modal"
      id="imageViewModal"
      onclick="closeImageViewModal()"
    >
      <div style="max-width: 90%; max-height: var(--vh-80)">
        <img
          id="imageViewImg"
          src=""
          style="max-width: 100%; max-height: var(--vh-80); border-radius: 12px"
        />
      </div>
    </div>

    <!-- éšè—çš„å›¾ç‰‡è¾“å…¥ -->
    <input
      type="file"
      id="realImageInput"
      hidden
      accept="image/*"
      onchange="handleRealImageSelect(this)"
    />

    <!-- ç¾¤å…¬å‘Šå¼¹çª— -->
    <div
      class="group-announcement-modal"
      id="groupAnnouncementModal"
      onclick="if(event.target===this)closeGroupAnnouncementModal()"
    >
      <div class="group-announcement-content">
        <div class="group-announcement-header">
          <span class="group-announcement-title">ğŸ“¢ ç¾¤å…¬å‘Š</span>
          <button
            class="group-announcement-close"
            onclick="closeGroupAnnouncementModal()"
          >
            âœ•
          </button>
        </div>
        <div class="group-announcement-body">
          <textarea
            class="group-announcement-input"
            id="groupAnnouncementInput"
            placeholder="è¾“å…¥ç¾¤å…¬å‘Šå†…å®¹...&#10;ç¾¤æˆå‘˜å’ŒAIéƒ½å¯ä»¥çœ‹åˆ°è¿™ä¸ªå…¬å‘Š"
          ></textarea>
        </div>
        <div class="group-announcement-footer">
          <button
            class="group-announcement-btn cancel"
            onclick="closeGroupAnnouncementModal()"
          >
            å–æ¶ˆ
          </button>
          <button
            class="group-announcement-btn confirm"
            onclick="saveGroupAnnouncement()"
          >
            ä¿å­˜
          </button>
        </div>
      </div>
    </div>
    <!-- ä¸€èµ·å¬æ­Œé¡µé¢ -->
    <div class="music-together-page" id="musicTogetherPage">
      <div class="music-header">
        <button class="music-header-back" onclick="closeMusicTogether()">
          â†
        </button>
        <div class="music-header-title">ğŸµ ä¸€èµ·å¬æ­Œ</div>
        <div style="width: 36px"></div>
      </div>

      <div class="music-content">
        <!-- å½“å‰æ’­æ”¾ -->
        <div
          class="current-music-section"
          id="currentMusicSection"
          style="display: none"
        >
          <div class="music-player-info">
            <div class="music-cover-wrapper">
              <span class="music-cover-placeholder">ğŸµ</span>
            </div>
            <div class="music-meta">
              <div id="musicName">æ­Œæ›²åç§°</div>
              <div id="musicArtist">æ­Œæ‰‹</div>
            </div>
          </div>

          <!-- æ’­æ”¾æ§åˆ¶ -->
          <div class="music-controls">
            <button
              class="music-ctrl-btn small"
              id="playModeBtn"
              onclick="togglePlayMode()"
              title="æ’­æ”¾æ¨¡å¼"
            >
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="17 1 21 5 17 9"></polyline>
                <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                <polyline points="7 23 3 19 7 15"></polyline>
                <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
              </svg>
            </button>
            <button class="music-ctrl-btn" onclick="playPrevMusic()">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <polygon points="19 20 9 12 19 4 19 20"></polygon>
                <line
                  x1="5"
                  y1="19"
                  x2="5"
                  y2="5"
                  stroke="currentColor"
                  stroke-width="2"
                ></line>
              </svg>
            </button>
            <button
              class="music-ctrl-btn music-play-btn"
              id="musicPlayBtn"
              onclick="toggleMusicPlay()"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
            </button>
            <button class="music-ctrl-btn" onclick="playNextMusic()">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <polygon points="5 4 15 12 5 20 5 4"></polygon>
                <line
                  x1="19"
                  y1="5"
                  x2="19"
                  y2="19"
                  stroke="currentColor"
                  stroke-width="2"
                ></line>
              </svg>
            </button>
            <button
              class="music-ctrl-btn small"
              onclick="stopMusic()"
              title="åœæ­¢"
            >
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <rect x="6" y="6" width="12" height="12" rx="1"></rect>
              </svg>
            </button>
          </div>

          <!-- è¿›åº¦æ¡ -->
          <div class="music-progress-section">
            <div class="music-progress-bar" onclick="seekMusic(event)">
              <div class="music-progress-fill" id="musicProgressFill"></div>
            </div>
            <div class="music-time">
              <span id="musicCurrentTime">0:00</span>
              <span id="musicDuration">0:00</span>
            </div>
          </div>

          <!-- æ­Œè¯åŒºåŸŸ -->
          <div class="music-lyrics-section">
            <div class="music-lyrics-header">
              <span class="music-lyrics-title">ğŸ“ æ­Œè¯</span>
              <button class="music-lyrics-edit" onclick="openEditLyricsModal()">
                ç¼–è¾‘æ­Œè¯
              </button>
            </div>
            <div class="music-lyrics-container" id="musicLyricsContainer">
              <div class="lyric-empty">æš‚æ— æ­Œè¯</div>
            </div>
          </div>

          <!-- æ“ä½œæŒ‰é’® -->
          <div class="music-actions">
            <button
              class="music-action-btn primary"
              onclick="startFloatingLyric()"
            >
              ğŸ¤ æ¡Œé¢æ­Œè¯
            </button>
          </div>
        </div>

        <!-- éŸ³ä¹åº“ -->
        <div class="music-library-section">
          <div class="music-library-header">
            <div class="music-section-title">ğŸ§ æˆ‘çš„éŸ³ä¹åº“</div>
            <button class="music-add-btn" onclick="openMusicImportModal()">
              + å¯¼å…¥
            </button>
          </div>
          <div class="music-library-list" id="musicLibraryList">
            <!-- åŠ¨æ€æ¸²æŸ“ -->
          </div>
        </div>
      </div>
    </div>

    <!-- å¯¼å…¥éŸ³ä¹å¼¹çª— -->
    <div
      class="music-import-modal"
      id="musicImportModal"
      onclick="if(event.target===this)closeMusicImportModal()"
    >
      <div class="music-import-content">
        <div class="music-import-header">
          <div class="music-import-title">ğŸµ å¯¼å…¥éŸ³ä¹</div>
        </div>
        <div class="music-import-body">
          <div class="import-form-group">
            <label class="import-form-label"
              >æ­Œæ›²åç§° <span class="required">*</span></label
            >
            <input
              type="text"
              class="import-form-input"
              id="importMusicName"
              placeholder="è¾“å…¥æ­Œæ›²åç§°"
              oninput="checkImportValid()"
            />
          </div>
          <div class="import-form-group">
            <label class="import-form-label">æ­Œæ‰‹/è‰ºæœ¯å®¶</label>
            <input
              type="text"
              class="import-form-input"
              id="importMusicArtist"
              placeholder="è¾“å…¥æ­Œæ‰‹åï¼ˆå¯é€‰ï¼‰"
            />
          </div>
          <div class="import-form-group">
            <label class="import-form-label"
              >éŸ³é¢‘æ–‡ä»¶ <span class="required">*</span></label
            >
            <div
              class="file-select-btn"
              onclick="document.getElementById('audioFileInput').click()"
            >
              <div class="file-select-icon">ğŸµ</div>
              <div class="file-select-info">
                <div class="file-select-name" id="selectedAudioName">
                  ç‚¹å‡»é€‰æ‹©éŸ³é¢‘æ–‡ä»¶
                </div>
                <div class="file-select-hint">æ”¯æŒ MP3ã€M4Aã€WAV æ ¼å¼</div>
              </div>
            </div>
            <input
              type="file"
              id="audioFileInput"
              hidden
              accept=".mp3,.m4a,.wav,.flac,.ogg,audio/*"
              onchange="handleAudioFileSelect(this)"
            />
          </div>
          <div class="import-form-group">
            <label class="import-form-label">æ­Œè¯æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</label>
            <div
              class="file-select-btn"
              onclick="document.getElementById('lrcFileInput').click()"
            >
              <div class="file-select-icon">ğŸ“</div>
              <div class="file-select-info">
                <div class="file-select-name" id="selectedLrcName">
                  ç‚¹å‡»é€‰æ‹©ï¼ˆå¯é€‰ï¼‰
                </div>
                <div class="file-select-hint">æ”¯æŒ LRC æ ¼å¼æ­Œè¯æ–‡ä»¶</div>
              </div>
              <button
                class="file-clear-btn"
                onclick="event.stopPropagation(); clearSelectedLrc()"
              >
                âœ•
              </button>
            </div>
            <input
              type="file"
              id="lrcFileInput"
              hidden
              accept=".lrc,.txt"
              onchange="handleLrcFileSelect(this)"
            />
          </div>
        </div>
        <div class="music-import-footer">
          <button class="import-btn cancel" onclick="closeMusicImportModal()">
            å–æ¶ˆ
          </button>
          <button
            class="import-btn confirm"
            id="importMusicConfirmBtn"
            onclick="confirmImportMusic()"
            disabled
          >
            å¯¼å…¥
          </button>
        </div>
      </div>
    </div>

    <!-- æ¡Œé¢æ­Œè¯ï¼ˆçº¯æ–‡å­—æ‚¬æµ®ï¼‰ -->
    <div class="desktop-lyric" id="desktopLyric">
      <div class="desktop-lyric-text" id="desktopLyricText">â™ª â™ª â™ª</div>
      <button class="desktop-lyric-close" onclick="hideFloatingLyric()">
        âœ•
      </button>
    </div>

    <!-- ç¼–è¾‘æ­Œè¯å¼¹çª— -->
    <div
      class="edit-lyrics-modal"
      id="editLyricsModal"
      onclick="if(event.target===this)closeEditLyricsModal()"
    >
      <div class="edit-lyrics-content">
        <div class="edit-lyrics-header">
          <span class="edit-lyrics-title">ğŸ“ ç¼–è¾‘æ­Œè¯</span>
          <button class="edit-lyrics-close" onclick="closeEditLyricsModal()">
            âœ•
          </button>
        </div>
        <div class="edit-lyrics-body">
          <div class="lyrics-format-hint">
            æ”¯æŒ LRC æ ¼å¼ï¼Œä¾‹å¦‚ï¼š<br />
            [00:00.00] æ­Œè¯ç¬¬ä¸€å¥<br />
            [00:05.20] æ­Œè¯ç¬¬äºŒå¥
          </div>
          <button
            class="lyrics-import-btn"
            onclick="document.getElementById('editLrcFileInput').click()"
          >
            ğŸ“‚ å¯¼å…¥ LRC æ–‡ä»¶
          </button>
          <input
            type="file"
            id="editLrcFileInput"
            hidden
            accept=".lrc,.txt"
            onchange="importLyricsToEdit(this)"
          />
          <textarea
            id="editLyricsTextarea"
            placeholder="åœ¨æ­¤ç²˜è´´æˆ–è¾“å…¥æ­Œè¯..."
          ></textarea>
        </div>
        <div class="edit-lyrics-footer">
          <button class="lyrics-btn cancel" onclick="closeEditLyricsModal()">
            å–æ¶ˆ
          </button>
          <button class="lyrics-btn save" onclick="saveEditedLyrics()">
            ä¿å­˜
          </button>
        </div>
      </div>
    </div>
    <script src="phone_peek.js"></script>
    <script src="music_together.js"></script>
    <!-- è®ºå›å¸–å­è¯¦æƒ… -->
    <div class="forum-detail-overlay" id="forumDetailOverlay">
      <div class="forum-detail-header">
        <button class="forum-detail-back" onclick="closeForumPostDetail()">
          â†
        </button>
        <div class="forum-detail-title">å¸–å­è¯¦æƒ…</div>
        <div style="width: 36px"></div>
      </div>
      <div class="forum-detail-content" id="forumDetailContent"></div>
      <div
        class="forum-reply-indicator"
        id="forumReplyIndicator"
        style="display: none"
      ></div>
      <div class="forum-comment-bar">
        <input
          type="text"
          class="forum-comment-input"
          id="forumCommentInput"
          placeholder="å†™è¯„è®º..."
        />
        <button
          class="forum-comment-refresh"
          onclick="generateMoreComments()"
          title="ç”Ÿæˆæ›´å¤šäº’åŠ¨"
        >
          ğŸ’¬
        </button>
        <button class="forum-comment-send" onclick="submitForumComment()">
          å‘é€
        </button>
      </div>
    </div>

    <!-- è®ºå›è®¾ç½® -->
    <div class="forum-settings-overlay" id="forumSettingsOverlay">
      <div class="forum-settings-header">
        <button class="forum-settings-back" onclick="closeForumSettings()">
          â†
        </button>
        <div class="forum-settings-title">è®ºå›è®¾ç½®</div>
        <div style="width: 36px"></div>
      </div>
      <div class="forum-settings-content" id="forumSettingsContent"></div>
    </div>

    <!-- è®ºå›å‘å¸– -->
    <div class="forum-compose-overlay" id="forumComposeOverlay">
      <div class="forum-compose-header">
        <button class="forum-compose-cancel" onclick="closeForumCompose()">
          å–æ¶ˆ
        </button>
        <div class="forum-compose-title">å‘å¸–</div>
        <button class="forum-compose-submit" onclick="submitForumPost()">
          å‘å¸ƒ
        </button>
      </div>
      <div class="forum-compose-body">
        <div class="forum-compose-user-info" id="forumComposeUserInfo"></div>
        <textarea
          class="forum-compose-textarea"
          id="forumComposeTextarea"
          placeholder="åˆ†äº«ä½ çš„æƒ³æ³•...&#10;&#10;ğŸ’¡ å›¾ç‰‡æç¤ºï¼š&#10;â€¢ ç‚¹å‡»ä¸‹æ–¹ğŸ“·æ·»åŠ çœŸå®å›¾ç‰‡&#10;â€¢ æˆ–è¾“å…¥ [å›¾ç‰‡:æè¿°] æ·»åŠ æè¿°å›¾"
        ></textarea>
        <div class="forum-compose-images" id="forumComposeImages"></div>
        <div class="forum-compose-toolbar">
          <button
            class="forum-compose-tool-btn"
            onclick="document.getElementById('forumComposeImageInput').click()"
            title="æ·»åŠ å›¾ç‰‡"
          >
            <svg
              viewBox="0 0 24 24"
              width="22"
              height="22"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
          </button>
          <button
            class="forum-compose-tool-btn"
            onclick="insertImagePlaceholder()"
            title="æ·»åŠ å›¾ç‰‡æè¿°"
          >
            <svg
              viewBox="0 0 24 24"
              width="22"
              height="22"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
              ></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="12" y1="18" x2="12" y2="12"></line>
              <line x1="9" y1="15" x2="15" y2="15"></line>
            </svg>
          </button>
        </div>
        <input
          type="file"
          id="forumComposeImageInput"
          accept="image/*"
          multiple
          style="display: none"
          onchange="handleComposeImageUpload(this)"
        />
      </div>
    </div>

    <script src="continue_chat.js"></script>
    <script src="forum_app.js"></script>

    <!-- æƒ…ä¾£ç©ºé—´é¡µé¢ -->
    <div class="page" id="coupleSpacePage">
      <div class="page-header">
        <button class="back-btn" onclick="closePage('coupleSpacePage')">
          â†
        </button>
        <span class="page-title">æƒ…ä¾£ç©ºé—´</span>
      </div>
      <div class="page-content"></div>
    </div>

    <!-- æŸ¥æ‰‹æœºè§’è‰²é€‰æ‹©å¼¹çª— -->
    <div class="phone-peek-selector-overlay" id="phonePeekSelectorOverlay">
      <div class="phone-peek-selector-modal">
        <div class="phone-peek-selector-header">
          <h3>é€‰æ‹©è¦æŸ¥çœ‹çš„æ‰‹æœº</h3>
          <button
            class="phone-peek-selector-close"
            onclick="closePhonePeekSelector()"
          >
            âœ•
          </button>
        </div>
        <div class="phone-peek-selector-list" id="phonePeekSelectorList">
          <!-- åŠ¨æ€æ¸²æŸ“è§’è‰²åˆ—è¡¨ -->
        </div>
      </div>
    </div>

    <!-- æŸ¥æ‰‹æœºé¡µé¢ -->
    <div class="phone-peek-page" id="phonePeekPage">
      <button class="phone-peek-close" onclick="closePhonePeek()">âœ•</button>
      <button class="phone-wallpaper-btn" onclick="openWallpaperModal()">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <circle cx="8.5" cy="8.5" r="1.5"></circle>
          <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
      </button>

      <!-- æ‰‹æœºå¤–å£³ -->
      <div class="phone-device">
        <div class="phone-screen">
          <!-- çµåŠ¨å²› -->
          <div class="phone-dynamic-island"></div>

          <!-- çŠ¶æ€æ  -->
          <div class="phone-statusbar">
            <div class="phone-statusbar-left" id="phoneTime">9:41</div>
            <div class="phone-statusbar-center"></div>
            <div class="phone-statusbar-right">
              <span class="status-icon">
                <svg width="18" height="12" viewBox="0 0 18 12" fill="white">
                  <path
                    d="M1 4.5C1 3.67 1.67 3 2.5 3h2C5.33 3 6 3.67 6 4.5v3C6 8.33 5.33 9 4.5 9h-2C1.67 9 1 8.33 1 7.5v-3z"
                    fill-opacity="0.35"
                  />
                  <path
                    d="M1 4.5C1 3.67 1.67 3 2.5 3h2C5.33 3 6 3.67 6 4.5v3C6 8.33 5.33 9 4.5 9h-2C1.67 9 1 8.33 1 7.5v-3z"
                  />
                  <path
                    d="M7 5C7 4.17 7.67 3.5 8.5 3.5h2c.83 0 1.5.67 1.5 1.5v2.5c0 .83-.67 1.5-1.5 1.5h-2C7.67 9 7 8.33 7 7.5V5z"
                    fill-opacity="0.35"
                  />
                  <path
                    d="M7 5C7 4.17 7.67 3.5 8.5 3.5h2c.83 0 1.5.67 1.5 1.5v2.5c0 .83-.67 1.5-1.5 1.5h-2C7.67 9 7 8.33 7 7.5V5z"
                  />
                  <path
                    d="M13 5.5c0-.83.67-1.5 1.5-1.5h1c.83 0 1.5.67 1.5 1.5v2c0 .83-.67 1.5-1.5 1.5h-1c-.83 0-1.5-.67-1.5-1.5v-2z"
                    fill-opacity="0.35"
                  />
                  <path
                    d="M13 5.5c0-.83.67-1.5 1.5-1.5h1c.83 0 1.5.67 1.5 1.5v2c0 .83-.67 1.5-1.5 1.5h-1c-.83 0-1.5-.67-1.5-1.5v-2z"
                  />
                </svg>
              </span>
              <span class="status-icon">
                <svg width="25" height="12" viewBox="0 0 25 12" fill="white">
                  <rect
                    x="0.5"
                    y="0.5"
                    width="21"
                    height="11"
                    rx="2.5"
                    stroke="white"
                    stroke-opacity="0.35"
                    fill="none"
                  />
                  <rect
                    x="2"
                    y="2"
                    width="17"
                    height="8"
                    rx="1.5"
                    fill="white"
                  />
                  <path
                    d="M23 4v4c.83-.6 1.33-1.5 1.33-2s-.5-1.4-1.33-2z"
                    fill="white"
                    fill-opacity="0.4"
                  />
                </svg>
              </span>
            </div>
          </div>

          <!-- æ‰‹æœºä¸»ä½“ -->
          <div class="phone-body">
            <!-- Appå¤´éƒ¨ï¼ˆè¿›å…¥Appåæ˜¾ç¤ºï¼‰ -->
            <div class="phone-app-header" id="phoneAppHeader">
              <button class="phone-app-back" onclick="showPhoneHome()">
                â€¹
              </button>
              <div class="phone-app-title">App</div>
              <div class="phone-app-header-spacer"></div>
            </div>

            <!-- å†…å®¹åŒº -->
            <div class="phone-content" id="phoneContent">
              <!-- åŠ¨æ€æ¸²æŸ“ -->
            </div>
          </div>

          <!-- åº•éƒ¨æ¨ªæ¡ -->
          <div class="phone-home-indicator"></div>
        </div>
      </div>
    </div>
    <script>
      // ============ ä¸»å±å¹•åŒé¡µæ»‘åŠ¨åŠŸèƒ½ ============
      (function() {
        let currentPage = 0;
        let startX = 0;
        let startY = 0;
        let isDragging = false;
        let currentTranslate = 0;
        let prevTranslate = 0;
        
        function init() {
          const container = document.getElementById('homePagesContainer');
          const indicator = document.getElementById('homePageIndicator');
          const homeWallpaper = document.getElementById('homeWallpaper');
          
          if (!container) {
            console.log('homePagesContainer not found');
            return;
          }
          
          // åº”ç”¨å£çº¸åˆ°ä¸»å±å¹•èƒŒæ™¯
          function applyHomeWallpaper() {
            const savedWallpaper = localStorage.getItem('pinkyphone_wallpaper');
            if (savedWallpaper && homeWallpaper) {
              homeWallpaper.style.backgroundImage = 'url(' + savedWallpaper + ')';
            }
          }
          
          applyHomeWallpaper();
          window.addEventListener('storage', applyHomeWallpaper);
          
          function setSliderPosition() {
            container.style.transform = 'translateX(' + currentTranslate + 'px)';
          }
          
          function updateIndicator() {
            if (!indicator) return;
            const dots = indicator.querySelectorAll('.indicator-dot');
            dots.forEach(function(dot, index) {
              dot.classList.toggle('active', index === currentPage);
            });
          }
          
          function goToPage(pageIndex) {
            currentPage = pageIndex;
            const pageWidth = window.innerWidth;
            currentTranslate = -pageIndex * pageWidth;
            prevTranslate = currentTranslate;
            container.style.transition = 'transform 0.3s ease-out';
            setSliderPosition();
            updateIndicator();
          }
          
          function touchStart(event) {
            var openPages = document.querySelectorAll('.page');
            for (var i = 0; i < openPages.length; i++) {
              var p = openPages[i];
              if (p.style.transform === 'translateX(0px)') return;
            }
            startX = event.touches[0].clientX;
            startY = event.touches[0].clientY;
            isDragging = true;
            container.style.transition = 'none';
          }
          
          function touchMove(event) {
            if (!isDragging) return;
            var currentX = event.touches[0].clientX;
            var currentY = event.touches[0].clientY;
            var diffX = currentX - startX;
            var diffY = currentY - startY;
            
            if (Math.abs(diffY) > Math.abs(diffX) * 1.2) {
              isDragging = false;
              return;
            }
            
            var pageWidth = window.innerWidth;
            var newTranslate = prevTranslate + diffX;
            
            if (newTranslate > 50) {
              newTranslate = 50 + (newTranslate - 50) * 0.2;
            }
            if (newTranslate < -pageWidth - 50) {
              newTranslate = -pageWidth - 50 + (newTranslate + pageWidth + 50) * 0.2;
            }
            
            currentTranslate = newTranslate;
            setSliderPosition();
          }
          
          function touchEnd() {
            if (!isDragging) return;
            isDragging = false;
            var pageWidth = window.innerWidth;
            var movedBy = currentTranslate - prevTranslate;
            
            if (movedBy < -50 && currentPage < 1) {
              currentPage++;
            } else if (movedBy > 50 && currentPage > 0) {
              currentPage--;
            }
            goToPage(currentPage);
          }
          
          container.addEventListener('touchstart', touchStart, { passive: true });
          container.addEventListener('touchmove', touchMove, { passive: false });
          container.addEventListener('touchend', touchEnd);
          
          if (indicator) {
            indicator.addEventListener('click', function(e) {
              if (e.target.classList.contains('indicator-dot')) {
                var pageIndex = parseInt(e.target.dataset.page);
                goToPage(pageIndex);
              }
            });
          }
          
          window.addEventListener('resize', function() { goToPage(currentPage); });
          window.goToHomePage = goToPage;
          window.applyHomeWallpaper = applyHomeWallpaper;
        }
        
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
      })();
    </script>
    <script>
      // æ³¨å†Œ Service Worker
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("./sw.js")
            .then((registration) => {
              console.log("Service Worker æ³¨å†ŒæˆåŠŸï¼ŒèŒƒå›´:", registration.scope);
            })
            .catch((err) => {
              console.log("Service Worker æ³¨å†Œå¤±è´¥:", err);
            });
        });
      }

      // è¯·æ±‚é€šçŸ¥æƒé™ï¼ˆå¿…é¡»ç‚¹â€œå…è®¸â€æ‰èƒ½å¼¹çª—ï¼‰
      function requestNotificationPermission() {
        if ("Notification" in window) {
          Notification.requestPermission().then((permission) => {
            if (permission === "granted") {
              console.log("é€šçŸ¥æƒé™å·²è·å–");
              if (window.showToast) window.showToast("é€šçŸ¥æƒé™å·²å¼€å¯");
            }
          });
        }
      }

      // å¯ä»¥åœ¨ç”¨æˆ·é¦–æ¬¡ç‚¹å‡»é¡µé¢ä»»æ„ä½ç½®æ—¶è§¦å‘ç”³è¯·æƒé™ï¼Œæˆ–è€…åšä¸€ä¸ªä¸“é—¨çš„æŒ‰é’®
      document.body.addEventListener("click", requestNotificationPermission, {
        once: true,
      });
    </script>
    <script src="companion_patch.js"></script>
    <script src="couple_space.js"></script>
  </body>
</html>
