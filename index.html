<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <title>SillyTavern</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=Satisfy&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        user-select: none;
      }

      :root {
        --bg-pink: #fce4ec;
        --bg-dots: #f8bbd9;
        --card-bg: rgba(255, 255, 255, 0.85);
        --text-primary: #37474f;
        --text-secondary: #78909c;
        --text-hint: #b0bec5;
        --accent-pink: #f48fb1;
        --accent-green: #c5e1a5;
        --shadow: rgba(0, 0, 0, 0.08);
      }

      html {
        height: 100%;
        -webkit-text-size-adjust: 100%;
      }

      body {
        margin: 0;
        height: 100%;
        overflow: hidden;
        font-family: "Noto Sans SC", -apple-system, BlinkMacSystemFont,
          sans-serif;
        background: var(--bg-pink);
      }

      /* Polka dot background */
      body::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: radial-gradient(
          var(--bg-dots) 1.5px,
          transparent 1.5px
        );
        background-size: 20px 20px;
        opacity: 0.5;
        pointer-events: none;
        z-index: 0;
      }

      /* Decorative stars */
      .star {
        position: absolute;
        opacity: 0.15;
        pointer-events: none;
        z-index: 0;
      }

      .star::before {
        content: "‚òÖ";
        font-size: 40px;
        color: #ec407a;
      }

      .star-1 {
        top: 60%;
        left: 10%;
      }
      .star-2 {
        top: 70%;
        right: 15%;
        transform: scale(0.7);
      }
      .star-3 {
        top: 50%;
        left: 50%;
        transform: scale(0.5);
      }
      .star-4 {
        top: 75%;
        left: 30%;
        transform: scale(0.6);
      }
      .star-5 {
        top: 65%;
        right: 25%;
        transform: scale(0.8);
      }

      .phone-container {
        width: 100%;
        height: 100vh;
        position: relative;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        z-index: 1;
        background: var(--bg-pink);
      }

      /* Main scrollable content */
      .main-content {
        flex: 1;
        padding: 16px;
        padding-top: max(16px, env(safe-area-inset-top));
        padding-bottom: calc(90px + env(safe-area-inset-bottom));
        overflow-y: auto;
        overflow-x: hidden;
      }

      /* Top decorative bar - Â∑≤ÈöêËóè */
      .top-bar {
        display: none;
      }

      .top-bar::after {
        display: none;
      }

      /* Profile Card Widget - ÂàõÊÑèÈÄèÊòéÂêçÁâá */
      .profile-widget {
        background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border-radius: 24px;
        padding: 16px;
        margin-top: 20px;
        position: relative;
        border: 1px solid rgba(255, 255, 255, 0.4);
        display: flex;
        align-items: center;
        gap: 14px;
        overflow: hidden;
      }

      .profile-widget::before {
        content: "";
        position: absolute;
        top: -50%;
        right: -30%;
        width: 120px;
        height: 120px;
        background: radial-gradient(circle, rgba(244,143,177,0.3) 0%, transparent 70%);
        border-radius: 50%;
        pointer-events: none;
      }

      .profile-widget::after {
        content: "";
        position: absolute;
        bottom: -30%;
        left: -20%;
        width: 80px;
        height: 80px;
        background: radial-gradient(circle, rgba(129,212,250,0.3) 0%, transparent 70%);
        border-radius: 50%;
        pointer-events: none;
      }

      .profile-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fce4ec, #e1bee7, #bbdefb);
        padding: 2px;
        box-shadow: 0 4px 15px rgba(244, 143, 177, 0.25);
        cursor: pointer;
        flex-shrink: 0;
        position: relative;
        z-index: 1;
      }

      .profile-avatar-inner {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        font-size: 28px;
      }

      .profile-avatar-inner img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .profile-info {
        flex: 1;
        min-width: 0;
        position: relative;
        z-index: 1;
      }

      .profile-name {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .profile-handle {
        font-size: 0.75rem;
        color: var(--accent-pink);
        margin-bottom: 6px;
        font-weight: 500;
      }

      .profile-bio {
        font-size: 0.8rem;
        color: var(--text-secondary);
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .profile-location {
        display: none;
      }

      .profile-location::before {
        content: "üìç";
        font-size: 0.75rem;
      }

      /* Apps Grid */
      .apps-section {
        margin-top: 24px;
      }

      .apps-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px 12px;
      }

      .app-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .app-item:active {
        transform: scale(0.9);
      }

      .app-icon {
        width: 60px;
        height: 60px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0;
        color: transparent;
        background: var(--card-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        box-shadow: 0 2px 10px var(--shadow);
        position: relative;
        overflow: hidden;
      }

      .app-icon img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .app-icon.gradient-pink {
        background: linear-gradient(135deg, #fce4ec, #f8bbd9);
      }

      .app-icon.gradient-blue {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      }

      .app-icon.gradient-green {
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
      }

      .app-icon.gradient-purple {
        background: linear-gradient(135deg, #f3e5f5, #e1bee7);
      }

      .app-icon.gradient-orange {
        background: linear-gradient(135deg, #fff3e0, #ffe0b2);
      }

      .app-name {
        font-size: 0.6rem;
        font-weight: 500;
        color: var(--text-primary);
        text-align: center;
        max-width: 70px;
        line-height: 1.2;
      }

      /* Bottom Dock - iOSÈ£éÊ†ºÊµÆÂä®ËÉ∂Âõä */
      .dock {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 40px);
        max-width: 360px;
        padding: 8px 24px;
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(30px) saturate(180%);
        -webkit-backdrop-filter: blur(30px) saturate(180%);
        border-radius: 26px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
      }

      .dock-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        cursor: pointer;
        transition: transform 0.2s ease;
        padding: 4px;
      }

      .dock-item:active {
        transform: scale(0.9);
      }

      .dock-icon {
        width: 50px;
        height: 50px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0;
        color: transparent;
        background: rgba(255, 255, 255, 0.6);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        overflow: hidden;
      }

      .dock-icon img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .dock-icon.dock-blue {
        background: linear-gradient(135deg, rgba(227, 242, 253, 0.9), rgba(144, 202, 249, 0.9));
      }

      .dock-icon.dock-purple {
        background: linear-gradient(135deg, rgba(243, 229, 245, 0.9), rgba(206, 147, 216, 0.9));
      }

      .dock-icon.dock-orange {
        background: linear-gradient(135deg, rgba(255, 243, 224, 0.9), rgba(255, 204, 128, 0.9));
      }

      .dock-label {
        font-size: 0.6rem;
        font-weight: 500;
        color: var(--text-primary);
        text-align: center;
        max-width: 60px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Hidden input */
      .hidden-input {
        display: none;
      }

      /* Page views */
      .page {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--bg-pink);
        z-index: 200;
        padding: 16px;
        padding-top: max(16px, env(safe-area-inset-top));
        padding-bottom: calc(20px + env(safe-area-inset-bottom));
        overflow-y: auto;
      }

      .page::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: radial-gradient(
          var(--bg-dots) 1.5px,
          transparent 1.5px
        );
        background-size: 20px 20px;
        opacity: 0.5;
        pointer-events: none;
        z-index: -1;
      }

      .page.active {
        display: block;
        animation: slideUp 0.3s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(100%);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .page-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
      }

      .back-btn {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: var(--card-bg);
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 2px 8px var(--shadow);
        transition: transform 0.2s;
        color: #000;
      }

      .back-btn:active {
        transform: scale(0.95);
      }

      .page-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .page-content {
        background: var(--card-bg);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 24px;
        min-height: 150px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        font-size: 0.95rem;
        box-shadow: 0 4px 20px var(--shadow);
      }

      /* Edit modal for profile */
      .edit-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        z-index: 300;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .edit-modal.active {
        display: flex;
      }

      .edit-modal-content {
        background: white;
        border-radius: 20px;
        padding: 24px;
        width: 100%;
        max-width: 320px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      .edit-modal-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 16px;
        text-align: center;
      }

      .edit-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        font-size: 0.95rem;
        font-family: inherit;
        margin-bottom: 12px;
        outline: none;
        transition: border-color 0.2s;
      }

      .edit-input:focus {
        border-color: var(--accent-pink);
      }

      .edit-buttons {
        display: flex;
        gap: 10px;
        margin-top: 8px;
      }

      .edit-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .edit-btn:active {
        transform: scale(0.98);
      }

      .edit-btn-cancel {
        background: #f5f5f5;
        color: var(--text-secondary);
      }

      .edit-btn-save {
        background: var(--accent-pink);
        color: white;
      }

      /* Scrollbar hide */
      .main-content::-webkit-scrollbar,
      .page::-webkit-scrollbar {
        display: none;
      }

      .main-content,
      .page {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      /* ==================== CHAT APP STYLES ==================== */
      .chat-app {
        display: none;
        flex-direction: column;
        padding: 0 !important;
        background: #fdf5f7 !important;
        background-image: radial-gradient(circle, rgba(244,143,177,0.15) 2px, transparent 2px) !important;
        background-size: 20px 20px !important;
      }

      .chat-app.active {
        display: flex !important;
      }

      .chat-app::before {
        display: none;
      }

      .chat-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 16px;
        padding-top: max(10px, env(safe-area-inset-top));
        background: transparent;
        border: none;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      .chat-header .back-btn {
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      .chat-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .chat-header-btn {
        width: 34px;
        height: 34px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: none;
        font-size: 16px;
        cursor: pointer;
      }

      .chat-content {
        flex: 1;
        overflow-y: auto;
        padding-bottom: calc(70px + env(safe-area-inset-bottom));
      }

      .chat-tab-content {
        display: none;
        min-height: 100%;
        padding: 0 12px;
      }

      .chat-tab-content.active {
        display: block;
      }

      /* Messages Tab - ÊêúÁ¥¢Ê†è */
      .search-bar {
        display: flex;
        align-items: center;
        background: rgba(255, 255, 255, 0.8);
        margin: 12px 4px;
        padding: 10px 14px;
        border-radius: 20px;
        gap: 8px;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      .search-icon {
        font-size: 14px;
        opacity: 0.5;
      }

      .search-input {
        flex: 1;
        border: none;
        background: none;
        font-size: 0.9rem;
        font-family: inherit;
        outline: none;
      }

      .message-list {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 24px;
        margin: 8px 4px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.5);
      }

      /* ÂàÜÁªÑÊ†áÈ¢ò */
      .message-group {
        margin-bottom: 12px;
      }

      .message-group-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 16px;
        cursor: pointer;
      }

      .message-group-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .message-group-arrow {
        font-size: 12px;
        transition: transform 0.3s ease;
      }

      .message-group.collapsed .message-group-arrow {
        transform: rotate(-90deg);
      }

      .message-group.collapsed .message-group-content {
        display: none;
      }

      .message-group-content {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 20px;
        margin: 0 4px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.5);
      }

      /* ÁΩÆÈ°∂Ê∂àÊÅØÊ†∑Âºè */
      .message-item.pinned {
        background: rgba(252, 228, 236, 0.3);
      }

      .message-item {
        display: flex;
        align-items: center;
        padding: 14px 16px;
        gap: 12px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.04);
        cursor: pointer;
        transition: background 0.2s;
        position: relative;
      }

      .message-item:last-child {
        border-bottom: none;
      }

      .message-item:active {
        background: rgba(244, 143, 177, 0.1);
      }

      .message-avatar {
        width: 50px;
        height: 50px;
        border-radius: 14px;
        background: linear-gradient(135deg, #fce4ec, #e8f5e9);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        flex-shrink: 0;
        overflow: hidden;
      }

      .message-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .message-info {
        flex: 1;
        min-width: 0;
      }

      .message-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 4px;
      }

      .message-name {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .message-time {
        font-size: 0.75rem;
        color: var(--text-hint);
      }

      .message-preview {
        font-size: 0.85rem;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .message-badge {
        background: #ff6b6b;
        color: white;
        font-size: 0.7rem;
        font-weight: 600;
        padding: 2px 7px;
        border-radius: 10px;
        min-width: 18px;
        text-align: center;
      }

      /* Empty State */
      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 60px 20px;
        text-align: center;
      }

      .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.8;
      }

      .empty-text {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 6px;
      }

      .empty-hint {
        font-size: 0.85rem;
        color: var(--text-hint);
      }

      /* ÊêúÁ¥¢ÁªìÊûúÊ†∑Âºè */
      .search-results {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 16px;
        margin: 8px 4px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        display: none;
      }

      .search-results.active {
        display: block;
      }

      .search-result-item {
        padding: 12px 16px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        cursor: pointer;
      }

      .search-result-item:active {
        background: rgba(244, 143, 177, 0.1);
      }

      .search-result-char {
        font-size: 0.8rem;
        color: var(--accent-pink);
        font-weight: 600;
        margin-bottom: 4px;
      }

      .search-result-content {
        font-size: 0.9rem;
        color: var(--text-primary);
      }

      .search-result-content mark {
        background: rgba(244, 143, 177, 0.3);
        color: inherit;
        padding: 0 2px;
        border-radius: 2px;
      }

      /* ==================== ÂæÆ‰ø°ÊúãÂèãÂúàÈ£éÊ†ºÂä®ÊÄÅÈ°µÈù¢ ==================== */
      #momentsTab {
        background: #efefef;
        min-height: 100%;
        padding-bottom: 80px;
      }

      /* Stories Ê®™ÂêëÊªöÂä®Âå∫ - ‰øùÁïô‰ΩÜÁÆÄÂåñ */
      .ig-stories {
        background: #fff;
        padding: 16px 0;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      }
      .ig-stories::-webkit-scrollbar {
        display: none;
      }
      .ig-stories-inner {
        display: flex;
        gap: 16px;
        padding: 0 16px;
      }
      .ig-story-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        flex-shrink: 0;
      }
      .ig-story-ring {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        padding: 2px;
        background: linear-gradient(135deg, #ff9a9e, #fecfef, #fecfef, #a18cd1);
      }
      .ig-story-ring.no-story {
        background: #e0e0e0;
      }
      .ig-story-ring.my-story {
        background: transparent;
        border: 2px dashed #ccc;
        position: relative;
      }
      .ig-story-avatar {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background: #fff;
        padding: 2px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .ig-story-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
      }
      .ig-story-avatar-emoji {
        font-size: 28px;
      }
      .ig-story-add {
        position: absolute;
        bottom: -2px;
        right: -2px;
        width: 20px;
        height: 20px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: 2px solid #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 12px;
        font-weight: 700;
      }
      .ig-story-name {
        font-size: 0.7rem;
        color: #666;
        max-width: 60px;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Áî®Êà∑‰∏™‰∫∫ËµÑÊñôÂç°Áâá - ÁÆÄÂåñÁâà */
      .ig-profile-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        margin: 12px;
        border-radius: 20px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
        position: relative;
        overflow: hidden;
      }
      .ig-profile-card::before {
        content: "";
        position: absolute;
        top: -50%;
        right: -50%;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        pointer-events: none;
      }
      .ig-profile-header {
        display: flex;
        align-items: center;
        gap: 16px;
        position: relative;
        z-index: 1;
      }
      .ig-profile-avatar-wrap {
        position: relative;
        cursor: pointer;
      }
      .ig-profile-avatar {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        background: rgba(255,255,255,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 35px;
        overflow: hidden;
        border: 3px solid rgba(255,255,255,0.5);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      }
      .ig-profile-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .ig-profile-edit-icon {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 24px;
        height: 24px;
        background: #fff;
        border: none;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      }
      .ig-profile-info {
        flex: 1;
      }
      .ig-profile-name {
        font-size: 1.2rem;
        font-weight: 700;
        color: #fff;
        margin-bottom: 4px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }
      .ig-profile-handle {
        font-size: 0.8rem;
        color: rgba(255,255,255,0.8);
      }
      .ig-profile-bio {
        font-size: 0.85rem;
        color: rgba(255,255,255,0.9);
        line-height: 1.5;
        margin-top: 12px;
        white-space: pre-wrap;
        position: relative;
        z-index: 1;
      }

      /* Âä®ÊÄÅÂàóË°® */
      .ig-feed {
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      /* ÂçïÊù°Âä®ÊÄÅÂç°Áâá - ÊúãÂèãÂúàÈ£éÊ†º */
      .ig-post {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .ig-post:active {
        transform: scale(0.995);
      }
      .ig-post-header {
        display: flex;
        align-items: center;
        padding: 14px 16px;
        gap: 12px;
      }
      .ig-post-avatar {
        width: 44px;
        height: 44px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fce4ec, #fff3e0);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        flex-shrink: 0;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      .ig-post-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .ig-post-user-info {
        flex: 1;
        min-width: 0;
      }
      .ig-post-username {
        font-size: 0.95rem;
        font-weight: 600;
        color: #333;
      }
      .ig-post-time-header {
        font-size: 0.75rem;
        color: #999;
        margin-top: 2px;
      }
      .ig-post-delete {
        background: none;
        border: none;
        font-size: 1rem;
        cursor: pointer;
        padding: 8px;
        color: #ccc;
        border-radius: 50%;
        opacity: 0.6;
        transition: opacity 0.2s, color 0.2s;
      }
      .ig-post-delete:hover, .ig-post-delete:active {
        opacity: 1;
        color: #ff6b6b;
        background: #fff0f0;
      }
      .ig-post-more {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 8px;
        color: #999;
        border-radius: 50%;
      }
      .ig-post-more:active {
        background: #f5f5f5;
      }

      /* Ê≠£ÊñáÂÜÖÂÆπ - Âú®ÂõæÁâá‰∏äÊñπ */
      .ig-post-content {
        padding: 0 16px 12px;
        font-size: 0.95rem;
        color: #333;
        line-height: 1.6;
      }

      /* ÂõæÁâáÂå∫Âüü */
      .ig-post-images {
        width: 100%;
        background: #f8f8f8;
        overflow: hidden;
      }
      .ig-post-images.single-img {
        max-height: 400px;
      }
      .ig-post-images.single-img img {
        width: 100%;
        height: auto;
        max-height: 400px;
        object-fit: cover;
      }
      .ig-post-images img {
        width: 100%;
        display: block;
      }
      .ig-post-text-img {
        width: 100%;
        min-height: 220px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 30px;
        font-size: 1.15rem;
        color: #fff;
        text-align: center;
        line-height: 1.8;
        text-shadow: 0 2px 8px rgba(0,0,0,0.3);
        position: relative;
        overflow: hidden;
      }
      /* ÊñáÂ≠óÈÖçÂõæË£ÖÈ•∞ÊïàÊûú */
      .ig-post-text-img::before {
        content: "";
        position: absolute;
        width: 150%;
        height: 150%;
        top: -25%;
        left: -25%;
        background-image:
          radial-gradient(circle at 20% 30%, rgba(255,255,255,0.15) 0%, transparent 50%),
          radial-gradient(circle at 80% 70%, rgba(255,255,255,0.1) 0%, transparent 40%),
          radial-gradient(circle at 40% 80%, rgba(255,255,255,0.08) 0%, transparent 30%);
        animation: floatBg 15s ease-in-out infinite;
      }
      .ig-post-text-img::after {
        content: "‚ú®";
        position: absolute;
        font-size: 3rem;
        opacity: 0.15;
        right: 15px;
        bottom: 15px;
        filter: blur(1px);
      }
      @keyframes floatBg {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        33% { transform: translate(2%, 2%) rotate(1deg); }
        66% { transform: translate(-1%, 1%) rotate(-1deg); }
      }
      .ig-post-text-img .text-content {
        position: relative;
        z-index: 2;
        padding: 20px 24px;
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border-radius: 16px;
        border: 1px solid rgba(255,255,255,0.2);
        box-shadow: 0 4px 24px rgba(0,0,0,0.1);
        max-width: 90%;
      }
      .ig-post-text-img .text-quote {
        position: absolute;
        top: -8px;
        left: 20px;
        font-size: 2.5rem;
        opacity: 0.4;
        font-family: Georgia, serif;
        line-height: 1;
      }

      /* ‰∫íÂä®Âå∫Âüü */
      .ig-post-footer {
        padding: 12px 16px;
        border-top: 1px solid #f0f0f0;
      }
      .ig-post-actions {
        display: flex;
        align-items: center;
        gap: 20px;
      }
      .ig-action-btn {
        background: none;
        border: none;
        font-size: 1.3rem;
        cursor: pointer;
        padding: 6px;
        transition: transform 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
        color: #666;
        border-radius: 8px;
      }
      .ig-action-btn:active {
        transform: scale(0.9);
        background: #f5f5f5;
      }
      .ig-action-btn.liked {
        color: #ff4757;
      }
      .ig-action-btn.bookmarked {
        color: #f5a623;
      }
      .ig-action-btn span {
        font-size: 0.85rem;
      }
      @keyframes likeAnim {
        0% { transform: scale(1); }
        50% { transform: scale(1.3); }
        100% { transform: scale(1); }
      }
      .ig-action-btn.liked svg, .ig-action-btn.liked {
        animation: likeAnim 0.3s ease;
      }

      /* ÁÇπËµû‰ø°ÊÅØ */
      .ig-post-likes {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 10px 0;
        font-size: 0.85rem;
        color: #666;
        border-bottom: 1px solid #f5f5f5;
      }
      .ig-post-likes-avatars {
        display: flex;
        margin-right: 4px;
      }
      .ig-post-likes-avatars .like-avatar {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        border: 2px solid #fff;
        margin-left: -8px;
        background: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        overflow: hidden;
      }
      .ig-post-likes-avatars .like-avatar:first-child {
        margin-left: 0;
      }
      .ig-post-likes-avatars .like-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      /* ËØÑËÆ∫Âå∫ */
      .ig-post-comments {
        padding-top: 10px;
      }
      .ig-comment {
        font-size: 0.9rem;
        color: #333;
        margin-bottom: 8px;
        line-height: 1.5;
        padding: 8px 12px;
        background: #f8f8f8;
        border-radius: 10px;
      }
      .ig-comment .username {
        font-weight: 600;
        color: #667eea;
        margin-right: 8px;
      }
      .ig-view-comments {
        font-size: 0.85rem;
        color: #999;
        padding: 8px 0;
        cursor: pointer;
      }

      /* ÂèëÂ∏ÉÊåâÈíÆ */
      .ig-fab {
        position: fixed;
        bottom: 100px;
        right: 20px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 200;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .ig-fab:active {
        transform: scale(0.92);
      }
      .ig-fab-icon {
        color: #fff;
        font-size: 1.8rem;
        font-weight: 300;
      }

      /* ÂèëÂ∏ÉÂä®ÊÄÅÂºπÁ™ó */
      .ig-post-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        display: none;
        align-items: flex-end;
        justify-content: center;
      }
      .ig-post-modal.active {
        display: flex;
      }
      .ig-post-modal-content {
        background: #fff;
        width: 100%;
        max-height: 90vh;
        border-radius: 24px 24px 0 0;
        overflow: hidden;
        animation: slideUpModal 0.3s ease;
      }
      @keyframes slideUpModal {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
      }
      .ig-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 18px 20px;
        border-bottom: 1px solid #f0f0f0;
      }
      .ig-modal-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
      }
      .ig-modal-close, .ig-modal-submit {
        background: none;
        border: none;
        font-size: 0.95rem;
        cursor: pointer;
        padding: 6px 12px;
        border-radius: 8px;
      }
      .ig-modal-close {
        color: #666;
      }
      .ig-modal-submit {
        color: #fff;
        background: linear-gradient(135deg, #667eea, #764ba2);
        font-weight: 600;
      }
      .ig-modal-submit:disabled {
        opacity: 0.4;
      }
      .ig-modal-body {
        padding: 20px;
        max-height: 60vh;
        overflow-y: auto;
      }
      .ig-post-textarea {
        width: 100%;
        min-height: 120px;
        border: none;
        font-size: 1rem;
        line-height: 1.6;
        resize: none;
        outline: none;
        font-family: inherit;
      }
      .ig-post-textarea::placeholder {
        color: #aaa;
      }
      .ig-image-options {
        display: flex;
        gap: 12px;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #f0f0f0;
      }
      .ig-image-option {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 20px 16px;
        background: #f8f8f8;
        border: 2px dashed #ddd;
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .ig-image-option:active {
        background: #f0f0f0;
      }
      .ig-image-option.selected {
        border-color: #667eea;
        background: #f0f4ff;
      }
      .ig-image-option-icon {
        font-size: 2rem;
      }
      .ig-image-option-text {
        font-size: 0.8rem;
        color: #666;
        text-align: center;
      }

      /* ËØÑËÆ∫Âå∫ */
      .ig-post-comments {
        padding: 0 16px;
      }
      .ig-comment {
        font-size: 0.85rem;
        color: #262626;
        margin-bottom: 6px;
        line-height: 1.4;
      }
      .ig-comment .username {
        font-weight: 600;
        margin-right: 6px;
        color: #262626;
      }
      .ig-view-comments {
        font-size: 0.85rem;
        color: #8e8e8e;
        padding: 4px 16px;
        cursor: pointer;
      }

      /* Êó∂Èó¥ */
      .ig-post-time {
        font-size: 0.7rem;
        color: #8e8e8e;
        padding: 4px 16px 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* ËØÑËÆ∫ËæìÂÖ•Ê°Ü */
      .ig-comment-input-wrap {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-top: 1px solid #efefef;
        gap: 12px;
      }
      .ig-comment-input {
        flex: 1;
        border: none;
        font-size: 0.9rem;
        outline: none;
        background: transparent;
      }
      .ig-comment-input::placeholder {
        color: #8e8e8e;
      }
      .ig-comment-submit {
        background: none;
        border: none;
        color: #0095f6;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        opacity: 0.5;
        transition: opacity 0.2s;
      }
      .ig-comment-submit.active {
        opacity: 1;
      }

      /* ÂèëÂ∏ÉÂä®ÊÄÅÊåâÈíÆ - ÊµÆÂä® */
      .ig-fab {
        position: fixed;
        bottom: 100px;
        right: 20px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
        border: none;
        box-shadow: 0 4px 16px rgba(225,48,108,0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 200;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .ig-fab:active {
        transform: scale(0.92);
      }
      .ig-fab-icon {
        color: #fff;
        font-size: 1.6rem;
        font-weight: 300;
      }

      /* ÂèëÂ∏ÉÂä®ÊÄÅÂºπÁ™ó */
      .ig-post-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.6);
        z-index: 1000;
        display: none;
        align-items: flex-end;
        justify-content: center;
      }
      .ig-post-modal.active {
        display: flex;
      }
      .ig-post-modal-content {
        background: #fff;
        width: 100%;
        max-height: 90vh;
        border-radius: 20px 20px 0 0;
        overflow: hidden;
        animation: slideUpModal 0.3s ease;
      }
      @keyframes slideUpModal {
        from { transform: translateY(100%); }
        to { transform: translateY(0); }
      }
      .ig-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid #efefef;
      }
      .ig-modal-title {
        font-size: 1rem;
        font-weight: 600;
        color: #262626;
      }
      .ig-modal-close, .ig-modal-submit {
        background: none;
        border: none;
        font-size: 0.95rem;
        cursor: pointer;
        padding: 4px 8px;
      }
      .ig-modal-close {
        color: #262626;
      }
      .ig-modal-submit {
        color: #0095f6;
        font-weight: 600;
      }
      .ig-modal-submit:disabled {
        opacity: 0.4;
      }
      .ig-modal-body {
        padding: 16px 20px;
        max-height: 60vh;
        overflow-y: auto;
      }
      .ig-post-textarea {
        width: 100%;
        min-height: 120px;
        border: none;
        font-size: 1rem;
        line-height: 1.6;
        resize: none;
        outline: none;
        font-family: inherit;
      }
      .ig-post-textarea::placeholder {
        color: #8e8e8e;
      }
      .ig-image-options {
        display: flex;
        gap: 12px;
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #efefef;
      }

      /* ÂèØËßÅËåÉÂõ¥ÈÄâÊã©Âô® */
      .ig-visibility-section {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px solid #efefef;
      }

      .ig-visibility-label {
        font-size: 13px;
        color: #666;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .ig-visibility-options {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .ig-visibility-option {
        padding: 8px 14px;
        border-radius: 20px;
        border: 1px solid #ddd;
        background: #fff;
        font-size: 13px;
        color: #666;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .ig-visibility-option:hover {
        border-color: #f48fb1;
        color: #c2185b;
      }

      .ig-visibility-option.selected {
        background: linear-gradient(135deg, #fce4ec, #f8bbd9);
        border-color: #f48fb1;
        color: #c2185b;
        font-weight: 500;
      }

      .ig-visibility-option .check-icon {
        display: none;
        font-size: 12px;
      }

      .ig-visibility-option.selected .check-icon {
        display: inline;
      }

      .ig-image-option {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 16px;
        background: #fafafa;
        border: 2px dashed #dbdbdb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .ig-image-option:active {
        background: #f0f0f0;
        border-color: #0095f6;
      }
      .ig-image-option.selected {
        border-color: #0095f6;
        background: #e8f4fd;
      }
      .ig-image-option-icon {
        font-size: 2rem;
      }
      .ig-image-option-text {
        font-size: 0.8rem;
        color: #8e8e8e;
        text-align: center;
      }
      .ig-text-img-input {
        width: 100%;
        margin-top: 12px;
        padding: 12px;
        border: 1px solid #dbdbdb;
        border-radius: 8px;
        font-size: 0.9rem;
        outline: none;
        display: none;
      }
      .ig-text-img-input.visible {
        display: block;
      }
      .ig-text-img-input:focus {
        border-color: #0095f6;
      }
      .ig-image-preview {
        margin-top: 12px;
        display: none;
      }
      .ig-image-preview.visible {
        display: block;
      }
      .ig-image-preview img {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        object-fit: cover;
      }
      .ig-image-preview-remove {
        display: inline-block;
        margin-top: 8px;
        color: #ed4956;
        font-size: 0.85rem;
        cursor: pointer;
      }

      /* ‰∏™‰∫∫ËµÑÊñôÁºñËæëÂºπÁ™ó */
      .ig-profile-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.6);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .ig-profile-modal.active {
        display: flex;
      }
      .ig-profile-modal-content {
        background: #fff;
        width: 100%;
        max-width: 400px;
        border-radius: 16px;
        overflow: hidden;
        animation: modalPop 0.3s ease;
      }
      @keyframes modalPop {
        from { transform: scale(0.9); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }
      .ig-profile-modal-header {
        padding: 16px 20px;
        border-bottom: 1px solid #efefef;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .ig-profile-modal-title {
        font-size: 1rem;
        font-weight: 600;
      }
      .ig-profile-modal-close {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        color: #8e8e8e;
      }
      .ig-profile-modal-body {
        padding: 20px;
      }
      .ig-profile-avatar-edit {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 20px;
      }
      .ig-profile-avatar-preview {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fce4ec, #e1bee7);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 50px;
        overflow: hidden;
        margin-bottom: 12px;
      }
      .ig-profile-avatar-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .ig-profile-avatar-btns {
        display: flex;
        gap: 12px;
      }
      .ig-profile-avatar-btn {
        padding: 8px 16px;
        background: #fafafa;
        border: 1px solid #dbdbdb;
        border-radius: 8px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      .ig-profile-avatar-btn:active {
        background: #f0f0f0;
      }
      .ig-profile-form-group {
        margin-bottom: 16px;
      }
      .ig-profile-form-label {
        display: block;
        font-size: 0.8rem;
        color: #8e8e8e;
        margin-bottom: 6px;
        font-weight: 500;
      }
      .ig-profile-form-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #dbdbdb;
        border-radius: 8px;
        font-size: 0.95rem;
        outline: none;
        transition: border-color 0.2s;
      }
      .ig-profile-form-input:focus {
        border-color: #0095f6;
      }
      .ig-profile-form-textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #dbdbdb;
        border-radius: 8px;
        font-size: 0.95rem;
        outline: none;
        min-height: 80px;
        resize: none;
        font-family: inherit;
      }
      .ig-profile-form-textarea:focus {
        border-color: #0095f6;
      }
      .ig-profile-save-btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
        color: #fff;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        margin-top: 8px;
        transition: opacity 0.2s;
      }
      .ig-profile-save-btn:active {
        opacity: 0.9;
      }

      /* Á©∫Áä∂ÊÄÅ */
      .ig-empty-state {
        text-align: center;
        padding: 60px 20px;
      }
      .ig-empty-icon {
        font-size: 4rem;
        margin-bottom: 16px;
      }
      .ig-empty-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #262626;
        margin-bottom: 8px;
      }
      .ig-empty-text {
        font-size: 0.9rem;
        color: #8e8e8e;
      }

      /* ËØÑËÆ∫ÂºπÁ™ó */
      .ig-comments-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.6);
        z-index: 1000;
        display: none;
        align-items: flex-end;
      }
      .ig-comments-modal.active {
        display: flex;
      }
      .ig-comments-modal-content {
        background: #fff;
        width: 100%;
        max-height: 70vh;
        border-radius: 20px 20px 0 0;
        display: flex;
        flex-direction: column;
        animation: slideUpModal 0.3s ease;
      }
      .ig-comments-header {
        padding: 16px 20px;
        border-bottom: 1px solid #efefef;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .ig-comments-title {
        font-size: 1rem;
        font-weight: 600;
      }
      .ig-comments-close {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
      }
      .ig-comments-list {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
      }
      .ig-full-comment {
        display: flex;
        gap: 12px;
        margin-bottom: 16px;
      }
      .ig-full-comment-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fce4ec, #fff3e0);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        flex-shrink: 0;
        overflow: hidden;
      }
      .ig-full-comment-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .ig-full-comment-content {
        flex: 1;
      }
      .ig-full-comment-user {
        font-weight: 600;
        font-size: 0.9rem;
        color: #262626;
      }
      .ig-full-comment-text {
        font-size: 0.9rem;
        color: #262626;
        margin-top: 2px;
        line-height: 1.4;
      }
      .ig-full-comment-actions {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-top: 6px;
      }
      .ig-full-comment-time {
        font-size: 0.75rem;
        color: #8e8e8e;
      }
      .ig-reply-btn {
        font-size: 0.75rem;
        color: #8e8e8e;
        font-weight: 600;
        cursor: pointer;
      }
      .ig-reply-btn:active {
        color: #262626;
      }
      .ig-reply-tag {
        color: #0095f6;
        font-weight: 500;
      }
      .ig-comments-input-area {
        border-top: 1px solid #efefef;
        padding: 12px 16px;
        padding-bottom: calc(12px + env(safe-area-inset-bottom));
        display: flex;
        gap: 12px;
        align-items: center;
      }
      .ig-comments-input {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid #dbdbdb;
        border-radius: 20px;
        font-size: 0.9rem;
        outline: none;
      }
      .ig-comments-input:focus {
        border-color: #0095f6;
      }
      .ig-comments-send {
        background: none;
        border: none;
        color: #0095f6;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
      }

      /* ËΩ¨ÂèëÈÄâÊã©ÂºπÁ™ó */
      .ig-share-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.6);
        z-index: 1000;
        display: none;
        align-items: flex-end;
      }
      .ig-share-modal.active {
        display: flex;
      }
      .ig-share-modal-content {
        background: #fff;
        width: 100%;
        max-height: 60vh;
        border-radius: 20px 20px 0 0;
        display: flex;
        flex-direction: column;
        animation: slideUpModal 0.3s ease;
      }
      .ig-share-header {
        padding: 16px 20px;
        border-bottom: 1px solid #efefef;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .ig-share-title {
        font-size: 1rem;
        font-weight: 600;
      }
      .ig-share-close {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        color: #666;
      }
      .ig-share-list {
        flex: 1;
        overflow-y: auto;
        padding: 8px 0;
      }
      .ig-share-item {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 12px 20px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .ig-share-item:active {
        background: #f5f5f5;
      }
      .ig-share-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      .ig-share-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .ig-share-info {
        flex: 1;
      }
      .ig-share-name {
        font-size: 1rem;
        font-weight: 600;
        color: #333;
      }
      .ig-share-desc {
        font-size: 0.8rem;
        color: #999;
        margin-top: 2px;
      }
      .ig-share-btn {
        padding: 8px 16px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: #fff;
        border: none;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
      }
      .ig-share-btn:active {
        transform: scale(0.95);
      }
      .ig-share-empty {
        text-align: center;
        padding: 40px 20px;
        color: #999;
      }

      /* Âä®ÊÄÅÊìç‰ΩúËèúÂçï */
      .ig-post-menu {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.6);
        z-index: 1000;
        display: none;
        align-items: flex-end;
      }
      .ig-post-menu.active {
        display: flex;
      }
      .ig-post-menu-content {
        background: #fff;
        width: 100%;
        border-radius: 20px 20px 0 0;
        padding-bottom: env(safe-area-inset-bottom);
        animation: slideUpModal 0.3s ease;
      }
      .ig-post-menu-item {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px 20px;
        font-size: 1rem;
        color: #262626;
        cursor: pointer;
        border-bottom: 1px solid #efefef;
      }
      .ig-post-menu-item:last-child {
        border-bottom: none;
      }
      .ig-post-menu-item:active {
        background: #fafafa;
      }
      .ig-post-menu-item.danger {
        color: #ed4956;
      }
      .ig-post-menu-icon {
        font-size: 1.2rem;
      }
      .ig-post-menu-cancel {
        text-align: center;
        padding: 16px;
        font-weight: 600;
        color: #262626;
        border-top: 8px solid #fafafa;
        cursor: pointer;
      }

      /* ==================== Todo Tab - Ë∂ÖÂèØÁà±Â∞èÂ§πÊùøËÆæËÆ° ==================== */
      #todoTab {
        padding: 16px;
        padding-bottom: 80px;
        background: #fffafa;
        min-height: 100%;
        position: relative;
      }

      /* ËÉåÊôØË£ÖÈ•∞ */
      #todoTab::before {
        content: "‚úø ‚ùÄ ‚úø ‚ùÄ ‚úø";
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 0.8rem;
        color: rgba(255,182,193,0.4);
        letter-spacing: 8px;
        pointer-events: none;
      }

      /* ÂèØÁà±Ê†áÈ¢ò */
      .todo-cute-title {
        text-align: center;
        margin-bottom: 16px;
        padding-top: 8px;
      }
      .todo-cute-title-text {
        font-size: 1.1rem;
        font-weight: 700;
        color: #e75480;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .todo-cute-title-text::before {
        content: "üéÄ";
      }
      .todo-cute-title-text::after {
        content: "üéÄ";
      }

      /* Â§πÊùøÂÆπÂô® */
      .clipboard-container {
        position: relative;
        margin-top: 8px;
      }

      /* ÂèØÁà±Á≤âËâ≤Â§πÂ≠ê */
      .clipboard-clip {
        position: relative;
        width: 70px;
        height: 24px;
        background: linear-gradient(180deg, #ff9eb5 0%, #ff7a9a 100%);
        border-radius: 8px 8px 4px 4px;
        margin: 0 auto;
        z-index: 10;
        box-shadow: 0 3px 10px rgba(255,122,154,0.3);
      }
      .clipboard-clip::before {
        content: "‚ô°";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 12px;
        color: rgba(255,255,255,0.8);
      }
      .clipboard-clip::after {
        content: "";
        position: absolute;
        bottom: -6px;
        left: 50%;
        transform: translateX(-50%);
        width: 50px;
        height: 10px;
        background: linear-gradient(180deg, #ff7a9a, #ff6b8a);
        border-radius: 0 0 6px 6px;
        box-shadow: 0 2px 6px rgba(255,107,138,0.2);
      }

      /* ÂèØÁà±Êú®ÊùøÔºàÁ≤âËâ≤Ë∞ÉÔºâ */
      .clipboard-board {
        background: linear-gradient(135deg, #ffcdd2 0%, #f8bbd9 50%, #f48fb1 100%);
        border-radius: 16px;
        padding: 10px;
        margin-top: -3px;
        box-shadow:
          0 8px 25px rgba(244,143,177,0.3),
          inset 0 2px 0 rgba(255,255,255,0.4);
        position: relative;
        border: 2px solid rgba(255,255,255,0.5);
      }
      .clipboard-board::before {
        content: "";
        position: absolute;
        top: 4px;
        left: 4px;
        right: 4px;
        bottom: 4px;
        border: 2px dashed rgba(255,255,255,0.4);
        border-radius: 12px;
        pointer-events: none;
      }

      /* ÂèØÁà±Á∫∏Âº† */
      .clipboard-paper {
        background: linear-gradient(180deg, #ffffff 0%, #fff9fc 50%, #fff5f8 100%);
        border-radius: 12px;
        padding: 20px 16px;
        position: relative;
        box-shadow:
          0 4px 15px rgba(0,0,0,0.06),
          inset 0 0 30px rgba(255,182,193,0.08);
        min-height: 380px;
      }
      /* Á∫∏Âº†Ë£ÖÈ•∞ - Â∞èÁà±ÂøÉËæπÁ∫ø */
      .clipboard-paper::before {
        content: "‚ô° ‚ô° ‚ô° ‚ô° ‚ô°";
        position: absolute;
        top: 8px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 8px;
        color: rgba(255,182,193,0.5);
        letter-spacing: 12px;
      }
      .clipboard-paper::after {
        content: "";
        position: absolute;
        top: 25px;
        left: 16px;
        right: 16px;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(255,182,193,0.3), transparent);
      }

      /* È°∂ÈÉ®Êó•ÊúüÂå∫Âüü */
      .todo-top-section {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 16px;
        margin-top: 20px;
        padding-bottom: 14px;
        border-bottom: 2px dotted rgba(255,182,193,0.4);
      }

      .todo-date-box {
        background: linear-gradient(135deg, #ff8fab 0%, #ff6b8a 100%);
        padding: 12px 16px;
        border-radius: 16px;
        text-align: center;
        box-shadow:
          0 4px 15px rgba(255,107,138,0.35),
          inset 0 2px 0 rgba(255,255,255,0.3);
        position: relative;
        min-width: 65px;
      }
      .todo-date-box::before {
        content: "‚úß";
        position: absolute;
        top: -4px;
        right: -4px;
        font-size: 12px;
        color: #ffeb3b;
      }
      .todo-date-day {
        font-size: 1.8rem;
        font-weight: 800;
        color: white;
        line-height: 1;
        text-shadow: 0 2px 4px rgba(0,0,0,0.15);
      }
      .todo-date-month {
        font-size: 0.7rem;
        color: rgba(255,255,255,0.95);
        font-weight: 600;
        margin-top: 2px;
      }
      .todo-date-weekday {
        font-size: 0.6rem;
        color: rgba(255,255,255,0.85);
        margin-top: 1px;
      }

      .todo-greeting-box {
        flex: 1;
      }
      .todo-greeting-text {
        font-size: 1rem;
        font-weight: 700;
        color: #e75480;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .todo-greeting-sub {
        font-size: 0.75rem;
        color: #c9879f;
        font-style: italic;
      }

      /* ÂèØÁà±ÁªüËÆ°Âç°Áâá */
      .todo-stats-row {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
      }
      .todo-stat-card {
        flex: 1;
        background: linear-gradient(135deg, #fff 0%, #fff5f8 100%);
        border-radius: 14px;
        padding: 12px 8px;
        text-align: center;
        border: 2px solid rgba(255,182,193,0.3);
        position: relative;
        overflow: hidden;
      }
      .todo-stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #ffb6c1, #ff8fab, #ffb6c1);
      }
      .todo-stat-num {
        font-size: 1.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, #ff6b8a, #e91e63);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        line-height: 1.2;
      }
      .todo-stat-label {
        font-size: 0.65rem;
        color: #c9879f;
        font-weight: 600;
        margin-top: 2px;
      }

      /* ÂàÜÁ±ªÁ≠õÈÄâÊ†è */
      .todo-filter-bar {
        display: flex;
        gap: 6px;
        margin-bottom: 14px;
        overflow-x: auto;
        padding: 4px 0;
        -webkit-overflow-scrolling: touch;
      }
      .todo-filter-bar::-webkit-scrollbar {
        display: none;
      }
      .todo-filter-btn {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 600;
        border: 2px solid rgba(255,182,193,0.4);
        background: white;
        color: #c9879f;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.2s;
      }
      .todo-filter-btn.active {
        background: linear-gradient(135deg, #ff8fab, #ff6b8a);
        color: white;
        border-color: transparent;
        box-shadow: 0 3px 10px rgba(255,107,138,0.3);
        transform: scale(1.02);
      }

      /* ÂæÖÂäûÂàóË°® */
      .todo-list-container {
        margin-bottom: 14px;
      }
      .todo-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        background: white;
        border-radius: 14px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid rgba(255,182,193,0.2);
        position: relative;
      }
      .todo-item::before {
        content: "";
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 4px;
        height: 60%;
        background: linear-gradient(180deg, #ffb6c1, #ff8fab);
        border-radius: 0 4px 4px 0;
      }
      .todo-item:active {
        transform: scale(0.98);
        border-color: rgba(255,182,193,0.5);
      }
      .todo-item.done {
        background: linear-gradient(135deg, #f0fff0 0%, #e8f5e9 100%);
        border-color: rgba(165,214,167,0.4);
      }
      .todo-item.done::before {
        background: linear-gradient(180deg, #a5d6a7, #81c784);
      }

      .todo-checkbox {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid #ffb6c1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: transparent;
        flex-shrink: 0;
        transition: all 0.2s;
        background: white;
      }
      .todo-item.done .todo-checkbox {
        background: linear-gradient(135deg, #a5d6a7, #81c784);
        border-color: #81c784;
        color: white;
        box-shadow: 0 2px 8px rgba(129,199,132,0.3);
      }

      .todo-content {
        flex: 1;
        min-width: 0;
      }
      .todo-text {
        font-size: 0.88rem;
        color: #5a4a5a;
        line-height: 1.4;
        font-weight: 500;
      }
      .todo-item.done .todo-text {
        text-decoration: line-through;
        color: #a0a0a0;
      }
      .todo-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 3px;
      }
      .todo-time {
        font-size: 0.6rem;
        color: #cbb0bf;
      }

      .todo-tag {
        font-size: 0.55rem;
        font-weight: 700;
        padding: 3px 8px;
        border-radius: 10px;
        flex-shrink: 0;
        text-transform: uppercase;
      }
      .tag-health { background: linear-gradient(135deg, #c8e6c9, #a5d6a7); color: #2e7d32; }
      .tag-self { background: linear-gradient(135deg, #f8bbd9, #f48fb1); color: #c2185b; }
      .tag-study { background: linear-gradient(135deg, #bbdefb, #90caf9); color: #1565c0; }
      .tag-work { background: linear-gradient(135deg, #ffe0b2, #ffcc80); color: #ef6c00; }
      .tag-life { background: linear-gradient(135deg, #e1bee7, #ce93d8); color: #7b1fa2; }

      .todo-delete-btn {
        width: 26px;
        height: 26px;
        border-radius: 50%;
        background: rgba(255,107,107,0.1);
        border: none;
        color: #ff6b6b;
        font-size: 0.75rem;
        cursor: pointer;
        opacity: 0;
        transition: all 0.2s;
      }
      .todo-item:hover .todo-delete-btn,
      .todo-item:active .todo-delete-btn {
        opacity: 1;
      }

      /* Ê∑ªÂä†ÊåâÈíÆ - Ë∂ÖÂèØÁà± */
      .todo-add-btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #fff 0%, #fff5f8 100%);
        border: 2px dashed #ffb6c1;
        border-radius: 16px;
        font-size: 0.85rem;
        font-weight: 700;
        color: #e75480;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
      }
      .todo-add-btn::before {
        content: "‚ú®";
        position: absolute;
        left: 20px;
        animation: sparkle 2s infinite;
      }
      .todo-add-btn::after {
        content: "‚ú®";
        position: absolute;
        right: 20px;
        animation: sparkle 2s infinite 0.5s;
      }
      @keyframes sparkle {
        0%, 100% { opacity: 0.3; transform: scale(0.8); }
        50% { opacity: 1; transform: scale(1.2); }
      }
      .todo-add-btn:active {
        background: linear-gradient(135deg, #fff0f5 0%, #ffe4ec 100%);
        transform: scale(0.98);
        border-style: solid;
      }

      /* AIÁõëÁù£Âå∫Âüü - ÂèØÁà±Áâà */
      .todo-ai-section {
        background: linear-gradient(135deg, #fff5f8 0%, #fff0f5 100%);
        border-radius: 20px;
        padding: 16px;
        margin-top: 16px;
        border: 2px solid rgba(255,182,193,0.3);
        position: relative;
      }
      .todo-ai-section::before {
        content: "~ Â∞èÂä©Êâã ~";
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 2px 12px;
        font-size: 0.65rem;
        color: #e75480;
        font-weight: 600;
        border-radius: 10px;
        border: 2px solid rgba(255,182,193,0.3);
      }
      .todo-ai-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
        margin-top: 8px;
      }
      .todo-ai-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff8fab, #ff6b8a);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        box-shadow: 0 4px 12px rgba(255,107,138,0.35);
        animation: bounce 3s infinite;
      }
      @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-3px); }
      }
      .todo-ai-title {
        font-size: 0.9rem;
        font-weight: 700;
        color: #e75480;
      }
      .todo-ai-subtitle {
        font-size: 0.7rem;
        color: #c9879f;
      }
      .todo-ai-char-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .todo-ai-char-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 14px;
        background: white;
        border-radius: 25px;
        border: 2px solid rgba(255,182,193,0.3);
        font-size: 0.75rem;
        font-weight: 600;
        color: #8a6a7f;
        cursor: pointer;
        transition: all 0.2s;
      }
      .todo-ai-char-btn:active {
        transform: scale(0.95);
      }
      .todo-ai-char-btn.active {
        background: linear-gradient(135deg, #ff8fab, #ff6b8a);
        color: white;
        border-color: transparent;
        box-shadow: 0 3px 12px rgba(255,107,138,0.35);
      }
      .todo-ai-char-avatar {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fce4ec, #f8bbd9);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.65rem;
        overflow: hidden;
        border: 2px solid rgba(255,255,255,0.5);
      }
      .todo-ai-char-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .todo-ai-empty {
        text-align: center;
        padding: 16px;
        color: #c9879f;
        font-size: 0.8rem;
      }

      /* ==================== ÁªèÊúüËÆ∞ÂΩïÁ≥ªÁªü ==================== */
      .period-tracker-section {
        margin-top: 20px;
        position: relative;
      }
      .period-card {
        background: linear-gradient(135deg, #fff0f3 0%, #ffe4ec 50%, #ffd6e0 100%);
        border-radius: 24px;
        padding: 20px;
        border: 2px solid rgba(255,182,193,0.4);
        box-shadow: 0 6px 20px rgba(255,182,193,0.2);
        position: relative;
        overflow: hidden;
      }
      .period-card::before {
        content: "";
        position: absolute;
        top: -20px;
        right: -20px;
        width: 80px;
        height: 80px;
        background: radial-gradient(circle, rgba(255,182,193,0.3) 0%, transparent 70%);
        border-radius: 50%;
      }
      .period-card::after {
        content: "";
        position: absolute;
        bottom: -30px;
        left: -30px;
        width: 100px;
        height: 100px;
        background: radial-gradient(circle, rgba(255,107,138,0.15) 0%, transparent 70%);
        border-radius: 50%;
      }

      .period-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
        position: relative;
        z-index: 1;
      }
      .period-icon {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ff6b8a 0%, #e91e63 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4rem;
        box-shadow: 0 4px 15px rgba(233,30,99,0.35);
      }
      .period-title-area {
        flex: 1;
      }
      .period-title {
        font-size: 1rem;
        font-weight: 700;
        color: #c2185b;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .period-subtitle {
        font-size: 0.7rem;
        color: #d4768a;
        margin-top: 2px;
      }

      /* ÁªèÊúüÁä∂ÊÄÅÊòæÁ§∫ */
      .period-status {
        background: white;
        border-radius: 16px;
        padding: 16px;
        margin-bottom: 16px;
        position: relative;
        z-index: 1;
      }
      .period-status-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 12px;
      }
      .period-status-label {
        font-size: 0.8rem;
        color: #8a6a7f;
        font-weight: 500;
      }
      .period-status-value {
        font-size: 0.9rem;
        font-weight: 700;
        color: #c2185b;
      }
      .period-status-value.safe {
        color: #43a047;
      }
      .period-status-value.warning {
        color: #ff9800;
      }
      .period-status-value.period {
        color: #e91e63;
      }

      /* ÁªèÊúüËøõÂ∫¶Êù° */
      .period-progress {
        margin-top: 12px;
      }
      .period-progress-bar {
        height: 8px;
        background: rgba(255,182,193,0.3);
        border-radius: 10px;
        overflow: hidden;
        position: relative;
      }
      .period-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff8fab, #e91e63);
        border-radius: 10px;
        transition: width 0.3s ease;
      }
      .period-progress-labels {
        display: flex;
        justify-content: space-between;
        margin-top: 6px;
        font-size: 0.6rem;
        color: #c9879f;
      }

      /* ÁªèÊúüÊó•ÂéÜ */
      .period-calendar {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        margin-bottom: 16px;
        position: relative;
        z-index: 1;
      }
      .period-cal-header {
        font-size: 0.6rem;
        color: #c9879f;
        text-align: center;
        font-weight: 600;
        padding: 4px 0;
      }
      .period-cal-day {
        aspect-ratio: 1;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        color: #8a6a7f;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
        border: 1px solid transparent;
      }
      .period-cal-day:active {
        transform: scale(0.9);
      }
      .period-cal-day.today {
        border: 2px solid #ff6b8a;
        font-weight: 700;
      }
      .period-cal-day.period {
        background: linear-gradient(135deg, #ff8fab, #ff6b8a);
        color: white;
        font-weight: 600;
      }
      .period-cal-day.predicted {
        background: linear-gradient(135deg, #ffcdd2, #ffb6c1);
        color: #c2185b;
      }
      .period-cal-day.ovulation {
        background: linear-gradient(135deg, #e1f5fe, #b3e5fc);
        color: #0288d1;
      }
      .period-cal-day.empty {
        background: transparent;
        cursor: default;
      }

      /* Êìç‰ΩúÊåâÈíÆ */
      .period-actions {
        display: flex;
        gap: 10px;
        position: relative;
        z-index: 1;
      }
      .period-action-btn {
        flex: 1;
        padding: 12px;
        border-radius: 14px;
        font-size: 0.8rem;
        font-weight: 700;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: all 0.2s;
      }
      .period-action-btn.primary {
        background: linear-gradient(135deg, #ff6b8a, #e91e63);
        color: white;
        box-shadow: 0 4px 15px rgba(233,30,99,0.3);
      }
      .period-action-btn.primary:active {
        transform: scale(0.98);
        box-shadow: 0 2px 8px rgba(233,30,99,0.3);
      }
      .period-action-btn.secondary {
        background: white;
        color: #c2185b;
        border: 2px solid rgba(255,182,193,0.4);
      }
      .period-action-btn.secondary:active {
        background: #fff5f8;
        transform: scale(0.98);
      }

      /* ÁªèÊúüËÆæÁΩÆÂºπÁ™ó */
      .period-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 10000;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }
      .period-modal-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }
      .period-modal {
        background: linear-gradient(180deg, #fff 0%, #fff5f8 100%);
        border-radius: 24px 24px 0 0;
        width: 100%;
        max-width: 500px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
        transform: translateY(100%);
        transition: transform 0.3s ease;
      }
      .period-modal-overlay.active .period-modal {
        transform: translateY(0);
      }
      .period-modal-header {
        padding: 20px;
        border-bottom: 2px solid rgba(255,182,193,0.2);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .period-modal-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #c2185b;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .period-modal-close {
        width: 32px;
        height: 32px;
        border: none;
        background: rgba(255,182,193,0.2);
        border-radius: 50%;
        font-size: 1.1rem;
        color: #c2185b;
        cursor: pointer;
      }
      .period-modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
      }
      .period-input-group {
        margin-bottom: 20px;
      }
      .period-input-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: #8a6a7f;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .period-input {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid rgba(255,182,193,0.3);
        border-radius: 14px;
        font-size: 1rem;
        color: #5a4a5a;
        background: white;
        outline: none;
        transition: all 0.2s;
      }
      .period-input:focus {
        border-color: #ff6b8a;
        box-shadow: 0 0 0 3px rgba(255,107,138,0.15);
      }
      .period-hint {
        font-size: 0.7rem;
        color: #c9879f;
        margin-top: 6px;
        font-style: italic;
      }
      .period-modal-footer {
        padding: 16px 20px;
        padding-bottom: calc(16px + env(safe-area-inset-bottom));
        border-top: 2px solid rgba(255,182,193,0.2);
      }
      .period-save-btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #ff6b8a, #e91e63);
        border: none;
        border-radius: 14px;
        font-size: 1rem;
        font-weight: 700;
        color: white;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(233,30,99,0.3);
        transition: all 0.2s;
      }
      .period-save-btn:active {
        transform: scale(0.98);
      }

      /* ÁªèÊúüÂ∞èË¥¥Â£´ */
      .period-tips {
        background: white;
        border-radius: 14px;
        padding: 14px;
        margin-top: 12px;
        position: relative;
        z-index: 1;
      }
      .period-tips-title {
        font-size: 0.75rem;
        font-weight: 700;
        color: #c2185b;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .period-tips-content {
        font-size: 0.75rem;
        color: #8a6a7f;
        line-height: 1.6;
      }

      /* Ê∑ªÂä†ÂæÖÂäûÂºπÁ™óÊ†∑Âºè */
      .todo-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 10000;
        display: flex;
        align-items: flex-end;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }
      .todo-modal-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }
      .todo-modal {
        background: linear-gradient(180deg, #fff 0%, #fff5f8 100%);
        border-radius: 24px 24px 0 0;
        width: 100%;
        max-width: 500px;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        transform: translateY(100%);
        transition: transform 0.3s ease;
      }
      .todo-modal-overlay.active .todo-modal {
        transform: translateY(0);
      }
      .todo-modal-header {
        padding: 20px;
        border-bottom: 2px solid rgba(255,182,193,0.2);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .todo-modal-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #e75480;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .todo-modal-close {
        width: 32px;
        height: 32px;
        border: none;
        background: rgba(255,182,193,0.2);
        border-radius: 50%;
        font-size: 1.1rem;
        color: #e75480;
        cursor: pointer;
      }
      .todo-modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
      }
      .todo-input-group {
        margin-bottom: 20px;
      }
      .todo-input-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: #8a6a7f;
        margin-bottom: 10px;
        display: block;
      }
      .todo-input {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid rgba(255,182,193,0.3);
        border-radius: 14px;
        font-size: 0.95rem;
        color: #5a4a5a;
        background: white;
        outline: none;
        transition: all 0.2s;
      }
      .todo-input:focus {
        border-color: #ff6b8a;
        box-shadow: 0 0 0 3px rgba(255,107,138,0.15);
      }
      .todo-input::placeholder {
        color: #cbb0bf;
      }
      .todo-tag-select {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .todo-tag-option {
        padding: 10px 16px;
        border-radius: 25px;
        font-size: 0.8rem;
        font-weight: 600;
        border: 2px solid rgba(255,182,193,0.3);
        background: white;
        color: #8a6a7f;
        cursor: pointer;
        transition: all 0.2s;
      }
      .todo-tag-option.selected {
        background: linear-gradient(135deg, #fff0f5, #ffe4ec);
        border-color: #ff6b8a;
        color: #c2185b;
      }
      .todo-modal-footer {
        padding: 16px 20px;
        padding-bottom: calc(16px + env(safe-area-inset-bottom));
        border-top: 2px solid rgba(255,182,193,0.2);
      }
      .todo-save-btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #ff8fab, #ff6b8a);
        border: none;
        border-radius: 14px;
        font-size: 1rem;
        font-weight: 700;
        color: white;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(255,107,138,0.3);
        transition: all 0.2s;
      }
      .todo-save-btn:active {
        transform: scale(0.98);
      }

      /* Á©∫Áä∂ÊÄÅ */
      .todo-empty-state {
        text-align: center;
        padding: 30px 20px;
      }
      .todo-empty-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
        animation: float 3s ease-in-out infinite;
      }
      @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-8px); }
      }
      .todo-empty-text {
        font-size: 0.9rem;
        color: #c9879f;
        margin-bottom: 4px;
        font-weight: 600;
      }
      .todo-empty-hint {
        font-size: 0.75rem;
        color: #dab0c5;
      }

      /* ÂæÖÂäûËÆæÁΩÆÊåâÈíÆ */
      .todo-settings-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: rgba(255,182,193,0.2);
        border: none;
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        z-index: 5;
      }
      .todo-settings-btn:active {
        transform: scale(0.9);
        background: rgba(255,182,193,0.4);
      }

      /* ÂæÖÂäûËÆæÁΩÆÂºπÁ™ó */
      .todo-settings-modal {
        background: linear-gradient(180deg, #fff 0%, #fff5f8 100%);
        border-radius: 24px 24px 0 0;
        width: 100%;
        max-width: 500px;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        transform: translateY(100%);
        transition: transform 0.3s ease;
      }
      .todo-modal-overlay.active .todo-settings-modal {
        transform: translateY(0);
      }

      /* ÂàÜÁ±ªÁÆ°ÁêÜ */
      .todo-category-list {
        margin-top: 10px;
      }
      .todo-category-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        background: white;
        border-radius: 12px;
        margin-bottom: 8px;
        border: 1px solid rgba(255,182,193,0.2);
      }
      .todo-category-emoji {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        background: linear-gradient(135deg, #fff0f5, #ffe4ec);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
      }
      .todo-category-name {
        flex: 1;
        font-size: 0.9rem;
        color: #5a4a5a;
        font-weight: 500;
      }
      .todo-category-delete {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: rgba(255,107,107,0.1);
        border: none;
        color: #ff6b6b;
        font-size: 0.8rem;
        cursor: pointer;
      }
      .todo-category-delete:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }
      .todo-add-category-row {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }
      .todo-add-category-input {
        flex: 1;
        padding: 10px 14px;
        border: 2px solid rgba(255,182,193,0.3);
        border-radius: 12px;
        font-size: 0.9rem;
        outline: none;
      }
      .todo-add-category-input:focus {
        border-color: #ff6b8a;
      }
      .todo-add-category-btn {
        padding: 10px 16px;
        background: linear-gradient(135deg, #ff8fab, #ff6b8a);
        border: none;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        cursor: pointer;
      }

      /* ÈóÆÂÄôËØ≠ËÆæÁΩÆ */
      .greeting-preview {
        background: linear-gradient(135deg, #fff0f5, #ffe4ec);
        border-radius: 12px;
        padding: 14px;
        margin-top: 10px;
        text-align: center;
      }
      .greeting-preview-main {
        font-size: 1rem;
        font-weight: 600;
        color: #e75480;
        margin-bottom: 4px;
      }
      .greeting-preview-sub {
        font-size: 0.75rem;
        color: #c9879f;
      }
      .greeting-input-row {
        display: flex;
        gap: 8px;
        margin-top: 10px;
      }
      .greeting-input-row .todo-input {
        flex: 1;
      }
      .greeting-time-select {
        padding: 10px 12px;
        border: 2px solid rgba(255,182,193,0.3);
        border-radius: 12px;
        font-size: 0.85rem;
        background: white;
        color: #5a4a5a;
        outline: none;
      }

      /* Profile Tab (ÊàëÁöÑ) */
      #profileTab {
        background: #f5f5f5;
        min-height: 100%;
        overflow: hidden;
      }

      .profile-header-card {
        background: white;
        margin: 12px;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 2px 10px var(--shadow);
      }

      .profile-main {
        display: flex;
        align-items: center;
        padding: 20px 16px;
        gap: 14px;
        cursor: pointer;
      }

      .profile-main:active {
        background: #f9f9f9;
      }

      .profile-avatar-large {
        width: 64px;
        height: 64px;
        border-radius: 14px;
        background: linear-gradient(135deg, #fce4ec, #e8f5e9);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
      }

      .profile-info-main {
        flex: 1;
      }

      .profile-name-large {
        font-size: 1.15rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
      }

      .profile-id {
        font-size: 0.8rem;
        color: var(--text-secondary);
      }

      .profile-arrow {
        font-size: 1.5rem;
        color: var(--text-hint);
      }

      .profile-menu {
        background: white;
        margin: 12px;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 2px 10px var(--shadow);
      }

      .menu-item {
        display: flex;
        align-items: center;
        padding: 16px;
        gap: 14px;
        border-bottom: 1px solid #f5f5f5;
        cursor: pointer;
        transition: background 0.2s;
      }

      .menu-item:last-child {
        border-bottom: none;
      }

      .menu-item:active {
        background: #f9f9f9;
      }

      .menu-icon {
        font-size: 22px;
      }

      .menu-text {
        flex: 1;
        font-size: 0.95rem;
        color: var(--text-primary);
      }

      .menu-arrow {
        font-size: 1.2rem;
        color: var(--text-hint);
      }

      /* Chat Tab Bar */
      .chat-tab-bar {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        justify-content: center;
        gap: 4px;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(25px) saturate(180%);
        -webkit-backdrop-filter: blur(25px) saturate(180%);
        padding: 8px 16px;
        border-radius: 25px;
        border: 1px solid rgba(255, 255, 255, 0.5);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        z-index: 50;
        width: calc(100% - 40px);
        max-width: 400px;
      }

      .chat-tab {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
        padding: 6px 0;
        cursor: pointer;
        transition: all 0.2s;
        border-radius: 16px;
        flex: 1;
      }

      .chat-tab:active {
        transform: scale(0.95);
      }

      .chat-tab.active {
        background: rgba(244, 143, 177, 0.15);
      }

      .tab-icon {
        font-size: 20px;
        opacity: 0.5;
        transition: opacity 0.2s;
      }

      .chat-tab.active .tab-icon {
        opacity: 1;
      }

      .tab-label {
        font-size: 0.6rem;
        color: var(--text-secondary);
        transition: color 0.2s;
      }

      .chat-tab.active .tab-label {
        color: var(--accent-pink);
        font-weight: 600;
      }

      /* Tab Badge Â∞èÁ∫¢ÁÇπ */
      .tab-badge {
        position: absolute;
        top: 2px;
        right: 50%;
        transform: translateX(12px);
        min-width: 16px;
        height: 16px;
        background: #ff3b30;
        color: white;
        font-size: 10px;
        font-weight: 600;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0 4px;
        box-shadow: 0 2px 4px rgba(255, 59, 48, 0.4);
        animation: badgePop 0.3s ease;
      }

      .chat-tab {
        position: relative;
      }

      @keyframes badgePop {
        0% { transform: translateX(12px) scale(0); }
        50% { transform: translateX(12px) scale(1.2); }
        100% { transform: translateX(12px) scale(1); }
      }

      /* Êñ∞Ê∂àÊÅØÈÄöÁü•ÂºπÁ™ó - ÂèØÁà±Â∞èÂç°ÁâáÈ£éÊ†º */
      .message-notification {
        position: fixed;
        top: max(16px, env(safe-area-inset-top));
        left: 50%;
        transform: translateX(-50%) translateY(-150%);
        width: calc(100% - 32px);
        max-width: 340px;
        background: linear-gradient(135deg, #fff 0%, #fff5f8 100%);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        padding: 14px 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(244, 143, 177, 0.25),
                    0 2px 8px rgba(0, 0, 0, 0.08),
                    inset 0 1px 0 rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(244, 143, 177, 0.2);
        z-index: 9999;
        transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        cursor: pointer;
      }

      .message-notification.show {
        transform: translateX(-50%) translateY(0);
      }

      .notification-avatar {
        width: 48px;
        height: 48px;
        border-radius: 14px;
        background: linear-gradient(135deg, #fce4ec, #f8bbd9);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(244, 143, 177, 0.3);
        overflow: hidden;
      }

      .notification-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 14px;
        object-fit: cover;
      }

      .notification-content {
        flex: 1;
        min-width: 0;
      }

      .notification-name {
        font-size: 15px;
        font-weight: 600;
        color: #c2185b;
        margin-bottom: 3px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .notification-name::after {
        content: 'üíï';
        font-size: 12px;
      }

      .notification-text {
        font-size: 13px;
        color: #666;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        line-height: 1.4;
      }

      .notification-time {
        font-size: 11px;
        color: #f48fb1;
        flex-shrink: 0;
        background: rgba(244, 143, 177, 0.1);
        padding: 4px 8px;
        border-radius: 10px;
      }

      /* Create Character Modal */
      .create-char-content {
        background: white;
        border-radius: 24px;
        padding: 28px 24px;
        width: 100%;
        max-width: 340px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      }

      .create-char-title {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--text-primary);
        text-align: center;
        margin-bottom: 24px;
      }

      .create-avatar-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 24px;
        cursor: pointer;
      }

      .create-avatar {
        width: 90px;
        height: 90px;
        border-radius: 50%;
        background: linear-gradient(135deg, #fce4ec, #f3e5f5);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 10px;
        overflow: hidden;
        border: 3px dashed #e0e0e0;
        transition: all 0.3s ease;
      }

      .create-avatar:active {
        transform: scale(0.95);
      }

      .create-avatar.has-image {
        border: 3px solid var(--accent-pink);
      }

      .create-avatar-placeholder {
        font-size: 32px;
        opacity: 0.6;
      }

      .create-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .create-avatar-hint {
        font-size: 0.8rem;
        color: var(--text-hint);
      }

      .create-input-group {
        margin-bottom: 18px;
      }

      .create-label {
        display: block;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
      }

      .create-label .required {
        color: #ff6b6b;
      }

      .create-label .optional {
        font-weight: 400;
        color: var(--text-hint);
      }

      .create-input {
        width: 100%;
        padding: 14px 16px;
        border: 1.5px solid #e8e8e8;
        border-radius: 14px;
        font-size: 0.95rem;
        font-family: inherit;
        outline: none;
        transition: border-color 0.2s, box-shadow 0.2s;
        background: #fafafa;
      }

      .create-input:focus {
        border-color: var(--accent-pink);
        background: white;
        box-shadow: 0 0 0 3px rgba(244, 143, 177, 0.15);
      }

      .create-input::placeholder {
        color: var(--text-hint);
      }

      .create-buttons {
        display: flex;
        gap: 12px;
        margin-top: 24px;
      }

      .create-btn {
        flex: 1;
        padding: 14px;
        border: none;
        border-radius: 14px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-family: inherit;
      }

      .create-btn:active {
        transform: scale(0.98);
      }

      .create-btn-cancel {
        background: #f5f5f5;
        color: var(--text-secondary);
      }

      .create-btn-cancel:active {
        background: #eeeeee;
      }

      .create-btn-confirm {
        background: linear-gradient(135deg, #f48fb1, #f06292);
        color: white;
        box-shadow: 0 4px 15px rgba(244, 143, 177, 0.4);
      }

      .create-btn-confirm:active {
        box-shadow: 0 2px 8px rgba(244, 143, 177, 0.4);
      }

      /* ==================== API SETTINGS STYLES ==================== */
      .api-settings-page {
        background: #f5f5f5 !important;
      }

      .api-settings-page::before {
        display: none;
      }

      .api-settings-page .page-header {
        display: flex;
        align-items: center;
        background: white;
        padding: 12px 16px;
        padding-top: max(12px, env(safe-area-inset-top));
        border-bottom: 1px solid #eee;
      }

      .page-header-add {
        width: 36px;
        height: 36px;
        border: none;
        background: none;
        font-size: 20px;
        cursor: pointer;
      }

      .api-settings-content {
        padding: 16px;
      }

      .api-section {
        margin-bottom: 20px;
      }

      .api-section-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 12px;
        padding-left: 4px;
      }

      .api-preset-list {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 2px 10px var(--shadow);
      }

      .api-preset-item {
        display: flex;
        align-items: center;
        padding: 16px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        transition: background 0.2s;
      }

      .api-preset-item:last-child {
        border-bottom: none;
      }

      .api-preset-item:active {
        background: #f9f9f9;
      }

      .api-preset-item.active {
        background: linear-gradient(135deg, #fce4ec, #fff);
      }

      .preset-radio {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        border: 2px solid #ddd;
        margin-right: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.2s;
      }

      .api-preset-item.active .preset-radio {
        border-color: var(--accent-pink);
        background: var(--accent-pink);
      }

      .api-preset-item.active .preset-radio::after {
        content: "‚úì";
        color: white;
        font-size: 12px;
        font-weight: bold;
      }

      .preset-info {
        flex: 1;
        min-width: 0;
      }

      .preset-name {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
      }

      .preset-detail {
        font-size: 0.8rem;
        color: var(--text-hint);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .preset-edit-btn {
        width: 36px;
        height: 36px;
        border: none;
        background: #f5f5f5;
        border-radius: 10px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .preset-edit-btn:active {
        background: #eee;
      }

      .active-config-card {
        background: white;
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 2px 10px var(--shadow);
      }

      .active-config-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #f5f5f5;
      }

      .active-config-row:last-child {
        border-bottom: none;
      }

      .active-label {
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .active-value {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
        max-width: 60%;
        text-align: right;
        word-break: break-all;
      }

      .active-status {
        font-size: 0.8rem;
        font-weight: 600;
        padding: 4px 12px;
        border-radius: 20px;
        background: #e8f5e9;
        color: #4caf50;
      }

      .api-tips {
        background: #fff8e1;
        border-radius: 12px;
        padding: 14px 16px;
        margin-top: 20px;
      }

      .api-tips-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: #f57c00;
        margin-bottom: 6px;
      }

      .api-tips-content {
        font-size: 0.82rem;
        color: #e65100;
        line-height: 1.5;
      }

      /* API Modal */
      .api-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 400;
        align-items: flex-end;
        justify-content: center;
      }

      .api-modal.active {
        display: flex;
      }

      .api-modal-content {
        background: white;
        width: 100%;
        max-height: 90vh;
        border-radius: 24px 24px 0 0;
        display: flex;
        flex-direction: column;
        animation: slideUpModal 0.3s ease-out;
      }

      @keyframes slideUpModal {
        from {
          transform: translateY(100%);
        }
        to {
          transform: translateY(0);
        }
      }

      .api-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 20px 16px;
        border-bottom: 1px solid #f0f0f0;
      }

      .api-modal-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-primary);
      }

      .api-modal-close {
        width: 32px;
        height: 32px;
        border: none;
        background: #f5f5f5;
        border-radius: 50%;
        font-size: 16px;
        cursor: pointer;
        color: var(--text-secondary);
      }

      .api-modal-body {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
      }

      .api-field {
        margin-bottom: 20px;
      }

      .api-field-label {
        display: block;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 10px;
      }

      .api-field-input {
        width: 100%;
        padding: 14px 16px;
        border: 1.5px solid #e8e8e8;
        border-radius: 12px;
        font-size: 0.95rem;
        font-family: inherit;
        outline: none;
        transition: all 0.2s;
        background: #fafafa;
      }

      .api-field-input:focus {
        border-color: var(--accent-pink);
        background: white;
        box-shadow: 0 0 0 3px rgba(244, 143, 177, 0.15);
      }

      .api-field-key {
        position: relative;
      }

      .api-field-key .api-field-input {
        padding-right: 50px;
      }

      .key-toggle-btn {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        opacity: 0.6;
      }

      .model-select-row {
        display: flex;
        gap: 10px;
      }

      .model-input {
        flex: 1;
        cursor: pointer;
      }

      .model-fetch-btn {
        padding: 14px 20px;
        background: #f5f5f5;
        border: 1.5px solid #e8e8e8;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.2s;
        font-family: inherit;
      }

      .model-fetch-btn:active {
        background: #eee;
      }

      .model-fetch-btn.loading {
        color: var(--text-hint);
        pointer-events: none;
      }

      .model-hint {
        font-size: 0.75rem;
        color: var(--text-hint);
        margin-top: 6px;
        padding-left: 2px;
      }

      .model-dropdown {
        display: none;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1.5px solid #e8e8e8;
        border-radius: 12px;
        margin-top: 8px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .model-dropdown.active {
        display: block;
      }

      .model-option {
        padding: 12px 16px;
        font-size: 0.9rem;
        color: var(--text-primary);
        cursor: pointer;
        transition: background 0.2s;
        border-bottom: 1px solid #f5f5f5;
      }

      .model-option:last-child {
        border-bottom: none;
      }

      .model-option:hover,
      .model-option:active {
        background: #f5f5f5;
      }

      .model-option.selected {
        background: #fce4ec;
        color: var(--accent-pink);
        font-weight: 600;
      }

      .api-modal-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        padding-bottom: calc(16px + env(safe-area-inset-bottom));
        border-top: 1px solid #f0f0f0;
        background: #fafafa;
      }

      .api-modal-btn-group {
        display: flex;
        gap: 10px;
      }

      .api-modal-btn {
        padding: 12px 24px;
        border: none;
        border-radius: 12px;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-family: inherit;
      }

      .api-modal-btn:active {
        transform: scale(0.98);
      }

      .btn-cancel {
        background: #f5f5f5;
        color: var(--text-secondary);
      }

      .btn-save {
        background: linear-gradient(135deg, #f48fb1, #f06292);
        color: white;
        box-shadow: 0 4px 15px rgba(244, 143, 177, 0.4);
      }

      .btn-delete {
        background: none;
        color: #ff6b6b;
        padding: 12px 16px;
      }

      /* ==================== CHAT CONVERSATION PAGE ==================== */
      .chat-conversation-page {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #f5f5f5;
        z-index: 300;
        flex-direction: column;
      }

      .chat-conversation-page.active {
        display: flex;
      }

      .conv-header {
        display: flex;
        align-items: center;
        padding: 10px 16px;
        padding-top: max(10px, env(safe-area-inset-top));
        background: transparent;
        border: none;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        z-index: 100;
      }

      .conv-back-btn {
        width: 36px;
        height: 36px;
        border: 1.5px solid rgba(0, 0, 0, 0.15);
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 50%;
        font-size: 18px;
        color: var(--text-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .conv-title-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 2px;
        margin: 0 40px;
      }

      .conv-avatar {
        display: none;
      }

      .conv-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .conv-name {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .conv-subtitle {
        font-size: 0.75rem;
        color: var(--text-secondary);
      }

      .conv-menu-btn {
        width: 36px;
        height: 36px;
        border: 1.5px solid rgba(0, 0, 0, 0.15);
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 50%;
        font-size: 14px;
        letter-spacing: 2px;
        color: var(--text-primary);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .conv-menu {
        display: none;
        position: absolute;
        top: 100%;
        right: 16px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: saturate(180%) blur(20px);
        -webkit-backdrop-filter: saturate(180%) blur(20px);
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        z-index: 110;
      }

      .conv-menu.active {
        display: block;
      }

      .conv-menu-item {
        padding: 14px 20px;
        font-size: 0.9rem;
        color: var(--text-primary);
        cursor: pointer;
        transition: background 0.2s;
        white-space: nowrap;
      }

      .conv-menu-item:hover {
        background: #f5f5f5;
      }

      .conv-menu-item:last-child {
        color: #ff6b6b;
      }

      .conv-messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        padding-top: 100px;
        padding-bottom: calc(100px + env(safe-area-inset-bottom));
        display: flex;
        flex-direction: column;
        gap: 8px;
        background: transparent;
      }

      .conv-empty {
        display: none;
      }

      .conv-empty-icon {
        font-size: 48px;
        margin-bottom: 12px;
      }

      .conv-empty-text {
        font-size: 0.95rem;
        color: var(--text-secondary);
      }

      /* Message bubbles - iMessage style */
      .msg-row {
        display: flex;
        flex-direction: column;
        max-width: 80%;
      }

      .msg-row.user {
        align-self: flex-end;
        align-items: flex-end;
      }

      .msg-row.ai {
        align-self: flex-start;
        align-items: flex-start;
      }
      .msg-bubble {
        padding: 6px 10px;
        border-radius: 14px;
        font-size: 0.95rem;
        line-height: 1.45;
        word-break: break-word;
        margin-bottom: 2px;

        /* ÂÖ≥ÈîÆ‰øÆÂ§çÔºöËÆ©Ê∞îÊ≥°ÂåÖ‰ΩèÊñáÂ≠óÔºå‰∏îÊîØÊåÅÈïøÊñáÊç¢Ë°å */
        width: fit-content;
        max-width: 100%;
        display: inline-block;
        white-space: normal;

        position: relative;
        min-height: auto;
      }
      .msg-row.user .msg-bubble {
        background: linear-gradient(135deg, #fce4ec, #f8bbd9);
        color: #c2185b;
        border-bottom-right-radius: 6px;
      }

      .msg-row.user .msg-bubble:last-child {
        border-bottom-right-radius: 18px;
      }

      .msg-row.ai .msg-bubble {
        background: white;
        color: var(--text-primary);
        border-bottom-left-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }

      .msg-row.ai .msg-bubble:last-child {
        border-bottom-left-radius: 18px;
      }

      .msg-time {
        font-size: 0.7rem;
        color: var(--text-hint);
        margin-top: 4px;
        padding: 0 4px;
      }

      /* Á≥ªÁªüÊ∂àÊÅØÂç°ÁâáÊ†∑Âºè - Áî®‰∫éÁù£‰øÉÂä©ÊâãÁªëÂÆöÁ≠âÁ≥ªÁªü‰∫ã‰ª∂ */
      .msg-system-card {
        width: 100%;
        display: flex;
        justify-content: center;
        margin: 16px 0;
      }

      .system-card {
        background: linear-gradient(135deg, #fff5f8 0%, #fce4ec 100%);
        border-radius: 16px;
        padding: 14px 18px;
        max-width: 280px;
        box-shadow: 0 4px 16px rgba(244, 143, 177, 0.15);
        border: 1px solid rgba(244, 143, 177, 0.2);
        text-align: center;
      }

      .system-card-icon {
        font-size: 28px;
        margin-bottom: 8px;
      }

      .system-card-title {
        font-size: 14px;
        font-weight: 600;
        color: #c2185b;
        margin-bottom: 4px;
      }

      .system-card-desc {
        font-size: 12px;
        color: #888;
      }

      .msg-typing {
        display: flex;
        gap: 4px;
        padding: 12px 16px;
      }

      .msg-typing span {
        width: 8px;
        height: 8px;
        background: #ccc;
        border-radius: 50%;
        animation: typing 1.4s infinite;
      }

      .msg-typing span:nth-child(2) {
        animation-delay: 0.2s;
      }

      .msg-typing span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          transform: translateY(0);
          opacity: 0.4;
        }
        30% {
          transform: translateY(-6px);
          opacity: 1;
        }
      }

      /* Input area - ÂÆåÂÖ®ÈÄèÊòé */
      .conv-input-area {
        padding: 12px 16px;
        padding-bottom: calc(12px + env(safe-area-inset-bottom));
        background: none;
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        border: none;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 100;
      }

      .conv-input-wrapper {
        display: flex;
        align-items: flex-end;
        gap: 10px;
        background: rgba(255, 255, 255, 0.85);
        border-radius: 20px;
        padding: 8px 8px 8px 16px;
        margin-bottom: 10px;
      }

      .conv-input {
        flex: 1;
        border: none;
        background: none;
        font-size: 0.95rem;
        font-family: inherit;
        resize: none;
        outline: none;
        max-height: 100px;
        line-height: 1.4;
      }

      .conv-send-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: none;
        background: linear-gradient(135deg, #f48fb1, #f06292);
        color: white;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        transition: all 0.2s;
      }

      .conv-send-btn:active {
        transform: scale(0.9);
      }

      .conv-reply-btn {
        width: 100%;
        padding: 12px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        font-family: inherit;
        transition: all 0.2s;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .conv-reply-btn:active {
        transform: scale(0.98);
      }

      .conv-reply-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .conv-reply-btn.loading {
        background: #ccc;
        box-shadow: none;
      }

      /* ==================== CHAT SETTINGS STYLES ==================== */
      .chat-settings-page {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(180deg, #fff5f8 0%, #ffeef5 100%);
        z-index: 350;
        flex-direction: column;
        overflow: hidden;
      }

      .chat-settings-page.active {
        display: flex;
        animation: slideInRight 0.3s ease-out;
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .settings-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        padding-top: max(16px, env(safe-area-inset-top));
        background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      }

      .settings-header-title {
        font-size: 1.15rem;
        font-weight: 700;
        color: #c2185b;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .settings-header-title::before {
        content: "‚öôÔ∏è";
        font-size: 1.1rem;
      }

      .settings-close-btn {
        width: 36px;
        height: 36px;
        border: none;
        background: rgba(255, 255, 255, 0.6);
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        color: #c2185b;
        transition: all 0.2s;
      }

      .settings-close-btn:active {
        transform: scale(0.9);
        background: rgba(255, 255, 255, 0.8);
      }

      .settings-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        padding-bottom: calc(100px + env(safe-area-inset-bottom));
      }

      .settings-section {
        background: white;
        border-radius: 20px;
        margin-bottom: 16px;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(194, 24, 91, 0.08);
      }

      .section-header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 16px 20px;
        background: linear-gradient(135deg, #fff0f5 0%, #fce4ec 100%);
        border-bottom: 1px solid rgba(0, 0, 0, 0.03);
      }

      .section-icon {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
      }

      .section-icon.brown {
        background: linear-gradient(135deg, #f8bbd9, #f48fb1);
      }
      .section-icon.purple {
        background: linear-gradient(135deg, #e1bee7, #ce93d8);
      }
      .section-icon.teal {
        background: linear-gradient(135deg, #b2dfdb, #80cbc4);
      }
      .section-icon.orange {
        background: linear-gradient(135deg, #ffe0b2, #ffcc80);
      }
      .section-icon.blue {
        background: linear-gradient(135deg, #bbdefb, #90caf9);
      }

      .section-title {
        font-size: 0.95rem;
        font-weight: 700;
        color: #c2185b;
      }

      .section-body {
        padding: 16px 20px;
      }

      /* Form Elements */
      .form-group {
        margin-bottom: 18px;
      }

      .form-group:last-child {
        margin-bottom: 0;
      }

      .form-label {
        display: block;
        font-size: 0.82rem;
        font-weight: 600;
        color: #7a6b5a;
        margin-bottom: 8px;
      }

      .form-hint {
        font-size: 0.72rem;
        color: #a99e8f;
        font-weight: 400;
        margin-left: 4px;
      }

      .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 1.5px solid #e5ddd3;
        border-radius: 12px;
        font-size: 0.9rem;
        font-family: inherit;
        outline: none;
        background: #faf8f5;
        color: #5d4e37;
        transition: all 0.2s;
      }

      .form-input:focus {
        border-color: #c4a87c;
        background: white;
        box-shadow: 0 0 0 3px rgba(196, 168, 124, 0.15);
      }

      .form-input::placeholder {
        color: #bfb5a8;
      }

      .form-textarea {
        min-height: 100px;
        resize: vertical;
        line-height: 1.5;
      }

      .form-select-wrapper {
        display: flex;
        gap: 10px;
      }

      .form-select {
        flex: 1;
        padding: 12px 16px;
        border: 1.5px solid #e5ddd3;
        border-radius: 12px;
        font-size: 0.9rem;
        font-family: inherit;
        outline: none;
        background: #faf8f5;
        color: #5d4e37;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%237a6b5a' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 14px center;
        padding-right: 36px;
      }

      .form-select:focus {
        border-color: #c4a87c;
        background-color: white;
      }

      .form-btn-small {
        padding: 12px 18px;
        border: 1.5px solid #e5ddd3;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        font-family: inherit;
        background: #faf8f5;
        color: #7a6b5a;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .form-btn-small:active {
        background: #f0ebe5;
        transform: scale(0.98);
      }

      /* Toggle Switch */
      .toggle-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #f0ebe5;
      }

      .toggle-row:last-child {
        border-bottom: none;
      }

      .toggle-label {
        font-size: 0.9rem;
        color: #5d4e37;
        font-weight: 500;
      }

      .toggle-sublabel {
        font-size: 0.75rem;
        color: #a99e8f;
        margin-top: 2px;
      }

      .toggle-switch {
        position: relative;
        width: 50px;
        height: 28px;
        cursor: pointer;
      }

      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .toggle-slider {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #ddd5ca;
        border-radius: 14px;
        transition: all 0.3s;
      }

      .toggle-slider::before {
        content: "";
        position: absolute;
        width: 22px;
        height: 22px;
        left: 3px;
        bottom: 3px;
        background: white;
        border-radius: 50%;
        transition: all 0.3s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .toggle-switch input:checked + .toggle-slider {
        background: linear-gradient(135deg, #c4a87c, #b49870);
      }

      .toggle-switch input:checked + .toggle-slider::before {
        transform: translateX(22px);
      }

      /* Radio Options */
      .radio-group {
        display: flex;
        gap: 12px;
      }

      .radio-option {
        flex: 1;
        padding: 12px 16px;
        border: 1.5px solid #e5ddd3;
        border-radius: 12px;
        background: #faf8f5;
        cursor: pointer;
        text-align: center;
        font-size: 0.85rem;
        color: #7a6b5a;
        font-weight: 500;
        transition: all 0.2s;
      }

      .radio-option.active {
        border-color: #c4a87c;
        background: linear-gradient(135deg, #f5efe8, #ebe3d9);
        color: #5d4e37;
        box-shadow: 0 2px 8px rgba(196, 168, 124, 0.2);
      }

      /* Avatar Upload Section */
      .avatar-upload-row {
        display: flex;
        gap: 24px;
        padding: 12px 0;
      }

      .avatar-upload-col {
        flex: 1;
        text-align: center;
      }

      .avatar-upload-label {
        font-size: 0.8rem;
        color: #7a6b5a;
        margin-bottom: 10px;
        font-weight: 600;
      }

      .avatar-preview {
        width: 72px;
        height: 72px;
        border-radius: 16px;
        margin: 0 auto 10px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        background: linear-gradient(135deg, #f5efe8, #ebe3d9);
        border: 2px dashed #d4c4b0;
        cursor: pointer;
        transition: all 0.2s;
      }

      .avatar-preview:hover {
        border-color: #c4a87c;
        background: linear-gradient(135deg, #ebe3d9, #ddd3c5);
      }

      .avatar-preview.has-image {
        border: 2px solid #c4a87c;
      }

      .avatar-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .avatar-actions {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .avatar-action-btn {
        padding: 8px 12px;
        border: 1px solid #e5ddd3;
        border-radius: 8px;
        background: white;
        font-size: 0.75rem;
        color: #7a6b5a;
        cursor: pointer;
        font-family: inherit;
        transition: all 0.2s;
      }

      .avatar-action-btn:active {
        background: #f5efe8;
      }

      /* Number Input */
      .number-input-row {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .number-input {
        width: 80px;
        padding: 10px 14px;
        border: 1.5px solid #e5ddd3;
        border-radius: 10px;
        font-size: 0.95rem;
        font-family: inherit;
        text-align: center;
        outline: none;
        background: #faf8f5;
        color: #5d4e37;
      }

      .number-input:focus {
        border-color: #c4a87c;
        background: white;
      }

      /* Slider Input */
      .slider-row {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 8px 0;
      }

      .slider-value {
        min-width: 40px;
        font-size: 0.9rem;
        font-weight: 600;
        color: #5d4e37;
        text-align: center;
      }

      .slider-track {
        flex: 1;
        height: 6px;
        background: #e5ddd3;
        border-radius: 3px;
        position: relative;
        cursor: pointer;
      }

      .slider-fill {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        background: linear-gradient(135deg, #c4a87c, #b49870);
        border-radius: 3px;
        transition: width 0.1s;
      }

      .slider-thumb {
        position: absolute;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 20px;
        height: 20px;
        background: white;
        border: 3px solid #c4a87c;
        border-radius: 50%;
        cursor: grab;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }

      input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 6px;
        background: #e5ddd3;
        border-radius: 3px;
        outline: none;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 22px;
        height: 22px;
        background: white;
        border: 3px solid #c4a87c;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      }

      /* Action Buttons Section */
      .action-buttons-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .action-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 14px 16px;
        border: 1.5px solid #e5ddd3;
        border-radius: 14px;
        background: white;
        font-size: 0.88rem;
        font-weight: 600;
        color: #5d4e37;
        cursor: pointer;
        font-family: inherit;
        transition: all 0.2s;
      }

      .action-btn:active {
        background: #f5efe8;
        transform: scale(0.98);
      }

      .action-btn.danger {
        border-color: #e8c4c4;
        color: #b85c5c;
      }

      .action-btn.danger:active {
        background: #fdf5f5;
      }

      /* Settings Footer */
      .settings-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        gap: 12px;
        padding: 16px 20px;
        padding-bottom: calc(16px + env(safe-area-inset-bottom));
        background: white;
        border-top: 1px solid #e5ddd3;
        z-index: 10;
      }

      .footer-btn {
        flex: 1;
        padding: 14px;
        border: none;
        border-radius: 14px;
        font-size: 0.95rem;
        font-weight: 700;
        cursor: pointer;
        font-family: inherit;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .footer-btn:active {
        transform: scale(0.98);
      }

      .footer-btn.cancel {
        background: #f5efe8;
        color: #7a6b5a;
      }

      .footer-btn.save {
        background: linear-gradient(135deg, #c4a87c, #b49870);
        color: white;
        box-shadow: 0 4px 15px rgba(180, 152, 112, 0.35);
      }

      /* Background Preview */
      .bg-preview-container {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 12px 0;
      }

      .bg-preview-phone {
        width: 80px;
        height: 140px;
        border-radius: 12px;
        background: #f5efe8;
        border: 2px solid #e5ddd3;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: #a99e8f;
      }

      .bg-preview-phone img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .bg-upload-btn {
        flex: 1;
        padding: 24px 20px;
        border: 2px dashed #d4c4b0;
        border-radius: 14px;
        background: #faf8f5;
        font-size: 0.9rem;
        font-weight: 600;
        color: #9a8b7a;
        cursor: pointer;
        font-family: inherit;
        text-align: center;
        transition: all 0.2s;
      }

      .bg-upload-btn:hover {
        border-color: #c4a87c;
        background: #f5efe8;
        color: #7a6b5a;
      }

      /* CSS Editor */
      .css-editor-container {
        margin-top: 12px;
      }

      .css-editor {
        width: 100%;
        min-height: 120px;
        padding: 14px;
        border: 1.5px solid #e5ddd3;
        border-radius: 12px;
        font-family: "Monaco", "Menlo", "Consolas", monospace;
        font-size: 0.82rem;
        line-height: 1.5;
        background: #2d2a26;
        color: #e8dfd4;
        resize: vertical;
        outline: none;
      }

      .css-editor::placeholder {
        color: #6d6560;
      }

      .css-editor:focus {
        border-color: #c4a87c;
      }

      .css-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }

      /* Chat Preview */
      .chat-preview-container {
        background: linear-gradient(135deg, #f5efe8, #ebe3d9);
        border-radius: 14px;
        padding: 16px;
        margin-top: 12px;
      }

      .preview-label {
        font-size: 0.75rem;
        color: #9a8b7a;
        margin-bottom: 12px;
        font-weight: 600;
      }

      .preview-msg-row {
        display: flex;
        align-items: flex-end;
        gap: 8px;
        margin-bottom: 10px;
      }

      .preview-msg-row.right {
        flex-direction: row-reverse;
      }

      .preview-avatar {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        background: white;
        flex-shrink: 0;
      }

      .preview-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .preview-bubble {
        padding: 10px 14px;
        border-radius: 16px;
        font-size: 0.85rem;
        max-width: 180px;
      }

      .preview-msg-row:not(.right) .preview-bubble {
        background: white;
        color: #5d4e37;
        border-bottom-left-radius: 4px;
      }

      .preview-msg-row.right .preview-bubble {
        background: linear-gradient(135deg, #c4a87c, #b49870);
        color: white;
        border-bottom-right-radius: 4px;
      }

      .preview-time {
        font-size: 0.65rem;
        color: #a99e8f;
        margin-top: 4px;
        text-align: center;
      }

      /* Settings Scrollbar */
      .settings-content::-webkit-scrollbar {
        width: 4px;
      }

      .settings-content::-webkit-scrollbar-track {
        background: transparent;
      }

      .settings-content::-webkit-scrollbar-thumb {
        background: #d4c4b0;
        border-radius: 2px;
      }
      /* ==================== ÁªàÊûÅÁâàÔºöiMessage ÂÆåÁæéËøûÂèëÊ†∑Âºè (Á∫ØCSSÁâà) ==================== */

      /* 1. Âü∫Á°ÄËÆæÁΩÆÔºöËÆ©Ê∞îÊ≥°Èù†ÂæóÊõ¥ËøëÔºå‰∫ßÁîü‚ÄúÊàêÁªÑ‚ÄùÁöÑÊÑüËßâ */
      .msg-wrapper .msg-row .msg-bubble {
        margin-bottom: 2px !important;
      }

      /* ================= AI (Â∑¶‰æß) ËøûÂèëÈÄªËæë ================= */
      /* ËßÑÂàôAÔºöÂè™Ë¶Å‰∏çÊòØ„ÄêÁ¨¨‰∏Ä‰∏™„ÄëÊ∞îÊ≥°ÔºåÂ∑¶‰∏äËßíÂ∞±Ë¶ÅÂèòÂ∞ñ */
      .msg-row.ai .msg-bubble:not(:first-child) {
        border-top-left-radius: 4px !important;
      }
      /* ËßÑÂàôBÔºöÂè™Ë¶Å‰∏çÊòØ„ÄêÊúÄÂêé‰∏Ä‰∏™„ÄëÊ∞îÊ≥°ÔºåÂ∑¶‰∏ãËßíÂ∞±Ë¶ÅÂèòÂ∞ñ */
      .msg-row.ai .msg-bubble:not(:last-child) {
        border-bottom-left-radius: 4px !important;
      }
      /* ‰øÆÂ§çÔºöÊúÄÂêé‰∏Ä‰∏™Ê∞îÊ≥°ÁöÑÂ∑¶‰∏ãËßí‰øùÊåÅÂúÜÊ∂¶ÔºàÊî∂Â∞æÔºâ */
      .msg-row.ai .msg-bubble:last-child {
        border-bottom-left-radius: 14px !important;
      }

      /* ================= Áî®Êà∑ (Âè≥‰æß) ËøûÂèëÈÄªËæë ================= */
      /* ËßÑÂàôAÔºöÂè™Ë¶Å‰∏çÊòØ„ÄêÁ¨¨‰∏Ä‰∏™„ÄëÊ∞îÊ≥°ÔºåÂè≥‰∏äËßíÂ∞±Ë¶ÅÂèòÂ∞ñ */
      .msg-row.user .msg-bubble:not(:first-child) {
        border-top-right-radius: 4px !important;
      }
      /* ËßÑÂàôBÔºöÂè™Ë¶Å‰∏çÊòØ„ÄêÊúÄÂêé‰∏Ä‰∏™„ÄëÊ∞îÊ≥°ÔºåÂè≥‰∏ãËßíÂ∞±Ë¶ÅÂèòÂ∞ñ */
      .msg-row.user .msg-bubble:not(:last-child) {
        border-bottom-right-radius: 4px !important;
      }
      /* ‰øÆÂ§çÔºöÊúÄÂêé‰∏Ä‰∏™Ê∞îÊ≥°ÁöÑÂè≥‰∏ãËßí‰øùÊåÅÂúÜÊ∂¶ÔºàÊî∂Â∞æÔºâ */
      .msg-row.user .msg-bubble:last-child {
        border-bottom-right-radius: 14px !important;
      }
      /* ==================== ËÅäÂ§©È°µÈù¢ÈáçÊûÑ (iMessage È£éÊ†º) ==================== */

      .menu-item:first-child {
        border-radius: 8px 0 0 8px;
      }
      .menu-item:last-child {
        border-radius: 0 8px 8px 0;
        border-right: none;
      }

      /* ÁÆ≠Â§¥ (ÊåáÂêë‰∏äÊñπÊ∞îÊ≥° - ÂΩìËèúÂçïÊòæÁ§∫Âú®‰∏ãÊñπÊó∂) */
      .context-menu.arrow-top::after {
        bottom: auto;
        top: -6px;
        border-width: 0 6px 6px;
        border-color: transparent transparent rgba(40, 40, 40, 0.9) transparent;
      }
      /* ‰øÆÊîπÂèòÊç¢ÂéüÁÇπÔºå‰ªé‰∏äÊñπÂºπÂá∫ */
      .context-menu.arrow-top {
        transform-origin: center top;
      }
      /* ==================== ‰øÆÂ§çÁâàÔºöÂ§öÈÄâ & Â∫ïÈÉ®Ê†èÊ†∑Âºè ==================== */

      /* 1. Â§öÈÄâÊ®°Âºè‰∏ãÁöÑÊ∞îÊ≥°‰∫§‰∫í */
      /* ÂΩìËøõÂÖ•Â§öÈÄâÊ®°ÂºèÊó∂ÔºåÊ∞îÊ≥°ÂèòÂæóÂèØ‰ª•ÁÇπÂáª */
      .msg-bubble {
        transition: all 0.2s ease;
        position: relative;
      }

      /* ÈÄâ‰∏≠Áä∂ÊÄÅÁöÑÊ∞îÊ≥° */
      .msg-bubble.selected {
        background: #e3f2fd !important;
        border: 2px solid #2196f3 !important;
        color: #0d47a1 !important;
        transform: scale(0.98);
      }
      /* Áî®Êà∑ÂèëÁöÑÊ∞îÊ≥°ÈÄâ‰∏≠Êó∂ÔºåÈ¢úËâ≤Á®çÂæÆÊ∑±‰∏ÄÁÇπ‰ª•Á§∫Âå∫ÂàÜ */
      .msg-row.user .msg-bubble.selected {
        background: #bbdefb !important;
        color: #002171 !important;
      }

      /* 2. ‰øÆÂ§çÂ∫ïÈÉ®Âà†Èô§Ê†è (Êîπ‰∏∫ fixed ÂÆö‰ΩçÔºåÂ±ÇÁ∫ßÊúÄÈ´ò) */
      .selection-footer {
        position: fixed; /* ÂÖ≥ÈîÆÔºöÊîπ‰∏∫ fixed */
        bottom: 0;
        left: 0;
        right: 0;
        height: 70px; /*Á®çÂæÆÈ´ò‰∏ÄÁÇπ */
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        display: none; /* ÈªòËÆ§ÈöêËóè */
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
        z-index: 9999; /* ‰øùËØÅÂú®ÊúÄ‰∏äÂ±Ç */
        padding-bottom: env(safe-area-inset-bottom);
        box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
        animation: slideUpFooter 0.3s ease-out;
      }

      .selection-footer.active {
        display: flex !important; /* Âº∫Âà∂ÊòæÁ§∫ */
      }

      @keyframes slideUpFooter {
        from {
          transform: translateY(100%);
        }
        to {
          transform: translateY(0);
        }
      }

      /* ÊåâÈíÆÊ†∑Âºè‰ºòÂåñ */
      .selection-btn {
        font-size: 1rem;
        font-weight: 600;
        background: none;
        border: none;
        padding: 10px;
        cursor: pointer;
        border-radius: 8px;
      }
      .selection-btn:active {
        background: #f0f0f0;
      }
      .selection-btn.cancel {
        color: #555;
      }
      .selection-btn.delete {
        color: #ff3b30;
        opacity: 0.3;
        pointer-events: none;
        transition: opacity 0.2s;
      }
      .selection-btn.delete.active {
        opacity: 1;
        pointer-events: auto;
      }

      /* ÈöêËóè‰πãÂâçÁöÑ checkbox ÂúÜÂúàÊ†∑ÂºèÔºåÂõ†‰∏∫Êàë‰ª¨ÊîπÁî®Ê∞îÊ≥°ÂèòËâ≤‰∫Ü */
      .selection-checkbox-container {
        display: none !important;
      }
      .msg-wrapper.selecting {
        transform: none !important;
      }

      /* 4. Êí§ÂõûÊ∂àÊÅØÊ†∑Âºè */
      .msg-system-tip {
        font-size: 0.75rem;
        color: #999;
        text-align: center;
        margin: 8px 0;
        padding: 4px 12px;
        background: rgba(0, 0, 0, 0.03);
        border-radius: 4px;
        align-self: center;
        width: fit-content;
      }
      /* ==================== Â∞èËØ¥Ê®°ÂºèÊ∏≤ÊüìÊ†∑Âºè ==================== */
      .msg-bubble i {
        font-style: italic;
        color: #78909c; /* ÂøÉÁêÜÊ¥ªÂä®Áî®Á®çÂæÆÊ∑°‰∏ÄÁÇπÁöÑÈ¢úËâ≤ */
        font-family: serif; /* ÂèØÈÄâÔºöÁî®Ë°¨Á∫ø‰ΩìÂå∫ÂàÜÂøÉÁêÜÊèèÂÜôÔºåÊõ¥ÂÉèÂ∞èËØ¥ */
      }

      /* ==================== ÂæÆ‰ø°È£éÊ†ºËØ≠Èü≥Êù°Ê†∑Âºè ==================== */
      .voice-message {
        display: flex;
        flex-direction: column;
        gap: 4px;
        width: 100%;
      }

      .voice-bar {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 14px;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        cursor: pointer;
        transition: all 0.2s;
        min-width: 80px;
        max-width: 180px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }

      .voice-bar:active {
        transform: scale(0.98);
        background: rgba(240, 240, 240, 0.95);
      }

      .voice-bar.playing {
        background: rgba(245, 245, 245, 0.98);
      }

      /* ËØ≠Èü≥Ê≥¢Á∫πÂä®Áîª */
      .voice-waves {
        display: flex;
        align-items: center;
        gap: 2px;
        height: 16px;
      }

      .voice-waves span {
        width: 3px;
        height: 6px;
        background: #333;
        border-radius: 2px;
        animation: none;
      }

      .voice-bar.playing .voice-waves span {
        animation: voiceWave 0.8s ease-in-out infinite;
      }

      .voice-waves span:nth-child(1) {
        height: 5px;
        animation-delay: 0s;
      }
      .voice-waves span:nth-child(2) {
        height: 10px;
        animation-delay: 0.1s;
      }
      .voice-waves span:nth-child(3) {
        height: 14px;
        animation-delay: 0.2s;
      }
      .voice-waves span:nth-child(4) {
        height: 10px;
        animation-delay: 0.3s;
      }
      .voice-waves span:nth-child(5) {
        height: 5px;
        animation-delay: 0.4s;
      }

      @keyframes voiceWave {
        0%,
        100% {
          transform: scaleY(0.5);
        }
        50% {
          transform: scaleY(1);
        }
      }

      .voice-duration {
        font-size: 0.8rem;
        color: #666;
        font-weight: 500;
        margin-left: auto;
      }

      /* ËØ≠Èü≥ÊñáÂ≠óÂÜÖÂÆπ - ÈªòËÆ§ÈöêËóèÔºåÁÇπÂáªÂêéÊòæÁ§∫ */
      .voice-text {
        display: none;
        font-size: 0.82rem;
        color: #555;
        line-height: 1.4;
        padding: 6px 10px;
        background: rgba(0, 0, 0, 0.03);
        border-radius: 8px;
        margin-top: 2px;
      }

      .voice-text.visible {
        display: block;
      }

      /* ËΩ¨ÊñáÂ≠óÊåâÈíÆ */
      .voice-to-text-btn {
        font-size: 0.72rem;
        color: #999;
        cursor: pointer;
        padding: 2px 0;
        transition: color 0.2s;
      }

      .voice-to-text-btn:active {
        color: #666;
      }

      /* AIÂèëÈÄÅÁöÑËØ≠Èü≥Êù° */
      .msg-row.ai .voice-bar {
        background: rgba(255, 255, 255, 0.95);
      }

      .msg-row.ai .voice-waves span {
        background: #333;
      }

      /* ËØ≠Èü≥Âä†ËΩΩ‰∏≠Áä∂ÊÄÅ */
      .voice-bar.loading {
        opacity: 0.7;
      }

      .voice-bar.loading::after {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.4),
          transparent
        );
        animation: voiceLoading 1.5s infinite;
      }

      @keyframes voiceLoading {
        0% {
          left: -100%;
        }
        100% {
          left: 100%;
        }
      }

      /* ËØ≠Èü≥Ê∂àÊÅØÊ∞îÊ≥°ÁâπÊÆäÊ†∑Âºè - ÈÄèÊòéËÉåÊôØ */
      .msg-bubble.voice-message-bubble {
        background: transparent !important;
        box-shadow: none !important;
        padding: 2px 0 !important;
      }

      .msg-row.user .msg-bubble.voice-message-bubble,
      .msg-row.ai .msg-bubble.voice-message-bubble {
        background: transparent !important;
      }

      /* ==================== ËØ≠Èü≥Êí≠ÊîæÂô®Ê†∑Âºè ==================== */
      .audio-player-bubble {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 12px;
        margin-top: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid rgba(0, 0, 0, 0.05);
        max-width: fit-content;
      }

      .audio-player-bubble:active {
        transform: scale(0.98);
        background: #f0f0f0;
      }

      .audio-icon {
        font-size: 14px;
      }

      .audio-text {
        font-size: 0.8rem;
        color: #666;
        font-weight: 500;
      }

      .audio-player-bubble.playing .audio-icon {
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      /* Âú®ËÆæÁΩÆÈ°µÈáåÁöÑÂ∞èÊèêÁ§∫ */
      .voice-hint-link {
        color: var(--accent-pink);
        text-decoration: underline;
        cursor: pointer;
      }
      /* ==================== ‰øÆÂ§çÔºöÈïøÊåâËèúÂçïÊ†∑Âºè ==================== */
      .context-menu-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.2); /* ËΩªÂæÆÊöóËâ≤ËÉåÊôØ */
        z-index: 9998;
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
        opacity: 0;
        transition: opacity 0.2s;
      }
      .context-menu-overlay.active {
        display: block;
        opacity: 1;
      }

      .context-menu {
        display: none;
        position: fixed; /* Êîπ‰∏∫ fixed Â±Ö‰∏≠ÊòæÁ§∫ */
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        width: 200px;
        overflow: hidden;
        z-index: 9999;
        opacity: 0;
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      .context-menu.show {
        display: block;
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }

      .context-menu .menu-item {
        padding: 14px 20px;
        font-size: 16px;
        color: #333;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        text-align: center;
        cursor: pointer;
      }

      .context-menu .menu-item:last-child {
        border-bottom: none;
      }

      .context-menu .menu-item:active {
        background: #f0f0f0;
      }

      /* ==================== Â§ñËßÇËÆæÁΩÆÈ°µÈù¢Ê†∑Âºè ==================== */
      #appearancePage {
        padding-top: 0 !important;
      }

      #appearancePage .page-header {
        position: sticky;
        top: 0;
        z-index: 100;
        background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
        margin: 0 -16px 16px -16px;
        padding: 16px;
        padding-top: max(16px, env(safe-area-inset-top));
      }

      #appearancePage .page-title {
        color: #c2185b;
      }

      #appearancePage .page-content {
        display: flex !important;
        flex-direction: column !important;
        gap: 16px !important;
      }

      .appearance-section {
        display: block !important;
        width: 100% !important;
        background: rgba(255, 255, 255, 0.7) !important;
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 20px !important;
        padding: 20px !important;
        margin: 0 !important;
        border: 1px solid rgba(255, 255, 255, 0.5);
        box-sizing: border-box !important;
      }

      .appearance-section > h3 {
        display: block !important;
        width: 100% !important;
        font-size: 1rem !important;
        font-weight: 600 !important;
        color: var(--text-primary) !important;
        margin: 0 0 16px 0 !important;
        padding: 0 !important;
        background: none !important;
        border: none !important;
        text-align: left !important;
      }

      .wallpaper-preview {
        display: flex !important;
        width: 100% !important;
        height: 160px !important;
        border-radius: 16px !important;
        background: linear-gradient(135deg, var(--bg-pink), #e8f5e9) !important;
        align-items: center !important;
        justify-content: center !important;
        cursor: pointer;
        overflow: hidden;
        margin-bottom: 12px !important;
        border: 2px dashed rgba(244, 143, 177, 0.4) !important;
      }

      .wallpaper-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .wallpaper-placeholder {
        color: var(--text-secondary);
        font-size: 0.9rem;
      }

      .appearance-btn {
        display: block !important;
        width: 100% !important;
        padding: 12px !important;
        border-radius: 12px !important;
        border: none !important;
        font-size: 0.9rem !important;
        font-weight: 600 !important;
        cursor: pointer;
        text-align: center !important;
      }

      .appearance-btn.secondary {
        background: rgba(0, 0, 0, 0.05) !important;
        color: var(--text-secondary) !important;
      }

      .color-options {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: wrap !important;
        gap: 12px !important;
        width: 100% !important;
      }

      .color-option {
        width: 40px !important;
        height: 40px !important;
        border-radius: 50% !important;
        cursor: pointer;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        flex-shrink: 0 !important;
      }

      .color-option.selected {
        box-shadow: 0 0 0 3px var(--accent-pink), 0 2px 8px rgba(0, 0, 0, 0.2) !important;
      }

      .color-option.custom-color {
        background: linear-gradient(135deg, #ff9a9e, #fad0c4, #a18cd1, #fbc2eb) !important;
        color: white !important;
        font-size: 18px !important;
        font-weight: bold !important;
      }

      .app-customize-list {
        display: flex !important;
        flex-direction: column !important;
        gap: 10px !important;
        width: 100% !important;
      }

      .app-customize-item {
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        gap: 12px !important;
        padding: 10px !important;
        background: rgba(255, 255, 255, 0.5) !important;
        border-radius: 12px !important;
        width: 100% !important;
        box-sizing: border-box !important;
      }

      .app-customize-icon {
        width: 44px !important;
        height: 44px !important;
        min-width: 44px !important;
        border-radius: 10px !important;
        background: linear-gradient(135deg, #fce4ec, #f8bbd9) !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-size: 12px !important;
        font-weight: 600 !important;
        color: var(--text-primary) !important;
        cursor: pointer;
        overflow: hidden;
      }

      .app-customize-icon img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .app-customize-name {
        flex: 1 !important;
        min-width: 0 !important;
        padding: 10px 12px !important;
        border: 1px solid rgba(0, 0, 0, 0.1) !important;
        border-radius: 10px !important;
        font-size: 0.9rem !important;
        background: white !important;
        outline: none;
      }

      .app-customize-name:focus {
        border-color: var(--accent-pink) !important;
      }

      .appearance-save-btn {
        display: block !important;
        width: 100% !important;
        padding: 16px !important;
        border-radius: 16px !important;
        border: none !important;
        background: linear-gradient(135deg, #f48fb1, #f06292) !important;
        color: white !important;
        font-size: 1rem !important;
        font-weight: 700 !important;
        cursor: pointer;
        margin-bottom: 30px !important;
        box-shadow: 0 4px 15px rgba(244, 143, 177, 0.4);
        text-align: center !important;
      }

      .context-menu .menu-item.danger {
        color: #ff3b30;
        font-weight: 500;
      }

      /* Â§¥ÂÉèÊòæÁ§∫ÂºÄÂÖ≥Ê†∑Âºè */
      .avatar-toggle-group {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .toggle-item {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
      }

      .toggle-item input[type="checkbox"] {
        width: 44px;
        height: 24px;
        appearance: none;
        -webkit-appearance: none;
        background: #e0e0e0;
        border-radius: 12px;
        position: relative;
        cursor: pointer;
        transition: background 0.3s ease;
      }

      .toggle-item input[type="checkbox"]:checked {
        background: var(--accent-pink);
      }

      .toggle-item input[type="checkbox"]::before {
        content: "";
        position: absolute;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: transform 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }

      .toggle-item input[type="checkbox"]:checked::before {
        transform: translateX(20px);
      }

      .toggle-label {
        font-size: 0.9rem;
        color: var(--text-primary);
      }

      /* ÂàÜÁªÑÁÆ°ÁêÜÊ†∑Âºè */
      .group-list {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 12px;
      }

      .group-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: #f5f5f5;
        border-radius: 10px;
        margin-bottom: 8px;
      }

      .group-item-name {
        font-size: 0.9rem;
        color: var(--text-primary);
      }

      .group-item-delete {
        width: 24px;
        height: 24px;
        border: none;
        background: rgba(255, 100, 100, 0.2);
        color: #ff6464;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
      }

      .group-add-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      /* Ê∞îÊ≥°È¢úËâ≤ÈÄâÊã©Âô®Ê†∑Âºè */
      .bubble-color-row {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .bubble-color-item {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .bubble-color-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
      }

      .color-picker-combo {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .color-preset-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 6px;
      }

      .color-preset {
        width: 24px;
        height: 24px;
        border-radius: 6px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.2s;
      }

      .color-preset:hover {
        transform: scale(1.15);
      }

      .color-preset.selected {
        border-color: #333;
        box-shadow: 0 0 0 2px white, 0 0 0 4px #333;
      }

      .color-picker-input {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        padding: 0;
        background: none;
      }

      .color-picker-input::-webkit-color-swatch-wrapper {
        padding: 2px;
      }

      .color-picker-input::-webkit-color-swatch {
        border-radius: 6px;
        border: 2px solid rgba(0,0,0,0.1);
      }
      /* ==================== Â∫ïÈÉ®Ê†èÊñ∞Â∏ÉÂ±Ä ==================== */
      .conv-input-area {
        padding: 0 !important;
        background: transparent !important;
        border: none !important;
        position: fixed !important;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 200;
        transition: transform 0.3s ease;
      }

      /* ËæìÂÖ•Ê†èËøô‰∏ÄË°å */
      .conv-input-bar {
        display: flex;
        align-items: flex-end;
        padding: 8px 12px;
        padding-bottom: calc(8px + env(safe-area-inset-bottom));
        gap: 8px;
        background: transparent;
        border: none;
        flex-wrap: nowrap;
      }

      /* Â∑¶‰æßÂä†Âè∑ÊåâÈíÆ */
      .tool-btn {
        width: 34px;
        height: 34px;
        min-width: 34px;
        border-radius: 50%;
        border: 1.5px solid rgba(0, 0, 0, 0.12);
        background: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #888;
        font-size: 22px;
        font-weight: 300;
        cursor: pointer;
        flex-shrink: 0;
        margin-bottom: 2px;
      }
      .tool-btn:active {
        background: rgba(244, 143, 177, 0.1);
      }

      /* ËæìÂÖ•Ê°ÜÂåÖË£πÂ±Ç (Êîπ) */
      .conv-input-wrapper {
        flex: 1;
        min-width: 0;
        background: rgba(255, 255, 255, 0.85);
        border-radius: 20px;
        padding: 8px 12px;
        display: flex;
        align-items: flex-end;
        min-height: 36px;
        margin: 0 !important;
        border: none;
      }

      /* ËæìÂÖ•Ê°ÜÊú¨‰Ωì */
      .conv-input {
        flex: 1;
        min-width: 0;
        max-height: 100px;
        background: transparent;
        padding: 0;
        margin-right: 4px;
        line-height: 1.4;
        font-size: 1rem;
        border: none;
        outline: none;
      }

      /* ËæìÂÖ•Ê°ÜÈáåÁöÑË°®ÊÉÖÂ∞èÊåâÈíÆ */
      .emoji-btn-inner {
        width: 24px;
        height: 24px;
        background: none;
        border: none;
        cursor: pointer;
        opacity: 0.4;
        margin-bottom: 1px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #666;
      }
      .emoji-btn-inner:active {
        opacity: 0.7;
        transform: scale(1.1);
      }
      .emoji-btn-inner svg {
        width: 20px;
        height: 20px;
      }

      /* --- AIÊåâÈíÆÂíåÂèëÈÄÅÊåâÈíÆÁöÑÊ†∑Âºè --- */
      #replyBtn {
        width: 34px !important;
        height: 34px !important;
        min-width: 34px !important;
        border-radius: 50% !important;
        background: linear-gradient(135deg, #fce4ec, #f8bbd9) !important;
        border: none !important;
        margin-bottom: 4px !important;
        flex-shrink: 0 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-size: 16px !important;
        color: #e91e63 !important;
        box-shadow: 0 2px 8px rgba(233, 30, 99, 0.15) !important;
        align-self: flex-end !important;
      }
      .conv-send-btn {
        width: 34px !important;
        height: 34px !important;
        min-width: 34px !important;
        border-radius: 50% !important;
        background: linear-gradient(135deg, #f8bbd9, #f48fb1) !important;
        border: none !important;
        margin-bottom: 4px !important;
        flex-shrink: 0 !important;
        box-shadow: 0 2px 8px rgba(233, 30, 99, 0.2) !important;
        align-self: flex-end !important;
      }

      /* ÁßªÂä®Á´ØÂ∞èÂ±èÂπï‰ºòÂåñ */
      @media screen and (max-width: 380px) {
        .conv-input-bar {
          padding: 8px 10px;
          gap: 6px;
        }
        .tool-btn, .conv-send-btn, #replyBtn {
          width: 32px !important;
          height: 32px !important;
          min-width: 32px !important;
        }
      }

      /* ==================== Â∫ïÈÉ®ÂºπÂá∫Èù¢Êùø ==================== */
      .chat-panel {
        height: 0;
        overflow-y: auto;
        background: #f5f5f5;
        transition: height 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        border-top: 1px solid #e5e5e5;
      }

      .chat-panel.open {
        height: 250px; /* Èù¢ÊùøÂºπÂá∫ÁöÑÈ´òÂ∫¶ */
        padding-bottom: env(safe-area-inset-bottom);
      }

      /* Âä†Âè∑ËèúÂçïÁΩëÊ†º */
      .panel-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        padding: 24px;
      }

      .panel-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }
      .panel-item:active {
        opacity: 0.7;
      }

      .panel-icon-box {
        width: 56px;
        height: 56px;
        border-radius: 16px;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      /* ÂõæÊ†áËÉåÊôØËâ≤ */
      .bg-photo {
        background: #f5f5f5;
      }
      .bg-camera {
        background: #f5f5f5;
      }
      .bg-redpacket {
        background: #ffebee;
        color: #ff5252;
      }
      .bg-call {
        background: #fff3e0;
        color: #ff9800;
      }
      .bg-location {
        background: #e3f2fd;
        color: #2196f3;
      }
      .bg-nudge {
        background: #fce4ec;
        color: #f48fb1;
      }
      .bg-book {
        background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
        color: #4caf50;
      }

      .panel-label {
        font-size: 0.75rem;
        color: #666;
      }

      /* ==================== ‰∏ÄËµ∑ËØª‰π¶È°µÈù¢ ==================== */
      .read-together-page {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(180deg, #fef9e7 0%, #fdf2e9 100%);
        z-index: 400;
        flex-direction: column;
      }
      .read-together-page.active {
        display: flex;
      }
      .read-header {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        padding-top: max(12px, env(safe-area-inset-top));
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      }
      .read-header-back {
        width: 36px;
        height: 36px;
        border: none;
        background: none;
        font-size: 24px;
        color: #4caf50;
        cursor: pointer;
      }
      .read-header-title {
        flex: 1;
        text-align: center;
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
      }
      .read-header-action {
        width: 36px;
        height: 36px;
        border: none;
        background: none;
        font-size: 20px;
        cursor: pointer;
      }
      .read-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px 16px;
      }
      .read-book-info {
        background: white;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 16px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      }
      .read-book-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .read-book-progress {
        font-size: 0.85rem;
        color: #888;
        margin-bottom: 12px;
      }
      .read-progress-bar {
        height: 6px;
        background: #e0e0e0;
        border-radius: 3px;
        overflow: hidden;
      }
      .read-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #81c784, #4caf50);
        border-radius: 3px;
        transition: width 0.3s;
      }
      .read-no-book {
        text-align: center;
        padding: 40px 20px;
      }
      .read-no-book-icon {
        font-size: 64px;
        margin-bottom: 16px;
      }
      .read-no-book-text {
        font-size: 1rem;
        color: #666;
        margin-bottom: 20px;
      }
      .read-import-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: linear-gradient(135deg, #81c784, #4caf50);
        color: white;
        border: none;
        border-radius: 24px;
        font-size: 1rem;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
      }
      .read-import-btn:active {
        transform: scale(0.96);
      }
      .read-current-section {
        background: white;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 16px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      }
      .read-section-label {
        font-size: 0.8rem;
        color: #4caf50;
        margin-bottom: 8px;
        font-weight: 500;
      }
      .read-section-text {
        font-size: 1rem;
        color: #333;
        line-height: 1.8;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
      }
      .read-controls {
        display: flex;
        gap: 12px;
        margin-top: 16px;
      }
      .read-ctrl-btn {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 12px;
        font-size: 0.9rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }
      .read-ctrl-btn.prev {
        background: #f5f5f5;
        color: #666;
      }
      .read-ctrl-btn.next {
        background: linear-gradient(135deg, #81c784, #4caf50);
        color: white;
      }
      .read-ctrl-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .read-settings {
        background: white;
        border-radius: 16px;
        padding: 16px 20px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      }
      .read-setting-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #f0f0f0;
      }
      .read-setting-row:last-child {
        border-bottom: none;
      }
      .read-setting-label {
        font-size: 0.95rem;
        color: #333;
      }
      .read-setting-value {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .read-setting-input {
        width: 80px;
        padding: 6px 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 0.9rem;
        text-align: center;
      }
      .read-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: #e8f5e9;
        color: #4caf50;
        border-radius: 12px;
        font-size: 0.8rem;
      }
      .read-status-badge.inactive {
        background: #f5f5f5;
        color: #999;
      }

      /* ==================== ÊÇ¨ÊµÆÁ™óÊ®°Âºè ==================== */
      .read-floating-btn {
        position: fixed;
        bottom: 160px;
        right: 16px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, #81c784, #4caf50);
        color: white;
        border: none;
        font-size: 24px;
        box-shadow: 0 4px 16px rgba(76, 175, 80, 0.4);
        z-index: 350;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        animation: floatBounce 2s ease-in-out infinite;
      }
      .read-floating-btn.active {
        display: flex;
      }
      @keyframes floatBounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-5px);
        }
      }
      .read-floating-panel {
        position: fixed;
        bottom: 230px;
        right: 16px;
        width: 320px;
        min-width: 200px;
        max-width: 90vw;
        height: 300px;
        min-height: 150px;
        max-height: 70vh;
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        z-index: 351;
        display: none;
        flex-direction: column;
        overflow: hidden;
        resize: both;
      }
      .read-floating-panel.active {
        display: flex;
      }
      .read-float-header {
        display: flex;
        align-items: center;
        padding: 10px 14px;
        background: linear-gradient(135deg, #81c784, #4caf50);
        color: white;
        gap: 8px;
        cursor: move;
        user-select: none;
        flex-shrink: 0;
      }
      .read-float-drag-hint {
        font-size: 12px;
        opacity: 0.8;
      }
      .read-float-title {
        flex: 1;
        font-size: 0.9rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .read-float-progress {
        font-size: 0.75rem;
        opacity: 0.9;
        background: rgba(255, 255, 255, 0.2);
        padding: 2px 8px;
        border-radius: 10px;
      }
      .read-float-close {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 4px;
        opacity: 0.9;
      }
      .read-float-close:hover {
        opacity: 1;
      }
      .read-float-content {
        flex: 1;
        padding: 14px 16px;
        font-size: 1rem;
        line-height: 1.8;
        color: #333;
        overflow-y: auto;
        white-space: pre-wrap;
        background: #fffef5;
      }
      .read-float-controls {
        display: flex;
        border-top: 1px solid #eee;
        flex-shrink: 0;
        background: white;
      }
      .read-float-btn {
        flex: 1;
        padding: 12px;
        border: none;
        background: none;
        font-size: 0.85rem;
        cursor: pointer;
        color: #666;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
      }
      .read-float-btn:active {
        background: #f5f5f5;
      }
      .read-float-btn.primary {
        color: #4caf50;
        font-weight: 500;
      }
      .read-float-btn + .read-float-btn {
        border-left: 1px solid #eee;
      }
      .read-float-resize-hint {
        position: absolute;
        bottom: 4px;
        right: 8px;
        font-size: 10px;
        color: #ccc;
        pointer-events: none;
      }

      /* ==================== ‰π¶Êû∂Ê†∑Âºè ==================== */
      .bookshelf-section {
        margin-bottom: 20px;
      }
      .bookshelf-title {
        font-size: 1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .bookshelf-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }
      .book-card {
        background: white;
        border-radius: 12px;
        padding: 14px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .book-card:active {
        transform: scale(0.98);
      }
      .book-card.reading {
        border: 2px solid #4caf50;
      }
      .book-card-icon {
        font-size: 32px;
        margin-bottom: 8px;
      }
      .book-card-name {
        font-size: 0.9rem;
        font-weight: 500;
        color: #333;
        margin-bottom: 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .book-card-info {
        font-size: 0.75rem;
        color: #888;
      }
      .book-card-progress {
        margin-top: 8px;
        height: 4px;
        background: #e0e0e0;
        border-radius: 2px;
        overflow: hidden;
      }
      .book-card-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #81c784, #4caf50);
        border-radius: 2px;
      }
      .book-card-actions {
        display: flex;
        gap: 8px;
        margin-top: 10px;
      }
      .book-card-btn {
        flex: 1;
        padding: 6px 8px;
        border: none;
        border-radius: 6px;
        font-size: 0.75rem;
        cursor: pointer;
      }
      .book-card-btn.read {
        background: linear-gradient(135deg, #81c784, #4caf50);
        color: white;
      }
      .book-card-btn.delete {
        background: #ffebee;
        color: #f44336;
      }
      .add-book-card {
        background: #f5f5f5;
        border: 2px dashed #ddd;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 120px;
        color: #999;
      }
      .add-book-card:active {
        background: #eee;
      }

      .sticker-item:active {
        transform: scale(0.95);
      }

      .sticker-item img {
        width: 100%;
        height: 100%;
        object-fit: contain; /* ‰øùÊåÅÂõæÁâáÊØî‰æã */
        padding: 4px;
      }

      /* Âà†Èô§ÊåâÈíÆÔºàÈïøÊåâÊòæÁ§∫Ôºâ */
      .sticker-delete-btn {
        position: absolute;
        top: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        width: 20px;
        height: 20px;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-bottom-left-radius: 8px;
      }
      .emoji-item:active {
        background: #e0e0e0;
      }

      /* ËÅäÂ§©ÂõæÁâáÊ†∑Âºè */
      .msg-img-bubble {
        padding: 0 !important;
        overflow: hidden;
        background: transparent !important;
        box-shadow: none !important;
      }
      .msg-img {
        max-width: 200px;
        max-height: 200px;
        border-radius: 12px;
        display: block;
        cursor: pointer;
      }
      /* ==================== Ë°®ÊÉÖÂåÖ Pro Ê†∑Âºè ==================== */

      /* 1. ÂàÜÁ±ªÊ†è */
      .sticker-category-bar {
        display: flex;
        overflow-x: auto;
        padding: 10px 16px;
        gap: 8px;
        background: #f9f9f9;
        border-bottom: 1px solid #eee;
        scrollbar-width: none; /* ÈöêËóèÊªöÂä®Êù° */
      }
      .sticker-category-bar::-webkit-scrollbar {
        display: none;
      }

      .category-tab {
        padding: 6px 12px;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 16px;
        font-size: 0.8rem;
        color: #666;
        white-space: nowrap;
        cursor: pointer;
        transition: all 0.2s;
        user-select: none; /* Á¶ÅÊ≠¢ÊñáÂ≠óÈÄâ‰∏≠ */
        -webkit-user-select: none; /* ÂÖºÂÆπ Safari */
      }

      .category-tab.active {
        background: var(--accent-pink); /* ‰ΩøÁî®‰Ω†ÁöÑ‰∏ªÈ¢òËâ≤ */
        color: white;
        border-color: var(--accent-pink);
        font-weight: 600;
      }

      .category-add-btn {
        padding: 6px 10px;
        background: #eee;
        border-radius: 16px;
        color: #333;
        font-weight: bold;
        cursor: pointer;
        border: none;
        flex-shrink: 0;
      }

      /* ÁºñËæëÊåâÈíÆ */
      .category-edit-btn {
        padding: 6px 12px;
        background: transparent;
        border-radius: 16px;
        color: var(--accent-pink);
        font-size: 0.8rem;
        cursor: pointer;
        border: 1px solid var(--accent-pink);
        flex-shrink: 0;
        margin-left: auto;
      }
      .category-edit-btn:active {
        background: var(--accent-pink);
        color: white;
      }

      /* ÁºñËæëÊ®°Âºè‰∏ãÁöÑÂàÜÁ±ªÊ†áÁ≠æ */
      .category-tab.editing {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding-right: 6px;
      }
      .cat-delete-btn {
        width: 16px;
        height: 16px;
        background: #ff6b6b;
        color: white;
        border-radius: 50%;
        font-size: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .cat-delete-btn:active {
        transform: scale(0.9);
      }

      /* Ë°®ÊÉÖÂåÖÈÄâ‰∏≠Ê†áËÆ∞ */
      .sticker-select-mark {
        position: absolute;
        top: 4px;
        right: 4px;
        width: 20px;
        height: 20px;
        background: var(--accent-pink);
        color: white;
        border-radius: 50%;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.15s;
      }
      .sticker-item.editing .sticker-select-mark {
        opacity: 0.5;
        background: #ccc;
      }
      .sticker-item.editing.selected .sticker-select-mark {
        opacity: 1;
        background: var(--accent-pink);
      }
      .sticker-item.editing.selected .sticker-img-box {
        border: 2px solid var(--accent-pink);
      }

      /* ÁºñËæëÊ®°ÂºèÊìç‰ΩúÊåâÈíÆ */
      .edit-action-btn {
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 0.8rem;
        cursor: pointer;
        border: none;
        flex-shrink: 0;
      }
      .edit-action-btn.select-all {
        background: #f0f0f0;
        color: #333;
      }
      .edit-action-btn.select-all:active {
        background: #e0e0e0;
      }
      .edit-action-btn.delete-btn {
        background: #ffebee;
        color: #f44336;
      }
      .edit-action-btn.delete-btn:active {
        background: #ffcdd2;
      }
      .edit-action-btn.delete-btn:disabled {
        background: #f5f5f5;
        color: #bbb;
        cursor: not-allowed;
      }
      .edit-spacer {
        flex: 1;
      }

      /* ÁºñËæëÊ®°Âºè‰∏ãÂõæÁâáÂÆπÂô®ÈúÄË¶ÅÁõ∏ÂØπÂÆö‰Ωç */
      .sticker-item.editing .sticker-img-box {
        position: relative;
        cursor: pointer;
      }
      .sticker-item.editing:active {
        transform: scale(0.95);
      }

      /* ==================== ‰øÆÂ§çÁâàÔºöË°®ÊÉÖÂåÖÈù¢ÊùøÊ†∑Âºè ==================== */

      /* 1. ËÆ©Èù¢ÊùøÂèòÊàêÂºπÊÄßÁõíÂ≠êÔºåÂ§¥ÈÉ®Âõ∫ÂÆöÔºåÂ∫ïÈÉ®ÊªöÂä® */
      #emojiPanel {
        display: flex !important;
        flex-direction: column !important;
        height: 0 !important;
        padding: 0 !important;
        background: #fff !important;
        overflow: hidden !important;
        transition: height 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      }
      /* ÊøÄÊ¥ªÁä∂ÊÄÅÔºöÈ´òÂ∫¶Â±ïÂºÄ */
      #emojiPanel.open {
        height: 320px !important; /* Â¢ûÂä†È´òÂ∫¶ÂÆπÁ∫≥ÊêúÁ¥¢Ê°Ü */
      }

      /* ÊêúÁ¥¢Ê°ÜÊ†∑Âºè */
      .sticker-search-bar {
        flex-shrink: 0;
        padding: 10px 12px;
        background: #fff;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .sticker-search-input {
        flex: 1;
        height: 32px;
        padding: 0 12px;
        border: 1px solid #e0e0e0;
        border-radius: 16px;
        font-size: 0.85rem;
        background: #f5f5f5;
        outline: none;
      }
      .sticker-search-input:focus {
        border-color: var(--accent-pink);
        background: #fff;
      }
      .sticker-search-clear {
        width: 20px;
        height: 20px;
        background: #ccc;
        color: white;
        border-radius: 50%;
        font-size: 12px;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .sticker-search-clear.show {
        display: flex;
      }

      /* 2. ÂàÜÁ±ªÊ†èÔºöÂõ∫ÂÆöÂú®È°∂ÈÉ® */
      .sticker-category-bar {
        flex-shrink: 0; /* Á¶ÅÊ≠¢ÂéãÁº© */
        display: flex;
        align-items: center;
        overflow-x: auto;
        padding: 8px 12px;
        gap: 8px;
        background: #f9f9f9;
        border-bottom: 1px solid #eee;
      }

      /* AIÁªëÂÆöÊ†áËÆ∞ - ÁÆÄÊ¥ÅÁöÑÂ∞èÂúÜÁÇπÊåáÁ§∫Âô® */
      .category-tab.ai-bound {
        position: relative;
      }
      .category-tab.ai-bound::after {
        content: "";
        position: absolute;
        top: 4px;
        right: 4px;
        width: 6px;
        height: 6px;
        background: #42a5f5;
        border-radius: 50%;
        box-shadow: 0 0 4px rgba(66, 165, 245, 0.5);
      }
      .category-tab.ai-bound.active::after {
        background: #fff;
        box-shadow: 0 0 4px rgba(255, 255, 255, 0.5);
      }

      /* AIÁªëÂÆöÊåâÈíÆ - ÁÆÄÊ¥ÅÂõæÊ†áÈ£éÊ†ºÔºåÁ±ª‰ººÁºñËæëÊåâÈíÆ */
      .ai-bind-btn {
        padding: 4px 10px;
        background: transparent;
        border: 1px solid #ddd;
        border-radius: 12px;
        font-size: 0.75rem;
        color: #666;
        cursor: pointer;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        gap: 3px;
        transition: all 0.2s ease;
      }
      .ai-bind-btn:active {
        background: #f5f5f5;
      }
      .ai-bind-btn.has-bindings {
        background: #e3f2fd;
        border-color: #64b5f6;
        color: #1976d2;
      }

      /* AIÁªëÂÆöÁÆ°ÁêÜÂºπÁ™ó */
      .ai-bind-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
      }
      .ai-bind-modal-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }
      .ai-bind-modal {
        background: #fff;
        border-radius: 16px;
        width: 90%;
        max-width: 360px;
        max-height: 70vh;
        display: flex;
        flex-direction: column;
        transform: scale(0.9);
        transition: transform 0.2s ease;
        overflow: hidden;
      }
      .ai-bind-modal-overlay.active .ai-bind-modal {
        transform: scale(1);
      }
      .ai-bind-modal-header {
        padding: 16px;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .ai-bind-modal-title {
        font-size: 1rem;
        font-weight: 600;
        color: #333;
      }
      .ai-bind-modal-subtitle {
        font-size: 0.75rem;
        color: #999;
        margin-top: 2px;
      }
      .ai-bind-modal-close {
        width: 28px;
        height: 28px;
        border: none;
        background: #f5f5f5;
        border-radius: 50%;
        font-size: 1rem;
        color: #666;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .ai-bind-modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 12px 16px;
      }
      .ai-bind-category-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 8px;
        background: #f9f9f9;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .ai-bind-category-item:active {
        background: #f0f0f0;
        transform: scale(0.98);
      }
      .ai-bind-category-item.selected {
        background: #e3f2fd;
        border: 1px solid #64b5f6;
      }
      .ai-bind-category-checkbox {
        width: 20px;
        height: 20px;
        border: 2px solid #ddd;
        border-radius: 4px;
        margin-right: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
        flex-shrink: 0;
      }
      .ai-bind-category-item.selected .ai-bind-category-checkbox {
        background: #42a5f5;
        border-color: #42a5f5;
        color: #fff;
      }
      .ai-bind-category-info {
        flex: 1;
        min-width: 0;
      }
      .ai-bind-category-name {
        font-size: 0.9rem;
        color: #333;
        font-weight: 500;
      }
      .ai-bind-category-count {
        font-size: 0.75rem;
        color: #999;
        margin-top: 2px;
      }
      .ai-bind-modal-footer {
        padding: 12px 16px;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
      }
      .ai-bind-modal-btn {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 10px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.15s ease;
      }
      .ai-bind-modal-btn.cancel {
        background: #f5f5f5;
        color: #666;
      }
      .ai-bind-modal-btn.confirm {
        background: #42a5f5;
        color: #fff;
      }
      .ai-bind-modal-btn:active {
        transform: scale(0.98);
        opacity: 0.9;
      }
      .ai-bind-empty-hint {
        text-align: center;
        padding: 40px 20px;
        color: #999;
        font-size: 0.85rem;
      }
      .ai-bind-char-hint {
        padding: 10px 12px;
        background: #fff8e1;
        border-radius: 8px;
        margin-bottom: 12px;
        font-size: 0.8rem;
        color: #f57c00;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      /* ÊêúÁ¥¢ÁªìÊûúÊèêÁ§∫ */
      .search-result-hint {
        padding: 8px 12px;
        background: #fff8e1;
        color: #f57c00;
        font-size: 0.8rem;
        text-align: center;
        flex-shrink: 0;
      }

      /* ÊêúÁ¥¢ÁªìÊûú‰∏∫Á©∫ÊèêÁ§∫ */
      .sticker-empty-hint {
        grid-column: 1 / -1;
        text-align: center;
        padding: 40px 20px;
        color: #999;
        font-size: 0.9rem;
      }
        flex-shrink: 0;
      }

      .sticker-img-box:active {
        transform: scale(0.95);
        background: #f5f5f5;
      }
      /* ‰ºòÂåñÂêéÁöÑÁΩëÊ†ºÔºöÂæÆ‰ø°È£éÊ†º */
      .emoji-grid {
        flex: 1;
        overflow-y: auto !important;
        overflow-x: hidden !important; /* Á¶ÅÊ≠¢Â∑¶Âè≥ÊªëÂä® */
        display: grid !important;
        /* Ê†∏ÂøÉ‰øÆÊîπÔºöÂõ∫ÂÆö4Âàó */
        grid-template-columns: repeat(4, 1fr) !important;
        padding: 12px !important;
        gap: 12px 8px !important; /* Ë°åÈó¥Ë∑ù12pxÔºåÂàóÈó¥Ë∑ù8px */
        align-content: start;
        width: 100% !important;
        box-sizing: border-box !important;
      }

      /* Âçï‰∏™Ë°®ÊÉÖÂç°Áâá */
      .sticker-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        width: 100%;
        min-width: 0; /* Èò≤Ê≠¢Ê∫¢Âá∫ */
      }

      /* ÂõæÁâáÂÆπÂô®Ôºö‰øùÊåÅÊ≠£ÊñπÂΩ¢ */
      .sticker-img-box {
        width: 100%;
        aspect-ratio: 1 / 1;
        border-radius: 8px;
        background: #fff;
        border: 1px solid rgba(0, 0, 0, 0.05);
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 4px;
        position: relative; /* ‰∏∫Âà†Èô§Ë¶ÜÁõñÂ±ÇÂÆö‰Ωç */
      }

      /* ÂõæÁâáÊú¨Ë∫´ */
      .sticker-img-box img {
        width: 100%;
        height: 100%;
        object-fit: contain; /* ‰øùÊåÅÊØî‰æã */
      }

      /* ÊèèËø∞ÊñáÂ≠ó */
      .sticker-desc {
        font-size: 0.65rem;
        color: #999;
        text-align: center;
        width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.2;
      }

      /* Ê∑ªÂä†/ÈìæÊé•ÊåâÈíÆ - Áªü‰∏Ä‰ΩøÁî®sticker-img-boxÁöÑÊ†∑Âºè */
      .sticker-add-btn {
        width: 100%;
        aspect-ratio: 1 / 1;
        border-radius: 8px;
        border: 2px dashed #ddd;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: #fafafa;
        color: #bbb;
        margin-bottom: 6px;
      }
      .sticker-add-btn .sticker-add-icon {
        font-size: 20px;
        color: #ccc;
        margin-bottom: 2px;
      }
      .sticker-add-btn .sticker-add-text {
        font-size: 0.65rem;
        color: #aaa;
      }
      /* ÂæÆ‰ø°È£éÊ†ºË°®ÊÉÖÂåÖÊ†∑Âºè */
      .sticker-img {
        max-width: 120px !important; /* ÈôêÂà∂ÊúÄÂ§ßÂÆΩÂ∫¶ */
        max-height: 120px !important;
        width: auto;
        height: auto;
        vertical-align: middle;
        cursor: pointer;
      }

      /* ËøôÊòØ‰∏Ä‰∏™ÁâπÊÆäÁöÑ classÔºåÁî®‰∫éËÆ©Ê∞îÊ≥°ËÉåÊôØÈÄèÊòé */
      .msg-bubble.sticker-bubble {
        background: transparent !important; /* ÂéªÊéâËÉåÊôØËâ≤ */
        box-shadow: none !important; /* ÂéªÊéâÈò¥ÂΩ± */
        padding: 0 !important; /* ÂéªÊéâÂÜÖËæπË∑ù */
        border-radius: 0 !important; /* ÂéªÊéâÂúÜËßí */
      }

      /* ËΩ¨ÂèëÂä®ÊÄÅÂç°ÁâáÊ†∑Âºè - Á≤æËá¥Áâà */
      .shared-post-card {
        background: #fff;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        max-width: 280px;
        border: 1px solid rgba(0,0,0,0.05);
      }
      .shared-post-header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 14px;
        background: linear-gradient(135deg, rgba(102,126,234,0.08), rgba(118,75,162,0.08));
      }
      .shared-post-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #fff;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(102,126,234,0.3);
      }
      .shared-post-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .shared-post-meta {
        flex: 1;
      }
      .shared-post-author {
        font-size: 0.9rem;
        font-weight: 600;
        color: #333;
        display: block;
      }
      .shared-post-time {
        font-size: 0.7rem;
        color: #999;
        margin-top: 1px;
      }
      .shared-post-label {
        font-size: 0.65rem;
        color: #fff;
        background: linear-gradient(135deg, #667eea, #764ba2);
        padding: 3px 8px;
        border-radius: 10px;
        font-weight: 500;
      }
      .shared-post-body {
        padding: 12px 14px;
      }
      .shared-post-content {
        font-size: 0.9rem;
        color: #333;
        line-height: 1.6;
        margin-bottom: 10px;
        display: -webkit-box;
        -webkit-line-clamp: 4;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .shared-post-image {
        width: 100%;
        max-height: 180px;
        object-fit: cover;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      .shared-post-text-img {
        width: 100%;
        height: 100px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.9rem;
        color: #fff;
        text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        position: relative;
        overflow: hidden;
      }
      .shared-post-text-img::before {
        content: "";
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.1);
        backdrop-filter: blur(1px);
      }
      .shared-post-text-img span {
        position: relative;
        z-index: 1;
        padding: 0 12px;
        text-align: center;
      }
      .shared-post-footer {
        padding: 10px 14px;
        background: linear-gradient(135deg, #f8f9ff, #fdf8ff);
        border-top: 1px solid rgba(102,126,234,0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .shared-post-footer-text {
        font-size: 0.75rem;
        color: #888;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      .shared-post-footer-icon {
        font-size: 0.9rem;
      }
      .shared-post-interact {
        font-size: 0.7rem;
        color: #667eea;
        font-weight: 500;
      }

      /* Á¶ÅÁî®ÈïøÊåâÁ≥ªÁªüËèúÂçï */
      .category-tab {
        -webkit-touch-callout: none; /* Á¶ÅÁî® iOS ÈïøÊåâÂºπÂá∫ËèúÂçï */
        -webkit-user-select: none; /* Á¶ÅÁî®ÊñáÂ≠óÈÄâ‰∏≠ */
        user-select: none;
        position: relative; /* Á°Æ‰øùÂÆö‰ΩçÂáÜÁ°Æ */
      }
    </style>
  </head>
  <body>
    <!-- Decorative stars -->
    <div class="star star-1"></div>
    <div class="star star-2"></div>
    <div class="star star-3"></div>
    <div class="star star-4"></div>
    <div class="star star-5"></div>

    <div class="phone-container">
      <div class="main-content">
        <!-- Top decorative bar -->
        <div class="top-bar"></div>

        <!-- Profile Widget -->
        <div class="profile-widget">
          <div
            class="profile-avatar"
            onclick="document.getElementById('avatarInput').click()"
          >
            <div class="profile-avatar-inner">
              <span id="avatarPlaceholder">üê∞</span>
              <img id="avatarImg" src="" alt="" style="display: none" />
            </div>
          </div>
          <input
            type="file"
            id="avatarInput"
            class="hidden-input"
            accept="image/*"
            onchange="handleAvatarUpload(this)"
          />

          <div class="profile-info">
            <div
              class="profile-name"
              id="profileName"
              onclick="openEditModal('name')"
            >
              Áî®Êà∑Âêç
            </div>
            <div
              class="profile-handle"
              id="profileHandle"
              onclick="openEditModal('handle')"
            >
              @YourHandle
            </div>
            <div
              class="profile-bio"
              id="profileBio"
              onclick="openEditModal('bio')"
            >
              ÁÇπÂáªÁºñËæë‰Ω†ÁöÑ‰∏™ÊÄßÁ≠æÂêç ‚ú®
            </div>
          </div>
        </div>

        <!-- Apps -->
        <div class="apps-section">
          <div class="apps-grid">
            <div class="app-item" onclick="openPage('chatPage')">
              <div class="app-icon gradient-pink">ËÅäÂ§©</div>
              <span class="app-name">ËÅäÂ§©</span>
            </div>
            <div class="app-item" onclick="openPage('worldbookPage')">
              <div class="app-icon gradient-green">‰∏ñÁïå‰π¶</div>
              <span class="app-name">‰∏ñÁïå‰π¶</span>
            </div>
            <div class="app-item" onclick="openPage('forumPage')">
              <div class="app-icon gradient-purple">ËÆ∫Âùõ</div>
              <span class="app-name">ËÆ∫Âùõ</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Pages -->
      <div id="chatPage" class="page chat-app">
        <!-- Chat App Header -->
        <div class="chat-header">
          <button class="back-btn" onclick="closePage('chatPage')">‚Üê</button>
          <h1 class="chat-title" id="chatAppTitle">Message</h1>
          <button
            class="chat-header-btn"
            id="chatHeaderBtn"
            onclick="handleHeaderBtn()"
          >
            ‚ûï
          </button>
        </div>

        <!-- Chat App Content -->
        <div class="chat-content">
          <!-- Messages Tab -->
          <div class="chat-tab-content active" id="messagesTab">
            <!-- Search bar -->
            <div class="search-bar">
              <span class="search-icon">üîç</span>
              <input
                type="text"
                placeholder="ÊêúÁ¥¢ËÅäÂ§©ËÆ∞ÂΩï"
                class="search-input"
                id="chatSearchInput"
                oninput="searchChatHistory(this.value)"
              />
            </div>

            <!-- ÊêúÁ¥¢ÁªìÊûú -->
            <div class="search-results" id="searchResults"></div>

            <!-- Message List -->
            <div class="message-list" id="messageList">
              <!-- Empty state -->
              <div class="empty-state" id="emptyMessages">
                <div class="empty-icon">üí≠</div>
                <div class="empty-text">ËøòÊ≤°ÊúâÊ∂àÊÅØÂì¶</div>
                <div class="empty-hint">Ê∑ªÂä†AIËßíËâ≤ÂºÄÂßãËÅäÂ§©ÂêßÔΩû</div>
              </div>
            </div>
          </div>

          <!-- Moments Tab (InstagramÈ£éÊ†ºÂä®ÊÄÅ) -->
          <div class="chat-tab-content" id="momentsTab">
            <!-- StoriesÂå∫Âüü -->
            <div class="ig-stories">
              <div class="ig-stories-inner" id="igStoriesContainer">
                <!-- ÊàëÁöÑStory -->
                <div class="ig-story-item" onclick="openPostModal()">
                  <div class="ig-story-ring my-story">
                    <div class="ig-story-avatar" id="myStoryAvatar">
                      <span class="ig-story-avatar-emoji">üê∞</span>
                    </div>
                    <div class="ig-story-add">+</div>
                  </div>
                  <span class="ig-story-name">‰Ω†ÁöÑÂä®ÊÄÅ</span>
                </div>
                <!-- AIËßíËâ≤ÁöÑStories‰ºöÂä®ÊÄÅÊ∏≤Êüì -->
              </div>
            </div>

            <!-- Âä®ÊÄÅÂàóË°® -->
            <div class="ig-feed" id="igFeed">
              <div class="ig-empty-state" id="igEmptyState">
                <div class="ig-empty-icon">üì∑</div>
                <div class="ig-empty-title">ÂàÜ‰∫´‰Ω†ÁöÑÁ≤æÂΩ©Áû¨Èó¥</div>
                <div class="ig-empty-text">ÁÇπÂáªÂè≥‰∏ãËßíÊåâÈíÆÂèëÂ∏ÉÁ¨¨‰∏ÄÊù°Âä®ÊÄÅÂêß~</div>
              </div>
            </div>

            <!-- ÂèëÂ∏ÉÊåâÈíÆ -->
            <button class="ig-fab" onclick="openPostModal()">
              <span class="ig-fab-icon">+</span>
            </button>
          </div>

          <!-- ÂèëÂ∏ÉÂä®ÊÄÅÂºπÁ™ó -->
          <div
            class="ig-post-modal"
            id="igPostModal"
            onclick="if(event.target===this)closePostModal()"
          >
            <div class="ig-post-modal-content">
              <div class="ig-modal-header">
                <button class="ig-modal-close" onclick="closePostModal()">
                  ÂèñÊ∂à
                </button>
                <span class="ig-modal-title">Êñ∞Âä®ÊÄÅ</span>
                <button
                  class="ig-modal-submit"
                  id="igPostSubmit"
                  onclick="submitPost()"
                  disabled
                >
                  ÂèëÂ∏É
                </button>
              </div>
              <div class="ig-modal-body">
                <textarea
                  class="ig-post-textarea"
                  id="igPostText"
                  placeholder="ÂàÜ‰∫´‰Ω†ÁöÑÊÉ≥Ê≥ï..."
                  oninput="checkPostValid()"
                ></textarea>
                <div class="ig-image-options">
                  <div
                    class="ig-image-option"
                    onclick="selectImageOption('album')"
                    id="imgOptionAlbum"
                  >
                    <span class="ig-image-option-icon">üñºÔ∏è</span>
                    <span class="ig-image-option-text">‰ªéÁõ∏ÂÜåÈÄâÊã©</span>
                  </div>
                  <div
                    class="ig-image-option"
                    onclick="selectImageOption('text')"
                    id="imgOptionText"
                  >
                    <span class="ig-image-option-icon">üé®</span>
                    <span class="ig-image-option-text">ÊñáÂ≠óÈÖçÂõæ</span>
                  </div>
                </div>
                <input
                  type="file"
                  id="igImageInput"
                  accept="image/*"
                  style="display: none"
                  onchange="handleImageSelect(event)"
                />
                <input
                  type="text"
                  class="ig-text-img-input"
                  id="igTextImgInput"
                  placeholder="ËæìÂÖ•ÂõæÁâáÊèèËø∞ÔºåAIÂ∞ÜÁúãÂà∞Ëøô‰∏™ÊèèËø∞..."
                  oninput="checkPostValid()"
                />
                <div class="ig-image-preview" id="igImagePreview">
                  <img id="igPreviewImg" src="" alt="" />
                  <span class="ig-image-preview-remove" onclick="removeImage()"
                    >‚ùå ÁßªÈô§ÂõæÁâá</span
                  >
                </div>

                <!-- ÂèØËßÅËåÉÂõ¥ÈÄâÊã© -->
                <div class="ig-visibility-section">
                  <div class="ig-visibility-label">üëÅÔ∏è Ë∞ÅÂèØ‰ª•Áúã</div>
                  <div class="ig-visibility-options" id="visibilityOptions">
                    <div
                      class="ig-visibility-option selected"
                      data-value="all"
                      onclick="selectVisibility('all', this)"
                    >
                      <span class="check-icon">‚úì</span> ÂÖ¨ÂºÄ
                    </div>
                    <!-- ÂàÜÁªÑÈÄâÈ°π‰ºöÈÄöËøáJSÂä®ÊÄÅÊ∏≤Êüì -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ‰∏™‰∫∫ËµÑÊñôÁºñËæëÂºπÁ™ó -->
          <div
            class="ig-profile-modal"
            id="igProfileModal"
            onclick="if(event.target===this)closeProfileModal()"
          >
            <div class="ig-profile-modal-content">
              <div class="ig-profile-modal-header">
                <span class="ig-profile-modal-title">ÁºñËæë‰∏™‰∫∫ËµÑÊñô</span>
                <button
                  class="ig-profile-modal-close"
                  onclick="closeProfileModal()"
                >
                  ‚úï
                </button>
              </div>
              <div class="ig-profile-modal-body">
                <div class="ig-profile-avatar-edit">
                  <div class="ig-profile-avatar-preview" id="igAvatarPreview">
                    üê∞
                  </div>
                  <div class="ig-profile-avatar-btns">
                    <button
                      class="ig-profile-avatar-btn"
                      onclick="document.getElementById('igAvatarInput').click()"
                    >
                      ‰∏ä‰º†ÁÖßÁâá
                    </button>
                    <button
                      class="ig-profile-avatar-btn"
                      onclick="openEmojiPicker()"
                    >
                      ÈÄâÊã©Ë°®ÊÉÖ
                    </button>
                  </div>
                  <input
                    type="file"
                    id="igAvatarInput"
                    accept="image/*"
                    style="display: none"
                    onchange="handleAvatarSelect(event)"
                  />
                </div>
                <div class="ig-profile-form-group">
                  <label class="ig-profile-form-label">ÊòµÁß∞</label>
                  <input
                    type="text"
                    class="ig-profile-form-input"
                    id="igEditName"
                    placeholder="ËæìÂÖ•‰Ω†ÁöÑÊòµÁß∞"
                  />
                </div>
                <div class="ig-profile-form-group">
                  <label class="ig-profile-form-label">Áî®Êà∑Âêç</label>
                  <input
                    type="text"
                    class="ig-profile-form-input"
                    id="igEditHandle"
                    placeholder="@username"
                  />
                </div>
                <div class="ig-profile-form-group">
                  <label class="ig-profile-form-label">‰∏™ÊÄßÁ≠æÂêç</label>
                  <textarea
                    class="ig-profile-form-textarea"
                    id="igEditBio"
                    placeholder="ÂÜôÁÇπ‰ªÄ‰πà‰ªãÁªç‰∏Ä‰∏ãËá™Â∑±Âêß~"
                  ></textarea>
                </div>
                <button class="ig-profile-save-btn" onclick="saveProfile()">
                  ‰øùÂ≠ò
                </button>
              </div>
            </div>
          </div>

          <!-- ËØÑËÆ∫ÂºπÁ™ó -->
          <div
            class="ig-comments-modal"
            id="igCommentsModal"
            onclick="if(event.target===this)closeCommentsModal()"
          >
            <div class="ig-comments-modal-content">
              <div class="ig-comments-header">
                <span class="ig-comments-title">ËØÑËÆ∫</span>
                <button
                  class="ig-comments-close"
                  onclick="closeCommentsModal()"
                >
                  ‚úï
                </button>
              </div>
              <div class="ig-comments-list" id="igCommentsList">
                <!-- ËØÑËÆ∫‰ºöÂä®ÊÄÅÊ∏≤Êüì -->
              </div>
              <div class="ig-comments-input-area">
                <input
                  type="text"
                  class="ig-comments-input"
                  id="igCommentInput"
                  placeholder="Ê∑ªÂä†ËØÑËÆ∫..."
                />
                <button class="ig-comments-send" onclick="sendComment()">
                  ÂèëÈÄÅ
                </button>
              </div>
            </div>
          </div>

          <!-- ËΩ¨ÂèëÈÄâÊã©ÂºπÁ™ó -->
          <div
            class="ig-share-modal"
            id="igShareModal"
            onclick="if(event.target===this)closeShareModal()"
          >
            <div class="ig-share-modal-content">
              <div class="ig-share-header">
                <span class="ig-share-title">ËΩ¨ÂèëÁªô</span>
                <button class="ig-share-close" onclick="closeShareModal()">
                  ‚úï
                </button>
              </div>
              <div class="ig-share-list" id="igShareList">
                <!-- ËßíËâ≤ÂàóË°®‰ºöÂä®ÊÄÅÊ∏≤Êüì -->
              </div>
            </div>
          </div>

          <!-- Âä®ÊÄÅÊìç‰ΩúËèúÂçï -->
          <div
            class="ig-post-menu"
            id="igPostMenu"
            onclick="if(event.target===this)closePostMenu()"
          >
            <div class="ig-post-menu-content">
              <div class="ig-post-menu-item" onclick="deletePost()">
                <span class="ig-post-menu-icon">üóëÔ∏è</span>
                <span>Âà†Èô§Âä®ÊÄÅ</span>
              </div>
              <div class="ig-post-menu-cancel" onclick="closePostMenu()">
                ÂèñÊ∂à
              </div>
            </div>
          </div>

          <!-- Todo Tab - Ë∂ÖÂèØÁà±Â∞èÂ§πÊùøËÆæËÆ° -->
          <div class="chat-tab-content" id="todoTab">
            <!-- ÂèØÁà±Ê†áÈ¢ò -->
            <div class="todo-cute-title">
              <div class="todo-cute-title-text" id="todoTitleText">
                ÊàëÁöÑÂ∞èÊú¨Êú¨
              </div>
            </div>

            <div class="clipboard-container">
              <!-- Â§πÂ≠ê -->
              <div class="clipboard-clip"></div>
              <!-- Êú®Êùø -->
              <div class="clipboard-board">
                <!-- Á∫∏Âº† -->
                <div class="clipboard-paper">
                  <!-- È°∂ÈÉ®Âå∫Âüü -->
                  <div class="todo-top-section">
                    <div class="todo-date-box">
                      <div class="todo-date-day" id="todoDateDay">24</div>
                      <div class="todo-date-month" id="todoDateMonth">12Êúà</div>
                      <div class="todo-date-weekday" id="todoDateWeekday">
                        Âë®‰∫å
                      </div>
                    </div>
                    <div class="todo-greeting-box">
                      <div class="todo-greeting-text" id="todoGreeting">
                        ‰ªäÂ§©‰πüË¶ÅÂä†Ê≤πÈ∏≠ÔºÅü¶Ü
                      </div>
                      <div class="todo-greeting-sub" id="todoGreetingSub">
                        Êñ∞ÁöÑ‰∏ÄÂ§©ÔºåÊñ∞ÁöÑÂºÄÂßã~
                      </div>
                    </div>
                  </div>

                  <!-- ÁªüËÆ°Âç°Áâá -->
                  <div class="todo-stats-row">
                    <div class="todo-stat-card">
                      <div class="todo-stat-num" id="todoStatTotal">0</div>
                      <div class="todo-stat-label">ÂÖ®ÈÉ®</div>
                    </div>
                    <div class="todo-stat-card">
                      <div class="todo-stat-num" id="todoStatDone">0</div>
                      <div class="todo-stat-label">ÂÆåÊàê</div>
                    </div>
                    <div class="todo-stat-card">
                      <div class="todo-stat-num" id="todoStatPending">0</div>
                      <div class="todo-stat-label">ÂæÖÂäû</div>
                    </div>
                  </div>

                  <!-- ÂàÜÁ±ªÁ≠õÈÄâ - Âä®ÊÄÅÊ∏≤Êüì -->
                  <div class="todo-filter-bar" id="todoFilterBar">
                    <!-- Âä®ÊÄÅÊ∏≤Êüì -->
                  </div>

                  <!-- ÂæÖÂäûÂàóË°® -->
                  <div class="todo-list-container" id="todoListContainer">
                    <!-- Âä®ÊÄÅÊ∏≤Êüì -->
                  </div>

                  <!-- Ê∑ªÂä†ÊåâÈíÆ -->
                  <button class="todo-add-btn" onclick="openTodoModal()">
                    <span>‚úèÔ∏è</span> Ê∑ªÂä†Êñ∞ÂæÖÂäû
                  </button>

                  <!-- ÁõëÁù£Âå∫Âüü -->
                  <div class="todo-ai-section">
                    <div class="todo-ai-header">
                      <div class="todo-ai-icon">üíù</div>
                      <div>
                        <div class="todo-ai-title">Áù£‰øÉÂ∞èÂä©Êâã</div>
                        <div class="todo-ai-subtitle">ÈÄâÊã©Ë∞ÅÊù•Èô™‰º¥Áù£‰øÉ‰Ω†~</div>
                      </div>
                    </div>
                    <div class="todo-ai-char-list" id="todoAiCharList">
                      <!-- Âä®ÊÄÅÊ∏≤ÊüìËßíËâ≤ÂàóË°® -->
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- ÁªèÊúüËÆ∞ÂΩïÁ≥ªÁªü -->
            <div class="period-tracker-section">
              <div class="period-card">
                <div class="period-header">
                  <div class="period-icon">üå∏</div>
                  <div class="period-title-area">
                    <div class="period-title">
                      ÁîüÁêÜÊúüËÆ∞ÂΩï <span style="font-size: 0.7rem">üíï</span>
                    </div>
                    <div class="period-subtitle">ËÆ∞ÂΩïÂë®ÊúüÔºåTA‰ª¨‰ºöÊõ¥ÊáÇ‰Ω†~</div>
                  </div>
                </div>

                <!-- Áä∂ÊÄÅÊòæÁ§∫ -->
                <div class="period-status">
                  <div class="period-status-row">
                    <span class="period-status-label">ÂΩìÂâçÁä∂ÊÄÅ</span>
                    <span class="period-status-value" id="periodStatusText"
                      >ÁÇπÂáªËÆæÁΩÆÂºÄÂßãËÆ∞ÂΩï</span
                    >
                  </div>
                  <div class="period-status-row">
                    <span class="period-status-label">Ë∑ùÁ¶ª‰∏ãÊ¨°</span>
                    <span class="period-status-value safe" id="periodNextText"
                      >--</span
                    >
                  </div>
                  <div class="period-progress">
                    <div class="period-progress-bar">
                      <div
                        class="period-progress-fill"
                        id="periodProgressFill"
                        style="width: 0%"
                      ></div>
                    </div>
                    <div class="period-progress-labels">
                      <span>Âë®ÊúüÂºÄÂßã</span>
                      <span id="periodCycleDay">Á¨¨ - Â§©</span>
                      <span>‰∏ãÊ¨°ÁªèÊúü</span>
                    </div>
                  </div>
                </div>

                <!-- ÁÆÄÊòìÊó•ÂéÜ -->
                <div class="period-calendar" id="periodCalendar">
                  <div class="period-cal-header">Êó•</div>
                  <div class="period-cal-header">‰∏Ä</div>
                  <div class="period-cal-header">‰∫å</div>
                  <div class="period-cal-header">‰∏â</div>
                  <div class="period-cal-header">Âõõ</div>
                  <div class="period-cal-header">‰∫î</div>
                  <div class="period-cal-header">ÂÖ≠</div>
                  <!-- Êó•ÊúüÂä®ÊÄÅÊ∏≤Êüì -->
                </div>

                <!-- Â∞èË¥¥Â£´ -->
                <div class="period-tips">
                  <div class="period-tips-title">üí° Ê∏©È¶®ÊèêÁ§∫</div>
                  <div class="period-tips-content" id="periodTipsContent">
                    ËÆæÁΩÆÁªèÊúü‰ø°ÊÅØÂêéÔºåTA‰ª¨‰ºöÂú®ÁâπÊÆäÊó∂ÊúüÁªô‰Ω†Êõ¥Â§öÂÖ≥ÂøÉÂíåÊ∏©ÊöñÂì¶~
                  </div>
                </div>

                <!-- Êìç‰ΩúÊåâÈíÆ -->
                <div class="period-actions">
                  <button
                    class="period-action-btn secondary"
                    onclick="openPeriodModal()"
                  >
                    ‚öôÔ∏è ËÆæÁΩÆ
                  </button>
                  <button
                    class="period-action-btn primary"
                    onclick="recordPeriodStart()"
                  >
                    ü©∏ ËÆ∞ÂΩïÊù•‰∫Ü
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Ê∑ªÂä†ÂæÖÂäûÂºπÁ™ó -->
          <div
            class="todo-modal-overlay"
            id="todoModalOverlay"
            onclick="if(event.target===this)closeTodoModal()"
          >
            <div class="todo-modal">
              <div class="todo-modal-header">
                <div class="todo-modal-title">‚úèÔ∏è Ê∑ªÂä†ÂæÖÂäû</div>
                <button class="todo-modal-close" onclick="closeTodoModal()">
                  ‚úï
                </button>
              </div>
              <div class="todo-modal-body">
                <div class="todo-input-group">
                  <label class="todo-input-label">ÂæÖÂäûÂÜÖÂÆπ</label>
                  <input
                    type="text"
                    class="todo-input"
                    id="todoInputText"
                    placeholder="‰ªäÂ§©Ë¶ÅÂÅö‰ªÄ‰πàÂë¢Ôºü"
                    maxlength="100"
                  />
                </div>
                <div class="todo-input-group">
                  <label class="todo-input-label">ÈÄâÊã©ÂàÜÁ±ª</label>
                  <div class="todo-tag-select" id="todoTagSelect">
                    <!-- Âä®ÊÄÅÊ∏≤Êüì -->
                  </div>
                </div>
              </div>
              <div class="todo-modal-footer">
                <button class="todo-save-btn" onclick="saveTodoItem()">
                  Ê∑ªÂä†ÂæÖÂäû
                </button>
              </div>
            </div>
          </div>

          <!-- ÂæÖÂäûËÆæÁΩÆÂºπÁ™ó -->
          <div
            class="todo-modal-overlay"
            id="todoSettingsOverlay"
            onclick="if(event.target===this)closeTodoSettingsModal()"
          >
            <div class="todo-settings-modal">
              <div class="todo-modal-header">
                <div class="todo-modal-title">‚öôÔ∏è ÂæÖÂäûËÆæÁΩÆ</div>
                <button
                  class="todo-modal-close"
                  onclick="closeTodoSettingsModal()"
                >
                  ‚úï
                </button>
              </div>
              <div class="todo-modal-body">
                <!-- Ê†áÈ¢òËÆæÁΩÆ -->
                <div class="todo-input-group">
                  <label class="todo-input-label">üìù È°µÈù¢Ê†áÈ¢ò</label>
                  <input
                    type="text"
                    class="todo-input"
                    id="todoSettingsTitle"
                    placeholder="ÊàëÁöÑÂ∞èÊú¨Êú¨"
                    maxlength="20"
                  />
                </div>

                <!-- ÈóÆÂÄôËØ≠ËÆæÁΩÆ -->
                <div class="todo-input-group">
                  <label class="todo-input-label">üí¨ Ëá™ÂÆö‰πâÈóÆÂÄôËØ≠</label>
                  <div class="greeting-preview">
                    <div class="greeting-preview-main" id="greetingPreviewMain">
                      ‰ªäÂ§©‰πüË¶ÅÂä†Ê≤πÈ∏≠ÔºÅü¶Ü
                    </div>
                    <div class="greeting-preview-sub" id="greetingPreviewSub">
                      Êñ∞ÁöÑ‰∏ÄÂ§©ÔºåÊñ∞ÁöÑÂºÄÂßã~
                    </div>
                  </div>
                  <div class="greeting-input-row">
                    <input
                      type="text"
                      class="todo-input"
                      id="greetingMainInput"
                      placeholder="‰∏ªÈóÆÂÄôËØ≠"
                      maxlength="30"
                    />
                  </div>
                  <div class="greeting-input-row">
                    <input
                      type="text"
                      class="todo-input"
                      id="greetingSubInput"
                      placeholder="ÂâØÊ†áÈ¢ò"
                      maxlength="30"
                    />
                    <button
                      class="todo-add-category-btn"
                      onclick="saveGreeting()"
                    >
                      ‰øùÂ≠ò
                    </button>
                  </div>
                </div>

                <!-- ÂàÜÁ±ªÁÆ°ÁêÜ -->
                <div class="todo-input-group">
                  <label class="todo-input-label">üè∑Ô∏è ÁÆ°ÁêÜÂàÜÁ±ª</label>
                  <div class="todo-category-list" id="todoCategoryList">
                    <!-- Âä®ÊÄÅÊ∏≤Êüì -->
                  </div>
                  <div class="todo-add-category-row">
                    <input
                      type="text"
                      class="todo-add-category-input"
                      id="newCategoryEmoji"
                      placeholder="emoji"
                      maxlength="2"
                      style="width: 60px; flex: none"
                    />
                    <input
                      type="text"
                      class="todo-add-category-input"
                      id="newCategoryName"
                      placeholder="ÂàÜÁ±ªÂêçÁß∞"
                      maxlength="10"
                    />
                    <button
                      class="todo-add-category-btn"
                      onclick="addTodoCategory()"
                    >
                      Ê∑ªÂä†
                    </button>
                  </div>
                </div>
              </div>
              <div class="todo-modal-footer">
                <button class="todo-save-btn" onclick="saveTodoSettings()">
                  ‰øùÂ≠òËÆæÁΩÆ
                </button>
              </div>
            </div>
          </div>

          <!-- ÁªèÊúüËÆæÁΩÆÂºπÁ™ó -->
          <div
            class="period-modal-overlay"
            id="periodModalOverlay"
            onclick="if(event.target===this)closePeriodModal()"
          >
            <div class="period-modal">
              <div class="period-modal-header">
                <div class="period-modal-title">üå∏ ÁªèÊúüËÆæÁΩÆ</div>
                <button class="period-modal-close" onclick="closePeriodModal()">
                  ‚úï
                </button>
              </div>
              <div class="period-modal-body">
                <div class="period-input-group">
                  <label class="period-input-label">üìÖ ‰∏äÊ¨°ÁªèÊúüÂºÄÂßãÊó•Êúü</label>
                  <input type="date" class="period-input" id="periodLastDate" />
                  <div class="period-hint">ÈÄâÊã©‰Ω†‰∏äÊ¨°ÊúàÁªèÁ¨¨‰∏ÄÂ§©ÁöÑÊó•Êúü</div>
                </div>
                <div class="period-input-group">
                  <label class="period-input-label">üîÑ Âπ≥ÂùáÂë®ÊúüÂ§©Êï∞</label>
                  <input
                    type="number"
                    class="period-input"
                    id="periodCycleLength"
                    value="28"
                    min="21"
                    max="45"
                  />
                  <div class="period-hint">‰∏ÄËà¨‰∏∫21-35Â§©ÔºåÂπ≥Âùá28Â§©</div>
                </div>
                <div class="period-input-group">
                  <label class="period-input-label">‚è±Ô∏è Âπ≥ÂùáÁªèÊúüÂ§©Êï∞</label>
                  <input
                    type="number"
                    class="period-input"
                    id="periodDuration"
                    value="5"
                    min="2"
                    max="10"
                  />
                  <div class="period-hint">‰∏ÄËà¨‰∏∫3-7Â§©</div>
                </div>
              </div>
              <div class="period-modal-footer">
                <button class="period-save-btn" onclick="savePeriodSettings()">
                  ‰øùÂ≠òËÆæÁΩÆ
                </button>
              </div>
            </div>
          </div>

          <!-- Profile Tab (ÊàëÁöÑ) -->
          <div class="chat-tab-content" id="profileTab">
            <!-- Profile Header -->
            <div class="profile-header-card">
              <div class="profile-main">
                <div class="profile-avatar-large">üê∞</div>
                <div class="profile-info-main">
                  <div class="profile-name-large">ÊàëÁöÑÊòµÁß∞</div>
                  <div class="profile-id">SillyTavern ID: ST_12345</div>
                </div>
                <div class="profile-arrow">‚Ä∫</div>
              </div>
            </div>

            <!-- Profile Menu -->
            <div class="profile-menu">
              <div class="menu-item">
                <span class="menu-icon">‚≠ê</span>
                <span class="menu-text">ÊàëÁöÑÊî∂Ëóè</span>
                <span class="menu-arrow">‚Ä∫</span>
              </div>
              <div class="menu-item">
                <span class="menu-icon">üì∑</span>
                <span class="menu-text">ÊàëÁöÑÁõ∏ÂÜå</span>
                <span class="menu-arrow">‚Ä∫</span>
              </div>
              <div class="menu-item">
                <span class="menu-icon">üé¥</span>
                <span class="menu-text">ÊàëÁöÑÂç°Áâá</span>
                <span class="menu-arrow">‚Ä∫</span>
              </div>
              <div class="menu-item">
                <span class="menu-icon">üòä</span>
                <span class="menu-text">ÊàëÁöÑË°®ÊÉÖ</span>
                <span class="menu-arrow">‚Ä∫</span>
              </div>
            </div>

            <div class="profile-menu">
              <div class="menu-item">
                <span class="menu-icon">‚öôÔ∏è</span>
                <span class="menu-text">ËÆæÁΩÆ</span>
                <span class="menu-arrow">‚Ä∫</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat App Bottom Tab Bar -->
        <div class="chat-tab-bar">
          <div class="chat-tab active" onclick="switchChatTab('messages')">
            <span class="tab-icon">üí¨</span>
            <span class="tab-badge" id="messagesBadge" style="display: none"
              >0</span
            >
            <span class="tab-label">Message</span>
          </div>
          <div class="chat-tab" onclick="switchChatTab('moments')">
            <span class="tab-icon">üåü</span>
            <span class="tab-badge" id="momentsBadge" style="display: none"
              >0</span
            >
            <span class="tab-label">Moment</span>
          </div>
          <div class="chat-tab" onclick="switchChatTab('todo')">
            <span class="tab-icon">üìã</span>
            <span class="tab-label">To Do</span>
          </div>
          <div class="chat-tab" onclick="switchChatTab('profile')">
            <span class="tab-icon">üë§</span>
            <span class="tab-label">Me</span>
          </div>
        </div>
      </div>

      <div id="worldbookPage" class="page">
        <div class="page-header">
          <button class="back-btn" onclick="closePage('worldbookPage')">
            ‚Üê
          </button>
          <h1 class="page-title">‰∏ñÁïå‰π¶</h1>
        </div>
        <div class="page-content">‰∏ñÁïå‰π¶ÂäüËÉΩÂºÄÂèë‰∏≠...</div>
      </div>

      <div id="forumPage" class="page">
        <div class="page-header">
          <button class="back-btn" onclick="closePage('forumPage')">‚Üê</button>
          <h1 class="page-title">ËÆ∫Âùõ</h1>
        </div>
        <div class="page-content">ËÆ∫ÂùõÂäüËÉΩÂºÄÂèë‰∏≠...</div>
      </div>

      <div id="apiPage" class="page api-settings-page">
        <div class="page-header">
          <button class="back-btn" onclick="closePage('apiPage')">‚Üê</button>
          <h1 class="page-title">APIËÆæÁΩÆ</h1>
          <button class="page-header-add" onclick="openApiPresetModal()">
            ‚ûï
          </button>
        </div>

        <div class="api-settings-content">
          <!-- API Presets List -->
          <div class="api-section">
            <div class="api-section-title">API È¢ÑËÆæÁÆ°ÁêÜ</div>
            <div class="api-preset-list" id="apiPresetList">
              <!-- Presets will be rendered here -->
              <div class="empty-state" id="emptyPresets">
                <div class="empty-icon">üîå</div>
                <div class="empty-text">ËøòÊ≤°ÊúâAPIÈ¢ÑËÆæ</div>
                <div class="empty-hint">ÁÇπÂáªÂè≥‰∏äËßí ‚ûï ÂàõÂª∫È¢ÑËÆæ</div>
              </div>
            </div>
          </div>

          <!-- Current Active Config -->
          <div
            class="api-section"
            id="activeConfigSection"
            style="display: none"
          >
            <div class="api-section-title">‚úÖ ÂΩìÂâç‰ΩøÁî®</div>
            <div class="active-config-card">
              <div class="active-config-row">
                <span class="active-label">È¢ÑËÆæÂêçÁß∞</span>
                <span class="active-value" id="activePresetName">-</span>
              </div>
              <div class="active-config-row">
                <span class="active-label">Ê®°Âûã</span>
                <span class="active-value" id="activeModelName">-</span>
              </div>
              <div class="active-config-row">
                <span class="active-label">Áä∂ÊÄÅ</span>
                <span class="active-status">Â∑≤ËøûÊé•</span>
              </div>
            </div>
          </div>
          <div class="api-section">
            <div class="api-section-title">üéôÔ∏è ËØ≠Èü≥ËÆæÁΩÆ (MiniMax)</div>
            <div
              class="active-config-card"
              style="background: #fff; padding: 16px"
            >
              <div class="form-group">
                <label class="form-label">Group ID</label>
                <input
                  type="text"
                  class="form-input"
                  id="voiceGroupId"
                  placeholder="Â°´ÂÜô MiniMax Group ID"
                />
              </div>

              <div class="form-group">
                <label class="form-label">API Key</label>
                <input
                  type="password"
                  class="form-input"
                  id="voiceApiKey"
                  placeholder="Â°´ÂÜô MiniMax API Key"
                />
              </div>
              <div class="form-group">
                <label class="form-label">API Á∫øË∑Ø</label>
                <div class="radio-group">
                  <div
                    class="radio-option active"
                    onclick="switchVoiceUrl('cn')"
                    id="voiceUrlCN"
                  >
                    ÂõΩÂÜÖÁâà
                  </div>
                  <div
                    class="radio-option"
                    onclick="switchVoiceUrl('intl')"
                    id="voiceUrlIntl"
                  >
                    Êµ∑Â§ñÁâà
                  </div>
                </div>
                <div class="form-hint" style="margin-top: 6px">
                  ÂõΩÂÜÖÁâà: api.minimax.chat | Êµ∑Â§ñÁâà: api.minimaxi.com
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">ËØ≠Èü≥Ê®°Âûã</label>
                <div class="form-select-wrapper">
                  <select class="form-select" id="voiceModelSelect">
                    <option value="speech-2.6-hd">
                      speech-2.6-hd (ÊúÄÊñ∞¬∑Ë∂ÖÊ∏Ö)
                    </option>
                    <option value="speech-2.6-turbo">
                      speech-2.6-turbo (ÊúÄÊñ∞¬∑ÊûÅÈÄü)
                    </option>

                    <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>

                    <option value="speech-02-hd">speech-02-hd (È´òÊ∏Ö)</option>
                    <option value="speech-02-turbo">
                      speech-02-turbo (Âø´ÈÄü)
                    </option>
                    <option value="speech-01-turbo">
                      speech-01-turbo (ËÄÅÊóß)
                    </option>
                    <option value="speech-01-hd">speech-01-hd (ËÄÅÊóß)</option>
                  </select>
                </div>
              </div>

              <button
                class="action-btn"
                onclick="saveVoiceConfig()"
                style="width: 100%; margin-top: 10px"
              >
                üíæ ‰øùÂ≠òËØ≠Èü≥ÈÖçÁΩÆ
              </button>
            </div>
          </div>
          <!-- Tips -->
          <div class="api-tips">
            <div class="api-tips-title">üí° ÊèêÁ§∫</div>
            <div class="api-tips-content">
              ÊîØÊåÅ OpenAI ÂÖºÂÆπÊ†ºÂºèÁöÑ API„ÄÇÂ°´ÂÜôÂèç‰ª£Âú∞ÂùÄÊó∂Êó†ÈúÄÊ∑ªÂä† /v1 ÂêéÁºÄ„ÄÇ
            </div>
          </div>
        </div>
      </div>

      <!-- API Preset Modal -->
      <div class="api-modal" id="apiPresetModal">
        <div class="api-modal-content">
          <div class="api-modal-header">
            <h2 class="api-modal-title" id="apiModalTitle">ÂàõÂª∫ API È¢ÑËÆæ</h2>
            <button class="api-modal-close" onclick="closeApiPresetModal()">
              ‚úï
            </button>
          </div>
          <div class="api-modal-body">
            <div class="api-field">
              <label class="api-field-label">È¢ÑËÆæÂêçÁß∞</label>
              <input
                type="text"
                class="api-field-input"
                id="presetNameInput"
                placeholder="‰æãÂ¶Ç: OpenAI, Claude, Ëá™Áî®API"
              />
            </div>

            <div class="api-field">
              <label class="api-field-label">Âèç‰ª£Âú∞ÂùÄ</label>
              <input
                type="text"
                class="api-field-input"
                id="presetUrlInput"
                placeholder="https://api.example.com"
              />
            </div>

            <div class="api-field">
              <label class="api-field-label">API Key</label>
              <div class="api-field-key">
                <input
                  type="password"
                  class="api-field-input"
                  id="presetKeyInput"
                  placeholder="sk-xxxxxxxxxxxxxxxx"
                />
                <button
                  class="key-toggle-btn"
                  onclick="togglePresetKeyVisibility()"
                >
                  üëÅÔ∏è
                </button>
              </div>
            </div>

            <div class="api-field">
              <label class="api-field-label">Ê®°Âûã</label>
              <div class="model-select-row">
                <input
                  type="text"
                  class="api-field-input model-input"
                  id="presetModelInput"
                  placeholder="ËæìÂÖ•ÊàñÊãâÂèñÊ®°ÂûãÂêçÁß∞"
                />
                <button class="model-fetch-btn" onclick="fetchPresetModels()">
                  ÊãâÂèñ
                </button>
              </div>
              <div class="model-hint">
                ÂèØÁõ¥Êé•ËæìÂÖ•Ê®°ÂûãÂêçÁß∞ÔºåÂ¶Ç gpt-4o„ÄÅclaude-3-5-sonnet Á≠â
              </div>

              <div class="model-dropdown" id="modelDropdown"></div>
            </div>

            <div
              class="api-field"
              style="
                margin-top: 20px;
                padding-top: 20px;
                border-top: 1px dashed #eee;
              "
            >
              <label class="api-field-label">ÂèÇÊï∞ÂæÆË∞É (Advanced)</label>

              <div class="slider-row">
                <div style="width: 70px; font-size: 0.85rem; color: #666">
                  Ê∏©Â∫¶<br /><span style="font-size: 0.7rem; color: #999"
                    >(ÈöèÊú∫ÊÄß)</span
                  >
                </div>
                <input
                  type="range"
                  id="presetTempInput"
                  min="0"
                  max="2"
                  step="0.1"
                  value="1.0"
                  oninput="document.getElementById('valTemp').textContent = this.value"
                />
                <span class="slider-value" id="valTemp">1.0</span>
              </div>

              <div class="slider-row">
                <div style="width: 70px; font-size: 0.85rem; color: #666">
                  È¢ëÁéáÊÉ©ÁΩö<br /><span style="font-size: 0.7rem; color: #999"
                    >(ÂéªÈáç)</span
                  >
                </div>
                <input
                  type="range"
                  id="presetFreqInput"
                  min="-2"
                  max="2"
                  step="0.1"
                  value="0"
                  oninput="document.getElementById('valFreq').textContent = this.value"
                />
                <span class="slider-value" id="valFreq">0.0</span>
              </div>

              <div class="slider-row">
                <div style="width: 70px; font-size: 0.85rem; color: #666">
                  Â≠òÂú®ÊÉ©ÁΩö<br /><span style="font-size: 0.7rem; color: #999"
                    >(ÂàõÊñ∞)</span
                  >
                </div>
                <input
                  type="range"
                  id="presetPresInput"
                  min="-2"
                  max="2"
                  step="0.1"
                  value="0"
                  oninput="document.getElementById('valPres').textContent = this.value"
                />
                <span class="slider-value" id="valPres">0.0</span>
              </div>
            </div>
          </div>

          <div class="api-modal-footer">
            <button
              class="api-modal-btn btn-delete"
              id="presetDeleteBtn"
              onclick="deleteApiPreset()"
              style="display: none"
            >
              Âà†Èô§
            </button>
            <div class="api-modal-btn-group">
              <button
                class="api-modal-btn btn-cancel"
                onclick="closeApiPresetModal()"
              >
                ÂèñÊ∂à
              </button>
              <button class="api-modal-btn btn-save" onclick="saveApiPreset()">
                ‰øùÂ≠ò
              </button>
            </div>
          </div>
        </div>
      </div>

      <div
        id="fontPage"
        class="page chat-settings-page"
        style="background: #f5f5f5"
      >
        <div
          class="page-header"
          style="background: white; border-bottom: 1px solid #eee"
        >
          <button class="back-btn" onclick="closePage('fontPage')">‚Üê</button>
          <h1 class="page-title">Â≠ó‰ΩìËÆæÁΩÆ</h1>
        </div>

        <div class="settings-content">
          <div class="settings-section">
            <div class="section-header">
              <div class="section-icon purple">Aa</div>
              <span class="section-title">Ê∑ªÂä†Êñ∞Â≠ó‰Ωì</span>
            </div>
            <div class="section-body">
              <div class="form-group">
                <div class="radio-group">
                  <div
                    class="radio-option active"
                    onclick="switchFontSource('url')"
                    id="tabFontUrl"
                  >
                    ÁΩëÁªúÈìæÊé•
                  </div>
                  <div
                    class="radio-option"
                    onclick="switchFontSource('file')"
                    id="tabFontFile"
                  >
                    Êú¨Âú∞‰∏ä‰º†
                  </div>
                </div>
              </div>

              <div id="fontSourceUrl" class="form-group">
                <label class="form-label">Â≠ó‰Ωì URL (.woff2, .ttf)</label>
                <input
                  type="text"
                  class="form-input"
                  id="fontUrlInput"
                  placeholder="https://example.com/font.woff2"
                />
              </div>

              <div id="fontSourceFile" class="form-group" style="display: none">
                <label class="form-label">‰∏ä‰º†Â≠ó‰ΩìÊñá‰ª∂</label>
                <div
                  class="bg-upload-btn"
                  onclick="document.getElementById('fontFileInput').click()"
                >
                  üìÇ ÁÇπÂáªÈÄâÊã©Â≠ó‰ΩìÊñá‰ª∂
                </div>
                <input
                  type="file"
                  id="fontFileInput"
                  class="hidden-input"
                  accept=".ttf,.otf,.woff,.woff2"
                  onchange="handleFontFileUpload(this)"
                />
                <div
                  class="form-hint"
                  id="fontFileName"
                  style="margin-top: 8px"
                >
                  Êú™ÈÄâÊã©Êñá‰ª∂
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">È¢ÑËÆæÂêçÁß∞</label>
                <input
                  type="text"
                  class="form-input"
                  id="fontNameInput"
                  placeholder="‰æãÂ¶Ç: Â∞ëÂ•≥‰Ωì, ÂÉèÁ¥†È£é..."
                />
              </div>

              <div class="form-group">
                <label class="form-label">ÊïàÊûúÈ¢ÑËßà</label>
                <div
                  id="fontPreviewBox"
                  style="
                    padding: 16px;
                    background: white;
                    border: 1px solid #e5ddd3;
                    border-radius: 12px;
                    font-size: 16px;
                    line-height: 1.6;
                    color: #5d4e37;
                    transition: all 0.3s;
                  "
                >
                  The quick brown fox jumps over the lazy dog.<br />
                  ËøôÊòØ‰∏ÄÊÆµ‰∏≠ÊñáÊµãËØïÊñáÊú¨ÔºåÁî®‰∫éÈ¢ÑËßàÂ≠ó‰ΩìÊïàÊûú„ÄÇ<br />
                  1234567890 !@#$%^&*()
                </div>
              </div>

              <div class="action-buttons-grid">
                <button class="action-btn" onclick="previewCustomFont()">
                  üëÅÔ∏è È¢ÑËßà
                </button>
                <button
                  class="action-btn"
                  style="
                    background: linear-gradient(135deg, #a18cd1, #fbc2eb);
                    color: white;
                    border: none;
                  "
                  onclick="saveFontPreset()"
                >
                  üíæ ‰øùÂ≠òÂπ∂Â∫îÁî®
                </button>
              </div>
            </div>
          </div>

          <div class="settings-section">
            <div class="section-header">
              <div class="section-icon orange">üìö</div>
              <span class="section-title">ÊàëÁöÑÂ≠ó‰ΩìÂ∫ì</span>
            </div>
            <div class="section-body">
              <div class="api-preset-list" id="fontPresetList">
                <div class="api-preset-item active" onclick="applySystemFont()">
                  <div class="preset-radio" id="radio-system"></div>
                  <div class="preset-info">
                    <div class="preset-name">Á≥ªÁªüÈªòËÆ§</div>
                    <div class="preset-detail">System Default</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="appearancePage" class="page">
        <div class="page-header">
          <button class="back-btn" onclick="closePage('appearancePage')">
            ‚Üê
          </button>
          <h1 class="page-title">Â§ñËßÇËÆæÁΩÆ</h1>
        </div>
        <div
          class="page-content"
          style="
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
          "
        >
          <!-- Â£ÅÁ∫∏ËÆæÁΩÆ -->
          <div class="appearance-section">
            <h3>üñºÔ∏è ‰∏ªÂ±èÂπïÂ£ÅÁ∫∏</h3>
            <div
              class="wallpaper-preview"
              id="wallpaperPreview"
              onclick="document.getElementById('wallpaperInput').click()"
            >
              <div class="wallpaper-placeholder">ÁÇπÂáªÊõ¥Êç¢Â£ÅÁ∫∏</div>
            </div>
            <input
              type="file"
              id="wallpaperInput"
              accept="image/*"
              style="display: none"
              onchange="previewWallpaper(this)"
            />
            <button class="appearance-btn secondary" onclick="resetWallpaper()">
              ÊÅ¢Â§çÈªòËÆ§
            </button>
          </div>

          <!-- Â≠ó‰ΩìÈ¢úËâ≤ËÆæÁΩÆ -->
          <div class="appearance-section">
            <h3>üé® Â≠ó‰ΩìÈ¢úËâ≤</h3>
            <div class="color-options">
              <div
                class="color-option"
                style="background: #37474f"
                onclick="setFontColor('#37474f')"
                data-color="#37474f"
              ></div>
              <div
                class="color-option"
                style="background: #ffffff; border: 1px solid #ddd"
                onclick="setFontColor('#ffffff')"
                data-color="#ffffff"
              ></div>
              <div
                class="color-option"
                style="background: #f48fb1"
                onclick="setFontColor('#f48fb1')"
                data-color="#f48fb1"
              ></div>
              <div
                class="color-option"
                style="background: #90caf9"
                onclick="setFontColor('#90caf9')"
                data-color="#90caf9"
              ></div>
              <div
                class="color-option"
                style="background: #a5d6a7"
                onclick="setFontColor('#a5d6a7')"
                data-color="#a5d6a7"
              ></div>
              <div
                class="color-option"
                style="background: #ffcc80"
                onclick="setFontColor('#ffcc80')"
                data-color="#ffcc80"
              ></div>
              <div
                class="color-option custom-color"
                onclick="document.getElementById('customColorInput').click()"
              >
                <span>+</span>
              </div>
            </div>
            <input
              type="color"
              id="customColorInput"
              style="display: none"
              onchange="setFontColor(this.value)"
            />
          </div>

          <!-- APPÂõæÊ†áÂíåÂêçÁß∞ËÆæÁΩÆ -->
          <div class="appearance-section">
            <h3>üì± APPËá™ÂÆö‰πâ</h3>
            <div class="app-customize-list">
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_chat"
                  onclick="document.getElementById('iconInput_chat').click()"
                >
                  ËÅäÂ§©
                </div>
                <input
                  type="file"
                  id="iconInput_chat"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('chat', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_chat"
                  value="ËÅäÂ§©"
                  placeholder="APPÂêçÁß∞"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_worldbook"
                  onclick="document.getElementById('iconInput_worldbook').click()"
                >
                  ‰∏ñÁïå‰π¶
                </div>
                <input
                  type="file"
                  id="iconInput_worldbook"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('worldbook', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_worldbook"
                  value="‰∏ñÁïå‰π¶"
                  placeholder="APPÂêçÁß∞"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_forum"
                  onclick="document.getElementById('iconInput_forum').click()"
                >
                  ËÆ∫Âùõ
                </div>
                <input
                  type="file"
                  id="iconInput_forum"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('forum', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_forum"
                  value="ËÆ∫Âùõ"
                  placeholder="APPÂêçÁß∞"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_api"
                  onclick="document.getElementById('iconInput_api').click()"
                >
                  API
                </div>
                <input
                  type="file"
                  id="iconInput_api"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('api', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_api"
                  value="APIËÆæÁΩÆ"
                  placeholder="APPÂêçÁß∞"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_font"
                  onclick="document.getElementById('iconInput_font').click()"
                >
                  Â≠ó‰Ωì
                </div>
                <input
                  type="file"
                  id="iconInput_font"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('font', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_font"
                  value="Â≠ó‰Ωì"
                  placeholder="APPÂêçÁß∞"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_appearance"
                  onclick="document.getElementById('iconInput_appearance').click()"
                >
                  Â§ñËßÇ
                </div>
                <input
                  type="file"
                  id="iconInput_appearance"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('appearance', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_appearance"
                  value="Â§ñËßÇËÆæÁΩÆ"
                  placeholder="APPÂêçÁß∞"
                />
              </div>
            </div>
          </div>

          <!-- ‰øùÂ≠òÊåâÈíÆ -->
          <button
            class="appearance-save-btn"
            onclick="saveAppearanceSettings()"
          >
            ‚ú® ‰øùÂ≠òËÆæÁΩÆ
          </button>
        </div>
      </div>

      <!-- Bottom Dock -->
      <div class="dock">
        <div class="dock-item" onclick="openPage('apiPage')">
          <div class="dock-icon dock-blue">APIËÆæÁΩÆ</div>
          <span class="dock-label">APIËÆæÁΩÆ</span>
        </div>
        <div class="dock-item" onclick="openPage('fontPage')">
          <div class="dock-icon dock-purple">Â≠ó‰Ωì</div>
          <span class="dock-label">Â≠ó‰Ωì</span>
        </div>
        <div class="dock-item" onclick="openPage('appearancePage')">
          <div class="dock-icon dock-orange">Â§ñËßÇËÆæÁΩÆ</div>
          <span class="dock-label">Â§ñËßÇËÆæÁΩÆ</span>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div class="edit-modal" id="editModal">
      <div class="edit-modal-content">
        <div class="edit-modal-title" id="editModalTitle">ÁºñËæë</div>
        <input
          type="text"
          class="edit-input"
          id="editInput"
          placeholder="ËØ∑ËæìÂÖ•..."
        />
        <div class="edit-buttons">
          <button class="edit-btn edit-btn-cancel" onclick="closeEditModal()">
            ÂèñÊ∂à
          </button>
          <button class="edit-btn edit-btn-save" onclick="saveEdit()">
            ‰øùÂ≠ò
          </button>
        </div>
      </div>
    </div>

    <!-- ÂàÜÁªÑÁÆ°ÁêÜÂºπÁ™ó -->
    <div class="edit-modal" id="groupManagerModal" style="z-index: 1000">
      <div class="edit-modal-content" style="max-width: 320px">
        <div class="edit-modal-title">ÁÆ°ÁêÜÂàÜÁªÑ</div>
        <div class="group-list" id="groupList">
          <!-- Âä®ÊÄÅÊ∏≤ÊüìÂàÜÁªÑÂàóË°® -->
        </div>
        <div class="group-add-row">
          <input
            type="text"
            class="edit-input"
            id="newGroupInput"
            placeholder="ËæìÂÖ•Êñ∞ÂàÜÁªÑÂêçÁß∞..."
            style="flex: 1; margin-bottom: 0"
          />
          <button
            class="edit-btn edit-btn-save"
            onclick="addNewGroup()"
            style="margin-left: 8px; width: 60px"
          >
            Ê∑ªÂä†
          </button>
        </div>
        <div class="edit-buttons" style="margin-top: 16px">
          <button
            class="edit-btn edit-btn-cancel"
            onclick="closeGroupManager()"
          >
            ÂÖ≥Èó≠
          </button>
        </div>
      </div>
    </div>

    <!-- Create Character Modal -->
    <div class="edit-modal" id="createCharModal">
      <div class="create-char-content">
        <div class="create-char-title">ÂàõÂª∫Êñ∞ËßíËâ≤</div>

        <!-- Avatar upload -->
        <div
          class="create-avatar-section"
          onclick="document.getElementById('charAvatarInput').click()"
        >
          <div class="create-avatar">
            <span class="create-avatar-placeholder" id="charAvatarPlaceholder"
              >üì∑</span
            >
            <img id="charAvatarPreview" src="" alt="" style="display: none" />
          </div>
          <span class="create-avatar-hint">ÁÇπÂáª‰∏ä‰º†Â§¥ÂÉè</span>
        </div>
        <input
          type="file"
          id="charAvatarInput"
          class="hidden-input"
          accept="image/*"
          onchange="previewCharAvatar(this)"
        />

        <!-- Name input -->
        <div class="create-input-group">
          <label class="create-label"
            >ËßíËâ≤ÂêçÁß∞ <span class="required">*</span></label
          >
          <input
            type="text"
            class="create-input"
            id="charNameInput"
            placeholder="ËØ∑ËæìÂÖ•ËßíËâ≤ÂêçÁß∞"
          />
        </div>

        <!-- Note input -->
        <div class="create-input-group">
          <label class="create-label"
            >Â§áÊ≥® <span class="optional">(ÈÄâÂ°´)</span></label
          >
          <input
            type="text"
            class="create-input"
            id="charNoteInput"
            placeholder="Ê∑ªÂä†Â§áÊ≥®‰ø°ÊÅØ"
          />
        </div>

        <!-- Buttons -->
        <div class="create-buttons">
          <button
            class="create-btn create-btn-cancel"
            onclick="closeCreateCharModal()"
          >
            ÂèñÊ∂à
          </button>
          <button
            class="create-btn create-btn-confirm"
            onclick="createCharacter()"
          >
            ÂàõÂª∫
          </button>
        </div>
      </div>
    </div>

    <div class="chat-conversation-page" id="chatConversationPage">
      <div class="conv-header">
        <button class="conv-back-btn" onclick="closeConversation()">‚Äπ</button>
        <div class="conv-title-section">
          <div class="conv-avatar" id="convAvatar">ü§ñ</div>
          <span class="conv-name" id="convName">ËßíËâ≤ÂêçÁß∞</span>
        </div>
        <button class="conv-menu-btn" onclick="openChatSettings()">‚Ä¢‚Ä¢‚Ä¢</button>
      </div>

      <div class="conv-menu" id="convMenu">
        <div class="conv-menu-item" onclick="clearChatHistory()">
          üóëÔ∏è Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï
        </div>
        <div class="conv-menu-item" onclick="deleteCharacter()">
          ‚ùå Âà†Èô§Ê≠§ËßíËâ≤
        </div>
      </div>

      <div class="conv-messages" id="convMessages" onclick="closeChatPanel()">
        <div class="conv-empty">
          <div class="conv-empty-icon">üí¨</div>
          <div class="conv-empty-text">ÂºÄÂßãÂíåTAËÅäÂ§©ÂêßÔΩû</div>
        </div>
      </div>

      <div class="conv-input-area" id="inputArea">
        <div class="conv-input-bar">
          <button class="tool-btn icon-btn" onclick="toggleChatPanel('plus')">
            +
          </button>

          <div class="conv-input-wrapper">
            <textarea
              class="conv-input"
              id="convInput"
              placeholder="ËæìÂÖ•Ê∂àÊÅØ..."
              rows="1"
              oninput="autoResizeTextarea(this)"
              onfocus="closeChatPanel()"
            ></textarea>
            <button class="emoji-btn-inner" onclick="toggleChatPanel('emoji')">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
              >
                <circle cx="12" cy="12" r="10" />
                <path d="M8 14s1.5 2 4 2 4-2 4-2" />
                <line x1="9" y1="9" x2="9.01" y2="9" />
                <line x1="15" y1="9" x2="15.01" y2="9" />
              </svg>
            </button>
          </div>

          <button class="ai-magic-btn" onclick="requestAIReply()" id="replyBtn">
            ‚ú¶
          </button>

          <button class="conv-send-btn" onclick="sendUserMessage()">
            <span>‚Üë</span>
          </button>
        </div>

        <div class="chat-panel" id="plusPanel">
          <div class="panel-grid">
            <div
              class="panel-item"
              onclick="document.getElementById('chatImgInput').click()"
            >
              <div class="panel-icon-box bg-photo">üñºÔ∏è</div>
              <span class="panel-label">Áõ∏ÂÜå</span>
            </div>
            <div class="panel-item" onclick="handleCameraAction()">
              <div class="panel-icon-box bg-camera">üì∑</div>
              <span class="panel-label">ÊãçÊëÑ</span>
            </div>
            <div class="panel-item" onclick="sendRedPacket()">
              <div class="panel-icon-box bg-redpacket">üßß</div>
              <span class="panel-label">Á∫¢ÂåÖ</span>
            </div>
            <div class="panel-item" onclick="startFakeCall()">
              <div class="panel-icon-box bg-call">üìû</div>
              <span class="panel-label">ÈÄöËØù</span>
            </div>
            <div class="panel-item" onclick="sendFakeLocation()">
              <div class="panel-icon-box bg-location">üìç</div>
              <span class="panel-label">‰ΩçÁΩÆ</span>
            </div>
            <div class="panel-item" onclick="sendNudge()">
              <div class="panel-icon-box bg-nudge">üëã</div>
              <span class="panel-label">Êãç‰∏ÄÊãç</span>
            </div>
            <div class="panel-item" onclick="openReadTogether()">
              <div class="panel-icon-box bg-book">üìö</div>
              <span class="panel-label">‰∏ÄËµ∑ËØª‰π¶</span>
            </div>
          </div>
          <input
            type="file"
            id="chatImgInput"
            hidden
            accept="image/*"
            onchange="handleChatImageUpload(this)"
          />
        </div>

        <div class="chat-panel" id="emojiPanel">
          <!-- ÊêúÁ¥¢Ê°Ü -->
          <div class="sticker-search-bar">
            <input
              type="text"
              class="sticker-search-input"
              id="stickerSearchInput"
              placeholder="ÊêúÁ¥¢Ë°®ÊÉÖÂåÖ..."
              oninput="handleStickerSearch(this.value)"
            />
            <span
              class="sticker-search-clear"
              id="stickerSearchClear"
              onclick="clearStickerSearch()"
              >‚úï</span
            >
          </div>

          <div class="sticker-category-bar" id="stickerCategoryBar"></div>

          <div class="emoji-grid" id="stickerGrid"></div>

          <input
            type="file"
            id="stickerInput"
            hidden
            accept="image/*,.txt"
            multiple
            onchange="handleStickerImport(this)"
          />
        </div>
      </div>
    </div>

    <!-- ‰∏ÄËµ∑ËØª‰π¶È°µÈù¢ -->
    <div class="read-together-page" id="readTogetherPage">
      <div class="read-header">
        <button class="read-header-back" onclick="closeReadTogether()">
          ‚Üê
        </button>
        <div class="read-header-title">üìö ‰∏ÄËµ∑ËØª‰π¶</div>
        <button class="read-header-action" onclick="startFloatingMode()">
          üìå
        </button>
      </div>
      <div class="read-content">
        <!-- ÊàëÁöÑ‰π¶Êû∂ -->
        <div class="bookshelf-section">
          <div class="bookshelf-title">üìö ÊàëÁöÑ‰π¶Êû∂</div>
          <div class="bookshelf-grid" id="bookshelfGrid">
            <!-- ‰π¶Á±çÂç°Áâá‰ºöÂä®ÊÄÅÁîüÊàê -->
            <div
              class="book-card add-book-card"
              onclick="document.getElementById('bookFileInput').click()"
            >
              <div style="font-size: 32px; margin-bottom: 8px">‚ûï</div>
              <div>ÂØºÂÖ•Êñ∞‰π¶</div>
            </div>
          </div>
          <input
            type="file"
            id="bookFileInput"
            hidden
            accept=".txt"
            onchange="handleBookImport(this)"
          />
        </div>

        <!-- ÂΩìÂâçÈòÖËØª -->
        <div id="currentReadingSection" style="display: none">
          <div class="bookshelf-title">üìñ ÂΩìÂâçÈòÖËØª</div>
          <div class="read-book-info">
            <div class="read-book-title">
              <span>üìñ</span>
              <span id="readBookName">‰π¶Âêç</span>
              <span class="read-status-badge" id="readStatusBadge">
                <span>‚úì</span> ÈòÖËØª‰∏≠
              </span>
            </div>
            <div class="read-book-progress" id="readBookProgress">
              ËøõÂ∫¶ÔºöÁ¨¨ 1 È°µ / ÂÖ± 100 È°µ
            </div>
            <div class="read-progress-bar">
              <div
                class="read-progress-fill"
                id="readProgressFill"
                style="width: 0%"
              ></div>
            </div>
          </div>

          <div class="read-current-section">
            <div class="read-section-label">üìç ÂΩìÂâçÈ°µÂÜÖÂÆπ</div>
            <div class="read-section-text" id="readSectionText">
              ËøôÈáåÊòæÁ§∫ÂΩìÂâçÈ°µÁöÑÂÜÖÂÆπ...
            </div>
            <div class="read-controls">
              <button class="read-ctrl-btn prev" onclick="readPrevSection()">
                ‚Üê ‰∏ä‰∏ÄÈ°µ
              </button>
              <button class="read-ctrl-btn next" onclick="readNextSection()">
                ‰∏ã‰∏ÄÈ°µ ‚Üí
              </button>
            </div>
          </div>

          <div class="read-settings">
            <div class="read-setting-row">
              <span class="read-setting-label">Ë∑≥ËΩ¨Âà∞Á¨¨</span>
              <div class="read-setting-value">
                <input
                  type="number"
                  class="read-setting-input"
                  id="readJumpTo"
                  value="1"
                  min="1"
                />
                <span>È°µ</span>
                <button
                  class="read-ctrl-btn next"
                  style="flex: none; padding: 6px 12px"
                  onclick="jumpToSection()"
                >
                  Ë∑≥ËΩ¨
                </button>
              </div>
            </div>
            <div class="read-setting-row">
              <span class="read-setting-label">ÂºÄÂêØÊÇ¨ÊµÆÁ™ó</span>
              <div class="read-setting-value">
                <button
                  class="read-ctrl-btn next"
                  style="flex: none; padding: 8px 16px"
                  onclick="startFloatingMode()"
                >
                  üìå ÊÇ¨ÊµÆÈòÖËØª
                </button>
              </div>
            </div>
            <div class="read-setting-row">
              <button
                class="read-ctrl-btn prev"
                style="width: 100%; background: #fff3e0; color: #ff9800"
                onclick="stopCurrentReading()"
              >
                ‚è∏Ô∏è ÊöÇÂÅúÈòÖËØªÔºàÂõûÂà∞‰π¶Êû∂Ôºâ
              </button>
            </div>
          </div>
        </div>

        <!-- ÂØºÂÖ•ËÆæÁΩÆ -->
        <div class="read-settings" style="margin-top: 16px">
          <div class="bookshelf-title" style="margin-bottom: 12px">
            ‚öôÔ∏è ÂØºÂÖ•ËÆæÁΩÆ
          </div>
          <div class="read-setting-row">
            <span class="read-setting-label">ÊØèÈ°µÂ≠óÊï∞</span>
            <div class="read-setting-value">
              <input
                type="number"
                class="read-setting-input"
                id="readChunkSize"
                value="500"
                min="100"
                max="3000"
                style="width: 70px"
              />
              <span>Â≠ó</span>
            </div>
          </div>
          <div style="font-size: 0.8rem; color: #888; margin-top: 8px">
            ÊèêÁ§∫ÔºöÂØºÂÖ•Êñ∞‰π¶Êó∂ÁîüÊïà„ÄÇÂ≠óÊï∞Ë∂äÂ∞ëÁøªÈ°µË∂äÈ¢ëÁπÅÔºåÂ≠óÊï∞Ë∂äÂ§öÊØèÈ°µÂÜÖÂÆπË∂äÈïø„ÄÇ
          </div>
        </div>

        <!-- ‰ΩøÁî®ËØ¥Êòé -->
        <div class="read-settings" style="margin-top: 16px">
          <div
            class="read-setting-row"
            style="flex-direction: column; align-items: flex-start; gap: 8px"
          >
            <span class="read-setting-label">üí° ‰ΩøÁî®ËØ¥Êòé</span>
            <div style="font-size: 0.85rem; color: #666; line-height: 1.6">
              1. ËÆæÁΩÆÊØèÈ°µÂ≠óÊï∞ÔºåÁÑ∂ÂêéÂØºÂÖ•TXT‰π¶Á±ç<br />
              2. ÁÇπÂáª‰π¶Á±çÂç°ÁâáÂºÄÂßãÈòÖËØª<br />
              3. ÁÇπÂáª„Äåüìå ÊÇ¨ÊµÆÈòÖËØª„ÄçÂºÄÂêØÊÇ¨ÊµÆÁ™ó<br />
              4. ÊÇ¨ÊµÆÁ™óÂèØ‰ª•ÊãñÂä®„ÄÅÁº©ÊîæÔºåËæπÁúã‰π¶ËæπËÅäÂ§©<br />
              5. AI‰ºöÊ†πÊçÆÂΩìÂâçÈòÖËØªÂÜÖÂÆπ‰∏é‰Ω†‰∫íÂä®
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ÊÇ¨ÊµÆÈòÖËØªÊåâÈíÆ -->
    <button
      class="read-floating-btn"
      id="readFloatingBtn"
      onclick="toggleFloatingPanel()"
    >
      üìñ
    </button>

    <!-- ÊÇ¨ÊµÆÈòÖËØªÈù¢Êùø -->
    <div class="read-floating-panel" id="readFloatingPanel">
      <div class="read-float-header" id="floatPanelHeader">
        <span class="read-float-drag-hint">‚ãÆ‚ãÆ</span>
        <div class="read-float-title" id="floatBookTitle">‰π¶Âêç</div>
        <div class="read-float-progress" id="floatProgress">Á¨¨1È°µ</div>
        <button class="read-float-close" onclick="toggleFloatingPanel()">
          ‚úï
        </button>
      </div>
      <div class="read-float-content" id="floatContent">ÂΩìÂâçÈ°µÂÜÖÂÆπ...</div>
      <div class="read-float-controls">
        <button
          class="read-float-btn"
          onclick="readPrevSection();updateFloatingPanel();"
        >
          ‚Üê ‰∏ä‰∏ÄÈ°µ
        </button>
        <button
          class="read-float-btn primary"
          onclick="readNextSection();updateFloatingPanel();"
        >
          ‰∏ã‰∏ÄÈ°µ ‚Üí
        </button>
        <button
          class="read-float-btn"
          onclick="openReadTogether();hideFloatingPanel();"
        >
          üìö ‰π¶Êû∂
        </button>
      </div>
      <div class="read-float-resize-hint">‚Üò ÊãñÂä®Âè≥‰∏ãËßíÁº©Êîæ</div>
    </div>

    <!-- Chat Settings Page -->
    <div class="chat-settings-page" id="chatSettingsPage">
      <div class="settings-header">
        <div class="settings-header-title">ËÅäÂ§©ËÆæÁΩÆ</div>
        <button class="settings-close-btn" onclick="closeChatSettings()">
          ‚úï
        </button>
      </div>

      <div class="settings-content">
        <!-- Section 1: Basic Info -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon brown">üìù</div>
            <span class="section-title">Âü∫Á°ÄËµÑÊñô</span>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label"
                >ËßíËâ≤ÁúüÂêç / Áæ§ËÅäÂêçÁß∞
                <span class="form-hint">(AIÂè™ËÆ§Ëøô‰∏™)</span></label
              >
              <input
                type="text"
                class="form-input"
                id="settingsCharName"
                placeholder="ËæìÂÖ•ËßíËâ≤ÂêçÁß∞..."
              />
            </div>
            <div class="form-group">
              <label class="form-label"
                >Â§áÊ≥®Âêç
                <span class="form-hint">(‰ªÖÊòæÁ§∫Áî®ÔºåAI‰∏çÁü•ÈÅì)</span></label
              >
              <input
                type="text"
                class="form-input"
                id="settingsCharNote"
                placeholder="ËæìÂÖ•Â§áÊ≥®Âêç..."
              />
            </div>
            <div class="form-group">
              <label class="form-label">Â•ΩÂèãÂàÜÁªÑ</label>
              <div class="form-select-wrapper">
                <select class="form-select" id="settingsGroup">
                  <option value="none">Êú™ÂàÜÁªÑ</option>
                </select>
                <button class="form-btn-small" onclick="openGroupManager()">
                  ÁÆ°ÁêÜ
                </button>
              </div>
            </div>

            <!-- ÁΩÆÈ°∂ËÅîÁ≥ª‰∫∫ -->
            <div class="form-group">
              <label class="form-label">ËÅäÂ§©ÂàóË°®ËÆæÁΩÆ</label>
              <div class="avatar-toggle-group">
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="settingsPinned"
                    onchange="togglePinContact()"
                  />
                  <span class="toggle-label">üìå ÁΩÆÈ°∂Ê≠§ËÅîÁ≥ª‰∫∫</span>
                </label>
              </div>
            </div>

            <!-- Avatar Upload -->
            <div class="avatar-upload-row">
              <div class="avatar-upload-col">
                <div class="avatar-upload-label">ÂØπÊñπÂ§¥ÂÉè</div>
                <div
                  class="avatar-preview"
                  id="settingsOtherAvatar"
                  onclick="document.getElementById('otherAvatarInput').click()"
                >
                  <span id="otherAvatarPlaceholder">üì∑</span>
                  <img id="otherAvatarImg" src="" style="display: none" />
                </div>
                <input
                  type="file"
                  id="otherAvatarInput"
                  class="hidden-input"
                  accept="image/*"
                  onchange="previewSettingsAvatar(this, 'other')"
                />
                <div class="avatar-actions">
                  <button
                    class="avatar-action-btn"
                    onclick="document.getElementById('otherAvatarInput').click()"
                  >
                    ‰∏ä‰º†
                  </button>
                  <button
                    class="avatar-action-btn"
                    onclick="clearSettingsAvatar('other')"
                  >
                    Ê∏ÖÈô§
                  </button>
                </div>
              </div>
              <div class="avatar-upload-col">
                <div class="avatar-upload-label">ÊàëÁöÑÂ§¥ÂÉè</div>
                <div
                  class="avatar-preview"
                  id="settingsMyAvatar"
                  onclick="document.getElementById('myAvatarInput').click()"
                >
                  <span id="myAvatarPlaceholder">üì∑</span>
                  <img id="myAvatarImg" src="" style="display: none" />
                </div>
                <input
                  type="file"
                  id="myAvatarInput"
                  class="hidden-input"
                  accept="image/*"
                  onchange="previewSettingsAvatar(this, 'my')"
                />
                <div class="avatar-actions">
                  <button
                    class="avatar-action-btn"
                    onclick="document.getElementById('myAvatarInput').click()"
                  >
                    ‰∏ä‰º†
                  </button>
                  <button
                    class="avatar-action-btn"
                    onclick="clearSettingsAvatar('my')"
                  >
                    Ê∏ÖÈô§
                  </button>
                </div>
              </div>
            </div>

            <!-- Â§¥ÂÉèÊòæÁ§∫ÂºÄÂÖ≥ -->
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">Â§¥ÂÉèÊòæÁ§∫ËÆæÁΩÆ</label>
              <div class="avatar-toggle-group">
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="showAiAvatar"
                    checked
                    onchange="toggleAvatarDisplay()"
                  />
                  <span class="toggle-label">ÊòæÁ§∫AIÂ§¥ÂÉè</span>
                </label>
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="showUserAvatar"
                    checked
                    onchange="toggleAvatarDisplay()"
                  />
                  <span class="toggle-label">ÊòæÁ§∫ÊàëÁöÑÂ§¥ÂÉè</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Section 2: AI Brain & Persona -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon purple">üß†</div>
            <span class="section-title">AIÂ§ßËÑë‰∏éËÆæÂÆö</span>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label">ÂØπÊñπ‰∫∫ËÆæ (Persona)</label>
              <textarea
                class="form-input form-textarea"
                id="settingsPersona"
                placeholder="ÊèèËø∞AIËßíËâ≤ÁöÑÊÄßÊ†º„ÄÅËÉåÊôØ„ÄÅËØ¥ËØùÊñπÂºèÁ≠â..."
              ></textarea>
            </div>
            <div class="form-group">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 8px;
                "
              >
                <label class="form-label" style="margin-bottom: 0"
                  >ÊàëÁöÑ‰∫∫ËÆæ (My Persona)</label
                >
                <div style="display: flex; gap: 8px">
                  <select
                    class="form-select"
                    id="userPersonaPresetSelect"
                    style="
                      padding: 6px 24px 6px 12px;
                      font-size: 0.8rem;
                      background-position: right 8px center;
                    "
                  >
                    <option value="">-- ÈÄâÊã©È¢ÑËÆæ --</option>
                  </select>
                  <button
                    class="form-btn-small"
                    onclick="saveUserPersonaPreset()"
                    style="padding: 6px 12px; font-size: 0.8rem"
                  >
                    ‰øùÂ≠òÈ¢ÑËÆæ
                  </button>
                </div>
              </div>
              <textarea
                class="form-input form-textarea"
                id="settingsMyPersona"
                placeholder="ÊèèËø∞‰Ω†Ëá™Â∑±ÁöÑËÆæÂÆöÔºåËÆ©AI‰∫ÜËß£‰Ω†..."
              ></textarea>
            </div>
            <div class="form-group">
              <label class="form-label"
                >ÂÖ≥ËÅî‰∏ñÁïå‰π¶ <span class="form-hint">(Â§öÈÄâ)</span></label
              >
              <select class="form-select" id="settingsWorldbook">
                <option value="">-- ÁÇπÂáªÈÄâÊã© --</option>
                <option value="default">ÈªòËÆ§‰∏ñÁïåËßÇ</option>
                <option value="fantasy">Â•áÂπª‰∏ñÁïå</option>
                <option value="scifi">ÁßëÂπª‰∏ñÁïå</option>
                <option value="modern">Áé∞‰ª£ÈÉΩÂ∏Ç</option>
              </select>
            </div>
            <div
              class="form-group"
              style="
                margin-top: 18px;
                padding-top: 18px;
                border-top: 1px dashed #eee;
              "
            >
              <label class="form-label">üó£Ô∏è ËßíËâ≤Èü≥Ëâ≤ (Voice ID)</label>
              <div class="form-select-wrapper">
                <input
                  type="text"
                  class="form-input"
                  id="settingsVoiceId"
                  placeholder="‰æãÂ¶Ç: male-qn-qingse (ÈùíÊ∂©ÈùíÂπ¥)"
                />
                <button class="form-btn-small" onclick="testCharacterVoice()">
                  ËØïÂê¨
                </button>
              </div>
              <div class="form-hint">ËØ∑Â°´ÂÜô MiniMax ÁöÑÈü≥Ëâ≤ ID</div>
            </div>
          </div>
        </div>

        <!-- Section 3: Memory Settings -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon teal">üíæ</div>
            <span class="section-title">ËÆ∞ÂøÜ‰∏é‰∏ä‰∏ãÊñá</span>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label"
                >ËÆ∞ÂøÜ‰∫íÈÄö
                <span class="form-hint">(ÈÄâÊã©Ë¶ÅÈìæÊé•ÁöÑËÅäÂ§©)</span></label
              >
              <select class="form-select" id="settingsMemoryLink">
                <option value="">-- ÁÇπÂáªÈÄâÊã© --</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">‰∫íÈÄöÊù°Êï∞</label>
              <div class="number-input-row">
                <input
                  type="number"
                  class="number-input"
                  id="settingsMemoryCount"
                  value="5"
                  min="1"
                  max="50"
                />
                <span class="form-hint">Êù°ÊúÄËøëÊ∂àÊÅØ</span>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">‰∏ä‰∏ãÊñáËÆ∞ÂøÜÊù°Êï∞</label>
              <div class="number-input-row">
                <input
                  type="number"
                  class="number-input"
                  id="settingsContextCount"
                  value="150"
                  min="10"
                  max="500"
                />
                <span class="form-hint">Êù°</span>
              </div>
            </div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 12px;
                padding: 10px 12px;
                background: #faf8f5;
                border-radius: 10px;
              "
            >
              <span style="font-size: 0.82rem; color: #9a8b7a"
                >ÊÄªÊ∂àÊÅØÔºö<strong id="settingsTotalMsg">0</strong> Êù°</span
              >
              <span style="font-size: 0.82rem; color: #c4a87c"
                >tokenÔºö<strong id="settingsTokenCount">0</strong></span
              >
            </div>
          </div>
        </div>

        <!-- Section 4: Play Mode -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon orange">üéÆ</div>
            <span class="section-title">Áé©Ê≥ï‰∏éÊ®°Âºè</span>
          </div>
          <div class="section-body">
            <div class="toggle-row">
              <div>
                <div class="toggle-label">Á∫ø‰∏ãÊ®°Âºè (Online Dating)</div>
                <div class="toggle-sublabel">Ê®°ÊãüÁúüÂÆûÁ∫¶‰ºöÂú∫ÊôØ</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="settingsOnlineDating" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="toggle-row">
              <div>
                <div class="toggle-label">ÈïøÊúüËÆ∞ÂøÜÊÄªÁªì</div>
                <div class="toggle-sublabel">Ëá™Âä®ÊÄªÁªìÈáçË¶ÅÂØπËØù</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="settingsLongMemory" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">ÊÄªÁªìÊ®°Âºè</label>
              <div class="radio-group">
                <div
                  class="radio-option"
                  data-value="auto"
                  onclick="selectRadio(this, 'summaryMode')"
                >
                  Ëá™Âä®ÊÄªÁªì
                </div>
                <div
                  class="radio-option active"
                  data-value="manual"
                  onclick="selectRadio(this, 'summaryMode')"
                >
                  ÊâãÂä®ÊÄªÁªì
                </div>
              </div>
              <input type="hidden" id="settingsSummaryMode" value="manual" />
            </div>
            <div class="form-group">
              <label class="form-label">Ëß¶ÂèëÊù°Êï∞</label>
              <div class="number-input-row">
                <input
                  type="number"
                  class="number-input"
                  id="settingsTriggerCount"
                  value="500"
                  min="50"
                  max="2000"
                />
                <span class="form-hint">Êù°Ê∂àÊÅØÂêéËß¶ÂèëÊÄªÁªì</span>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">ÊÄªÁªìÊèêÁ§∫ËØç</label>
              <textarea
                class="form-input form-textarea"
                id="settingsSummaryPrompt"
                placeholder="ËØ∑‰ª•Á¨¨‰∏â‰∫∫Áß∞ÁöÑËßÜËßíÔºåÂÆ¢ËßÇ„ÄÅÂÜ∑Èùô„ÄÅ‰∏çÂ∏¶‰ªª‰ΩïÊÑüÊÉÖËâ≤ÂΩ©Âú∞ÊÄªÁªì‰ª•‰∏ãÂØπËØùÁöÑÊ†∏ÂøÉ‰∫ã‰ª∂Âíå‰ø°ÊÅØ„ÄÇÁ¶ÅÊ≠¢ËøõË°å‰ªª‰ΩïËßíËâ≤ÊâÆÊºîÊàñÊ∑ªÂä†‰∏ªËßÇËØÑËÆ∫„ÄÇ"
              ></textarea>
            </div>
            <div class="action-buttons-grid" style="margin-top: 12px">
              <button class="action-btn" onclick="viewSummaries()">
                üìã Êü•Áúã/ÁÆ°ÁêÜÊÄªÁªì
              </button>
              <button class="action-btn" onclick="triggerManualSummary()">
                ‚úçÔ∏è Á´ãÂç≥ÊâãÂä®ÊÄªÁªì
              </button>
            </div>
            <div class="toggle-row" style="margin-top: 12px">
              <div>
                <div class="toggle-label">Áª≠ÁÅ´Ëä±Á≥ªÁªü</div>
                <div class="toggle-sublabel">‰øùÊåÅÂØπËØùÁÉ≠Â∫¶</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="settingsFlame" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="toggle-row">
              <div>
                <div class="toggle-label">ÂÆûÊó∂Êó∂Èó¥ÊÑüÁü•</div>
                <div class="toggle-sublabel">AI‰∫ÜËß£ÂΩìÂâçÊó∂Èó¥</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="settingsTimeAware" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>

        <!-- Section 5: Visual Customization -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon blue">üé®</div>
            <span class="section-title">ËßÜËßâÁæéÂåñ</span>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label">ËÅäÂ§©ËÉåÊôØ</label>
              <div class="bg-preview-container">
                <div class="bg-preview-phone" id="bgPreview">
                  <span id="bgPreviewPlaceholder">Êó†ËÉåÊôØ</span>
                  <img id="bgPreviewImg" src="" style="display: none" />
                </div>
                <button
                  class="bg-upload-btn"
                  onclick="document.getElementById('bgUploadInput').click()"
                >
                  üì§ ÁÇπÂáª‰∏ä‰º†ËÉåÊôØÂõæÁâá
                </button>
                <input
                  type="file"
                  id="bgUploadInput"
                  class="hidden-input"
                  accept="image/*"
                  onchange="previewBackground(this)"
                />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Â≠ó‰ΩìÂ§ßÂ∞è</label>
              <div class="slider-row">
                <span class="slider-value" id="fontSizeValue">14px</span>
                <input
                  type="range"
                  id="settingsFontSize"
                  min="12"
                  max="20"
                  value="14"
                  oninput="updateFontSizePreview(this.value)"
                />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Ê∞îÊ≥°Â≠ó‰ΩìÈ¢úËâ≤</label>
              <div class="bubble-color-row">
                <div class="bubble-color-item">
                  <span class="bubble-color-label">ÊàëÁöÑÊ∞îÊ≥°</span>
                  <div class="color-picker-combo">
                    <div class="color-preset-grid" id="userColorGrid">
                      <div
                        class="color-preset"
                        style="background: #c2185b"
                        onclick="setUserBubbleColor('#c2185b')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #e91e63"
                        onclick="setUserBubbleColor('#e91e63')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #ff4081"
                        onclick="setUserBubbleColor('#ff4081')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #f06292"
                        onclick="setUserBubbleColor('#f06292')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #7b1fa2"
                        onclick="setUserBubbleColor('#7b1fa2')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #512da8"
                        onclick="setUserBubbleColor('#512da8')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #1976d2"
                        onclick="setUserBubbleColor('#1976d2')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #0097a7"
                        onclick="setUserBubbleColor('#0097a7')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #388e3c"
                        onclick="setUserBubbleColor('#388e3c')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #f57c00"
                        onclick="setUserBubbleColor('#f57c00')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #5d4037"
                        onclick="setUserBubbleColor('#5d4037')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #37474f"
                        onclick="setUserBubbleColor('#37474f')"
                      ></div>
                    </div>
                    <input
                      type="color"
                      id="settingsUserBubbleColor"
                      value="#c2185b"
                      class="color-picker-input"
                    />
                  </div>
                </div>
                <div class="bubble-color-item">
                  <span class="bubble-color-label">AIÊ∞îÊ≥°</span>
                  <div class="color-picker-combo">
                    <div class="color-preset-grid" id="aiColorGrid">
                      <div
                        class="color-preset"
                        style="background: #37474f"
                        onclick="setAiBubbleColor('#37474f')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #455a64"
                        onclick="setAiBubbleColor('#455a64')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #616161"
                        onclick="setAiBubbleColor('#616161')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #212121"
                        onclick="setAiBubbleColor('#212121')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #5d4037"
                        onclick="setAiBubbleColor('#5d4037')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #4e342e"
                        onclick="setAiBubbleColor('#4e342e')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #1565c0"
                        onclick="setAiBubbleColor('#1565c0')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #00838f"
                        onclick="setAiBubbleColor('#00838f')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #2e7d32"
                        onclick="setAiBubbleColor('#2e7d32')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #ad1457"
                        onclick="setAiBubbleColor('#ad1457')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #6a1b9a"
                        onclick="setAiBubbleColor('#6a1b9a')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #000000"
                        onclick="setAiBubbleColor('#000000')"
                      ></div>
                    </div>
                    <input
                      type="color"
                      id="settingsAiBubbleColor"
                      value="#37474f"
                      class="color-picker-input"
                    />
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Ê∞îÊ≥°Ê†∑ÂºèÈ¢ÑËÆæ</label>
              <div class="form-select-wrapper">
                <select class="form-select" id="settingsBubbleStyle">
                  <option value="none">-- Êó†È¢ÑËÆæ --</option>
                  <option value="simple">ÁÆÄÁ∫¶È£éÊ†º</option>
                  <option value="bubble">Ê∞îÊ≥°È£éÊ†º</option>
                  <option value="modern">Áé∞‰ª£È£éÊ†º</option>
                  <option value="retro">Â§çÂè§È£éÊ†º</option>
                </select>
                <button class="form-btn-small" onclick="manageBubbleStyles()">
                  ÁÆ°ÁêÜ
                </button>
              </div>
            </div>
            <div class="action-buttons-grid">
              <button class="action-btn" onclick="exportBubbleStyle()">
                üì§ ÂØºÂá∫
              </button>
              <button class="action-btn" onclick="importBubbleStyle()">
                üì• ÂØºÂÖ•
              </button>
            </div>
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">Ëá™ÂÆö‰πâCSS</label>
              <button
                class="form-btn-small"
                onclick="resetCustomCSS()"
                style="float: right; margin-top: -28px"
              >
                ÈáçÁΩÆ
              </button>
              <div class="css-editor-container">
                <textarea
                  class="css-editor"
                  id="settingsCustomCSS"
                  placeholder="/* Âú®Ê≠§ËæìÂÖ•Ëá™ÂÆö‰πâCSS‰ª£Á†Å */"
                ></textarea>
              </div>
            </div>

            <!-- Chat Preview -->
            <div class="chat-preview-container">
              <div class="preview-label">ÂÆûÊó∂È¢ÑËßà</div>
              <div class="preview-msg-row">
                <div class="preview-avatar" id="previewOtherAvatar">ü§ñ</div>
                <div>
                  <div class="preview-bubble" id="previewOtherBubble">
                    ÂØπÊñπÊ∂àÊÅØÈ¢ÑËßà
                  </div>
                  <div class="preview-time">10:00</div>
                </div>
              </div>
              <div class="preview-msg-row right">
                <div class="preview-avatar" id="previewMyAvatar">üòä</div>
                <div>
                  <div class="preview-bubble" id="previewMyBubble">
                    ÊàëÁöÑÊ∂àÊÅØÈ¢ÑËßà
                  </div>
                  <div class="preview-time">10:00</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Section 6: Data & Operations -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon brown">üíæ</div>
            <span class="section-title">Êï∞ÊçÆ‰∏éÊìç‰Ωú</span>
          </div>
          <div class="section-body">
            <div class="action-buttons-grid">
              <button class="action-btn" onclick="importChatHistory()">
                üì• ÂØºÂÖ•ËÅäÂ§©ËÆ∞ÂΩï
              </button>
              <button class="action-btn" onclick="exportChatHistory()">
                üì§ ÂØºÂá∫ËÅäÂ§©ËÆ∞ÂΩï
              </button>
            </div>
            <button
              class="action-btn"
              style="width: 100%; margin-top: 12px"
              onclick="searchChatContent()"
            >
              üîç Êü•ÊâæËÅäÂ§©ÂÜÖÂÆπ
            </button>
            <div style="border-top: 1px dashed #e5ddd3; margin: 20px 0"></div>
            <div class="action-buttons-grid">
              <button
                class="action-btn danger"
                onclick="clearChatHistoryFromSettings()"
              >
                üßπ Ê∏ÖÁ©∫ËÅäÂ§©
              </button>
              <button class="action-btn danger" onclick="blockCharacter()">
                üö´ ÊãâÈªëÂØπÊñπ
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Footer -->
      <div class="settings-footer">
        <button class="footer-btn cancel" onclick="closeChatSettings()">
          ‚ùå ÂèñÊ∂à
        </button>
        <button class="footer-btn save" onclick="saveChatSettings()">
          üíæ ‰øùÂ≠ò
        </button>
      </div>
    </div>

    <script>
      // ==================== „ÄêÊñ∞„ÄëÂÖ®Â±ÄÂèòÈáèÈõÜ‰∏≠Â£∞Êòé‰∏éÂàùÂßãÂåñ ====================
      // 1. ÂÖàÊääÊâÄÊúâÂèòÈáèÂÆö‰πâÂú® window ‰∏äÔºåÂàùÂßã‰∏∫Á©∫
      window.fontPresets = [];
      window.activeFontId = "system";
      window.readTogetherData = {};
      window.characters = []; // ‰ª•ÂâçÊï£ËêΩÂú® 1827 Ë°å
      window.apiPresets = []; // ‰ª•ÂâçÊï£ËêΩÂú® 1898 Ë°å
      window.chatHistories = {}; // ‰ª•ÂâçÊï£ËêΩÂú® 2095 Ë°å
      window.chatSettings = {}; // ‰ª•ÂâçÊï£ËêΩÂú® 2445 Ë°å
      window.userPersonaPresets = []; // ‰ª•ÂâçÊï£ËêΩÂú® 2660 Ë°å
      window.bookshelfData = []; // ‰ª•ÂâçÊï£ËêΩÂú® 3175 Ë°å
      window.voiceConfig = {}; // ‰ª•ÂâçÊï£ËêΩÂú® 2980 Ë°å

      // 2. ÂàõÂª∫‰∏Ä‰∏™ÂºÇÊ≠•ÂêØÂä®ÂáΩÊï∞
      async function initApp() {
        try {
          console.log("Ê≠£Âú®ÈÄöËøá localforage Âä†ËΩΩÊï∞ÊçÆ...");

          // Âπ∂Ë°åËØªÂèñÊâÄÊúâÊï∞ÊçÆÔºåÈÄüÂ∫¶Êõ¥Âø´
          const values = await Promise.all([
            localforage.getItem("fontPresets"),
            localforage.getItem("activeFontId"),
            localforage.getItem("readTogetherData"),
            localforage.getItem("characters"),
            localforage.getItem("apiPresets"),
            localforage.getItem("chatHistories"),
            localforage.getItem("chatSettings"),
            localforage.getItem("userPersonaPresets"),
            localforage.getItem("bookshelfData"),
            localforage.getItem("voiceConfig"),
            localforage.getItem("avatarImg"), // Â§¥ÂÉèÂçïÁã¨ËØªÂèñ
            localforage.getItem("activePresetId"), // APIÈ¢ÑËÆæÈÄâ‰∏≠Áä∂ÊÄÅ
          ]);

          // ËµãÂÄºÔºàÂ¶ÇÊûúËØªÂèñ‰∏∫ nullÔºåÂ∞±Áî®ÈªòËÆ§ÂÄºÔºâ
          window.fontPresets = values[0] || [];
          window.activeFontId = values[1] || "system";
          window.readTogetherData = values[2] || {};
          window.characters = values[3] || [];
          window.apiPresets = values[4] || [];
          window.chatHistories = values[5] || {};
          window.chatSettings = values[6] || {};
          window.userPersonaPresets = values[7] || [];
          window.bookshelfData = values[8] || [];
          window.voiceConfig = values[9] || {};

          const avatarImg = values[10];

          // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáèÔºå‰æõÂêéÈù¢APIÈ¢ÑËÆæÊ®°Âùó‰ΩøÁî®
          window.savedActivePresetId = values[11] || null;
          // „Äê‚úÖ ÂÖ≥ÈîÆ‰øÆÂ§çÂºÄÂßã„Äë
          // ÂøÖÈ°ªÊâãÂä®Êõ¥Êñ∞ activePresetId ÂèòÈáèÔºåÂê¶ÂàôÁïåÈù¢Ê∏≤ÊüìÊó∂‰∏çÁü•ÈÅìÂàöÊâçËØªÂà∞‰∫Ü‰ªÄ‰πà
          if (window.savedActivePresetId) {
            activePresetId = window.savedActivePresetId;
          }
          // „Äê‚úÖ ÂÖ≥ÈîÆ‰øÆÂ§çÁªìÊùü„Äë
          // Âä†ËΩΩÂ§¥ÂÉè
          if (avatarImg) {
            const img = document.getElementById("avatarImg");
            const ph = document.getElementById("avatarPlaceholder");
            if (img && ph) {
              img.src = avatarImg;
              img.style.display = "block";
              ph.style.display = "none";
            }
          }

          // Âä†ËΩΩ‰∏™‰∫∫ËµÑÊñô (Profile)
          const fields = ["name", "handle", "bio", "location"];
          const elementMap = {
            name: "profileName",
            handle: "profileHandle",
            bio: "profileBio",
            location: "profileLocation",
          };
          for (const field of fields) {
            const val = await localforage.getItem("profile_" + field);
            if (val) {
              const el = document.getElementById(elementMap[field]);
              if (el) {
                if (field === "handle")
                  el.textContent = "@" + val.replace("@", "");
                else el.textContent = val;
              }
            }
          }

          console.log("Êï∞ÊçÆÂä†ËΩΩÂÆåÊàêÔºåÂºÄÂßãÊ∏≤ÊüìÁïåÈù¢...");

          // Êï∞ÊçÆÂà∞‰Ωç‰∫ÜÔºåÂÜçË∞ÉÁî®ÂéüÊù•ÁöÑÊ∏≤ÊüìÂáΩÊï∞
          // Ê≥®ÊÑèÔºöËøôÈáåÊõøÊç¢‰∫ÜÂéüÊù•ÁöÑ window.onload Êàñ DOMContentLoaded ÈáåÁöÑÈÄªËæë
          renderCharacters();
          renderApiPresets();
          updateActiveConfigDisplay(); // Êõ¥Êñ∞ÂΩìÂâçÊøÄÊ¥ªÁöÑAPIÈÖçÁΩÆÊòæÁ§∫
          loadVoiceSettings();
          initUserPersonaPresets();

          // Â¶ÇÊûúÊúâËá™ÂÆö‰πâÂ≠ó‰ΩìÔºåÂ∫îÁî®ÂÆÉ
          if (window.activeFontId !== "system") {
            const font = window.fontPresets.find(
              (f) => f.id == window.activeFontId
            );
            if (font) injectGlobalFont(font.source);
          }
        } catch (err) {
          console.error("ÂàùÂßãÂåñÂ§±Ë¥•:", err);
          alert("Êï∞ÊçÆÂä†ËΩΩÂá∫ÈîôÔºåËØ∑Êü•ÁúãÊéßÂà∂Âè∞");
        }
      }

      // 3. ÂêØÂä®ÔºÅ
      document.addEventListener("DOMContentLoaded", initApp);

      // ÂøÖÈ°ªÁî® var ÂÆö‰πâÔºåÈò≤Ê≠¢Êä•Èîô
      var isSelectionMode = false;
      var activeMsgIndex = -1;
      var selectedIndices = new Set();
      var longPressTimer = null;
      var touchStartX = 0;
      var touchStartY = 0;
      var voiceTouchStartTime = 0;
      // ==================== Ê≥®ÂÖ•ËÅäÂ§©Â§¥ÂÉèÊ†∑Âºè ====================
      const avatarStyle = document.createElement("style");
      avatarStyle.innerHTML = `
    /* ========== ‰øÆÂ§çÊ†∏ÂøÉÔºöÊ∞îÊ≥°Â∏ÉÂ±Ä ========== */
    .msg-wrapper {
        display: flex;
        width: 100%;
        margin-bottom: 16px;
        gap: 10px;
        padding: 0 4px;
    }

    /* Áî®Êà∑Ê∂àÊÅØÔºöÂ§¥ÂÉèÂú®Âè≥ÔºåÊ∞îÊ≥°Âú®Â∑¶ÔºàÂèçÂêëÊéíÂàóÔºâ */
    .msg-wrapper.user {
        flex-direction: row-reverse;
    }

    /* AIÊ∂àÊÅØÔºöÂ§¥ÂÉèÂú®Â∑¶ÔºåÊ∞îÊ≥°Âú®Âè≥ */
    .msg-wrapper.ai {
        flex-direction: row;
    }

    /* Â§¥ÂÉèÊ†∑Âºè */
    .chat-avatar-small {
        width: 42px;
        height: 42px;
        border-radius: 12px;
        background: linear-gradient(135deg, #fce4ec, #e8f5e9);
        flex-shrink: 0;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        margin-top: 0px; 
    }
    .chat-avatar-small img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* ÂåÖË£πÊ∞îÊ≥°ÁöÑÂàóÂÆπÂô® */
    .msg-content-container {
        max-width: 72%;
        display: flex;
        flex-direction: column;
    }

    /* Ë¶ÜÁõñ msg-rowÔºåËÆ©ÂÆÉ‰Ωú‰∏∫ Flex Âàó */
    .msg-wrapper .msg-row {
        display: flex;
        flex-direction: column;
        max-width: 100%;
        margin: 0;
    }

    /* „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÂº∫Âà∂Ê∞îÊ≥°‰∏çÊãâ‰º∏ÔºÅ */
    /* Áî®Êà∑Ê∞îÊ≥°ÔºöÈù†Âè≥ÂØπÈΩê */
    .msg-wrapper.user .msg-content-container,
    .msg-wrapper.user .msg-row {
        align-items: flex-end !important; 
    }

    /* AIÊ∞îÊ≥°ÔºöÈù†Â∑¶ÂØπÈΩê */
    .msg-wrapper.ai .msg-content-container,
    .msg-wrapper.ai .msg-row {
        align-items: flex-start !important;
    }

    /* Á°Æ‰øùÊ∞îÊ≥°Êú¨Ë∫´ÁöÑÂÆΩÂ∫¶ÊòØÈÄÇÂ∫îÂÜÖÂÆπÁöÑ */
    .msg-bubble {
        width: fit-content !important;
        max-width: 100% !important;
        word-wrap: break-word;
        word-break: break-word;
    }

    /* Êó∂Èó¥ÂæÆË∞É */
    .msg-time-wrapper {
        font-size: 0.7rem;
        color: var(--text-hint);
        margin-top: 4px;
        padding: 0 2px;
    }
`;
      document.head.appendChild(avatarStyle);
      var currentEditField = "";
      // ==================== ÂõæÁâáÂéãÁº©Â∑•ÂÖ∑ ====================
      // file: ‰∏ä‰º†ÁöÑÊñá‰ª∂ÂØπË±°
      // maxWidth: ÂõæÁâáÊúÄÂ§ßÂÆΩÂ∫¶ (Â§¥ÂÉèÂª∫ËÆÆ300ÔºåËÉåÊôØÂª∫ËÆÆ800)
      // quality: ÂéãÁº©Ë¥®Èáè (0-1ÔºåÂª∫ËÆÆ0.7)
      function compressImage(file, maxWidth, quality) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
              // ËÆ°ÁÆóÂéãÁº©ÂêéÁöÑÂ∞∫ÂØ∏
              let width = img.width;
              let height = img.height;
              if (width > maxWidth) {
                height = Math.round(height * (maxWidth / width));
                width = maxWidth;
              }

              // ‰ΩøÁî® Canvas ÁªòÂõæÂπ∂ÂéãÁº©
              const canvas = document.createElement("canvas");
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0, width, height);

              // ÂØºÂá∫‰∏∫ÂéãÁº©ÂêéÁöÑ Base64
              resolve(canvas.toDataURL("image/jpeg", quality));
            };
          };
        });
      }
      // ‰øÆÊîπÂêéÁöÑ‰∏™‰∫∫‰∏ªÈ°µÂ§¥ÂÉè‰∏ä‰º†ÔºàÂ∏¶ÂéãÁº©Ôºâ
      async function handleAvatarUpload(input) {
        const file = input.files[0];
        if (file) {
          try {
            // Â§¥ÂÉèÂéãÁº©Âà∞ 300px ÂÆΩÔºåË¥®Èáè 0.7
            const compressedData = await compressImage(file, 300, 0.7);

            const img = document.getElementById("avatarImg");
            const placeholder = document.getElementById("avatarPlaceholder");
            img.src = compressedData;
            img.style.display = "block";
            placeholder.style.display = "none";
            localforage.setItem("avatarImg", compressedData);
          } catch (e) {
            alert("ÂõæÁâáÂ§ÑÁêÜÂ§±Ë¥•ÔºåËØ∑ÈáçËØï");
          }
        }
      }

      // Edit modal
      function openEditModal(field) {
        currentEditField = field;
        const modal = document.getElementById("editModal");
        const title = document.getElementById("editModalTitle");
        const input = document.getElementById("editInput");

        const titles = {
          name: "ÁºñËæëÁî®Êà∑Âêç",
          handle: "ÁºñËæëID",
          bio: "ÁºñËæë‰∏™ÊÄßÁ≠æÂêç",
          location: "ÁºñËæë‰ΩçÁΩÆ",
        };

        const placeholders = {
          name: "ËØ∑ËæìÂÖ•Áî®Êà∑Âêç",
          handle: "ËØ∑ËæìÂÖ•@ID",
          bio: "ËØ∑ËæìÂÖ•‰∏™ÊÄßÁ≠æÂêç",
          location: "ËØ∑ËæìÂÖ•‰ΩçÁΩÆ",
        };

        title.textContent = titles[field];
        input.placeholder = placeholders[field];
        input.value = localStorage.getItem("profile_" + field) || "";
        modal.classList.add("active");
        input.focus();
      }

      function closeEditModal() {
        document.getElementById("editModal").classList.remove("active");
      }

      function saveEdit() {
        const input = document.getElementById("editInput");
        const value = input.value.trim();

        if (value) {
          localforage.setItem("profile_" + currentEditField, value);

          const elementMap = {
            name: "profileName",
            handle: "profileHandle",
            bio: "profileBio",
            location: "profileLocation",
          };

          const element = document.getElementById(elementMap[currentEditField]);
          if (currentEditField === "handle") {
            element.textContent = "@" + value.replace("@", "");
          } else {
            element.textContent = value;
          }
        }

        closeEditModal();
      }

      // Page navigation
      function openPage(pageId) {
        document.getElementById(pageId).classList.add("active");
      }

      function closePage(pageId) {
        const page = document.getElementById(pageId);
        page.classList.remove("active");
      }

      // Load saved data
      function loadSavedData() {
        // Avatar
        const avatarData = localStorage.getItem("avatarImg");
        if (avatarData) {
          const img = document.getElementById("avatarImg");
          const placeholder = document.getElementById("avatarPlaceholder");
          img.src = avatarData;
          img.style.display = "block";
          placeholder.style.display = "none";
        }

        // Profile fields
        const fields = ["name", "handle", "bio", "location"];
        const elementMap = {
          name: "profileName",
          handle: "profileHandle",
          bio: "profileBio",
          location: "profileLocation",
        };

        fields.forEach((field) => {
          const saved = localStorage.getItem("profile_" + field);
          if (saved) {
            const element = document.getElementById(elementMap[field]);
            if (field === "handle") {
              element.textContent = "@" + saved.replace("@", "");
            } else {
              element.textContent = saved;
            }
          }
        });
      }

      // Close modal on outside click
      document
        .getElementById("editModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeEditModal();
          }
        });

      // Enter key to save
      document
        .getElementById("editInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            saveEdit();
          }
        });

      // Chat App Tab Switching
      function switchChatTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll(".chat-tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Remove active from all tabs
        document.querySelectorAll(".chat-tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected tab content
        document.getElementById(tabName + "Tab").classList.add("active");

        // Set active tab
        const tabs = document.querySelectorAll(".chat-tab");
        const tabIndex = { messages: 0, moments: 1, todo: 2, profile: 3 };
        tabs[tabIndex[tabName]].classList.add("active");

        // Update header title
        const titles = {
          messages: "Message",
          moments: "Moment",
          todo: "To Do",
          profile: "Me",
        };
        document.getElementById("chatAppTitle").textContent = titles[tabName];

        // Update header button (todoÁî®ËÆæÁΩÆÊåâÈíÆ)
        const buttons = {
          messages: "‚ûï",
          moments: "üì∑",
          todo: "‚öôÔ∏è",
          profile: "‚öôÔ∏è",
        };
        document.getElementById("chatHeaderBtn").textContent = buttons[tabName];

        // ÂàáÊç¢Âà∞momentsÊó∂Ê∏ÖÈô§ÊúãÂèãÂúàÂ∞èÁ∫¢ÁÇπ
        if (tabName === "moments") {
          if (typeof clearUnreadMoments === "function") clearUnreadMoments();
        }

        // ËÉåÊôØÂíåÊªöÂä®ÊéßÂà∂
        const chatApp = document.querySelector(".chat-app");
        const tabBar = document.querySelector(".chat-tab-bar");
        const chatContent = document.querySelector(".chat-content");

        if (tabName === "messages") {
          // messagesÈ°µÈù¢‰øùÁïôÊ≥¢ÁÇπËÉåÊôØ
          chatApp.style.background = "#fdf5f7";
          chatApp.style.backgroundImage =
            "radial-gradient(circle, rgba(244,143,177,0.15) 2px, transparent 2px)";
          chatApp.style.backgroundSize = "20px 20px";
          chatContent.style.background = "transparent";
          tabBar.style.background = "rgba(255, 255, 255, 0.7)";
          tabBar.style.backdropFilter = "blur(25px) saturate(180%)";
          tabBar.style.webkitBackdropFilter = "blur(25px) saturate(180%)";
          chatContent.style.overflowY = "auto";
        } else if (tabName === "moments") {
          chatApp.style.backgroundImage = "none";
          chatApp.style.background = "#efefef";
          chatContent.style.background = "#efefef";
          tabBar.style.background = "rgba(255, 255, 255, 0.25)";
          tabBar.style.backdropFilter = "blur(30px) saturate(180%)";
          tabBar.style.webkitBackdropFilter = "blur(30px) saturate(180%)";
          chatContent.style.overflowY = "auto";
        } else if (tabName === "todo") {
          chatApp.style.backgroundImage = "none";
          chatApp.style.background = "#fffafa";
          chatContent.style.background = "#fffafa";
          tabBar.style.background = "rgba(255, 255, 255, 0.25)";
          tabBar.style.backdropFilter = "blur(30px) saturate(180%)";
          tabBar.style.webkitBackdropFilter = "blur(30px) saturate(180%)";
          chatContent.style.overflowY = "auto";
        } else {
          // profileÈ°µÈù¢
          chatApp.style.backgroundImage = "none";
          chatApp.style.background = "#f5f5f5";
          chatContent.style.background = "#f5f5f5";
          tabBar.style.background = "rgba(255, 255, 255, 0.25)";
          tabBar.style.backdropFilter = "blur(30px) saturate(180%)";
          tabBar.style.webkitBackdropFilter = "blur(30px) saturate(180%)";
          chatContent.style.overflowY = "hidden";
        }

        // ÂàáÊç¢Âà∞ÂæÖÂäûÊ†áÁ≠æÊó∂Âà∑Êñ∞AIËßíËâ≤ÂàóË°®ÂíåÊó•Êúü
        if (tabName === "todo") {
          if (typeof renderTodoAiCharList === "function")
            renderTodoAiCharList();
          if (typeof updateTodoDate === "function") updateTodoDate();
          if (typeof updateTodoStats === "function") updateTodoStats();
        }
      }

      // ÊóßÁöÑtodoÁÇπÂáª‰∫ã‰ª∂Â∑≤Â∫üÂºÉÔºå‰ΩøÁî®Êñ∞ÁöÑÂæÖÂäûÁ≥ªÁªü

      // Character data storage
      var tempCharAvatar = null;

      // Header button handler
      function handleHeaderBtn() {
        const currentTab = document.querySelector(
          ".chat-tab.active .tab-label"
        ).textContent;
        if (currentTab === "Message") {
          openCreateCharModal();
        } else if (currentTab === "To Do") {
          openTodoSettingsModal();
        }
      }

      // Open create character modal
      function openCreateCharModal() {
        document.getElementById("createCharModal").classList.add("active");
        document.getElementById("charNameInput").value = "";
        document.getElementById("charNoteInput").value = "";
        document.getElementById("charAvatarPreview").style.display = "none";
        document.getElementById("charAvatarPlaceholder").style.display =
          "block";
        document.querySelector(".create-avatar").classList.remove("has-image");
        tempCharAvatar = null;
      }

      // Close create character modal
      function closeCreateCharModal() {
        document.getElementById("createCharModal").classList.remove("active");
      }

      // ‰øÆÊîπÂêéÁöÑÂàõÂª∫ËßíËâ≤Â§¥ÂÉèÈ¢ÑËßàÔºàÂ∏¶ÂéãÁº©Ôºâ
      async function previewCharAvatar(input) {
        const file = input.files[0];
        if (file) {
          // Â§¥ÂÉèÂéãÁº©Âà∞ 300px
          const compressedData = await compressImage(file, 300, 0.7);

          const preview = document.getElementById("charAvatarPreview");
          const placeholder = document.getElementById("charAvatarPlaceholder");
          preview.src = compressedData;
          preview.style.display = "block";
          placeholder.style.display = "none";
          document.querySelector(".create-avatar").classList.add("has-image");
          tempCharAvatar = compressedData; // Â≠òÂÖ•‰∏¥Êó∂ÂèòÈáèÁöÑÊòØÂéãÁº©ÂêéÁöÑÊï∞ÊçÆ
        }
      }

      // Create character
      function createCharacter() {
        const name = document.getElementById("charNameInput").value.trim();
        const note = document.getElementById("charNoteInput").value.trim();

        if (!name) {
          alert("ËØ∑ËæìÂÖ•ËßíËâ≤ÂêçÁß∞");
          return;
        }

        const character = {
          id: Date.now(),
          name: name,
          note: note,
          avatar: tempCharAvatar,
          lastMessage: "",
          lastTime: "ÂàöÂàö",
          unread: 0,
        };

        characters.push(character);
        localforage.setItem("characters", characters);

        renderCharacters();
        closeCreateCharModal();
      }

      function renderCharacters() {
        const container = document.getElementById("messageList");

        if (characters.length === 0) {
          container.innerHTML = `
                                    <div class="empty-state" id="emptyMessages">
                                        <div class="empty-icon">üí≠</div>
                                        <div class="empty-text">ËøòÊ≤°ÊúâÊ∂àÊÅØÂì¶</div>
                                        <div class="empty-hint">Ê∑ªÂä†AIËßíËâ≤ÂºÄÂßãËÅäÂ§©ÂêßÔΩû</div>
                                    </div>
                                `;
          return;
        }

        // ÂàÜÁ¶ªÁΩÆÈ°∂ÂíåÊôÆÈÄöËßíËâ≤
        const pinnedChars = [];
        const normalChars = [];
        const groupedChars = {};

        characters.forEach((char) => {
          const settings = chatSettings[char.id] || {};
          if (settings.pinned) {
            pinnedChars.push(char);
          } else if (settings.group && settings.group !== "none") {
            if (!groupedChars[settings.group]) {
              groupedChars[settings.group] = [];
            }
            groupedChars[settings.group].push(char);
          } else {
            normalChars.push(char);
          }
        });

        // ÁîüÊàêËßíËâ≤Âç°ÁâáHTMLÁöÑÂáΩÊï∞
        const renderCharCard = (char, isPinned = false) => {
          const displayName = char.note || char.name;
          let sparkHtml = "";
          if (char.flameData && char.flameData.active) {
            sparkHtml = `<span class="spark-badge">${char.flameData.icon} ${char.flameData.days}</span>`;
          }
          // Ëé∑ÂèñÊú™ËØªÊ∂àÊÅØÊï∞
          const unreadCount =
            (typeof unreadMessages !== "undefined" &&
              unreadMessages[char.id]) ||
            char.unread ||
            0;
          return `
            <div class="message-item ${isPinned ? "pinned" : ""}" data-id="${
            char.id
          }">
              <div class="message-avatar">
                ${
                  char.avatar
                    ? `<img src="${char.avatar}" alt="${char.name}">`
                    : "ü§ñ"
                }
              </div>
              <div class="message-info">
                <div class="message-top">
                  <span class="message-name">${displayName} ${sparkHtml}</span>
                  <span class="message-time">${char.lastTime || ""}</span>
                </div>
                <div class="message-preview">${
                  char.lastMessage || "ÁÇπÂáªÂºÄÂßãËÅäÂ§©ÔΩû"
                }</div>
              </div>
              ${
                unreadCount > 0
                  ? `<div class="message-badge">${unreadCount}</div>`
                  : ""
              }
            </div>
          `;
        };

        let html = "";

        // ÁΩÆÈ°∂ÁöÑËßíËâ≤
        if (pinnedChars.length > 0) {
          html += pinnedChars
            .map((char) => renderCharCard(char, true))
            .join("");
        }

        // ÂàÜÁªÑÁöÑËßíËâ≤
        Object.keys(groupedChars).forEach((groupName) => {
          const chars = groupedChars[groupName];
          html += `
            <div class="message-group" id="group_${groupName}">
              <div class="message-group-header" onclick="toggleGroup('${groupName}')">
                <span class="message-group-title">
                  <span class="message-group-arrow">‚ñº</span>
                  ${groupName} (${chars.length})
                </span>
              </div>
              <div class="message-group-content">
                ${chars.map((char) => renderCharCard(char)).join("")}
              </div>
            </div>
          `;
        });

        // Êú™ÂàÜÁªÑÁöÑËßíËâ≤
        if (normalChars.length > 0) {
          html += normalChars.map((char) => renderCharCard(char)).join("");
        }

        container.innerHTML = html;

        document.querySelectorAll(".message-item").forEach((item) => {
          item.onclick = function () {
            const charId = parseInt(this.dataset.id);
            openConversation(charId);
          };
        });
      }

      // ÂàáÊç¢ÂàÜÁªÑÂ±ïÂºÄ/Êî∂Ëµ∑
      function toggleGroup(groupName) {
        const group = document.getElementById(`group_${groupName}`);
        if (group) {
          group.classList.toggle("collapsed");
        }
      }

      // Close modal on outside click
      document
        .getElementById("createCharModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeCreateCharModal();
          }
        });

      // ==================== API PRESETS MANAGEMENT ====================
      // ‰ΩøÁî®‰ªélocalforageÂä†ËΩΩÁöÑÂÄºÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÂ∞ùËØïlocalStorageÔºàÂÖºÂÆπÊóßÊï∞ÊçÆÔºâ
      var activePresetId =
        window.savedActivePresetId ||
        localStorage.getItem("activePresetId") ||
        null;
      var editingPresetId = null;
      var tempModelList = [];

      // Render API presets list
      function renderApiPresets() {
        const container = document.getElementById("apiPresetList");

        if (apiPresets.length === 0) {
          container.innerHTML = `
                                            <div class="empty-state" id="emptyPresets">
                                                <div class="empty-icon">üîå</div>
                                                <div class="empty-text">ËøòÊ≤°ÊúâAPIÈ¢ÑËÆæ</div>
                                                <div class="empty-hint">ÁÇπÂáªÂè≥‰∏äËßí ‚ûï ÂàõÂª∫È¢ÑËÆæ</div>
                                            </div>
                                        `;
          return;
        }

        container.innerHTML = apiPresets
          .map(
            (preset) => `
                                        <div class="api-preset-item ${
                                          activePresetId == preset.id
                                            ? "active"
                                            : ""
                                        }" onclick="selectApiPreset(${
              preset.id
            })">
                                            <div class="preset-radio"></div>
                                            <div class="preset-info">
                                                <div class="preset-name">${escapeHtml(
                                                  preset.name
                                                )}</div>
                                                <div class="preset-detail">${
                                                  preset.model || "Êú™ÈÄâÊã©Ê®°Âûã"
                                                }</div>
                                            </div>
                                            <button class="preset-edit-btn" onclick="event.stopPropagation(); editApiPreset(${
                                              preset.id
                                            })">‚úèÔ∏è</button>
                                        </div>
                                    `
          )
          .join("");
      }

      // Select API preset as active
      function selectApiPreset(presetId) {
        activePresetId = presetId;
        localforage.setItem("activePresetId", presetId); // ËøôÈáåÂÖ∂ÂÆûÂ∑≤ÁªèËá™Âä®‰øùÂ≠ò‰∫Ü
        renderApiPresets();
        updateActiveConfigDisplay();

        // „Äê‚úÖ Êñ∞Â¢ûÔºöÁªô‰∏™ÊèêÁ§∫ÔºåËÆ©‰Ω†Áü•ÈÅì‰øùÂ≠òÊàêÂäü‰∫Ü„Äë
        const preset = apiPresets.find((p) => p.id == presetId);
        if (preset) {
          showToast(`Â∑≤ÂàáÊç¢Âπ∂‰øùÂ≠òÈ¢ÑËÆæÔºö${preset.name}`);
        }
      }

      // Update active config display
      function updateActiveConfigDisplay() {
        const section = document.getElementById("activeConfigSection");
        if (!activePresetId) {
          section.style.display = "none";
          return;
        }

        const preset = apiPresets.find((p) => p.id == activePresetId);
        if (!preset) {
          section.style.display = "none";
          return;
        }

        document.getElementById("activePresetName").textContent = preset.name;
        document.getElementById("activeModelName").textContent =
          preset.model || "Êú™ÈÄâÊã©";
        section.style.display = "block";
      }

      // Close API preset modal
      function closeApiPresetModal() {
        document.getElementById("apiPresetModal").classList.remove("active");
        editingPresetId = null;
      }

      // Toggle API key visibility in modal
      function togglePresetKeyVisibility() {
        const input = document.getElementById("presetKeyInput");
        const btn = document.querySelector(".key-toggle-btn");
        if (input.type === "password") {
          input.type = "text";
          btn.textContent = "üôà";
        } else {
          input.type = "password";
          btn.textContent = "üëÅÔ∏è";
        }
      }

      // Fetch models for preset
      async function fetchPresetModels() {
        const url = document.getElementById("presetUrlInput").value.trim();
        const key = document.getElementById("presetKeyInput").value.trim();

        if (!url || !key) {
          alert("ËØ∑ÂÖàÂ°´ÂÜôÂèç‰ª£Âú∞ÂùÄÂíå API Key");
          return;
        }

        const btn = document.querySelector(".model-fetch-btn");
        btn.textContent = "ÊãâÂèñ‰∏≠...";
        btn.classList.add("loading");

        try {
          // Ensure URL is properly formatted
          let baseUrl = url.replace(/\/+$/, "");
          if (!baseUrl.includes("/v1")) {
            baseUrl += "/v1";
          }

          const response = await fetch(`${baseUrl}/models`, {
            method: "GET",
            mode: "cors",
            headers: {
              Authorization: `Bearer ${key}`,
            },
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          tempModelList = data.data || [];

          if (tempModelList.length === 0) {
            alert("Ê≤°ÊúâËé∑ÂèñÂà∞ÂèØÁî®Ê®°Âûã");
            return;
          }

          // Render model dropdown
          renderModelDropdown();
          document.getElementById("modelDropdown").classList.add("active");
        } catch (error) {
          console.error("Fetch models error:", error);
          // Â¶ÇÊûúÊòØCORSÈîôËØØÔºåÊèêÁ§∫Áî®Êà∑ÊâãÂä®ËæìÂÖ•
          if (
            error.message.includes("Failed to fetch") ||
            error.message.includes("NetworkError") ||
            error.message.includes("CORS")
          ) {
            alert(
              "ÊãâÂèñÂ§±Ë¥•ÔºàÂèØËÉΩÊòØË∑®ÂüüÈôêÂà∂Ôºâ\n\nÊÇ®ÂèØ‰ª•Áõ¥Êé•Âú®Ê®°ÂûãËæìÂÖ•Ê°Ü‰∏≠ÊâãÂä®ËæìÂÖ•Ê®°ÂûãÂêçÁß∞Ôºå‰æãÂ¶Ç:\n‚Ä¢ gpt-4o\n‚Ä¢ gpt-4-turbo\n‚Ä¢ claude-3-opus-20240229\n‚Ä¢ claude-3-sonnet-20240229"
            );
            // ÂêØÁî®ÊâãÂä®ËæìÂÖ•
            document
              .getElementById("presetModelInput")
              .removeAttribute("readonly");
            document.getElementById("presetModelInput").placeholder =
              "ÊâãÂä®ËæìÂÖ•Ê®°ÂûãÂêçÁß∞";
          } else {
            alert("ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•: " + error.message);
          }
        } finally {
          btn.textContent = "ÊãâÂèñ";
          btn.classList.remove("loading");
        }
      }

      // Render model dropdown
      function renderModelDropdown() {
        const container = document.getElementById("modelDropdown");
        const currentModel = document.getElementById("presetModelInput").value;

        container.innerHTML = tempModelList
          .map(
            (model) => `
                                        <div class="model-option ${
                                          model.id === currentModel
                                            ? "selected"
                                            : ""
                                        }" onclick="selectPresetModel('${
              model.id
            }')">
                                            ${model.id}
                                        </div>
                                    `
          )
          .join("");
      }

      // Select model for preset
      function selectPresetModel(modelId) {
        document.getElementById("presetModelInput").value = modelId;
        document.getElementById("modelDropdown").classList.remove("active");
      }
      // ÊâìÂºÄÊñ∞Âª∫Á™óÂè£ÔºöÈáçÁΩÆÊâÄÊúâÊªëÂùó‰∏∫ÈªòËÆ§ÂÄº
      function openApiPresetModal() {
        editingPresetId = null;
        document.getElementById("apiModalTitle").textContent = "ÂàõÂª∫ API È¢ÑËÆæ";
        document.getElementById("presetNameInput").value = "";
        document.getElementById("presetUrlInput").value = "";
        document.getElementById("presetKeyInput").value = "";
        document.getElementById("presetModelInput").value = "";
        document.getElementById("presetKeyInput").type = "password";
        document.getElementById("modelDropdown").classList.remove("active");
        document.getElementById("presetDeleteBtn").style.display = "none";

        // --- Êñ∞Â¢ûÔºöÈáçÁΩÆÂèÇÊï∞ÊªëÂùó ---
        document.getElementById("presetTempInput").value = "1.0";
        document.getElementById("valTemp").textContent = "1.0";

        document.getElementById("presetFreqInput").value = "0.0";
        document.getElementById("valFreq").textContent = "0.0";

        document.getElementById("presetPresInput").value = "0.0";
        document.getElementById("valPres").textContent = "0.0";
        // ------------------------

        tempModelList = [];
        document.getElementById("apiPresetModal").classList.add("active");
      }

      // ÊâìÂºÄÁºñËæëÁ™óÂè£ÔºöÂõûÊòæ‰øùÂ≠òÁöÑÂèÇÊï∞
      function editApiPreset(presetId) {
        const preset = apiPresets.find((p) => p.id === presetId);
        if (!preset) return;

        editingPresetId = presetId;
        document.getElementById("apiModalTitle").textContent = "ÁºñËæë API È¢ÑËÆæ";
        document.getElementById("presetNameInput").value = preset.name;
        document.getElementById("presetUrlInput").value = preset.url;
        document.getElementById("presetKeyInput").value = preset.key;
        document.getElementById("presetModelInput").value = preset.model || "";
        document.getElementById("modelDropdown").classList.remove("active");
        document.getElementById("presetDeleteBtn").style.display = "block";

        // --- Êñ∞Â¢ûÔºöÂõûÊòæÂèÇÊï∞ÊªëÂùó (Â¶ÇÊûúÊ≤°ÊúâÂÄºÂàô‰ΩøÁî®ÈªòËÆ§) ---
        const temp =
          preset.temperature !== undefined ? preset.temperature : 1.0;
        const freq =
          preset.frequency_penalty !== undefined
            ? preset.frequency_penalty
            : 0.0;
        const pres =
          preset.presence_penalty !== undefined ? preset.presence_penalty : 0.0;

        document.getElementById("presetTempInput").value = temp;
        document.getElementById("valTemp").textContent = temp;

        document.getElementById("presetFreqInput").value = freq;
        document.getElementById("valFreq").textContent = freq;

        document.getElementById("presetPresInput").value = pres;
        document.getElementById("valPres").textContent = pres;
        // ------------------------

        tempModelList = [];
        document.getElementById("apiPresetModal").classList.add("active");
      }

      // ‰øùÂ≠òÈÄªËæëÔºöÂ∞ÜÊªëÂùóÁöÑÂÄºÂ≠òÂÖ•È¢ÑËÆæÂØπË±°
      function saveApiPreset() {
        const name = document.getElementById("presetNameInput").value.trim();
        const url = document.getElementById("presetUrlInput").value.trim();
        const key = document.getElementById("presetKeyInput").value.trim();
        const model = document.getElementById("presetModelInput").value.trim();

        // --- Êñ∞Â¢ûÔºöËé∑ÂèñÂèÇÊï∞ÂÄº ---
        const temperature = parseFloat(
          document.getElementById("presetTempInput").value
        );
        const frequency_penalty = parseFloat(
          document.getElementById("presetFreqInput").value
        );
        const presence_penalty = parseFloat(
          document.getElementById("presetPresInput").value
        );
        // ---------------------

        if (!name) {
          alert("ËØ∑ËæìÂÖ•È¢ÑËÆæÂêçÁß∞");
          return;
        }
        if (!url) {
          alert("ËØ∑ËæìÂÖ•Âèç‰ª£Âú∞ÂùÄ");
          return;
        }
        if (!key) {
          alert("ËØ∑ËæìÂÖ• API Key");
          return;
        }

        let baseUrl = url.replace(/\/+$/, "");
        if (!baseUrl.includes("/v1")) {
          baseUrl += "/v1";
        }

        // ÊûÑÂª∫Êñ∞ÁöÑÊï∞ÊçÆÂØπË±°
        const presetData = {
          name,
          url: baseUrl,
          key,
          model,
          // ‰øùÂ≠òÊñ∞ÂèÇÊï∞
          temperature,
          frequency_penalty,
          presence_penalty,
        };

        if (editingPresetId) {
          const index = apiPresets.findIndex((p) => p.id === editingPresetId);
          if (index !== -1) {
            // ÂêàÂπ∂Êï∞ÊçÆÔºå‰øùÁïô id
            apiPresets[index] = { ...apiPresets[index], ...presetData };
          }
        } else {
          const newPreset = {
            id: Date.now(),
            ...presetData,
          };
          apiPresets.push(newPreset);
          if (apiPresets.length === 1) {
            activePresetId = newPreset.id;
            localforage.setItem("activePresetId", activePresetId);
          }
        }

        localforage.setItem("apiPresets", apiPresets);
        renderApiPresets();
        updateActiveConfigDisplay();
        closeApiPresetModal();
      }
      // Delete API preset
      function deleteApiPreset() {
        if (!editingPresetId) return;

        if (confirm("Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™È¢ÑËÆæÂêóÔºü")) {
          apiPresets = apiPresets.filter((p) => p.id !== editingPresetId);
          localforage.setItem("apiPresets", apiPresets);

          // Clear active if deleted
          if (activePresetId == editingPresetId) {
            activePresetId = apiPresets.length > 0 ? apiPresets[0].id : null;
            localforage.setItem("activePresetId", activePresetId || "");
          }

          renderApiPresets();
          updateActiveConfigDisplay();
          closeApiPresetModal();
        }
      }

      // Get current active API config
      function getActiveApiConfig() {
        if (!activePresetId) return null;
        return apiPresets.find((p) => p.id == activePresetId) || null;
      }

      // Close dropdown when clicking outside
      document.addEventListener("click", function (e) {
        const dropdown = document.getElementById("modelDropdown");
        const modelInput = document.getElementById("presetModelInput");
        const fetchBtn = document.querySelector(".model-fetch-btn");

        if (
          dropdown &&
          !dropdown.contains(e.target) &&
          e.target !== modelInput &&
          e.target !== fetchBtn
        ) {
          dropdown.classList.remove("active");
        }
      });

      // ==================== CHAT CONVERSATION ====================
      var currentChatCharId = null;

      // Open conversation
      function openConversation(charId) {
        // ËÆæÁΩÆÊ†áÈ¢òÊ†è (Â∏¶ÁÅ´Ëä±)
        const settings = chatSettings[charId] || {};
        currentChatCharId = charId;
        const char = characters.find((c) => c.id === charId);
        if (!char) return;

        // Ê∏ÖÈô§ËØ•ËßíËâ≤ÁöÑÊú™ËØªÊ∂àÊÅØ
        if (typeof clearUnreadForChar === "function") {
          clearUnreadForChar(charId);
        }

        // Set header info
        document.getElementById("convName").textContent = char.name;
        const avatarEl = document.getElementById("convAvatar");
        if (char.avatar) {
          avatarEl.innerHTML = `<img src="${char.avatar}" alt="${char.name}">`;
        } else {
          avatarEl.innerHTML = "ü§ñ";
        }

        // Load chat history
        renderConversation();

        // Â∫îÁî®Â§¥ÂÉèÂèØËßÅÊÄßËÆæÁΩÆ
        applyAvatarVisibility(
          settings.showAiAvatar !== false,
          settings.showUserAvatar !== false
        );

        // ÁîüÊàêÁÅ´Ëä± HTML
        let sparkHtml = "";
        // Ê≥®ÊÑèÔºöËøôÈáåËØªÂèñÁöÑÊòØ chatSettings ÈáåÁöÑ flameDataÔºåÊàñËÄÖ characters ÈáåÁöÑ
        const fData = settings.flameData || char.flameData;
        if (fData && fData.active) {
          sparkHtml = `<span class="spark-badge">${fData.icon} ${fData.days}</span>`;
        }
        const displayTitle =
          settings.charNote || settings.charName || char.name;
        document.getElementById("convName").innerHTML =
          displayTitle + sparkHtml;
        // Show page
        document.getElementById("chatConversationPage").classList.add("active");
      }

      // Close conversation
      function closeConversation() {
        document
          .getElementById("chatConversationPage")
          .classList.remove("active");
        document.getElementById("convMenu").classList.remove("active");
        currentChatCharId = null;

        // Âà∑Êñ∞Ë°®ÊÉÖÈù¢ÊùøÁöÑÁªëÂÆöÁä∂ÊÄÅÊòæÁ§∫
        if (typeof renderCategoryBar === "function") {
          renderCategoryBar();
        }
      }

      // Toggle conversation menu
      function toggleConvMenu() {
        document.getElementById("convMenu").classList.toggle("active");
      }

      // ==================== ‰øÆÂ§çÔºöÂÆåÊï¥ÁöÑ renderMessageGroup ÂáΩÊï∞ ====================
      // ==================== ‰øÆÂ§çÔºöÂÆåÊï¥ÁöÑÊ∂àÊÅØÊ∏≤ÊüìÂáΩÊï∞ ====================
      window.renderMessageGroup = function (
        messages,
        role,
        aiAvatarSrc,
        userAvatarSrc
      ) {
        const isUser = role === "user";

        const bubbles = messages
          .map((m) => {
            // 1. Â§öÈÄâÁä∂ÊÄÅÂà§Êñ≠
            // Ê≥®ÊÑèÔºöisSelecting ÊòØ‚ÄúÊòØÂê¶Â§Ñ‰∫éÂ§öÈÄâÊ®°Âºè‚Äù
            const isSelecting =
              typeof isSelectionMode !== "undefined" && isSelectionMode;

            // 2. ÂçïÊù°ÈÄâ‰∏≠Âà§Êñ≠
            // Ê≥®ÊÑèÔºöisSelected ÊòØ‚ÄúËøôÊù°Ê∂àÊÅØÊòØÂê¶Ë¢´ÂãæÈÄâ‚Äù
            const isSelected =
              isSelecting &&
              typeof selectedIndices !== "undefined" &&
              selectedIndices.has(m.originalIndex);

            // 3. Ê†∏ÂøÉ‰øÆÂ§çÔºöÊ£ÄÊµãÊòØÂê¶‰∏∫Ë°®ÊÉÖÂåÖ
            const rawContent = m.content || "";
            // Ê£ÄÊµãÂ∑≤Ê∏≤ÊüìÁöÑË°®ÊÉÖÂåÖÂõæÁâáÔºåÊàñËÄÖÂéüÂßãÁöÑË°®ÊÉÖÂåÖÊ†áÁ≠æ
            const isSticker =
              rawContent.includes('class="sticker-img"') ||
              /^\[(sticker|Ë°®ÊÉÖ|Ë°®ÊÉÖÂåÖ)[Ôºö:][^\]]+\]$/i.test(rawContent.trim());

            // 4. ÁîüÊàêÊ∞îÊ≥°Ê†∑Âºè
            // Â¶ÇÊûúÊòØË°®ÊÉÖÂåÖÔºåÂä†‰∏ä sticker-bubble Á±ªÔºõÂ¶ÇÊûúÊòØÈÄâ‰∏≠Áä∂ÊÄÅÔºåÂä†‰∏ä selected Á±ª
            const bubbleClass = `msg-bubble ${isSelected ? "selected" : ""} ${
              isSticker ? "sticker-bubble" : ""
            }`;

            // 5. ËØ≠Èü≥Ê∂àÊÅØÂ§ÑÁêÜ
            const voiceMatch =
              rawContent.match && rawContent.match(/^\[ËØ≠Èü≥[ :Ôºö„ÄÉ\s]*(.+)\]$/);

            if (voiceMatch && !isUser) {
              const voiceText = voiceMatch[1];
              const hasAudio = m.audioUrl ? "has-audio" : "";
              const duration =
                m.audioDuration || Math.ceil(voiceText.length / 5) + '"';
              const textVisible = m.voiceTextVisible ? "visible" : "";

              return `
            <div class="${bubbleClass} voice-message-bubble"
                    data-index="${m.originalIndex}"
                    data-voice-text="${escapeHtml(voiceText)}"
                    oncontextmenu="return false;"
                    ontouchstart="handleVoiceBubbleTouchStart(event, ${
                      m.originalIndex
                    })"
                    ontouchend="handleVoiceBubbleTouchEnd(event, ${
                      m.originalIndex
                    })"
                    ontouchmove="handleTouchMove(event)"
                    onmousedown="handleMouseDown(event, ${m.originalIndex})"
                    onmouseup="handleMouseUp()"
            >
                <div class="voice-message">
                    <div class="voice-bar ${hasAudio}" data-audio-url="${
                m.audioUrl || ""
              }" onclick="playVoiceMessage(event, ${m.originalIndex})">
                        <div class="voice-waves">
                            <span></span><span></span><span></span><span></span><span></span>
                        </div>
                        <span class="voice-duration">${duration}</span>
                    </div>
                    <div class="voice-text ${textVisible}" id="voiceText-${
                m.originalIndex
              }">${escapeHtml(voiceText)}</div>
                    <div class="voice-to-text-btn" onclick="toggleVoiceText(event, ${
                      m.originalIndex
                    })">
                        ${m.voiceTextVisible ? "Êî∂Ëµ∑ÊñáÂ≠ó" : "ËΩ¨ÊñáÂ≠ó"}
                    </div>
                </div>
            </div>`;
            }

            // 6. ÊôÆÈÄö/ÂØåÊñáÊú¨Ê∂àÊÅØÂ§ÑÁêÜ
            let contentHtml;
            if (
              m.isHtml ||
              rawContent.includes("<img") ||
              rawContent.includes("style=")
            ) {
              contentHtml = rawContent;
            } else {
              // ÂÖàÂ§ÑÁêÜAIË°®ÊÉÖÂåÖÊ†áÁ≠æ [sticker:xxx]
              contentHtml = processAiStickerTags(rawContent);
              // ÂÜçÂ§ÑÁêÜÂÖ∂‰ªñÊ†ºÂºèÂåñ
              if (!contentHtml.includes('class="sticker-img"')) {
                contentHtml = formatNovelMessage(contentHtml);
              }
            }

            // ÊôÆÈÄöÊ∞îÊ≥° HTML
            return `
        <div class="${bubbleClass}"
                data-index="${m.originalIndex}"
                oncontextmenu="return false;"
                ontouchstart="handleTouchStart(event, ${m.originalIndex})"
                ontouchend="handleTouchEnd()"
                ontouchmove="handleTouchMove(event)"
                onmousedown="handleMouseDown(event, ${m.originalIndex})"
                onmouseup="handleMouseUp()"
                onclick="handleBubbleClick(event, ${m.originalIndex})"
        >
            ${contentHtml}
        </div>`;
          })
          .join("");

        // 7. Â§¥ÂÉè‰∏éÊó∂Èó¥
        const time = messages[messages.length - 1].time || "";
        const avatarUrl = isUser ? userAvatarSrc : aiAvatarSrc;
        const defaultEmoji = isUser ? "üòä" : "ü§ñ";
        const avatarHtml = avatarUrl
          ? `<img src="${avatarUrl}" />`
          : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:20px;">${defaultEmoji}</div>`;

        // 8. ÁªÑÂêàÊúÄÁªà HTML
        return `
    <div class="msg-wrapper ${isUser ? "user" : "ai"}">
        <div class="chat-avatar-small">
            ${avatarHtml}
        </div>
        <div class="msg-content-container">
            <div class="msg-row ${isUser ? "user" : "ai"}">
                ${bubbles}
            </div>
            <div class="msg-time-wrapper">${time}</div>
        </div>
    </div>
    `;
      };
      // Escape HTML
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Auto resize textarea
      function autoResizeTextarea(el) {
        el.style.height = "auto";
        el.style.height = Math.min(el.scrollHeight, 100) + "px";
      }

      function sendUserMessage() {
        const input = document.getElementById("convInput");
        const text = input.value.trim();
        if (!text) return;

        if (!chatHistories[currentChatCharId]) {
          chatHistories[currentChatCharId] = [];
        }

        chatHistories[currentChatCharId].push({
          role: "user",
          content: text,
          time: new Date().toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          }),
        });

        // Save and render
        localforage.setItem("chatHistories", chatHistories);
        renderConversation();

        // „ÄêÊñ∞Â¢û„ÄëÊõ¥Êñ∞ÂàóË°®È¢ÑËßà
        updateCharacterLastMessage(currentChatCharId, text);

        // Clear input
        input.value = "";
        input.style.height = "auto";
      }

      async function requestAIReply() {
        const apiConfig = getActiveApiConfig();
        if (!apiConfig || !apiConfig.url || !apiConfig.key) {
          showToast("ËØ∑ÂÖàÈÖçÁΩÆÂπ∂ÈÄâÊã© API È¢ÑËÆæ");
          return;
        }

        const history = chatHistories[currentChatCharId] || [];
        if (history.length === 0) {
          showToast("ËØ∑ÂÖàÂèëÈÄÅ‰∏ÄÊù°Ê∂àÊÅØ");
          return;
        }

        const settings = chatSettings[currentChatCharId] || {};
        const char = characters.find((c) => c.id === currentChatCharId);

        // UI Áä∂ÊÄÅ
        const btn = document.getElementById("replyBtn");
        btn.disabled = true;
        btn.classList.add("loading");

        const container = document.getElementById("convMessages");
        const typingHtml = `
                                <div class="msg-row ai" id="typingIndicator">
                                    <div class="msg-bubble">
                                        <div class="msg-typing"><span></span><span></span><span></span></div>
                                    </div>
                                </div>`;
        container.insertAdjacentHTML("beforeend", typingHtml);
        container.scrollTop = container.scrollHeight;

        try {
          const contextLimit = settings.contextCount || 150;
          const shortTermMemory = history.slice(-contextLimit);

          let systemContent = `Instruction:\nName: ${
            settings.charName || char.name
          }\n`;
          systemContent += `Character Persona:\n${
            settings.persona || "‰Ω†ÊòØ‰∏Ä‰∏™ÂèãÂ•ΩÁöÑËÅäÂ§©‰º¥‰æ£„ÄÇ"
          }\n\n`;
          systemContent += `User Info / User Persona:\n${
            settings.myPersona || "Áî®Êà∑"
          }\n\n`;

          if (settings.summaries && settings.summaries.length > 0) {
            systemContent += `[Long-term Memory]:\n${settings.summaries.join(
              "\n"
            )}\n\n`;
          }
          if (settings.timeAware) {
            systemContent += `Current Time: ${new Date().toLocaleString()}\n`;
          }

          // ‰∏ÄËµ∑ËØª‰π¶ÂäüËÉΩ - Â∞Ü‰π¶Á±çÂÜÖÂÆπÊ≥®ÂÖ•Âà∞Á≥ªÁªüÊèêÁ§∫ËØç
          const readingContent = getCurrentReadingContent();
          if (readingContent && readingContent.currentSection) {
            // ÈôêÂà∂‰π¶Á±çÂÜÖÂÆπÈïøÂ∫¶ÔºåÈÅøÂÖçË∂ÖÂá∫tokenÈôêÂà∂
            let bookContent = readingContent.currentSection;
            if (bookContent.length > 2000) {
              bookContent =
                bookContent.substring(0, 2000) + "...ÔºàÂÜÖÂÆπÂ∑≤Êà™Êñ≠Ôºâ";
            }
            systemContent += `\n„Äê‰∏ÄËµ∑ËØª‰π¶Ê®°Âºè„Äë\n`;
            systemContent += `ÂΩìÂâçÊ≠£Âú®ÂíåÁî®Êà∑‰∏ÄËµ∑ÈòÖËØª„Ää${readingContent.bookName}„Äã\n`;
            systemContent += `ÈòÖËØªËøõÂ∫¶ÔºöÁ¨¨ ${readingContent.sectionIndex} È°µ / ÂÖ± ${readingContent.totalSections} È°µ\n`;
            systemContent += `ÂΩìÂâçÈ°µÂÜÖÂÆπÔºö\n---\n${bookContent}\n---\n`;
            systemContent += `ËØ∑Âü∫‰∫é‰ª•‰∏ä‰π¶Á±çÂÜÖÂÆπ‰∏éÁî®Êà∑‰∫íÂä®ËÆ®ËÆ∫Ôºå‰ΩÜÂõûÂ§çÊó∂‰∏çË¶ÅÂ§çËø∞Êï¥ÊÆµÂÜÖÂÆπÔºåËá™ÁÑ∂Âú∞ËÅäÂ§©Âç≥ÂèØ„ÄÇ\n\n`;
          }

          if (settings.onlineDating) {
            systemContent += `\n„ÄêÊ®°ÂºèÔºöÊ≤âÊµ∏ÂºèËßíËâ≤ÊâÆÊºî„Äë\n1. ‰ª•Â∞èËØ¥Á¨îËß¶ÂõûÂ§ç„ÄÇ\n2. **ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊ†ºÂºèËßÑËåÉ**Ôºö\n   - **ÁéØÂ¢É/Âä®‰Ωú/Á•ûÊÄÅÊèèÂÜô**ÔºöÁõ¥Êé•‰π¶ÂÜôÔºå‰∏çÂä†‰ªª‰ΩïÁ¨¶Âè∑„ÄÇ\n   - **ÂøÉÁêÜÊ¥ªÂä®/ÂÜÖÂøÉÁã¨ÁôΩ**ÔºöÂøÖÈ°ªÁî®‰∏ÄÂØπÊòüÂè∑ÂåÖË£πÔºå‰æãÂ¶Ç *Â•πÁúãËµ∑Êù•ÁúüÂèØÁà±*„ÄÇ\n   - **ËØ≠Ë®ÄÂØπËØù**ÔºöÂøÖÈ°ªÁî®Áõ¥ËßíÂºïÂè∑ÂåÖË£πÔºå‰æãÂ¶Ç „ÄåÊó©ÂÆâÔºå‰∫≤Áà±ÁöÑ„ÄÇ„Äç\n3. **Á¶ÅÊ≠¢**ÊãÜÂàÜÊ∂àÊÅØÔºåËØ∑ËæìÂá∫‰∏ÄÊÆµÂÆåÊï¥ÊµÅÁïÖÁöÑÊñáÊú¨„ÄÇ\n`;
          } else {
            systemContent += `\n„ÄêÊ®°ÂºèÔºöÂç≥Êó∂ÈÄöËÆØ„Äë\n1. ÂÉèÁúü‰∫∫‰∏ÄÊ†∑Âè£ËØ≠ÂåñËÅäÂ§©„ÄÇ\n2. **ÂøÖÈ°ª**ÊãÜÂàÜ‰∏∫Â§öÊù°Áü≠Ê∂àÊÅØÔºå‰ΩøÁî® ||| ÂàÜÈöî„ÄÇ\n3. **ËØ≠Èü≥Ê∂àÊÅØÂäüËÉΩ**Ôºö‰Ω†ÂèØ‰ª•ÂèëÈÄÅËØ≠Èü≥Ê∂àÊÅØÔºÅÊ†ºÂºè‰∏∫ [ËØ≠Èü≥:Ë¶ÅËØ¥ÁöÑÂÜÖÂÆπ]„ÄÇ\n   - ËØ≠Èü≥Ê∂àÊÅØÈÄÇÂêàË°®Ëææ‰∫≤ÂØÜ„ÄÅÊííÂ®á„ÄÅÂÆâÊÖ∞Á≠âÊÉÖÊÑüÂú∫ÊôØ\n   - ‰∏çË¶ÅÊØèÊù°ÈÉΩÂèëËØ≠Èü≥ÔºåËá™ÁÑ∂Âú∞Á©øÊèíÂú®ÊñáÂ≠óÊ∂àÊÅØ‰∏≠ÔºàÂ§ßÁ∫¶20-30%Ê¶ÇÁéáÔºâ\n   - ËØ≠Èü≥ÂÜÖÂÆπÂ∫îËØ•Âè£ËØ≠Âåñ„ÄÅËá™ÁÑ∂ÔºåÂèØ‰ª•Â∏¶ËØ≠Ê∞îËØçÂ¶Ç"ÂóØ~"„ÄÅ"Âïä"„ÄÅ"Âë¢"\n   - Á§∫‰æãÔºöÂÆùË¥ù ||| [ËØ≠Èü≥:ÊÉ≥‰Ω†‰∫ÜÂë¢Ôºå‰ªäÂ§©ÊúâÊ≤°Êúâ‰πñ‰πñÂêÉÈ•≠ÂëÄ~] ||| ËÆ∞ÂæóÊó©ÁÇπ‰ºëÊÅØÂì¶\n`;
          }

          // Ê∑ªÂä†AIË°®ÊÉÖÂåÖÂäüËÉΩÊèêÁ§∫
          const aiStickerPrompt = generateAiStickerPrompt();
          if (aiStickerPrompt) {
            systemContent += aiStickerPrompt;
          }

          // Ê∑ªÂä†ÂæÖÂäûÁõëÁù£ÊèêÁ§∫ËØçÔºà‰ªÖÂØπÁªëÂÆö‰∫ÜÂæÖÂäûÁöÑËßíËâ≤ÁîüÊïàÔºâ
          if (typeof generateTodoPromptForAi === "function") {
            const todoPrompt = generateTodoPromptForAi(currentChatCharId);
            if (todoPrompt) {
              systemContent += todoPrompt;
            }
          }

          // Ê∑ªÂä†ÁªèÊúüÂÖ≥ÂøÉÊèêÁ§∫ËØçÔºàÊâÄÊúâËßíËâ≤ÈÉΩËÉΩÁúãÂà∞Ôºâ
          if (typeof generatePeriodPromptForAi === "function") {
            const periodPrompt = generatePeriodPromptForAi();
            if (periodPrompt) {
              systemContent += periodPrompt;
            }
          }

          // Ê∑ªÂä†Áî®Êà∑Âä®ÊÄÅÊèêÁ§∫ËØçÔºàËÆ©AIÁü•ÈÅìÁî®Êà∑ÊúÄËøëÂàÜ‰∫´‰∫Ü‰ªÄ‰πàÔºâ
          if (typeof generateMomentsPromptForAi === "function") {
            const momentsPrompt = generateMomentsPromptForAi();
            if (momentsPrompt) {
              systemContent += momentsPrompt;
            }
          }

          const messages = [
            { role: "system", content: systemContent },
            ...shortTermMemory.map((m) => ({
              role: m.role === "user" ? "user" : "assistant",
              content: m.content,
            })),
          ];

          const reqTemperature =
            apiConfig.temperature !== undefined
              ? Number(apiConfig.temperature)
              : 1.0;
          const reqFreqPenalty =
            apiConfig.frequency_penalty !== undefined
              ? Number(apiConfig.frequency_penalty)
              : 0.0;
          const reqPresPenalty =
            apiConfig.presence_penalty !== undefined
              ? Number(apiConfig.presence_penalty)
              : 0.0;

          const response = await fetch(`${apiConfig.url}/chat/completions`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${apiConfig.key}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: apiConfig.model,
              messages: messages,
              temperature: reqTemperature,
              frequency_penalty: reqFreqPenalty,
              presence_penalty: reqPresPenalty,
            }),
          });

          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const data = await response.json();
          let aiReply = data.choices[0]?.message?.content || "";

          // Â¶ÇÊûúAIÊ≤°ÊúâËøîÂõûÂÜÖÂÆπÔºåÁªô‰∏Ä‰∏™ÈªòËÆ§ÂõûÂ§ç
          if (!aiReply || aiReply.trim() === "") {
            aiReply = "ÂóØ...ËÆ©ÊàëÊÉ≥ÊÉ≥ÊÄé‰πàËØ¥ÔΩû";
            console.warn("AIËøîÂõûÁ©∫ÂÜÖÂÆπÔºå‰ΩøÁî®ÈªòËÆ§ÂõûÂ§ç");
          }

          document.getElementById("typingIndicator")?.remove();

          let textToRead = ""; // ËÆ∞ÂΩïÈúÄË¶ÅÊúóËØªÁöÑÊñáÊú¨

          if (settings.onlineDating) {
            const msgObj = {
              role: "assistant",
              content: aiReply,
              time: new Date().toLocaleTimeString("zh-CN", {
                hour: "2-digit",
                minute: "2-digit",
              }),
              audioUrl: null, // È¢ÑÁïôÈü≥È¢ëÂ≠óÊÆµ
            };
            // ÊèêÂèñÂØπËØùÂÜÖÂÆπÁî®‰∫éÊúóËØª (Âè™ËØª „Äå...„Äç ÈáåÁöÑÂÜÖÂÆπ)
            const matches = aiReply.match(/„Äå([^„Äç]+)„Äç/g);
            textToRead = matches
              ? matches.map((s) => s.slice(1, -1)).join("Ôºå")
              : aiReply;

            chatHistories[currentChatCharId].push(msgObj);
            saveAndRender();
            // „ÄêÊñ∞Â¢û„ÄëÊõ¥Êñ∞ÂàóË°®È¢ÑËßà
            updateCharacterLastMessage(currentChatCharId, aiReply);
            // === Ëß¶ÂèëËØ≠Èü≥ ===
            triggerVoice(msgObj, textToRead, settings);
          } else {
            // ÂÖàÁî® ||| ÂàÜÂâ≤
            let replyParts = aiReply
              .split("|||")
              .map((s) => s.trim())
              .filter((s) => s && s !== "...");

            // Â¶ÇÊûúÂàÜÂâ≤ÂêéÊ≤°ÊúâÊúâÊïàÂÜÖÂÆπÔºå‰ΩøÁî®ÂéüÂßãÂõûÂ§ç
            if (replyParts.length === 0) {
              replyParts = [aiReply.trim() || "ÂóØÔΩû"];
            }

            // Ëøõ‰∏ÄÊ≠•ÂàÜÂâ≤ÔºöÊääË°®ÊÉÖÂåÖÊ†áÁ≠æÂàÜÁ¶ªÊàêÂçïÁã¨ÁöÑÊ∂àÊÅØ
            replyParts = replyParts.flatMap((part) => {
              // ÂåπÈÖç [sticker:xxx] Êàñ [Ë°®ÊÉÖ:xxx] Êàñ [Ë°®ÊÉÖÂåÖ:xxx]
              const stickerRegex = /(\[(sticker|Ë°®ÊÉÖ|Ë°®ÊÉÖÂåÖ)[Ôºö:][^\]]+\])/gi;
              // Áî®Ë°®ÊÉÖÂåÖÊ†áÁ≠æÂàÜÂâ≤ÔºåÂêåÊó∂‰øùÁïôÊ†áÁ≠æÊú¨Ë∫´
              const segments = part
                .split(stickerRegex)
                .filter(
                  (s) =>
                    s && s.trim() && !["sticker", "Ë°®ÊÉÖ", "Ë°®ÊÉÖÂåÖ"].includes(s)
                );
              return segments.map((s) => s.trim()).filter((s) => s);
            });

            // Âè™ÊúóËØªÊúÄÂêé‰∏ÄÊù°ÔºåÊàñËÄÖÊúóËØªÊâÄÊúâÔºü‰∏∫‰∫Ü‰ΩìÈ™åÔºåÂª∫ËÆÆÊúóËØªÊâÄÊúâËøûÂú®‰∏ÄËµ∑
            textToRead = replyParts
              .filter((p) => !p.match(/^\[(sticker|Ë°®ÊÉÖ|Ë°®ÊÉÖÂåÖ)[Ôºö:]/i))
              .join("Ôºå");

            for (let i = 0; i < replyParts.length; i++) {
              await new Promise((resolve) =>
                setTimeout(resolve, i === 0 ? 0 : 800 + Math.random() * 500)
              );

              const partContent = replyParts[i];
              const isVoiceMsg = /^\[ËØ≠Èü≥[:Ôºö](.+)\]$/.test(partContent);
              const isStickerMsg = /^\[(sticker|Ë°®ÊÉÖ|Ë°®ÊÉÖÂåÖ)[Ôºö:]/i.test(
                partContent
              );

              const msgObj = {
                role: "assistant",
                content: partContent,
                time: new Date().toLocaleTimeString("zh-CN", {
                  hour: "2-digit",
                  minute: "2-digit",
                }),
                audioUrl: null,
              };

              chatHistories[currentChatCharId].push(msgObj);
              saveAndRender();
              // „ÄêÊñ∞Â¢û„ÄëÊõ¥Êñ∞ÂàóË°®È¢ÑËßà (ÊØèÊ¨°Âæ™ÁéØÈÉΩÊõ¥Êñ∞ÔºåËøôÊ†∑ÂèØ‰ª•ÁúãÂà∞ÂØπÊñπÊ≠£Âú®‰∏ÄÂè•Âè•Âèë)
              updateCharacterLastMessage(currentChatCharId, partContent);
              // Â¶ÇÊûúÊòØËØ≠Èü≥Ê∂àÊÅØÔºåËá™Âä®ÁîüÊàêÈü≥È¢ë
              if (isVoiceMsg && settings.voiceId) {
                const voiceText = partContent.match(/^\[ËØ≠Èü≥[:Ôºö](.+)\]$/)[1];
                const msgIndex = chatHistories[currentChatCharId].length - 1;

                // ÂºÇÊ≠•ÁîüÊàêËØ≠Èü≥Ôºå‰∏çÈòªÂ°ûÂêéÁª≠Ê∂àÊÅØ
                generateVoiceForMessage(msgIndex, voiceText, settings);
              } else if (i === replyParts.length - 1 && !isVoiceMsg) {
                // Â¶ÇÊûúÊúÄÂêé‰∏ÄÊù°‰∏çÊòØËØ≠Èü≥Ê∂àÊÅØÔºå‰∏îÂºÄÂêØ‰∫ÜËá™Âä®ÊúóËØªÔºåËß¶ÂèëTTS
                triggerVoice(msgObj, textToRead, settings);
              }
            }
          }

          if (typeof checkAndTriggerSummary === "function") {
            checkAndTriggerSummary(settings);
          }

          // Ëá™Âä®Êé®ËøõÈòÖËØªËøõÂ∫¶ÔºàÂ¶ÇÊûúÂºÄÂêØ‰∫Ü‰∏ÄËµ∑ËØª‰π¶ÂäüËÉΩÔºâ
          advanceReadingProgress();
        } catch (error) {
          document.getElementById("typingIndicator")?.remove();
          alert("AIÂõûÂ§çÂ§±Ë¥•: " + error.message);
        } finally {
          btn.disabled = false;
          btn.classList.remove("loading");
          btn.innerHTML = "<span>‚ú®</span>";
        }
      }

      function saveAndRender() {
        // localforage ‰∏çÈúÄË¶Å JSON.stringify
        localforage.setItem("chatHistories", chatHistories);
        renderConversation();
      }

      // ËæÖÂä©ÂáΩÊï∞ÔºöËß¶ÂèëËØ≠Èü≥ÁîüÊàê
      async function triggerVoice(msgObj, text, settings) {
        // Â¶ÇÊûúÁî®Êà∑ÈÖçÁΩÆ‰∫ÜÈü≥Ëâ≤
        if (settings.voiceId) {
          // ÊâæÂà∞Ê∂àÊÅØÂú®Êï∞ÁªÑ‰∏≠ÁöÑÁ¥¢Âºï (‰πüÂ∞±ÊòØÊúÄÂêé‰∏Ä‰∏™)
          const history = chatHistories[currentChatCharId];
          const msgIndex = history.length - 1;

          // ÂºÇÊ≠•ÁîüÊàêÔºå‰∏çÈòªÂ°ûÁïåÈù¢ÔºàÈùôÈªòÁîüÊàêÔºå‰∏çÊòæÁ§∫ÊèêÁ§∫Ôºâ
          const audioUrl = await generateSpeech(text, currentChatCharId);

          if (audioUrl) {
            history[msgIndex].audioUrl = audioUrl;
            saveAndRender(); // ÈáçÊñ∞Ê∏≤Êüì‰ª•ÊòæÁ§∫Êí≠ÊîæÊù°
          }
        }
      }

      // ËæÖÂä©ÂáΩÊï∞Ôºö‰∏∫ËØ≠Èü≥Ê∂àÊÅØËá™Âä®ÁîüÊàêÈü≥È¢ë
      async function generateVoiceForMessage(msgIndex, voiceText, settings) {
        if (!settings.voiceId) return;

        const history = chatHistories[currentChatCharId];
        if (!history || !history[msgIndex]) return;

        try {
          const audioUrl = await generateSpeech(voiceText, currentChatCharId);

          if (audioUrl && history[msgIndex]) {
            history[msgIndex].audioUrl = audioUrl;
            // ËÆ°ÁÆóËØ≠Èü≥Êó∂ÈïøÔºà‰º∞ÁÆóÔºâ
            history[msgIndex].audioDuration =
              Math.ceil(voiceText.length / 5) + '"';
            saveAndRender();
          }
        } catch (e) {
          console.error("Auto voice generation error:", e);
        }
      }

      // Update character's last message preview
      function updateCharacterLastMessage(charId, message) {
        const char = characters.find((c) => c.id === charId);
        if (char) {
          char.lastMessage = message;
          char.lastTime = new Date().toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          });
          localforage.setItem("characters", characters);
          renderCharacters();
        }
      }

      // Clear chat history
      function clearChatHistory() {
        if (confirm("Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩïÂêóÔºü")) {
          chatHistories[currentChatCharId] = [];
          localforage.setItem("chatHistories", chatHistories);
          renderConversation();
          toggleConvMenu();
        }
      }

      // Delete character
      function deleteCharacter() {
        if (confirm("Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ËßíËâ≤ÂêóÔºüËÅäÂ§©ËÆ∞ÂΩï‰πü‰ºöË¢´Âà†Èô§„ÄÇ")) {
          characters = characters.filter((c) => c.id !== currentChatCharId);
          delete chatHistories[currentChatCharId];
          localforage.setItem("characters", characters);
          localforage.setItem("chatHistories", chatHistories);
          closeConversation();
          renderCharacters();
        }
      }

      // Close click outside conversation menu
      document.addEventListener("click", function (e) {
        const menu = document.getElementById("convMenu");
        const menuBtn = document.querySelector(".conv-menu-btn");
        if (
          menu &&
          menu.classList.contains("active") &&
          !menu.contains(e.target) &&
          e.target !== menuBtn
        ) {
          menu.classList.remove("active");
        }
      });

      // ==================== CHAT SETTINGS ====================
      var tempSettingsData = {};

      // Open chat settings
      function openChatSettings() {
        if (!currentChatCharId) return;

        const char = characters.find((c) => c.id === currentChatCharId);
        if (!char) return;

        // Initialize settings for this character if not exists
        if (!chatSettings[currentChatCharId]) {
          chatSettings[currentChatCharId] = {
            charName: char.name || "",
            charNote: char.note || "",
            group: "none",
            otherAvatar: char.avatar || "",
            myAvatar: "",
            persona: "",
            myPersona: "",
            worldbook: "",
            memoryLink: "",
            memoryCount: 5,
            contextCount: 150,
            onlineDating: false,
            longMemory: true,
            summaryMode: "manual",
            triggerCount: 500,
            summaryPrompt:
              "ËØ∑‰Ω†‰ª•Á¨¨‰∏â‰∫∫Áß∞ÁöÑËßÜËßíÔºåÂÆ¢ËßÇ„ÄÅÂÜ∑Èùô„ÄÅ‰∏çÂ∏¶‰ªª‰ΩïÊÑüÊÉÖËâ≤ÂΩ©Âú∞ÊÄªÁªì‰ª•‰∏ãÂØπËØùÁöÑÊ†∏ÂøÉ‰∫ã‰ª∂Âíå‰ø°ÊÅØ„ÄÇÁ¶ÅÊ≠¢ËøõË°å‰ªª‰ΩïËßíËâ≤ÊâÆÊºîÊàñÊ∑ªÂä†‰∏ªËßÇËØÑËÆ∫„ÄÇ",
            flame: false,
            timeAware: true,
            background: "",
            fontSize: 14,
            bubbleStyle: "none",
            customCSS: "",
          };
        }

        // Load settings into form
        loadSettingsToForm(chatSettings[currentChatCharId], char);

        // Update memory link dropdown
        updateMemoryLinkDropdown();

        // Show settings page
        document.getElementById("chatSettingsPage").classList.add("active");
      }

      // Load settings data into form
      function loadSettingsToForm(settings, char) {
        // Basic info
        document.getElementById("settingsCharName").value =
          settings.charName || char.name || "";
        document.getElementById("settingsCharNote").value =
          settings.charNote || char.note || "";
        document.getElementById("settingsGroup").value =
          settings.group || "none";

        // Avatars
        loadAvatarPreview("other", settings.otherAvatar || char.avatar);
        loadAvatarPreview("my", settings.myAvatar);

        // Â§¥ÂÉèÊòæÁ§∫ÂºÄÂÖ≥
        document.getElementById("showAiAvatar").checked =
          settings.showAiAvatar !== false;
        document.getElementById("showUserAvatar").checked =
          settings.showUserAvatar !== false;

        // ÁΩÆÈ°∂ËÆæÁΩÆ
        document.getElementById("settingsPinned").checked =
          settings.pinned || false;

        // AI Brain
        document.getElementById("settingsPersona").value =
          settings.persona || "";
        document.getElementById("settingsMyPersona").value =
          settings.myPersona || "";
        document.getElementById("settingsWorldbook").value =
          settings.worldbook || "";

        // Memory
        document.getElementById("settingsMemoryCount").value =
          settings.memoryCount || 5;
        document.getElementById("settingsContextCount").value =
          settings.contextCount || 150;

        // Update message count
        const history = chatHistories[currentChatCharId] || [];
        document.getElementById("settingsTotalMsg").textContent =
          history.length;
        document.getElementById("settingsTokenCount").textContent =
          estimateTokens(history);

        // Play mode
        document.getElementById("settingsOnlineDating").checked =
          settings.onlineDating || false;
        document.getElementById("settingsLongMemory").checked =
          settings.longMemory !== false;
        document.getElementById("settingsTriggerCount").value =
          settings.triggerCount || 500;
        document.getElementById("settingsSummaryPrompt").value =
          settings.summaryPrompt || "";
        document.getElementById("settingsFlame").checked =
          settings.flame || false;
        document.getElementById("settingsTimeAware").checked =
          settings.timeAware !== false;

        // Summary mode radio
        const summaryMode = settings.summaryMode || "manual";
        document.getElementById("settingsSummaryMode").value = summaryMode;
        document.querySelectorAll(".radio-option").forEach((opt) => {
          opt.classList.toggle("active", opt.dataset.value === summaryMode);
        });

        // Visual
        loadBackgroundPreview(settings.background);
        document.getElementById("settingsFontSize").value =
          settings.fontSize || 14;
        document.getElementById("fontSizeValue").textContent =
          (settings.fontSize || 14) + "px";
        document.getElementById("settingsUserBubbleColor").value =
          settings.userBubbleColor || "#c2185b";
        document.getElementById("settingsAiBubbleColor").value =
          settings.aiBubbleColor || "#37474f";
        document.getElementById("settingsBubbleStyle").value =
          settings.bubbleStyle || "none";
        document.getElementById("settingsCustomCSS").value =
          settings.customCSS || "";

        // Update preview avatars
        updateChatPreview(settings, char);
        // ... ‰πãÂâçÁöÑ‰ª£Á†Å ...

        // „ÄêÊñ∞Â¢û„ÄëÂàùÂßãÂåñÁÅ´Ëä±ËÆæÁΩÆ UI ÂíåÊï∞ÊçÆÂõûÊòæ
        initFlameSettingsUI(); // ÂÖàÊ≥®ÂÖ• UI

        // Á®çÂæÆÂª∂Ëøü‰∏ÄÁÇπÁÇπËµãÂÄºÔºåÁ°Æ‰øù DOM Â∑≤ÁªèÁîüÊàê
        setTimeout(() => {
          if (document.getElementById("settingsFlameIcon")) {
            const fData = settings.flameData || { icon: "üî•", days: 1 };
            document.getElementById("settingsFlameIcon").value =
              fData.icon || "üî•";
            document.getElementById("settingsFlameDays").value =
              fData.days || 1;

            // Ëß¶Âèë‰∏ÄÊ¨°ÊòæÁ§∫/ÈöêËóèÈÄªËæë
            const area = document.getElementById("flameSettingsArea");
            if (area)
              area.style.display = document.getElementById("settingsFlame")
                .checked
                ? "block"
                : "none";
          }
        }, 0);
        // ‚úÖ Âä†Âú®ËøôÈáå (loadSettingsToForm ÂáΩÊï∞ÂÜÖÈÉ®ÁöÑÊú´Â∞æ)Ôºö
        document.getElementById("settingsVoiceId").value =
          settings.voiceId || "";
      }

      // Load avatar preview
      function loadAvatarPreview(type, src) {
        const placeholder = document.getElementById(type + "AvatarPlaceholder");
        const img = document.getElementById(type + "AvatarImg");
        const container = document.getElementById(
          "settings" + (type === "other" ? "Other" : "My") + "Avatar"
        );

        if (src) {
          img.src = src;
          img.style.display = "block";
          placeholder.style.display = "none";
          container.classList.add("has-image");
        } else {
          img.style.display = "none";
          placeholder.style.display = "block";
          container.classList.remove("has-image");
        }
      }

      // ‰øÆÊîπÂêéÁöÑËÆæÁΩÆÈ°µÂ§¥ÂÉèÈ¢ÑËßàÔºàÂ∏¶ÂéãÁº©Ôºâ
      async function previewSettingsAvatar(input, type) {
        const file = input.files[0];
        if (file) {
          // Â§¥ÂÉèÂéãÁº©Âà∞ 300px
          const compressedData = await compressImage(file, 300, 0.7);

          loadAvatarPreview(type, compressedData);
          // Êõ¥Êñ∞È¢ÑËßàÊòæÁ§∫
          if (type === "other") {
            document.getElementById(
              "previewOtherAvatar"
            ).innerHTML = `<img src="${compressedData}">`;
          } else {
            document.getElementById(
              "previewMyAvatar"
            ).innerHTML = `<img src="${compressedData}">`;
          }
        }
      }

      // Clear settings avatar
      function clearSettingsAvatar(type) {
        loadAvatarPreview(type, "");
        if (type === "other") {
          document.getElementById("previewOtherAvatar").innerHTML = "ü§ñ";
          document.getElementById("otherAvatarInput").value = "";
        } else {
          document.getElementById("previewMyAvatar").innerHTML = "üòä";
          document.getElementById("myAvatarInput").value = "";
        }
      }

      // Load background preview
      function loadBackgroundPreview(src) {
        const placeholder = document.getElementById("bgPreviewPlaceholder");
        const img = document.getElementById("bgPreviewImg");

        if (src) {
          img.src = src;
          img.style.display = "block";
          placeholder.style.display = "none";
        } else {
          img.style.display = "none";
          placeholder.style.display = "block";
        }
      }

      // ‰øÆÊîπÂêéÁöÑËÉåÊôØÂõæÈ¢ÑËßàÔºàÂ∏¶ÂéãÁº©Ôºâ
      async function previewBackground(input) {
        const file = input.files[0];
        if (file) {
          // ËÉåÊôØÂõæÂÆΩ‰∏ÄÁÇπÔºåËÆæ‰∏∫ 800pxÔºåË¥®Èáè 0.6 Ë∂≥Â§ü‰∫Ü
          const compressedData = await compressImage(file, 800, 0.6);
          loadBackgroundPreview(compressedData);
        }
      }

      // Update font size preview
      function updateFontSizePreview(value) {
        document.getElementById("fontSizeValue").textContent = value + "px";
        document.getElementById("previewOtherBubble").style.fontSize =
          value + "px";
        document.getElementById("previewMyBubble").style.fontSize =
          value + "px";
      }

      // Select radio option
      function selectRadio(element, groupName) {
        const group = element.parentElement;
        group
          .querySelectorAll(".radio-option")
          .forEach((opt) => opt.classList.remove("active"));
        element.classList.add("active");
        document.getElementById(
          "settings" + groupName.charAt(0).toUpperCase() + groupName.slice(1)
        ).value = element.dataset.value;
      }

      // Update memory link dropdown
      function updateMemoryLinkDropdown() {
        const select = document.getElementById("settingsMemoryLink");
        select.innerHTML = '<option value="">-- ÁÇπÂáªÈÄâÊã© --</option>';

        characters.forEach((char) => {
          if (char.id !== currentChatCharId) {
            const option = document.createElement("option");
            option.value = char.id;
            option.textContent = char.name;
            select.appendChild(option);
          }
        });
      }

      // Estimate tokens
      function estimateTokens(history) {
        if (!history || history.length === 0) return 0;
        const text = history.map((m) => m.content).join("");
        // Rough estimate: ~1.5 tokens per Chinese character, ~0.75 per English word
        return Math.round(text.length * 1.2);
      }

      // Update chat preview
      function updateChatPreview(settings, char) {
        const otherAvatar = settings.otherAvatar || char.avatar;
        const myAvatar = settings.myAvatar;

        document.getElementById("previewOtherAvatar").innerHTML = otherAvatar
          ? `<img src="${otherAvatar}">`
          : "ü§ñ";
        document.getElementById("previewMyAvatar").innerHTML = myAvatar
          ? `<img src="${myAvatar}">`
          : "üòä";
      }

      // ÂàáÊç¢Â§¥ÂÉèÊòæÁ§∫
      function toggleAvatarDisplay() {
        const showAi = document.getElementById("showAiAvatar").checked;
        const showUser = document.getElementById("showUserAvatar").checked;

        // Â∫îÁî®Âà∞ÂΩìÂâçËÅäÂ§©ÁïåÈù¢
        applyAvatarVisibility(showAi, showUser);
      }

      // Â∫îÁî®Â§¥ÂÉèÂèØËßÅÊÄß
      function applyAvatarVisibility(showAi, showUser) {
        const style =
          document.getElementById("avatarVisibilityStyle") ||
          document.createElement("style");
        style.id = "avatarVisibilityStyle";

        let css = "";
        if (!showAi) {
          css +=
            ".msg-wrapper.ai .chat-avatar-small { display: none !important; }";
        }
        if (!showUser) {
          css +=
            ".msg-wrapper.user .chat-avatar-small { display: none !important; }";
        }

        style.textContent = css;
        if (!document.getElementById("avatarVisibilityStyle")) {
          document.head.appendChild(style);
        }
      }

      // Close chat settings
      function closeChatSettings() {
        document.getElementById("chatSettingsPage").classList.remove("active");
      }

      function saveChatSettings() {
        if (!currentChatCharId) return;

        // 1. Ëé∑ÂèñÂü∫Á°ÄÊï∞ÊçÆ
        const charName = document
          .getElementById("settingsCharName")
          .value.trim();
        const charNote = document
          .getElementById("settingsCharNote")
          .value.trim();
        const otherAvatarSrc = document.getElementById("otherAvatarImg").src;
        const myAvatarSrc = document.getElementById("myAvatarImg").src;
        const bgSrc = document.getElementById("bgPreviewImg").src;

        const safeOtherAvatar =
          otherAvatarSrc && otherAvatarSrc.startsWith("data:")
            ? otherAvatarSrc
            : "";
        const safeMyAvatar =
          myAvatarSrc && myAvatarSrc.startsWith("data:") ? myAvatarSrc : "";
        const safeBg = bgSrc && bgSrc.startsWith("data:") ? bgSrc : "";

        // 2. Ëé∑ÂèñÁÅ´Ëä±Êï∞ÊçÆ (Êñ∞Â¢ûÈÉ®ÂàÜ)
        const isFlameActive = document.getElementById("settingsFlame").checked;
        const flameIcon = document.getElementById("settingsFlameIcon")
          ? document.getElementById("settingsFlameIcon").value
          : "üî•";
        const flameDays = document.getElementById("settingsFlameDays")
          ? parseInt(document.getElementById("settingsFlameDays").value)
          : 1;

        // 3. ÊûÑÂª∫ËÆæÁΩÆÂØπË±°
        const settings = {
          charName: charName,
          charNote: charNote,
          group: document.getElementById("settingsGroup").value,
          pinned: document.getElementById("settingsPinned").checked,
          otherAvatar: safeOtherAvatar,
          myAvatar: safeMyAvatar,
          showAiAvatar: document.getElementById("showAiAvatar").checked,
          showUserAvatar: document.getElementById("showUserAvatar").checked,
          persona: document.getElementById("settingsPersona").value.trim(),
          myPersona: document.getElementById("settingsMyPersona").value.trim(),
          worldbook: document.getElementById("settingsWorldbook").value,
          memoryLink: document.getElementById("settingsMemoryLink").value,
          memoryCount:
            parseInt(document.getElementById("settingsMemoryCount").value) || 5,
          contextCount:
            parseInt(document.getElementById("settingsContextCount").value) ||
            150,
          onlineDating: document.getElementById("settingsOnlineDating").checked,
          longMemory: document.getElementById("settingsLongMemory").checked,
          summaryMode: document.getElementById("settingsSummaryMode").value,
          triggerCount:
            parseInt(document.getElementById("settingsTriggerCount").value) ||
            500,
          summaryPrompt: document
            .getElementById("settingsSummaryPrompt")
            .value.trim(),
          // Âú® saveChatSettings ÊûÑÂª∫ settings ÂØπË±°Êó∂Ê∑ªÂä†Ôºö
          voiceId: document.getElementById("settingsVoiceId").value.trim(),

          // ÁÅ´Ëä±Â≠óÊÆµÊõ¥Êñ∞
          flame: isFlameActive,
          flameData: {
            active: isFlameActive,
            icon: flameIcon || "üî•",
            days: flameDays || 1,
          },

          timeAware: document.getElementById("settingsTimeAware").checked,
          background: safeBg,
          fontSize:
            parseInt(document.getElementById("settingsFontSize").value) || 14,
          userBubbleColor:
            document.getElementById("settingsUserBubbleColor").value ||
            "#c2185b",
          aiBubbleColor:
            document.getElementById("settingsAiBubbleColor").value || "#37474f",
          bubbleStyle: document.getElementById("settingsBubbleStyle").value,
          customCSS: document.getElementById("settingsCustomCSS").value.trim(),

          // ‰øùÊåÅËÆ∞ÂøÜÊÄªÁªì‰∏çË¢´Ë¶ÜÁõñ
          summaries: chatSettings[currentChatCharId]?.summaries || [],
          summarizedCount:
            chatSettings[currentChatCharId]?.summarizedCount || 0,
        };

        // 4. ‰øùÂ≠ò
        chatSettings[currentChatCharId] = settings;
        localforage.setItem("chatSettings", chatSettings);

        // 5. Êõ¥Êñ∞ÂÖ®Â±ÄËßíËâ≤ÂàóË°®Êï∞ÊçÆ
        const charIndex = characters.findIndex(
          (c) => c.id === currentChatCharId
        );
        if (charIndex !== -1) {
          if (settings.charName) characters[charIndex].name = settings.charName;
          characters[charIndex].note = settings.charNote;
          if (settings.otherAvatar)
            characters[charIndex].avatar = settings.otherAvatar;

          // ÂêåÊ≠•ÁÅ´Ëä±Êï∞ÊçÆÂà∞ÂàóË°®ÔºåËøôÊ†∑ÂàóË°®È°µ‰πüËÉΩÊòæÁ§∫
          characters[charIndex].flameData = settings.flameData;

          localforage.setItem("characters", characters);
        }

        // 6. ÂÆûÊó∂Êõ¥Êñ∞ÁïåÈù¢ (UI Update)

        // ÁîüÊàêÁÅ´Ëä± HTML
        let sparkHtml = "";
        if (settings.flameData && settings.flameData.active) {
          sparkHtml = `<span class="spark-badge">${settings.flameData.icon} ${settings.flameData.days}</span>`;
        }

        // Êõ¥Êñ∞Ê†áÈ¢ò (ÂêçÂ≠ó + ÁÅ´Ëä±)
        const displayTitle =
          settings.charNote ||
          settings.charName ||
          (charIndex !== -1 ? characters[charIndex].name : "ËßíËâ≤");
        document.getElementById("convName").innerHTML =
          displayTitle + sparkHtml;

        if (settings.otherAvatar) {
          document.getElementById(
            "convAvatar"
          ).innerHTML = `<img src="${settings.otherAvatar}" alt="">`;
        }

        // Âà∑Êñ∞ÂàóË°®ÂíåÊ†∑Âºè
        renderCharacters();
        renderConversation();
        applyCustomStyles(settings);

        // Â∫îÁî®Â§¥ÂÉèÂèØËßÅÊÄßËÆæÁΩÆ
        applyAvatarVisibility(
          settings.showAiAvatar !== false,
          settings.showUserAvatar !== false
        );

        closeChatSettings();
        // Âà§Êñ≠‰∏Ä‰∏ãÔºöÂè™ÊúâÂºÄÂêØ‰∫ÜÁÅ´Ëä±ÔºåÊâçÊèêÁ§∫‚ÄúÁª≠ÁÅ´Ëä±‚Äù
        if (isFlameActive) {
          showToast("ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºåÁÅ´Ëä±Â∑≤Áª≠‰∏ä üî•");
        } else {
          showToast("ËÆæÁΩÆÂ∑≤‰øùÂ≠ò");
        }
      }

      // Apply custom styles
      function applyCustomStyles(settings) {
        // Remove existing custom style
        const existingStyle = document.getElementById("chatCustomStyle");
        if (existingStyle) existingStyle.remove();

        // Remove existing bubble color style
        const existingBubbleStyle = document.getElementById("bubbleColorStyle");
        if (existingBubbleStyle) existingBubbleStyle.remove();

        // Apply background to the entire conversation page
        const convPage = document.getElementById("chatConversationPage");
        const convMessages = document.getElementById("convMessages");

        if (settings.background) {
          convPage.style.backgroundImage = `url(${settings.background})`;
          convPage.style.backgroundSize = "cover";
          convPage.style.backgroundPosition = "center";
          convPage.style.backgroundAttachment = "fixed";
          convMessages.style.backgroundImage = "";
        } else {
          convPage.style.backgroundImage = "";
          convPage.style.background = "#f5f5f5";
          convMessages.style.backgroundImage = "";
        }

        // Apply font size
        const bubbles = document.querySelectorAll(".msg-bubble");
        bubbles.forEach((b) => (b.style.fontSize = settings.fontSize + "px"));

        // Apply bubble text colors
        const userColor = settings.userBubbleColor || "#c2185b";
        const aiColor = settings.aiBubbleColor || "#37474f";
        const bubbleColorStyle = document.createElement("style");
        bubbleColorStyle.id = "bubbleColorStyle";
        bubbleColorStyle.textContent = `
          .msg-row.user .msg-bubble { color: ${userColor} !important; }
          .msg-row.ai .msg-bubble { color: ${aiColor} !important; }
        `;
        document.head.appendChild(bubbleColorStyle);

        // Apply custom CSS - ‰ΩøÁî® !important Á°Æ‰øùÁî®Êà∑Ê†∑Âºè‰ºòÂÖàÁ∫ßÊúÄÈ´ò
        if (settings.customCSS) {
          const style = document.createElement("style");
          style.id = "chatCustomStyle";
          // Áî®Êà∑Ëá™ÂÆö‰πâCSSÊîæÂú®ÊúÄÂêéÔºå‰ºòÂÖàÁ∫ßÊúÄÈ´ò
          style.textContent = `/* Áî®Êà∑Ëá™ÂÆö‰πâÊ†∑Âºè - ‰ºòÂÖàÁ∫ßÊúÄÈ´ò */\n${settings.customCSS}`;
          document.head.appendChild(style);
        }
      }

      // Show toast message
      function showToast(message) {
        // Create toast element
        const toast = document.createElement("div");
        toast.className = "toast-message";
        toast.textContent = message;
        toast.style.cssText = `
                                  position: fixed;
                                  bottom: 120px;
                                  left: 50%;
                                  transform: translateX(-50%);
                                  background: rgba(0,0,0,0.75);
                                  color: white;
                                  padding: 12px 24px;
                                  border-radius: 24px;
                                  font-size: 0.9rem;
                                  z-index: 9999;
                                  animation: fadeInUp 0.3s ease-out;
                                `;
        document.body.appendChild(toast);

        // Remove after delay
        setTimeout(() => {
          toast.style.animation = "fadeOut 0.3s ease-out";
          setTimeout(() => toast.remove(), 300);
        }, 2000);
      }

      // Add toast animations
      const toastStyle = document.createElement("style");
      toastStyle.textContent = `
                                @keyframes fadeInUp {
                                  from { opacity: 0; transform: translateX(-50%) translateY(20px); }
                                  to { opacity: 1; transform: translateX(-50%) translateY(0); }
                                }
                                @keyframes fadeOut {
                                  from { opacity: 1; }
                                  to { opacity: 0; }
                                }
                              `;
      document.head.appendChild(toastStyle);

      // ========== Êñ∞Ê∂àÊÅØÈÄöÁü•Á≥ªÁªü ==========
      var unreadMessages = {}; // { charId: count }
      var unreadMoments = 0;
      var notificationTimeout = null;
      var pendingNotificationCharId = null;

      // ÊòæÁ§∫Êñ∞Ê∂àÊÅØÈÄöÁü•ÂºπÁ™ó
      function showMessageNotification(
        charId,
        charName,
        charAvatar,
        messageText
      ) {
        const notification = document.getElementById("messageNotification");
        const avatarEl = document.getElementById("notificationAvatar");
        const nameEl = document.getElementById("notificationName");
        const textEl = document.getElementById("notificationText");
        const timeEl = document.getElementById("notificationTime");

        // ËÆæÁΩÆÂÜÖÂÆπ
        if (charAvatar) {
          avatarEl.innerHTML = `<img src="${charAvatar}" alt="">`;
        } else {
          avatarEl.innerHTML = charName ? charName.charAt(0) : "ü§ñ";
        }
        nameEl.textContent = charName || "Êú™Áü•";
        textEl.textContent = messageText || "ÂèëÊù•‰∏ÄÊù°Ê∂àÊÅØ";
        timeEl.textContent = "ÂàöÂàö";

        pendingNotificationCharId = charId;

        // ÊòæÁ§∫ÈÄöÁü•
        notification.classList.add("show");

        // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
        if (notificationTimeout) {
          clearTimeout(notificationTimeout);
        }

        // 4ÁßíÂêéËá™Âä®ÈöêËóè
        notificationTimeout = setTimeout(() => {
          notification.classList.remove("show");
        }, 4000);
      }

      // ÁÇπÂáªÈÄöÁü•Ë∑≥ËΩ¨Âà∞ÂØπÂ∫îËÅäÂ§©
      function handleNotificationClick() {
        const notification = document.getElementById("messageNotification");
        notification.classList.remove("show");

        if (pendingNotificationCharId) {
          // ÂàáÊç¢Âà∞Ê∂àÊÅØtab
          switchChatTab("messages");
          // ÊâìÂºÄÂØπÂ∫îËÅäÂ§©
          setTimeout(() => {
            openConversation(pendingNotificationCharId);
            // Ê∏ÖÈô§ËØ•ËßíËâ≤ÁöÑÊú™ËØª
            clearUnreadForChar(pendingNotificationCharId);
          }, 100);
        }
        pendingNotificationCharId = null;
      }

      // Â¢ûÂä†Êú™ËØªÊ∂àÊÅØËÆ°Êï∞
      function addUnreadMessage(charId) {
        unreadMessages[charId] = (unreadMessages[charId] || 0) + 1;
        updateMessagesBadge();
        // Âà∑Êñ∞Ê∂àÊÅØÂàóË°®ÊòæÁ§∫Á∫¢ÁÇπ
        if (typeof renderCharacters === "function") {
          renderCharacters();
        }
      }

      // Ê∏ÖÈô§Êüê‰∏™ËßíËâ≤ÁöÑÊú™ËØªÊ∂àÊÅØ
      function clearUnreadForChar(charId) {
        if (unreadMessages[charId]) {
          delete unreadMessages[charId];
          updateMessagesBadge();
          // Âà∑Êñ∞Ê∂àÊÅØÂàóË°®ÁßªÈô§Á∫¢ÁÇπ
          if (typeof renderCharacters === "function") {
            renderCharacters();
          }
        }
      }

      // Êõ¥Êñ∞Ê∂àÊÅØtabÁöÑÂ∞èÁ∫¢ÁÇπ
      function updateMessagesBadge() {
        const badge = document.getElementById("messagesBadge");
        const total = Object.values(unreadMessages).reduce((a, b) => a + b, 0);

        if (total > 0) {
          badge.textContent = total > 99 ? "99+" : total;
          badge.style.display = "flex";
        } else {
          badge.style.display = "none";
        }
      }

      // Â¢ûÂä†ÊúãÂèãÂúàÊú™ËØª
      function addUnreadMoment() {
        unreadMoments++;
        updateMomentsBadge();
      }

      // Ê∏ÖÈô§ÊúãÂèãÂúàÊú™ËØª
      function clearUnreadMoments() {
        unreadMoments = 0;
        updateMomentsBadge();
      }

      // Êõ¥Êñ∞ÊúãÂèãÂúàtabÁöÑÂ∞èÁ∫¢ÁÇπ
      function updateMomentsBadge() {
        const badge = document.getElementById("momentsBadge");

        if (unreadMoments > 0) {
          badge.textContent = unreadMoments > 99 ? "99+" : unreadMoments;
          badge.style.display = "flex";
        } else {
          badge.style.display = "none";
        }
      }

      // Placeholder functions for settings actions
      function manageFriendGroups() {
        alert("Â•ΩÂèãÂàÜÁªÑÁÆ°ÁêÜÂäüËÉΩÂºÄÂèë‰∏≠...");
      }

      function triggerManualSummary() {
        const history = chatHistories[currentChatCharId] || [];
        if (history.length < 10) {
          alert("ËÅäÂ§©ËÆ∞ÂΩïÂ§™Â∞ëÔºåÊó†Ê≥ïÁîüÊàêÊÄªÁªì");
          return;
        }
        alert("Ê≠£Âú®ÁîüÊàêÊÄªÁªì...\n\nÊ≠§ÂäüËÉΩÈúÄË¶ÅÈÖçÂêàAPI‰ΩøÁî®");
      }

      function manageBubbleStyles() {
        alert("Ê∞îÊ≥°Ê†∑ÂºèÁÆ°ÁêÜÂäüËÉΩÂºÄÂèë‰∏≠...");
      }

      function exportBubbleStyle() {
        const css = document.getElementById("settingsCustomCSS").value;
        if (!css) {
          alert("Ê≤°ÊúâËá™ÂÆö‰πâÊ†∑ÂºèÂèØÂØºÂá∫");
          return;
        }
        const blob = new Blob([css], { type: "text/css" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "chat-style.css";
        a.click();
        URL.revokeObjectURL(url);
      }

      function importBubbleStyle() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".css,.txt";
        input.onchange = function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              document.getElementById("settingsCustomCSS").value =
                e.target.result;
            };
            reader.readAsText(file);
          }
        };
        input.click();
      }

      function resetCustomCSS() {
        if (confirm("Á°ÆÂÆöË¶ÅÈáçÁΩÆËá™ÂÆö‰πâCSSÂêóÔºü")) {
          document.getElementById("settingsCustomCSS").value = "";
        }
      }

      function importChatHistory() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";
        input.onchange = function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              try {
                const data = JSON.parse(e.target.result);
                if (Array.isArray(data)) {
                  chatHistories[currentChatCharId] = data;
                  localforage.setItem("chatHistories", chatHistories);
                  renderConversation();
                  showToast("ËÅäÂ§©ËÆ∞ÂΩïÂØºÂÖ•ÊàêÂäü");
                } else {
                  alert("Êó†ÊïàÁöÑËÅäÂ§©ËÆ∞ÂΩïÊ†ºÂºè");
                }
              } catch (err) {
                alert("ÂØºÂÖ•Â§±Ë¥•Ôºö" + err.message);
              }
            };
            reader.readAsText(file);
          }
        };
        input.click();
      }

      function exportChatHistory() {
        const history = chatHistories[currentChatCharId] || [];
        if (history.length === 0) {
          alert("Ê≤°ÊúâËÅäÂ§©ËÆ∞ÂΩïÂèØÂØºÂá∫");
          return;
        }
        const char = characters.find((c) => c.id === currentChatCharId);
        const blob = new Blob([JSON.stringify(history, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `chat-${char?.name || "export"}-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }

      function searchChatContent() {
        const keyword = prompt("ËØ∑ËæìÂÖ•Ë¶ÅÊêúÁ¥¢ÁöÑÂÖ≥ÈîÆËØçÔºö");
        if (!keyword) return;

        const history = chatHistories[currentChatCharId] || [];
        const results = history.filter((m) => m.content.includes(keyword));

        if (results.length === 0) {
          alert('Êú™ÊâæÂà∞ÂåÖÂê´"' + keyword + '"ÁöÑÊ∂àÊÅØ');
        } else {
          alert("ÊâæÂà∞ " + results.length + ' Êù°ÂåÖÂê´"' + keyword + '"ÁöÑÊ∂àÊÅØ');
        }
      }

      function clearChatHistoryFromSettings() {
        if (confirm("Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅ")) {
          chatHistories[currentChatCharId] = [];
          localforage.setItem("chatHistories", chatHistories);
          document.getElementById("settingsTotalMsg").textContent = "0";
          document.getElementById("settingsTokenCount").textContent = "0";
          renderConversation();
          showToast("ËÅäÂ§©ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫");
        }
      }

      function blockCharacter() {
        if (confirm("Á°ÆÂÆöË¶ÅÊãâÈªëÊ≠§ËßíËâ≤ÂêóÔºüÊãâÈªëÂêéÂ∞ÜÊó†Ê≥ïÊî∂ÂèëÊ∂àÊÅØ„ÄÇ")) {
          const char = characters.find((c) => c.id === currentChatCharId);
          if (char) {
            char.blocked = true;
            localforage.setItem("characters", characters);
            showToast("Â∑≤ÊãâÈªë " + char.name);
            closeChatSettings();
            closeConversation();
          }
        }
      }

      // Load settings when opening conversation
      const originalOpenConversation = openConversation;
      openConversation = function (charId) {
        originalOpenConversation(charId);

        // Apply saved settings if exist
        if (chatSettings[charId]) {
          applyCustomStyles(chatSettings[charId]);
        }

        // Âà∑Êñ∞Ë°®ÊÉÖÈù¢ÊùøÁöÑÁªëÂÆöÁä∂ÊÄÅÊòæÁ§∫ÔºàÂõ†‰∏∫‰∏çÂêåËßíËâ≤Êúâ‰∏çÂêåÁöÑÁªëÂÆöÔºâ
        if (typeof renderCategoryBar === "function") {
          renderCategoryBar();
        }
      };
      // ==================== Áî®Êà∑‰∫∫ËÆæÈ¢ÑËÆæÈÄªËæë ====================
      var userPersonaPresets;
      try {
        userPersonaPresets = JSON.parse(
          localStorage.getItem("userPersonaPresets") || "[]"
        );
        if (!Array.isArray(userPersonaPresets)) userPersonaPresets = [];
      } catch (e) {
        console.error("userPersonaPresetsËß£ÊûêÂ§±Ë¥•", e);
        userPersonaPresets = [];
      }

      // ÂàùÂßãÂåñÈ¢ÑËÆæ‰∏ãÊãâËèúÂçï
      function initUserPersonaPresets() {
        const select = document.getElementById("userPersonaPresetSelect");
        // ‰øùÁïôÁ¨¨‰∏Ä‰∏™ÈªòËÆ§ÈÄâÈ°πÔºåÊ∏ÖÈô§ÂÖ∂‰ªñÁöÑ
        while (select.options.length > 1) {
          select.remove(1);
        }

        userPersonaPresets.forEach((preset) => {
          const option = document.createElement("option");
          option.value = preset.id;
          option.textContent = preset.name;
          select.appendChild(option);
        });

        // ÁªëÂÆö change ‰∫ã‰ª∂
        select.onchange = function () {
          if (this.value) {
            loadUserPersonaPreset(this.value);
          }
        };
      }

      // ‰øùÂ≠òÂΩìÂâçÈÖçÁΩÆ‰∏∫Êñ∞È¢ÑËÆæ
      function saveUserPersonaPreset() {
        const currentPersona = document
          .getElementById("settingsMyPersona")
          .value.trim();
        const currentAvatar = document.getElementById("myAvatarImg").src;

        if (!currentPersona) {
          alert("ËØ∑ÂÖàÂ°´ÂÜô‰∫∫ËÆæÂÜÖÂÆπÂÜç‰øùÂ≠òÈ¢ÑËÆæÔºÅ");
          return;
        }

        const name = prompt(
          "ËØ∑‰∏∫ÂΩìÂâç‰∫∫ËÆæÂèñ‰∏™ÂêçÂ≠óÔºà‰æãÂ¶ÇÔºöÈ´òÂÜ∑Èú∏ÊÄª„ÄÅÊííÂ®áÂ∞èÁå´ÔºâÔºö"
        );
        if (!name) return;

        const newPreset = {
          id: Date.now().toString(),
          name: name,
          persona: currentPersona,
          avatar: currentAvatar, // ËøûÂêåÂ§¥ÂÉè‰∏ÄËµ∑‰øùÂ≠ò
        };

        userPersonaPresets.push(newPreset);
        localforage.setItem("userPersonaPresets", userPersonaPresets);

        showToast("È¢ÑËÆæÂ∑≤‰øùÂ≠ò ‚ú®");
        initUserPersonaPresets(); // Âà∑Êñ∞‰∏ãÊãâÊ°Ü
      }

      // Âä†ËΩΩÈ¢ÑËÆæ
      function loadUserPersonaPreset(presetId) {
        const preset = userPersonaPresets.find((p) => p.id === presetId);
        if (!preset) return;

        // 1. Â°´ÂÖ•‰∫∫ËÆæÊñáÊú¨
        document.getElementById("settingsMyPersona").value = preset.persona;

        // 2. Â¶ÇÊûúÈ¢ÑËÆæÈáåÊúâÂ§¥ÂÉèÔºå‰πü‰∏ÄËµ∑Âä†ËΩΩ
        if (preset.avatar && preset.avatar.startsWith("data:")) {
          loadAvatarPreview("my", preset.avatar);
          document.getElementById(
            "previewMyAvatar"
          ).innerHTML = `<img src="${preset.avatar}">`;
        }

        showToast(`Â∑≤ÂàáÊç¢Ëá≥Ôºö${preset.name}`);
      }

      // Âú®È°µÈù¢Âä†ËΩΩÂÆåÊàêÊó∂ÂàùÂßãÂåñ
      document.addEventListener("DOMContentLoaded", function () {
        // ... ÂéüÊúâÁöÑÂàùÂßãÂåñ‰ª£Á†Å ...
        initUserPersonaPresets(); // Ê∑ªÂä†Ëøô‰∏ÄË°å
      });
      // ==================== ÈïøÊúüËÆ∞ÂøÜÊÄªÁªìÁ≥ªÁªü ====================

      // 1. Ê£ÄÊü•ÊòØÂê¶ËææÂà∞Ëß¶ÂèëÊù°‰ª∂
      function checkAndTriggerSummary(settings) {
        if (!settings.longMemory) return; // Â¶ÇÊûúÂºÄÂÖ≥Ê≤°ÂºÄÔºåÁõ¥Êé•ÈÄÄÂá∫

        const history = chatHistories[currentChatCharId] || [];
        const totalMsg = history.length;
        // ÈªòËÆ§Â∑≤ÊÄªÁªìÊù°Êï∞‰∏∫0
        const summarizedCount = settings.summarizedCount || 0;
        // Ëé∑ÂèñËß¶ÂèëÈòàÂÄº
        const triggerCount = settings.triggerCount || 500;

        // ËÆ°ÁÆóÊñ∞Â¢ûÁöÑ„ÄÅÊú™ÊÄªÁªìÁöÑÊ∂àÊÅØÊï∞
        const newMsgCount = totalMsg - summarizedCount;

        if (newMsgCount >= triggerCount) {
          if (settings.summaryMode === "auto") {
            // Ëá™Âä®Ê®°ÂºèÔºöÁõ¥Êé•ÂºÄÂßãÊÄªÁªì
            performSummary(settings, history, summarizedCount, totalMsg);
          } else {
            // ÊâãÂä®Ê®°ÂºèÔºöÊèêÁ§∫Áî®Êà∑
            showToast(`üîî Êñ∞Ê∂àÊÅØÂ∑≤Ëææ ${newMsgCount} Êù°ÔºåÂª∫ËÆÆËøõË°åÊÄªÁªì`);
            // ËøôÈáåÂèØ‰ª•Âä†‰∏Ä‰∏™Â∞èÁ∫¢ÁÇπÈÄªËæëÔºåÊàñËÄÖÂºπÁ™óÔºåÁõÆÂâçÁî®ToastÊèêÁ§∫
          }
        }
      }

      // 2. ÊâßË°åÊÄªÁªì (Ë∞ÉÁî® AI)
      async function performSummary(
        settings,
        history,
        startIndex,
        endIndex,
        isManual = false
      ) {
        const apiConfig = getActiveApiConfig();
        if (!apiConfig) {
          if (isManual) alert("APIÊú™ÈÖçÁΩÆÔºåÊó†Ê≥ïÊÄªÁªì");
          return;
        }

        // Êà™ÂèñÈúÄË¶ÅÊÄªÁªìÁöÑÁâáÊÆµ
        const messagesToSummarize = history.slice(startIndex, endIndex);
        if (messagesToSummarize.length === 0) return;

        // Â∞ÜËÅäÂ§©ËÆ∞ÂΩïËΩ¨Êç¢‰∏∫ÊñáÊú¨
        const chatText = messagesToSummarize
          .map(
            (m) =>
              `${m.role === "user" ? "Áî®Êà∑" : settings.charName || "AI"}: ${
                m.content
              }`
          )
          .join("\n");

        const summaryPrompt =
          settings.summaryPrompt || "ËØ∑ÊÄªÁªì‰ª•‰∏ãÂØπËØùÁöÑÊ†∏ÂøÉ‰∫ã‰ª∂„ÄÇ";

        // ÊòæÁ§∫Ê≠£Âú®Â§ÑÁêÜÁöÑÊèêÁ§∫
        if (isManual) showToast("Ê≠£Âú®ÁîüÊàêËÆ∞ÂøÜÊÄªÁªì...");

        try {
          const response = await fetch(`${apiConfig.url}/chat/completions`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${apiConfig.key}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: apiConfig.model,
              messages: [
                { role: "system", content: summaryPrompt },
                { role: "user", content: chatText },
              ],
              temperature: 0.5, // ÊÄªÁªìÈúÄË¶ÅÂáÜÁ°ÆÔºåÊ∏©Â∫¶Ë∞É‰Ωé
            }),
          });

          const data = await response.json();
          const summaryText = data.choices[0]?.message?.content;

          if (summaryText) {
            // ‰øùÂ≠òÊÄªÁªì
            if (!settings.summaries) settings.summaries = [];

            // Ê∑ªÂä†Â∏¶Êó•ÊúüÁöÑÊÄªÁªì
            const dateStr = new Date().toLocaleDateString();
            settings.summaries.push(`[${dateStr}] ${summaryText}`);

            // Êõ¥Êñ∞Â∑≤ÊÄªÁªìÁöÑËÆ°Êï∞ÊåáÈíà
            settings.summarizedCount = endIndex;

            // ‰øùÂ≠òÂà∞ LocalStorage
            chatSettings[currentChatCharId] = settings;
            localforage.setItem("chatSettings", chatSettings);

            showToast("‚úÖ ÈïøÊúüËÆ∞ÂøÜÂ∑≤Êõ¥Êñ∞");
          }
        } catch (e) {
          console.error(e);
          if (isManual) alert("ÊÄªÁªìÂ§±Ë¥•: " + e.message);
        }
      }

      // 3. ÊâãÂä®Ëß¶ÂèëÊåâÈíÆÈÄªËæë (ÂØπÂ∫îËÆæÁΩÆÈ°µÁöÑÊåâÈíÆ)
      function triggerManualSummary() {
        if (!currentChatCharId) return;
        const settings = chatSettings[currentChatCharId];
        const history = chatHistories[currentChatCharId] || [];

        const summarizedCount = settings.summarizedCount || 0;
        const totalMsg = history.length;

        if (totalMsg <= summarizedCount) {
          alert("ÂΩìÂâçÊ≤°ÊúâÊñ∞ÁöÑÊ∂àÊÅØÈúÄË¶ÅÊÄªÁªì„ÄÇ");
          return;
        }

        if (
          confirm(
            `Êúâ ${
              totalMsg - summarizedCount
            } Êù°Êñ∞Ê∂àÊÅØÊú™ÊÄªÁªìÔºåÁ°ÆÂÆöÁé∞Âú®ÁîüÊàêÊÄªÁªìÂêóÔºü`
          )
        ) {
          performSummary(settings, history, summarizedCount, totalMsg, true);
        }
      }
      // ==================== Êü•Áúã/ÁÆ°ÁêÜÊÄªÁªì UI (ÂçáÁ∫ßÁâàÔºöÊîØÊåÅÁºñËæë) ====================
      function viewSummaries() {
        if (!currentChatCharId) return;
        const settings = chatSettings[currentChatCharId];
        const summaries = settings.summaries || [];

        // 1. ÂàõÂª∫ÈÅÆÁΩ©Â±Ç (Â¶ÇÊûúÊúâÊóßÁöÑÂÖàÁßªÈô§ÔºåÈò≤Ê≠¢ÈáçÂ§ç)
        const oldModal = document.getElementById("summaryManagerModal");
        if (oldModal) oldModal.remove();

        const overlay = document.createElement("div");
        overlay.className = "api-modal active";
        overlay.id = "summaryManagerModal";

        // 2. ÊûÑÂª∫ÂÜÖÂÆπ HTML
        let listHtml = "";
        if (summaries.length === 0) {
          listHtml = `<div class="empty-state" style="padding:20px;">
                                    <div class="empty-text">ÊöÇÊó†ÈïøÊúüËÆ∞ÂøÜ</div>
                                    <div class="empty-hint">AI ËøòÊ≤°ÊúâÁîüÊàêËøáÊÄªÁªìÂì¶</div>
                                </div>`;
        } else {
          summaries.forEach((sum, index) => {
            // ËøôÈáå‰ΩøÁî®‰∫ÜË°åÂÜÖÁºñËæëÁöÑÂ∏ÉÂ±Ä
            // ÈªòËÆ§ÊòæÁ§∫Ôºösummary-view (ÊñáÂ≠ó + ÊåâÈíÆ)
            // ÁºñËæëÁä∂ÊÄÅÔºösummary-edit (ËæìÂÖ•Ê°Ü + ‰øùÂ≠ò/ÂèñÊ∂à) -> ÈªòËÆ§ÈöêËóè
            listHtml += `
                                        <div id="summary-item-${index}" style="background:#f5f5f5; padding:12px; border-radius:12px; margin-bottom:10px; position:relative; transition: all 0.2s;">

                                            <div id="summary-view-${index}">
                                                <div style="font-size:0.9rem; color:#333; line-height:1.5; padding-right:60px; word-break: break-word;">${escapeHtml(
                                                  sum
                                                )}</div>

                                                <div style="position:absolute; top:8px; right:8px; display:flex; gap:4px;">
                                                    <button onclick="startEditSummary(${index})" style="border:none; background:white; width:28px; height:28px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1); color:#5d4e37; cursor:pointer; display:flex; align-items:center; justify-content:center;">‚úèÔ∏è</button>
                                                    <button onclick="deleteSummary(${index})" style="border:none; background:white; width:28px; height:28px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1); color:#ff6b6b; cursor:pointer; display:flex; align-items:center; justify-content:center;">üóëÔ∏è</button>
                                                </div>
                                            </div>

                                            <div id="summary-edit-${index}" style="display:none;">
                                                <textarea id="summary-input-${index}" class="edit-input" style="width:100%; height:80px; resize:vertical; margin-bottom:8px; background:white;">${sum}</textarea>
                                                <div style="display:flex; gap:8px; justify-content:flex-end;">
                                                    <button onclick="cancelEditSummary(${index})" class="form-btn-small" style="padding:6px 12px; background:#eee;">ÂèñÊ∂à</button>
                                                    <button onclick="saveSummaryEdit(${index})" class="form-btn-small" style="padding:6px 12px; background:var(--accent-pink); color:white; border:none; box-shadow:0 2px 8px rgba(244, 143, 177, 0.4);">‰øùÂ≠ò</button>
                                                </div>
                                            </div>

                                        </div>
                                    `;
          });
        }

        overlay.innerHTML = `
                                <div class="api-modal-content" style="height: 70vh;">
                                    <div class="api-modal-header">
                                        <h2 class="api-modal-title">ÈïøÊúüËÆ∞ÂøÜÁÆ°ÁêÜ (${summaries.length})</h2>
                                        <button class="api-modal-close" onclick="closeSummaryModal()">‚úï</button>
                                    </div>
                                    <div class="api-modal-body" id="summaryListContainer" style="padding-bottom: 40px;">
                                        ${listHtml}
                                    </div>
                                    <div class="api-modal-footer">
                                        <button class="api-modal-btn btn-cancel" style="width:100%" onclick="closeSummaryModal()">ÂÖ≥Èó≠</button>
                                    </div>
                                </div>
                            `;

        document.body.appendChild(overlay);
      }
      // ÂºÄÂßãÁºñËæëÔºöÂàáÊç¢ÊòæÁ§∫Áä∂ÊÄÅ
      function startEditSummary(index) {
        document.getElementById(`summary-view-${index}`).style.display = "none";
        document.getElementById(`summary-edit-${index}`).style.display =
          "block";

        // Ëá™Âä®ËÅöÁÑ¶Âπ∂ÊääÂÖâÊ†áÁßªÂà∞ÊúÄÂêé
        const textarea = document.getElementById(`summary-input-${index}`);
        textarea.focus();
        textarea.setSelectionRange(
          textarea.value.length,
          textarea.value.length
        );
      }

      // ÂèñÊ∂àÁºñËæëÔºöËøòÂéüÊòæÁ§∫Áä∂ÊÄÅ
      function cancelEditSummary(index) {
        document.getElementById(`summary-view-${index}`).style.display =
          "block";
        document.getElementById(`summary-edit-${index}`).style.display = "none";

        // ËøòÂéüÊñáÊú¨ÔºàÈò≤Ê≠¢Áî®Êà∑‰øÆÊîπ‰∫Ü‰∏ÄÂçäÊ≤°‰øùÂ≠òÔºâ
        const settings = chatSettings[currentChatCharId];
        document.getElementById(`summary-input-${index}`).value =
          settings.summaries[index];
      }

      // ‰øùÂ≠òÁºñËæë
      function saveSummaryEdit(index) {
        const newVal = document
          .getElementById(`summary-input-${index}`)
          .value.trim();
        if (!newVal) {
          alert("ËÆ∞ÂøÜÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫");
          return;
        }

        // Êõ¥Êñ∞Êï∞ÊçÆ
        const settings = chatSettings[currentChatCharId];
        settings.summaries[index] = newVal;

        // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
        chatSettings[currentChatCharId] = settings;
        localforage.setItem("chatSettings", chatSettings);

        showToast("ËÆ∞ÂøÜÂ∑≤‰øÆÊ≠£ ‚ú®");

        // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®ÔºàÊúÄÁÆÄÂçïÁöÑÊñπÊ≥ïÔºåÁ°Æ‰øùUIÂêåÊ≠•Ôºâ
        viewSummaries();
      }

      // Âà†Èô§ÊÄªÁªìÔºà‰øùÊåÅÂéüÊù•ÁöÑÈÄªËæëÔºåÁ®çÂæÆ‰ºòÂåñ‰∏Ä‰∏ãUIÂà∑Êñ∞Ôºâ
      window.deleteSummary = function (index) {
        if (confirm("Á°ÆÂÆöË¶ÅÈÅóÂøòËøôÊÆµËÆ∞ÂøÜÂêóÔºü")) {
          const settings = chatSettings[currentChatCharId];
          settings.summaries.splice(index, 1);

          localforage.setItem("chatSettings", chatSettings);

          viewSummaries(); // ÈáçÊñ∞Ê∏≤Êüì
          showToast("Â∑≤Âà†Èô§ËØ•Êù°ËÆ∞ÂøÜ");
        }
      };

      // ÂÖ≥Èó≠ÊÄªÁªìÂºπÁ™ó
      function closeSummaryModal() {
        const modal = document.getElementById("summaryManagerModal");
        if (modal) {
          modal.classList.remove("active"); // Êí≠ÊîæÈÄÄÂá∫Âä®ÁîªÔºàÂ¶ÇÊûúÊúâÔºâ
          setTimeout(() => modal.remove(), 300);
        }
      }

      // Âà†Èô§ÂçïÊù°ÊÄªÁªì
      window.deleteSummary = function (index) {
        if (confirm("Á°ÆÂÆöË¶ÅÈÅóÂøòËøôÊÆµËÆ∞ÂøÜÂêóÔºü")) {
          const settings = chatSettings[currentChatCharId];
          settings.summaries.splice(index, 1);

          // ‰øùÂ≠ò
          localforage.setItem("chatSettings", chatSettings);

          // Âà∑Êñ∞ÂàóË°®ÔºàÁÆÄÂçïÁ≤óÊö¥ÔºöÂÖ≥Èó≠ÂÜçÈáçÂºÄÔºåÊàñËÄÖÈáçÊñ∞ÁîüÊàêHTMLÔºâ
          closeSummaryModal();
          setTimeout(viewSummaries, 100); // Á®çÂæÆÂª∂Ëøü‰∏Ä‰∏ãÈáçÊñ∞ÊâìÂºÄ
          showToast("Â∑≤Âà†Èô§ËØ•Êù°ËÆ∞ÂøÜ");
        }
      };
      // ==================== Âø´Êç∑ÈîÆÔºöÂõûËΩ¶ÂèëÈÄÅ ====================
      document
        .getElementById("convInput")
        .addEventListener("keydown", function (e) {
          // Âà§Êñ≠ÔºöÂ¶ÇÊûúÊòØ Enter ÈîÆÔºåÂπ∂‰∏îÊ≤°ÊúâÊåâ‰Ωè Shift ÈîÆ
          // (!e.isComposing Áî®‰∫éÈò≤Ê≠¢Âú®ËæìÂÖ•‰∏≠ÊñáÊãºÈü≥Êó∂Êåâ‰∏ãÂõûËΩ¶ËØØÂèëÈÄÅ)
          if (e.key === "Enter" && !e.shiftKey && !e.isComposing) {
            e.preventDefault(); // ÈòªÊ≠¢ÈªòËÆ§ÁöÑ‚ÄúÊç¢Ë°å‚ÄùË°å‰∏∫
            sendUserMessage(); // ÊâßË°åÂèëÈÄÅÂáΩÊï∞
          }
        });
      // ==================== ÁÅ´Ëä±Ê†∑Âºè ====================
      const flameStyle = document.createElement("style");
      flameStyle.innerHTML = `
                            /* ÁÅ´Ëä±Â∞èÂæΩÁ´†ÂÆπÂô® */
                            .spark-badge {
                                display: inline-flex;
                                align-items: center;
                                gap: 2px;
                                padding: 2px 6px;
                                background: #fff0f6; /* ÊµÖÁ≤âËÉåÊôØ */
                                border: 1px solid #ffadd2; /* Ê∑±Á≤âÊèèËæπ */
                                border-radius: 12px;
                                color: #eb2f96;
                                font-size: 0.75rem;
                                font-weight: 600;
                                margin-left: 6px;
                                vertical-align: middle;
                                transform: translateY(-1px);
                                box-shadow: 0 1px 2px rgba(235, 47, 150, 0.1);
                            }

                            /* ÂàóË°®ÈáåÁöÑÁÅ´Ëä±ÔºàÁ®çÂæÆÂ∞è‰∏ÄÁÇπÔºâ */
                            .message-name .spark-badge {
                                font-size: 0.7rem;
                                padding: 1px 5px;
                            }

                            /* ËÆæÁΩÆÈ°µÈáåÁöÑÁÅ´Ëä±ÈÖçÁΩÆÂå∫Âüü */
                            #flameSettingsArea {
                                background: #fafafa;
                                padding: 12px;
                                border-radius: 12px;
                                margin-top: 10px;
                                border: 1px solid #eee;
                                animation: slideDown 0.2s ease-out;
                            }

                            @keyframes slideDown {
                                from { opacity: 0; transform: translateY(-10px); }
                                to { opacity: 1; transform: translateY(0); }
                            }
                        `;
      document.head.appendChild(flameStyle);
      // ==================== Áª≠ÁÅ´Ëä±ËÆæÁΩÆÈÄªËæë (UIÊ≥®ÂÖ•) ====================
      function initFlameSettingsUI() {
        const toggleSwitch = document.getElementById("settingsFlame");
        const toggleRow = toggleSwitch.closest(".toggle-row");

        // 1. Â¶ÇÊûúÈÖçÁΩÆÂå∫ÂüüËøòÊ≤°ÂàõÂª∫ÔºåÂ∞±ÂàõÂª∫ÂÆÉ
        if (!document.getElementById("flameSettingsArea")) {
          const area = document.createElement("div");
          area.id = "flameSettingsArea";
          area.style.display = "none"; // ÈªòËÆ§ÈöêËóè

          area.innerHTML = `
                                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                        <div style="flex: 1;">
                                            <label class="form-label" style="font-size: 0.75rem;">ÁÅ´Ëä±Ê†∑Âºè</label>
                                            <input type="text" id="settingsFlameIcon" class="form-input" style="text-align:center;" placeholder="üî•" value="üî•">
                                        </div>
                                        <div style="flex: 2;">
                                            <label class="form-label" style="font-size: 0.75rem;">Â∑≤Áª≠Â§©Êï∞</label>
                                            <input type="number" id="settingsFlameDays" class="form-input" value="1" min="1">
                                        </div>
                                    </div>
                                    <div style="font-size: 0.7rem; color: #999;">‚ú® ÊØèÂ§©ËÅäÂ§©‰ºöËá™Âä® +1 Âì¶</div>
                                `;

          // ÊèíÂÖ•Âà∞ÂºÄÂÖ≥Ë°åÁöÑÂêéÈù¢
          toggleRow.parentNode.insertBefore(area, toggleRow.nextSibling);
        }

        // 2. ÁªëÂÆöÂºÄÂÖ≥‰∫ã‰ª∂ÔºöÂºÄÂÖ≥ÊâìÂºÄÊó∂ÊòæÁ§∫ÈÖçÁΩÆÂå∫
        const area = document.getElementById("flameSettingsArea");

        function toggleArea() {
          area.style.display = toggleSwitch.checked ? "block" : "none";
        }

        // ÁõëÂê¨ÂèòÂåñ
        toggleSwitch.onchange = toggleArea;

        // ÂàùÂßãÂåñÁä∂ÊÄÅ
        toggleArea();
      }
      // ==================== UI ÁæéÂåñÔºöÊØõÁéªÁíÉ & ÊåâÈíÆÂ∏ÉÂ±Ä‰ºòÂåñ ====================

      // 1. Ê≥®ÂÖ•Ê†∑Âºè (ÈöêËóèÂ§¥ÂÉè„ÄÅÊØõÁéªÁíÉ„ÄÅÂúÜÂΩ¢ÊåâÈíÆ)
      const uiUpgradeStyle = document.createElement("style");
      uiUpgradeStyle.innerHTML = `
                            /* --- 1. ÈöêËóèËÅäÂ§©È°∂ÈÉ®Ê†áÈ¢òÊ†èÁöÑÈÇ£‰∏™Â∞èÂ§¥ÂÉè --- */
                            .conv-title-section .conv-avatar {
                                display: none !important;
                            }
                            /* Ë∞ÉÊï¥ÂêçÂ≠óÁöÑ‰ΩçÁΩÆÔºåÂõ†‰∏∫Â§¥ÂÉèÊ≤°‰∫ÜÔºåÂêçÂ≠óË¶ÅÂ±Ö‰∏≠ÊòæÁ§∫ */
                            .conv-title-section {
                                margin: 0 !important;
                                justify-content: center;
                            }

                            /* --- 2. ÂÆåÂÖ®ÈÄèÊòéÊïàÊûú --- */
                            /* È°∂ÈÉ®Ê†è */
                            .conv-header {
                                background: none !important;
                                backdrop-filter: none !important;
                                -webkit-backdrop-filter: none !important;
                                border: none !important;
                                box-shadow: none !important;
                            }

                            /* Â∫ïÈÉ®ËæìÂÖ•Ê†è */
                            .conv-input-area {
                                background: none !important;
                                backdrop-filter: none !important;
                                -webkit-backdrop-filter: none !important;
                                border: none !important;
                            }

                            /* --- 3. ÊîπÈÄ† AI ÊåâÈíÆ (ÂèòÊàêÂúÜÂΩ¢Â∞èÊåâÈíÆ) --- */
                            #replyBtn {
                                width: 34px !important;
                                height: 34px !important;
                                min-height: unset !important;
                                border-radius: 50% !important;
                                padding: 0 !important;

                                /* ÊµÖÁ≤âËâ≤Ê∏êÂèò */
                                background: linear-gradient(135deg, #fce4ec, #f8bbd9) !important;
                                color: #e91e63 !important;
                                box-shadow: 0 2px 8px rgba(233, 30, 99, 0.15) !important;

                                /* Â∏ÉÂ±Ä */
                                display: flex !important;
                                align-items: center !important;
                                justify-content: center !important;
                                font-size: 16px !important;
                                margin-bottom: 4px !important;
                                flex-shrink: 0 !important;
                                align-self: flex-end !important;
                            }

                            /* Ê≠£Â∏∏Áä∂ÊÄÅ‰∏ãÔºöÈöêËóèÊñáÂ≠óÔºåÂè™ÊòæÁ§∫ÊàëËÆæÂÆöÁöÑÂõæÊ†á */
                            #replyBtn span { display: none; } /* Â¶ÇÊûúÊúâ span */

                            /* Âä†ËΩΩÁä∂ÊÄÅÂ§ÑÁêÜ (ÂΩìÂèò‰∏∫"ÊÄùËÄÉ‰∏≠..."Êó∂) */
                            #replyBtn.loading {
                                font-size: 0 !important;
                                background: #ddd !important;
                                color: #999 !important;
                                pointer-events: none;
                            }
                            #replyBtn.loading::after {
                                content: "‚è≥";
                                font-size: 14px !important;
                                animation: spin 1s infinite linear;
                            }

                            @keyframes spin { 100% { transform: rotate(360deg); } }
                        `;
      document.head.appendChild(uiUpgradeStyle);

      // 2. JS ÈÄªËæëÔºöÊää AI ÊåâÈíÆ"Êê¨Ëøê"Âà∞ËæìÂÖ•Ê°ÜÈáåÈù¢ÂéªÔºàÂª∂ËøüÊâßË°åÔºâ
      document.addEventListener("DOMContentLoaded", function () {
        const wrapper = document.querySelector(".conv-input-wrapper");
        const replyBtn = document.getElementById("replyBtn");
        const sendBtn = document.querySelector(".conv-send-btn");
        if (
          wrapper &&
          replyBtn &&
          sendBtn &&
          sendBtn.parentNode === wrapper &&
          replyBtn.parentNode !== wrapper
        ) {
          replyBtn.innerHTML = "‚ú¶";
          wrapper.insertBefore(replyBtn, sendBtn);
          const input = document.getElementById("convInput");
          if (input) input.style.marginRight = "4px";
        }
      });
      const simpleBtnStyle = document.createElement("style");
      simpleBtnStyle.innerHTML = `
                            /* Ë¶ÜÁõñ‰πãÂâçÁöÑÊ†∑ÂºèÔºåËÆ©ÂÆÉÂèòÂõûÊôÆÈÄöÂúÜÂΩ¢ÊåâÈíÆ */
                            #replyBtn {
                                width: 34px !important;
                                height: 34px !important;
                                border-radius: 50% !important;
                                border: none !important;
                                padding: 0 !important;

                                /* ÊµÖÁ≤âËâ≤Ê∏êÂèò */
                                background: linear-gradient(135deg, #fce4ec, #f8bbd9) !important;
                                color: #e91e63 !important;

                                display: flex !important;
                                align-items: center !important;
                                justify-content: center !important;
                                font-size: 16px !important;

                                cursor: pointer !important;
                                box-shadow: 0 2px 8px rgba(233, 30, 99, 0.15) !important;
                                margin-bottom: 4px !important;
                                transition: opacity 0.2s !important;
                                align-self: flex-end !important;
                            }

                            /* ÁÇπÂáªÊó∂ÁöÑÊïàÊûú */
                            #replyBtn:active {
                                transform: scale(0.9);
                            }

                            /* Âä†ËΩΩÊó∂ÁöÑÊïàÊûú */
                            #replyBtn.loading {
                                opacity: 0.5 !important;
                                cursor: not-allowed !important;
                                background: #ddd !important;
                            }

                            /* Âº∫Âà∂ÈöêËóè‰πãÂâçÂèØËÉΩÂ≠òÂú®ÁöÑ‰º™ÂÖÉÁ¥†Âä®Áîª */
                            #replyBtn.loading::after {
                                display: none !important;
                            }
                        `;
      document.head.appendChild(simpleBtnStyle);
      // ==================== Â≠ó‰ΩìÁÆ°ÁêÜÁ≥ªÁªü ====================
      // ÂèòÈáèÂ∑≤Âú®scriptÂºÄÂ§¥ÂàùÂßãÂåñ

      // ÂàùÂßãÂåñ
      document.addEventListener("DOMContentLoaded", function () {
        renderFontPresets();
        // Â¶ÇÊûúÊúâÊøÄÊ¥ªÁöÑÂ≠ó‰ΩìÔºåÂ∫îÁî®ÂÆÉ
        if (window.activeFontId !== "system") {
          const font = window.fontPresets.find(
            (f) => f.id == window.activeFontId
          );
          if (font) injectGlobalFont(font.source);
        }
      });

      // ÂàáÊç¢Êù•Ê∫ê Tab (URL / Êú¨Âú∞Êñá‰ª∂)
      function switchFontSource(type) {
        document
          .querySelectorAll("#fontPage .radio-option")
          .forEach((el) => el.classList.remove("active"));
        if (type === "url") {
          document.getElementById("tabFontUrl").classList.add("active");
          document.getElementById("fontSourceUrl").style.display = "block";
          document.getElementById("fontSourceFile").style.display = "none";
          window.tempFontData = null;
        } else {
          document.getElementById("tabFontFile").classList.add("active");
          document.getElementById("fontSourceUrl").style.display = "none";
          document.getElementById("fontSourceFile").style.display = "block";
        }
      }

      // Â§ÑÁêÜÊñá‰ª∂‰∏ä‰º† (ËΩ¨ Base64)
      function handleFontFileUpload(input) {
        const file = input.files[0];
        if (!file) return;

        // ÈôêÂà∂Â§ßÂ∞è (‰æãÂ¶Ç 3MB)ÔºåÈò≤Ê≠¢ localStorage ÁàÜÁÇ∏
        if (file.size > 3 * 1024 * 1024) {
          alert("Â≠ó‰ΩìÊñá‰ª∂ËøáÂ§ßÔºåËØ∑‰ΩøÁî® URL ÊñπÂºèÊàñ‰∏ä‰º†Â∞è‰∫é 3MB ÁöÑÊñá‰ª∂„ÄÇ");
          input.value = "";
          return;
        }

        document.getElementById("fontFileName").textContent = file.name;

        const reader = new FileReader();
        reader.onload = function (e) {
          window.tempFontData = e.target.result; // Base64 Â≠óÁ¨¶‰∏≤
          showToast("Êñá‰ª∂Â∑≤ËØªÂèñÔºåËØ∑ÁÇπÂáªÈ¢ÑËßà");
        };
        reader.readAsDataURL(file);
      }

      // È¢ÑËßàÂ≠ó‰Ωì
      function previewCustomFont() {
        let source = "";
        // Âà§Êñ≠ÂΩìÂâçÊòØ URL Ê®°ÂºèËøòÊòØÊñá‰ª∂Ê®°Âºè
        if (
          document.getElementById("tabFontUrl").classList.contains("active")
        ) {
          source = `url('${document
            .getElementById("fontUrlInput")
            .value.trim()}')`;
        } else {
          if (!window.tempFontData) {
            alert("ËØ∑ÂÖà‰∏ä‰º†Â≠ó‰ΩìÊñá‰ª∂");
            return;
          }
          source = `url('${window.tempFontData}')`;
        }

        if (!source || source === "url('')") {
          alert("ËØ∑ËæìÂÖ• URL Êàñ‰∏ä‰º†Êñá‰ª∂");
          return;
        }

        // ÂàõÂª∫‰∏¥Êó∂ Style Ê≥®ÂÖ•È¢ÑËßà
        const previewId = "temp-preview-font";
        let style = document.getElementById(previewId);
        if (style) style.remove();

        style = document.createElement("style");
        style.id = previewId;
        style.innerHTML = `
                                    @font-face {
                                        font-family: 'PreviewFont';
                                        src: ${source};
                                    }
                                  `;
        document.head.appendChild(style);

        // Â∫îÁî®Âà∞È¢ÑËßàÊ°Ü
        const box = document.getElementById("fontPreviewBox");
        box.style.fontFamily = "'PreviewFont', sans-serif";
        showToast("È¢ÑËßàÂ∑≤Â∫îÁî®");
      }

      // ‰øùÂ≠òÂπ∂Â∫îÁî®Â≠ó‰Ωì
      function saveFontPreset() {
        // Á°Æ‰øùfontPresetsÂ∑≤ÂàùÂßãÂåñ
        if (!window.fontPresets) window.fontPresets = [];

        const name = document.getElementById("fontNameInput").value.trim();
        let source = "";

        if (
          document.getElementById("tabFontUrl").classList.contains("active")
        ) {
          const url = document.getElementById("fontUrlInput").value.trim();
          if (!url) {
            alert("ËØ∑ËæìÂÖ•Â≠ó‰Ωì URL");
            return;
          }
          source = `url('${url}')`;
        } else {
          if (!window.tempFontData) {
            alert("ËØ∑ÂÖà‰∏ä‰º†Â≠ó‰ΩìÊñá‰ª∂");
            return;
          }
          source = `url('${window.tempFontData}')`;
        }

        if (!name) {
          alert("ËØ∑ÁªôÂ≠ó‰ΩìËµ∑‰∏™ÂêçÂ≠ó");
          return;
        }

        const newPreset = {
          id: Date.now(),
          name: name,
          source: source,
        };

        window.fontPresets.push(newPreset);
        localforage.setItem("fontPresets", window.fontPresets);

        // Á´ãÂç≥Â∫îÁî®
        activateFont(newPreset.id);
        renderFontPresets();

        // Ê∏ÖÁ©∫ËæìÂÖ•
        document.getElementById("fontNameInput").value = "";
        document.getElementById("fontUrlInput").value = "";
        document.getElementById("fontFileInput").value = "";
        document.getElementById("fontFileName").textContent = "Êú™ÈÄâÊã©Êñá‰ª∂";
        window.tempFontData = null;

        showToast("Â≠ó‰Ωì‰øùÂ≠òÂπ∂Â∫îÁî®ÊàêÂäü ‚ú®");
      }

      // Ê∏≤ÊüìÂ≠ó‰ΩìÂàóË°®
      function renderFontPresets() {
        // Á°Æ‰øùÂèòÈáèÂ∑≤ÂàùÂßãÂåñ
        if (!window.fontPresets) window.fontPresets = [];
        if (!window.activeFontId) window.activeFontId = "system";

        const container = document.getElementById("fontPresetList");

        // ‰øùÁïôÁ¨¨‰∏Ä‰∏™Á≥ªÁªüÈªòËÆ§
        let html = `
                                     <div class="api-preset-item ${
                                       window.activeFontId === "system"
                                         ? "active"
                                         : ""
                                     }" onclick="applySystemFont()">
                                        <div class="preset-radio" id="radio-system"></div>
                                        <div class="preset-info">
                                           <div class="preset-name">Á≥ªÁªüÈªòËÆ§</div>
                                           <div class="preset-detail">System Default</div>
                                        </div>
                                     </div>
                                  `;

        window.fontPresets.forEach((preset) => {
          const isActive = window.activeFontId == preset.id;
          html += `
                                        <div class="api-preset-item ${
                                          isActive ? "active" : ""
                                        }" onclick="activateFont(${preset.id})">
                                            <div class="preset-radio"></div>
                                            <div class="preset-info">
                                                <div class="preset-name" style="${
                                                  isActive
                                                    ? "font-family: CustomGlobalFont;"
                                                    : ""
                                                }">${escapeHtml(
            preset.name
          )}</div>
                                                <div class="preset-detail">Ëá™ÂÆö‰πâÂ≠ó‰Ωì</div>
                                            </div>
                                            <button class="preset-edit-btn" style="color:#ff6b6b;" onclick="event.stopPropagation(); deleteFontPreset(${
                                              preset.id
                                            })">üóëÔ∏è</button>
                                        </div>
                                      `;
        });

        container.innerHTML = html;
      }

      // ÊøÄÊ¥ªËá™ÂÆö‰πâÂ≠ó‰Ωì
      function activateFont(id) {
        if (!window.fontPresets) window.fontPresets = [];
        const preset = window.fontPresets.find((p) => p.id == id);
        if (!preset) return;

        window.activeFontId = id;
        localforage.setItem("activeFontId", id);

        injectGlobalFont(preset.source);
        renderFontPresets();
      }

      // ÊÅ¢Â§çÁ≥ªÁªüÈªòËÆ§Â≠ó‰Ωì
      function applySystemFont() {
        window.activeFontId = "system";
        localforage.setItem("activeFontId", "system");

        // ÁßªÈô§ÂÖ®Â±ÄÊ†∑Âºè
        const style = document.getElementById("global-custom-font");
        if (style) style.remove();

        renderFontPresets();
        showToast("Â∑≤ÊÅ¢Â§çÈªòËÆ§Â≠ó‰Ωì");
      }

      // Ê†∏ÂøÉÔºöÊ≥®ÂÖ•ÂÖ®Â±Ä CSS
      function injectGlobalFont(sourceStr) {
        const styleId = "global-custom-font";
        let style = document.getElementById(styleId);
        if (style) style.remove();

        style = document.createElement("style");
        style.id = styleId;
        style.innerHTML = `
                                    @font-face {
                                        font-family: 'CustomGlobalFont';
                                        src: ${sourceStr};
                                        font-display: swap;
                                    }
                                    /* Âº∫Âà∂Ë¶ÜÁõñÊâÄÊúâÂÖÉÁ¥†ÁöÑÂ≠ó‰Ωì */
                                    body, button, input, textarea, select, .chat-title, .message-preview, .msg-bubble {
                                        font-family: 'CustomGlobalFont', "Noto Sans SC", sans-serif !important;
                                    }
                                  `;
        document.head.appendChild(style);
      }

      // Âà†Èô§Â≠ó‰Ωì
      function deleteFontPreset(id) {
        if (!window.fontPresets) window.fontPresets = [];
        if (confirm("Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Â≠ó‰ΩìÈ¢ÑËÆæÂêóÔºü")) {
          window.fontPresets = window.fontPresets.filter((p) => p.id != id);
          localforage.setItem("fontPresets", window.fontPresets);

          if (window.activeFontId == id) {
            applySystemFont();
          } else {
            renderFontPresets();
          }
        }
      }

      // ==================== ‰øÆÂ§çÔºöËÅäÂ§©Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ® ====================
      function renderConversation() {
        const container = document.getElementById("convMessages");
        const history = chatHistories[currentChatCharId] || [];

        if (history.length === 0) {
          container.innerHTML = `
            <div class="conv-empty">
                <div class="conv-empty-icon">üí¨</div>
                <div class="conv-empty-text">ÂºÄÂßãÂíåTAËÅäÂ§©ÂêßÔΩû</div>
            </div>`;
          return;
        }

        const settings = chatSettings[currentChatCharId] || {};
        const char = characters.find((c) => c.id === currentChatCharId);

        // Â§¥ÂÉèÈÄªËæë
        const aiAvatarSrc =
          settings.otherAvatar || (char ? char.avatar : "") || "";
        const globalUserAvatar = localStorage.getItem("avatarImg");
        const userAvatarSrc = settings.myAvatar || globalUserAvatar || "";

        let html = "";
        let lastRole = null;
        let currentGroup = [];

        // ÈÅçÂéÜÁîüÊàê HTML (ÈÄªËæë‰øùÊåÅ‰∏çÂèò)
        history.forEach((msg, index) => {
          const isRecalled = msg.isRecalled === true;

          if (isRecalled) {
            if (currentGroup.length > 0) {
              html += renderMessageGroup(
                currentGroup,
                lastRole,
                aiAvatarSrc,
                userAvatarSrc
              );
              currentGroup = [];
            }
            html += `<div class="msg-system-tip">${
              msg.role === "user" ? "‰Ω†" : "ÂØπÊñπ"
            }Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ</div>`;
            lastRole = null;
            return;
          }

          // Â§ÑÁêÜÁ≥ªÁªüÂç°Áâá
          if (msg.type === "system-card") {
            if (currentGroup.length > 0) {
              html += renderMessageGroup(
                currentGroup,
                lastRole,
                aiAvatarSrc,
                userAvatarSrc
              );
              currentGroup = [];
            }
            html += `<div class="msg-system-card">
              <div class="system-card">
                <div class="system-card-icon">${msg.cardIcon || "üìå"}</div>
                <div class="system-card-title">${
                  msg.cardTitle || "Á≥ªÁªüÊ∂àÊÅØ"
                }</div>
                <div class="system-card-desc">${msg.cardDesc || ""}</div>
              </div>
            </div>`;
            lastRole = null;
            return;
          }

          if (msg.role !== lastRole && currentGroup.length > 0) {
            html += renderMessageGroup(
              currentGroup,
              lastRole,
              aiAvatarSrc,
              userAvatarSrc
            );
            currentGroup = [];
          }

          currentGroup.push({ ...msg, originalIndex: index });
          lastRole = msg.role;

          if (index === history.length - 1) {
            html += renderMessageGroup(
              currentGroup,
              lastRole,
              aiAvatarSrc,
              userAvatarSrc
            );
          }
        });

        container.innerHTML = html;

        // „ÄêÂÖ≥ÈîÆ‰øÆÊîπ„ÄëÂ¶ÇÊûú‰∏çÊòØÂú®Â§öÈÄâÊ®°ÂºèÔºåÂº∫Âà∂ÊªöÂä®Âà∞Â∫ïÈÉ®
        // ‰ΩøÁî® setTimeout Á°Æ‰øù DOM Ê∏≤ÊüìÂÆåÊàêÂêéÂÜçÊªöÂä®
        if (typeof isSelectionMode === "undefined" || !isSelectionMode) {
          setTimeout(() => {
            container.scrollTop = container.scrollHeight;
          }, 0);
        }
      }

      // 3. ÈïøÊåâÂ§ÑÁêÜÈÄªËæë
      function handleTouchStart(e, index) {
        if (isSelectionMode) return; // Â§öÈÄâÊ®°Âºè‰∏ã‰∏çËß¶ÂèëÈïøÊåâ
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;

        longPressTimer = setTimeout(() => {
          showContextMenu(e.touches[0].clientX, e.touches[0].clientY, index);
        }, 500); // 500ms ÈïøÊåâËß¶Âèë
      }

      function handleTouchMove(e) {
        if (!longPressTimer) return;
        // Â¶ÇÊûúÁßªÂä®Ë∂ÖËøá‰∏ÄÂÆöË∑ùÁ¶ªÔºåÂèñÊ∂àÈïøÊåâ
        let moveX = e.touches[0].clientX;
        let moveY = e.touches[0].clientY;
        if (
          Math.abs(moveX - touchStartX) > 10 ||
          Math.abs(moveY - touchStartY) > 10
        ) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      }

      function handleTouchEnd() {
        if (longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      }

      // Èº†Ê†áÂÖºÂÆπ (PCÁ´ØË∞ÉËØïÁî®)
      function handleMouseDown(e, index) {
        if (isSelectionMode) return;
        longPressTimer = setTimeout(() => {
          showContextMenu(e.clientX, e.clientY, index);
        }, 500);
      }
      function handleMouseUp() {
        if (longPressTimer) clearTimeout(longPressTimer);
      }

      // ==================== ÁÆÄÂåñÁâàÔºöÊòæÁ§∫Â±Ö‰∏≠ËèúÂçï ====================
      // ==================== ÊúÄÁªàÂÆöÁ®øÔºöÂ±èÂπïÂ±Ö‰∏≠ÈÄªËæë ====================

      function showContextMenu(x, y, index) {
        if (navigator.vibrate) navigator.vibrate(50);

        activeMsgIndex = index;
        const overlay = document.getElementById("contextMenuOverlay");
        const menu = document.getElementById("contextMenu");

        // Ëé∑ÂèñÂΩìÂâçÊ∂àÊÅØËßíËâ≤
        const history = chatHistories[currentChatCharId];
        const msg = history[index];
        const isUser = msg.role === "user";

        // ÊûÑÂª∫ËèúÂçïÂÜÖÂÆπ
        let menuHtml = `<div class="menu-item" onclick="handleCopyMsg()">Â§çÂà∂</div>`;

        if (isUser) {
          menuHtml += `<div class="menu-item" onclick="handleRecallMsg()">Êí§Âõû</div>`;
        }

        menuHtml += `
                                <div class="menu-item" onclick="handleEditMsg()">ÁºñËæë</div>
                                <div class="menu-item" onclick="handleMultiSelect()">Â§öÈÄâ</div>
                                <div class="menu-item danger" onclick="handleDeleteMsg()">Âà†Èô§</div>
                            `;

        menu.innerHTML = menuHtml;

        // Ê∏ÖÈô§ÂèØËÉΩÊÆãÁïôÁöÑÂÜÖËÅîÊ†∑Âºè
        menu.style.left = "";
        menu.style.top = "";
        menu.classList.remove("arrow-top");

        // ÊòæÁ§∫
        overlay.classList.add("active");
        setTimeout(() => menu.classList.add("show"), 10);
      }
      // ==================== ÊúÄÁªàÁâàÔºöÈîöÂÆöÊ∞îÊ≥°ÁöÑËèúÂçïÈÄªËæë ====================

      function hideContextMenu() {
        const overlay = document.getElementById("contextMenuOverlay");
        const menu = document.getElementById("contextMenu");
        menu.classList.remove("show");
        setTimeout(() => overlay.classList.remove("active"), 200);
      }

      // Ê∞îÊ≥°ÁÇπÂáªÂ§ÑÁêÜÔºàÂ§öÈÄâÊ®°Âºè‰∏ãÂàáÊç¢ÈÄâ‰∏≠Áä∂ÊÄÅÔºâ
      function handleBubbleClick(event, index) {
        if (isSelectionMode) {
          event.stopPropagation();
          if (selectedIndices.has(index)) {
            selectedIndices.delete(index);
          } else {
            selectedIndices.add(index);
          }
          updateSelectionUI();
          renderConversation();
        }
      }

      // 5. ËèúÂçïÂäüËÉΩÂÆûÁé∞

      // Â§çÂà∂
      function handleCopyMsg() {
        const msg = chatHistories[currentChatCharId][activeMsgIndex];
        navigator.clipboard.writeText(msg.content).then(() => {
          showToast("Â∑≤Â§çÂà∂");
        });
      }

      // Êí§Âõû (Ê†∏ÂøÉÂäüËÉΩÔºöAIÂèØËßÅÔºåÁî®Êà∑‰∏çÂèØËßÅ)
      function handleRecallMsg() {
        if (!confirm("Á°ÆÂÆöÊí§ÂõûËøôÊù°Ê∂àÊÅØÂêóÔºü(AI‰ªç‰ºöËÆ∞ÂæóÊ≠§ÂÜÖÂÆπ)")) return;

        // Ê†áËÆ∞‰∏∫Â∑≤Êí§ÂõûÔºå‰∏çÂà†Èô§
        chatHistories[currentChatCharId][activeMsgIndex].isRecalled = true;
        localforage.setItem("chatHistories", chatHistories);

        renderConversation();
        showToast("Ê∂àÊÅØÂ∑≤Êí§Âõû");
      }

      // Âà†Èô§ (Ê†∏ÂøÉÂäüËÉΩÔºöAIÂ§±ÂøÜ)
      function handleDeleteMsg() {
        if (!confirm("Á°ÆÂÆöÂà†Èô§Ôºü(AIÂ∞ÜÂøòËÆ∞ËøôÊù°Ê∂àÊÅØ)")) return;

        // ÂΩªÂ∫ï‰ªéÊï∞ÁªÑÁßªÈô§
        chatHistories[currentChatCharId].splice(activeMsgIndex, 1);
        localforage.setItem("chatHistories", chatHistories);

        // Êõ¥Êñ∞ËÆæÁΩÆÈ°µÁöÑÁªüËÆ°
        document.getElementById("settingsTotalMsg").textContent =
          chatHistories[currentChatCharId].length;

        renderConversation();
        showToast("Ê∂àÊÅØÂ∑≤Âà†Èô§");
      }

      // ÁºñËæë (Ê†∏ÂøÉÂäüËÉΩÔºöAIËÆ∞ÂøÜÊõ¥Êñ∞)
      function handleEditMsg() {
        const msg = chatHistories[currentChatCharId][activeMsgIndex];

        // ÂºπÂá∫‰∏Ä‰∏™ prompt ÊàñËÄÖ‰ΩøÁî®‰πãÂâçÁöÑ editModal (‰∏∫‰∫ÜÁÆÄÂçïËøôÈáåÁî® promptÔºå‰Ω†ÂèØ‰ª•ÊîπÁî® editModal)
        // ‰ΩøÁî®Â§öË°åËæìÂÖ•Ê°ÜÊïàÊûúÊõ¥Â•Ω
        const newContent = prompt("ÁºñËæëÊ∂àÊÅØ (AIËÆ∞ÂøÜÂ∞ÜÊõ¥Êñ∞):", msg.content);

        if (newContent !== null && newContent.trim() !== "") {
          chatHistories[currentChatCharId][activeMsgIndex].content =
            newContent.trim();
          localforage.setItem("chatHistories", chatHistories);

          renderConversation();
          showToast("Ê∂àÊÅØÂ∑≤ÁºñËæë");
        }
      }

      // Â§öÈÄâÊ®°ÂºèÂÖ•Âè£
      function handleMultiSelect() {
        isSelectionMode = true;
        selectedIndices.clear();

        // ÈªòËÆ§ÈÄâ‰∏≠Ëß¶ÂèëÈïøÊåâÁöÑÈÇ£‰∏ÄÊù°
        selectedIndices.add(activeMsgIndex);

        // Êõ¥Êñ∞ UI Áä∂ÊÄÅ
        document.getElementById("convInput").blur(); // Êî∂Ëµ∑ÈîÆÁõò
        document.querySelector(".conv-input-area").style.display = "none"; // ÈöêËóèËæìÂÖ•Ê°Ü
        document.getElementById("selectionFooter").classList.add("active"); // ÊòæÁ§∫Âà†Èô§Ê†è

        renderConversation(); // ÈáçÊñ∞Ê∏≤Êüì‰ª•ÊòæÁ§∫ checkbox
        updateSelectionUI();
      }

      // 6. Â§öÈÄâÊ®°ÂºèÈÄªËæë

      // ÁÇπÂáªÊ∂àÊÅØ (Âú®Â§öÈÄâÊ®°Âºè‰∏ã)
      function handleClickMsg(index) {
        if (!isSelectionMode) return;
        // ËøôÈáåÂõ†‰∏∫Êàë‰ª¨Âú® render Êó∂ÊòØÊåâÁªÑÊ∏≤Êüì onclickÔºåÊâÄ‰ª•Ëøô‰∏™ÂáΩÊï∞ÂèØËÉΩË¢´ÁªÑÁÇπÂáªË¶ÜÁõñ
        // ‰ΩÜÂ¶ÇÊûúÁõ¥Êé•ÁÇπÊ∞îÊ≥°Ôºå‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÂèØ‰ª•Âú®ËøôÈáåÂ§ÑÁêÜ
      }

      // ÂàáÊç¢‰∏ÄÁªÑÊ∂àÊÅØÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
      function toggleSelectionGroup(indices) {
        // Ê£ÄÊü•ËøôÁªÑÊòØÂê¶ÂÖ®ÈÄâ‰∫ÜÔºåÂ¶ÇÊûúÊòØÔºåÂàôÂèçÈÄâÔºõÂê¶ÂàôÂÖ®ÈÄâ
        const allSelected = indices.every((i) => selectedIndices.has(i));

        if (allSelected) {
          indices.forEach((i) => selectedIndices.delete(i));
        } else {
          indices.forEach((i) => selectedIndices.add(i));
        }

        // Âº∫Âà∂Êõ¥Êñ∞ UI (‰∏çÂÆåÂÖ®ÈáçÁªòÔºåÂè™ÂàáÊç¢ class)
        const firstIdx = indices[0];
        const wrapper = document.getElementById(`msg-wrapper-${firstIdx}`);
        if (wrapper) {
          if (!allSelected) wrapper.classList.add("selected");
          else wrapper.classList.remove("selected");
        }

        updateSelectionUI();
      }

      function exitSelectionMode() {
        isSelectionMode = false;
        selectedIndices.clear();

        document.querySelector(".conv-input-area").style.display = "block";
        document.getElementById("selectionFooter").classList.remove("active");

        renderConversation();
      }
      // ==================== Ê∂àÊÅØÊ†ºÂºèËß£ÊûêÂô® ====================
      function formatNovelMessage(text) {
        // 1. ÂÖàËøõË°å HTML ËΩ¨‰πâÔºåÈò≤Ê≠¢ XSS
        let safeText = escapeHtml(text);

        // 2. Â§ÑÁêÜÂøÉÁêÜÊ¥ªÂä®ÔºöÊää *ÂÜÖÂÆπ* ÊõøÊç¢‰∏∫ <i>ÂÜÖÂÆπ</i>
        // ‰ΩøÁî®Ê≠£ÂàôÔºö\* ÂåπÈÖçÊòüÂè∑Ôºå([^*]+) ÊçïËé∑‰∏≠Èó¥ÈùûÊòüÂè∑ÁöÑÂÜÖÂÆπ
        safeText = safeText.replace(/\*([^*]+)\*/g, "<i>*$1*</i>");

        // 3. Â§ÑÁêÜÊç¢Ë°åÔºöÊää \n ÊõøÊç¢‰∏∫ <br>
        safeText = safeText.replace(/\n/g, "<br>");

        return safeText;
      }

      // ==================== ËØ≠Èü≥Êù°Êí≠ÊîæÂäüËÉΩ ====================
      let currentPlayingAudio = null;
      let currentPlayingBar = null;
      // voiceTouchStartTime Â∑≤Âú®Êñá‰ª∂ÂºÄÂ§¥Áî®varÂ£∞Êòé

      // ËØ≠Èü≥Ê∞îÊ≥°ÁöÑtouchstartÂ§ÑÁêÜ - ËÆ∞ÂΩïÂºÄÂßãÊó∂Èó¥
      function handleVoiceBubbleTouchStart(event, msgIndex) {
        voiceTouchStartTime = Date.now();
        // Ë∞ÉÁî®ÂéüÊù•ÁöÑÈïøÊåâÂ§ÑÁêÜ
        handleTouchStart(event, msgIndex);
      }

      // ËØ≠Èü≥Ê∞îÊ≥°ÁöÑtouchendÂ§ÑÁêÜ - Âà§Êñ≠ÊòØÁü≠ÊåâËøòÊòØÈïøÊåâ
      function handleVoiceBubbleTouchEnd(event, msgIndex) {
        const touchDuration = Date.now() - voiceTouchStartTime;

        // Â¶ÇÊûúËß¶Êë∏Êó∂Èó¥Â∞è‰∫é450msÔºå‰∏îlongPressTimerËøòÂ≠òÂú®ÔºàËØ¥ÊòéÈïøÊåâËøòÊ≤°Ëß¶ÂèëÔºâ
        // ÂàôËßÜ‰∏∫ÁÇπÂáªÔºåÊí≠ÊîæËØ≠Èü≥
        if (touchDuration < 450 && longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;

          // Êí≠ÊîæËØ≠Èü≥
          const voiceBar = event.currentTarget.querySelector(".voice-bar");
          if (voiceBar) {
            playVoiceMessageByIndex(msgIndex, voiceBar);
          }
        } else if (longPressTimer) {
          // Ë∂ÖËøá450ms‰ΩÜËèúÂçïËøòÊ≤°ÊòæÁ§∫ÔºåÊ∏ÖÈô§ËÆ°Êó∂Âô®
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
        // Â¶ÇÊûúlongPressTimerÂ∑≤ÁªèÊòØnullÔºåËØ¥ÊòéÈïøÊåâËèúÂçïÂ∑≤ÁªèÊòæÁ§∫‰∫ÜÔºå‰∏çÈúÄË¶ÅÂÅö‰ªª‰Ωï‰∫ã
      }

      // ÈÄöËøáÁ¥¢ÂºïÊí≠ÊîæËØ≠Èü≥
      function playVoiceMessageByIndex(msgIndex, voiceBar) {
        const history = chatHistories[currentChatCharId] || [];
        const msg = history[msgIndex];
        if (!msg) return;

        // Â¶ÇÊûúÊ≠£Âú®Êí≠ÊîæÔºåÂÅúÊ≠¢
        if (currentPlayingAudio && currentPlayingBar === voiceBar) {
          currentPlayingAudio.pause();
          currentPlayingAudio.currentTime = 0;
          currentPlayingAudio = null;
          voiceBar.classList.remove("playing");
          currentPlayingBar = null;
          return;
        }

        // ÂÅúÊ≠¢‰πãÂâçÁöÑÊí≠Êîæ
        if (currentPlayingAudio) {
          currentPlayingAudio.pause();
          currentPlayingAudio.currentTime = 0;
          if (currentPlayingBar) {
            currentPlayingBar.classList.remove("playing");
          }
        }

        // Â¶ÇÊûúÂ∑≤ÁªèÊúâÈü≥È¢ëURLÔºåÁõ¥Êé•Êí≠Êîæ
        if (msg.audioUrl) {
          playAudioFromUrl(msg.audioUrl, voiceBar);
          return;
        }

        // Âê¶ÂàôÔºåÁîüÊàêËØ≠Èü≥
        generateAndPlayVoice(msg, msgIndex, voiceBar);
      }

      // ÁîüÊàêÂπ∂Êí≠ÊîæËØ≠Èü≥
      async function generateAndPlayVoice(msg, msgIndex, voiceBar) {
        const settings = chatSettings[currentChatCharId] || {};
        if (!settings.voiceId) {
          showToast("ËØ∑ÂÖàÂú®ËÅäÂ§©ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆËØ≠Èü≥ID");
          return;
        }

        // Ëé∑ÂèñËØ≠Èü≥ÊñáÊú¨
        const voiceMatch = msg.content.match(/^\[ËØ≠Èü≥[ :Ôºö„ÄÉ\s]*(.+)\]$/);
        if (!voiceMatch) return;

        const voiceText = voiceMatch[1];

        // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅÔºàÈùôÈªòÁîüÊàêÔºå‰∏çÊòæÁ§∫ToastÊèêÁ§∫Ôºâ
        voiceBar.classList.add("loading");

        try {
          const audioUrl = await generateSpeech(voiceText, currentChatCharId);

          if (audioUrl) {
            // ‰øùÂ≠òÂà∞Ê∂àÊÅØ‰∏≠
            const history = chatHistories[currentChatCharId];
            if (history && history[msgIndex]) {
              history[msgIndex].audioUrl = audioUrl;
              localforage.setItem("chatHistories", chatHistories);
            }

            voiceBar.classList.remove("loading");
            voiceBar.classList.add("has-audio");
            voiceBar.dataset.audioUrl = audioUrl;

            // Êí≠Êîæ
            playAudioFromUrl(audioUrl, voiceBar);
          } else {
            voiceBar.classList.remove("loading");
            showToast("ËØ≠Èü≥ÁîüÊàêÂ§±Ë¥•");
          }
        } catch (e) {
          console.error("Voice generation error:", e);
          voiceBar.classList.remove("loading");
          showToast("ËØ≠Èü≥ÁîüÊàêÂá∫Èîô");
        }
      }

      // Êí≠ÊîæËØ≠Èü≥Ê∂àÊÅØ (onclickÁî®ÔºåPCÁ´Ø)
      async function playVoiceMessage(event, msgIndex) {
        event.stopPropagation();
        const voiceBar = event.currentTarget;
        playVoiceMessageByIndex(msgIndex, voiceBar);
      }

      // Êí≠ÊîæÈü≥È¢ë
      function playAudioFromUrl(url, voiceBar) {
        console.log("[Voice] Playing audio from URL:", url);
        const audio = new Audio(url);
        currentPlayingAudio = audio;
        currentPlayingBar = voiceBar;

        voiceBar.classList.add("playing");

        audio.oncanplaythrough = () => {
          console.log("[Voice] Audio can play through");
        };

        audio.onended = () => {
          console.log("[Voice] Audio ended");
          voiceBar.classList.remove("playing");
          currentPlayingAudio = null;
          currentPlayingBar = null;
        };

        audio.onerror = (e) => {
          console.error("[Voice] Audio error:", audio.error);
          voiceBar.classList.remove("playing");
          currentPlayingAudio = null;
          currentPlayingBar = null;
          showToast("Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•: " + (audio.error?.message || "Êú™Áü•ÈîôËØØ"));
        };

        audio
          .play()
          .then(() => {
            console.log("[Voice] Audio playing...");
          })
          .catch((e) => {
            console.error("[Voice] Audio play error:", e);
            voiceBar.classList.remove("playing");
            currentPlayingAudio = null;
            currentPlayingBar = null;
            showToast("Êí≠ÊîæÂ§±Ë¥•: " + e.message);
          });
      }

      // ÂàáÊç¢ËØ≠Èü≥ÊñáÂ≠óÊòæÁ§∫
      function toggleVoiceText(event, msgIndex) {
        event.stopPropagation();

        const history = chatHistories[currentChatCharId] || [];
        const msg = history[msgIndex];
        if (!msg) return;

        // ÂàáÊç¢Áä∂ÊÄÅ
        msg.voiceTextVisible = !msg.voiceTextVisible;
        localforage.setItem("chatHistories", chatHistories);

        // Êõ¥Êñ∞UI
        const textEl = document.getElementById(`voiceText-${msgIndex}`);
        const btn = event.currentTarget;

        if (msg.voiceTextVisible) {
          textEl.classList.add("visible");
          btn.textContent = "Êî∂Ëµ∑ÊñáÂ≠ó";
        } else {
          textEl.classList.remove("visible");
          btn.textContent = "ËΩ¨ÊñáÂ≠ó";
        }
      }

      // ==================== ËØ≠Èü≥ÂäüËÉΩ (MiniMax TTS ÂÆåÊï¥ÊúÄÁªàÁâà) ====================

      // 1. ÂÖ®Â±ÄÂèòÈáèÔºöÂè™ÂÆö‰πâ‰∏ÄÊ¨°ÔºÅ
      let voiceConfig = JSON.parse(localStorage.getItem("voiceConfig") || "{}");

      // 2. ÂàáÊç¢Á∫øË∑Ø UI
      function switchVoiceUrl(type) {
        const cnBtn = document.getElementById("voiceUrlCN");
        const intlBtn = document.getElementById("voiceUrlIntl");

        if (!cnBtn || !intlBtn) return; // Èò≤Ê≠¢Êâæ‰∏çÂà∞ÂÖÉÁ¥†Êä•Èîô

        cnBtn.classList.remove("active");
        intlBtn.classList.remove("active");

        if (type === "cn") {
          cnBtn.classList.add("active");
        } else {
          intlBtn.classList.add("active");
        }
      }

      // 3. ÂàùÂßãÂåñÂä†ËΩΩÈÖçÁΩÆ
      function loadVoiceSettings() {
        if (voiceConfig.groupId)
          document.getElementById("voiceGroupId").value = voiceConfig.groupId;
        if (voiceConfig.apiKey)
          document.getElementById("voiceApiKey").value = voiceConfig.apiKey;
        if (voiceConfig.model)
          document.getElementById("voiceModelSelect").value = voiceConfig.model;

        // Âä†ËΩΩÁ∫øË∑ØÈÄâÊã© (ÈªòËÆ§ÂõΩÂÜÖ)
        const baseUrl = voiceConfig.baseUrl || "https://api.minimax.chat";
        if (baseUrl.includes("minimaxi.chat")) {
          switchVoiceUrl("intl");
        } else {
          switchVoiceUrl("cn");
        }
      }
      // ÁõëÂê¨Âä†ËΩΩ
      document.addEventListener("DOMContentLoaded", loadVoiceSettings);

      // 4. ‰øùÂ≠òÈÖçÁΩÆ
      function saveVoiceConfig() {
        const groupId = document.getElementById("voiceGroupId").value.trim();
        const apiKey = document.getElementById("voiceApiKey").value.trim();
        const model = document.getElementById("voiceModelSelect").value;

        // Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠ÁöÑÁ∫øË∑Ø
        const intlBtn = document.getElementById("voiceUrlIntl");
        const isIntl = intlBtn && intlBtn.classList.contains("active");
        const baseUrl = isIntl
          ? "https://api.minimaxi.chat"
          : "https://api.minimax.chat";

        if (!groupId || !apiKey) {
          alert("ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑ Group ID Âíå API Key");
          return;
        }

        voiceConfig = { groupId, apiKey, model, baseUrl };
        localforage.setItem("voiceConfig", voiceConfig);
        showToast("ËØ≠Èü≥ÈÖçÁΩÆÂ∑≤‰øùÂ≠ò üéôÔ∏è");
      }
      // ==================== ‰ºòÂåñÁâàÔºögenerateSpeech (Êõ¥Ëá™ÁÑ∂ÁöÑÊñ≠Âè•) ====================
      async function generateSpeech(text, charId) {
        // 1. Ëé∑Âèñ ID Âíå Key
        let currentGroupId =
          (voiceConfig && voiceConfig.groupId) ||
          document.getElementById("voiceGroupId")?.value;
        let currentApiKey =
          (voiceConfig && voiceConfig.apiKey) ||
          document.getElementById("voiceApiKey")?.value;

        if (!currentGroupId || !currentApiKey) {
          alert("ËØ∑ÂÖàÂú® API ËÆæÁΩÆÈ°µÂ°´ÂÜô MiniMax Group ID Âíå API KeyÔºÅ");
          return null;
        }

        // 2. Ëé∑Âèñ Voice ID
        const settings = chatSettings[charId];
        let voiceId = settings?.voiceId;
        if (charId === "temp_test") {
          voiceId = document.getElementById("settingsVoiceId").value.trim();
        }

        if (!voiceId) {
          alert("ËØ∑ÂÖàÂ°´ÂÜô Voice IDÔºÅ");
          return null;
        }

        // ========== Ê†∏ÂøÉ‰ºòÂåñÔºöÊñáÊú¨Ê∏ÖÊ¥ó (Prompt ‰πüÂ∞±ÊòØÂú®ËøôÈáåË∞ÉÊï¥) ==========
        let cleanText = text;

        // 1. ÂéªÈô§Âä®‰ΩúÊèèÂÜôÂíåÂøÉÁêÜÊ¥ªÂä® (Êã¨Âè∑ÊàñÊòüÂè∑ÈáåÁöÑÂÜÖÂÆπ‰∏çËØª)
        cleanText = cleanText
          .replace(/[\(Ôºà][^\)Ôºâ]*[\)Ôºâ]/g, "")
          .replace(/\*[^\*]+\*/g, "");

        // 2. „ÄêÂÖ≥ÈîÆ„ÄëÂ§ÑÁêÜÊç¢Ë°åÁ¨¶ÔºöÊääÊç¢Ë°åÂèòÊàêÈÄóÂè∑ÔºåÈò≤Ê≠¢Áî±‰∫éÊéíÁâàÂØºËá¥ÁöÑÂ•áÊÄ™ÈïøÂÅúÈ°ø
        cleanText = cleanText.replace(/\n/g, "Ôºå");

        // 3. Â§ÑÁêÜÂèØËÉΩÂØºËá¥Âç°È°øÁöÑÁâπÊÆäÁ¨¶Âè∑
        cleanText = cleanText
          .replace(/‚Ä¶‚Ä¶/g, "Ôºå") // ÁúÅÁï•Âè∑Â§™Èïø‰ºöÂç°ÔºåÊîπÊàêÈÄóÂè∑
          .replace(/‚Ä¶/g, "Ôºå")
          .replace(/‚Äî/g, "Ôºå") // Á†¥ÊäòÂè∑ÊîπÊàêÈÄóÂè∑
          .replace(/~/g, "Èòø") // „ÄêÂ∞èÊäÄÂ∑ß„ÄëÊ≥¢Êµ™Âè∑Â¶ÇÊûúÊòØËØ≠Ê∞îËØç(Â¶Ç:Â•ΩÂìí~)ÔºåÊîπÊàê"Èòø"Êàñ"ËÄ∂"‰ºöÊõ¥Ëá™ÁÑ∂ÔºåÊàñËÄÖÁõ¥Êé•ÂéªÊéâ
          .replace(/["]/g, ""); // ÂéªÊéâÂèåÂºïÂè∑ÔºåÈò≤Ê≠¢ËØ≠Ë∞ÉÂ•áÊÄ™

        // 4. ÊúÄÂêéÂè™‰øùÁïô‰∏≠Êñá„ÄÅËã±Êñá„ÄÅÊï∞Â≠óÂíåÂü∫Êú¨Ê†áÁÇπ (Á©∫Ê†º‰øùÁïôÔºåÁî®‰∫éËã±ÊñáÂàÜËØç)
        cleanText = cleanText.replace(
          /[^\u4e00-\u9fa5a-zA-Z0-9Ôºå„ÄÇÔºÅÔºü,.?! ]/g,
          ""
        );

        // Â¶ÇÊûúÊ¥óÂÆåÊ≤°ËØç‰∫ÜÔºàÊØîÂ¶ÇÂè™Âèë‰∫Ü‰∏™Ë°®ÊÉÖÔºâÔºåÂ∞±‰∏çÁîüÊàê
        if (cleanText.trim().length < 1) return null;

        // =============================================================

        // ËæÖÂä©ÂáΩÊï∞ÔºöBlob ËΩ¨ Base64
        const blobToBase64 = (blob) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          });
        };

        const tryFetch = async (baseUrl) => {
          const url = `${baseUrl}/v1/t2a_v2?GroupId=${currentGroupId}`;
          const response = await fetch(url, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${currentApiKey}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              // „ÄêÂª∫ËÆÆ„ÄëÂ¶ÇÊûú‰Ω†ËßâÂæó Turbo Ê®°ÂûãÂ§™Âç°ÔºåÂèØ‰ª•Âú® API ËÆæÁΩÆÈáåÈÄâ speech-02-hd
              model: voiceConfig.model || "speech-01-turbo",
              text: cleanText,
              stream: false,
              voice_setting: {
                voice_id: voiceId,
                speed: 1.0,
                vol: 1.0,
                pitch: 0,
              },
              audio_setting: {
                sample_rate: 32000,
                bitrate: 128000,
                format: "mp3",
                channel: 1,
              },
            }),
          });
          return response;
        };

        try {
          const activeIntlBtn = document.getElementById("voiceUrlIntl");
          const isIntlSelected =
            activeIntlBtn && activeIntlBtn.classList.contains("active");
          let firstUrl = isIntlSelected
            ? "https://api.minimaxi.chat"
            : "https://api.minimax.chat";
          let secondUrl = isIntlSelected
            ? "https://api.minimax.chat"
            : "https://api.minimaxi.chat";

          let response = await tryFetch(firstUrl);
          if (response.status === 404) response = await tryFetch(secondUrl);

          if (!response.ok) throw new Error(`API Error ${response.status}`);
          const result = await response.json();

          if (result.base_resp && result.base_resp.status_code !== 0) {
            throw new Error(result.base_resp.status_msg);
          }

          const audioHex = result.data?.audio || result.audio;
          if (audioHex) {
            const bytes = new Uint8Array(audioHex.length / 2);
            for (let i = 0; i < audioHex.length; i += 2) {
              bytes[i / 2] = parseInt(audioHex.substr(i, 2), 16);
            }
            const blob = new Blob([bytes.buffer], { type: "audio/mp3" });
            return await blobToBase64(blob);
          }

          // Â§áÁî®ÔºöURLÂ§ÑÁêÜ
          const audioUrl = result.data?.audio_url || result.audio_url;
          if (audioUrl) {
            try {
              const urlResp = await fetch(audioUrl);
              const urlBlob = await urlResp.blob();
              return await blobToBase64(urlBlob);
            } catch (e) {
              return audioUrl;
            }
          }
          return null;
        } catch (e) {
          console.error(e);
          // ÈùôÈªòÂ§±Ë¥•Ôºå‰∏çÊâìÊâ∞Áî®Êà∑ËÅäÂ§©‰ΩìÈ™å
          return null;
        }
      }
      // 6. ËØïÂê¨ÂäüËÉΩ
      async function testCharacterVoice() {
        const voiceId = document.getElementById("settingsVoiceId").value.trim();
        if (!voiceId) {
          alert("ËØ∑ÂÖàÂ°´ÂÜô Voice ID");
          return;
        }

        const btn = document.querySelector(
          'button[onclick="testCharacterVoice()"]'
        );
        const originalText = btn.textContent;
        btn.textContent = "ÁîüÊàê‰∏≠...";
        btn.disabled = true;

        try {
          const tempCharId = "temp_test";
          // ‰∏¥Êó∂Â≠òÂÖ•ËÆæÁΩÆÔºå‰ª•‰æø generateSpeech ËØªÂèñ
          if (!chatSettings[tempCharId]) chatSettings[tempCharId] = {};
          chatSettings[tempCharId].voiceId = voiceId;

          const audioUrl = await generateSpeech(
            "‰Ω†Â•ΩÔºåÊàëÊòØ‰Ω†ÁöÑ‰∏ìÂ±ûAI‰º¥‰æ£ÔºåËøôÊòØÊàëÁöÑÂ£∞Èü≥„ÄÇ",
            tempCharId
          );

          if (audioUrl) {
            const audio = new Audio(audioUrl);
            audio.play();
            btn.textContent = "Êí≠Êîæ‰∏≠...";
            audio.onended = () => {
              btn.textContent = originalText;
              btn.disabled = false;
            };
          } else {
            btn.textContent = originalText;
            btn.disabled = false;
          }
          delete chatSettings[tempCharId];
        } catch (e) {
          alert("ËØïÂê¨Â§±Ë¥•");
          btn.textContent = originalText;
          btn.disabled = false;
        }
      }
      /* ==================== ‰øÆÂ§çÔºöÁº∫Â§±ÁöÑÂ§öÈÄâÈÄªËæëÂáΩÊï∞ ==================== */

      // 1. Êõ¥Êñ∞Â∫ïÈÉ®Â§öÈÄâÊ†è UI (‰øÆÂ§çÊòæÁ§∫ 0 Êù°ÁöÑÈóÆÈ¢ò)
      function updateSelectionUI() {
        const count = selectedIndices.size;
        const countEl = document.getElementById("selectionCount");
        const deleteBtn = document.getElementById("multiDeleteBtn");

        // Êõ¥Êñ∞ÊñáÂ≠ó
        if (countEl) {
          countEl.textContent = `Â∑≤ÈÄâ ${count} Êù°`;
        }

        // Êõ¥Êñ∞Âà†Èô§ÊåâÈíÆÁä∂ÊÄÅ (ÊúâÈÄâ‰∏≠Êó∂ÂèòÁ∫¢ÔºåÊó†ÈÄâ‰∏≠Êó∂ÂèòÁÅ∞)
        if (deleteBtn) {
          if (count > 0) {
            deleteBtn.classList.add("active"); // ËøôÈáåÁöÑ active Á±ªÂú® CSS ÈáåÊéßÂà∂ÈÄèÊòéÂ∫¶ÂíåÁÇπÂáª
            deleteBtn.style.opacity = "1";
            deleteBtn.style.pointerEvents = "auto";
          } else {
            deleteBtn.classList.remove("active");
            deleteBtn.style.opacity = "0.3";
            deleteBtn.style.pointerEvents = "none";
          }
        }
      }

      // 2. ÊâßË°åÂà†Èô§ÈÄâ‰∏≠ÁöÑÊ∂àÊÅØ (‰øÆÂ§çÂà†Èô§ÊåâÈíÆÊó†ÂèçÂ∫î)
      function deleteSelectedMessages() {
        if (selectedIndices.size === 0) return;

        if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô ${selectedIndices.size} Êù°Ê∂àÊÅØÂêóÔºü`)) {
          const history = chatHistories[currentChatCharId] || [];

          // Ê†∏ÂøÉÈÄªËæëÔºöËøáÊª§Êéâ index Âú® selectedIndices ÈáåÁöÑÊ∂àÊÅØ
          // Ê≥®ÊÑèÔºöËøôÈáåÂà©Áî® filter ‰∫ßÁîüÊñ∞Êï∞ÁªÑÔºåÈùûÂ∏∏ÂÆâÂÖ®
          const newHistory = history.filter(
            (_, index) => !selectedIndices.has(index)
          );

          // Êõ¥Êñ∞Êï∞ÊçÆ
          chatHistories[currentChatCharId] = newHistory;
          localforage.setItem("chatHistories", chatHistories);

          // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆ
          const totalMsgEl = document.getElementById("settingsTotalMsg");
          if (totalMsgEl) totalMsgEl.textContent = newHistory.length;

          // ÈÄÄÂá∫Â§öÈÄâÊ®°ÂºèÂπ∂Âà∑Êñ∞
          exitSelectionMode();
          showToast("Âà†Èô§ÊàêÂäü");
        }
      }

      // 3. Ë°•‰∏ÅÔºöÁ°Æ‰øù handleMultiSelect ËÉΩÊ≠£Á°ÆÂàùÂßãÂåñÁ¨¨‰∏ÄÊù°ÈÄâ‰∏≠
      // (Â∞ÜÂéüÊù•ÁöÑ handleMultiSelect ÊõøÊç¢ÊàñË¶ÜÁõñ‰∏∫Ëøô‰∏™Â¢ûÂº∫Áâà)
      window.handleMultiSelect = function () {
        isSelectionMode = true;
        selectedIndices.clear();

        // ÈªòËÆ§ÈÄâ‰∏≠ÈïøÊåâÁöÑÈÇ£‰∏ÄÊù°
        if (activeMsgIndex !== -1) {
          selectedIndices.add(activeMsgIndex);
        }

        // ÈöêËóèËæìÂÖ•Ê°ÜÔºåÊòæÁ§∫Âà†Èô§Ê†è
        const inputArea = document.querySelector(".conv-input-area");
        const footer = document.getElementById("selectionFooter");

        if (inputArea) inputArea.style.display = "none";
        if (footer) {
          footer.style.display = "flex"; // Âº∫Âà∂ÊòæÁ§∫
          // Á®çÂæÆÂª∂ËøüÂä† active class ‰ª•Ëß¶ÂèëÂä®ÁîªÔºàÂ¶ÇÊûúÊúâÔºâ
          setTimeout(() => footer.classList.add("active"), 10);
        }

        // ÈöêËóèÈïøÊåâËèúÂçï
        hideContextMenu();

        // Âà∑Êñ∞ UI
        updateSelectionUI(); // Á´ãÂç≥Êõ¥Êñ∞‰∏ÄÊ¨°ÊñáÂ≠ó
        renderConversation(); // ÈáçÊñ∞Ê∏≤ÊüìÊ∞îÊ≥°‰ª•ÊòæÁ§∫ÂãæÈÄâÁä∂ÊÄÅ
      };

      // 4. Ë°•‰∏ÅÔºöÁ°Æ‰øùÈÄÄÂá∫Â§öÈÄâÊó∂ UI Â§çÂéü
      window.exitSelectionMode = function () {
        isSelectionMode = false;
        selectedIndices.clear();

        // ÊÅ¢Â§çËæìÂÖ•Ê°Ü
        const inputArea = document.querySelector(".conv-input-area");
        if (inputArea) inputArea.style.display = "block";

        // ÈöêËóèÂ∫ïÈÉ®Ê†è
        const footer = document.getElementById("selectionFooter");
        if (footer) {
          footer.classList.remove("active");
          setTimeout(() => (footer.style.display = "none"), 300); // Á≠âÂä®ÁîªÊí≠ÂÆåÂÜçÈöêËóè
        }

        renderConversation();
      };
      /* ==================== ‰øÆÂ§çÔºöËØ≠Èü≥Êù°Êó†Ê≥ïÂ§öÈÄâÁöÑÈóÆÈ¢ò ==================== */

      // 1. Ë¶ÜÁõñÂéüÊúâÁöÑ playVoiceMessage ÂáΩÊï∞
      window.playVoiceMessage = async function (event, msgIndex) {
        // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÊ£ÄÊµãÊòØÂê¶Â§Ñ‰∫éÂ§öÈÄâÊ®°Âºè
        if (typeof isSelectionMode !== "undefined" && isSelectionMode) {
          // Â¶ÇÊûúÊòØÂ§öÈÄâÊ®°ÂºèÔºö
          event.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂Êâ©Êï£
          event.preventDefault(); // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫

          // ÊâãÂä®Ë∞ÉÁî®ÈÄâ‰∏≠ÈÄªËæë (ÂÅáË£ÖÊàë‰ª¨ÁÇπÂáª‰∫ÜÊ∞îÊ≥°)
          if (typeof handleBubbleClick === "function") {
            handleBubbleClick(event, msgIndex);
          }
          return; // Áõ¥Êé•ÈÄÄÂá∫Ôºå„Äê‰∏çÊí≠Êîæ„ÄëÈü≥È¢ë
        }

        // --- ‰ª•‰∏ãÊòØÂéüÊúâÁöÑÊí≠ÊîæÈÄªËæë ---
        event.stopPropagation();
        const voiceBar = event.currentTarget;
        playVoiceMessageByIndex(msgIndex, voiceBar);
      };

      // 2. Ë¶ÜÁõñÂéüÊúâÁöÑ toggleVoiceText ÂáΩÊï∞ (Èò≤Ê≠¢ÁÇπÂáª"ËΩ¨ÊñáÂ≠ó"ÊåâÈíÆ‰πüÈÄâ‰∏≠‰∏ç‰∫Ü)
      window.toggleVoiceText = function (event, msgIndex) {
        // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÊ£ÄÊµãÊòØÂê¶Â§Ñ‰∫éÂ§öÈÄâÊ®°Âºè
        if (typeof isSelectionMode !== "undefined" && isSelectionMode) {
          event.stopPropagation();
          if (typeof handleBubbleClick === "function") {
            handleBubbleClick(event, msgIndex);
          }
          return; // Áõ¥Êé•ÈÄÄÂá∫Ôºå‰∏çÂàáÊç¢ÊñáÂ≠óÊòæÁ§∫
        }

        // --- ‰ª•‰∏ãÊòØÂéüÊúâÁöÑËΩ¨ÊñáÂ≠óÈÄªËæë ---
        event.stopPropagation();

        const history = chatHistories[currentChatCharId] || [];
        const msg = history[msgIndex];
        if (!msg) return;

        // ÂàáÊç¢Áä∂ÊÄÅ
        msg.voiceTextVisible = !msg.voiceTextVisible;
        localforage.setItem("chatHistories", chatHistories);

        // Êõ¥Êñ∞UI
        const textEl = document.getElementById(`voiceText-${msgIndex}`);
        const btn = event.currentTarget;

        if (msg.voiceTextVisible) {
          textEl.classList.add("visible");
          btn.textContent = "Êî∂Ëµ∑ÊñáÂ≠ó";
        } else {
          textEl.classList.remove("visible");
          btn.textContent = "ËΩ¨ÊñáÂ≠ó";
        }
      };
      // ==================== Êñ∞Â¢ûÔºöÊõ¥Êñ∞ÂàóË°®È¢ÑËßàÊñáÂ≠ó ====================
      function updateCharacterLastMessage(charId, rawContent) {
        const charIndex = characters.findIndex((c) => c.id === charId);
        if (charIndex === -1) return;

        let previewText = rawContent;

        // 1. Âà§Êñ≠ÊòØ‰∏çÊòØËØ≠Èü≥Ê∂àÊÅØ
        if (rawContent.match(/^\[ËØ≠Èü≥[:Ôºö](.+)\]$/)) {
          previewText = "[ËØ≠Èü≥]"; // ÊàñËÄÖÊòæÁ§∫ "[ËØ≠Èü≥] ÊñáÊú¨ÂÜÖÂÆπ"
        } else {
          // 2. Ê∏ÖÊ¥ó HTML Ê†áÁ≠æ (Êää <i>ÂøÉÁêÜ</i> ÂèòÊàêÁ∫ØÊñáÊú¨)
          // Ëøô‰∏ÄÊ≠•ÂæàÈáçË¶ÅÔºåÂê¶ÂàôÂàóË°®‰ºöÊòæÁ§∫ <i>...</i>
          previewText = rawContent.replace(/<[^>]+>/g, "");

          // 3. Â§ÑÁêÜÂ∞èËØ¥Ê®°ÂºèÁöÑÊ†áËÆ∞ (Êää *Âä®‰Ωú* ÂèòÊàêÁ∫ØÊñáÊú¨)
          previewText = previewText.replace(/\*/g, "");
        }

        // Êõ¥Êñ∞Êï∞ÊçÆ
        characters[charIndex].lastMessage = previewText;
        characters[charIndex].lastTime = new Date().toLocaleTimeString(
          "zh-CN",
          { hour: "2-digit", minute: "2-digit" }
        );

        // ÁßªÂà∞ÁΩÆÈ°∂ (ÂÉèÂæÆ‰ø°‰∏ÄÊ†∑ÔºåÊúÄÊñ∞Ê∂àÊÅØÊéíÊúÄÂâç) - ÂèØÈÄâ
        // const updatedChar = characters.splice(charIndex, 1)[0];
        // characters.unshift(updatedChar);

        localforage.setItem("characters", characters);
        renderCharacters(); // Âà∑Êñ∞ÂàóË°®ÁïåÈù¢
      }
      /* ==================== Â∫ïÈÉ®ËèúÂçï‰∏éË°®ÊÉÖÂäüËÉΩ ==================== */
      /* ==================== ÂÖ®Êñ∞ÔºöËá™ÂÆö‰πâË°®ÊÉÖÂåÖÂäüËÉΩ (Pro MaxÁâà) ==================== */

      // ÂÖ®Â±ÄÂèòÈáè
      window.customStickers = []; // Â≠òÂÖ∑‰ΩìË°®ÊÉÖÂØπË±° {id, src, desc, category}
      window.stickerCategories = []; // Â≠òÂàÜÁ±ªÂàóË°® ["ÈªòËÆ§", "ÂºÄÂøÉ", ...]
      window.currentCategory = "ÈªòËÆ§";
      window.aiStickerBindings = {}; // ÊØè‰∏™ËßíËâ≤ÁªëÂÆöÁöÑÂàÜÁ±ª {charId: ["ÂàÜÁ±ª1", "ÂàÜÁ±ª2", ...]} // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÂàÜÁ±ª

      // 1. ÂàùÂßãÂåñÂä†ËΩΩ
      async function initStickerPanel() {
        try {
          // ËØªÂèñÊï∞ÊçÆ
          const savedStickers = await localforage.getItem("customStickers");
          const savedCategories = await localforage.getItem(
            "stickerCategories"
          );

          // === Êï∞ÊçÆËøÅÁßªÈÄªËæë (Èò≤Ê≠¢ÊóßÁî®Êà∑Êä•Èîô) ===
          if (Array.isArray(savedStickers) && savedStickers.length > 0) {
            // Ê£ÄÊü•ÊòØ‰∏çÊòØÊóßÁöÑÂ≠óÁ¨¶‰∏≤Ê†ºÂºè
            if (typeof savedStickers[0] === "string") {
              console.log("Ê≠£Âú®ËøÅÁßªÊóßÁâàË°®ÊÉÖÂåÖÊï∞ÊçÆ...");
              window.customStickers = savedStickers.map((src) => ({
                id: Date.now() + Math.random(),
                src: src,
                desc: "Ë°®ÊÉÖÂåÖ", // ÊóßÊï∞ÊçÆÈªòËÆ§ÊèèËø∞
                category: "ÈªòËÆ§",
              }));
            } else {
              window.customStickers = savedStickers;
            }
          } else {
            window.customStickers = [];
          }

          // ÂàùÂßãÂåñÂàÜÁ±ª
          window.stickerCategories = savedCategories || ["ÈªòËÆ§"];

          // Á°Æ‰øù‚ÄúÈªòËÆ§‚ÄùÂàÜÁ±ªÊ∞∏ËøúÂ≠òÂú®
          if (!window.stickerCategories.includes("ÈªòËÆ§")) {
            window.stickerCategories.unshift("ÈªòËÆ§");
          }

          // ÁºñËæëÊ®°ÂºèÊ†áËÆ∞
          window.stickerEditMode = false;
          // ÈÄâ‰∏≠ÁöÑË°®ÊÉÖÂåÖIDÂàóË°®
          window.selectedStickerIds = [];
          // ÊêúÁ¥¢ÂÖ≥ÈîÆËØç
          window.stickerSearchKeyword = "";
          // AIÁªëÂÆöÁöÑÂàÜÁ±ªÔºà‰ªéÊú¨Âú∞Â≠òÂÇ®ËØªÂèñÔºâ
          const savedAiCat = await localforage.getItem("aiStickerCategory");
          // AIÁªëÂÆöÊï∞ÊçÆÔºàÊñ∞ÁâàÔºöÊØè‰∏™ËßíËâ≤ÂèØÁªëÂÆöÂ§ö‰∏™ÂàÜÁ±ªÔºâ
          const savedBindings = await localforage.getItem("aiStickerBindings");
          window.aiStickerBindings = savedBindings || {};

          // ËøÅÁßªÊóßÁâàÂçï‰∏ÄÁªëÂÆöÊï∞ÊçÆ
          const oldSingleBinding = await localforage.getItem(
            "aiStickerCategory"
          );
          if (
            oldSingleBinding &&
            Object.keys(window.aiStickerBindings).length === 0
          ) {
            window.aiStickerBindings["__global__"] = [oldSingleBinding];
            await localforage.setItem(
              "aiStickerBindings",
              window.aiStickerBindings
            );
            await localforage.removeItem("aiStickerCategory");
            console.log("Â∑≤ËøÅÁßªÊóßÁâàAIÁªëÂÆöÊï∞ÊçÆ");
          }
        } catch (e) {
          console.error("Ë°®ÊÉÖÂåÖÂä†ËΩΩÂ§±Ë¥•", e);
          window.customStickers = [];
          window.stickerCategories = ["ÈªòËÆ§"];
          window.aiStickerBindings = {};
        }

        renderStickerPanel();
      }

      // È°µÈù¢Âä†ËΩΩÊó∂ÂêØÂä®
      document.addEventListener("DOMContentLoaded", initStickerPanel);

      // 2. Ê∏≤ÊüìÊï¥‰∏™Èù¢Êùø (ÂàÜÁ±ªÊ†è + ÁΩëÊ†º)
      function renderStickerPanel() {
        renderCategoryBar();
        renderStickerGrid();
      }

      // 2.1 Ê∏≤ÊüìÂàÜÁ±ªÊ†è
      function renderCategoryBar() {
        const bar = document.getElementById("stickerCategoryBar");
        if (!bar) return;

        let html = "";
        const isEdit = window.stickerEditMode;
        const isSearching =
          window.stickerSearchKeyword &&
          window.stickerSearchKeyword.trim() !== "";

        if (isEdit) {
          // ÁºñËæëÊ®°ÂºèÔºöÊòæÁ§∫ÂÖ®ÈÄâÂíåÂà†Èô§ÊåâÈíÆ
          const currentStickers = window.customStickers.filter(
            (s) => s.category === window.currentCategory
          );
          const currentIds = currentStickers.map((s) => s.id);
          const selectedIds = window.selectedStickerIds || [];
          const allSelected =
            currentIds.length > 0 &&
            currentIds.every((id) => selectedIds.includes(id));

          html += `<button class="edit-action-btn select-all" onclick="toggleSelectAll()">${
            allSelected ? "ÂèñÊ∂àÂÖ®ÈÄâ" : "ÂÖ®ÈÄâ"
          }</button>`;
          html += `<button class="edit-action-btn delete-btn" id="batchDeleteBtn" onclick="deleteSelectedStickers()" ${
            selectedIds.length === 0 ? "disabled" : ""
          }>Âà†Èô§${
            selectedIds.length > 0 ? " (" + selectedIds.length + ")" : ""
          }</button>`;
          html += `<span class="edit-spacer"></span>`;
        }

        // ÊêúÁ¥¢Ê®°Âºè‰∏ãÊòæÁ§∫ËøîÂõûÊåâÈíÆ
        if (isSearching && !isEdit) {
          html += `<button class="edit-action-btn" onclick="clearStickerSearch()" style="background:#fff3e0;color:#f57c00;">‚Üê ËøîÂõû</button>`;
        }

        // Ëé∑ÂèñÂΩìÂâçËßíËâ≤ÁöÑÁªëÂÆöÂàÜÁ±ªÔºàÁ°Æ‰øù‰ΩøÁî®Â≠óÁ¨¶‰∏≤Á±ªÂûãÁöÑcharIdÔºâ
        const charId = currentChatCharId
          ? String(currentChatCharId)
          : "__global__";
        const boundCategories = window.aiStickerBindings[charId] || [];

        // Ê∏≤ÊüìÊâÄÊúâÂàÜÁ±ªÊ†áÁ≠æ
        window.stickerCategories.forEach((cat) => {
          const activeClass = cat === window.currentCategory ? "active" : "";
          const aiClass = boundCategories.includes(cat) ? "ai-bound" : "";

          if (isEdit && cat !== "ÈªòËÆ§") {
            // ÁºñËæëÊ®°ÂºèÔºöÊòæÁ§∫Âà†Èô§ÊåâÈíÆ
            html += `<div class="category-tab ${activeClass} ${aiClass} editing">
              <span onclick="switchCategory('${cat}')">${cat}</span>
              <span class="cat-delete-btn" onclick="event.stopPropagation();deleteCategory('${cat}')">‚úï</span>
            </div>`;
          } else if (isEdit && cat === "ÈªòËÆ§") {
            html += `<div class="category-tab ${activeClass} ${aiClass}" onclick="switchCategory('${cat}')">${cat}</div>`;
          } else {
            html += `<div class="category-tab ${activeClass} ${aiClass}" onclick="switchCategory('${cat}')">${cat}</div>`;
          }
        });

        // ÈùûÁºñËæëÊ®°ÂºèÊòæÁ§∫Ê∑ªÂä†ÂàÜÁ±ªÊåâÈíÆÂíåAIÁªëÂÆöÊåâÈíÆ
        if (!isEdit && !isSearching) {
          html += `<button class="category-add-btn" onclick="addCategory()">Ôºã</button>`;
          // AIÁªëÂÆöÊåâÈíÆÔºàÁÆÄÊ¥ÅÈ£éÊ†ºÔºâ
          const hasBindings = boundCategories.length > 0;
          html += `<button class="ai-bind-btn ${
            hasBindings ? "has-bindings" : ""
          }" onclick="openAiBindModal()">
            üîó ${hasBindings ? boundCategories.length : ""}
          </button>`;
        }

        // ÁºñËæëÊåâÈíÆ
        if (!isSearching) {
          const editBtnText = isEdit ? "ÂÆåÊàê" : "ÁºñËæë";
          html += `<button class="category-edit-btn" onclick="toggleStickerEditMode()">${editBtnText}</button>`;
        }

        bar.innerHTML = html;
      }

      // 2.2 Ê∏≤ÊüìË°®ÊÉÖÁΩëÊ†º
      function renderStickerGrid() {
        const grid = document.getElementById("stickerGrid");
        if (!grid) return;

        const isEdit = window.stickerEditMode;
        const selectedIds = window.selectedStickerIds || [];
        const keyword = (window.stickerSearchKeyword || "")
          .trim()
          .toLowerCase();
        const isSearching = keyword !== "";

        let stickersToShow;

        if (isSearching) {
          // ÊêúÁ¥¢Ê®°ÂºèÔºöÊêúÁ¥¢ÊâÄÊúâÂàÜÁ±ª
          stickersToShow = window.customStickers.filter((s) =>
            (s.desc || "").toLowerCase().includes(keyword)
          );
        } else {
          // Ê≠£Â∏∏Ê®°ÂºèÔºöÂè™ÊòæÁ§∫ÂΩìÂâçÂàÜÁ±ª
          stickersToShow = window.customStickers.filter(
            (s) => s.category === window.currentCategory
          );
        }

        let html = "";

        // ÈùûÁºñËæëÊ®°Âºè‰∏îÈùûÊêúÁ¥¢Ê®°ÂºèÊâçÊòæÁ§∫ÂØºÂÖ•ÊåâÈíÆ
        if (!isEdit && !isSearching) {
          // ÊåâÈíÆÔºöÂØºÂÖ•
          html += `
          <div class="sticker-item" onclick="document.getElementById('stickerInput').click()">
              <div class="sticker-add-btn">
                  <div class="sticker-add-icon">üìÇ</div>
                  <div class="sticker-add-text">ÂØºÂÖ•</div>
              </div>
              <div class="sticker-desc">ÊîØÊåÅÁõ∏ÂÜå/TXT</div>
          </div>
      `;

          // ÊåâÈíÆÔºöÁ≤òË¥¥ÈìæÊé•
          html += `
          <div class="sticker-item" onclick="importStickersFromUrl()">
              <div class="sticker-add-btn">
                  <div class="sticker-add-icon">üîó</div>
                  <div class="sticker-add-text">ÈìæÊé•</div>
              </div>
              <div class="sticker-desc">ÁΩëÁªúÂõæÁâá</div>
          </div>
      `;
        }

        // ÊêúÁ¥¢ÁªìÊûú‰∏∫Á©∫ÊèêÁ§∫
        if (isSearching && stickersToShow.length === 0) {
          html += `<div class="sticker-empty-hint">Ê≤°ÊúâÊâæÂà∞"${keyword}"Áõ∏ÂÖ≥ÁöÑË°®ÊÉÖÂåÖ</div>`;
        }

        // Ê∏≤ÊüìË°®ÊÉÖÂàóË°® (ÂÄíÂ∫èÔºåÊñ∞ÁöÑÂú®Ââç)
        stickersToShow
          .slice()
          .reverse()
          .forEach((sticker) => {
            if (isEdit) {
              // ÁºñËæëÊ®°ÂºèÔºöÊòæÁ§∫ÈÄâÊã©Ê°Ü
              const isSelected = selectedIds.includes(sticker.id);
              const selectedClass = isSelected ? "selected" : "";
              html += `
              <div class="sticker-item editing ${selectedClass}" onclick="toggleStickerSelect('${
                sticker.id
              }')">
                  <div class="sticker-img-box">
                      <img src="${sticker.src}" loading="lazy">
                      <div class="sticker-select-mark">${
                        isSelected ? "‚úì" : ""
                      }</div>
                  </div>
                  <div class="sticker-desc">${sticker.desc || "Ë°®ÊÉÖ"}</div>
              </div>
          `;
            } else {
              // Ê≠£Â∏∏Ê®°Âºè
              html += `
              <div class="sticker-item" 
                   onclick="sendSticker('${sticker.id}')">
                  <div class="sticker-img-box">
                      <img src="${sticker.src}" loading="lazy">
                  </div>
                  <div class="sticker-desc">${sticker.desc || "Ë°®ÊÉÖ"}</div>
              </div>
          `;
            }
          });

        grid.innerHTML = html;
      }

      // 3. ÂàáÊç¢ÂàÜÁ±ª
      function switchCategory(cat) {
        window.currentCategory = cat;
        renderStickerPanel();
      }

      // 4. Ê∑ªÂä†Êñ∞ÂàÜÁ±ª
      async function addCategory() {
        const name = prompt("ËØ∑ËæìÂÖ•Êñ∞ÂàÜÁ±ªÂêçÁß∞ÔºàÂ¶ÇÔºöÁå´Áå´Â§¥ÔºâÔºö");
        if (!name) return;

        if (window.stickerCategories.includes(name)) {
          alert("Ëøô‰∏™ÂàÜÁ±ªÂ∑≤ÁªèÊúâ‰∫ÜÔºÅ");
          return;
        }

        window.stickerCategories.push(name);
        await localforage.setItem(
          "stickerCategories",
          window.stickerCategories
        );

        // Ëá™Âä®ÂàáÊç¢Âà∞Êñ∞ÂàÜÁ±ª
        switchCategory(name);
      }

      // 5. Âà†Èô§ÂàÜÁ±ª
      async function deleteCategory(cat) {
        if (cat === "ÈªòËÆ§") return;

        if (
          confirm(
            `Á°ÆÂÆöË¶ÅÂà†Èô§ÂàÜÁ±ª"${cat}"ÂêóÔºü
ËØ•ÂàÜÁ±ª‰∏ãÁöÑË°®ÊÉÖÂåÖ‰ºöÁßªÂä®Âà∞"ÈªòËÆ§"ÂàÜÁ±ª„ÄÇ`
          )
        ) {
          // ÊääËØ•ÂàÜÁ±ª‰∏ãÁöÑË°®ÊÉÖÁßªÂä®Âà∞ÈªòËÆ§
          window.customStickers.forEach((s) => {
            if (s.category === cat) s.category = "ÈªòËÆ§";
          });

          // ÁßªÈô§ÂàÜÁ±ª
          window.stickerCategories = window.stickerCategories.filter(
            (c) => c !== cat
          );

          // ‰øùÂ≠ò
          await Promise.all([
            localforage.setItem("customStickers", window.customStickers),
            localforage.setItem("stickerCategories", window.stickerCategories),
          ]);

          // ÂàáÊç¢ÂõûÈªòËÆ§
          switchCategory("ÈªòËÆ§");
          showToast("ÂàÜÁ±ªÂ∑≤Âà†Èô§");
        }
      }

      // ÂàáÊç¢ÁºñËæëÊ®°Âºè
      function toggleStickerEditMode() {
        window.stickerEditMode = !window.stickerEditMode;
        // ÈÄÄÂá∫ÁºñËæëÊ®°ÂºèÊó∂Ê∏ÖÁ©∫ÈÄâ‰∏≠
        if (!window.stickerEditMode) {
          window.selectedStickerIds = [];
        }
        renderStickerPanel();
      }

      // ÂàáÊç¢ÈÄâ‰∏≠Áä∂ÊÄÅ
      function toggleStickerSelect(id) {
        const numId = Number(id);
        if (!window.selectedStickerIds) {
          window.selectedStickerIds = [];
        }
        const idx = window.selectedStickerIds.indexOf(numId);
        if (idx === -1) {
          window.selectedStickerIds.push(numId);
        } else {
          window.selectedStickerIds.splice(idx, 1);
        }
        renderStickerGrid();
        updateDeleteBtnState();
      }

      // ÂÖ®ÈÄâ/ÂèñÊ∂àÂÖ®ÈÄâÂΩìÂâçÂàÜÁ±ªÁöÑË°®ÊÉÖ
      function toggleSelectAll() {
        const currentStickers = window.customStickers.filter(
          (s) => s.category === window.currentCategory
        );
        const currentIds = currentStickers.map((s) => s.id);

        // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÂÖ®ÈÄâ
        const allSelected = currentIds.every(
          (id) =>
            window.selectedStickerIds && window.selectedStickerIds.includes(id)
        );

        if (allSelected) {
          // ÂèñÊ∂àÂÖ®ÈÄâÔºöÁßªÈô§ÂΩìÂâçÂàÜÁ±ªÁöÑÊâÄÊúâid
          window.selectedStickerIds = (window.selectedStickerIds || []).filter(
            (id) => !currentIds.includes(id)
          );
        } else {
          // ÂÖ®ÈÄâÔºöÊ∑ªÂä†ÂΩìÂâçÂàÜÁ±ªÁöÑÊâÄÊúâid
          if (!window.selectedStickerIds) window.selectedStickerIds = [];
          currentIds.forEach((id) => {
            if (!window.selectedStickerIds.includes(id)) {
              window.selectedStickerIds.push(id);
            }
          });
        }
        renderStickerGrid();
        updateDeleteBtnState();
      }

      // Êõ¥Êñ∞Âà†Èô§ÊåâÈíÆÁä∂ÊÄÅ
      function updateDeleteBtnState() {
        const btn = document.getElementById("batchDeleteBtn");
        const count = (window.selectedStickerIds || []).length;
        if (btn) {
          btn.textContent = count > 0 ? `Âà†Èô§ (${count})` : "Âà†Èô§";
          btn.disabled = count === 0;
        }
      }

      // ÊâπÈáèÂà†Èô§ÈÄâ‰∏≠ÁöÑË°®ÊÉÖÂåÖ
      async function deleteSelectedStickers() {
        const count = (window.selectedStickerIds || []).length;
        if (count === 0) {
          showToast("ËØ∑ÂÖàÈÄâÊã©Ë°®ÊÉÖÂåÖ");
          return;
        }

        if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${count} ‰∏™Ë°®ÊÉÖÂåÖÂêóÔºü`)) return;

        window.customStickers = window.customStickers.filter(
          (s) => !window.selectedStickerIds.includes(s.id)
        );
        await localforage.setItem("customStickers", window.customStickers);
        window.selectedStickerIds = [];
        renderStickerGrid();
        updateDeleteBtnState();
        showToast(`Â∑≤Âà†Èô§ ${count} ‰∏™Ë°®ÊÉÖÂåÖ`);
      }

      // Âà†Èô§Âçï‰∏™Ë°®ÊÉÖÂåÖÔºà‰øùÁïôÂÖºÂÆπÔºâ
      async function deleteStickerById(id) {
        // ËΩ¨Êç¢‰∏∫Êï∞Â≠óÁ±ªÂûãËøõË°åÊØîËæÉÔºàÂõ†‰∏∫idÊòØDate.now()+Math.random()ÁîüÊàêÁöÑÊï∞Â≠óÔºâ
        const numId = Number(id);
        window.customStickers = window.customStickers.filter(
          (s) => s.id !== numId
        );
        await localforage.setItem("customStickers", window.customStickers);
        // ÂêåÊó∂‰ªéÈÄâ‰∏≠ÂàóË°®ÁßªÈô§
        if (window.selectedStickerIds) {
          window.selectedStickerIds = window.selectedStickerIds.filter(
            (id) => id !== numId
          );
        }
        renderStickerGrid();
        showToast("Â∑≤Âà†Èô§");
      }

      // ==================== ÊêúÁ¥¢ÂäüËÉΩ ====================
      function handleStickerSearch(value) {
        window.stickerSearchKeyword = value;
        // ÊòæÁ§∫/ÈöêËóèÊ∏ÖÈô§ÊåâÈíÆ
        const clearBtn = document.getElementById("stickerSearchClear");
        if (clearBtn) {
          clearBtn.classList.toggle("show", value.trim() !== "");
        }
        renderStickerPanel();
      }

      function clearStickerSearch() {
        window.stickerSearchKeyword = "";
        const input = document.getElementById("stickerSearchInput");
        if (input) input.value = "";
        const clearBtn = document.getElementById("stickerSearchClear");
        if (clearBtn) clearBtn.classList.remove("show");
        renderStickerPanel();
      }

      // ==================== AIË°®ÊÉÖÂåÖÁªëÂÆöÂäüËÉΩÔºàÊñ∞ÁâàÔºöÂ§öÂàÜÁ±ª+ÊØèËßíËâ≤Ôºâ====================

      // ÊâìÂºÄAIÁªëÂÆöÂºπÁ™ó
      function openAiBindModal() {
        // Ê£ÄÊü•ÊòØÂê¶Âú®ÂØπËØù‰∏≠ÔºàÁ°Æ‰øù‰ΩøÁî®Â≠óÁ¨¶‰∏≤Á±ªÂûãÁöÑcharIdÔºâ
        const charId = currentChatCharId ? String(currentChatCharId) : null;
        const charName = charId
          ? characters.find((c) => String(c.id) === charId)?.name || "ÂΩìÂâçËßíËâ≤"
          : null;

        // Ëé∑ÂèñÂΩìÂâçËßíËâ≤ÁöÑÁªëÂÆöÔºàÊ≥®ÊÑèÔºöË¶ÅÊ∑±Êã∑Ë¥ùÔºåÈÅøÂÖçÂºïÁî®ÈóÆÈ¢òÔºâ
        const currentBindings = window.aiStickerBindings[charId] || [];
        const boundCategories = [...currentBindings]; // Ê∑±Êã∑Ë¥ù

        // ‰øùÂ≠òÂΩìÂâçÊ≠£Âú®ÁºñËæëÁöÑËßíËâ≤IDÂíåÂàùÂßãÈÄâ‰∏≠Áä∂ÊÄÅ
        window._tempAiBindCharId = charId;
        window._tempAiBindCategories = [...boundCategories];

        console.log(
          "ÊâìÂºÄÁªëÂÆöÂºπÁ™ó - ËßíËâ≤ID:",
          charId,
          "ÂΩìÂâçÁªëÂÆö:",
          boundCategories
        );

        // ÂàõÂª∫ÂºπÁ™óHTML
        let modalHtml = `
          <div class="ai-bind-modal-overlay" id="aiBindModalOverlay" onclick="if(event.target===this)closeAiBindModal()">
            <div class="ai-bind-modal">
              <div class="ai-bind-modal-header">
                <div>
                  <div class="ai-bind-modal-title">üîó ÁªëÂÆöË°®ÊÉÖÂåÖ</div>
                  <div class="ai-bind-modal-subtitle">${
                    charName
                      ? `‰∏∫„Äå${charName}„ÄçÈÄâÊã©Ë°®ÊÉÖÂåÖ`
                      : "ËØ∑ÂÖàÊâìÂºÄ‰∏Ä‰∏™ÂØπËØù"
                  }</div>
                </div>
                <button class="ai-bind-modal-close" onclick="closeAiBindModal()">‚úï</button>
              </div>
              <div class="ai-bind-modal-body">
        `;

        if (!charId) {
          modalHtml += `<div class="ai-bind-empty-hint">üí° ËØ∑ÂÖàËøõÂÖ•‰∏Ä‰∏™ËßíËâ≤ÁöÑÂØπËØùÔºå<br>ÁÑ∂ÂêéÂÜçÊù•ÁªëÂÆöË°®ÊÉÖÂåÖ</div>`;
        } else if (window.stickerCategories.length === 0) {
          modalHtml += `<div class="ai-bind-empty-hint">ÊöÇÊó†Ë°®ÊÉÖÂàÜÁ±ª<br>ËØ∑ÂÖàÊ∑ªÂä†‰∏Ä‰∫õË°®ÊÉÖÂåÖ</div>`;
        } else {
          modalHtml += `<div class="ai-bind-char-hint">üí° ÊØè‰∏™ËßíËâ≤ÂèØ‰ª•ÁªëÂÆö‰∏çÂêåÁöÑË°®ÊÉÖÂåÖÂàÜÁ±ª</div>`;

          window.stickerCategories.forEach((cat) => {
            const count = window.customStickers.filter(
              (s) => s.category === cat
            ).length;
            const isSelected = boundCategories.includes(cat);
            modalHtml += `
              <div class="ai-bind-category-item ${
                isSelected ? "selected" : ""
              }" onclick="toggleAiBindCategory('${cat}')">
                <div class="ai-bind-category-checkbox">${
                  isSelected ? "‚úì" : ""
                }</div>
                <div class="ai-bind-category-info">
                  <div class="ai-bind-category-name">${cat}</div>
                  <div class="ai-bind-category-count">${count} ‰∏™Ë°®ÊÉÖ</div>
                </div>
              </div>
            `;
          });
        }

        modalHtml += `
              </div>
              <div class="ai-bind-modal-footer">
                <button class="ai-bind-modal-btn cancel" onclick="closeAiBindModal()">ÂèñÊ∂à</button>
                <button class="ai-bind-modal-btn confirm" onclick="saveAiBindings()" ${
                  !charId ? "disabled" : ""
                }>Á°ÆÂÆö</button>
              </div>
            </div>
          </div>
        `;

        // ÁßªÈô§ÊóßÂºπÁ™óÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
        const oldModal = document.getElementById("aiBindModalOverlay");
        if (oldModal) oldModal.remove();

        // ÊèíÂÖ•ÂºπÁ™ó
        document.body.insertAdjacentHTML("beforeend", modalHtml);

        // ÊòæÁ§∫ÂºπÁ™ó
        setTimeout(() => {
          document.getElementById("aiBindModalOverlay").classList.add("active");
        }, 10);
      }

      // ÂÖ≥Èó≠AIÁªëÂÆöÂºπÁ™ó
      function closeAiBindModal() {
        const modal = document.getElementById("aiBindModalOverlay");
        if (modal) {
          modal.classList.remove("active");
          setTimeout(() => modal.remove(), 200);
        }
        // Ê∏ÖÁêÜÊâÄÊúâ‰∏¥Êó∂ÂèòÈáè
        window._tempAiBindCategories = null;
        window._tempAiBindCharId = null;
      }

      // ÂàáÊç¢ÂàÜÁ±ªÈÄâ‰∏≠Áä∂ÊÄÅ
      function toggleAiBindCategory(cat) {
        if (!window._tempAiBindCategories) window._tempAiBindCategories = [];

        const index = window._tempAiBindCategories.indexOf(cat);
        if (index > -1) {
          window._tempAiBindCategories.splice(index, 1);
        } else {
          window._tempAiBindCategories.push(cat);
        }

        // Êõ¥Êñ∞UI
        const items = document.querySelectorAll(".ai-bind-category-item");
        items.forEach((item) => {
          const name = item.querySelector(".ai-bind-category-name").textContent;
          const isSelected = window._tempAiBindCategories.includes(name);
          item.classList.toggle("selected", isSelected);
          item.querySelector(".ai-bind-category-checkbox").textContent =
            isSelected ? "‚úì" : "";
        });
      }

      // ‰øùÂ≠òÁªëÂÆö
      async function saveAiBindings() {
        // ‰ΩøÁî®ÊâìÂºÄÂºπÁ™óÊó∂‰øùÂ≠òÁöÑËßíËâ≤IDÔºåËÄå‰∏çÊòØÂΩìÂâçÂèØËÉΩÂ∑≤ÊîπÂèòÁöÑËßíËâ≤ID
        const charId = window._tempAiBindCharId;
        if (!charId) {
          showToast("ËØ∑ÂÖàÊâìÂºÄ‰∏Ä‰∏™ÂØπËØù");
          return;
        }

        const selectedCategories = window._tempAiBindCategories || [];

        console.log(
          "‰øùÂ≠òÁªëÂÆö - ËßíËâ≤ID:",
          charId,
          "ÈÄâ‰∏≠ÂàÜÁ±ª:",
          selectedCategories
        );
        console.log(
          "‰øùÂ≠òÂâçÁöÑÁªëÂÆöÊï∞ÊçÆ:",
          JSON.stringify(window.aiStickerBindings)
        );

        // Êõ¥Êñ∞ÁªëÂÆöÔºà‰ΩøÁî®Â≠óÁ¨¶‰∏≤charId‰Ωú‰∏∫ÈîÆÔºåÊ∑±Êã∑Ë¥ùÊï∞ÁªÑÔºâ
        if (selectedCategories.length > 0) {
          window.aiStickerBindings[charId] = [...selectedCategories];
        } else {
          delete window.aiStickerBindings[charId];
        }

        console.log(
          "‰øùÂ≠òÂêéÁöÑÁªëÂÆöÊï∞ÊçÆ:",
          JSON.stringify(window.aiStickerBindings)
        );

        // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
        await localforage.setItem(
          "aiStickerBindings",
          window.aiStickerBindings
        );

        // ÁªüËÆ°Ë°®ÊÉÖÊï∞Èáè
        const totalCount = selectedCategories.reduce((sum, cat) => {
          return (
            sum + window.customStickers.filter((s) => s.category === cat).length
          );
        }, 0);

        if (selectedCategories.length > 0) {
          showToast(
            `Â∑≤ÁªëÂÆö ${selectedCategories.length} ‰∏™ÂàÜÁ±ªÔºà${totalCount} ‰∏™Ë°®ÊÉÖÔºâ`
          );
        } else {
          showToast("Â∑≤Ê∏ÖÈô§Ë°®ÊÉÖÂåÖÁªëÂÆö");
        }

        closeAiBindModal();
        renderCategoryBar();
      }

      // Ëé∑ÂèñAIÂèØÁî®ÁöÑË°®ÊÉÖÂåÖÂàóË°®Ôºà‰æõAIË∞ÉÁî®Ôºâ- Êñ∞ÁâàÊîØÊåÅÂ§öÂàÜÁ±ª
      function getAiStickers() {
        // Á°Æ‰øù‰ΩøÁî®Â≠óÁ¨¶‰∏≤Á±ªÂûãÁöÑcharId
        const charId = currentChatCharId
          ? String(currentChatCharId)
          : "__global__";
        const boundCategories = window.aiStickerBindings[charId] || [];

        if (boundCategories.length === 0) return [];

        return window.customStickers.filter((s) =>
          boundCategories.includes(s.category)
        );
      }

      // AIÂèëÈÄÅË°®ÊÉÖÂåÖÔºàÊ†πÊçÆÊèèËø∞ÂåπÈÖçÔºâ
      function getAiStickerByKeyword(keyword) {
        const stickers = getAiStickers();
        if (stickers.length === 0) return null;

        // ‰ºòÂÖàÁ≤æÁ°ÆÂåπÈÖç
        let match = stickers.find(
          (s) => s.desc && s.desc.toLowerCase() === keyword.toLowerCase()
        );
        if (match) return match;

        // Ê®°Á≥äÂåπÈÖç
        match = stickers.find(
          (s) => s.desc && s.desc.toLowerCase().includes(keyword.toLowerCase())
        );
        if (match) return match;

        // ÈöèÊú∫ËøîÂõû‰∏Ä‰∏™
        return stickers[Math.floor(Math.random() * stickers.length)];
      }

      // Â§ÑÁêÜAIÂõûÂ§ç‰∏≠ÁöÑË°®ÊÉÖÂåÖÊ†áÁ≠æ [sticker:xxx]
      function processAiStickerTags(text) {
        if (!text) return text;

        // ÂåπÈÖç [sticker:xxx] Êàñ [Ë°®ÊÉÖ:xxx] Êàñ [Ë°®ÊÉÖÂåÖ:xxx] Ê†ºÂºè
        const stickerRegex = /\[(sticker|Ë°®ÊÉÖ|Ë°®ÊÉÖÂåÖ)[Ôºö:]\s*([^\]]+)\]/gi;

        return text.replace(stickerRegex, (match, type, keyword) => {
          const sticker = getAiStickerByKeyword(keyword.trim());
          if (sticker) {
            return `<img src="${sticker.src}" class="sticker-img" alt="${
              sticker.desc || "Ë°®ÊÉÖ"
            }" onclick="showFullImage('${sticker.src}')">`;
          }
          // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂåπÈÖçÁöÑË°®ÊÉÖÂåÖÔºåËøîÂõûÂéüÊñáÊú¨
          return match;
        });
      }

      // ÁîüÊàêAIË°®ÊÉÖÂåÖÊèêÁ§∫ËØçÔºàÁî®‰∫éÂèëÈÄÅÁªôAIÁöÑsystem promptÔºâ
      function generateAiStickerPrompt() {
        const stickers = getAiStickers();
        if (stickers.length === 0) return "";

        const stickerList = stickers.map((s) => s.desc || "Ë°®ÊÉÖ").join("„ÄÅ");
        return `\n\n„ÄêË°®ÊÉÖÂåÖÂäüËÉΩ„Äë‰Ω†ÂèØ‰ª•Âú®ÂõûÂ§ç‰∏≠‰ΩøÁî®Ë°®ÊÉÖÂåÖÊù•Ë°®ËææÊÉÖÁª™ÔºÅ‰ΩøÁî®Ê†ºÂºèÔºö[sticker:Ë°®ÊÉÖÂêçÁß∞]
ÂèØÁî®ÁöÑË°®ÊÉÖÂåÖÊúâÔºö${stickerList}
‰æãÂ¶ÇÔºö[sticker:ÂºÄÂøÉ] Êàñ [sticker:ÂÆ≥Áæû]
ËØ∑Ê†πÊçÆÂØπËØùÊÉÖÂ¢ÉËá™ÁÑ∂Âú∞‰ΩøÁî®Ë°®ÊÉÖÂåÖÔºå‰ΩÜ‰∏çË¶ÅËøáÂ∫¶‰ΩøÁî®„ÄÇ`;
      }

      // 6. ÂØºÂÖ•ÈÄªËæë (ÂçáÁ∫ßÁâàÔºöÊîØÊåÅËá™Âä®ËØÜÂà´ TXT ÊèèËø∞)
      async function handleStickerImport(input) {
        const files = Array.from(input.files);
        if (files.length === 0) return;

        // ÈªòËÆ§ÊèèËø∞Ôºà‰ªÖ‰Ωú‰∏∫ÂÖúÂ∫ïÔºâ
        let fallbackDesc = null;

        let addedCount = 0;
        showToast("Ê≠£Âú®Â§ÑÁêÜ...");

        for (const file of files) {
          let newStickers = [];

          // === ÊÉÖÂÜµA: TXTÊñá‰ª∂ (Êô∫ËÉΩËß£Êûê) ===
          if (file.name.endsWith(".txt") || file.type === "text/plain") {
            const text = await readFileAsText(file);
            // ‰ΩøÁî®Êñ∞ÂÜôÁöÑËß£ÊûêÂáΩÊï∞
            const parsedItems = parseStickersFromText(text);

            // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂÖúÂ∫ïÊèèËø∞ÔºàÂ¶ÇÊûúËß£ÊûêÂá∫Êù•ÁöÑ desc ÈÉΩÊòØÁ©∫ÁöÑÔºâ
            const needFallback = parsedItems.some((item) => !item.desc);
            if (needFallback && !fallbackDesc) {
              fallbackDesc =
                prompt(`ÈÉ®ÂàÜÂõæÁâáÊú™ËØÜÂà´Âà∞ÂêçÁß∞ÔºåËØ∑ËæìÂÖ•ÈªòËÆ§ÊèèËø∞Ôºö`, "Ë°®ÊÉÖÂåÖ") ||
                "Ë°®ÊÉÖÂåÖ";
            }

            newStickers = parsedItems.map((item) => ({
              id: Date.now() + Math.random(),
              src: item.src,
              desc: item.desc || fallbackDesc, // ‰ºòÂÖàÁî®Êñá‰ª∂ÈáåÁöÑÔºåÊ≤°ÊúâÂàôÁî®ÂÖúÂ∫ï
              category: window.currentCategory,
            }));
          }
          // === ÊÉÖÂÜµB: ÂõæÁâáÊñá‰ª∂ (Áõ∏ÂÜå‰∏ä‰º†) ===
          else if (file.type.startsWith("image/")) {
            // ÂõæÁâáËÇØÂÆöÊ≤°ÊúâÊèèËø∞ÔºåÂøÖÈ°ªÈóÆ‰∏ÄÊ¨°
            if (!fallbackDesc) {
              fallbackDesc =
                prompt(
                  `Ê≠£Âú®ÂØºÂÖ•Âà∞„Äê${window.currentCategory}„ÄëÂàÜÁ±ª„ÄÇ\nËØ∑ËæìÂÖ•Ëøô‰∫õË°®ÊÉÖÁöÑÊÑèÊÄùÔºö`,
                  "Ë°®ÊÉÖÂåÖ"
                ) || "Ë°®ÊÉÖÂåÖ";
            }
            try {
              const compressedData = await compressImage(file, 200, 0.7);
              newStickers.push({
                id: Date.now() + Math.random(),
                src: compressedData,
                desc: fallbackDesc,
                category: window.currentCategory,
              });
            } catch (e) {
              console.error(e);
            }
          }

          if (newStickers.length > 0) {
            window.customStickers.push(...newStickers);
            addedCount += newStickers.length;
          }
        }

        if (addedCount > 0) {
          await localforage.setItem("customStickers", window.customStickers);
          renderStickerGrid();
          showToast(`ÊàêÂäüÂØºÂÖ• ${addedCount} ‰∏™Ë°®ÊÉÖÔºÅ`);
        } else {
          showToast("Êú™ÊâæÂà∞ÊúâÊïàÂÜÖÂÆπ");
        }

        input.value = "";
      }

      // 7. Á≤òË¥¥ÈìæÊé•ÂØºÂÖ• (ÂçáÁ∫ßÁâàÔºöÊîØÊåÅ ÂÖ≥ÈîÆËØçÔºöURL Ê†ºÂºè)
      function importStickersFromUrl() {
        const text = prompt(
          "ËØ∑Á≤òË¥¥ÂÜÖÂÆπÔºàÊîØÊåÅ 'ÂÖ≥ÈîÆËØçÔºöURL' Ê†ºÂºèÔºå‰∏ÄË°å‰∏Ä‰∏™ÔºâÔºö"
        );
        if (!text) return;

        // 1. Êô∫ËÉΩËß£Êûê
        const parsedItems = parseStickersFromText(text);

        if (parsedItems.length === 0) {
          showToast("Êú™Ê£ÄÊµãÂà∞ÊúâÊïàÈìæÊé•");
          return;
        }

        // 2. Ê£ÄÊü•ÊòØÂê¶ÊúâÁº∫Â§±ÊèèËø∞ÁöÑÈ°π
        let fallbackDesc = null;
        const needFallback = parsedItems.some((item) => !item.desc);

        if (needFallback) {
          fallbackDesc =
            prompt("ÈÉ®ÂàÜÈìæÊé•Ê≤°ÊúâÂÜôÊèèËø∞ÔºåËØ∑ËæìÂÖ•ÈªòËÆ§ÊÑèÊÄùÔºö", "Ë°®ÊÉÖÂåÖ") ||
            "Ë°®ÊÉÖÂåÖ";
        }

        // 3. ÊûÑÂª∫Êï∞ÊçÆ
        const newStickers = parsedItems.map((item) => ({
          id: Date.now() + Math.random(),
          src: item.src,
          desc: item.desc || fallbackDesc,
          category: window.currentCategory,
        }));

        window.customStickers.push(...newStickers);
        localforage.setItem("customStickers", window.customStickers);
        renderStickerGrid();
        showToast(`ÊàêÂäüÊ∑ªÂä† ${newStickers.length} ‰∏™Ë°®ÊÉÖ`);
      }

      // 8. ÂèëÈÄÅË°®ÊÉÖ (ÂæÆ‰ø°È£éÊ†ºÁâà)
      function sendSticker(stickerId) {
        const sticker = window.customStickers.find((s) => s.id == stickerId);
        if (!sticker) return;

        // ÊûÑÈÄ† HTMLÔºöÂä†‰∏ä class="sticker-img"
        const hiddenDesc = `<span style="display:none">[Ë°®ÊÉÖÂåÖÔºö${sticker.desc}]</span>`;
        const imgHtml = `<img src="${sticker.src}" class="sticker-img" onclick="showFullImage(this.src)">`;
        const finalContent = `${hiddenDesc}${imgHtml}`;

        // ÂèëÈÄÅ
        sendRichMessage(finalContent, `[Ë°®ÊÉÖÂåÖ] ${sticker.desc}`);

        // ÂèëÈÄÅÂêéÂÖ≥Èó≠Èù¢Êùø (ÂèØÈÄâ)
        closeChatPanel();
      }

      // 9. ÁºñËæë/Âà†Èô§Ë°®ÊÉÖ (Âè≥ÈîÆÊàñÈïøÊåâ)
      async function editSticker(event, stickerId) {
        event.preventDefault();
        const stickerIndex = window.customStickers.findIndex(
          (s) => s.id == stickerId
        );
        if (stickerIndex === -1) return;

        const action = prompt(
          "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÊèèËø∞ÔºàÊ∏ÖÁ©∫ÂàôÂà†Èô§ËØ•Ë°®ÊÉÖÔºâÔºö",
          window.customStickers[stickerIndex].desc
        );

        if (action === null) return; // ÂèñÊ∂à

        if (action.trim() === "") {
          // Âà†Èô§
          window.customStickers.splice(stickerIndex, 1);
          showToast("Ë°®ÊÉÖÂ∑≤Âà†Èô§");
        } else {
          // ‰øÆÊîπÊèèËø∞
          window.customStickers[stickerIndex].desc = action.trim();
          showToast("ÊèèËø∞Â∑≤Êõ¥Êñ∞");
        }

        await localforage.setItem("customStickers", window.customStickers);
        renderStickerGrid();
      }

      // üÜï Êñ∞Â¢ûÔºöÈÄöÁî®ÁöÑÂØåÊñáÊú¨ÂèëÈÄÅÂáΩÊï∞ (Êõø‰ª£ sendMediaMessage ÁöÑÈÉ®ÂàÜÂäüËÉΩ)
      function sendRichMessage(htmlContent, previewText) {
        if (!chatHistories[currentChatCharId])
          chatHistories[currentChatCharId] = [];

        const msgObj = {
          role: "user",
          content: htmlContent, // ËøôÈáåÈù¢ÂåÖÂê´‰∫Ü <span style="display:none">ÊèèËø∞</span>
          time: new Date().toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          }),
          isHtml: true,
        };

        chatHistories[currentChatCharId].push(msgObj);
        localStorage.setItem("chatHistories", JSON.stringify(chatHistories)); // Êàñ localforage

        renderConversation();
        updateCharacterLastMessage(currentChatCharId, previewText);
      }

      // Â§çÁî®ËæÖÂä©ÂáΩÊï∞
      function readFileAsText(file) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.readAsText(file);
        });
      }
      function extractUrlsFromText(text) {
        const regex = /(https?:\/\/[^\s"']+)/g;
        const matches = text.match(regex);
        return matches
          ? [...new Set(matches)].filter((u) => u.length > 10)
          : [];
      }
      /* ==================== Ë°•ÂõûÔºöÈù¢ÊùøÂàáÊç¢ÈÄªËæë ==================== */
      /* ==================== ‰øÆÂ§çÁâàÔºöÈù¢ÊùøÂàáÊç¢ÈÄªËæë ==================== */

      // 1. ÂàáÊç¢Èù¢Êùø (Âä†Âè∑Èù¢Êùø vs Ë°®ÊÉÖÈù¢Êùø)
      function toggleChatPanel(type) {
        const plusPanel = document.getElementById("plusPanel");
        const emojiPanel = document.getElementById("emojiPanel");
        const inputArea = document.getElementById("convInput");

        // Âè™Ë¶ÅÁÇπ‰∫ÜÊåâÈíÆÔºåÂ∞±ÂÖàÊî∂Ëµ∑ÈîÆÁõò
        if (inputArea) inputArea.blur();

        if (type === "plus") {
          // Â¶ÇÊûúÂä†Âè∑Èù¢ÊùøÂ∑≤ÁªèÂºÄ‰∫Ü -> ÂÖ≥Èó≠ÂÆÉ
          if (plusPanel.classList.contains("open")) {
            closeChatPanel();
          }
          // Â¶ÇÊûúÊ≤°ÂºÄ -> ÊâìÂºÄÂÆÉÔºåÂπ∂ÂÖ≥Èó≠Ë°®ÊÉÖÈù¢Êùø
          else {
            plusPanel.classList.add("open");
            emojiPanel.classList.remove("open");
            setTimeout(scrollToBottom, 300);
          }
        } else if (type === "emoji") {
          // Â¶ÇÊûúË°®ÊÉÖÈù¢ÊùøÂ∑≤ÁªèÂºÄ‰∫Ü -> ÂÖ≥Èó≠ÂÆÉ
          if (emojiPanel.classList.contains("open")) {
            closeChatPanel();
          }
          // Â¶ÇÊûúÊ≤°ÂºÄ -> ÊâìÂºÄÂÆÉÔºåÂπ∂ÂÖ≥Èó≠Âä†Âè∑Èù¢Êùø
          else {
            emojiPanel.classList.add("open");
            plusPanel.classList.remove("open");
            setTimeout(scrollToBottom, 300);
          }
        }
      }

      // 2. ÂÖ≥Èó≠ÊâÄÊúâÈù¢Êùø (ÁÇπÂáªÁ©∫ÁôΩÂ§ÑË∞ÉÁî®)
      function closeChatPanel() {
        const plusPanel = document.getElementById("plusPanel");
        const emojiPanel = document.getElementById("emojiPanel");

        let isClosed = true;

        if (plusPanel && plusPanel.classList.contains("open")) {
          plusPanel.classList.remove("open");
          isClosed = false;
        }
        if (emojiPanel && emojiPanel.classList.contains("open")) {
          emojiPanel.classList.remove("open");
          isClosed = false;
        }

        // Â¶ÇÊûúÊú¨Êù•Â∞±ÊòØÂÖ≥ÁùÄÁöÑÔºåÂ∞±‰∏çÈúÄË¶ÅÂÅöÈ¢ùÂ§ñÊìç‰Ωú
        if (!isClosed) {
          // ÂèØ‰ª•Âä†‰∏Ä‰∫õÂÖ∂‰ªñÁöÑÂ§ç‰ΩçÈÄªËæë
        }
      }
      // 3. ËæÖÂä©ÔºöÊªöÂä®Âà∞Â∫ïÈÉ®
      function scrollToBottom() {
        const container = document.getElementById("convMessages");
        if (container) container.scrollTop = container.scrollHeight;
      }
      // 4. ÂèëÈÄÅÂõæÁâáÂäüËÉΩ
      async function handleChatImageUpload(input) {
        const file = input.files[0];
        if (!file) return;

        // ÂéãÁº©ÂõæÁâá
        const compressedData = await compressImage(file, 800, 0.8);

        // ÂèëÈÄÅÂõæÁâáÊ∂àÊÅØ
        sendMediaMessage(compressedData, "image");

        // ÂÖ≥Èó≠Èù¢Êùø
        closeChatPanel();
        // Ê∏ÖÁ©∫ input Âê¶ÂàôÊó†Ê≥ïËøûÁª≠ÂèëÂêå‰∏ÄÂº†Âõæ
        input.value = "";
      }

      // ÈÄöÁî®Â™í‰ΩìÊ∂àÊÅØÂèëÈÄÅÂáΩÊï∞
      function sendMediaMessage(content, type) {
        if (!chatHistories[currentChatCharId])
          chatHistories[currentChatCharId] = [];

        let msgContent = content;
        if (type === "image") {
          msgContent = `<img src="${content}" class="msg-img" onclick="showFullImage(this.src)">`;
        }

        const msgObj = {
          role: "user",
          content: msgContent,
          time: new Date().toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          }),
          // Ê†áËÆ∞ËøôÊòØ‰∏Ä‰∏™ÂØåÊñáÊú¨/HTMLÊ∂àÊÅØÔºåÂèØ‰ª•ÁâπÊÆäÂ§ÑÁêÜ
          isHtml: true,
        };

        chatHistories[currentChatCharId].push(msgObj);
        localforage.setItem("chatHistories", chatHistories);

        renderConversation();
        updateCharacterLastMessage(
          currentChatCharId,
          type === "image" ? "[ÂõæÁâá]" : "[Ê∂àÊÅØ]"
        );
      }

      // Êü•ÁúãÂ§ßÂõæ (ÁÆÄÂçïÁöÑÂÖ®Â±èÈ¢ÑËßà)
      function showFullImage(src) {
        const overlay = document.createElement("div");
        overlay.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.9); z-index: 1000;
        display: flex; align-items: center; justify-content: center;
        animation: fadeIn 0.2s;
    `;
        overlay.onclick = () => overlay.remove();

        const img = document.createElement("img");
        img.src = src;
        img.style.cssText = `max-width: 100%; max-height: 100%; object-fit: contain;`;

        overlay.appendChild(img);
        document.body.appendChild(overlay);
      }

      // 5. Ê®°ÊãüÂäüËÉΩÔºöÂèëÁ∫¢ÂåÖ
      function sendRedPacket() {
        const amount = (Math.random() * 200).toFixed(2);
        const html = `
        <div style="background:#fa9d3b; padding:12px 16px; border-radius:10px; display:flex; align-items:center; gap:12px; min-width:200px; cursor:pointer;" onclick="alert('È¢ÜÂèñ‰∫Ü ${amount} ÂÖÉÔºÅ')">
            <div style="background:#fce6c5; width:36px; height:36px; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:20px;">üßß</div>
            <div style="color:white; font-size:0.95rem;">
                <div>ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©</div>
                <div style="font-size:0.7rem; opacity:0.8; margin-top:2px;">ÂæÆ‰ø°Á∫¢ÂåÖ</div>
            </div>
        </div>
    `;
        sendMediaMessage(html, "redpacket");
        closeChatPanel();
      }

      // 6. Ê®°ÊãüÂäüËÉΩÔºöÊãç‰∏ÄÊãç
      function sendNudge() {
        closeChatPanel();
        // Êãç‰∏ÄÊãçÈÄöÂ∏∏ÊòØÁ≥ªÁªüÊèêÁ§∫Ôºå‰∏ç‰Ωú‰∏∫‰∏ÄÊù°ÊôÆÈÄöÊ∂àÊÅØ
        const container = document.getElementById("convMessages");
        const html = `<div class="msg-system-tip">‰Ω†Êãç‰∫ÜÊãç "ÂØπÊñπ" ÁöÑËÑëË¢ã</div>`;
        container.insertAdjacentHTML("beforeend", html);
        container.scrollTop = container.scrollHeight;

        // Â¶ÇÊûú‰Ω†ÊÉ≥ËÆ©AIÂõûÂ∫îÔºåÂèØ‰ª•‰º™ÈÄ†‰∏ÄÊù° AI Ê∂àÊÅØ
        // setTimeout(() => { ... }, 1000);
      }

      // 7. Ê®°ÊãüÂäüËÉΩÔºöÊãçÁÖß/ÈÄöËØù/‰ΩçÁΩÆ (‰ªÖÊèêÁ§∫)
      function handleCameraAction() {
        alert("Áõ∏Êú∫ÂäüËÉΩÂºÄÂèë‰∏≠... (ÂèØ‰ΩøÁî®Áõ∏ÂÜåÂèëÂõæ)");
      }
      function startFakeCall() {
        sendMediaMessage(
          `
        <div style="background:white; padding:10px 14px; border-radius:10px; display:flex; align-items:center; gap:10px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
            <div style="background:#f5f5f5; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:#ff9800;">üìû</div>
            <div>
                <div style="font-size:0.9rem;">ËØ≠Èü≥ÈÄöËØù</div>
                <div style="font-size:0.7rem; color:#999;">ÈÄöËØùÊó∂Èïø 00:00</div>
            </div>
        </div>
    `,
          "call"
        );
        closeChatPanel();
      }
      function sendFakeLocation() {
        sendMediaMessage(
          `
        <div style="width:200px; height:100px; background:#e0e0e0; border-radius:8px; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden;">
            <div style="position:absolute; bottom:0; left:0; right:0; background:rgba(0,0,0,0.6); color:white; padding:4px 8px; font-size:0.75rem;">‰∏äÊµ∑Â∏Ç ¬∑ ÈôÜÂÆ∂Âò¥</div>
            <div style="font-size:30px;">üó∫Ô∏è</div>
        </div>
    `,
          "location"
        );
        closeChatPanel();
      }
      /* ==================== ‰øÆÂ§çÔºö‰∏ÄÈîÆÂà∑Êñ∞Ê∂àÊÅØÂàóË°®È¢ÑËßà ==================== */
      function fixAllLastMessages() {
        console.log("ÂºÄÂßã‰øÆÂ§çÂàóË°®È¢ÑËßà...");
        characters.forEach((char) => {
          const history = chatHistories[char.id] || [];
          if (history.length > 0) {
            // ÂèñÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØ
            const lastMsg = history[history.length - 1];
            let previewText = lastMsg.content || "";

            // Ê†πÊçÆÁ±ªÂûãÁîüÊàêÈ¢ÑËßà
            if (previewText.match && previewText.match(/^\[ËØ≠Èü≥[:Ôºö](.+)\]$/)) {
              previewText = "[ËØ≠Èü≥]";
            } else if (lastMsg.isHtml || previewText.includes("<img")) {
              previewText = "[ÂõæÁâá/Ê∂àÊÅØ]";
            } else {
              // Ê∏ÖÈô§ HTML Ê†áÁ≠æÂíåÂ∞èËØ¥Ê†áËÆ∞
              previewText = previewText
                .replace(/<[^>]+>/g, "")
                .replace(/\*/g, "");
            }

            // Êõ¥Êñ∞Âπ∂‰øùÂ≠ò
            char.lastMessage = previewText;
            char.lastTime = lastMsg.time;
          }
        });
        localforage.setItem("characters", characters);
        renderCharacters(); // Âà∑Êñ∞ÁïåÈù¢
        console.log("ÂàóË°®È¢ÑËßà‰øÆÂ§çÂÆåÊàê ‚úÖ");
      }

      // È°µÈù¢Âä†ËΩΩÂêéËá™Âä®ËøêË°å‰∏ÄÊ¨°‰øÆÂ§ç
      setTimeout(fixAllLastMessages, 1000);
      /* ==================== ‰øÆÂ§çÔºö‰∫§‰∫íÂáΩÊï∞ (Èò≤ÂÜ≤Á™ÅÂÆâÂÖ®Áâà) ==================== */

      // Ê≥®ÊÑèÔºöËøôÈáå‰∏çÂÜçÁî® var/let Â£∞ÊòéÂèòÈáèÔºåÁõ¥Êé•‰ΩøÁî®ÂÖ®Â±ÄÂ∑≤Â≠òÂú®ÁöÑÂèòÈáè

      // 1. ÈÄöÁî®Ëß¶Êë∏Â§ÑÁêÜ (Ë°•ÂÖ®ÈÄªËæë)
      window.handleTouchStart = function (e, index) {
        if (typeof isSelectionMode !== "undefined" && isSelectionMode) return;

        if (e.touches && e.touches[0]) {
          // Áõ¥Êé•ËµãÂÄºÁªôÂÖ®Â±ÄÂèòÈáè
          touchStartX = e.touches[0].clientX;
          touchStartY = e.touches[0].clientY;

          // Ê∏ÖÈô§ÊóßÂÆöÊó∂Âô®
          if (typeof longPressTimer !== "undefined" && longPressTimer) {
            clearTimeout(longPressTimer);
          }

          longPressTimer = setTimeout(() => {
            if (typeof showContextMenu === "function") {
              showContextMenu(touchStartX, touchStartY, index);
            }
          }, 500);
        }
      };

      window.handleTouchMove = function (e) {
        if (typeof longPressTimer !== "undefined" && !longPressTimer) return;

        if (e.touches && e.touches[0]) {
          let moveX = e.touches[0].clientX;
          let moveY = e.touches[0].clientY;
          // Â¶ÇÊûúÁßªÂä®Ë∂ÖËøá 10pxÔºåÂèñÊ∂àÈïøÊåâ
          if (
            Math.abs(moveX - touchStartX) > 10 ||
            Math.abs(moveY - touchStartY) > 10
          ) {
            if (typeof longPressTimer !== "undefined") {
              clearTimeout(longPressTimer);
              longPressTimer = null;
            }
          }
        }
      };

      window.handleTouchEnd = function () {
        if (typeof longPressTimer !== "undefined" && longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      };

      // 2. Èº†Ê†áÂ§ÑÁêÜ (ÂÖºÂÆπÁîµËÑëÁ´Ø)
      window.handleMouseDown = function (e, index) {
        if (typeof isSelectionMode !== "undefined" && isSelectionMode) return;

        if (typeof longPressTimer !== "undefined" && longPressTimer)
          clearTimeout(longPressTimer);

        longPressTimer = setTimeout(() => {
          if (typeof showContextMenu === "function") {
            showContextMenu(e.clientX, e.clientY, index);
          }
        }, 500);
      };

      window.handleMouseUp = function () {
        if (typeof longPressTimer !== "undefined" && longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      };

      // 3. ËØ≠Èü≥Ê∞îÊ≥°‰∏ìÁî®Â§ÑÁêÜ (Èò≤Ê≠¢ÈïøÊåâÂíåÁÇπÂáªÂÜ≤Á™Å)
      // voiceTouchStartTime Â¶ÇÊûúÊ≤°ÂÆö‰πâÔºåÊàë‰ª¨Âú® window ‰∏äÂÆö‰πâÂÆÉ
      if (typeof window.voiceTouchStartTime === "undefined") {
        window.voiceTouchStartTime = 0;
      }

      window.handleVoiceBubbleTouchStart = function (event, msgIndex) {
        window.voiceTouchStartTime = Date.now();
        if (typeof handleTouchStart === "function") {
          handleTouchStart(event, msgIndex);
        }
      };

      window.handleVoiceBubbleTouchEnd = function (event, msgIndex) {
        const touchDuration = Date.now() - window.voiceTouchStartTime;
        // Â¶ÇÊûúÊåâ‰ΩèÊó∂Èó¥Áü≠‰∫é 450msÔºå‰∏îÂÆöÊó∂Âô®ËøòÂ≠òÂú®ÔºàËØ¥ÊòéÈïøÊåâËøòÊ≤°Ëß¶ÂèëÔºâ
        // ÂàôËßÜ‰∏∫ÁÇπÂáªÔºåÊí≠ÊîæËØ≠Èü≥
        if (
          touchDuration < 450 &&
          typeof longPressTimer !== "undefined" &&
          longPressTimer
        ) {
          clearTimeout(longPressTimer);
          longPressTimer = null;

          // Â∞ùËØïÊí≠Êîæ
          const voiceBar = event.currentTarget.querySelector(".voice-bar");
          if (voiceBar && typeof playVoiceMessageByIndex === "function") {
            playVoiceMessageByIndex(msgIndex, voiceBar);
          }
        } else {
          if (typeof handleTouchEnd === "function") {
            handleTouchEnd();
          }
        }
      };
      // ==================== ‰∏ÄËµ∑ËØª‰π¶ÂäüËÉΩ ====================

      function openReadTogether() {
        closeChatPanel();
        document.getElementById("readTogetherPage").classList.add("active");
        renderBookshelf();
        renderCurrentReading();
      }

      function closeReadTogether() {
        document.getElementById("readTogetherPage").classList.remove("active");
      }

      // Ê∏≤Êüì‰π¶Êû∂
      function renderBookshelf() {
        const grid = document.getElementById("bookshelfGrid");
        let html = "";

        window.bookshelfData.forEach((book, index) => {
          const progress =
            Math.round(((book.currentIndex + 1) / book.chunks.length) * 100) ||
            0;
          const isReading = isCurrentlyReading(book.id);
          html += `
            <div class="book-card ${
              isReading ? "reading" : ""
            }" onclick="selectBook('${book.id}')">
              <div class="book-card-icon">üìñ</div>
              <div class="book-card-name">${escapeHtml(book.bookName)}</div>
              <div class="book-card-info">${
                book.chunks.length
              } È°µ ¬∑ ${progress}%</div>
              <div class="book-card-progress">
                <div class="book-card-progress-fill" style="width:${progress}%"></div>
              </div>
              <div class="book-card-actions" onclick="event.stopPropagation()">
                <button class="book-card-btn read" onclick="startReading('${
                  book.id
                }')">${isReading ? "ÁªßÁª≠ËØª" : "ÂºÄÂßãËØª"}</button>
                <button class="book-card-btn delete" onclick="deleteBook('${
                  book.id
                }')">Âà†Èô§</button>
              </div>
            </div>
          `;
        });

        // Ê∑ªÂä†Êñ∞‰π¶ÊåâÈíÆ
        html += `
          <div class="book-card add-book-card" onclick="document.getElementById('bookFileInput').click()">
            <div style="font-size:32px;margin-bottom:8px;">‚ûï</div>
            <div>ÂØºÂÖ•Êñ∞‰π¶</div>
          </div>
        `;

        grid.innerHTML = html;
      }

      // Ê£ÄÊü•ÊüêÊú¨‰π¶ÊòØÂê¶Ê≠£Âú®Ë¢´ÂΩìÂâçËßíËâ≤ÈòÖËØª
      function isCurrentlyReading(bookId) {
        const charId = currentChatCharId;
        const data = window.readTogetherData[charId];
        return data && data.bookId === bookId && data.active;
      }

      // Ê∏≤ÊüìÂΩìÂâçÈòÖËØªÂå∫Âüü
      function renderCurrentReading() {
        const charId = currentChatCharId;
        const data = window.readTogetherData[charId];
        const section = document.getElementById("currentReadingSection");

        if (!data || !data.active) {
          section.style.display = "none";
          return;
        }

        section.style.display = "block";

        const book = window.bookshelfData.find((b) => b.id === data.bookId);
        if (!book) {
          section.style.display = "none";
          return;
        }

        document.getElementById("readBookName").textContent = book.bookName;

        const current = book.currentIndex + 1;
        const total = book.chunks.length;
        const percent = Math.round((current / total) * 100);

        document.getElementById(
          "readBookProgress"
        ).textContent = `ËøõÂ∫¶ÔºöÁ¨¨ ${current} È°µ / ÂÖ± ${total} È°µ (${percent}%)`;
        document.getElementById("readProgressFill").style.width = percent + "%";
        document.getElementById("readJumpTo").max = total;
        document.getElementById("readJumpTo").value = current;

        const currentText = book.chunks[book.currentIndex] || "ÔºàÂ∑≤ËØªÂÆåÔºâ";
        document.getElementById("readSectionText").textContent = currentText;

        // Êõ¥Êñ∞Áä∂ÊÄÅÂæΩÁ´†
        const badge = document.getElementById("readStatusBadge");
        badge.innerHTML = "<span>‚úì</span> ÈòÖËØª‰∏≠";
        badge.classList.remove("inactive");
      }

      // ÂØºÂÖ•‰π¶Á±çÂà∞‰π¶Êû∂
      function handleBookImport(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          const content = e.target.result;
          // ‰ΩøÁî®Áî®Êà∑ËÆæÁΩÆÁöÑÊØèÈ°µÂ≠óÊï∞
          const chunkSizeInput = document.getElementById("readChunkSize");
          const chunkSize = parseInt(chunkSizeInput?.value) || 500;
          const chunks = splitTextIntoChunks(content, chunkSize);

          const bookId = "book_" + Date.now();
          const newBook = {
            id: bookId,
            bookName: file.name.replace(".txt", ""),
            chunks: chunks,
            currentIndex: 0,
            chunkSize: chunkSize,
            importTime: Date.now(),
          };

          window.bookshelfData.push(newBook);
          localforage
            .setItem("bookshelfData", window.bookshelfData)
            .then(() => {
              renderBookshelf();
              alert("ÂØºÂÖ•ÊàêÂäüÔºÅ");
            })
            .catch((err) => alert("‰øùÂ≠òÂ§±Ë¥•: " + err));
          showToast(
            "üìö „Ää" +
              newBook.bookName +
              "„ÄãÂ∑≤Âä†ÂÖ•‰π¶Êû∂ÔºÅÂÖ± " +
              chunks.length +
              " È°µ"
          );
        };
        reader.readAsText(file);
        input.value = "";
      }

      function splitTextIntoChunks(text, chunkSize) {
        const chunks = [];
        const paragraphs = text.split(/\n\s*\n|\r\n\s*\r\n/);
        let currentChunk = "";

        for (const para of paragraphs) {
          const trimmed = para.trim();
          if (!trimmed) continue;

          if (
            currentChunk.length + trimmed.length > chunkSize &&
            currentChunk.length > 0
          ) {
            chunks.push(currentChunk.trim());
            currentChunk = trimmed;
          } else {
            currentChunk += (currentChunk ? "\n\n" : "") + trimmed;
          }
        }

        if (currentChunk.trim()) {
          chunks.push(currentChunk.trim());
        }

        if (chunks.length === 0 && text.trim()) {
          for (let i = 0; i < text.length; i += chunkSize) {
            chunks.push(text.slice(i, i + chunkSize).trim());
          }
        }

        return chunks;
      }

      // ÈÄâÊã©‰π¶Á±çÔºàÁÇπÂáª‰π¶Á±çÂç°ÁâáÔºâ
      function selectBook(bookId) {
        startReading(bookId);
      }

      // ÂºÄÂßã/ÁªßÁª≠ÈòÖËØªÊüêÊú¨‰π¶
      function startReading(bookId) {
        const charId = currentChatCharId;
        const book = window.bookshelfData.find((b) => b.id === bookId);
        if (!book) return;

        window.readTogetherData[charId] = {
          bookId: bookId,
          active: true,
          mode: window.readTogetherData[charId]?.mode || "auto",
        };

        localforage.setItem("readTogetherData", window.readTogetherData);
        renderBookshelf();
        renderCurrentReading();
        showToast("üìñ ÂºÄÂßãÈòÖËØª„Ää" + book.bookName + "„Äã");
      }

      // ÊöÇÂÅúÈòÖËØªÔºàÂõûÂà∞‰π¶Êû∂Ôºâ
      function stopCurrentReading() {
        const charId = currentChatCharId;
        if (window.readTogetherData[charId]) {
          window.readTogetherData[charId].active = false;
          localforage.setItem("readTogetherData", window.readTogetherData);
        }
        renderBookshelf();
        renderCurrentReading();
        hideFloatingBtn();
        showToast("‚è∏Ô∏è Â∑≤ÊöÇÂÅúÈòÖËØª");
      }

      // Âà†Èô§‰π¶Á±ç
      function deleteBook(bookId) {
        if (!confirm("Á°ÆÂÆöË¶Å‰ªé‰π¶Êû∂Âà†Èô§ËøôÊú¨‰π¶ÂêóÔºü")) return;

        window.bookshelfData = window.bookshelfData.filter(
          (b) => b.id !== bookId
        );
        localforage.setItem("bookshelfData", window.bookshelfData);

        // Â¶ÇÊûúÊ≠£Âú®ÈòÖËØªËøôÊú¨‰π¶ÔºåÂÅúÊ≠¢ÈòÖËØª
        const charId = currentChatCharId;
        if (window.readTogetherData[charId]?.bookId === bookId) {
          delete window.readTogetherData[charId];
          localforage.setItem("readTogetherData", window.readTogetherData);
        }

        renderBookshelf();
        renderCurrentReading();
        hideFloatingBtn();
        showToast("üóëÔ∏è ‰π¶Á±çÂ∑≤Âà†Èô§");
      }

      // ÁøªÈ°µÂäüËÉΩ
      function readPrevSection() {
        const charId = currentChatCharId;
        const data = window.readTogetherData[charId];
        if (!data || !data.active) return;

        const book = window.bookshelfData.find((b) => b.id === data.bookId);
        if (!book || book.currentIndex <= 0) return;

        book.currentIndex--;
        localforage.setItem("bookshelfData", window.bookshelfData);
        renderCurrentReading();
        updateFloatingPanel();
      }

      function readNextSection() {
        const charId = currentChatCharId;
        const data = window.readTogetherData[charId];
        if (!data || !data.active) return;

        const book = window.bookshelfData.find((b) => b.id === data.bookId);
        if (!book || book.currentIndex >= book.chunks.length - 1) return;

        book.currentIndex++;
        localforage.setItem("bookshelfData", window.bookshelfData);
        renderCurrentReading();
        updateFloatingPanel();
      }

      function jumpToSection() {
        const charId = currentChatCharId;
        const data = window.readTogetherData[charId];
        if (!data || !data.active) return;

        const book = window.bookshelfData.find((b) => b.id === data.bookId);
        if (!book) return;

        const target =
          parseInt(document.getElementById("readJumpTo").value) - 1;
        if (target >= 0 && target < book.chunks.length) {
          book.currentIndex = target;
          localforage.setItem("bookshelfData", window.bookshelfData);
          renderCurrentReading();
          updateFloatingPanel();
          showToast("Â∑≤Ë∑≥ËΩ¨Âà∞Á¨¨ " + (target + 1) + " È°µ");
        }
      }

      // ==================== ÊÇ¨ÊµÆÁ™óÂäüËÉΩ ====================
      function startFloatingMode() {
        closeReadTogether();
        showFloatingBtn();
        showToast("üìå ÊÇ¨ÊµÆÁ™óÂ∑≤ÂºÄÂêØÔºåÁÇπÂáªüìñÊåâÈíÆÂèØÊü•ÁúãÂΩìÂâçÂÜÖÂÆπ");
      }

      function showFloatingBtn() {
        document.getElementById("readFloatingBtn").classList.add("active");
      }

      function hideFloatingBtn() {
        document.getElementById("readFloatingBtn").classList.remove("active");
        document.getElementById("readFloatingPanel").classList.remove("active");
      }

      function toggleFloatingPanel() {
        const panel = document.getElementById("readFloatingPanel");
        if (panel.classList.contains("active")) {
          panel.classList.remove("active");
        } else {
          updateFloatingPanel();
          panel.classList.add("active");
        }
      }

      function hideFloatingPanel() {
        document.getElementById("readFloatingPanel").classList.remove("active");
      }

      function updateFloatingPanel() {
        const charId = currentChatCharId;
        const data = window.readTogetherData[charId];
        if (!data || !data.active) return;

        const book = window.bookshelfData.find((b) => b.id === data.bookId);
        if (!book) return;

        document.getElementById("floatBookTitle").textContent = book.bookName;
        document.getElementById("floatProgress").textContent = `Á¨¨${
          book.currentIndex + 1
        }È°µ / ÂÖ±${book.chunks.length}È°µ`;
        document.getElementById("floatContent").textContent =
          book.chunks[book.currentIndex] || "ÔºàÂ∑≤ËØªÂÆåÔºâ";
      }

      // ÊÇ¨ÊµÆÁ™óÊãñÂä®ÂäüËÉΩ
      (function initFloatingPanelDrag() {
        document.addEventListener("DOMContentLoaded", function () {
          const panel = document.getElementById("readFloatingPanel");
          const header = document.getElementById("floatPanelHeader");
          if (!panel || !header) return;

          let isDragging = false;
          let startX, startY, startLeft, startTop;

          header.addEventListener("mousedown", startDrag);
          header.addEventListener("touchstart", startDrag, { passive: false });

          function startDrag(e) {
            if (e.target.classList.contains("read-float-close")) return;
            isDragging = true;

            const rect = panel.getBoundingClientRect();
            startLeft = rect.left;
            startTop = rect.top;

            if (e.type === "touchstart") {
              startX = e.touches[0].clientX;
              startY = e.touches[0].clientY;
            } else {
              startX = e.clientX;
              startY = e.clientY;
            }

            // ÁßªÈô§bottom/rightÂÆö‰ΩçÔºåÊîπÁî®left/top
            panel.style.left = startLeft + "px";
            panel.style.top = startTop + "px";
            panel.style.right = "auto";
            panel.style.bottom = "auto";

            document.addEventListener("mousemove", onDrag);
            document.addEventListener("mouseup", stopDrag);
            document.addEventListener("touchmove", onDrag, { passive: false });
            document.addEventListener("touchend", stopDrag);

            e.preventDefault();
          }

          function onDrag(e) {
            if (!isDragging) return;

            let currentX, currentY;
            if (e.type === "touchmove") {
              currentX = e.touches[0].clientX;
              currentY = e.touches[0].clientY;
            } else {
              currentX = e.clientX;
              currentY = e.clientY;
            }

            const deltaX = currentX - startX;
            const deltaY = currentY - startY;

            let newLeft = startLeft + deltaX;
            let newTop = startTop + deltaY;

            // ËæπÁïåÈôêÂà∂
            const maxLeft = window.innerWidth - panel.offsetWidth;
            const maxTop = window.innerHeight - panel.offsetHeight;
            newLeft = Math.max(0, Math.min(newLeft, maxLeft));
            newTop = Math.max(0, Math.min(newTop, maxTop));

            panel.style.left = newLeft + "px";
            panel.style.top = newTop + "px";

            e.preventDefault();
          }

          function stopDrag() {
            isDragging = false;
            document.removeEventListener("mousemove", onDrag);
            document.removeEventListener("mouseup", stopDrag);
            document.removeEventListener("touchmove", onDrag);
            document.removeEventListener("touchend", stopDrag);
          }
        });
      })();

      // ÊâìÂºÄÂØπËØùÊó∂Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊòæÁ§∫ÊÇ¨ÊµÆÊåâÈíÆ
      function checkFloatingBtn() {
        const charId = currentChatCharId;
        const data = window.readTogetherData[charId];
        if (data && data.active) {
          // ‰∏çËá™Âä®ÊòæÁ§∫ÊÇ¨ÊµÆÊåâÈíÆÔºåËÆ©Áî®Êà∑‰∏ªÂä®ÂºÄÂêØ
        }
      }

      // Ëé∑ÂèñÂΩìÂâçÈòÖËØªÂÜÖÂÆπÔºà‰æõAI‰ΩøÁî®Ôºâ
      function getCurrentReadingContent() {
        const charId = currentChatCharId;
        const data = window.readTogetherData[charId];
        if (!data || !data.active) return null;

        const book = window.bookshelfData.find((b) => b.id === data.bookId);
        if (!book) return null;

        return {
          bookName: book.bookName,
          currentSection: book.chunks[book.currentIndex],
          sectionIndex: book.currentIndex + 1,
          totalSections: book.chunks.length,
        };
      }

      // ‰øùÁïôËøô‰∏™ÂáΩÊï∞‰ΩÜ‰∏çÂÜçËá™Âä®Ë∞ÉÁî®
      function advanceReadingProgress() {
        // Â∑≤Á¶ÅÁî®Ëá™Âä®ÁøªÈ°µÂäüËÉΩÔºåÁî®Êà∑ÊâãÂä®ÁøªÈ°µ
      }

      // ==================== ÂæÖÂäû‰∫ãÈ°πÂäüËÉΩ ====================
      window.todoList = [];
      window.todoAiBindings = {};
      window.currentTodoFilter = "all";

      // ÈªòËÆ§ÂàÜÁ±ª
      window.todoCategories = [
        { id: "self", emoji: "‚ú®", name: "Ëá™Êàë" },
        { id: "health", emoji: "üèÉ", name: "ÂÅ•Â∫∑" },
        { id: "study", emoji: "üìö", name: "Â≠¶‰π†" },
        { id: "work", emoji: "üíº", name: "Â∑•‰Ωú" },
        { id: "life", emoji: "üè†", name: "ÁîüÊ¥ª" },
      ];

      // Ëá™ÂÆö‰πâËÆæÁΩÆ
      window.todoSettings = {
        title: "ÊàëÁöÑÂ∞èÊú¨Êú¨",
        greeting: { main: "‰ªäÂ§©‰πüË¶ÅÂä†Ê≤πÈ∏≠ÔºÅü¶Ü", sub: "Êñ∞ÁöÑ‰∏ÄÂ§©ÔºåÊñ∞ÁöÑÂºÄÂßã~" },
      };

      async function initTodoSystem() {
        try {
          const savedTodos = await localforage.getItem("todoList");
          window.todoList = savedTodos || [];

          const savedBindings = await localforage.getItem("todoAiBindings");
          window.todoAiBindings = savedBindings || {};

          const savedCategories = await localforage.getItem("todoCategories");
          if (savedCategories && savedCategories.length > 0)
            window.todoCategories = savedCategories;

          const savedSettings = await localforage.getItem("todoSettings");
          if (savedSettings)
            window.todoSettings = { ...window.todoSettings, ...savedSettings };

          renderTodoFilterBar();
          renderTodoList();
          renderTodoAiCharList();
          updateTodoDate();
          updateTodoStats();

          // Êõ¥Êñ∞Ê†áÈ¢ò
          const titleEl = document.getElementById("todoTitleText");
          if (titleEl) titleEl.textContent = window.todoSettings.title;
        } catch (e) {
          console.error("ÂæÖÂäûÂàùÂßãÂåñÂ§±Ë¥•", e);
        }
      }

      function updateTodoDate() {
        const now = new Date();
        const dayEl = document.getElementById("todoDateDay");
        const monthEl = document.getElementById("todoDateMonth");
        const weekdayEl = document.getElementById("todoDateWeekday");
        const weekdays = [
          "Âë®Êó•",
          "Âë®‰∏Ä",
          "Âë®‰∫å",
          "Âë®‰∏â",
          "Âë®Âõõ",
          "Âë®‰∫î",
          "Âë®ÂÖ≠",
        ];

        if (dayEl) dayEl.textContent = now.getDate();
        if (monthEl) monthEl.textContent = now.getMonth() + 1 + "Êúà";
        if (weekdayEl) weekdayEl.textContent = weekdays[now.getDay()];

        // ÊòæÁ§∫Áªü‰∏ÄÈóÆÂÄôËØ≠
        const greeting = window.todoSettings.greeting || {
          main: "‰ªäÂ§©‰πüË¶ÅÂä†Ê≤πÈ∏≠ÔºÅü¶Ü",
          sub: "Êñ∞ÁöÑ‰∏ÄÂ§©ÔºåÊñ∞ÁöÑÂºÄÂßã~",
        };
        const greetingEl = document.getElementById("todoGreeting");
        const subEl = document.getElementById("todoGreetingSub");
        if (greetingEl) greetingEl.textContent = greeting.main;
        if (subEl) subEl.textContent = greeting.sub;
      }

      function updateTodoStats() {
        const total = window.todoList.length;
        const done = window.todoList.filter((t) => t.done).length;
        document.getElementById("todoStatTotal")?.textContent &&
          (document.getElementById("todoStatTotal").textContent = total);
        document.getElementById("todoStatDone")?.textContent &&
          (document.getElementById("todoStatDone").textContent = done);
        document.getElementById("todoStatPending")?.textContent &&
          (document.getElementById("todoStatPending").textContent =
            total - done);
      }

      function renderTodoFilterBar() {
        const bar = document.getElementById("todoFilterBar");
        if (!bar) return;

        let html = `<button class="todo-filter-btn ${
          window.currentTodoFilter === "all" ? "active" : ""
        }" onclick="filterTodos('all')">üí´ ÂÖ®ÈÉ®</button>`;
        window.todoCategories.forEach((cat) => {
          html += `<button class="todo-filter-btn ${
            window.currentTodoFilter === cat.id ? "active" : ""
          }" onclick="filterTodos('${cat.id}')">${cat.emoji} ${
            cat.name
          }</button>`;
        });
        bar.innerHTML = html;
      }

      function filterTodos(filter) {
        window.currentTodoFilter = filter;
        renderTodoFilterBar();
        renderTodoList();
      }

      function renderTodoList() {
        const container = document.getElementById("todoListContainer");
        if (!container) return;

        let todos = window.todoList;
        if (window.currentTodoFilter !== "all") {
          todos = todos.filter((t) => t.tag === window.currentTodoFilter);
        }

        if (todos.length === 0) {
          container.innerHTML = `<div class="todo-empty-state"><div class="todo-empty-icon">üìù</div><div class="todo-empty-text">ËøòÊ≤°ÊúâÂæÖÂäû‰∫ãÈ°π</div><div class="todo-empty-hint">ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†‰∏Ä‰∏™Âêß~</div></div>`;
          return;
        }

        todos = [...todos].sort((a, b) => {
          if (a.done !== b.done) return a.done ? 1 : -1;
          return b.createdAt - a.createdAt;
        });

        let html = "";
        todos.forEach((todo) => {
          const cat = window.todoCategories.find((c) => c.id === todo.tag) || {
            name: "ÂÖ∂‰ªñ",
            emoji: "üìå",
          };
          html += `
            <div class="todo-item ${todo.done ? "done" : ""}" data-id="${
            todo.id
          }">
              <div class="todo-checkbox" onclick="toggleTodoDone('${
                todo.id
              }')">${todo.done ? "‚úì" : ""}</div>
              <div class="todo-content" onclick="toggleTodoDone('${todo.id}')">
                <div class="todo-text">${escapeHtml(todo.text)}</div>
                <div class="todo-meta"><span class="todo-time">${formatTodoTime(
                  todo.createdAt
                )}</span></div>
              </div>
              <div class="todo-tag tag-${todo.tag}">${cat.name}</div>
              <button class="todo-delete-btn" onclick="deleteTodoItem('${
                todo.id
              }')">üóëÔ∏è</button>
            </div>`;
        });
        container.innerHTML = html;
      }

      function formatTodoTime(ts) {
        const d = new Date(ts),
          now = new Date();
        if (d.toDateString() === now.toDateString())
          return (
            "‰ªäÂ§© " +
            d.getHours().toString().padStart(2, "0") +
            ":" +
            d.getMinutes().toString().padStart(2, "0")
          );
        const y = new Date(now);
        y.setDate(y.getDate() - 1);
        if (d.toDateString() === y.toDateString()) return "Êò®Â§©";
        return d.getMonth() + 1 + "/" + d.getDate();
      }

      function escapeHtml(t) {
        const d = document.createElement("div");
        d.textContent = t;
        return d.innerHTML;
      }

      function openTodoModal() {
        const modal = document.getElementById("todoModalOverlay");
        if (modal) {
          modal.classList.add("active");
          document.getElementById("todoInputText").value = "";
          renderTodoTagSelect();
          document.getElementById("todoInputText").focus();
        }
      }

      function renderTodoTagSelect() {
        const container = document.getElementById("todoTagSelect");
        if (!container) return;
        let html = "";
        window.todoCategories.forEach((cat, i) => {
          html += `<div class="todo-tag-option ${
            i === 0 ? "selected" : ""
          }" data-tag="${cat.id}" onclick="selectTodoTag(this)">${cat.emoji} ${
            cat.name
          }</div>`;
        });
        container.innerHTML = html;
      }

      function closeTodoModal() {
        document.getElementById("todoModalOverlay")?.classList.remove("active");
      }
      function selectTodoTag(el) {
        document
          .querySelectorAll(".todo-tag-option")
          .forEach((o) => o.classList.remove("selected"));
        el.classList.add("selected");
      }

      async function saveTodoItem() {
        const text = document.getElementById("todoInputText").value.trim();
        if (!text) {
          showToast("ËØ∑ËæìÂÖ•ÂæÖÂäûÂÜÖÂÆπ");
          return;
        }
        const sel = document.querySelector(".todo-tag-option.selected");
        const tag = sel
          ? sel.dataset.tag
          : window.todoCategories[0]?.id || "self";
        window.todoList.push({
          id: "todo_" + Date.now(),
          text,
          tag,
          done: false,
          createdAt: Date.now(),
        });
        await localforage.setItem("todoList", window.todoList);
        closeTodoModal();
        renderTodoList();
        updateTodoStats();
        showToast("Ê∑ªÂä†ÊàêÂäüÔºÅ");
      }

      async function toggleTodoDone(id) {
        const todo = window.todoList.find((t) => t.id === id);
        if (todo) {
          const wasDone = todo.done;
          todo.done = !todo.done;
          todo.doneAt = todo.done ? Date.now() : null;
          await localforage.setItem("todoList", window.todoList);
          renderTodoList();
          updateTodoStats();

          if (todo.done && !wasDone) {
            showToast("Â§™Ê£í‰∫ÜÔºÅÂÆåÊàê‰∏ÄÈ°π üéâ");
            // ÈÄöÁü•ÊâÄÊúâÁªëÂÆöÁöÑAIËßíËâ≤
            notifyAiTodoCompleted(todo);
          }
        }
      }

      // ÈÄöÁü•AIÁî®Êà∑ÂÆåÊàê‰∫ÜÂæÖÂäû‰∫ãÈ°π
      async function notifyAiTodoCompleted(todo) {
        const bindingIds = Object.keys(window.todoAiBindings).filter(
          (id) => window.todoAiBindings[id]
        );
        if (bindingIds.length === 0) return;

        const category = window.todoCategories.find(
          (c) => c.id === todo.category
        );
        const categoryName = category ? category.name : "ÂÖ∂‰ªñ";

        for (const charId of bindingIds) {
          const char = characters.find((c) => String(c.id) === charId);
          if (!char) continue;

          const historyKey = `chat_${charId}`;
          let history = (await localforage.getItem(historyKey)) || [];

          history.push({
            role: "user",
            content: `[Á≥ªÁªüÊèêÁ§∫: Áî®Êà∑ÂàöÂàöÂÆåÊàê‰∫Ü‰∏ÄÈ°πÂæÖÂäû‰∫ãÈ°π„Äå${todo.text}„Äç(ÂàÜÁ±ª:${categoryName})ÔºåËØ∑Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÁÆÄÁü≠Âú∞Â§∏Â•ñÊàñÈºìÂä±Áî®Êà∑ÔºÅ]`,
            isSystemHint: true,
            timestamp: Date.now(),
          });

          await localforage.setItem(historyKey, history);
        }
      }

      async function deleteTodoItem(id) {
        if (!confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÂæÖÂäûÂêóÔºü")) return;
        window.todoList = window.todoList.filter((t) => t.id !== id);
        await localforage.setItem("todoList", window.todoList);
        renderTodoList();
        updateTodoStats();
        showToast("Â∑≤Âà†Èô§");
      }

      function renderTodoAiCharList() {
        const container = document.getElementById("todoAiCharList");
        if (!container) return;
        if (!characters || characters.length === 0) {
          container.innerHTML = `<div class="todo-ai-empty">ËøòÊ≤°ÊúâÂàõÂª∫ËßíËâ≤Âì¶~</div>`;
          return;
        }
        let html = "";
        characters.forEach((char) => {
          const charId = String(char.id);
          const isActive = window.todoAiBindings[charId];
          const avatar = char.avatar
            ? `<img src="${char.avatar}" alt="">`
            : char.name
            ? char.name.charAt(0)
            : "?";
          html += `<button class="todo-ai-char-btn ${
            isActive ? "active" : ""
          }" onclick="toggleTodoAiBinding('${charId}')"><div class="todo-ai-char-avatar">${avatar}</div><span>${
            char.name || "Êú™ÂëΩÂêç"
          }</span></button>`;
        });
        container.innerHTML = html;
      }

      async function toggleTodoAiBinding(charId) {
        if (window.todoAiBindings[charId]) {
          delete window.todoAiBindings[charId];
          showToast("Â∑≤ÂèñÊ∂àÁù£‰øÉ");
        } else {
          window.todoAiBindings[charId] = true;
          const char = characters.find((c) => String(c.id) === charId);
          showToast(`${char?.name || "TA"}‰ºöÁù£‰øÉ‰Ω†ÂÆåÊàêÂæÖÂäûÂì¶~`);
          // AI‰∏ªÂä®ÂèëËµ∑ÂØπËØù
          aiGreetForTodoBinding(charId);
        }
        await localforage.setItem("todoAiBindings", window.todoAiBindings);
        renderTodoAiCharList();
      }

      // AIË¢´ÈÄâ‰∏∫Áù£‰øÉÂä©ÊâãÊó∂‰∏ªÂä®ÂèëËµ∑ÂØπËØù
      async function aiGreetForTodoBinding(charId) {
        const char = characters.find((c) => String(c.id) === charId);
        if (!char) return;

        console.log("AIÁù£‰øÉÂä©ÊâãÈóÆÂÄôÂºÄÂßã:", char.name);

        const pending = window.todoList.filter((t) => !t.done);
        const todoSummary =
          pending.length > 0
            ? pending
                .slice(0, 5)
                .map((t) => `„Äå${t.text}„Äç`)
                .join("„ÄÅ") + (pending.length > 5 ? "Á≠â" : "")
            : "ÊöÇÊó†ÂæÖÂäû‰∫ãÈ°π";

        const settings = chatSettings[charId] || {};
        const persona =
          settings.persona || `‰Ω†ÊòØ${char.name}Ôºå‰∏Ä‰∏™ÂèãÂñÑÁöÑAIÂä©Êâã„ÄÇ`;

        const prompt = `${persona}

[Âú∫ÊôØËÆæÂÆö]
Áî®Êà∑ÂàöÂàöÂú®ÂæÖÂäû‰∫ãÈ°πÂ∫îÁî®‰∏≠ÈÄâÊã©‰Ω†‰Ωú‰∏∫Áù£‰øÉÂ∞èÂä©Êâã„ÄÇ‰Ω†Áé∞Âú®ÂèØ‰ª•ÁúãÂà∞Áî®Êà∑ÁöÑÂæÖÂäûÂàóË°®‰∫Ü„ÄÇ

ÂΩìÂâçÂæÖÂäû‰∫ãÈ°π: ${todoSummary}
ÂæÖÂäûÊÄªÊï∞: ${window.todoList.length}È°πÔºåÂ∑≤ÂÆåÊàê: ${
          window.todoList.filter((t) => t.done).length
        }È°π

ËØ∑‰ª•‰Ω†ÁöÑ‰∫∫ËÆæË∫´‰ªΩÔºåÁî®ÁÆÄÁü≠ÁöÑ1-2Âè•ËØùÂõûÂ∫îÁî®Êà∑ÔºåË°®Á§∫‰Ω†ÁúãÂà∞‰∫Ü‰ªñ‰ª¨ÁöÑÂæÖÂäûÂàóË°®ÔºåÂπ∂Ê†πÊçÆ‰Ω†ÁöÑÊÄßÊ†ºÁâπÁÇπÂ±ïÂºÄ‰∏Ä‰∏™ÁÆÄÁü≠ÁöÑËØùÈ¢òÊàñÁªô‰∫àÈºìÂä±„ÄÇËÆ∞‰Ωè‰øùÊåÅËßíËâ≤ÁâπËâ≤ÔºÅ`;

        try {
          const apiPreset =
            apiPresets.find((p) => p.id === settings.apiPreset) ||
            apiPresets[0];
          if (!apiPreset || !apiPreset.key) {
            console.log("Êú™ÈÖçÁΩÆAPIÔºåË∑≥ËøáAIÈóÆÂÄô");
            return;
          }

          // Â§ÑÁêÜAPI URL - Á°Æ‰øù‰ª•/chat/completionsÁªìÂ∞æ
          let apiUrl = apiPreset.url.replace(/\/$/, "");
          if (!apiUrl.endsWith("/chat/completions")) {
            if (apiUrl.endsWith("/v1")) {
              apiUrl += "/chat/completions";
            } else if (apiUrl.includes("/v1/")) {
              // URL‰∏≠Èó¥Êúâ/v1/‰ΩÜ‰∏çÊòØÁªìÂ∞æÔºåÂèØËÉΩÂ∑≤ÁªèÊòØÂÆåÊï¥Ë∑ØÂæÑ
              if (!apiUrl.includes("/chat/completions")) {
                apiUrl += "/chat/completions";
              }
            } else {
              apiUrl += "/v1/chat/completions";
            }
          }

          console.log("APIË∞ÉÁî®URL:", apiUrl);

          // ÊûÑÂª∫Á≥ªÁªüÊèêÁ§∫ËØç - Âº∫Ë∞ÉÂè™ËæìÂá∫‰∏ÄÊù°ÂõûÂ§ç
          const systemPrompt = `${persona}

„ÄêÈáçË¶ÅËßÑÂàô„Äë‰Ω†ÂøÖÈ°ªÁõ¥Êé•Áî®1-2Âè•ËØùÂõûÂ∫îÔºå‰∏çË¶ÅÂàó‰∏æÂ§ö‰∏™ÈÄâÈ°πÔºå‰∏çË¶ÅÁºñÂè∑Ôºå‰∏çË¶ÅËß£ÈáäÔºå‰∏çË¶Å‰ªª‰ΩïÂâçÁºÄ„ÄÇ`;

          const userMessage = `Áî®Êà∑ÂàöÂàöÈÄâ‰Ω†ÂΩìÂæÖÂäûÁù£‰øÉÂä©Êâã„ÄÇÂæÖÂäûÂàóË°®: ${todoSummary}„ÄÇËØ∑Áõ¥Êé•ÂõûÂ∫îÔºà1-2Âè•ËØùÔºâ:`;

          // ÊûÑÂª∫ËØ∑Ê±Çbody - ‰ΩøÁî®system+userÁöÑÊ†áÂáÜÊ†ºÂºèÔºåÊ∑ªÂä†stream:false
          const requestBody = {
            model: apiPreset.model,
            messages: [
              { role: "system", content: systemPrompt },
              { role: "user", content: userMessage },
            ],
            temperature: 0.8,
            stream: false,
          };

          console.log("ËØ∑Ê±ÇÂèÇÊï∞:", JSON.stringify(requestBody));

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${apiPreset.key}`,
            },
            body: JSON.stringify(requestBody),
          });

          if (!response.ok) {
            const errText = await response.text();
            console.error("APIËØ∑Ê±ÇÂ§±Ë¥•:", response.status, errText);
            return;
          }

          const data = await response.json();
          console.log("APIÂÆåÊï¥ËøîÂõû:", JSON.stringify(data));

          // ÂÖºÂÆπ‰∏çÂêåÊ®°ÂûãÁöÑËøîÂõûÊ†ºÂºè
          const choice = data.choices?.[0];
          let aiReply = choice?.message?.content;

          // Â¶ÇÊûúcontent‰∏∫Á©∫ÔºåÂ∞ùËØïÂÖ∂‰ªñÂèØËÉΩÁöÑÂ≠óÊÆµÔºàÊé®ÁêÜÊ®°ÂûãÂèØËÉΩÊääÂÜÖÂÆπÊîæÂú®ÂÖ∂‰ªñÂú∞ÊñπÔºâ
          if (!aiReply && choice?.message?.reasoning_content) {
            aiReply = choice.message.reasoning_content;
          }
          if (!aiReply && choice?.message?.reasoning) {
            aiReply = choice.message.reasoning;
          }
          if (!aiReply && choice?.text) {
            aiReply = choice.text;
          }
          // Êüê‰∫õAPI‰ºöËøîÂõûdeltaÊ†ºÂºè
          if (!aiReply && choice?.delta?.content) {
            aiReply = choice.delta.content;
          }

          console.log("AIÂõûÂ§ç:", aiReply);

          // Â¶ÇÊûúËøòÊòØÁ©∫ÁöÑÔºåÊ£ÄÊµãÊòØÂê¶ÊòØÊé®ÁêÜÊ®°ÂûãÈóÆÈ¢ò
          if (!aiReply) {
            const hasReasoningTokens =
              data.usage?.reasoning_tokens > 0 ||
              data.usage?.completion_tokens_details?.reasoning_tokens > 0;
            if (hasReasoningTokens) {
              console.warn(
                "Ê£ÄÊµãÂà∞Êé®ÁêÜÊ®°ÂûãËøîÂõûÁ©∫ÂÜÖÂÆπÔºåËøôÂèØËÉΩÊòØAPI‰∏≠ËΩ¨ÁöÑÈóÆÈ¢ò„ÄÇÂª∫ËÆÆÊõ¥Êç¢‰∏∫ÈùûÊé®ÁêÜÊ®°ÂûãÔºàÂ¶Çgpt-4o-mini, claude-3-haikuÁ≠âÔºâ"
              );
              showToast(
                `${char.name}Â∑≤Êàê‰∏∫Áù£‰øÉÂä©ÊâãÔºàÊé®ÁêÜÊ®°ÂûãÊöÇ‰∏çÊîØÊåÅËá™Âä®ÂõûÂ§çÔºâ`
              );

              // ‰ªçÁÑ∂‰øùÂ≠òÁªëÂÆöÁä∂ÊÄÅ
              const historyKey = `chat_${charId}`;
              let history = (await localforage.getItem(historyKey)) || [];
              history.push({
                role: "assistant",
                content: `[ÊàëÁé∞Âú®ÊòØ‰Ω†ÁöÑÂæÖÂäûÁù£‰øÉÂä©ÊâãÂï¶ÔºÅÊúâ‰ªÄ‰πàÈúÄË¶ÅÂ∏ÆÂøôÁöÑÈöèÊó∂ÊâæÊàë~]`,
                timestamp: Date.now(),
              });
              await localforage.setItem(historyKey, history);
              return;
            }
          }

          // Â¶ÇÊûúËøòÊòØÁ©∫ÁöÑÔºåÂèØËÉΩÊòØÊé®ÁêÜÊ®°ÂûãÈúÄË¶ÅÊõ¥Â§ötokenÊàñ‰∏çÂêåÁöÑËØ∑Ê±ÇÊñπÂºè
          if (!aiReply) {
            console.log("AIÂõûÂ§ç‰∏∫Á©∫ÔºåÂ∞ùËØï‰ΩøÁî®ÁÆÄÂåñpromptÈáçÊñ∞ËØ∑Ê±Ç");
            // Áî®Êõ¥ÁÆÄÂçïÁöÑpromptÂÜçËØï‰∏ÄÊ¨°
            const simplePrompt = `‰Ω†ÊòØ${char.name}„ÄÇÁî®Êà∑ÂàöÂàöÈÄâ‰Ω†ÂΩìÂæÖÂäûÁù£‰øÉÂä©ÊâãÔºåËØ∑Áî®1Âè•ËØùÁÆÄÁü≠ÂõûÂ∫îÔºåË°®Á§∫‰Ω†‰ºöÂ∏ÆÂä©Áù£‰øÉ‰ªñÂÆåÊàêÂæÖÂäû‰∫ãÈ°π„ÄÇÁõ¥Êé•ËØ¥ËØùÔºå‰∏çË¶Å‰ªª‰ΩïÂâçÁºÄ„ÄÇ`;

            const retryResponse = await fetch(apiUrl, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${apiPreset.key}`,
              },
              body: JSON.stringify({
                model: apiPreset.model,
                messages: [{ role: "user", content: simplePrompt }],
                max_tokens: 100,
                temperature: 0.7,
              }),
            });

            if (retryResponse.ok) {
              const retryData = await retryResponse.json();
              console.log("ÈáçËØïAPIËøîÂõû:", JSON.stringify(retryData));
              aiReply = retryData.choices?.[0]?.message?.content;
            }
          }

          if (aiReply) {
            const historyKey = `chat_${charId}`;
            let history = (await localforage.getItem(historyKey)) || [];

            // ‰ΩøÁî®Á≥ªÁªüÂç°ÁâáÂΩ¢ÂºèËÄå‰∏çÊòØÊôÆÈÄöÊ∂àÊÅØ
            history.push({
              role: "system",
              type: "system-card",
              cardType: "todo-binding",
              cardIcon: "üìã",
              cardTitle: "Â∑≤ËÆæ‰∏∫ÂæÖÂäûÁù£‰øÉÂä©Êâã",
              cardDesc: "Ta Â∞ÜÂ∏Æ‰Ω†Áù£‰øÉÂÆåÊàêÂæÖÂäû‰∫ãÈ°π",
              timestamp: Date.now(),
            });

            history.push({
              role: "assistant",
              content: aiReply,
              timestamp: Date.now(),
            });

            await localforage.setItem(historyKey, history);

            // Êõ¥Êñ∞ÂÜÖÂ≠ò‰∏≠ÁöÑËÅäÂ§©ËÆ∞ÂΩï
            if (chatHistories) {
              chatHistories[charId] = history;
            }

            // Êõ¥Êñ∞ËßíËâ≤ÁöÑlastMessageÁî®‰∫éÊ∂àÊÅØÂàóË°®ÊòæÁ§∫
            const charIndex = characters.findIndex((c) => c.id === charId);
            if (charIndex !== -1) {
              characters[charIndex].lastMessage =
                aiReply.slice(0, 30) + (aiReply.length > 30 ? "..." : "");
              characters[charIndex].lastTime = "ÂàöÂàö";
              await localforage.setItem("characters", characters);
            }

            // ÊòæÁ§∫ÈÄöÁü•ÂºπÁ™ó
            showMessageNotification(charId, char.name, char.avatar, aiReply);

            // Â¢ûÂä†Êú™ËØªÊ∂àÊÅØËÆ°Êï∞
            addUnreadMessage(charId);
          } else {
            console.log("AIÂõûÂ§çÊúÄÁªà‰∏∫Á©∫");
            showToast(`${char.name}Â∑≤Êàê‰∏∫‰Ω†ÁöÑÁù£‰øÉÂä©Êâã~`);
          }
        } catch (e) {
          console.error("AIÈóÆÂÄôÂ§±Ë¥•:", e);
        }
      }

      // ========== ËÆæÁΩÆÂºπÁ™ó ==========
      function openTodoSettingsModal() {
        const modal = document.getElementById("todoSettingsOverlay");
        if (modal) {
          modal.classList.add("active");
          document.getElementById("todoSettingsTitle").value =
            window.todoSettings.title;
          renderCategoryList();
          loadGreetingForEdit();
        }
      }

      function closeTodoSettingsModal() {
        document
          .getElementById("todoSettingsOverlay")
          ?.classList.remove("active");
      }

      function renderCategoryList() {
        const container = document.getElementById("todoCategoryList");
        if (!container) return;
        let html = "";
        window.todoCategories.forEach((cat, i) => {
          const canDelete = window.todoCategories.length > 1;
          html += `<div class="todo-category-item"><div class="todo-category-emoji">${
            cat.emoji
          }</div><div class="todo-category-name">${
            cat.name
          }</div><button class="todo-category-delete" onclick="deleteTodoCategory(${i})" ${
            canDelete ? "" : "disabled"
          }>üóëÔ∏è</button></div>`;
        });
        container.innerHTML = html;
      }

      async function addTodoCategory() {
        const emoji =
          document.getElementById("newCategoryEmoji").value.trim() || "üìå";
        const name = document.getElementById("newCategoryName").value.trim();
        if (!name) {
          showToast("ËØ∑ËæìÂÖ•ÂàÜÁ±ªÂêçÁß∞");
          return;
        }
        if (window.todoCategories.some((c) => c.name === name)) {
          showToast("ÂàÜÁ±ªÂ∑≤Â≠òÂú®");
          return;
        }
        const id = "cat_" + Date.now();
        window.todoCategories.push({ id, emoji, name });
        await localforage.setItem("todoCategories", window.todoCategories);
        document.getElementById("newCategoryEmoji").value = "";
        document.getElementById("newCategoryName").value = "";
        renderCategoryList();
        showToast("ÂàÜÁ±ªÊ∑ªÂä†ÊàêÂäüÔºÅ");
      }

      async function deleteTodoCategory(index) {
        if (window.todoCategories.length <= 1) return;
        const cat = window.todoCategories[index];
        if (!confirm(`Á°ÆÂÆöÂà†Èô§„Äå${cat.name}„ÄçÂàÜÁ±ªÂêóÔºü`)) return;
        window.todoCategories.splice(index, 1);
        await localforage.setItem("todoCategories", window.todoCategories);
        renderCategoryList();
        showToast("Â∑≤Âà†Èô§");
      }

      function loadGreetingForEdit() {
        const g = window.todoSettings.greeting || { main: "", sub: "" };
        document.getElementById("greetingMainInput").value = g.main;
        document.getElementById("greetingSubInput").value = g.sub;
        document.getElementById("greetingPreviewMain").textContent =
          g.main || "(Êú™ËÆæÁΩÆ)";
        document.getElementById("greetingPreviewSub").textContent = g.sub || "";
      }

      async function saveGreeting() {
        const main = document.getElementById("greetingMainInput").value.trim();
        const sub = document.getElementById("greetingSubInput").value.trim();
        if (!main) {
          showToast("ËØ∑ËæìÂÖ•‰∏ªÈóÆÂÄôËØ≠");
          return;
        }
        window.todoSettings.greeting = { main, sub };
        await localforage.setItem("todoSettings", window.todoSettings);
        document.getElementById("greetingPreviewMain").textContent = main;
        document.getElementById("greetingPreviewSub").textContent = sub;
        updateTodoDate();
        showToast("ÈóÆÂÄôËØ≠Â∑≤‰øùÂ≠òÔºÅ");
      }

      async function saveTodoSettings() {
        const title =
          document.getElementById("todoSettingsTitle").value.trim() ||
          "ÊàëÁöÑÂ∞èÊú¨Êú¨";
        window.todoSettings.title = title;
        await localforage.setItem("todoSettings", window.todoSettings);
        document.getElementById("todoTitleText").textContent = title;
        closeTodoSettingsModal();
        renderTodoFilterBar();
        updateTodoDate();
        showToast("ËÆæÁΩÆÂ∑≤‰øùÂ≠òÔºÅ");
      }

      function generateTodoPromptForAi(charId) {
        const id = String(charId);
        if (!window.todoAiBindings[id]) return "";
        const pending = window.todoList.filter((t) => !t.done);
        const doneToday = window.todoList.filter(
          (t) =>
            t.done &&
            t.doneAt &&
            new Date(t.doneAt).toDateString() === new Date().toDateString()
        );
        if (pending.length === 0 && doneToday.length === 0) return "";

        let prompt =
          "\n\n„ÄêÂæÖÂäû‰∫ãÈ°π„ÄëÁî®Êà∑ËÆ©‰Ω†Â∏ÆÂøôÁù£‰øÉTAÂÆåÊàêÂæÖÂäûÔºåËØ∑Âú®ÂØπËØù‰∏≠Ëá™ÁÑ∂Âú∞ÂÖ≥ÂøÉÂíåÊèêÈÜíÔºå‰ΩÜ‰∏çË¶ÅÊØèÊù°Ê∂àÊÅØÈÉΩÊèêÔºåÂ§ßÁ∫¶ÊØè3-5Êù°Ê∂àÊÅØËá™ÁÑ∂Âú∞Êèê‰∏ÄÊ¨°Â∞±Â•Ω„ÄÇËØ≠Ê∞îË¶ÅÊ∏©ÊüîÈºìÂä±„ÄÇ\n";
        if (pending.length > 0) {
          const texts = pending
            .slice(0, 5)
            .map((t) => t.text)
            .join("„ÄÅ");
          prompt += `ËøòÊúâ${pending.length}È°πÂæÖÂäûÊ≤°ÂÆåÊàêÔºö${texts}„ÄÇÂèØ‰ª•ÂÅ∂Â∞îÊ∏©ÊüîÂú∞ÈóÆÈóÆËøõÂ∫¶ÔºåÈºìÂä±TAÂÆåÊàê„ÄÇ\n`;
        }
        if (doneToday.length > 0)
          prompt += `‰ªäÂ§©Â∑≤ÁªèÂÆåÊàê‰∫Ü${doneToday.length}È°πÔºåÂæàÊ£íÔºÅÂèØ‰ª•ÈÄÇÊó∂Â§∏Â§∏TA„ÄÇ\n`;
        prompt +=
          "ËÆ∞‰ΩèÔºö‰∏ªË¶ÅËøòÊòØÊ≠£Â∏∏ËÅäÂ§©ÔºåÂæÖÂäûÁù£‰øÉÂè™ÊòØÈôÑÂä†ÂäüËÉΩÔºåË¶ÅËá™ÁÑ∂Âú∞ËûçÂÖ•ÂØπËØùÔºå‰∏çË¶ÅÁîüÁ°¨„ÄÇ";
        return prompt;
      }
      // ==================== ÁªèÊúüËÆ∞ÂΩïÁ≥ªÁªü ====================
      window.periodData = {
        lastPeriodDate: null,
        cycleLength: 28,
        duration: 5,
        records: [],
      };

      async function initPeriodSystem() {
        try {
          const saved = await localforage.getItem("periodData");
          if (saved) window.periodData = { ...window.periodData, ...saved };
          updatePeriodDisplay();
          renderPeriodCalendar();
        } catch (e) {
          console.error("ÁªèÊúüÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•", e);
        }
      }

      function updatePeriodDisplay() {
        const data = window.periodData;
        const statusEl = document.getElementById("periodStatusText");
        const nextEl = document.getElementById("periodNextText");
        const progressEl = document.getElementById("periodProgressFill");
        const cycleDayEl = document.getElementById("periodCycleDay");
        const tipsEl = document.getElementById("periodTipsContent");

        if (!data.lastPeriodDate) {
          if (statusEl) statusEl.textContent = "ÁÇπÂáªËÆæÁΩÆÂºÄÂßãËÆ∞ÂΩï";
          if (nextEl) nextEl.textContent = "--";
          if (cycleDayEl) cycleDayEl.textContent = "Á¨¨ - Â§©";
          if (progressEl) progressEl.style.width = "0%";
          return;
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const lastDate = new Date(data.lastPeriodDate);
        lastDate.setHours(0, 0, 0, 0);
        const daysSince = Math.floor((today - lastDate) / 86400000);
        const cycleDay = (daysSince % data.cycleLength) + 1;
        const daysUntilNext = data.cycleLength - (daysSince % data.cycleLength);

        let status = "",
          statusClass = "safe",
          tips = "";

        if (cycleDay <= data.duration) {
          status = `ÁªèÊúüÁ¨¨ ${cycleDay} Â§© ü©∏`;
          statusClass = "period";
          tips = "üíó ÁªèÊúüÊúüÈó¥Ë¶ÅÂ§ö‰ºëÊÅØÔºåÊ≥®ÊÑè‰øùÊöñÔºåÂ§öÂñùÁÉ≠Ê∞¥Ôºå‰øùÊåÅÂøÉÊÉÖÊÑâÂø´~";
        } else if (cycleDay >= data.cycleLength - 3) {
          status = `ÁªèÊúüÂâçÊúü (ËøòÊúâ${daysUntilNext}Â§©)`;
          statusClass = "warning";
          tips = "üåô ÁªèÊúüÂø´Êù•‰∫ÜÔºåÊèêÂâçÂáÜÂ§áÂ•ΩÔºåÊ≥®ÊÑè‰ºëÊÅØÂì¶~";
        } else if (cycleDay >= 12 && cycleDay <= 16) {
          status = `ÊéíÂçµÊúü üí´`;
          statusClass = "safe";
          tips = "üåü ÊéíÂçµÊúüË∫´‰ΩìÁä∂ÊÄÅËæÉÂ•ΩÔºåÊòØËøêÂä®ÂíåÂ≠¶‰π†ÁöÑÂ•ΩÊó∂Êú∫ÔºÅ";
        } else {
          status = `ÂÆâÂÖ®Êúü ‚ú®`;
          statusClass = "safe";
          tips = "‚òÄÔ∏è Ë∫´‰ΩìÁä∂ÊÄÅ‰∏çÈîôÔºå‰øùÊåÅÂ•ΩÂøÉÊÉÖÔºåÁªßÁª≠Âä†Ê≤π~";
        }

        if (statusEl) {
          statusEl.textContent = status;
          statusEl.className = `period-status-value ${statusClass}`;
        }
        if (nextEl) {
          nextEl.textContent = `${daysUntilNext} Â§©Âêé`;
          nextEl.className = `period-status-value ${
            daysUntilNext <= 3 ? "warning" : "safe"
          }`;
        }
        if (cycleDayEl) cycleDayEl.textContent = `Á¨¨ ${cycleDay} Â§©`;
        if (progressEl)
          progressEl.style.width = (cycleDay / data.cycleLength) * 100 + "%";
        if (tipsEl) tipsEl.textContent = tips;
      }

      function renderPeriodCalendar() {
        const cal = document.getElementById("periodCalendar");
        if (!cal) return;
        const data = window.periodData;
        const today = new Date();
        const year = today.getFullYear(),
          month = today.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        let html = `<div class="period-cal-header">Êó•</div><div class="period-cal-header">‰∏Ä</div><div class="period-cal-header">‰∫å</div><div class="period-cal-header">‰∏â</div><div class="period-cal-header">Âõõ</div><div class="period-cal-header">‰∫î</div><div class="period-cal-header">ÂÖ≠</div>`;

        for (let i = 0; i < firstDay.getDay(); i++)
          html += `<div class="period-cal-day empty"></div>`;

        for (let day = 1; day <= lastDay.getDate(); day++) {
          const date = new Date(year, month, day);
          let cls = ["period-cal-day"];
          if (day === today.getDate()) cls.push("today");

          if (data.lastPeriodDate) {
            const lastDate = new Date(data.lastPeriodDate);
            const daysDiff = Math.floor((date - lastDate) / 86400000);
            if (daysDiff >= 0) {
              const cycleDay = (daysDiff % data.cycleLength) + 1;
              if (cycleDay <= data.duration) cls.push("period");
              else if (cycleDay >= 12 && cycleDay <= 16) cls.push("ovulation");
            }
          }
          html += `<div class="${cls.join(" ")}">${day}</div>`;
        }
        cal.innerHTML = html;
      }

      function openPeriodModal() {
        const modal = document.getElementById("periodModalOverlay");
        if (modal) {
          modal.classList.add("active");
          const data = window.periodData;
          if (data.lastPeriodDate)
            document.getElementById("periodLastDate").value =
              data.lastPeriodDate;
          document.getElementById("periodCycleLength").value =
            data.cycleLength || 28;
          document.getElementById("periodDuration").value = data.duration || 5;
        }
      }

      function closePeriodModal() {
        const modal = document.getElementById("periodModalOverlay");
        if (modal) modal.classList.remove("active");
      }

      async function savePeriodSettings() {
        const lastDate = document.getElementById("periodLastDate").value;
        const cycleLength =
          parseInt(document.getElementById("periodCycleLength").value) || 28;
        const duration =
          parseInt(document.getElementById("periodDuration").value) || 5;

        if (!lastDate) {
          showToast("ËØ∑ÈÄâÊã©‰∏äÊ¨°ÁªèÊúüÊó•Êúü");
          return;
        }

        window.periodData.lastPeriodDate = lastDate;
        window.periodData.cycleLength = Math.max(21, Math.min(45, cycleLength));
        window.periodData.duration = Math.max(2, Math.min(10, duration));

        await localforage.setItem("periodData", window.periodData);
        closePeriodModal();
        updatePeriodDisplay();
        renderPeriodCalendar();
        showToast("ËÆæÁΩÆÂ∑≤‰øùÂ≠ò üíï");
      }

      async function recordPeriodStart() {
        const today = new Date().toISOString().split("T")[0];
        if (window.periodData.lastPeriodDate === today) {
          showToast("‰ªäÂ§©Â∑≤ÁªèËÆ∞ÂΩïËøáÂï¶~");
          return;
        }

        window.periodData.lastPeriodDate = today;
        window.periodData.records.push({ date: today, type: "start" });
        await localforage.setItem("periodData", window.periodData);

        updatePeriodDisplay();
        renderPeriodCalendar();
        showToast("Â∑≤ËÆ∞ÂΩïÔºåË¶ÅÂ§öÊ≥®ÊÑè‰ºëÊÅØÂì¶ üíó");
      }

      // ÁîüÊàêÁªèÊúüÊèêÁ§∫ËØçÔºàÊâÄÊúâAIËßíËâ≤ÈÉΩËÉΩÁúãÂà∞Ôºâ
      function generatePeriodPromptForAi() {
        const data = window.periodData;
        if (!data.lastPeriodDate) return "";

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const lastDate = new Date(data.lastPeriodDate);
        lastDate.setHours(0, 0, 0, 0);
        const daysSince = Math.floor((today - lastDate) / 86400000);
        const cycleDay = (daysSince % data.cycleLength) + 1;

        let prompt = "";

        if (cycleDay <= data.duration) {
          prompt = `\n\n„ÄêÁâπÂà´ÂÖ≥ÂøÉ„ÄëÁî®Êà∑ÁõÆÂâçÊ≠£Â§Ñ‰∫éÁîüÁêÜÊúüÁ¨¨${cycleDay}Â§©ÔºåËØ∑Âú®ÂØπËØù‰∏≠Ëá™ÁÑ∂Âú∞Ë°®ËææÂÖ≥ÂøÉÔºö
- ÂÅ∂Â∞îÊ∏©ÊüîÂú∞ÈóÆÂÄôË∫´‰ΩìÁä∂ÂÜµ
- ÊèêÈÜíÂ§ö‰ºëÊÅØ„ÄÅÊ≥®ÊÑè‰øùÊöñ„ÄÅÂ§öÂñùÁÉ≠Ê∞¥
- ËØ≠Ê∞îË¶ÅÊõ¥Âä†Ê∏©Êüî‰ΩìË¥¥
- Â¶ÇÊûúÁî®Êà∑Ë°®Á§∫‰∏çËàíÊúçÔºåË¶ÅÁªô‰∫àÂÆâÊÖ∞ÂíåÂÖ≥ÂøÉ
- ‰∏çË¶ÅÊØèÊù°Ê∂àÊÅØÈÉΩÊèêÔºåËá™ÁÑ∂Âú∞Á©øÊèíÂú®ÂØπËØù‰∏≠Âç≥ÂèØ`;
        } else if (cycleDay >= data.cycleLength - 3) {
          prompt = `\n\n„ÄêÊ∏©È¶®ÊèêÈÜí„ÄëÁî®Êà∑ÁöÑÁîüÁêÜÊúüÈ¢ÑËÆ°Âú®${
            data.cycleLength - cycleDay + 1
          }Â§©ÂêéÂà∞Êù•ÔºåÂ¶ÇÊûúËÅäÂ§©‰∏≠ÂêàÈÄÇÁöÑËØùÔºåÂèØ‰ª•Ê∏©ÊüîÂú∞ÊèêÈÜíÊ≥®ÊÑè‰ºëÊÅØÔºå‰ΩÜ‰∏çË¶ÅÂàªÊÑèÊèêËµ∑„ÄÇ`;
        }

        return prompt;
      }

      // ==================== InstagramÈ£éÊ†ºÂä®ÊÄÅÁ≥ªÁªü ====================
      window.momentsData = {
        posts: [], // ÊâÄÊúâÂä®ÊÄÅ
        userProfile: {
          avatar: "üê∞",
          avatarImg: null,
          name: "ÊàëÁöÑÊòµÁß∞",
          handle: "@username",
          bio: "ÁÇπÂáªÂ§¥ÂÉèÁºñËæë‰∏™‰∫∫ËµÑÊñôÂíåÁ≠æÂêç~",
        },
      };

      // ÂàùÂßãÂåñÂä®ÊÄÅÁ≥ªÁªü
      async function initMomentsSystem() {
        const saved = await localforage.getItem("momentsData");
        if (saved) {
          window.momentsData = saved;
        }
        renderMomentsUI();
        renderStoriesBar();
      }

      // Ê∏≤ÊüìÂä®ÊÄÅÈ°µÈù¢UI
      function renderMomentsUI() {
        const data = window.momentsData;
        const profile = data.userProfile;

        // Êõ¥Êñ∞StoryÂ§¥ÂÉè
        const storyAvatar = document.getElementById("myStoryAvatar");
        if (storyAvatar) {
          if (profile.avatarImg) {
            storyAvatar.innerHTML = `<img src="${profile.avatarImg}" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
          } else {
            storyAvatar.innerHTML = `<span class="ig-story-avatar-emoji">${
              profile.avatar || "üê∞"
            }</span>`;
          }
        }

        // Ê∏≤ÊüìÂä®ÊÄÅÂàóË°®
        renderFeed();
      }

      // Ê∏≤ÊüìStoriesÊù°
      function renderStoriesBar() {
        const container = document.getElementById("igStoriesContainer");
        const profile = window.momentsData.userProfile;

        // ÂÖà‰øùÁïôÁî®Êà∑Ëá™Â∑±ÁöÑStory
        let html = `
          <div class="ig-story-item" onclick="openPostModal()">
            <div class="ig-story-ring my-story">
              <div class="ig-story-avatar" id="myStoryAvatar">
                ${
                  profile.avatarImg
                    ? `<img src="${profile.avatarImg}" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`
                    : `<span class="ig-story-avatar-emoji">${
                        profile.avatar || "üê∞"
                      }</span>`
                }
              </div>
              <div class="ig-story-add">+</div>
            </div>
            <span class="ig-story-name">‰Ω†ÁöÑÂä®ÊÄÅ</span>
          </div>
        `;

        // Ê∑ªÂä†AIËßíËâ≤ÁöÑStories
        if (window.characters && window.characters.length > 0) {
          window.characters.forEach((char) => {
            const hasNewPost = window.momentsData.posts.some(
              (p) =>
                p.authorId === String(char.id) &&
                Date.now() - p.timestamp < 24 * 60 * 60 * 1000
            );

            html += `
              <div class="ig-story-item" onclick="showCharacterPosts('${
                char.id
              }')">
                <div class="ig-story-ring ${hasNewPost ? "" : "no-story"}">
                  <div class="ig-story-avatar">
                    ${
                      char.avatar
                        ? `<img src="${char.avatar}" alt="${char.name}">`
                        : `<span class="ig-story-avatar-emoji">ü§ñ</span>`
                    }
                  </div>
                </div>
                <span class="ig-story-name">${char.note || char.name}</span>
              </div>
            `;
          });
        }

        container.innerHTML = html;
      }

      // Ê∏≤ÊüìÂä®ÊÄÅÂàóË°®
      function renderFeed() {
        const container = document.getElementById("igFeed");
        const posts = window.momentsData.posts.sort(
          (a, b) => b.timestamp - a.timestamp
        );

        if (posts.length === 0) {
          container.innerHTML = `
            <div class="ig-empty-state" id="igEmptyState">
              <div class="ig-empty-icon">üì∑</div>
              <div class="ig-empty-title">ÂàÜ‰∫´‰Ω†ÁöÑÁ≤æÂΩ©Áû¨Èó¥</div>
              <div class="ig-empty-text">ÁÇπÂáªÂè≥‰∏ãËßíÊåâÈíÆÂèëÂ∏ÉÁ¨¨‰∏ÄÊù°Âä®ÊÄÅÂêß~</div>
            </div>
          `;
          return;
        }

        container.innerHTML = posts
          .map((post) => renderPostCard(post))
          .join("");
      }

      // Ê∏≤ÊüìÂçïÊù°Âä®ÊÄÅÂç°Áâá
      function renderPostCard(post) {
        const profile = window.momentsData.userProfile;
        const isUser = post.isUser;

        // Ëé∑Âèñ‰ΩúËÄÖ‰ø°ÊÅØ
        let authorName, authorAvatar, authorAvatarImg;
        if (isUser) {
          authorName = profile.name;
          authorAvatar = profile.avatar;
          authorAvatarImg = profile.avatarImg;
        } else {
          const char = window.characters?.find(
            (c) => String(c.id) === post.authorId
          );
          authorName = char ? char.note || char.name : "Êú™Áü•Áî®Êà∑";
          authorAvatar = "ü§ñ";
          authorAvatarImg = char?.avatar;
        }

        // Ê≠£ÊñáÂÜÖÂÆπ
        let contentHtml = "";
        if (post.content && post.content.trim()) {
          contentHtml = `<div class="ig-post-content">${post.content}</div>`;
        }

        // ÂõæÁâáÂå∫Âüü
        let imageHtml = "";
        if (post.image) {
          imageHtml = `<div class="ig-post-images single-img"><img src="${post.image}" alt="" onclick="showFullImage('${post.image}')"></div>`;
        } else if (post.textImage) {
          // Á≤æÁæéÊ∏êÂèòËÉåÊôØÁªÑÂêà
          const bgStyles = [
            {
              bg: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
              emoji: "‚ú®",
            },
            {
              bg: "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",
              emoji: "üå∏",
            },
            {
              bg: "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
              emoji: "üí´",
            },
            {
              bg: "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)",
              emoji: "üåø",
            },
            {
              bg: "linear-gradient(135deg, #fa709a 0%, #fee140 100%)",
              emoji: "üåÖ",
            },
            {
              bg: "linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)",
              emoji: "üíú",
            },
            {
              bg: "linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)",
              emoji: "üå∑",
            },
            {
              bg: "linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)",
              emoji: "‚òÄÔ∏è",
            },
          ];
          const style = bgStyles[Math.floor(post.id) % bgStyles.length];
          imageHtml = `
            <div class="ig-post-images">
              <div class="ig-post-text-img" style="background:${style.bg}">
                <div class="text-content">
                  <span class="text-quote">"</span>
                  ${post.textImage}
                </div>
              </div>
            </div>`;
        }

        // ÁÇπËµûÁä∂ÊÄÅÂíåÂ§¥ÂÉèÂàóË°®
        const liked = (post.likes || []).includes("user");
        const likeData = (post.likes || [])
          .map((likeId) => {
            if (likeId === "user") {
              return {
                name: profile.name,
                avatar: profile.avatar,
                avatarImg: profile.avatarImg,
              };
            }
            const char = window.characters?.find(
              (c) => String(c.id) === likeId
            );
            if (char) {
              return {
                name: char.note || char.name,
                avatar: "ü§ñ",
                avatarImg: char.avatar,
              };
            }
            return null;
          })
          .filter(Boolean);

        // Êî∂ËóèÁä∂ÊÄÅ
        const bookmarked = (post.bookmarks || []).includes("user");

        // ÁÇπËµûÊòæÁ§∫ - Â∏¶Â§¥ÂÉè
        let likesHtml = "";
        if (likeData.length > 0) {
          const avatarsHtml = likeData
            .slice(0, 5)
            .map(
              (l) =>
                `<div class="like-avatar">${
                  l.avatarImg ? `<img src="${l.avatarImg}" alt="">` : l.avatar
                }</div>`
            )
            .join("");
          const namesText =
            likeData.length <= 2
              ? likeData.map((l) => l.name).join("„ÄÅ")
              : `${likeData[0].name} Á≠â ${likeData.length} ‰∫∫`;
          likesHtml = `
            <div class="ig-post-likes">
              <div class="ig-post-likes-avatars">${avatarsHtml}</div>
              <span>${namesText} ËßâÂæóÂæàËµû</span>
            </div>
          `;
        }

        // ËØÑËÆ∫
        const comments = post.comments || [];
        const previewComments = comments.slice(0, 2);

        // ËØÑËÆ∫Âå∫HTML
        let commentsHtml = "";
        if (previewComments.length > 0) {
          commentsHtml = `
            <div class="ig-post-comments">
              ${previewComments
                .map(
                  (c) => `
                <div class="ig-comment" onclick="openComments('${post.id}')">
                  <span class="username">${c.authorName}</span>${c.content}
                </div>
              `
                )
                .join("")}
            </div>
          `;
        }

        const postIdStr = String(post.id);

        return `
          <div class="ig-post" data-post-id="${postIdStr}">
            <div class="ig-post-header">
              <div class="ig-post-avatar">
                ${
                  authorAvatarImg
                    ? `<img src="${authorAvatarImg}" alt="">`
                    : authorAvatar
                }
              </div>
              <div class="ig-post-user-info">
                <div class="ig-post-username">${authorName}</div>
                <div class="ig-post-time-header">${formatPostTime(
                  post.timestamp
                )}</div>
              </div>
              <button class="ig-post-delete" onclick="confirmDeletePost('${postIdStr}')" title="Âà†Èô§">üóëÔ∏è</button>
            </div>
            ${contentHtml}
            ${imageHtml}
            <div class="ig-post-footer">
              <div class="ig-post-actions">
                <button class="ig-action-btn ${
                  liked ? "liked" : ""
                }" onclick="toggleLike('${postIdStr}')">
                  ${liked ? "‚ù§Ô∏è" : "ü§ç"}<span>${likeData.length || ""}</span>
                </button>
                <button class="ig-action-btn" onclick="openComments('${postIdStr}')">
                  üí¨<span>${comments.length || ""}</span>
                </button>
                <button class="ig-action-btn" onclick="sharePostToChat('${postIdStr}')" title="ËΩ¨ÂèëÂà∞ËÅäÂ§©">üì§</button>
                <div class="ig-action-spacer"></div>
                <button class="ig-action-btn ${
                  bookmarked ? "bookmarked" : ""
                }" onclick="toggleBookmark('${postIdStr}')" title="Êî∂Ëóè">
                  ${bookmarked ? "üîñ" : "üìë"}
                </button>
              </div>
              ${likesHtml}
              ${
                comments.length > 2
                  ? `<div class="ig-view-comments" onclick="openComments('${postIdStr}')">Êü•ÁúãÂÖ®ÈÉ® ${comments.length} Êù°ËØÑËÆ∫</div>`
                  : ""
              }
              ${commentsHtml}
            </div>
          </div>
        `;
      }

      // Ê†ºÂºèÂåñÊó∂Èó¥
      function formatPostTime(timestamp) {
        const now = Date.now();
        const diff = now - timestamp;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return "ÂàöÂàö";
        if (minutes < 60) return `${minutes} ÂàÜÈíüÂâç`;
        if (hours < 24) return `${hours} Â∞èÊó∂Ââç`;
        if (days < 7) return `${days} Â§©Ââç`;
        return new Date(timestamp).toLocaleDateString("zh-CN");
      }

      // ÊâìÂºÄÂèëÂ∏ÉÂºπÁ™ó
      // ÂΩìÂâçÈÄâ‰∏≠ÁöÑÂèØËßÅËåÉÂõ¥
      var selectedVisibility = "all";
      var selectedVisibilityGroups = [];

      function openPostModal() {
        document.getElementById("igPostModal").classList.add("active");
        document.getElementById("igPostText").value = "";
        document.getElementById("igTextImgInput").value = "";
        document.getElementById("igTextImgInput").classList.remove("visible");
        document.getElementById("igImagePreview").classList.remove("visible");
        document.getElementById("imgOptionAlbum").classList.remove("selected");
        document.getElementById("imgOptionText").classList.remove("selected");
        window.selectedPostImage = null;

        // ÂàùÂßãÂåñÂèØËßÅËåÉÂõ¥ÈÄâÊã©
        selectedVisibility = "all";
        selectedVisibilityGroups = [];
        renderVisibilityOptions();

        checkPostValid();
      }

      // Ê∏≤ÊüìÂèØËßÅËåÉÂõ¥ÈÄâÈ°π
      function renderVisibilityOptions() {
        const container = document.getElementById("visibilityOptions");
        if (!container) return;

        // Ëé∑ÂèñÊâÄÊúâÂàÜÁªÑ
        const groups = new Set();
        characters.forEach((char) => {
          const settings = chatSettings[char.id] || {};
          if (settings.group && settings.group !== "none") {
            groups.add(settings.group);
          }
        });

        let html = `<div class="ig-visibility-option ${
          selectedVisibility === "all" ? "selected" : ""
        }" data-value="all" onclick="selectVisibility('all', this)">
          <span class="check-icon">‚úì</span> ÂÖ¨ÂºÄ
        </div>`;

        groups.forEach((group) => {
          const isSelected = selectedVisibilityGroups.includes(group);
          html += `<div class="ig-visibility-option ${
            isSelected ? "selected" : ""
          }" data-value="${group}" onclick="toggleVisibilityGroup('${group}', this)">
            <span class="check-icon">‚úì</span> ${group}
          </div>`;
        });

        container.innerHTML = html;
      }

      // ÈÄâÊã©ÂèØËßÅËåÉÂõ¥
      function selectVisibility(value, el) {
        if (value === "all") {
          selectedVisibility = "all";
          selectedVisibilityGroups = [];
          // ÂèñÊ∂àÊâÄÊúâÂÖ∂‰ªñÈÄâ‰∏≠
          document.querySelectorAll(".ig-visibility-option").forEach((opt) => {
            opt.classList.remove("selected");
          });
          el.classList.add("selected");
        }
      }

      // ÂàáÊç¢ÂàÜÁªÑÂèØËßÅ
      function toggleVisibilityGroup(group, el) {
        // ÂèñÊ∂à"ÂÖ¨ÂºÄ"ÁöÑÈÄâ‰∏≠
        const allOption = document.querySelector(
          '.ig-visibility-option[data-value="all"]'
        );
        if (allOption) allOption.classList.remove("selected");
        selectedVisibility = "groups";

        if (selectedVisibilityGroups.includes(group)) {
          selectedVisibilityGroups = selectedVisibilityGroups.filter(
            (g) => g !== group
          );
          el.classList.remove("selected");

          // Â¶ÇÊûúÊ≤°ÊúâÈÄâ‰∏≠‰ªª‰ΩïÂàÜÁªÑÔºåÈªòËÆ§ÂõûÂà∞ÂÖ¨ÂºÄ
          if (selectedVisibilityGroups.length === 0) {
            selectedVisibility = "all";
            if (allOption) allOption.classList.add("selected");
          }
        } else {
          selectedVisibilityGroups.push(group);
          el.classList.add("selected");
        }
      }

      // ÂÖ≥Èó≠ÂèëÂ∏ÉÂºπÁ™ó
      function closePostModal() {
        document.getElementById("igPostModal").classList.remove("active");
      }

      // ÈÄâÊã©ÂõæÁâáÈÄâÈ°π
      function selectImageOption(type) {
        if (type === "album") {
          document.getElementById("igImageInput").click();
          document.getElementById("imgOptionAlbum").classList.add("selected");
          document.getElementById("imgOptionText").classList.remove("selected");
          document.getElementById("igTextImgInput").classList.remove("visible");
        } else {
          document.getElementById("imgOptionText").classList.add("selected");
          document
            .getElementById("imgOptionAlbum")
            .classList.remove("selected");
          document.getElementById("igTextImgInput").classList.add("visible");
          document.getElementById("igImagePreview").classList.remove("visible");
          window.selectedPostImage = null;
        }
      }

      // Â§ÑÁêÜÂõæÁâáÈÄâÊã©
      function handleImageSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          window.selectedPostImage = e.target.result;
          document.getElementById("igPreviewImg").src = e.target.result;
          document.getElementById("igImagePreview").classList.add("visible");
          document.getElementById("igTextImgInput").classList.remove("visible");
          checkPostValid();
        };
        reader.readAsDataURL(file);
      }

      // ÁßªÈô§ÂõæÁâá
      function removeImage() {
        window.selectedPostImage = null;
        document.getElementById("igImagePreview").classList.remove("visible");
        document.getElementById("imgOptionAlbum").classList.remove("selected");
        document.getElementById("igImageInput").value = "";
        checkPostValid();
      }

      // Ê£ÄÊü•ÊòØÂê¶ÂèØ‰ª•ÂèëÂ∏É
      function checkPostValid() {
        const text = document.getElementById("igPostText").value.trim();
        const textImg = document.getElementById("igTextImgInput").value.trim();
        const hasImage = window.selectedPostImage;

        const valid = text.length > 0 || textImg.length > 0 || hasImage;
        document.getElementById("igPostSubmit").disabled = !valid;
      }

      // ÂèëÂ∏ÉÂä®ÊÄÅ
      async function submitPost() {
        const text = document.getElementById("igPostText").value.trim();
        const textImg = document.getElementById("igTextImgInput").value.trim();

        const post = {
          id: Date.now(),
          content: text,
          image: window.selectedPostImage || null,
          textImage: textImg || null,
          timestamp: Date.now(),
          isUser: true,
          authorId: "user",
          likes: [],
          comments: [],
          // ÂèØËßÅËåÉÂõ¥
          visibility: selectedVisibility,
          visibleGroups:
            selectedVisibility === "groups"
              ? [...selectedVisibilityGroups]
              : [],
        };

        window.momentsData.posts.unshift(post);
        await localforage.setItem("momentsData", window.momentsData);

        closePostModal();
        renderMomentsUI();
        showToast("‚ú® Âä®ÊÄÅÂèëÂ∏ÉÊàêÂäüÔºÅ");

        // AIËßíËâ≤‰ºöÊù•‰∫íÂä® - Ê†πÊçÆÂèØËßÅËåÉÂõ¥Á≠õÈÄâ
        setTimeout(() => {
          aiInteractWithPost(post);
        }, 2000 + Math.random() * 2000);
      }

      // AI‰∏éÁî®Êà∑Âä®ÊÄÅ‰∫íÂä® - ‰ΩøÁî®APIÁîüÊàêÁ¨¶Âêà‰∫∫ËÆæÁöÑËØÑËÆ∫
      async function aiInteractWithPost(post) {
        if (!window.characters || window.characters.length === 0) {
          console.log("Ê≤°ÊúâËßíËâ≤ÔºåË∑≥ËøáAI‰∫íÂä®");
          return;
        }

        console.log("ÂºÄÂßãAI‰∫íÂä®ÔºåËßíËâ≤Êï∞Èáè:", window.characters.length);

        // Ê†πÊçÆÂèØËßÅËåÉÂõ¥Á≠õÈÄâÂèØ‰ª•ÁúãÂà∞Âä®ÊÄÅÁöÑAI
        let eligibleChars = [...window.characters];

        if (
          post.visibility === "groups" &&
          post.visibleGroups &&
          post.visibleGroups.length > 0
        ) {
          // Âè™ÊúâÊåáÂÆöÂàÜÁªÑÁöÑAIÂèØ‰ª•ÁúãÂà∞
          eligibleChars = window.characters.filter((char) => {
            const settings = chatSettings[char.id] || {};
            return post.visibleGroups.includes(settings.group);
          });
          console.log(
            "ÂèØËßÅÂàÜÁªÑ:",
            post.visibleGroups,
            "Á¨¶ÂêàÊù°‰ª∂ÁöÑAI:",
            eligibleChars.map((c) => c.name)
          );
        }

        if (eligibleChars.length === 0) {
          console.log("Ê≤°ÊúâÁ¨¶ÂêàÊù°‰ª∂ÁöÑAIÂèØ‰ª•ÁúãÂà∞ËøôÊù°Âä®ÊÄÅ");
          return;
        }

        // ÊâÄÊúâÁ¨¶ÂêàÊù°‰ª∂ÁöÑAIÈÉΩ‰ºöÊù•‰∫íÂä®Ôºà100%Ôºâ
        for (const char of eligibleChars) {
          await new Promise((resolve) =>
            setTimeout(resolve, 1500 + Math.random() * 2000)
          );

          // 100% ÁÇπËµû
          const postIndex = window.momentsData.posts.findIndex(
            (p) => p.id === post.id
          );
          if (
            postIndex !== -1 &&
            !window.momentsData.posts[postIndex].likes.includes(String(char.id))
          ) {
            window.momentsData.posts[postIndex].likes.push(String(char.id));
            await localforage.setItem("momentsData", window.momentsData);
            renderMomentsUI();
            console.log(char.name, "ÁÇπËµû‰∫Ü");
          }

          // 100% ËØÑËÆ∫
          console.log(char.name, "ÂáÜÂ§áËØÑËÆ∫ÔºåÂºÄÂßãË∞ÉÁî®API...");
          try {
            console.log(char.name, "Ê≠£Âú®ÁîüÊàêËØÑËÆ∫...");
            const comment = await generateAiCommentWithAPI(char, post);
            console.log(char.name, "APIËøîÂõûËØÑËÆ∫:", comment);
            if (comment) {
              const postIndex = window.momentsData.posts.findIndex(
                (p) => p.id === post.id
              );
              if (postIndex !== -1) {
                window.momentsData.posts[postIndex].comments.push({
                  id: Date.now(),
                  authorId: String(char.id),
                  authorName: char.note || char.name,
                  authorAvatar: char.avatar || "ü§ñ",
                  content: comment,
                  timestamp: Date.now(),
                  replyTo: null,
                });
                await localforage.setItem("momentsData", window.momentsData);
                renderMomentsUI();
                console.log(char.name, "ËØÑËÆ∫ÊàêÂäü:", comment);

                // Â¢ûÂä†ÊúãÂèãÂúàÊú™ËØªÊèêÈÜí
                addUnreadMoment();
              }
            } else {
              console.log(char.name, "ËØÑËÆ∫ÂÜÖÂÆπ‰∏∫Á©∫");
            }
          } catch (e) {
            console.error("AIËØÑËÆ∫ÁîüÊàêÂ§±Ë¥•:", e);
          }
        }
      }

      // ‰ΩøÁî®APIÁîüÊàêAIËØÑËÆ∫ - Á¨¶ÂêàËßíËâ≤‰∫∫ËÆæ
      async function generateAiCommentWithAPI(char, post) {
        // Ëé∑ÂèñÂΩìÂâçÊøÄÊ¥ªÁöÑAPIÈÖçÁΩÆÔºå‰ºòÂÖà‰ΩøÁî®ËßíËâ≤ËÆæÁΩÆÁöÑAPIÔºåÂê¶ÂàôÁî®ÂÖ®Â±ÄÊøÄÊ¥ªÁöÑ
        const charSettings = chatSettings[char.id] || {};
        let apiConfigToUse = null;

        if (charSettings.apiPreset) {
          apiConfigToUse = apiPresets.find(
            (p) => p.id === charSettings.apiPreset
          );
        }
        if (!apiConfigToUse) {
          apiConfigToUse = apiPresets.find((p) => p.id === activePresetId);
        }
        if (!apiConfigToUse && apiPresets.length > 0) {
          apiConfigToUse = apiPresets[0];
        }

        if (!apiConfigToUse || !apiConfigToUse.key) {
          console.log("Ê≤°ÊúâÂèØÁî®ÁöÑAPIÈÖçÁΩÆÔºåË∑≥ËøáAIËØÑËÆ∫");
          return null;
        }

        console.log("‰ΩøÁî®APIÈÖçÁΩÆ:", apiConfigToUse.name, apiConfigToUse.model);

        // ÊûÑÂª∫Âä®ÊÄÅÂÜÖÂÆπÊèèËø∞
        let postDescription = "";
        if (post.content) {
          postDescription += `Âä®ÊÄÅÊñáÂ≠óÂÜÖÂÆπ: "${post.content}"`;
        }
        if (post.textImage) {
          postDescription += `${postDescription ? "\n" : ""}Âä®ÊÄÅÈÖçÂõæÊèèËø∞: "${
            post.textImage
          }"`;
        }
        if (post.image) {
          postDescription += `${postDescription ? "\n" : ""}(Âä®ÊÄÅÂåÖÂê´‰∏ÄÂº†ÂõæÁâá)`;
        }

        const userName = window.momentsData.userProfile.name || "Áî®Êà∑";

        // Ëé∑ÂèñËßíËâ≤‰∫∫ËÆæ
        const persona = charSettings.persona || char.description || "";

        // ÊûÑÂª∫Á≥ªÁªüÊèêÁ§∫ËØç
        const systemPrompt = `‰Ω†ÊòØ${
          char.note || char.name
        }ÔºåÊ≠£Âú®Á§æ‰∫§Â™í‰Ωì‰∏äÁúãÂà∞${userName}ÂèëÂ∏ÉÁöÑ‰∏ÄÊù°Âä®ÊÄÅ„ÄÇ
${persona ? `‰Ω†ÁöÑ‰∫∫ËÆæ: ${persona}` : ""}

ËØ∑Ê†πÊçÆ‰Ω†ÁöÑÊÄßÊ†ºÂíå‰∫∫ËÆæÔºåÂØπËøôÊù°Âä®ÊÄÅÂÜô‰∏ÄÊù°ÁÆÄÁü≠ÁöÑËØÑËÆ∫ÂõûÂ§ç„ÄÇ

Ë¶ÅÊ±Ç:
1. ËØÑËÆ∫Ë¶ÅÁÆÄÁü≠Ëá™ÁÑ∂ÔºåÂÉèÁúü‰∫∫Âú®Á§æ‰∫§Â™í‰Ωì‰∏äÁöÑËØÑËÆ∫‰∏ÄÊ†∑ÔºåÈÄöÂ∏∏1-2Âè•ËØù
2. Ë¶ÅÁ¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæÂíåËØ¥ËØùÈ£éÊ†º
3. Ë¶ÅÈíàÂØπÂä®ÊÄÅÁöÑÂÖ∑‰ΩìÂÜÖÂÆπËøõË°åËØÑËÆ∫Ôºå‰∏çË¶ÅÊ≥õÊ≥õËÄåË∞à
4. ÂèØ‰ª•ÈÄÇÂΩì‰ΩøÁî®Ë°®ÊÉÖÁ¨¶Âè∑
5. Áõ¥Êé•ËæìÂá∫ËØÑËÆ∫ÂÜÖÂÆπÔºå‰∏çË¶ÅÊúâ‰ªª‰ΩïÂâçÁºÄÊàñËß£Èáä`;

        const userPrompt = `${userName}ÂèëÂ∏É‰∫Ü‰∏ÄÊù°Âä®ÊÄÅ:\n${postDescription}\n\nËØ∑ÂÜô‰∏ÄÊù°ËØÑËÆ∫:`;

        try {
          // Á°Æ‰øùURLÊ†ºÂºèÊ≠£Á°Æ - ‰ª•/chat/completionsÁªìÂ∞æ
          let apiUrl = apiConfigToUse.url.replace(/\/$/, "");
          if (!apiUrl.endsWith("/chat/completions")) {
            if (apiUrl.endsWith("/v1")) {
              apiUrl += "/chat/completions";
            } else if (apiUrl.includes("/v1/")) {
              if (!apiUrl.includes("/chat/completions")) {
                apiUrl += "/chat/completions";
              }
            } else {
              apiUrl += "/v1/chat/completions";
            }
          }

          console.log("AIËØÑËÆ∫APIË∞ÉÁî®:", apiUrl, apiConfigToUse.model);

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${apiConfigToUse.key}`,
            },
            body: JSON.stringify({
              model: apiConfigToUse.model,
              messages: [
                { role: "system", content: systemPrompt },
                { role: "user", content: userPrompt },
              ],
              temperature: 0.8,
              stream: false,
            }),
          });

          if (!response.ok) {
            const errText = await response.text();
            console.error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status}`, errText);
            throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status}`);
          }

          const data = await response.json();
          console.log("ËØÑËÆ∫APIÂÆåÊï¥ËøîÂõû:", JSON.stringify(data));

          // ÂÖºÂÆπ‰∏çÂêåÊ®°ÂûãÁöÑËøîÂõûÊ†ºÂºè
          const choice = data.choices?.[0];
          let comment = choice?.message?.content?.trim();

          // Â¶ÇÊûúcontent‰∏∫Á©∫ÔºåÂ∞ùËØïÂÖ∂‰ªñÂèØËÉΩÁöÑÂ≠óÊÆµ
          if (!comment && choice?.message?.reasoning_content) {
            comment = choice.message.reasoning_content.trim();
          }
          if (!comment && choice?.message?.reasoning) {
            comment = choice.message.reasoning.trim();
          }
          if (!comment && choice?.text) {
            comment = choice.text.trim();
          }
          if (!comment && choice?.delta?.content) {
            comment = choice.delta.content.trim();
          }

          // Â¶ÇÊûúËøòÊòØÁ©∫ÁöÑÔºåÊ£ÄÊµãÊòØÂê¶ÊòØÊé®ÁêÜÊ®°ÂûãÈóÆÈ¢ò
          if (!comment) {
            const hasReasoningTokens =
              data.usage?.reasoning_tokens > 0 ||
              data.usage?.completion_tokens_details?.reasoning_tokens > 0;
            if (hasReasoningTokens) {
              console.warn("Ê£ÄÊµãÂà∞Êé®ÁêÜÊ®°ÂûãËøîÂõûÁ©∫ÂÜÖÂÆπÔºåË∑≥ËøáËØÑËÆ∫");
              return null;
            }
          }

          // Â¶ÇÊûúËøòÊòØÁ©∫ÁöÑÔºåÁî®ÁÆÄÂåñpromptÈáçËØï
          if (!comment) {
            console.log("ËØÑËÆ∫‰∏∫Á©∫ÔºåÂ∞ùËØïÁÆÄÂåñpromptÈáçËØï");
            const simplePrompt = `ÁúãÂà∞ÊúãÂèãÂèëÁöÑÂä®ÊÄÅÔºö"${
              post.content || "(ÂõæÁâá)"
            }"ÔºåÂÜô‰∏ÄÂè•ÁÆÄÁü≠ËØÑËÆ∫Ôºà10Â≠ó‰ª•ÂÜÖÔºâÔºåÁõ¥Êé•ËæìÂá∫ËØÑËÆ∫ÂÜÖÂÆπÔºö`;

            const retryResponse = await fetch(apiUrl, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${apiConfigToUse.key}`,
              },
              body: JSON.stringify({
                model: apiConfigToUse.model,
                messages: [{ role: "user", content: simplePrompt }],
                max_tokens: 50,
                temperature: 0.7,
              }),
            });

            if (retryResponse.ok) {
              const retryData = await retryResponse.json();
              console.log("ÈáçËØïAPIËøîÂõû:", JSON.stringify(retryData));
              comment = retryData.choices?.[0]?.message?.content?.trim();
            }
          }

          console.log("AIËØÑËÆ∫ÊúÄÁªàÁªìÊûú:", comment);
          return comment || null;
        } catch (e) {
          console.error("APIË∞ÉÁî®Â§±Ë¥•:", e);
          return null;
        }
      }

      // AIËßíËâ≤ÂèëÂ∏ÉÂä®ÊÄÅ - ‰ΩøÁî®APIÁîüÊàêÁ¨¶Âêà‰∫∫ËÆæÁöÑÂä®ÊÄÅÂÜÖÂÆπ
      async function generateAiPosts() {
        // ‰∏çÂÜçËá™Âä®ÁîüÊàêÂÜÖÁΩÆÂä®ÊÄÅÔºåÊîπ‰∏∫Áî®Êà∑ÊâãÂä®Ëß¶ÂèëÊàñÂÖ∂‰ªñÊù°‰ª∂Ëß¶Âèë
        // Ëøô‰∏™ÂáΩÊï∞‰øùÁïô‰ΩÜ‰∏çÂÜçËá™Âä®ÊâßË°åÂÜÖÁΩÆÂÜÖÂÆπ
        return;
      }

      // ÁÇπËµû/ÂèñÊ∂àÁÇπËµû
      async function toggleLike(postId) {
        const postIndex = window.momentsData.posts.findIndex(
          (p) => String(p.id) === String(postId)
        );
        if (postIndex === -1) return;

        const post = window.momentsData.posts[postIndex];
        const userIndex = post.likes.indexOf("user");

        if (userIndex === -1) {
          post.likes.push("user");
        } else {
          post.likes.splice(userIndex, 1);
        }

        await localforage.setItem("momentsData", window.momentsData);
        renderMomentsUI();
      }

      // ÂΩìÂâçËØÑËÆ∫ÁöÑÂä®ÊÄÅID
      let currentCommentPostId = null;
      let replyToComment = null; // ÂΩìÂâçÂõûÂ§çÁöÑËØÑËÆ∫

      // ÊâìÂºÄËØÑËÆ∫ÂºπÁ™ó
      function openComments(postId) {
        currentCommentPostId = postId;
        replyToComment = null;
        const post = window.momentsData.posts.find(
          (p) => String(p.id) === String(postId)
        );
        if (!post) return;

        const container = document.getElementById("igCommentsList");
        const comments = post.comments || [];

        if (comments.length === 0) {
          container.innerHTML =
            '<div style="text-align:center;color:#8e8e8e;padding:40px;">ËøòÊ≤°ÊúâËØÑËÆ∫ÔºåÊù•ËØ¥ÁÇπ‰ªÄ‰πàÂêß~</div>';
        } else {
          container.innerHTML = comments
            .map((c) => {
              const char = window.characters?.find(
                (ch) => String(ch.id) === c.authorId
              );
              const avatarImg =
                c.authorId === "user"
                  ? window.momentsData.userProfile.avatarImg
                  : char?.avatar;
              const avatar =
                c.authorId === "user"
                  ? window.momentsData.userProfile.avatar
                  : "ü§ñ";

              // ÂõûÂ§çÊ†áËÆ∞
              let replyHtml = "";
              if (c.replyTo) {
                replyHtml = `<span class="ig-reply-tag">ÂõûÂ§ç @${c.replyTo}</span> `;
              }

              return `
              <div class="ig-full-comment" data-comment-id="${
                c.id
              }" data-author-id="${c.authorId}" data-author-name="${
                c.authorName
              }">
                <div class="ig-full-comment-avatar">
                  ${avatarImg ? `<img src="${avatarImg}" alt="">` : avatar}
                </div>
                <div class="ig-full-comment-content">
                  <div class="ig-full-comment-user">${c.authorName}</div>
                  <div class="ig-full-comment-text">${replyHtml}${
                c.content
              }</div>
                  <div class="ig-full-comment-actions">
                    <span class="ig-full-comment-time">${formatPostTime(
                      c.timestamp
                    )}</span>
                    <span class="ig-reply-btn" onclick="setReplyTo('${
                      c.id
                    }', '${c.authorName}', '${c.authorId}')">ÂõûÂ§ç</span>
                  </div>
                </div>
              </div>
            `;
            })
            .join("");
        }

        document.getElementById("igCommentsModal").classList.add("active");
        document.getElementById("igCommentInput").value = "";
        document.getElementById("igCommentInput").placeholder = "Ê∑ªÂä†ËØÑËÆ∫...";
      }

      // ËÆæÁΩÆÂõûÂ§çÁõÆÊ†á
      function setReplyTo(commentId, authorName, authorId) {
        replyToComment = {
          id: commentId,
          name: authorName,
          authorId: authorId,
        };
        const input = document.getElementById("igCommentInput");
        input.placeholder = `ÂõûÂ§ç @${authorName}...`;
        input.focus();
      }

      // ÂÖ≥Èó≠ËØÑËÆ∫ÂºπÁ™ó
      function closeCommentsModal() {
        document.getElementById("igCommentsModal").classList.remove("active");
        currentCommentPostId = null;
        replyToComment = null;
      }

      // ÂèëÈÄÅËØÑËÆ∫
      async function sendComment() {
        if (!currentCommentPostId) return;

        const input = document.getElementById("igCommentInput");
        const content = input.value.trim();
        if (!content) return;

        const postIndex = window.momentsData.posts.findIndex(
          (p) => String(p.id) === String(currentCommentPostId)
        );
        if (postIndex === -1) return;

        const profile = window.momentsData.userProfile;
        const newComment = {
          id: Date.now(),
          authorId: "user",
          authorName: profile.name,
          authorAvatar: profile.avatarImg || profile.avatar,
          content: content,
          timestamp: Date.now(),
          replyTo: replyToComment ? replyToComment.name : null,
        };

        window.momentsData.posts[postIndex].comments.push(newComment);
        await localforage.setItem("momentsData", window.momentsData);

        // ‰øùÂ≠òÂõûÂ§çÁõÆÊ†áÁî®‰∫éAIÂõûÂ§ç
        const replyTarget = replyToComment;

        // Ê∏ÖÁ©∫ÂõûÂ§çÁä∂ÊÄÅ
        replyToComment = null;
        input.value = "";
        input.placeholder = "Ê∑ªÂä†ËØÑËÆ∫...";

        // ÈáçÊñ∞ÊâìÂºÄËØÑËÆ∫ÂºπÁ™óÂà∑Êñ∞
        openComments(currentCommentPostId);
        renderMomentsUI();

        // Â¶ÇÊûúÊòØÂõûÂ§çAIÁöÑËØÑËÆ∫ÔºåAI‰ºöÂõûÂ§ç
        if (replyTarget && replyTarget.authorId !== "user") {
          const char = window.characters?.find(
            (c) => String(c.id) === replyTarget.authorId
          );
          if (char) {
            setTimeout(async () => {
              const post = window.momentsData.posts[postIndex];
              const reply = await generateAiReplyWithAPI(char, content, post);
              if (reply) {
                window.momentsData.posts[postIndex].comments.push({
                  id: Date.now(),
                  authorId: String(char.id),
                  authorName: char.note || char.name,
                  authorAvatar: char.avatar || "ü§ñ",
                  content: reply,
                  timestamp: Date.now(),
                  replyTo: profile.name,
                });
                await localforage.setItem("momentsData", window.momentsData);
                if (currentCommentPostId === String(post.id)) {
                  openComments(currentCommentPostId);
                }
                renderMomentsUI();
              }
            }, 2000 + Math.random() * 3000);
          }
        }
        // Â¶ÇÊûúÊòØÂú®AIÁöÑÂä®ÊÄÅ‰∏ãËØÑËÆ∫ÔºàÈùûÂõûÂ§çÔºâÔºåAI‰πüÂèØËÉΩ‰ºöÂõûÂ§ç
        else {
          const post = window.momentsData.posts[postIndex];
          if (!post.isUser && window.characters) {
            const char = window.characters.find(
              (c) => String(c.id) === post.authorId
            );
            if (char && Math.random() > 0.3) {
              // 70% Ê¶ÇÁéáÂõûÂ§ç
              setTimeout(async () => {
                const reply = await generateAiReplyWithAPI(char, content, post);
                if (reply) {
                  window.momentsData.posts[postIndex].comments.push({
                    id: Date.now(),
                    authorId: String(char.id),
                    authorName: char.note || char.name,
                    authorAvatar: char.avatar || "ü§ñ",
                    content: reply,
                    timestamp: Date.now(),
                    replyTo: profile.name,
                  });
                  await localforage.setItem("momentsData", window.momentsData);
                  if (currentCommentPostId === String(post.id)) {
                    openComments(currentCommentPostId);
                  }
                  renderMomentsUI();
                }
              }, 2000 + Math.random() * 3000);
            }
          }
        }
      }

      // ‰ΩøÁî®APIÁîüÊàêAIÂõûÂ§çËØÑËÆ∫
      async function generateAiReplyWithAPI(char, userComment, post) {
        // Ëé∑ÂèñÂΩìÂâçÊøÄÊ¥ªÁöÑAPIÈÖçÁΩÆ
        const charSettings = chatSettings[char.id] || {};
        let apiConfig = null;

        if (charSettings.apiPreset) {
          apiConfig = apiPresets.find((p) => p.id === charSettings.apiPreset);
        }
        if (!apiConfig) {
          apiConfig = apiPresets.find((p) => p.id === activePresetId);
        }
        if (!apiConfig && apiPresets.length > 0) {
          apiConfig = apiPresets[0];
        }

        if (!apiConfig || !apiConfig.key) {
          console.log("Ê≤°ÊúâÂèØÁî®ÁöÑAPIÈÖçÁΩÆÔºåË∑≥ËøáAIÂõûÂ§ç");
          return null;
        }

        const userName = window.momentsData.userProfile.name || "Áî®Êà∑";
        const persona = charSettings.persona || char.description || "";

        // ÊûÑÂª∫Âä®ÊÄÅÂÜÖÂÆπÊèèËø∞
        let postDescription = "";
        if (post.content) {
          postDescription += `Âä®ÊÄÅÂÜÖÂÆπ: "${post.content}"`;
        }
        if (post.textImage) {
          postDescription += `${postDescription ? ", " : ""}ÈÖçÂõæ: "${
            post.textImage
          }"`;
        }

        const systemPrompt = `‰Ω†ÊòØ${char.note || char.name}„ÄÇ
${persona ? `‰Ω†ÁöÑ‰∫∫ËÆæ: ${persona}` : ""}

${userName}Âú®‰Ω†ÁöÑÂä®ÊÄÅ‰∏ãÁïôË®Ä‰∫ÜÔºå‰Ω†ÈúÄË¶ÅÂõûÂ§ç„ÄÇ

‰Ω†ÁöÑÂä®ÊÄÅ: ${postDescription || "(‰∏ÄÊù°Âä®ÊÄÅ)"}

Ë¶ÅÊ±Ç:
1. ÂõûÂ§çË¶ÅÁÆÄÁü≠Ëá™ÁÑ∂ÔºåÂÉèÁúü‰∫∫ËÅäÂ§©‰∏ÄÊ†∑Ôºå1-2Âè•ËØùÂç≥ÂèØ
2. Ë¶ÅÁ¨¶Âêà‰Ω†ÁöÑ‰∫∫ËÆæÂíåËØ¥ËØùÈ£éÊ†º
3. Ë¶ÅÈíàÂØπÂØπÊñπËØÑËÆ∫ÁöÑÂÜÖÂÆπËøõË°åÂõûÂ§ç
4. ÂèØ‰ª•ÈÄÇÂΩì‰ΩøÁî®Ë°®ÊÉÖÁ¨¶Âè∑
5. Áõ¥Êé•ËæìÂá∫ÂõûÂ§çÂÜÖÂÆπÔºå‰∏çË¶ÅÊúâ‰ªª‰ΩïÂâçÁºÄÊàñËß£Èáä`;

        const userPrompt = `${userName}ÁöÑËØÑËÆ∫: "${userComment}"\n\nËØ∑ÂõûÂ§ç:`;

        try {
          // Â§ÑÁêÜAPI URL
          let apiUrl = apiConfig.url.replace(/\/$/, "");
          if (!apiUrl.endsWith("/chat/completions")) {
            if (apiUrl.endsWith("/v1")) {
              apiUrl += "/chat/completions";
            } else if (apiUrl.includes("/v1/")) {
              if (!apiUrl.includes("/chat/completions")) {
                apiUrl += "/chat/completions";
              }
            } else {
              apiUrl += "/v1/chat/completions";
            }
          }

          console.log("AIÂõûÂ§çËØÑËÆ∫APIË∞ÉÁî®:", apiUrl);

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${apiConfig.key}`,
            },
            body: JSON.stringify({
              model: apiConfig.model,
              messages: [
                { role: "system", content: systemPrompt },
                { role: "user", content: userPrompt },
              ],
              temperature: 0.8,
              stream: false,
            }),
          });

          if (!response.ok) {
            const errText = await response.text();
            console.error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status}`, errText);
            throw new Error(`APIËØ∑Ê±ÇÂ§±Ë¥•: ${response.status}`);
          }

          const data = await response.json();
          console.log("AIÂõûÂ§çËØÑËÆ∫ËøîÂõû:", JSON.stringify(data));
          const reply = data.choices?.[0]?.message?.content?.trim();
          return reply || null;
        } catch (e) {
          console.error("APIË∞ÉÁî®Â§±Ë¥•:", e);
          return null;
        }
      }

      // ÂΩìÂâçÊìç‰ΩúÁöÑÂä®ÊÄÅID
      let currentMenuPostId = null;

      // ÊâìÂºÄÂä®ÊÄÅËèúÂçï
      function openPostMenu(postId) {
        currentMenuPostId = postId;
        document.getElementById("igPostMenu").classList.add("active");
      }

      // ÂÖ≥Èó≠Âä®ÊÄÅËèúÂçï
      function closePostMenu() {
        document.getElementById("igPostMenu").classList.remove("active");
        currentMenuPostId = null;
      }

      // Âà†Èô§Âä®ÊÄÅ
      async function deletePost() {
        if (!currentMenuPostId) return;

        if (!confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Âä®ÊÄÅÂêóÔºü")) {
          closePostMenu();
          return;
        }

        window.momentsData.posts = window.momentsData.posts.filter(
          (p) => String(p.id) !== String(currentMenuPostId)
        );
        await localforage.setItem("momentsData", window.momentsData);

        closePostMenu();
        renderMomentsUI();
        showToast("Âä®ÊÄÅÂ∑≤Âà†Èô§");
      }

      // Á°ÆËÆ§Âà†Èô§Âä®ÊÄÅÔºàÁõ¥Êé•‰ªéÂç°ÁâáÊåâÈíÆË∞ÉÁî®Ôºâ
      window.confirmDeletePost = async function (postId) {
        console.log("Âà†Èô§Âä®ÊÄÅ:", postId);
        if (!confirm("Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Âä®ÊÄÅÂêóÔºü")) {
          return;
        }

        window.momentsData.posts = window.momentsData.posts.filter(
          (p) => String(p.id) !== String(postId)
        );
        await localforage.setItem("momentsData", window.momentsData);

        renderMomentsUI();
        showToast("üóëÔ∏è Âä®ÊÄÅÂ∑≤Âà†Èô§");
      };

      // ÂΩìÂâçË¶ÅËΩ¨ÂèëÁöÑÂä®ÊÄÅID
      let currentSharePostId = null;

      // ÊâìÂºÄËΩ¨ÂèëÈÄâÊã©ÂºπÁ™ó
      window.sharePostToChat = function (postId) {
        console.log("ÊâìÂºÄËΩ¨ÂèëÂºπÁ™ó:", postId);
        currentSharePostId = postId;

        const post = window.momentsData.posts.find(
          (p) => String(p.id) === String(postId)
        );
        if (!post) {
          showToast("‚ùå Êâæ‰∏çÂà∞ËøôÊù°Âä®ÊÄÅ");
          return;
        }

        // Ê∏≤ÊüìËßíËâ≤ÂàóË°®
        const container = document.getElementById("igShareList");
        if (!window.characters || window.characters.length === 0) {
          container.innerHTML =
            '<div class="ig-share-empty">ËøòÊ≤°ÊúâÊ∑ªÂä†Â•ΩÂèãÂì¶~</div>';
        } else {
          container.innerHTML = window.characters
            .map(
              (char) => `
            <div class="ig-share-item" onclick="confirmShareToChat('${
              char.id
            }')">
              <div class="ig-share-avatar">
                ${char.avatar ? `<img src="${char.avatar}" alt="">` : "ü§ñ"}
              </div>
              <div class="ig-share-info">
                <div class="ig-share-name">${char.note || char.name}</div>
                <div class="ig-share-desc">ÁÇπÂáªËΩ¨ÂèëÁªôTA</div>
              </div>
              <button class="ig-share-btn">ËΩ¨Âèë</button>
            </div>
          `
            )
            .join("");
        }

        document.getElementById("igShareModal").classList.add("active");
      };

      // ÂÖ≥Èó≠ËΩ¨ÂèëÂºπÁ™ó
      window.closeShareModal = function () {
        document.getElementById("igShareModal").classList.remove("active");
        currentSharePostId = null;
      };

      // Á°ÆËÆ§ËΩ¨ÂèëÁªôÊåáÂÆöËßíËâ≤
      window.confirmShareToChat = function (charId) {
        console.log("ËΩ¨ÂèëÁªôËßíËâ≤:", charId);
        const post = window.momentsData.posts.find(
          (p) => String(p.id) === String(currentSharePostId)
        );
        if (!post) {
          showToast("‚ùå Êâæ‰∏çÂà∞ËøôÊù°Âä®ÊÄÅ");
          closeShareModal();
          return;
        }

        const char = window.characters?.find(
          (c) => String(c.id) === String(charId)
        );
        if (!char) {
          showToast("‚ùå Êâæ‰∏çÂà∞Ëøô‰∏™ËßíËâ≤");
          closeShareModal();
          return;
        }

        // Ëé∑ÂèñÂä®ÊÄÅ‰ΩúËÄÖ‰ø°ÊÅØ
        let authorName, authorAvatar, authorAvatarImg;
        if (post.isUser) {
          authorName = window.momentsData.userProfile.name || "Êàë";
          authorAvatar = window.momentsData.userProfile.avatar || "üê∞";
          authorAvatarImg = window.momentsData.userProfile.avatarImg;
        } else {
          const postChar = window.characters?.find(
            (c) => String(c.id) === post.authorId
          );
          authorName = postChar ? postChar.note || postChar.name : "Êú™Áü•Áî®Êà∑";
          authorAvatar = "ü§ñ";
          authorAvatarImg = postChar?.avatar;
        }

        // Ê†ºÂºèÂåñÊó∂Èó¥
        const postTime = new Date(post.timestamp);
        const timeStr = `${
          postTime.getMonth() + 1
        }Êúà${postTime.getDate()}Êó• ${postTime.getHours()}:${String(
          postTime.getMinutes()
        ).padStart(2, "0")}`;

        // ÊûÑÂª∫ÂõæÁâáHTML
        let imageHtml = "";
        if (post.image) {
          imageHtml = `<img class="shared-post-image" src="${post.image}" alt="">`;
        } else if (post.textImage) {
          const bgStyles = [
            { bg: "linear-gradient(135deg, #667eea, #764ba2)", emoji: "‚ú®" },
            { bg: "linear-gradient(135deg, #f093fb, #f5576c)", emoji: "üå∏" },
            { bg: "linear-gradient(135deg, #4facfe, #00f2fe)", emoji: "üí´" },
            { bg: "linear-gradient(135deg, #43e97b, #38f9d7)", emoji: "üåø" },
          ];
          const style = bgStyles[Math.floor(post.id) % bgStyles.length];
          imageHtml = `<div class="shared-post-text-img" style="background:${style.bg}"><span>${post.textImage}</span></div>`;
        }

        // ÊûÑÂª∫Á≤æËá¥ËΩ¨ÂèëÂç°ÁâáHTML
        const cardHtml = `
          <div class="shared-post-card">
            <div class="shared-post-header">
              <div class="shared-post-avatar">
                ${
                  authorAvatarImg
                    ? `<img src="${authorAvatarImg}" alt="">`
                    : authorAvatar
                }
              </div>
              <div class="shared-post-meta">
                <span class="shared-post-author">${authorName}</span>
                <span class="shared-post-time">${timeStr}</span>
              </div>
              <span class="shared-post-label">Âä®ÊÄÅ</span>
            </div>
            <div class="shared-post-body">
              ${
                post.content
                  ? `<div class="shared-post-content">${post.content}</div>`
                  : ""
              }
              ${imageHtml}
            </div>
            <div class="shared-post-footer">
              <span class="shared-post-footer-text">
                <span class="shared-post-footer-icon">üì§</span> ËΩ¨ÂèëÁöÑÂä®ÊÄÅ
              </span>
              <span class="shared-post-interact">ÁÇπÂáªÊü•Áúã ‚Ä∫</span>
            </div>
          </div>
        `;

        // ÂÖ≥Èó≠ÂºπÁ™ó
        closeShareModal();

        // ÂàáÊç¢Âà∞ËØ•ËßíËâ≤ÁöÑËÅäÂ§©
        if (typeof openChat === "function") {
          openChat(charId);
        } else {
          currentChatCharId = String(charId);
        }

        // ÂàáÊç¢Âà∞ËÅäÂ§©È°µÈù¢
        switchChatTab("messages");

        // Âª∂ËøüÂèëÈÄÅÊ∂àÊÅØ
        setTimeout(() => {
          // Á°Æ‰øùchatHistoriesÂ≠òÂú®
          if (!chatHistories[charId]) {
            chatHistories[charId] = [];
          }

          // Ê∑ªÂä†Ê∂àÊÅØ
          const msgObj = {
            role: "user",
            content: cardHtml,
            time: new Date().toLocaleTimeString("zh-CN", {
              hour: "2-digit",
              minute: "2-digit",
            }),
            isHtml: true,
          };

          chatHistories[charId].push(msgObj);
          localStorage.setItem("chatHistories", JSON.stringify(chatHistories));

          // ÈáçÊñ∞Ê∏≤ÊüìÂØπËØù
          if (typeof renderConversation === "function") {
            renderConversation();
          }

          // Êõ¥Êñ∞ÊúÄÂêéÊ∂àÊÅØ
          if (typeof updateCharacterLastMessage === "function") {
            updateCharacterLastMessage(
              charId,
              `[ËΩ¨ÂèëÂä®ÊÄÅ] ${post.content || "ÂõæÁâá"}`
            );
          }

          showToast(`üì§ Â∑≤ËΩ¨ÂèëÁªô ${char.note || char.name}`);
        }, 300);
      };

      // ÂàáÊç¢Êî∂ËóèÁä∂ÊÄÅ
      window.toggleBookmark = async function (postId) {
        console.log("Êî∂ËóèÂä®ÊÄÅ:", postId);
        const postIndex = window.momentsData.posts.findIndex(
          (p) => String(p.id) === String(postId)
        );
        if (postIndex === -1) return;

        const post = window.momentsData.posts[postIndex];
        if (!post.bookmarks) {
          post.bookmarks = [];
        }

        const userIndex = post.bookmarks.indexOf("user");
        if (userIndex === -1) {
          post.bookmarks.push("user");
          showToast("üîñ Â∑≤Êî∂Ëóè");
        } else {
          post.bookmarks.splice(userIndex, 1);
          showToast("üìë Â∑≤ÂèñÊ∂àÊî∂Ëóè");
        }

        await localforage.setItem("momentsData", window.momentsData);
        renderMomentsUI();
      };

      // ÊâìÂºÄ‰∏™‰∫∫ËµÑÊñôÁºñËæëÂºπÁ™ó
      function openProfileModal() {
        const profile = window.momentsData.userProfile;

        // ËÆæÁΩÆÈ¢ÑËßàÂ§¥ÂÉè
        const preview = document.getElementById("igAvatarPreview");
        if (profile.avatarImg) {
          preview.innerHTML = `<img src="${profile.avatarImg}" alt="">`;
        } else {
          preview.innerHTML = profile.avatar || "üê∞";
        }

        document.getElementById("igEditName").value = profile.name || "";
        document.getElementById("igEditHandle").value = profile.handle || "";
        document.getElementById("igEditBio").value = profile.bio || "";

        document.getElementById("igProfileModal").classList.add("active");
      }

      // ÂÖ≥Èó≠‰∏™‰∫∫ËµÑÊñôÁºñËæëÂºπÁ™ó
      function closeProfileModal() {
        document.getElementById("igProfileModal").classList.remove("active");
      }

      // Â§ÑÁêÜÂ§¥ÂÉèÈÄâÊã©
      function handleAvatarSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          window.momentsData.userProfile.avatarImg = e.target.result;
          window.momentsData.userProfile.avatar = null;
          document.getElementById(
            "igAvatarPreview"
          ).innerHTML = `<img src="${e.target.result}" alt="">`;
        };
        reader.readAsDataURL(file);
      }

      // ÊâìÂºÄË°®ÊÉÖÈÄâÊã©Âô®
      function openEmojiPicker() {
        const emojis = [
          "üòä",
          "üòé",
          "ü•∞",
          "üòá",
          "ü§ó",
          "üòã",
          "üê∞",
          "üê±",
          "üê∂",
          "ü¶ä",
          "üêª",
          "üêº",
          "üå∏",
          "üå∫",
          "üåª",
          "üåà",
          "‚≠ê",
          "üí´",
          "üéÄ",
          "üíï",
        ];
        const emoji = prompt("ÈÄâÊã©‰∏Ä‰∏™Ë°®ÊÉÖ‰Ωú‰∏∫Â§¥ÂÉèÔºö\n" + emojis.join(" "));
        if (emoji && emojis.includes(emoji)) {
          window.momentsData.userProfile.avatar = emoji;
          window.momentsData.userProfile.avatarImg = null;
          document.getElementById("igAvatarPreview").innerHTML = emoji;
        }
      }

      // ‰øùÂ≠ò‰∏™‰∫∫ËµÑÊñô
      async function saveProfile() {
        const name = document.getElementById("igEditName").value.trim();
        const handle = document.getElementById("igEditHandle").value.trim();
        const bio = document.getElementById("igEditBio").value.trim();

        window.momentsData.userProfile.name = name || "ÊàëÁöÑÊòµÁß∞";
        window.momentsData.userProfile.handle = handle || "@username";
        window.momentsData.userProfile.bio = bio || "";

        await localforage.setItem("momentsData", window.momentsData);

        closeProfileModal();
        renderMomentsUI();
        renderStoriesBar();
        showToast("‰∏™‰∫∫ËµÑÊñôÂ∑≤‰øùÂ≠ò ‚ú®");
      }

      // ÊòæÁ§∫Êüê‰∏™ËßíËâ≤ÁöÑÂä®ÊÄÅ
      function showCharacterPosts(charId) {
        const char = window.characters?.find(
          (c) => String(c.id) === String(charId)
        );
        if (!char) return;

        const charPosts = window.momentsData.posts.filter(
          (p) => p.authorId === String(charId)
        );
        if (charPosts.length === 0) {
          showToast(`${char.note || char.name} ËøòÊ≤°ÊúâÂèëÂ∏ÉÂä®ÊÄÅ~`);
          return;
        }

        // ÊªöÂä®Âà∞ËØ•ËßíËâ≤ÁöÑÁ¨¨‰∏ÄÊù°Âä®ÊÄÅ
        const container = document.getElementById("igFeed");
        const firstPost = container.querySelector(
          `[data-post-id="${charPosts[0].id}"]`
        );
        if (firstPost) {
          firstPost.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      }

      // ÁîüÊàêÂä®ÊÄÅÁõ∏ÂÖ≥ÁöÑAIÊèêÁ§∫ËØç
      function generateMomentsPromptForAi() {
        const posts = window.momentsData.posts.filter((p) => p.isUser);
        if (posts.length === 0) return "";

        // Ëé∑ÂèñÊúÄËøëÁöÑ3Êù°Áî®Êà∑Âä®ÊÄÅ
        const recentPosts = posts.slice(0, 3);
        let prompt =
          "\n\n„ÄêÁî®Êà∑ÊúÄËøëÁöÑÂä®ÊÄÅ„Äë‰ª•‰∏ãÊòØÁî®Êà∑Âú®Á§æ‰∫§Âä®ÊÄÅ‰∏≠ÂàÜ‰∫´ÁöÑÂÜÖÂÆπÔºå‰Ω†ÂèØ‰ª•Âú®ÂØπËØù‰∏≠Ëá™ÁÑ∂Âú∞ÊèêÂèäÊàñËØ¢ÈóÆÁõ∏ÂÖ≥ËØùÈ¢òÔºö\n";

        recentPosts.forEach((post, index) => {
          const timeStr = formatPostTime(post.timestamp);
          prompt += `${index + 1}. ${timeStr}: "${post.content}"`;
          if (post.textImage) {
            prompt += ` [ÈÖçÂõæÊèèËø∞: ${post.textImage}]`;
          }
          prompt += "\n";
        });

        prompt +=
          '‰Ω†ÂèØ‰ª•Ëá™ÁÑ∂Âú∞Âú®ÂØπËØù‰∏≠ÊèêÂà∞Ëøô‰∫õÂä®ÊÄÅÔºåÊØîÂ¶Ç"ÊàëÁúãÂà∞‰Ω†ÂèëÁöÑÂä®ÊÄÅ‰∫Ü..."ÊàñËÄÖËØ¢ÈóÆÁõ∏ÂÖ≥ÁöÑËØùÈ¢òÔºå‰ΩÜ‰∏çË¶ÅÊòæÂæóÂ§™ÂàªÊÑè„ÄÇ';
        return prompt;
      }

      // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñÂä®ÊÄÅÁ≥ªÁªü
      document.addEventListener("DOMContentLoaded", function () {
        setTimeout(() => {
          initTodoSystem();
          initPeriodSystem();
          initMomentsSystem();
        }, 500);
      });

      // ==================== Â§ñËßÇËÆæÁΩÆÂäüËÉΩ ====================
      // Â§ñËßÇËÆæÁΩÆÊï∞ÊçÆ
      window.appearanceSettings = {
        wallpaper: null,
        fontColor: "#37474f",
        apps: {
          chat: { name: "ËÅäÂ§©", icon: null },
          worldbook: { name: "‰∏ñÁïå‰π¶", icon: null },
          forum: { name: "ËÆ∫Âùõ", icon: null },
          api: { name: "APIËÆæÁΩÆ", icon: null },
          font: { name: "Â≠ó‰Ωì", icon: null },
          appearance: { name: "Â§ñËßÇËÆæÁΩÆ", icon: null },
        },
      };

      // Âä†ËΩΩÂ§ñËßÇËÆæÁΩÆ
      async function loadAppearanceSettings() {
        try {
          const saved = await localforage.getItem("appearanceSettings");
          if (saved) {
            window.appearanceSettings = saved;
            applyAppearanceSettings();
          }
        } catch (e) {
          console.error("Âä†ËΩΩÂ§ñËßÇËÆæÁΩÆÂ§±Ë¥•:", e);
        }
      }

      // Â∫îÁî®Â§ñËßÇËÆæÁΩÆ
      function applyAppearanceSettings() {
        const settings = window.appearanceSettings;

        // Â∫îÁî®Â£ÅÁ∫∏
        if (settings.wallpaper) {
          document.querySelector(
            ".phone-container"
          ).style.backgroundImage = `url(${settings.wallpaper})`;
          document.querySelector(".phone-container").style.backgroundSize =
            "cover";
          document.querySelector(".phone-container").style.backgroundPosition =
            "center";
        }

        // Â∫îÁî®Â≠ó‰ΩìÈ¢úËâ≤
        document.documentElement.style.setProperty(
          "--text-primary",
          settings.fontColor
        );
        document
          .querySelectorAll(".app-name, .profile-name, .dock-label")
          .forEach((el) => {
            el.style.color = settings.fontColor;
          });

        // Â∫îÁî®APPÂêçÁß∞ÂíåÂõæÊ†á
        const appMappings = {
          chat: {
            iconSelector: ".apps-grid .app-item:nth-child(1) .app-icon",
            nameSelector: ".apps-grid .app-item:nth-child(1) .app-name",
          },
          worldbook: {
            iconSelector: ".apps-grid .app-item:nth-child(2) .app-icon",
            nameSelector: ".apps-grid .app-item:nth-child(2) .app-name",
          },
          forum: {
            iconSelector: ".apps-grid .app-item:nth-child(3) .app-icon",
            nameSelector: ".apps-grid .app-item:nth-child(3) .app-name",
          },
          api: {
            iconSelector: ".dock .dock-item:nth-child(1) .dock-icon",
            nameSelector: ".dock .dock-item:nth-child(1) .dock-label",
          },
          font: {
            iconSelector: ".dock .dock-item:nth-child(2) .dock-icon",
            nameSelector: ".dock .dock-item:nth-child(2) .dock-label",
          },
          appearance: {
            iconSelector: ".dock .dock-item:nth-child(3) .dock-icon",
            nameSelector: ".dock .dock-item:nth-child(3) .dock-label",
          },
        };

        Object.keys(settings.apps).forEach((appKey) => {
          const app = settings.apps[appKey];
          const mapping = appMappings[appKey];
          if (mapping) {
            const iconEl = document.querySelector(mapping.iconSelector);
            const nameEl = document.querySelector(mapping.nameSelector);
            if (iconEl && app.icon) {
              iconEl.innerHTML = `<img src="${app.icon}" style="width:100%;height:100%;object-fit:cover;border-radius:inherit;">`;
            } else if (iconEl && app.name) {
              iconEl.textContent = app.name;
            }
            if (nameEl) {
              nameEl.textContent = app.name;
            }
          }
        });
      }

      // È¢ÑËßàÂ£ÅÁ∫∏
      function previewWallpaper(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const preview = document.getElementById("wallpaperPreview");
            preview.innerHTML = `<img src="${e.target.result}">`;
            window.appearanceSettings.wallpaper = e.target.result;
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      // ÈáçÁΩÆÂ£ÅÁ∫∏
      function resetWallpaper() {
        const preview = document.getElementById("wallpaperPreview");
        preview.innerHTML =
          '<div class="wallpaper-placeholder">ÁÇπÂáªÊõ¥Êç¢Â£ÅÁ∫∏</div>';
        window.appearanceSettings.wallpaper = null;
      }

      // ËÆæÁΩÆÂ≠ó‰ΩìÈ¢úËâ≤
      function setFontColor(color) {
        window.appearanceSettings.fontColor = color;
        // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
        document.querySelectorAll(".color-option").forEach((el) => {
          el.classList.remove("selected");
          if (el.dataset.color === color) {
            el.classList.add("selected");
          }
        });
      }

      // È¢ÑËßàAPPÂõæÊ†á
      function previewAppIcon(appKey, input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const iconEl = document.getElementById(`customIcon_${appKey}`);
            iconEl.innerHTML = `<img src="${e.target.result}">`;
            window.appearanceSettings.apps[appKey].icon = e.target.result;
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      // ‰øùÂ≠òÂ§ñËßÇËÆæÁΩÆ
      async function saveAppearanceSettings() {
        // Êî∂ÈõÜAPPÂêçÁß∞
        Object.keys(window.appearanceSettings.apps).forEach((appKey) => {
          const nameInput = document.getElementById(`customName_${appKey}`);
          if (nameInput) {
            window.appearanceSettings.apps[appKey].name =
              nameInput.value || appKey;
          }
        });

        try {
          await localforage.setItem(
            "appearanceSettings",
            window.appearanceSettings
          );
          applyAppearanceSettings();
          showToast("Â§ñËßÇËÆæÁΩÆÂ∑≤‰øùÂ≠ò ‚ú®");
        } catch (e) {
          console.error("‰øùÂ≠òÂ§ñËßÇËÆæÁΩÆÂ§±Ë¥•:", e);
          showToast("‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï");
        }
      }

      // ==================== ÂàÜÁªÑÁÆ°ÁêÜÂäüËÉΩ ====================
      window.customGroups = [];

      // Âä†ËΩΩÂàÜÁªÑ
      async function loadCustomGroups() {
        try {
          const saved = await localforage.getItem("customGroups");
          window.customGroups = saved || [];
          updateGroupSelect();
        } catch (e) {
          console.error("Âä†ËΩΩÂàÜÁªÑÂ§±Ë¥•:", e);
        }
      }

      // Êõ¥Êñ∞ÂàÜÁªÑ‰∏ãÊãâÊ°Ü
      function updateGroupSelect() {
        const select = document.getElementById("settingsGroup");
        if (!select) return;
        select.innerHTML = '<option value="none">Êú™ÂàÜÁªÑ</option>';
        window.customGroups.forEach((group) => {
          const option = document.createElement("option");
          option.value = group;
          option.textContent = group;
          select.appendChild(option);
        });
      }

      // ÊâìÂºÄÂàÜÁªÑÁÆ°ÁêÜ
      function openGroupManager() {
        renderGroupList();
        document.getElementById("groupManagerModal").classList.add("active");
      }

      // ÂÖ≥Èó≠ÂàÜÁªÑÁÆ°ÁêÜ
      function closeGroupManager() {
        document.getElementById("groupManagerModal").classList.remove("active");
      }

      // Ê∏≤ÊüìÂàÜÁªÑÂàóË°®
      function renderGroupList() {
        const container = document.getElementById("groupList");
        container.innerHTML = window.customGroups
          .map(
            (group, index) => `
          <div class="group-item">
            <span class="group-item-name">${group}</span>
            <button class="group-item-delete" onclick="deleteGroup(${index})">‚úï</button>
          </div>
        `
          )
          .join("");
      }

      // Ê∑ªÂä†Êñ∞ÂàÜÁªÑ
      async function addNewGroup() {
        const input = document.getElementById("newGroupInput");
        const name = input.value.trim();
        if (!name) return;
        if (window.customGroups.includes(name)) {
          showToast("ÂàÜÁªÑÂ∑≤Â≠òÂú®");
          return;
        }
        window.customGroups.push(name);
        await localforage.setItem("customGroups", window.customGroups);
        input.value = "";
        renderGroupList();
        updateGroupSelect();
        showToast("ÂàÜÁªÑÊ∑ªÂä†ÊàêÂäü");
      }

      // Âà†Èô§ÂàÜÁªÑ
      async function deleteGroup(index) {
        window.customGroups.splice(index, 1);
        await localforage.setItem("customGroups", window.customGroups);
        renderGroupList();
        updateGroupSelect();
        showToast("ÂàÜÁªÑÂ∑≤Âà†Èô§");
      }

      // ÁΩÆÈ°∂ËÅîÁ≥ª‰∫∫ÂàáÊç¢
      function togglePinContact() {
        // Ëøô‰∏™‰ºöÂú®saveChatSettingsÊó∂‰øùÂ≠ò
      }

      // ËÆæÁΩÆÁî®Êà∑Ê∞îÊ≥°È¢úËâ≤
      function setUserBubbleColor(color) {
        document.getElementById("settingsUserBubbleColor").value = color;
        // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
        document
          .querySelectorAll("#userColorGrid .color-preset")
          .forEach((el) => {
            el.classList.remove("selected");
            if (
              el.style.background === color ||
              el.style.backgroundColor === color
            ) {
              el.classList.add("selected");
            }
          });
      }

      // ËÆæÁΩÆAIÊ∞îÊ≥°È¢úËâ≤
      function setAiBubbleColor(color) {
        document.getElementById("settingsAiBubbleColor").value = color;
        // Êõ¥Êñ∞ÈÄâ‰∏≠Áä∂ÊÄÅ
        document
          .querySelectorAll("#aiColorGrid .color-preset")
          .forEach((el) => {
            el.classList.remove("selected");
            if (
              el.style.background === color ||
              el.style.backgroundColor === color
            ) {
              el.classList.add("selected");
            }
          });
      }

      // ==================== ËÅäÂ§©ËÆ∞ÂΩïÊêúÁ¥¢ÂäüËÉΩ ====================
      function searchChatHistory(keyword) {
        const resultsContainer = document.getElementById("searchResults");
        const messageList = document.getElementById("messageList");

        if (!keyword || keyword.trim().length < 1) {
          resultsContainer.classList.remove("active");
          resultsContainer.innerHTML = "";
          messageList.style.display = "block";
          return;
        }

        keyword = keyword.trim().toLowerCase();
        const results = [];

        // ÊêúÁ¥¢ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩï - ‰ΩøÁî®window‰∏äÁöÑÂèòÈáèÁ°Æ‰øùËÉΩËÆøÈóÆ
        const histories = window.chatHistories || chatHistories || {};
        const chars = window.characters || characters || [];

        Object.keys(histories).forEach((charId) => {
          const history = histories[charId] || [];
          const char = chars.find((c) => c.id == charId);
          if (!char) return;

          history.forEach((msg, index) => {
            const content = msg.content || "";
            if (content.toLowerCase().includes(keyword)) {
              results.push({
                charId,
                charName: char.name,
                charAvatar: char.avatar,
                content: content,
                index,
              });
            }
          });
        });

        if (results.length === 0) {
          resultsContainer.innerHTML =
            '<div style="padding: 20px; text-align: center; color: #999;">Ê≤°ÊúâÊâæÂà∞Áõ∏ÂÖ≥ËÆ∞ÂΩï</div>';
        } else {
          resultsContainer.innerHTML = results
            .slice(0, 20)
            .map((r) => {
              // Êà™ÂèñÂÖ≥ÈîÆËØçÂë®Âõ¥ÁöÑÂÜÖÂÆπ
              const lowerContent = r.content.toLowerCase();
              const keywordIndex = lowerContent.indexOf(keyword);
              let displayContent = r.content;
              if (r.content.length > 60) {
                const start = Math.max(0, keywordIndex - 20);
                const end = Math.min(
                  r.content.length,
                  keywordIndex + keyword.length + 40
                );
                displayContent =
                  (start > 0 ? "..." : "") +
                  r.content.substring(start, end) +
                  (end < r.content.length ? "..." : "");
              }

              const highlighted = displayContent.replace(
                new RegExp(
                  keyword.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"),
                  "gi"
                ),
                (match) => `<mark>${match}</mark>`
              );
              return `
              <div class="search-result-item" onclick="openConversation(${r.charId}); document.getElementById('chatSearchInput').value=''; searchChatHistory('');">
                <div class="search-result-char">${r.charName}</div>
                <div class="search-result-content">${highlighted}</div>
              </div>
            `;
            })
            .join("");
        }

        resultsContainer.classList.add("active");
        messageList.style.display = "none";
      }

      // ÂàùÂßãÂåñÂä†ËΩΩÂàÜÁªÑ
      document.addEventListener("DOMContentLoaded", function () {
        loadCustomGroups();
      });

      // ÂàùÂßãÂåñÂ§ñËßÇËÆæÁΩÆÈ°µÈù¢
      function initAppearancePage() {
        const settings = window.appearanceSettings;

        // ÊòæÁ§∫ÂΩìÂâçÂ£ÅÁ∫∏
        if (settings.wallpaper) {
          document.getElementById(
            "wallpaperPreview"
          ).innerHTML = `<img src="${settings.wallpaper}">`;
        }

        // ÊòæÁ§∫ÂΩìÂâçÂ≠ó‰ΩìÈ¢úËâ≤
        document.querySelectorAll(".color-option").forEach((el) => {
          if (el.dataset.color === settings.fontColor) {
            el.classList.add("selected");
          }
        });

        // ÊòæÁ§∫ÂΩìÂâçAPPËÆæÁΩÆ
        Object.keys(settings.apps).forEach((appKey) => {
          const app = settings.apps[appKey];
          const nameInput = document.getElementById(`customName_${appKey}`);
          const iconEl = document.getElementById(`customIcon_${appKey}`);
          if (nameInput) nameInput.value = app.name;
          if (iconEl && app.icon) {
            iconEl.innerHTML = `<img src="${app.icon}">`;
          }
        });
      }

      // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
      document.addEventListener("DOMContentLoaded", function () {
        loadAppearanceSettings();
      });

      // ÊâìÂºÄÂ§ñËßÇËÆæÁΩÆÈ°µÈù¢Êó∂ÂàùÂßãÂåñ
      const originalOpenPage = window.openPage || function () {};
      window.openPage = function (pageId) {
        originalOpenPage(pageId);
        if (pageId === "appearancePage") {
          initAppearancePage();
        }
      };

      // ==================== Â∞ÜÊâÄÊúâonclickÈúÄË¶ÅÁöÑÂáΩÊï∞ÊåÇËΩΩÂà∞window ====================
      Object.assign(window, {
        // È°µÈù¢ÂØºËà™
        openPage,
        closePage,
        // ÁºñËæëÊ®°ÊÄÅÊ°Ü
        openEditModal,
        closeEditModal,
        saveEdit,
        // ËÅäÂ§©Ê†áÁ≠æÂàáÊç¢
        switchChatTab,
        handleHeaderBtn,
        // ËßíËâ≤ÁÆ°ÁêÜ
        openCreateCharModal,
        closeCreateCharModal,
        createCharacter,
        openConversation,
        closeConversation,
        deleteCharacter,
        blockCharacter,
        // APIËÆæÁΩÆ
        openApiPresetModal,
        closeApiPresetModal,
        selectApiPreset,
        editApiPreset,
        saveApiPreset,
        deleteApiPreset,
        togglePresetKeyVisibility,
        selectPresetModel,
        renderModelDropdown,
        // ËÅäÂ§©ËÆæÁΩÆ
        openChatSettings,
        closeChatSettings,
        saveChatSettings,
        toggleAvatarDisplay,
        applyAvatarVisibility,
        // ÂàÜÁªÑÁÆ°ÁêÜ
        openGroupManager,
        closeGroupManager,
        addNewGroup,
        deleteGroup,
        toggleGroup,
        togglePinContact,
        // Ê∞îÊ≥°È¢úËâ≤ÈÄâÊã©
        setUserBubbleColor,
        setAiBubbleColor,
        // ËÅäÂ§©ÊêúÁ¥¢
        searchChatHistory,
        clearSettingsAvatar,
        selectRadio,
        showToast,
        // Êñ∞Ê∂àÊÅØÈÄöÁü•Á≥ªÁªü
        showMessageNotification,
        handleNotificationClick,
        addUnreadMessage,
        clearUnreadForChar,
        updateMessagesBadge,
        addUnreadMoment,
        clearUnreadMoments,
        updateMomentsBadge,
        // ËÅäÂ§©ÂäüËÉΩ
        sendUserMessage,
        clearChatHistory,
        clearChatHistoryFromSettings,
        // Ê∞îÊ≥°ÂíåÊ∂àÊÅØÊìç‰Ωú
        handleBubbleClick,
        handleCopyMsg,
        handleRecallMsg,
        handleDeleteMsg,
        handleEditMsg,
        hideContextMenu,
        deleteSelectedMessages,
        exitSelectionMode,
        handleMultiSelect,
        // ÊëòË¶ÅÂäüËÉΩ
        triggerManualSummary,
        viewSummaries,
        startEditSummary,
        cancelEditSummary,
        saveSummaryEdit,
        closeSummaryModal,
        // Â≠ó‰ΩìËÆæÁΩÆ
        switchFontSource,
        previewCustomFont,
        saveFontPreset,
        activateFont,
        applySystemFont,
        deleteFontPreset,
        // Ê∞îÊ≥°Ê†∑Âºè
        manageBubbleStyles,
        exportBubbleStyle,
        importBubbleStyle,
        resetCustomCSS,
        // ËÅäÂ§©ÂéÜÂè≤ÂØºÂÖ•ÂØºÂá∫
        importChatHistory,
        exportChatHistory,
        searchChatContent,
        // Â•ΩÂèãÂàÜÁªÑ
        manageFriendGroups,
        // Áî®Êà∑‰∫∫ËÆæÈ¢ÑËÆæ
        saveUserPersonaPreset,
        // ËØ≠Èü≥ÂäüËÉΩ
        switchVoiceUrl,
        saveVoiceConfig,
        toggleVoiceText,
        playVoiceMessage,
        handleVoiceBubbleTouchStart,
        handleVoiceBubbleTouchEnd,
        // ËÅäÂ§©Èù¢Êùø
        toggleChatPanel,
        closeChatPanel,
        // Â§öÂ™í‰ΩìÊ∂àÊÅØ
        sendRedPacket,
        sendNudge,
        handleCameraAction,
        startFakeCall,
        sendFakeLocation,
        showFullImage,
        // Ëß¶Êë∏Â§ÑÁêÜ
        handleTouchStart,
        handleTouchMove,
        handleTouchEnd,
        handleMouseDown,
        handleMouseUp,
        // ‰∏ÄËµ∑ËØª‰π¶
        openReadTogether,
        closeReadTogether,
        handleBookImport,
        readPrevSection,
        readNextSection,
        jumpToSection,
        selectBook,
        startReading,
        stopCurrentReading,
        deleteBook,
        startFloatingMode,
        showFloatingBtn,
        hideFloatingBtn,
        toggleFloatingPanel,
        hideFloatingPanel,
        updateFloatingPanel,
        getCurrentReadingContent,
        advanceReadingProgress,
        // AIË°®ÊÉÖÂåÖÁªëÂÆö
        openAiBindModal,
        closeAiBindModal,
        toggleAiBindCategory,
        saveAiBindings,
        // ÂæÖÂäû‰∫ãÈ°π
        openTodoModal,
        closeTodoModal,
        saveTodoItem,
        toggleTodoDone,
        notifyAiTodoCompleted,
        deleteTodoItem,
        filterTodos,
        selectTodoTag,
        toggleTodoAiBinding,
        aiGreetForTodoBinding,
        renderTodoAiCharList,
        renderTodoTagSelect,
        // ÂæÖÂäûËÆæÁΩÆ
        openTodoSettingsModal,
        closeTodoSettingsModal,
        saveTodoSettings,
        addTodoCategory,
        deleteTodoCategory,
        loadGreetingForEdit,
        saveGreeting,
        // ÁªèÊúüËÆ∞ÂΩï
        openPeriodModal,
        closePeriodModal,
        savePeriodSettings,
        recordPeriodStart,
        // InstagramÂä®ÊÄÅÁ≥ªÁªü
        initMomentsSystem,
        renderMomentsUI,
        renderStoriesBar,
        renderFeed,
        openPostModal,
        closePostModal,
        selectImageOption,
        handleImageSelect,
        removeImage,
        checkPostValid,
        submitPost,
        renderVisibilityOptions,
        selectVisibility,
        toggleVisibilityGroup,
        toggleLike,
        toggleBookmark,
        openComments,
        closeCommentsModal,
        sendComment,
        setReplyTo,
        openPostMenu,
        closePostMenu,
        deletePost,
        confirmDeletePost,
        sharePostToChat,
        closeShareModal,
        confirmShareToChat,
        openProfileModal,
        closeProfileModal,
        handleAvatarSelect,
        openEmojiPicker,
        saveProfile,
        showCharacterPosts,
        generateMomentsPromptForAi,
        // Â§ñËßÇËÆæÁΩÆ
        previewWallpaper,
        resetWallpaper,
        setFontColor,
        previewAppIcon,
        saveAppearanceSettings,
        loadAppearanceSettings,
        applyAppearanceSettings,
        initAppearancePage,
      });
      console.log("‚úÖ ÊâÄÊúâÂáΩÊï∞Â∑≤ÊåÇËΩΩÂà∞window");
      // üÜï Êô∫ËÉΩËß£ÊûêÊñáÊú¨ÔºöËá™Âä®ËØÜÂà´ "ÂÖ≥ÈîÆËØçÔºöURL" Ê†ºÂºè
      function parseStickersFromText(text) {
        const lines = text.split(/\r?\n/); // ÊåâË°åÂàÜÂâ≤
        const results = [];

        // ÂåπÈÖç URL ÁöÑÊ≠£Âàô
        const urlRegex = /(https?:\/\/[^\s"']+)/;

        lines.forEach((line) => {
          line = line.trim();
          if (!line) return;

          // 1. ÂÖàÊâæÊúâÊ≤°Êúâ URL
          const urlMatch = line.match(urlRegex);
          if (urlMatch) {
            const url = urlMatch[0];
            let desc = ""; // ÈªòËÆ§Á©∫ÔºåÁ®çÂêéÂ§ÑÁêÜ

            // 2. ÊâæÂàÜÈöîÁ¨¶ (‰∏≠ÊñáÂÜíÂè∑ Êàñ Ëã±ÊñáÂÜíÂè∑)
            // ‰πüÂ∞±ÊòØÊâæ URL ÂâçÈù¢ÁöÑÈÉ®ÂàÜ
            const sepRegex = /[:Ôºö]/;
            const match = line.match(sepRegex);

            if (match && match.index < line.indexOf("http")) {
              // Â¶ÇÊûúÂÜíÂè∑Âú® http ‰πãÂâçÔºåËØ¥ÊòéÂÜíÂè∑ÂâçÊòØÊèèËø∞
              desc = line.substring(0, match.index).trim();
            }

            // 3. Â≠òÂÖ•ÁªìÊûú
            results.push({
              src: url,
              desc: desc, // Â¶ÇÊûúÊ≤°ÊâæÂà∞ÂÜíÂè∑ÔºåËøôÈáåÂ∞±ÊòØÁ©∫Â≠óÁ¨¶‰∏≤
            });
          }
        });

        return results;
      }
    </script>
    <div
      class="context-menu-overlay"
      id="contextMenuOverlay"
      onclick="hideContextMenu()"
    >
      <div class="context-menu" id="contextMenu"></div>
    </div>

    <div class="selection-footer" id="selectionFooter">
      <button class="selection-btn cancel" onclick="exitSelectionMode()">
        ÂèñÊ∂à
      </button>
      <span
        style="font-size: 1rem; font-weight: 600; color: #333"
        id="selectionCount"
        >Â∑≤ÈÄâ 0 Êù°</span
      >
      <button
        class="selection-btn delete"
        id="multiDeleteBtn"
        onclick="deleteSelectedMessages()"
      >
        üóëÔ∏è Âà†Èô§
      </button>
    </div>

    <!-- Êñ∞Ê∂àÊÅØÈÄöÁü•ÂºπÁ™ó -->
    <div
      class="message-notification"
      id="messageNotification"
      onclick="handleNotificationClick()"
    >
      <div class="notification-avatar" id="notificationAvatar">ü§ñ</div>
      <div class="notification-content">
        <div class="notification-name" id="notificationName">ËßíËâ≤Âêç</div>
        <div class="notification-text" id="notificationText">Ê∂àÊÅØÂÜÖÂÆπ</div>
      </div>
      <div class="notification-time" id="notificationTime">ÂàöÂàö</div>
    </div>
  </body>
</html>
