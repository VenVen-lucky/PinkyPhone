<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />

    <!-- PWA 配置 -->
    <link rel="manifest" href="manifest.json" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="PinkyPhone" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="theme-color" content="#fce4ec" />

    <!-- 主屏幕图标 -->
    <link
      rel="apple-touch-icon"
      href="https://i.postimg.cc/8kmQwCr0/IMG-2897.jpg"
    />
    <link
      rel="apple-touch-icon"
      sizes="152x152"
      href="https://i.postimg.cc/8kmQwCr0/IMG-2897.jpg"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="https://i.postimg.cc/8kmQwCr0/IMG-2897.jpg"
    />
    <link
      rel="icon"
      type="image/png"
      href="https://i.postimg.cc/8kmQwCr0/IMG-2897.jpg"
    />

    <title>PinkyPhone</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=Satisfy&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js?v=1.4"></script>

    <!-- 外部样式表 -->
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="moment-instagram.css" />
    <link rel="stylesheet" href="music_together.css" />
    <link rel="stylesheet" href="phone_peek.css" />
    <link rel="stylesheet" href="continue_chat.css" />
    <link rel="stylesheet" href="forum_app.css" />
  </head>
  <body>
    <!-- Decorative stars -->
    <div class="star star-1"></div>
    <div class="star star-2"></div>
    <div class="star star-3"></div>
    <div class="star star-4"></div>
    <div class="star star-5"></div>

    <div class="phone-container">
      <div class="main-content">
        <div class="profile-widget-new">
          <div class="profile-bg-container" onclick="triggerBgUpload()">
            <img
              id="userProfileBg"
              src="https://images.unsplash.com/photo-1490750967868-58cb75069ed6?auto=format&fit=crop&w=800&q=80"
              alt="背景墙"
            />
            <div class="bg-edit-hint">点击更换背景</div>
          </div>

          <div class="profile-info-card">
            <div class="profile-avatar-wrapper" onclick="triggerAvatarUpload()">
              <img
                id="userProfileAvatar"
                src='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">🐰</text></svg>'
                alt="头像"
              />
            </div>

            <div
              class="profile-name-large"
              id="userNameDisplay"
              onclick="editUserName()"
            >
              你的名字
            </div>

            <div
              class="profile-bio-text"
              id="userBioDisplay"
              onclick="editUserBio()"
            >
              点击这里设置你的个性签名...
            </div>

            <div class="profile-location" onclick="editUserLocation()">
              <svg
                class="location-icon"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M12 13.43a3.12 3.12 0 1 0 0-6.24 3.12 3.12 0 0 0 0 6.24Z"
                  stroke="currentColor"
                  stroke-width="1.5"
                />
                <path
                  d="M3.62 8.49c1.97-8.66 14.8-8.65 16.76 0 1.15 5.08-2.01 9.38-4.78 12.04a5.193 5.193 0 0 1-7.2 0C5.63 17.87 2.47 13.57 3.62 8.49Z"
                  stroke="currentColor"
                  stroke-width="1.5"
                />
              </svg>
              <span id="userLocationDisplay">添加定位</span>
            </div>
          </div>

          <input
            type="file"
            id="bgInput"
            hidden
            accept="image/*"
            onchange="handleBgChange(this)"
          />
          <input
            type="file"
            id="avatarInput"
            hidden
            accept="image/*"
            onchange="handleAvatarChange(this)"
          />
        </div>

        <!-- Apps -->
        <div class="apps-section">
          <div class="apps-grid">
            <!-- 恋爱纪念日小组件 (2x2) - 左上角 -->
            <div
              class="love-widget widget-2x2"
              id="loveWidget"
              onclick="handleLoveWidgetClick(event)"
            >
              <div class="love-widget-bg" id="loveWidgetBg"></div>
              <div
                class="love-days-row"
                onclick="openLoveEditModal('startDate')"
              >
                <span class="love-days-number" id="loveDaysNumber">0</span>
                <span class="love-days-unit">天</span>
              </div>

              <div class="love-avatars-row">
                <div
                  class="love-avatar"
                  onclick="document.getElementById('loveAvatar1Input').click()"
                >
                  <img
                    class="love-avatar-placeholder-img"
                    id="loveAvatar1Placeholder"
                    src="https://www.yn12377.cn/jubao/upload/smjb/2025/12/28/b7957012b29e42bdbf237cb27f46bb91.jpg"
                  />
                  <img id="loveAvatar1Img" src="" style="display: none" />
                </div>
                <div
                  class="love-avatar"
                  onclick="document.getElementById('loveAvatar2Input').click()"
                >
                  <img
                    class="love-avatar-placeholder-img"
                    id="loveAvatar2Placeholder"
                    src="https://www.yn12377.cn/jubao/upload/smjb/2025/12/28/b7957012b29e42bdbf237cb27f46bb91.jpg"
                  />
                  <img id="loveAvatar2Img" src="" style="display: none" />
                </div>
              </div>
              <input
                type="file"
                id="loveAvatar1Input"
                class="hidden-input"
                accept="image/*"
                onchange="handleLoveAvatarUpload(1, this)"
              />
              <input
                type="file"
                id="loveAvatar2Input"
                class="hidden-input"
                accept="image/*"
                onchange="handleLoveAvatarUpload(2, this)"
              />
              <input
                type="file"
                id="loveWidgetBgInput"
                class="hidden-input"
                accept="image/*"
                onchange="handleLoveWidgetBgUpload(this)"
              />

              <div class="love-title-row" onclick="openLoveEditModal('title')">
                <span class="love-title-text" id="loveTitleText">恋爱纪念</span>
              </div>

              <div
                class="love-date"
                id="loveDateText"
                onclick="openLoveEditModal('startDate')"
              >
                2024.01.01
              </div>
            </div>

            <!-- 右上角4个App -->
            <div class="app-item" onclick="openPage('chatPage')">
              <div class="app-icon gradient-pink">聊天</div>
              <span class="app-name">聊天</span>
            </div>
            <div class="app-item" onclick="openPage('worldbookPage')">
              <div class="app-icon gradient-green">世界书</div>
              <span class="app-name">世界书</span>
            </div>
            <div class="app-item" onclick="openPage('presetPage')">
              <div class="app-icon gradient-orange">预设</div>
              <span class="app-name">预设</span>
            </div>
            <div class="app-item" onclick="openPage('forumPage')">
              <div class="app-icon gradient-purple">论坛</div>
              <span class="app-name">论坛</span>
            </div>

            <!-- 第三行：情侣、陪伴在左边，拍立得在右边 -->
            <div class="app-item" onclick="openPage('coupleSpacePage')">
              <div class="app-icon gradient-pink">情侣</div>
              <span class="app-name">情侣空间</span>
            </div>
            <div class="app-item" onclick="openCompanionPage()">
              <div class="app-icon gradient-blue">陪伴</div>
              <span class="app-name">陪伴</span>
            </div>

            <!-- 拍立得小组件 (2x2) - 右下角 -->
            <div class="polaroid-widget widget-2x2" id="polaroidWidget">
              <div
                class="polaroid-photo-area"
                onclick="triggerPolaroidUpload()"
              >
                <img
                  id="polaroidImgDisplay"
                  src="https://images.unsplash.com/photo-1516961642265-531546e84af2?auto=format&fit=crop&w=400&q=80"
                  alt="拍立得"
                />
              </div>
              <div
                class="polaroid-caption"
                id="polaroidTextDisplay"
                onclick="editPolaroidText(event)"
              >
                My Moment
              </div>
              <input
                type="file"
                id="polaroidInput"
                hidden
                accept="image/*"
                onchange="handlePolaroidChange(this)"
              />
            </div>
          </div>
        </div>
      </div>

      <!-- Pages -->
      <div id="chatPage" class="page chat-app">
        <!-- Chat App Header -->
        <div class="chat-header">
          <button class="back-btn" onclick="closePage('chatPage')">←</button>
          <h1 class="chat-title" id="chatAppTitle">Message</h1>
          <div class="chat-header-btns">
            <button
              class="chat-header-btn"
              id="createGroupBtn"
              onclick="openCreateGroupModal()"
              title="创建群聊"
            >
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
            </button>
            <button
              class="chat-header-btn"
              id="chatHeaderBtn"
              onclick="handleHeaderBtn()"
            >
              +
            </button>
          </div>
        </div>

        <!-- Chat App Content -->
        <div class="chat-content">
          <!-- Messages Tab -->
          <div class="chat-tab-content active" id="messagesTab">
            <!-- Search bar -->
            <div class="search-bar">
              <span class="search-icon"
                ><svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <circle cx="11" cy="11" r="8"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg
              ></span>
              <input
                type="text"
                placeholder="搜索聊天记录"
                class="search-input"
                id="chatSearchInput"
                oninput="searchChatHistory(this.value)"
              />
            </div>

            <!-- 搜索结果 -->
            <div class="search-results" id="searchResults"></div>

            <!-- Message List -->
            <div class="message-list" id="messageList">
              <!-- Empty state -->
              <div class="empty-state" id="emptyMessages">
                <div class="empty-icon">
                  <svg
                    width="48"
                    height="48"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                    ></path>
                  </svg>
                </div>
                <div class="empty-text">还没有消息哦</div>
                <div class="empty-hint">添加AI角色开始聊天吧～</div>
              </div>
            </div>
          </div>

          <!-- Moments Tab (QQ空间风格动态) -->
          <div class="chat-tab-content" id="momentsTab">
            <!-- 个人名片区域 -->
            <div class="moment-profile-card">
              <div
                class="moment-cover"
                id="momentCover"
                onclick="changeMomentCover()"
              >
                <img id="momentCoverImg" src="" style="display: none" />
                <button
                  class="moment-cover-back"
                  onclick="event.stopPropagation();switchChatTab('messages')"
                >
                  ‹
                </button>
                <button
                  class="moment-cover-edit"
                  onclick="event.stopPropagation();changeMomentCover()"
                >
                  <svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"
                    ></path>
                    <circle cx="12" cy="13" r="4"></circle>
                  </svg>
                </button>
              </div>
              <div class="moment-profile-info">
                <div class="moment-avatar-row">
                  <div class="moment-avatar-wrap">
                    <div
                      class="moment-avatar"
                      id="momentAvatar"
                      onclick="changeMomentAvatar()"
                    >
                      <span id="momentAvatarEmoji">😊</span>
                      <img id="momentAvatarImg" src="" style="display: none" />
                    </div>
                    <button
                      class="moment-avatar-edit"
                      onclick="event.stopPropagation();changeMomentAvatar()"
                    >
                      <svg
                        width="10"
                        height="10"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2.5"
                      >
                        <path
                          d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"
                        ></path>
                        <circle cx="12" cy="13" r="4"></circle>
                      </svg>
                    </button>
                  </div>
                  <div class="moment-name-area">
                    <div
                      class="moment-nickname"
                      id="momentNickname"
                      onclick="editMomentNickname()"
                    >
                      用户
                    </div>
                    <div
                      class="moment-handle"
                      id="momentHandle"
                      onclick="editMomentHandle()"
                    >
                      @username
                    </div>
                  </div>
                </div>
                <div
                  class="moment-signature"
                  id="momentSignature"
                  onclick="editMomentSignature()"
                ></div>
              </div>
            </div>

            <!-- 动态列表 -->
            <div class="ig-feed" id="igFeed">
              <div class="ig-empty-state" id="igEmptyState">
                <div class="ig-empty-icon">
                  <svg
                    width="48"
                    height="48"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <rect
                      x="3"
                      y="3"
                      width="18"
                      height="18"
                      rx="2"
                      ry="2"
                    ></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                  </svg>
                </div>
                <div class="ig-empty-title">分享你的精彩瞬间</div>
                <div class="ig-empty-text">点击右下角按钮发布第一条动态吧~</div>
              </div>
            </div>

            <!-- 发布按钮 -->
            <button class="ig-fab" onclick="openPostModal()">
              <span class="ig-fab-icon">+</span>
            </button>
          </div>

          <!-- 发布动态弹窗 -->
          <div
            class="ig-post-modal"
            id="igPostModal"
            onclick="if(event.target===this)closePostModal()"
          >
            <div class="ig-post-modal-content">
              <div class="ig-modal-header">
                <button class="ig-modal-close" onclick="closePostModal()">
                  取消
                </button>
                <span class="ig-modal-title">新动态</span>
                <button
                  class="ig-modal-submit"
                  id="igPostSubmit"
                  onclick="submitPost()"
                  disabled
                >
                  发布
                </button>
              </div>
              <div class="ig-modal-body">
                <textarea
                  class="ig-post-textarea"
                  id="igPostText"
                  placeholder="分享你的想法..."
                  oninput="checkPostValid()"
                ></textarea>
                <div class="ig-image-options">
                  <div
                    class="ig-image-option"
                    onclick="selectImageOption('album')"
                    id="imgOptionAlbum"
                  >
                    <span class="ig-image-option-icon"
                      ><svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <rect
                          x="3"
                          y="3"
                          width="18"
                          height="18"
                          rx="2"
                          ry="2"
                        ></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline></svg
                    ></span>
                    <span class="ig-image-option-text">从相册选择</span>
                  </div>
                  <div
                    class="ig-image-option"
                    onclick="selectImageOption('text')"
                    id="imgOptionText"
                  >
                    <span class="ig-image-option-icon"
                      ><svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                        <path
                          d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"
                        ></path>
                        <path d="M2 2l7.586 7.586"></path>
                        <circle cx="11" cy="11" r="2"></circle></svg
                    ></span>
                    <span class="ig-image-option-text">文字配图</span>
                  </div>
                </div>
                <input
                  type="file"
                  id="igImageInput"
                  accept="image/*"
                  style="display: none"
                  onchange="handleImageSelect(event)"
                />
                <input
                  type="text"
                  class="ig-text-img-input"
                  id="igTextImgInput"
                  placeholder="输入图片描述，AI将看到这个描述..."
                  oninput="checkPostValid()"
                />
                <div class="ig-image-preview" id="igImagePreview">
                  <img id="igPreviewImg" src="" alt="" />
                  <span class="ig-image-preview-remove" onclick="removeImage()"
                    ><svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    移除图片</span
                  >
                </div>

                <!-- 可见范围选择 -->
                <div class="ig-visibility-section">
                  <div class="ig-visibility-label">
                    <svg
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                      ></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    谁可以看
                    <button
                      class="ig-manage-groups-btn"
                      onclick="openGroupManageModal()"
                      title="管理分组"
                    >
                      <svg
                        width="14"
                        height="14"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <circle cx="12" cy="12" r="3"></circle>
                        <path
                          d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                        ></path>
                      </svg>
                    </button>
                  </div>
                  <div class="ig-visibility-options" id="visibilityOptions">
                    <div
                      class="ig-visibility-option selected"
                      data-value="all"
                      onclick="selectVisibility('all', this)"
                    >
                      <span class="check-icon">✓</span> 公开
                    </div>
                    <!-- 分组选项会通过JS动态渲染 -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 自定义分组管理弹窗 -->
          <div
            class="ig-group-manage-modal"
            id="igGroupManageModal"
            onclick="if(event.target===this)closeGroupManageModal()"
          >
            <div class="ig-group-manage-content">
              <div class="ig-group-manage-header">
                <button
                  class="ig-group-manage-close"
                  onclick="closeGroupManageModal()"
                >
                  关闭
                </button>
                <span class="ig-group-manage-title">管理自定义分组</span>
                <button
                  class="ig-group-manage-add"
                  onclick="openCreateGroupModal()"
                >
                  <svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                </button>
              </div>
              <div class="ig-group-manage-list" id="customGroupList">
                <!-- 分组列表通过JS渲染 -->
              </div>
            </div>
          </div>

          <!-- 创建/编辑分组弹窗 -->
          <div
            class="ig-create-group-modal"
            id="igCreateGroupModal"
            onclick="if(event.target===this)closeCreateGroupModal()"
          >
            <div class="ig-create-group-content">
              <div class="ig-create-group-header">
                <button
                  class="ig-create-group-back"
                  onclick="closeCreateGroupModal()"
                >
                  取消
                </button>
                <span class="ig-create-group-title" id="createGroupTitle"
                  >新建分组</span
                >
                <button
                  class="ig-create-group-save"
                  onclick="saveCustomGroup()"
                >
                  保存
                </button>
              </div>
              <div class="ig-create-group-body">
                <div class="ig-create-group-name-section">
                  <label>分组名称</label>
                  <input
                    type="text"
                    id="customGroupNameInput"
                    placeholder="例如：仅闺蜜可见、不给谁看..."
                    maxlength="20"
                  />
                </div>
                <div class="ig-create-group-type-section">
                  <label>分组类型</label>
                  <div class="ig-group-type-options">
                    <div
                      class="ig-group-type-option selected"
                      data-type="include"
                      onclick="selectGroupType('include', this)"
                    >
                      <div class="ig-group-type-info">
                        <div class="ig-group-type-name">部分可见</div>
                        <div class="ig-group-type-desc">只有选中的人可以看</div>
                      </div>
                    </div>
                    <div
                      class="ig-group-type-option"
                      data-type="exclude"
                      onclick="selectGroupType('exclude', this)"
                    >
                      <div class="ig-group-type-info">
                        <div class="ig-group-type-name">不给谁看</div>
                        <div class="ig-group-type-desc">选中的人看不到</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="ig-create-group-members-section">
                  <div class="ig-members-header">
                    <label id="membersLabel">选择可见的人</label>
                    <div class="ig-members-actions">
                      <button onclick="selectAllGroupMembers()">全选</button>
                      <button onclick="deselectAllGroupMembers()">清空</button>
                    </div>
                  </div>
                  <div class="ig-members-search">
                    <input
                      type="text"
                      id="groupMemberSearch"
                      placeholder="搜索好友..."
                      oninput="filterGroupMemberList(this.value)"
                    />
                  </div>
                  <div class="ig-members-list" id="groupMemberList">
                    <!-- 好友列表通过JS渲染 -->
                  </div>
                  <div class="ig-members-count">
                    已选择 <span id="groupMemberCount">0</span> 人
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 个人资料编辑弹窗 -->
          <div
            class="ig-profile-modal"
            id="igProfileModal"
            onclick="if(event.target===this)closeProfileModal()"
          >
            <div class="ig-profile-modal-content">
              <div class="ig-profile-modal-header">
                <span class="ig-profile-modal-title">编辑个人资料</span>
                <button
                  class="ig-profile-modal-close"
                  onclick="closeProfileModal()"
                >
                  ✕
                </button>
              </div>
              <div class="ig-profile-modal-body">
                <div class="ig-profile-avatar-edit">
                  <div class="ig-profile-avatar-preview" id="igAvatarPreview">
                    A
                  </div>
                  <div class="ig-profile-avatar-btns">
                    <button
                      class="ig-profile-avatar-btn"
                      onclick="document.getElementById('igAvatarInput').click()"
                    >
                      上传照片
                    </button>
                    <button
                      class="ig-profile-avatar-btn"
                      onclick="openEmojiPicker()"
                    >
                      选择表情
                    </button>
                  </div>
                  <input
                    type="file"
                    id="igAvatarInput"
                    accept="image/*"
                    style="display: none"
                    onchange="handleAvatarSelect(event)"
                  />
                </div>
                <div class="ig-profile-form-group">
                  <label class="ig-profile-form-label">昵称</label>
                  <input
                    type="text"
                    class="ig-profile-form-input"
                    id="igEditName"
                    placeholder="输入你的昵称"
                  />
                </div>
                <div class="ig-profile-form-group">
                  <label class="ig-profile-form-label">用户名</label>
                  <input
                    type="text"
                    class="ig-profile-form-input"
                    id="igEditHandle"
                    placeholder="@username"
                  />
                </div>
                <div class="ig-profile-form-group">
                  <label class="ig-profile-form-label">个性签名</label>
                  <textarea
                    class="ig-profile-form-textarea"
                    id="igEditBio"
                    placeholder="写点什么介绍一下自己吧~"
                  ></textarea>
                </div>
                <button class="ig-profile-save-btn" onclick="saveProfile()">
                  保存
                </button>
              </div>
            </div>
          </div>

          <!-- 评论弹窗 -->
          <div
            class="ig-comments-modal"
            id="igCommentsModal"
            onclick="if(event.target===this)closeCommentsModal()"
          >
            <div class="ig-comments-modal-content">
              <div class="ig-comments-header">
                <span class="ig-comments-title">评论</span>
                <button
                  class="ig-comments-close"
                  onclick="closeCommentsModal()"
                >
                  ✕
                </button>
              </div>
              <div class="ig-comments-list" id="igCommentsList">
                <!-- 评论会动态渲染 -->
              </div>
              <div class="ig-comments-input-area">
                <input
                  type="text"
                  class="ig-comments-input"
                  id="igCommentInput"
                  placeholder="添加评论..."
                />
                <button class="ig-comments-send" onclick="sendComment()">
                  发送
                </button>
              </div>
            </div>
          </div>

          <!-- 转发选择弹窗 -->
          <div
            class="ig-share-modal"
            id="igShareModal"
            onclick="if(event.target===this)closeShareModal()"
          >
            <div class="ig-share-modal-content">
              <div class="ig-share-header">
                <span class="ig-share-title">转发给</span>
                <button class="ig-share-close" onclick="closeShareModal()">
                  ✕
                </button>
              </div>
              <div class="ig-share-list" id="igShareList">
                <!-- 角色列表会动态渲染 -->
              </div>
            </div>
          </div>

          <!-- 动态操作菜单 -->
          <div
            class="ig-post-menu"
            id="igPostMenu"
            onclick="if(event.target===this)closePostMenu()"
          >
            <div class="ig-post-menu-content">
              <div class="ig-post-menu-item" onclick="deletePost()">
                <span class="ig-post-menu-icon"
                  ><svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path
                      d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                    ></path></svg
                ></span>
                <span>删除动态</span>
              </div>
              <div class="ig-post-menu-cancel" onclick="closePostMenu()">
                取消
              </div>
            </div>
          </div>

          <!-- Todo Tab - 简约设计 -->
          <div class="chat-tab-content" id="todoTab">
            <div class="todo-container">
              <!-- 头部 -->
              <div class="todo-header">
                <div class="todo-header-left">
                  <div class="todo-date-card">
                    <div class="todo-date-day" id="todoDateDay">1</div>
                    <div class="todo-date-info" id="todoDateInfo">1月 周三</div>
                  </div>
                  <div class="todo-greeting">
                    <div class="todo-greeting-main" id="todoGreeting">
                      今天也要加油
                    </div>
                    <div class="todo-greeting-sub" id="todoGreetingSub">
                      新的一天，新的开始
                    </div>
                  </div>
                </div>
              </div>

              <!-- 统计 -->
              <div class="todo-stats">
                <div class="todo-stat-item">
                  <div class="todo-stat-num" id="todoStatTotal">0</div>
                  <div class="todo-stat-label">全部</div>
                </div>
                <div class="todo-stat-item">
                  <div class="todo-stat-num" id="todoStatDone">0</div>
                  <div class="todo-stat-label">完成</div>
                </div>
                <div class="todo-stat-item">
                  <div class="todo-stat-num" id="todoStatPending">0</div>
                  <div class="todo-stat-label">待办</div>
                </div>
              </div>

              <!-- 筛选栏 -->
              <div class="todo-filter-bar" id="todoFilterBar">
                <!-- 动态渲染 -->
              </div>

              <!-- 待办列表 -->
              <div class="todo-list" id="todoListContainer">
                <!-- 动态渲染 -->
              </div>

              <!-- 添加按钮 -->
              <button class="todo-add-btn" onclick="openTodoModal()">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                添加待办
              </button>

              <!-- AI督促区域 -->
              <div class="todo-ai-section">
                <div class="todo-ai-header">
                  <div class="todo-ai-icon">
                    <svg
                      width="18"
                      height="18"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"
                      ></path>
                      <circle cx="9" cy="7" r="4"></circle>
                      <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                      <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                  </div>
                  <div>
                    <div class="todo-ai-title">督促助手</div>
                    <div class="todo-ai-subtitle">选择角色来督促你完成待办</div>
                  </div>
                </div>
                <div class="todo-ai-list" id="todoAiCharList">
                  <!-- 动态渲染 -->
                </div>
              </div>
            </div>
          </div>

          <!-- 添加待办弹窗 -->
          <div
            class="todo-modal-overlay"
            id="todoModalOverlay"
            onclick="if(event.target===this)closeTodoModal()"
          >
            <div class="todo-modal">
              <div class="todo-modal-header">
                <div class="todo-modal-title">
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  添加待办
                </div>
                <button class="todo-modal-close" onclick="closeTodoModal()">
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              <div class="todo-modal-body">
                <div class="todo-input-group">
                  <label class="todo-input-label">待办内容</label>
                  <input
                    type="text"
                    class="todo-input"
                    id="todoInputText"
                    placeholder="要做什么？"
                    maxlength="100"
                  />
                </div>
                <div class="todo-input-group">
                  <label class="todo-input-label">选择分类</label>
                  <div class="todo-category-grid" id="todoTagSelect">
                    <!-- 动态渲染 -->
                  </div>
                </div>
                <div class="todo-input-group">
                  <label class="todo-input-label">重复周期</label>
                  <div class="todo-repeat-grid" id="todoRepeatSelect">
                    <div
                      class="todo-repeat-item selected"
                      data-repeat="none"
                      onclick="selectTodoRepeat(this)"
                    >
                      <div class="todo-repeat-name">不重复</div>
                    </div>
                    <div
                      class="todo-repeat-item"
                      data-repeat="daily"
                      onclick="selectTodoRepeat(this)"
                    >
                      <div class="todo-repeat-name">每天</div>
                    </div>
                    <div
                      class="todo-repeat-item"
                      data-repeat="weekday"
                      onclick="selectTodoRepeat(this)"
                    >
                      <div class="todo-repeat-name">工作日</div>
                    </div>
                    <div
                      class="todo-repeat-item"
                      data-repeat="weekly"
                      onclick="selectTodoRepeat(this)"
                    >
                      <div class="todo-repeat-name">每周</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="todo-modal-footer">
                <button class="todo-save-btn" onclick="saveTodoItem()">
                  添加
                </button>
              </div>
            </div>
          </div>

          <!-- 待办设置弹窗 -->
          <div
            class="todo-modal-overlay"
            id="todoSettingsOverlay"
            onclick="if(event.target===this)closeTodoSettingsModal()"
          >
            <div class="todo-settings-modal">
              <div class="todo-modal-header">
                <div class="todo-modal-title">
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                      d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                    ></path>
                  </svg>
                  设置
                </div>
                <button
                  class="todo-modal-close"
                  onclick="closeTodoSettingsModal()"
                >
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>
              </div>
              <div class="todo-modal-body">
                <!-- 问候语设置 -->
                <div class="todo-settings-section">
                  <div class="todo-settings-title">问候语</div>
                  <div class="greeting-preview">
                    <div class="greeting-preview-main" id="greetingPreviewMain">
                      今天也要加油
                    </div>
                    <div class="greeting-preview-sub" id="greetingPreviewSub">
                      新的一天，新的开始
                    </div>
                  </div>
                  <div class="todo-input-group" style="margin-bottom: 8px">
                    <input
                      type="text"
                      class="todo-input"
                      id="greetingMainInput"
                      placeholder="主问候语"
                      maxlength="20"
                    />
                  </div>
                  <div class="todo-input-group" style="margin-bottom: 8px">
                    <input
                      type="text"
                      class="todo-input"
                      id="greetingSubInput"
                      placeholder="副标题（可选）"
                      maxlength="30"
                    />
                  </div>
                  <button
                    class="todo-save-btn"
                    style="padding: 10px; font-size: 0.85rem"
                    onclick="saveGreeting()"
                  >
                    保存问候语
                  </button>
                </div>

                <!-- 分类管理 -->
                <div class="todo-settings-section">
                  <div class="todo-settings-title">分类管理</div>
                  <div
                    class="todo-category-grid"
                    id="todoCategoryList"
                    style="margin-bottom: 12px"
                  >
                    <!-- 动态渲染 -->
                  </div>
                  <div style="display: flex; gap: 8px">
                    <input
                      type="text"
                      class="todo-input"
                      id="newCategoryName"
                      placeholder="新分类名称"
                      maxlength="10"
                      style="flex: 1"
                    />
                    <button
                      class="todo-save-btn"
                      style="
                        padding: 10px 16px;
                        font-size: 0.85rem;
                        width: auto;
                      "
                      onclick="addTodoCategory()"
                    >
                      添加
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Profile Tab (我的) -->
          <div class="chat-tab-content" id="profileTab">
            <!-- 顶栏 -->
            <div class="tab-header">
              <button class="tab-header-back" onclick="closePage('chatPage')">
                ←
              </button>
              <span class="tab-header-title">Me</span>
              <span style="width: 36px"></span>
            </div>
            <!-- Profile Header -->
            <div class="profile-header-card">
              <div class="profile-main">
                <div
                  class="profile-avatar-large"
                  id="meProfileAvatar"
                  onclick="changeMomentAvatar()"
                >
                  <svg
                    width="32"
                    height="32"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="#f48fb1"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                </div>
                <div class="profile-info-main">
                  <div
                    class="profile-name-large"
                    id="meProfileName"
                    onclick="editMomentNickname()"
                  >
                    我的昵称
                  </div>
                  <div
                    class="profile-id"
                    id="meProfileHandle"
                    onclick="editMomentHandle()"
                  >
                    @username
                  </div>
                </div>
              </div>
            </div>

            <!-- Profile Menu -->
            <div class="profile-menu">
              <div class="menu-item" onclick="openWalletPage()">
                <span class="menu-icon"
                  ><svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <rect
                      x="1"
                      y="4"
                      width="22"
                      height="16"
                      rx="2"
                      ry="2"
                    ></rect>
                    <line x1="1" y1="10" x2="23" y2="10"></line></svg
                ></span>
                <span class="menu-text">我的钱包</span>
                <span class="menu-arrow">›</span>
              </div>
              <div class="menu-item" onclick="openFavoritesPage()">
                <span class="menu-icon"
                  ><svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <polygon
                      points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
                    ></polygon></svg
                ></span>
                <span class="menu-text">我的收藏</span>
                <span class="menu-arrow">›</span>
              </div>
              <div class="menu-item" onclick="openBackgroundActivityPage()">
                <span class="menu-icon"
                  ><svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline></svg
                ></span>
                <span class="menu-text">后台活动</span>
                <span class="menu-arrow" style="color: #f48fb1">›</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat App Bottom Tab Bar -->
        <div class="chat-tab-bar">
          <div class="chat-tab active" onclick="switchChatTab('messages')">
            <span class="tab-icon"
              ><svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                ></path></svg
            ></span>
            <span class="tab-badge" id="messagesBadge" style="display: none"
              >0</span
            >
            <span class="tab-label">Message</span>
          </div>
          <div class="chat-tab" onclick="switchChatTab('moments')">
            <span class="tab-icon"
              ><svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                <line x1="15" y1="9" x2="15.01" y2="9"></line></svg
            ></span>
            <span class="tab-badge" id="momentsBadge" style="display: none"
              >0</span
            >
            <span class="tab-label">Moment</span>
          </div>
          <div class="chat-tab" onclick="switchChatTab('todo')">
            <span class="tab-icon"
              ><svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M9 11l3 3L22 4"></path>
                <path
                  d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"
                ></path></svg
            ></span>
            <span class="tab-label">To Do</span>
          </div>
          <div class="chat-tab" onclick="switchChatTab('profile')">
            <span class="tab-icon"
              ><svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle></svg
            ></span>
            <span class="tab-label">Me</span>
          </div>
        </div>
      </div>

      <!-- 预设App页面 -->
      <div id="presetPage" class="page preset-page">
        <div class="preset-header">
          <button class="preset-back-btn" onclick="closePage('presetPage')">
            ←
          </button>
          <span class="preset-title"
            ><svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="vertical-align: middle; margin-right: 4px"
            >
              <path d="M12 20h9"></path>
              <path
                d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
              ></path></svg
            >预设管理</span
          >
          <div style="display: flex; gap: 8px">
            <button
              class="preset-header-btn"
              onclick="openPresetImportModal()"
              style="background: linear-gradient(135deg, #81d4fa, #4fc3f7)"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
            </button>
            <button class="preset-header-btn" onclick="openPresetModal()">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
          </div>
        </div>

        <div class="preset-content">
          <div class="preset-tabs">
            <button class="preset-tab active" onclick="switchPresetTab('all')">
              全部
            </button>
            <button class="preset-tab" onclick="switchPresetTab('character')">
              角色
            </button>
            <button class="preset-tab" onclick="switchPresetTab('style')">
              文风
            </button>
            <button class="preset-tab" onclick="switchPresetTab('scene')">
              场景
            </button>
          </div>

          <div class="preset-list" id="presetList">
            <!-- 预设列表将通过JS渲染 -->
          </div>
        </div>

        <!-- 批量操作浮动栏 -->
        <div class="preset-batch-bar" id="presetBatchBar">
          <button class="preset-batch-btn cancel" onclick="cancelPresetBatch()">
            取消
          </button>
          <button
            class="preset-batch-btn delete"
            onclick="deleteSelectedPresets()"
          >
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="vertical-align: middle; margin-right: 2px"
            >
              <polyline points="3 6 5 6 21 6"></polyline>
              <path
                d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
              ></path>
            </svg>
            删除所选
          </button>
        </div>
      </div>

      <!-- 预设编辑弹窗 -->
      <div class="preset-modal" id="stylePresetModal">
        <div class="preset-modal-content">
          <div class="preset-modal-header">
            <span class="preset-modal-title" id="stylePresetModalTitle"
              >创建预设</span
            >
            <button class="preset-modal-close" onclick="closePresetModal()">
              ✕
            </button>
          </div>
          <div class="preset-modal-body">
            <div class="preset-form-group">
              <label class="preset-form-label">预设名称</label>
              <input
                type="text"
                class="preset-form-input"
                id="stylePresetName"
                placeholder="给预设起个名字..."
              />
            </div>

            <div class="preset-form-group">
              <label class="preset-form-label">分类</label>
              <select class="preset-form-input" id="stylePresetCategory">
                <option value="character">角色预设</option>
                <option value="style">文风预设</option>
                <option value="scene">场景预设</option>
              </select>
            </div>

            <div class="preset-form-group">
              <label class="preset-form-label">图标</label>
              <input
                type="text"
                class="preset-form-input"
                id="stylePresetIcon"
                placeholder="输入一个符号，如 ★"
              />
            </div>

            <div class="preset-form-group">
              <label class="preset-form-label"
                >描述
                <span class="preset-form-hint">(简短说明预设用途)</span></label
              >
              <input
                type="text"
                class="preset-form-input"
                id="stylePresetDesc"
                placeholder="例如：温柔大姐姐文风"
              />
            </div>

            <div class="preset-form-group">
              <label class="preset-form-label">
                预设条目
                <span class="preset-form-hint">(可添加多个条目，分别开关)</span>
              </label>
              <div class="preset-entries-list" id="presetEntriesList">
                <!-- 条目会在这里动态生成 -->
              </div>
              <button class="preset-add-entry-btn" onclick="addPresetEntry()">
                + 添加条目
              </button>
            </div>
          </div>
          <div class="preset-modal-footer">
            <button
              class="preset-modal-btn cancel"
              onclick="closePresetModal()"
            >
              取消
            </button>
            <button class="preset-modal-btn save" onclick="savePreset()">
              保存
            </button>
          </div>
        </div>
      </div>

      <!-- 预设导入弹窗 -->
      <div class="preset-import-modal" id="presetImportModal">
        <div class="preset-import-content">
          <div class="preset-import-title">导入预设</div>
          <div class="preset-import-options">
            <div class="preset-import-option" onclick="importPresetFromFile()">
              <div class="preset-import-option-icon">📁</div>
              <div class="preset-import-option-text">
                <div class="preset-import-option-title">从文件导入</div>
                <div class="preset-import-option-desc">
                  支持JSON格式的预设文件
                </div>
              </div>
            </div>
            <div
              class="preset-import-option"
              onclick="importPresetFromClipboard()"
            >
              <div class="preset-import-option-icon">≡</div>
              <div class="preset-import-option-text">
                <div class="preset-import-option-title">从剪贴板导入</div>
                <div class="preset-import-option-desc">
                  粘贴Silly Tavern预设JSON
                </div>
              </div>
            </div>
          </div>
          <button
            class="preset-import-cancel"
            onclick="closePresetImportModal()"
          >
            取消
          </button>
        </div>
      </div>
      <input
        type="file"
        id="presetFileInput"
        accept=".json"
        style="display: none"
        onchange="handlePresetFileImport(event)"
      />

      <div id="worldbookPage" class="page worldbook-page">
        <!-- 世界书头部 -->
        <div class="worldbook-header">
          <div class="worldbook-header-left">
            <button class="back-btn" onclick="closePage('worldbookPage')">
              ←
            </button>
            <div class="worldbook-title">≡ 世界书</div>
          </div>
          <div class="worldbook-header-actions">
            <button
              class="worldbook-header-btn"
              onclick="openWorldbookGroupManager()"
              title="管理分组"
            >
              📁
            </button>
            <button
              class="worldbook-header-btn"
              onclick="toggleWorldbookBatchMode()"
              title="批量操作"
            >
              ☑️
            </button>
            <button
              class="worldbook-header-btn"
              onclick="openWorldbookModal()"
              title="新建世界书"
            >
              +
            </button>
          </div>
        </div>

        <div class="worldbook-content">
          <!-- 分组标签栏 -->
          <div class="worldbook-tabs" id="worldbookTabs">
            <div
              class="worldbook-tab active"
              data-group="all"
              onclick="filterWorldbookByGroup('all')"
            >
              全部 <span class="worldbook-tab-count" id="wbCountAll">0</span>
            </div>
          </div>

          <!-- 批量操作栏 -->
          <div class="worldbook-batch-bar" id="worldbookBatchBar">
            <div class="worldbook-batch-info">
              已选择 <span id="worldbookSelectedCount">0</span> 项
            </div>
            <div class="worldbook-batch-actions">
              <button
                class="worldbook-batch-btn cancel"
                onclick="cancelWorldbookBatch()"
              >
                取消
              </button>
              <button
                class="worldbook-batch-btn move"
                onclick="openWorldbookMoveModal()"
              >
                📁 移动
              </button>
              <button
                class="worldbook-batch-btn delete"
                onclick="deleteSelectedWorldbooks()"
              >
                ✕ 删除
              </button>
            </div>
          </div>

          <!-- 世界书列表 -->
          <div class="worldbook-list" id="worldbookList">
            <!-- 动态渲染 -->
          </div>

          <!-- 空状态 -->
          <div
            class="worldbook-empty"
            id="worldbookEmpty"
            style="display: none"
          >
            <div class="worldbook-empty-icon">
              <svg
                width="48"
                height="48"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path
                  d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"
                ></path>
              </svg>
            </div>
            <div class="worldbook-empty-title">还没有世界书</div>
            <div class="worldbook-empty-text">
              创建世界书，让AI角色拥有更丰富的背景设定
            </div>
            <button class="worldbook-empty-btn" onclick="openWorldbookModal()">
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                style="vertical-align: middle; margin-right: 2px"
              >
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              创建第一本世界书
            </button>
          </div>
        </div>
      </div>

      <!-- 世界书编辑弹窗 -->
      <div
        class="worldbook-modal"
        id="worldbookModal"
        onclick="if(event.target===this)closeWorldbookModal()"
      >
        <div class="worldbook-modal-content">
          <div class="worldbook-modal-header">
            <div class="worldbook-modal-title" id="worldbookModalTitle">
              新建世界书
            </div>
            <button
              class="worldbook-modal-close"
              onclick="closeWorldbookModal()"
            >
              ✕
            </button>
          </div>
          <div class="worldbook-modal-body">
            <div class="worldbook-form-group">
              <label class="worldbook-form-label"
                >世界书名称 <span style="color: #f48fb1">*</span></label
              >
              <input
                type="text"
                class="worldbook-form-input"
                id="worldbookNameInput"
                placeholder="例如：现代都市世界观"
              />
            </div>
            <div class="worldbook-form-group">
              <label class="worldbook-form-label">分组</label>
              <select
                class="worldbook-form-input worldbook-form-select"
                id="worldbookGroupSelect"
              >
                <option value="">未分组</option>
              </select>
            </div>
            <div class="worldbook-form-group">
              <label class="worldbook-form-label"
                >描述 <span class="worldbook-form-hint">(选填)</span></label
              >
              <textarea
                class="worldbook-form-input worldbook-form-textarea"
                id="worldbookDescInput"
                placeholder="简要描述这本世界书的内容..."
              ></textarea>
            </div>
            <div class="worldbook-form-group">
              <label class="worldbook-form-label">条目列表</label>
              <div class="worldbook-entries" id="worldbookEntries">
                <!-- 动态渲染条目 -->
              </div>
              <button
                class="worldbook-add-entry-btn"
                onclick="addWorldbookEntry()"
              >
                + 添加新条目
              </button>
            </div>
          </div>
          <div class="worldbook-modal-footer">
            <button
              class="worldbook-modal-btn cancel"
              onclick="closeWorldbookModal()"
            >
              取消
            </button>
            <button class="worldbook-modal-btn save" onclick="saveWorldbook()">
              保存
            </button>
          </div>
        </div>
      </div>

      <!-- 条目编辑弹窗 -->
      <div
        class="worldbook-modal"
        id="worldbookEntryModal"
        onclick="if(event.target===this)closeWorldbookEntryModal()"
      >
        <div class="worldbook-modal-content">
          <div class="worldbook-modal-header">
            <div class="worldbook-modal-title" id="worldbookEntryModalTitle">
              编辑条目
            </div>
            <button
              class="worldbook-modal-close"
              onclick="closeWorldbookEntryModal()"
            >
              ✕
            </button>
          </div>
          <div class="worldbook-modal-body">
            <div class="worldbook-form-group">
              <label class="worldbook-form-label"
                >备注
                <span class="worldbook-form-hint">(选填，便于管理)</span></label
              >
              <input
                type="text"
                class="worldbook-form-input"
                id="entryCommentInput"
                placeholder="例如：关于主角的童年"
              />
            </div>
            <div class="worldbook-form-group">
              <label class="worldbook-form-label"
                >关键词
                <span class="worldbook-form-hint">(用英文逗号分隔)</span></label
              >
              <input
                type="text"
                class="worldbook-form-input"
                id="entryKeywordsInput"
                placeholder="例如：童年, 小时候, 过去"
              />
            </div>
            <div class="worldbook-form-group">
              <label class="worldbook-form-label"
                >内容 <span style="color: #f48fb1">*</span></label
              >
              <textarea
                class="worldbook-form-input worldbook-form-textarea"
                id="entryContentInput"
                placeholder="当聊天中出现关键词时，这段内容会被注入到AI的记忆中..."
                style="min-height: 150px"
              ></textarea>
            </div>
          </div>
          <div class="worldbook-modal-footer">
            <button
              class="worldbook-modal-btn cancel"
              onclick="closeWorldbookEntryModal()"
            >
              取消
            </button>
            <button
              class="worldbook-modal-btn save"
              onclick="saveWorldbookEntry()"
            >
              保存
            </button>
          </div>
        </div>
      </div>

      <!-- 分组管理弹窗 -->
      <div
        class="worldbook-group-modal"
        id="worldbookGroupModal"
        onclick="if(event.target===this)closeWorldbookGroupManager()"
      >
        <div class="worldbook-group-modal-content">
          <div class="worldbook-group-title">📁 管理分组</div>
          <div class="worldbook-group-list" id="worldbookGroupList">
            <!-- 动态渲染 -->
          </div>
          <div class="worldbook-group-add-row">
            <input
              type="text"
              class="worldbook-group-add-input"
              id="worldbookNewGroupInput"
              placeholder="输入新分组名称..."
            />
            <button
              class="worldbook-group-add-btn"
              onclick="addWorldbookGroup()"
            >
              添加
            </button>
          </div>
          <button
            class="worldbook-group-close"
            onclick="closeWorldbookGroupManager()"
          >
            关闭
          </button>
        </div>
      </div>

      <!-- 移动分组弹窗 -->
      <div
        class="worldbook-move-modal"
        id="worldbookMoveModal"
        onclick="if(event.target===this)closeWorldbookMoveModal()"
      >
        <div class="worldbook-move-modal-content">
          <div class="worldbook-move-title">📁 移动到分组</div>
          <div class="worldbook-move-list" id="worldbookMoveList">
            <!-- 动态渲染 -->
          </div>
          <button
            class="worldbook-move-cancel"
            onclick="closeWorldbookMoveModal()"
          >
            取消
          </button>
        </div>
      </div>

      <div id="forumPage" class="page">
        <div class="page-header">
          <button class="back-btn" onclick="closePage('forumPage')">←</button>
          <h1 class="page-title">论坛</h1>
          <div class="forum-header-right">
            <button class="forum-header-btn" onclick="openForumSettings()">
              ⚙️
            </button>
          </div>
        </div>
        <div class="page-content" id="forumPageContent" style="padding: 0">
          <!-- 由JS动态渲染 -->
        </div>
      </div>

      <div id="coupleSpacePage" class="page">
        <div class="page-header">
          <button class="back-btn" onclick="closePage('coupleSpacePage')">
            ←
          </button>
          <h1 class="page-title">情侣空间</h1>
        </div>
        <div class="page-content">情侣空间功能开发中...</div>
      </div>

      <div id="companionPage" class="page">
        <div class="page-header companion-header">
          <button class="back-btn" onclick="closeCompanionPage()">←</button>
          <h1 class="page-title">陪伴</h1>
          <span style="width: 40px"></span>
        </div>

        <!-- Tab切换 -->
        <div class="companion-tabs">
          <div
            class="companion-tab active"
            onclick="switchCompanionTab('setup')"
            id="companionTabSetup"
          >
            开始陪伴
          </div>
          <div
            class="companion-tab"
            onclick="switchCompanionTab('history')"
            id="companionTabHistory"
          >
            陪伴记录
          </div>
        </div>

        <!-- 未开始陪伴时的设置界面 -->
        <div class="companion-setup" id="companionSetup">
          <!-- 数据统计卡片 -->
          <div class="companion-stats-card" id="companionStatsCard">
            <div class="companion-stat-item">
              <div class="companion-stat-value" id="companionTotalTimes">0</div>
              <div class="companion-stat-label">陪伴次数</div>
            </div>
            <div class="companion-stat-divider"></div>
            <div class="companion-stat-item">
              <div class="companion-stat-value" id="companionTotalHours">0</div>
              <div class="companion-stat-label">总时长(小时)</div>
            </div>
            <div class="companion-stat-divider"></div>
            <div class="companion-stat-item">
              <div class="companion-stat-value" id="companionStreak">0</div>
              <div class="companion-stat-label">连续天数</div>
            </div>
          </div>

          <!-- 选择AI角色 -->
          <div class="companion-section">
            <div class="companion-section-title">👤 选择陪伴角色</div>
            <div class="companion-char-select" id="companionCharSelect">
              <!-- 动态渲染角色列表 -->
            </div>
          </div>

          <!-- 陪伴项目 -->
          <div class="companion-section">
            <div class="companion-section-title">📝 陪伴项目</div>
            <input
              type="text"
              class="companion-input"
              id="companionTaskInput"
              placeholder="输入你想做的事情，例如：学习英语、写论文..."
            />
          </div>

          <!-- 陪伴时长 -->
          <div class="companion-section">
            <div class="companion-section-title">⏱️ 陪伴时长（分钟）</div>
            <input
              type="number"
              class="companion-input"
              id="companionDurationInput"
              placeholder="输入时长"
              value="45"
              min="1"
              max="480"
            />
          </div>

          <!-- 鼓励频率 -->
          <div class="companion-section">
            <div class="companion-section-title">💬 鼓励频率</div>
            <div class="companion-freq-select">
              <span class="companion-freq-tag" onclick="setEncourageFreq(3)"
                >频繁(3分钟)</span
              >
              <span
                class="companion-freq-tag active"
                onclick="setEncourageFreq(5)"
                >适中(5分钟)</span
              >
              <span class="companion-freq-tag" onclick="setEncourageFreq(10)"
                >偶尔(10分钟)</span
              >
              <span class="companion-freq-tag" onclick="setEncourageFreq(0)"
                >安静陪伴</span
              >
            </div>
          </div>

          <!-- 语音鼓励 -->
          <div class="companion-section">
            <div
              style="
                display: flex;
                align-items: center;
                justify-content: space-between;
              "
            >
              <div>
                <div class="companion-section-title" style="margin-bottom: 4px">
                  🔊 语音鼓励
                </div>
                <div style="font-size: 0.75rem; color: #999">
                  开启后AI会用语音给你加油
                </div>
              </div>
              <div
                id="companionVoiceToggle"
                onclick="toggleCompanionVoice()"
                style="
                  width: 50px;
                  height: 28px;
                  border-radius: 14px;
                  background: #e0e0e0;
                  position: relative;
                  cursor: pointer;
                  transition: all 0.3s;
                "
              >
                <div
                  style="
                    width: 24px;
                    height: 24px;
                    border-radius: 50%;
                    background: #fff;
                    position: absolute;
                    top: 2px;
                    left: 2px;
                    transition: all 0.3s;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                  "
                ></div>
              </div>
            </div>
          </div>

          <!-- 背景设置 -->
          <div class="companion-section">
            <div class="companion-section-title">🖼️ 陪伴背景</div>
            <div class="companion-bg-list" id="companionBgList">
              <!-- 已添加的背景预览 -->
            </div>
            <div
              class="companion-bg-add"
              onclick="document.getElementById('companionBgInput').click()"
            >
              <span>+</span>
              <span>添加图片/视频</span>
            </div>
            <input
              type="file"
              id="companionBgInput"
              accept="image/*,video/*"
              multiple
              style="display: none"
              onchange="handleCompanionBgSelect(event)"
            />
            <div style="font-size: 0.75rem; color: #999; margin-top: 8px">
              支持多张图片轮播（每10秒切换）或单个视频
            </div>

            <!-- 轮播间隔设置 -->
            <div
              id="companionBgIntervalSetting"
              style="display: none; margin-top: 12px"
            >
              <div style="font-size: 0.85rem; color: #666; margin-bottom: 6px">
                轮播间隔（秒）
              </div>
              <input
                type="number"
                class="companion-input"
                id="companionBgInterval"
                value="10"
                min="3"
                max="60"
                style="width: 100px"
              />
            </div>
          </div>

          <!-- 开始按钮 -->
          <button class="companion-start-btn" onclick="startCompanion()">
            开始陪伴 ✨
          </button>
        </div>

        <!-- 陪伴记录页面 -->
        <div
          class="companion-history"
          id="companionHistory"
          style="display: none"
        >
          <!-- 月度日历 -->
          <div class="companion-calendar-section">
            <div class="companion-calendar-header">
              <button
                class="companion-calendar-nav"
                onclick="changeCompanionMonth(-1)"
              >
                ‹
              </button>
              <span id="companionCalendarTitle">2025年1月</span>
              <button
                class="companion-calendar-nav"
                onclick="changeCompanionMonth(1)"
              >
                ›
              </button>
            </div>
            <div class="companion-calendar-weekdays">
              <span>日</span><span>一</span><span>二</span><span>三</span
              ><span>四</span><span>五</span><span>六</span>
            </div>
            <div class="companion-calendar-days" id="companionCalendarDays">
              <!-- 动态渲染日期 -->
            </div>
          </div>

          <!-- 记录列表 -->
          <div class="companion-history-list" id="companionHistoryList">
            <!-- 动态渲染记录 -->
          </div>

          <!-- 空状态 -->
          <div
            class="companion-history-empty"
            id="companionHistoryEmpty"
            style="display: none"
          >
            <div class="empty-icon">📝</div>
            <div class="empty-text">还没有陪伴记录</div>
            <div class="empty-hint">开始你的第一次陪伴吧！</div>
          </div>
        </div>

        <!-- 陪伴进行中界面（全屏沉浸式） -->
        <div
          class="companion-active"
          id="companionActive"
          style="display: none"
        >
          <!-- 全屏背景（支持轮播） -->
          <div class="companion-fullscreen-bg" id="companionFullscreenBg">
            <div class="companion-bg-slide active" id="companionBgSlide1"></div>
            <div class="companion-bg-slide" id="companionBgSlide2"></div>
            <video
              id="companionBgVideo"
              style="display: none"
              muted
              loop
              autoplay
              playsinline
            ></video>
            <div class="companion-bg-overlay"></div>
          </div>

          <!-- AI角色显示 -->
          <div class="companion-char-display">
            <div class="companion-char-avatar" id="companionCharAvatar">😊</div>
            <div class="companion-char-name" id="companionCharName">AI</div>
          </div>

          <!-- 翻页计时器 -->
          <div class="companion-timer-section">
            <div class="flip-clock" id="flipClock">
              <div class="flip-unit">
                <div class="flip-card" id="flipMin1">
                  <div class="flip-card-inner">
                    <div class="flip-card-front">0</div>
                    <div class="flip-card-back">0</div>
                  </div>
                </div>
              </div>
              <div class="flip-unit">
                <div class="flip-card" id="flipMin2">
                  <div class="flip-card-inner">
                    <div class="flip-card-front">0</div>
                    <div class="flip-card-back">0</div>
                  </div>
                </div>
              </div>
              <div class="flip-colon">:</div>
              <div class="flip-unit">
                <div class="flip-card" id="flipSec1">
                  <div class="flip-card-inner">
                    <div class="flip-card-front">0</div>
                    <div class="flip-card-back">0</div>
                  </div>
                </div>
              </div>
              <div class="flip-unit">
                <div class="flip-card" id="flipSec2">
                  <div class="flip-card-inner">
                    <div class="flip-card-front">0</div>
                    <div class="flip-card-back">0</div>
                  </div>
                </div>
              </div>
            </div>
            <div class="companion-task-name" id="companionTaskName">
              学习中...
            </div>
            <div class="companion-progress-bar">
              <div
                class="companion-progress-fill"
                id="companionProgressFill"
              ></div>
            </div>
          </div>

          <!-- AI鼓励消息 -->
          <div class="companion-message-area" id="companionMessageArea">
            <div class="companion-message" id="companionMessage">
              加油！我会一直陪着你~
            </div>
          </div>

          <!-- 底部操作 -->
          <div class="companion-actions">
            <button
              class="companion-action-btn chat"
              onclick="openCompanionChat()"
            >
              💬 聊聊天
            </button>
            <button
              class="companion-action-btn pause"
              id="companionPauseBtn"
              onclick="toggleCompanionPause()"
            >
              ⏸️ 暂停
            </button>
            <button
              class="companion-action-btn complete"
              onclick="completeCompanion()"
            >
              ✅ 完成
            </button>
            <button class="companion-action-btn quit" onclick="quitCompanion()">
              ❌ 放弃
            </button>
          </div>
        </div>

        <!-- 聊天弹窗 -->
        <div class="companion-chat-modal" id="companionChatModal">
          <div class="companion-chat-container">
            <div class="companion-chat-header">
              <span>和 <span id="companionChatCharName">AI</span> 聊聊</span>
              <button onclick="closeCompanionChat()">✕</button>
            </div>
            <div class="companion-chat-messages" id="companionChatMessages">
              <!-- 聊天消息 -->
            </div>
            <div class="companion-chat-input-area">
              <input
                type="text"
                id="companionChatInput"
                placeholder="累了就和我说说话吧~"
                onkeypress="if(event.key==='Enter')sendCompanionChat()"
              />
              <button onclick="sendCompanionChat()">发送</button>
            </div>
          </div>
        </div>
      </div>

      <div id="apiPage" class="page api-settings-page">
        <div class="page-header">
          <button class="back-btn" onclick="closePage('apiPage')">←</button>
          <h1 class="page-title">API设置</h1>
          <button class="page-header-add" onclick="openApiPresetModal()">
            +
          </button>
        </div>

        <div class="api-settings-content">
          <!-- API Presets List -->
          <div class="api-section">
            <div class="api-section-title">API 预设管理</div>
            <div class="api-preset-list" id="apiPresetList">
              <!-- Presets will be rendered here -->
              <div class="empty-state" id="emptyPresets">
                <div class="empty-icon">
                  <svg
                    width="48"
                    height="48"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                    <line x1="12" y1="2" x2="12" y2="12"></line>
                  </svg>
                </div>
                <div class="empty-text">还没有API预设</div>
                <div class="empty-hint">点击右上角 + 创建预设</div>
              </div>
            </div>
          </div>

          <!-- Current Active Config -->
          <div
            class="api-section"
            id="activeConfigSection"
            style="display: none"
          >
            <div class="api-section-title">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                style="vertical-align: middle; margin-right: 4px"
              >
                <polyline points="20 6 9 17 4 12"></polyline></svg
              >当前使用
            </div>
            <div class="active-config-card">
              <div class="active-config-row">
                <span class="active-label">预设名称</span>
                <span class="active-value" id="activePresetName">-</span>
              </div>
              <div class="active-config-row">
                <span class="active-label">模型</span>
                <span class="active-value" id="activeModelName">-</span>
              </div>
              <div class="active-config-row">
                <span class="active-label">状态</span>
                <span class="active-status">已连接</span>
              </div>
            </div>
          </div>
          <div class="api-section">
            <div class="api-section-title">🎙️ 语音设置 (MiniMax)</div>
            <div
              class="active-config-card"
              style="background: #fff; padding: 16px"
            >
              <div class="form-group">
                <label class="form-label">Group ID</label>
                <input
                  type="text"
                  class="form-input"
                  id="voiceGroupId"
                  placeholder="填写 MiniMax Group ID"
                />
              </div>

              <div class="form-group">
                <label class="form-label">API Key</label>
                <input
                  type="password"
                  class="form-input"
                  id="voiceApiKey"
                  placeholder="填写 MiniMax API Key"
                />
              </div>
              <div class="form-group">
                <label class="form-label">API 线路</label>
                <div class="radio-group">
                  <div
                    class="radio-option active"
                    onclick="switchVoiceUrl('cn')"
                    id="voiceUrlCN"
                  >
                    国内版
                  </div>
                  <div
                    class="radio-option"
                    onclick="switchVoiceUrl('intl')"
                    id="voiceUrlIntl"
                  >
                    海外版
                  </div>
                </div>
                <div class="form-hint" style="margin-top: 6px">
                  国内版: api.minimax.chat | 海外版: api.minimaxi.com
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">语音模型</label>
                <div class="form-select-wrapper">
                  <select class="form-select" id="voiceModelSelect">
                    <option value="speech-2.6-hd">
                      speech-2.6-hd (最新·超清)
                    </option>
                    <option value="speech-2.6-turbo">
                      speech-2.6-turbo (最新·极速)
                    </option>

                    <option disabled>──────────</option>

                    <option value="speech-02-hd">speech-02-hd (高清)</option>
                    <option value="speech-02-turbo">
                      speech-02-turbo (快速)
                    </option>
                    <option value="speech-01-turbo">
                      speech-01-turbo (老旧)
                    </option>
                    <option value="speech-01-hd">speech-01-hd (老旧)</option>
                  </select>
                </div>
              </div>

              <button
                class="action-btn"
                onclick="saveVoiceConfig()"
                style="width: 100%; margin-top: 10px"
              >
                💾 保存语音配置
              </button>
            </div>
          </div>
          <!-- Tips -->
          <div class="api-tips">
            <div class="api-tips-title">💡 提示</div>
            <div class="api-tips-content">
              支持 OpenAI 兼容格式的 API。填写反代地址时无需添加 /v1 后缀。
            </div>
          </div>
        </div>
      </div>

      <!-- API Preset Modal -->
      <div class="api-modal" id="apiPresetModal">
        <div class="api-modal-content">
          <div class="api-modal-header">
            <h2 class="api-modal-title" id="apiModalTitle">创建 API 预设</h2>
            <button class="api-modal-close" onclick="closeApiPresetModal()">
              ✕
            </button>
          </div>
          <div class="api-modal-body">
            <div class="api-field">
              <label class="api-field-label">预设名称</label>
              <input
                type="text"
                class="api-field-input"
                id="presetNameInput"
                placeholder="例如: OpenAI, Claude, 自用API"
              />
            </div>

            <div class="api-field">
              <label class="api-field-label">反代地址</label>
              <input
                type="text"
                class="api-field-input"
                id="presetUrlInput"
                placeholder="https://api.example.com"
              />
            </div>

            <div class="api-field">
              <label class="api-field-label">API Key</label>
              <div class="api-field-key">
                <input
                  type="password"
                  class="api-field-input"
                  id="presetKeyInput"
                  placeholder="sk-xxxxxxxxxxxxxxxx"
                />
                <button
                  class="key-toggle-btn"
                  onclick="togglePresetKeyVisibility()"
                >
                  ○
                </button>
              </div>
            </div>

            <div class="api-field">
              <label class="api-field-label">模型</label>
              <div class="model-select-row">
                <input
                  type="text"
                  class="api-field-input model-input"
                  id="presetModelInput"
                  placeholder="输入或拉取模型名称"
                />
                <button class="model-fetch-btn" onclick="fetchPresetModels()">
                  拉取
                </button>
              </div>
              <div class="model-hint">
                可直接输入模型名称，如 gpt-4o、claude-3-5-sonnet 等
              </div>

              <div class="model-dropdown" id="modelDropdown"></div>
            </div>

            <div
              class="api-field"
              style="
                margin-top: 20px;
                padding-top: 20px;
                border-top: 1px dashed #eee;
              "
            >
              <label class="api-field-label">参数微调 (Advanced)</label>

              <div class="slider-row">
                <div style="width: 70px; font-size: 0.85rem; color: #666">
                  温度<br /><span style="font-size: 0.7rem; color: #999"
                    >(随机性)</span
                  >
                </div>
                <input
                  type="range"
                  id="presetTempInput"
                  min="0"
                  max="2"
                  step="0.1"
                  value="1.0"
                  oninput="document.getElementById('valTemp').textContent = this.value"
                />
                <span class="slider-value" id="valTemp">1.0</span>
              </div>

              <div class="slider-row">
                <div style="width: 70px; font-size: 0.85rem; color: #666">
                  频率惩罚<br /><span style="font-size: 0.7rem; color: #999"
                    >(去重)</span
                  >
                </div>
                <input
                  type="range"
                  id="presetFreqInput"
                  min="-2"
                  max="2"
                  step="0.1"
                  value="0"
                  oninput="document.getElementById('valFreq').textContent = this.value"
                />
                <span class="slider-value" id="valFreq">0.0</span>
              </div>

              <div class="slider-row">
                <div style="width: 70px; font-size: 0.85rem; color: #666">
                  存在惩罚<br /><span style="font-size: 0.7rem; color: #999"
                    >(创新)</span
                  >
                </div>
                <input
                  type="range"
                  id="presetPresInput"
                  min="-2"
                  max="2"
                  step="0.1"
                  value="0"
                  oninput="document.getElementById('valPres').textContent = this.value"
                />
                <span class="slider-value" id="valPres">0.0</span>
              </div>
            </div>
          </div>

          <div class="api-modal-footer">
            <button
              class="api-modal-btn btn-delete"
              id="presetDeleteBtn"
              onclick="deleteApiPreset()"
              style="display: none"
            >
              删除
            </button>
            <div class="api-modal-btn-group">
              <button
                class="api-modal-btn btn-cancel"
                onclick="closeApiPresetModal()"
              >
                取消
              </button>
              <button class="api-modal-btn btn-save" onclick="saveApiPreset()">
                保存
              </button>
            </div>
          </div>
        </div>
      </div>

      <div
        id="fontPage"
        class="page chat-settings-page"
        style="background: #f5f5f5"
      >
        <div
          class="page-header"
          style="background: white; border-bottom: 1px solid #eee"
        >
          <button class="back-btn" onclick="closePage('fontPage')">←</button>
          <h1 class="page-title">字体设置</h1>
        </div>

        <div class="settings-content">
          <div class="settings-section">
            <div class="section-header">
              <div class="section-icon purple">🔤</div>
              <span class="section-title">添加新字体</span>
            </div>
            <div class="section-body">
              <div class="form-group">
                <div class="radio-group">
                  <div
                    class="radio-option active"
                    onclick="switchFontSource('url')"
                    id="tabFontUrl"
                  >
                    网络链接
                  </div>
                  <div
                    class="radio-option"
                    onclick="switchFontSource('file')"
                    id="tabFontFile"
                  >
                    本地上传
                  </div>
                </div>
              </div>

              <div id="fontSourceUrl" class="form-group">
                <label class="form-label">字体 URL (.woff2, .ttf)</label>
                <input
                  type="text"
                  class="form-input"
                  id="fontUrlInput"
                  placeholder="https://example.com/font.woff2"
                />
              </div>

              <div id="fontSourceFile" class="form-group" style="display: none">
                <label class="form-label">上传字体文件</label>
                <div
                  class="bg-upload-btn"
                  onclick="document.getElementById('fontFileInput').click()"
                >
                  📂 点击选择字体文件
                </div>
                <input
                  type="file"
                  id="fontFileInput"
                  class="hidden-input"
                  accept=".ttf,.otf,.woff,.woff2"
                  onchange="handleFontFileUpload(this)"
                />
                <div
                  class="form-hint"
                  id="fontFileName"
                  style="margin-top: 8px"
                >
                  未选择文件
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">预设名称</label>
                <input
                  type="text"
                  class="form-input"
                  id="fontNameInput"
                  placeholder="例如: 少女体, 像素风..."
                />
              </div>

              <div class="form-group">
                <label class="form-label">效果预览</label>
                <div
                  id="fontPreviewBox"
                  style="
                    padding: 16px;
                    background: white;
                    border: 1px solid #e5ddd3;
                    border-radius: 12px;
                    font-size: 16px;
                    line-height: 1.6;
                    color: #5d4e37;
                    transition: all 0.3s;
                  "
                >
                  The quick brown fox jumps over the lazy dog.<br />
                  这是一段中文测试文本，用于预览字体效果。<br />
                  1234567890 !@#$%^&*()
                </div>
              </div>

              <div class="action-buttons-grid">
                <button class="action-btn" onclick="previewCustomFont()">
                  ○ 预览
                </button>
                <button
                  class="action-btn"
                  style="
                    background: linear-gradient(135deg, #a18cd1, #fbc2eb);
                    color: white;
                    border: none;
                  "
                  onclick="saveFontPreset()"
                >
                  💾 保存并应用
                </button>
              </div>
            </div>
          </div>

          <div class="settings-section">
            <div class="section-header">
              <div class="section-icon orange">📚</div>
              <span class="section-title">我的字体库</span>
            </div>
            <div class="section-body">
              <div class="api-preset-list" id="fontPresetList">
                <div class="api-preset-item active" onclick="applySystemFont()">
                  <div class="preset-radio" id="radio-system"></div>
                  <div class="preset-info">
                    <div class="preset-name">系统默认</div>
                    <div class="preset-detail">System Default</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="appearancePage" class="page">
        <div class="page-header">
          <button class="back-btn" onclick="closePage('appearancePage')">
            ←
          </button>
          <h1 class="page-title">外观设置</h1>
        </div>
        <div
          class="page-content"
          style="
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
          "
        >
          <!-- 壁纸设置 -->
          <div class="appearance-section">
            <h3>▣ 主屏幕壁纸</h3>
            <div
              class="wallpaper-preview"
              id="wallpaperPreview"
              onclick="document.getElementById('wallpaperInput').click()"
            >
              <div class="wallpaper-placeholder">点击更换壁纸</div>
            </div>
            <input
              type="file"
              id="wallpaperInput"
              accept="image/*"
              style="display: none"
              onchange="previewWallpaper(this)"
            />
            <button class="appearance-btn secondary" onclick="resetWallpaper()">
              恢复默认
            </button>
          </div>

          <!-- 字体颜色设置 -->
          <div class="appearance-section">
            <h3>🎨 字体颜色</h3>
            <div class="color-options">
              <div
                class="color-option"
                style="background: #37474f"
                onclick="setFontColor('#37474f')"
                data-color="#37474f"
              ></div>
              <div
                class="color-option"
                style="background: #ffffff; border: 1px solid #ddd"
                onclick="setFontColor('#ffffff')"
                data-color="#ffffff"
              ></div>
              <div
                class="color-option"
                style="background: #f48fb1"
                onclick="setFontColor('#f48fb1')"
                data-color="#f48fb1"
              ></div>
              <div
                class="color-option"
                style="background: #90caf9"
                onclick="setFontColor('#90caf9')"
                data-color="#90caf9"
              ></div>
              <div
                class="color-option"
                style="background: #a5d6a7"
                onclick="setFontColor('#a5d6a7')"
                data-color="#a5d6a7"
              ></div>
              <div
                class="color-option"
                style="background: #ffcc80"
                onclick="setFontColor('#ffcc80')"
                data-color="#ffcc80"
              ></div>
              <div
                class="color-option custom-color"
                id="customColorOption"
                onclick="openCustomColorPicker()"
              >
                <span>+</span>
              </div>
            </div>
            <input
              type="color"
              id="customColorInput"
              style="position: absolute; width: 1px; height: 1px; opacity: 0"
              onchange="applyCustomFontColor(this.value)"
            />
          </div>

          <!-- APP图标和名称设置 -->
          <div class="appearance-section">
            <h3>□ APP自定义</h3>
            <div class="app-customize-list">
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_chat"
                  onclick="document.getElementById('iconInput_chat').click()"
                >
                  聊天
                </div>
                <input
                  type="file"
                  id="iconInput_chat"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('chat', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_chat"
                  value="聊天"
                  placeholder="APP名称"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_worldbook"
                  onclick="document.getElementById('iconInput_worldbook').click()"
                >
                  世界书
                </div>
                <input
                  type="file"
                  id="iconInput_worldbook"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('worldbook', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_worldbook"
                  value="世界书"
                  placeholder="APP名称"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_preset"
                  onclick="document.getElementById('iconInput_preset').click()"
                >
                  预设
                </div>
                <input
                  type="file"
                  id="iconInput_preset"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('preset', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_preset"
                  value="预设"
                  placeholder="APP名称"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_forum"
                  onclick="document.getElementById('iconInput_forum').click()"
                >
                  论坛
                </div>
                <input
                  type="file"
                  id="iconInput_forum"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('forum', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_forum"
                  value="论坛"
                  placeholder="APP名称"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_api"
                  onclick="document.getElementById('iconInput_api').click()"
                >
                  API
                </div>
                <input
                  type="file"
                  id="iconInput_api"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('api', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_api"
                  value="API设置"
                  placeholder="APP名称"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_font"
                  onclick="document.getElementById('iconInput_font').click()"
                >
                  字体
                </div>
                <input
                  type="file"
                  id="iconInput_font"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('font', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_font"
                  value="字体"
                  placeholder="APP名称"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_appearance"
                  onclick="document.getElementById('iconInput_appearance').click()"
                >
                  外观
                </div>
                <input
                  type="file"
                  id="iconInput_appearance"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('appearance', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_appearance"
                  value="外观设置"
                  placeholder="APP名称"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_couple"
                  onclick="document.getElementById('iconInput_couple').click()"
                >
                  情侣
                </div>
                <input
                  type="file"
                  id="iconInput_couple"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('couple', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_couple"
                  value="情侣空间"
                  placeholder="APP名称"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_companion"
                  onclick="document.getElementById('iconInput_companion').click()"
                >
                  陪伴
                </div>
                <input
                  type="file"
                  id="iconInput_companion"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('companion', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_companion"
                  value="陪伴"
                  placeholder="APP名称"
                />
              </div>
            </div>
          </div>

          <!-- 保存按钮 -->
          <button
            class="appearance-save-btn"
            onclick="saveAppearanceSettings()"
          >
            ★ 保存设置
          </button>
        </div>
      </div>

      <!-- Bottom Dock -->
      <div class="dock">
        <div class="dock-item" onclick="openPage('apiPage')">
          <div class="dock-icon dock-blue">API设置</div>
          <span class="dock-label">API设置</span>
        </div>
        <div class="dock-item" onclick="openPage('fontPage')">
          <div class="dock-icon dock-purple">字体</div>
          <span class="dock-label">字体</span>
        </div>
        <div class="dock-item" onclick="openPage('appearancePage')">
          <div class="dock-icon dock-orange">外观设置</div>
          <span class="dock-label">外观设置</span>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div class="edit-modal" id="editModal">
      <div class="edit-modal-content">
        <div class="edit-modal-title" id="editModalTitle">编辑</div>
        <input
          type="text"
          class="edit-input"
          id="editInput"
          placeholder="请输入..."
        />
        <div class="edit-buttons">
          <button class="edit-btn edit-btn-cancel" onclick="closeEditModal()">
            取消
          </button>
          <button class="edit-btn edit-btn-save" onclick="saveEdit()">
            保存
          </button>
        </div>
      </div>
    </div>

    <!-- 名片标签编辑弹窗 -->
    <div class="edit-modal" id="tagEditModal">
      <div class="edit-modal-content">
        <div class="edit-modal-title" id="tagEditTitle">编辑标签</div>
        <input
          type="text"
          class="edit-input"
          id="tagEditInput"
          placeholder="请输入..."
          maxlength="10"
        />
        <div class="edit-buttons">
          <button
            class="edit-btn edit-btn-cancel"
            onclick="closeTagEditModal()"
          >
            取消
          </button>
          <button class="edit-btn edit-btn-save" onclick="saveTagEdit()">
            保存
          </button>
        </div>
      </div>
    </div>

    <!-- 恋爱纪念编辑弹窗 -->
    <div class="edit-modal" id="loveEditModal">
      <div class="edit-modal-content">
        <div class="edit-modal-title" id="loveEditTitle">编辑</div>
        <input
          type="text"
          class="edit-input"
          id="loveEditInput"
          placeholder="请输入..."
        />
        <div class="edit-buttons">
          <button
            class="edit-btn edit-btn-cancel"
            onclick="closeLoveEditModal()"
          >
            取消
          </button>
          <button class="edit-btn edit-btn-save" onclick="saveLoveEdit()">
            保存
          </button>
        </div>
      </div>
    </div>

    <!-- 恋爱小组件选项弹窗 -->
    <div class="edit-modal" id="loveWidgetOptionsModal">
      <div class="edit-modal-content" style="padding: 16px">
        <div class="edit-modal-title">小组件设置</div>
        <div class="love-widget-options">
          <div class="love-widget-option" onclick="triggerLoveWidgetBgUpload()">
            <span class="love-widget-option-icon">🖼️</span>
            <span>更换背景图</span>
          </div>
          <div
            class="love-widget-option"
            onclick="setLoveWidgetTextColor('dark')"
          >
            <span class="love-widget-option-icon">⬛</span>
            <span>字体改黑色</span>
          </div>
          <div
            class="love-widget-option"
            onclick="setLoveWidgetTextColor('light')"
          >
            <span class="love-widget-option-icon">⬜</span>
            <span>字体改白色</span>
          </div>
        </div>
        <button
          class="edit-btn edit-btn-cancel"
          style="width: 100%; margin-top: 12px"
          onclick="closeLoveWidgetOptionsModal()"
        >
          取消
        </button>
      </div>
    </div>

    <!-- 分组管理弹窗 -->
    <div
      class="edit-modal"
      id="groupManagerModal"
      style="z-index: var(--z-toast)"
    >
      <div class="edit-modal-content" style="max-width: 320px">
        <div class="edit-modal-title">管理分组</div>
        <div class="group-list" id="groupList">
          <!-- 动态渲染分组列表 -->
        </div>
        <div class="group-add-row">
          <input
            type="text"
            class="edit-input"
            id="newGroupInput"
            placeholder="输入新分组名称..."
            style="flex: 1; margin-bottom: 0"
          />
          <button
            class="edit-btn edit-btn-save"
            onclick="addNewGroup()"
            style="margin-left: 8px; width: 60px"
          >
            添加
          </button>
        </div>
        <div class="edit-buttons" style="margin-top: 16px">
          <button
            class="edit-btn edit-btn-cancel"
            onclick="closeGroupManager()"
          >
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- Create Character Modal -->
    <div class="edit-modal" id="createCharModal">
      <div class="create-char-content">
        <div class="create-char-title">创建新角色</div>

        <!-- Avatar upload -->
        <div
          class="create-avatar-section"
          onclick="document.getElementById('charAvatarInput').click()"
        >
          <div class="create-avatar">
            <span class="create-avatar-placeholder" id="charAvatarPlaceholder"
              ><svg
                width="32"
                height="32"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline></svg
            ></span>
            <img id="charAvatarPreview" src="" alt="" style="display: none" />
          </div>
          <span class="create-avatar-hint">点击上传头像</span>
        </div>
        <input
          type="file"
          id="charAvatarInput"
          class="hidden-input"
          accept="image/*"
          onchange="previewCharAvatar(this)"
        />

        <!-- Name input -->
        <div class="create-input-group">
          <label class="create-label"
            >角色名称 <span class="required">*</span></label
          >
          <input
            type="text"
            class="create-input"
            id="charNameInput"
            placeholder="请输入角色名称"
          />
        </div>

        <!-- Note input -->
        <div class="create-input-group">
          <label class="create-label"
            >备注 <span class="optional">(选填)</span></label
          >
          <input
            type="text"
            class="create-input"
            id="charNoteInput"
            placeholder="添加备注信息"
          />
        </div>

        <!-- Buttons -->
        <div class="create-buttons">
          <button
            class="create-btn create-btn-cancel"
            onclick="closeCreateCharModal()"
          >
            取消
          </button>
          <button
            class="create-btn create-btn-confirm"
            onclick="createCharacter()"
          >
            创建
          </button>
        </div>
      </div>
    </div>

    <!-- Create Group Chat Modal -->
    <div
      class="create-group-modal"
      id="createGroupModal"
      onclick="if(event.target===this)closeCreateGroupModal()"
    >
      <div class="create-group-content">
        <div class="create-group-header">
          <span class="create-group-title">创建群聊</span>
          <button class="create-group-close" onclick="closeCreateGroupModal()">
            ✕
          </button>
        </div>
        <div class="create-group-body">
          <!-- 群聊头像 -->
          <div class="create-group-avatar-section">
            <div
              class="create-group-avatar"
              id="groupAvatarPreview"
              onclick="document.getElementById('groupAvatarInput').click()"
            >
              <span id="groupAvatarPlaceholder">👥</span>
              <img id="groupAvatarImg" src="" style="display: none" />
            </div>
            <div class="create-group-avatar-hint">点击上传群头像（可选）</div>
            <input
              type="file"
              id="groupAvatarInput"
              accept="image/*"
              style="display: none"
              onchange="previewGroupAvatar(this)"
            />
          </div>

          <!-- 群聊名称 -->
          <div class="create-group-input-section">
            <label class="create-group-label"
              >群聊名称 <span style="color: #f48fb1">*</span></label
            >
            <input
              type="text"
              class="create-group-input"
              id="groupNameInput"
              placeholder="输入群聊名称..."
              oninput="checkGroupCreateValid()"
            />
          </div>

          <!-- 选择成员 -->
          <div class="create-group-members-title">
            <span>选择群成员</span>
            <span class="create-group-members-count" id="selectedMembersCount"
              >已选 0 人</span
            >
          </div>
          <div class="create-group-members-list" id="groupMembersList">
            <!-- 角色列表会动态渲染 -->
          </div>
        </div>
        <div class="create-group-footer">
          <button
            class="create-group-btn cancel"
            onclick="closeCreateGroupModal()"
          >
            取消
          </button>
          <button
            class="create-group-btn confirm"
            id="createGroupConfirmBtn"
            onclick="createGroupChat()"
            disabled
          >
            创建群聊
          </button>
        </div>
      </div>
    </div>

    <!-- Group Settings Modal (添加群成员) -->
    <div
      class="create-group-modal"
      id="addGroupMemberModal"
      onclick="if(event.target===this)closeAddGroupMemberModal()"
    >
      <div class="create-group-content">
        <div class="create-group-header">
          <span class="create-group-title">添加群成员</span>
          <button
            class="create-group-close"
            onclick="closeAddGroupMemberModal()"
          >
            ✕
          </button>
        </div>
        <div class="create-group-body">
          <div class="create-group-members-title">
            <span>选择要添加的成员</span>
            <span class="create-group-members-count" id="addMembersCount"
              >已选 0 人</span
            >
          </div>
          <div class="create-group-members-list" id="addMembersList">
            <!-- 可添加的角色列表 -->
          </div>
        </div>
        <div class="create-group-footer">
          <button
            class="create-group-btn cancel"
            onclick="closeAddGroupMemberModal()"
          >
            取消
          </button>
          <button
            class="create-group-btn confirm"
            id="addMemberConfirmBtn"
            onclick="confirmAddGroupMembers()"
            disabled
          >
            添加
          </button>
        </div>
      </div>
    </div>

    <!-- 群聊专用设置页面 -->
    <!-- 群成员管理弹窗 -->
    <div
      class="create-group-modal"
      id="groupMemberManagerModal"
      onclick="if(event.target===this)closeGroupMemberManager()"
    >
      <div class="create-group-content">
        <div class="create-group-header">
          <span class="create-group-title">管理群成员</span>
          <button
            class="create-group-close"
            onclick="closeGroupMemberManager()"
          >
            ✕
          </button>
        </div>
        <div class="create-group-body">
          <div class="create-group-members-title">
            <span>群成员列表</span>
            <span class="create-group-members-count" id="manageMembersCount"
              >共 0 人</span
            >
          </div>
          <div class="create-group-members-list" id="manageMembersList">
            <!-- 群成员列表会动态渲染 -->
          </div>
          <div
            style="
              margin-top: 16px;
              padding-top: 16px;
              border-top: 1px dashed rgba(0, 0, 0, 0.1);
            "
          >
            <button
              class="create-group-btn confirm"
              onclick="closeGroupMemberManager();setTimeout(openAddGroupMemberModal, 300);"
              style="width: 100%"
            >
              ➕ 添加新成员
            </button>
          </div>
        </div>
        <div class="create-group-footer">
          <button
            class="create-group-btn cancel"
            onclick="closeGroupMemberManager()"
            style="width: 100%"
          >
            完成
          </button>
        </div>
      </div>
    </div>

    <!-- 群聊专用设置页面 -->
    <div class="chat-settings-page" id="groupChatSettingsPage">
      <div class="settings-header">
        <button class="settings-back-btn" onclick="closeGroupChatSettings()">
          ‹
        </button>
        <div class="settings-header-title">群聊设置</div>
        <button
          class="settings-save-btn"
          onclick="saveGroupChatSettingsAndClose()"
        >
          保存
        </button>
      </div>
      <div class="settings-content" id="groupSettingsContent">
        <!-- 动态生成内容 -->
      </div>
    </div>

    <div class="chat-conversation-page" id="chatConversationPage">
      <div class="conv-header">
        <button class="conv-back-btn" onclick="closeConversation()">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <div class="conv-title-section">
          <div class="conv-avatar" id="convAvatar">AI</div>
          <span class="conv-name" id="convName">角色名称</span>
        </div>
        <div class="conv-header-btns">
          <button
            class="conv-heart-btn"
            id="heartVoiceBtn"
            onclick="showHeartVoice()"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
              ></path>
            </svg>
          </button>
          <button class="conv-menu-btn" onclick="openChatSettings()">
            <svg
              width="22"
              height="22"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="12" cy="12" r="3"></circle>
              <path
                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
              ></path>
            </svg>
          </button>
        </div>
      </div>

      <div class="conv-menu" id="convMenu">
        <div class="conv-menu-item" onclick="clearChatHistory()">
          ✕ 清空聊天记录
        </div>
        <div class="conv-menu-item" onclick="deleteCharacter()">
          ✕ 删除此角色
        </div>
      </div>

      <!-- 群公告栏 - 仅群聊显示 -->
      <div
        class="group-announcement-bar"
        id="groupAnnouncementBar"
        style="display: none"
        onclick="openGroupAnnouncementModal()"
      >
        <span class="group-announcement-icon">📢</span>
        <span class="group-announcement-text" id="groupAnnouncementText"
          >点击设置群公告</span
        >
        <span class="group-announcement-arrow">›</span>
      </div>

      <div class="conv-messages" id="convMessages" onclick="closeChatPanel()">
        <div class="conv-empty">
          <div class="conv-empty-icon">
            <svg
              width="48"
              height="48"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
              ></path>
            </svg>
          </div>
          <div class="conv-empty-text">开始和TA聊天吧～</div>
        </div>
      </div>

      <div class="conv-input-area" id="inputArea">
        <!-- 引用预览区域 -->
        <div class="quote-preview" id="quotePreview" style="display: none">
          <div class="quote-preview-content">
            <div class="quote-preview-sender" id="quotePreviewSender"></div>
            <div class="quote-preview-text" id="quotePreviewText"></div>
          </div>
          <button class="quote-preview-close" onclick="cancelQuote()">✕</button>
        </div>

        <!-- 群聊引用预览区域 -->
        <div class="group-quote-preview" id="groupQuotePreview">
          <div class="group-quote-preview-content">
            <div
              class="group-quote-preview-sender"
              id="groupQuotePreviewSender"
            ></div>
            <div
              class="group-quote-preview-text"
              id="groupQuotePreviewText"
            ></div>
          </div>
          <button
            class="group-quote-preview-close"
            onclick="cancelGroupQuote()"
          >
            ✕
          </button>
        </div>

        <!-- @选择器弹窗 -->
        <div class="at-selector-popup" id="atSelectorPopup"></div>

        <div class="conv-input-bar">
          <button class="tool-btn icon-btn" onclick="toggleChatPanel('plus')">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>

          <div class="conv-input-wrapper">
            <textarea
              class="conv-input"
              id="convInput"
              placeholder="输入消息..."
              rows="1"
              oninput="autoResizeTextarea(this)"
              onfocus="closeChatPanel()"
            ></textarea>
            <button class="emoji-btn-inner" onclick="toggleChatPanel('emoji')">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
              >
                <circle cx="12" cy="12" r="10" />
                <path d="M8 14s1.5 2 4 2 4-2 4-2" />
                <line x1="9" y1="9" x2="9.01" y2="9" />
                <line x1="15" y1="9" x2="15.01" y2="9" />
              </svg>
            </button>
          </div>

          <button class="ai-magic-btn" onclick="requestAIReply()" id="replyBtn">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M12 3l1.5 4.5L18 9l-4.5 1.5L12 15l-1.5-4.5L6 9l4.5-1.5L12 3z"
              ></path>
              <path d="M5 19l1 3 1-3 3-1-3-1-1-3-1 3-3 1 3 1z"></path>
              <path
                d="M18 14l.5 1.5 1.5.5-1.5.5-.5 1.5-.5-1.5-1.5-.5 1.5-.5.5-1.5z"
              ></path>
            </svg>
          </button>

          <button class="conv-send-btn" onclick="sendUserMessage()">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="12" y1="19" x2="12" y2="5"></line>
              <polyline points="5 12 12 5 19 12"></polyline>
            </svg>
          </button>
        </div>

        <div class="chat-panel" id="plusPanel">
          <div class="panel-grid">
            <div class="panel-item" onclick="rerollAIReply()">
              <div class="panel-icon-box bg-reroll">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <polyline points="23 4 23 10 17 10"></polyline>
                  <polyline points="1 20 1 14 7 14"></polyline>
                  <path
                    d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
                  ></path>
                </svg>
              </div>
              <span class="panel-label">重roll</span>
            </div>
            <div class="panel-item" onclick="openSendImageModal()">
              <div class="panel-icon-box bg-camera">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <circle cx="8.5" cy="8.5" r="1.5"></circle>
                  <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
              </div>
              <span class="panel-label">照片</span>
            </div>
            <div class="panel-item" onclick="startVoiceCall()">
              <div class="panel-icon-box bg-call">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                  ></path>
                </svg>
              </div>
              <span class="panel-label">语音通话</span>
            </div>
            <div class="panel-item" onclick="startVideoCall()">
              <div class="panel-icon-box bg-video">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <polygon points="23 7 16 12 23 17 23 7"></polygon>
                  <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                </svg>
              </div>
              <span class="panel-label">视频通话</span>
            </div>
            <div class="panel-item" onclick="sendFakeLocation()">
              <div class="panel-icon-box bg-location">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"
                  ></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
              </div>
              <span class="panel-label">位置</span>
            </div>
            <div class="panel-item" onclick="openVoiceMessageModal()">
              <div class="panel-icon-box bg-voice-msg">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"
                  ></path>
                  <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                  <line x1="12" y1="19" x2="12" y2="23"></line>
                  <line x1="8" y1="23" x2="16" y2="23"></line>
                </svg>
              </div>
              <span class="panel-label">语音</span>
            </div>
            <div class="panel-item" onclick="openTransferModal()">
              <div class="panel-icon-box bg-transfer">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <line x1="12" y1="1" x2="12" y2="23"></line>
                  <path
                    d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
                  ></path>
                </svg>
              </div>
              <span class="panel-label">转账</span>
            </div>
            <div class="panel-item" onclick="openReadTogether()">
              <div class="panel-icon-box bg-book">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                  <path
                    d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"
                  ></path>
                </svg>
              </div>
              <span class="panel-label">一起读书</span>
            </div>
            <div class="panel-item" onclick="openMusicTogether()">
              <div class="panel-icon-box bg-music">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M9 18V5l12-2v13"></path>
                  <circle cx="6" cy="18" r="3"></circle>
                  <circle cx="18" cy="16" r="3"></circle>
                </svg>
              </div>
              <span class="panel-label">一起听歌</span>
            </div>
            <div class="panel-item" onclick="openPhonePeek()">
              <div class="panel-icon-box bg-phone">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                >
                  <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
                  <line x1="12" y1="18" x2="12.01" y2="18"></line>
                </svg>
              </div>
              <span class="panel-label">查手机</span>
            </div>
          </div>
          <input
            type="file"
            id="chatImgInput"
            hidden
            accept="image/*"
            onchange="handleChatImageUpload(this)"
          />
          <div class="panel-item" onclick="continueChat()">
            <div class="panel-icon-box bg-continue">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M5 12h14"></path>
                <path d="M12 5l7 7-7 7"></path>
              </svg>
            </div>
            <span class="panel-label">续写</span>
          </div>
        </div>

        <div class="chat-panel" id="emojiPanel">
          <!-- 搜索框 -->
          <div class="sticker-search-bar">
            <input
              type="text"
              class="sticker-search-input"
              id="stickerSearchInput"
              placeholder="搜索表情包..."
              oninput="handleStickerSearch(this.value)"
            />
            <span
              class="sticker-search-clear"
              id="stickerSearchClear"
              onclick="clearStickerSearch()"
              >✕</span
            >
          </div>

          <div class="sticker-category-bar" id="stickerCategoryBar"></div>

          <div class="emoji-grid" id="stickerGrid"></div>

          <input
            type="file"
            id="stickerInput"
            hidden
            accept="image/*,.txt"
            multiple
            onchange="handleStickerImport(this)"
          />
        </div>
      </div>
    </div>

    <!-- 一起读书页面 -->
    <div class="read-together-page" id="readTogetherPage">
      <div class="read-header">
        <button class="read-header-back" onclick="closeReadTogether()">
          ←
        </button>
        <div class="read-header-title">📖 一起读书</div>
        <div style="width: 36px"></div>
      </div>
      <div class="read-content">
        <!-- 我的书架 -->
        <div class="bookshelf-section">
          <div class="bookshelf-title">≡ 我的书架</div>
          <div class="bookshelf-grid" id="bookshelfGrid">
            <!-- 书籍卡片会动态生成 -->
            <div
              class="book-card add-book-card"
              onclick="document.getElementById('bookFileInput').click()"
            >
              <div style="font-size: 32px; margin-bottom: 8px">+</div>
              <div>导入新书</div>
            </div>
          </div>
          <input
            type="file"
            id="bookFileInput"
            hidden
            accept=".txt"
            onchange="handleBookImport(this)"
          />
        </div>

        <!-- 当前阅读 -->
        <div id="currentReadingSection" style="display: none">
          <div class="bookshelf-title">≡ 当前阅读</div>
          <div class="read-book-info">
            <div class="read-book-title">
              <span>≡</span>
              <span id="readBookName">书名</span>
              <span class="read-status-badge" id="readStatusBadge">
                <span>✓</span> 阅读中
              </span>
            </div>
            <div class="read-book-progress" id="readBookProgress">
              进度：第 1 页 / 共 100 页
            </div>
            <div class="read-progress-bar">
              <div
                class="read-progress-fill"
                id="readProgressFill"
                style="width: 0%"
              ></div>
            </div>
          </div>

          <div class="read-current-section">
            <div class="read-section-label">📍 当前页内容</div>
            <div class="read-section-text" id="readSectionText">
              这里显示当前页的内容...
            </div>
            <div class="read-controls">
              <button class="read-ctrl-btn prev" onclick="readPrevSection()">
                ← 上一页
              </button>
              <button class="read-ctrl-btn next" onclick="readNextSection()">
                下一页 →
              </button>
            </div>
          </div>

          <div class="read-settings">
            <div class="read-setting-row">
              <span class="read-setting-label">跳转到第</span>
              <div class="read-setting-value">
                <input
                  type="number"
                  class="read-setting-input"
                  id="readJumpTo"
                  value="1"
                  min="1"
                />
                <span>页</span>
                <button
                  class="read-ctrl-btn next"
                  style="flex: none; padding: 6px 12px"
                  onclick="jumpToSection()"
                >
                  跳转
                </button>
              </div>
            </div>
            <div class="read-setting-row">
              <span class="read-setting-label">开启悬浮窗</span>
              <div class="read-setting-value">
                <button
                  class="read-ctrl-btn next"
                  style="flex: none; padding: 8px 16px"
                  onclick="startFloatingMode()"
                >
                  • 悬浮阅读
                </button>
              </div>
            </div>
            <div class="read-setting-row">
              <button
                class="read-ctrl-btn prev"
                style="width: 100%; background: #fff3e0; color: #ff9800"
                onclick="stopCurrentReading()"
              >
                ⏸️ 暂停阅读（回到书架）
              </button>
            </div>
          </div>
        </div>

        <!-- 导入设置 -->
        <div class="read-settings" style="margin-top: 16px">
          <div class="bookshelf-title" style="margin-bottom: 12px">
            📥 导入设置
          </div>
          <div class="read-setting-row">
            <span class="read-setting-label">每页字数</span>
            <div class="read-setting-value">
              <input
                type="number"
                class="read-setting-input"
                id="readChunkSize"
                value="500"
                min="100"
                max="3000"
                style="width: 70px"
              />
              <span>字</span>
            </div>
          </div>
          <div style="font-size: 0.8rem; color: #888; margin-top: 8px">
            提示：导入新书时生效。字数越少翻页越频繁，字数越多每页内容越长。
          </div>
        </div>

        <!-- 使用说明 -->
        <div class="read-settings" style="margin-top: 16px">
          <div
            class="read-setting-row"
            style="flex-direction: column; align-items: flex-start; gap: 8px"
          >
            <span class="read-setting-label">📖 使用说明</span>
            <div style="font-size: 0.85rem; color: #666; line-height: 1.6">
              1. 设置每页字数，然后导入TXT书籍<br />
              2. 点击书籍卡片开始阅读<br />
              3. 点击「• 悬浮阅读」开启悬浮窗<br />
              4. 悬浮窗可以拖动、缩放，边看书边聊天<br />
              5. AI会根据当前阅读内容与你互动
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 悬浮阅读按钮 -->
    <button
      class="read-floating-btn"
      id="readFloatingBtn"
      onclick="toggleFloatingPanel()"
    >
      ≡
    </button>

    <!-- 悬浮阅读面板 -->
    <div class="read-floating-panel" id="readFloatingPanel">
      <div class="read-float-header" id="floatPanelHeader">
        <span class="read-float-drag-hint">⋮⋮</span>
        <div class="read-float-title" id="floatBookTitle">书名</div>
        <div class="read-float-progress" id="floatProgress">第1页</div>
        <button class="read-float-close" onclick="toggleFloatingPanel()">
          ✕
        </button>
      </div>
      <div class="read-float-content" id="floatContent">当前页内容...</div>
      <div class="read-float-controls">
        <button
          class="read-float-btn"
          onclick="readPrevSection();updateFloatingPanel();"
        >
          ← 上一页
        </button>
        <button
          class="read-float-btn primary"
          onclick="readNextSection();updateFloatingPanel();"
        >
          下一页 →
        </button>
        <button
          class="read-float-btn"
          onclick="openReadTogether();hideFloatingPanel();"
        >
          📖 书架
        </button>
      </div>
      <div class="read-float-resize-handle" id="floatResizeHandle"></div>
    </div>

    <!-- Chat Settings Page -->
    <div class="chat-settings-page" id="chatSettingsPage">
      <div class="settings-header">
        <button class="settings-back-btn" onclick="closeChatSettings()">
          ‹
        </button>
        <div class="settings-header-title">聊天设置</div>
        <button class="settings-save-btn" onclick="saveChatSettingsAndClose()">
          保存
        </button>
      </div>

      <div class="settings-content">
        <!-- Section 1: Basic Info -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon brown">📝</div>
            <span class="section-title">基础资料</span>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label"
                >角色真名 / 群聊名称
                <span class="form-hint">(AI只认这个)</span></label
              >
              <input
                type="text"
                class="form-input"
                id="settingsCharName"
                placeholder="输入角色名称..."
              />
            </div>
            <div class="form-group">
              <label class="form-label"
                >备注名
                <span class="form-hint">(仅显示用，AI不知道)</span></label
              >
              <input
                type="text"
                class="form-input"
                id="settingsCharNote"
                placeholder="输入备注名..."
              />
            </div>
            <div class="form-group">
              <label class="form-label">好友分组</label>
              <div class="form-select-wrapper">
                <select class="form-select" id="settingsGroup">
                  <option value="none">未分组</option>
                </select>
                <button class="form-btn-small" onclick="openGroupManager()">
                  管理
                </button>
              </div>
            </div>

            <!-- 置顶联系人 -->
            <div class="form-group">
              <label class="form-label">聊天列表设置</label>
              <div class="avatar-toggle-group">
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="settingsPinned"
                    onchange="togglePinContact()"
                  />
                  <span class="toggle-label">• 置顶此联系人</span>
                </label>
              </div>
            </div>

            <!-- Avatar Upload -->
            <div class="avatar-upload-row">
              <div class="avatar-upload-col">
                <div class="avatar-upload-label">对方头像</div>
                <div
                  class="avatar-preview"
                  id="settingsOtherAvatar"
                  onclick="document.getElementById('otherAvatarInput').click()"
                >
                  <span id="otherAvatarPlaceholder"
                    ><svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <rect
                        x="3"
                        y="3"
                        width="18"
                        height="18"
                        rx="2"
                        ry="2"
                      ></rect>
                      <circle cx="8.5" cy="8.5" r="1.5"></circle>
                      <polyline points="21 15 16 10 5 21"></polyline></svg
                  ></span>
                  <img id="otherAvatarImg" src="" style="display: none" />
                </div>
                <input
                  type="file"
                  id="otherAvatarInput"
                  class="hidden-input"
                  accept="image/*"
                  onchange="previewSettingsAvatar(this, 'other')"
                />
                <div class="avatar-actions">
                  <button
                    class="avatar-action-btn"
                    onclick="document.getElementById('otherAvatarInput').click()"
                  >
                    上传
                  </button>
                  <button
                    class="avatar-action-btn"
                    onclick="clearSettingsAvatar('other')"
                  >
                    清除
                  </button>
                </div>
              </div>
              <div class="avatar-upload-col">
                <div class="avatar-upload-label">我的头像</div>
                <div
                  class="avatar-preview"
                  id="settingsMyAvatar"
                  onclick="document.getElementById('myAvatarInput').click()"
                >
                  <span id="myAvatarPlaceholder"
                    ><svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <rect
                        x="3"
                        y="3"
                        width="18"
                        height="18"
                        rx="2"
                        ry="2"
                      ></rect>
                      <circle cx="8.5" cy="8.5" r="1.5"></circle>
                      <polyline points="21 15 16 10 5 21"></polyline></svg
                  ></span>
                  <img id="myAvatarImg" src="" style="display: none" />
                </div>
                <input
                  type="file"
                  id="myAvatarInput"
                  class="hidden-input"
                  accept="image/*"
                  onchange="previewSettingsAvatar(this, 'my')"
                />
                <div class="avatar-actions">
                  <button
                    class="avatar-action-btn"
                    onclick="document.getElementById('myAvatarInput').click()"
                  >
                    上传
                  </button>
                  <button
                    class="avatar-action-btn"
                    onclick="clearSettingsAvatar('my')"
                  >
                    清除
                  </button>
                </div>
              </div>
            </div>

            <!-- 头像显示开关 -->
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">头像显示设置</label>
              <div class="avatar-toggle-group">
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="showAiAvatar"
                    checked
                    onchange="toggleAvatarDisplay()"
                  />
                  <span class="toggle-label">显示AI头像</span>
                </label>
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="showUserAvatar"
                    checked
                    onchange="toggleAvatarDisplay()"
                  />
                  <span class="toggle-label">显示我的头像</span>
                </label>
              </div>
            </div>

            <!-- 头像大小调节 -->
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">头像大小</label>
              <div style="display: flex; align-items: center; gap: 12px">
                <input
                  type="range"
                  id="avatarSizeSlider"
                  min="28"
                  max="56"
                  value="40"
                  style="flex: 1; accent-color: #f48fb1"
                  oninput="updateAvatarSizePreview(this.value)"
                  onchange="saveAvatarSize(this.value)"
                />
                <span
                  id="avatarSizeValue"
                  style="
                    min-width: 45px;
                    text-align: center;
                    font-size: 0.9rem;
                    color: #666;
                  "
                  >40px</span
                >
              </div>
            </div>

            <!-- 气泡间距调节 -->
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">气泡间距</label>
              <div style="display: flex; align-items: center; gap: 12px">
                <input
                  type="range"
                  id="bubbleGapSlider"
                  min="2"
                  max="20"
                  value="6"
                  style="flex: 1; accent-color: #f48fb1"
                  oninput="updateBubbleGapPreview(this.value)"
                  onchange="saveBubbleGap(this.value)"
                />
                <span
                  id="bubbleGapValue"
                  style="
                    min-width: 45px;
                    text-align: center;
                    font-size: 0.9rem;
                    color: #666;
                  "
                  >6px</span
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Section 2: AI Brain & Persona -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon purple">🧠</div>
            <span class="section-title">设定</span>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label">对方人设 (Persona)</label>
              <textarea
                class="form-input form-textarea"
                id="settingsPersona"
                placeholder="描述AI角色的性格、背景、说话方式等..."
              ></textarea>
            </div>
            <div class="form-group">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 8px;
                "
              >
                <label class="form-label" style="margin-bottom: 0"
                  >我的人设 (My Persona)</label
                >
                <div style="display: flex; gap: 8px">
                  <select
                    class="form-select"
                    id="userPersonaPresetSelect"
                    style="
                      padding: 6px 24px 6px 12px;
                      font-size: 0.8rem;
                      background-position: right 8px center;
                    "
                  >
                    <option value="">-- 选择预设 --</option>
                  </select>
                  <button
                    class="form-btn-small"
                    onclick="saveUserPersonaPreset()"
                    style="padding: 6px 12px; font-size: 0.8rem"
                  >
                    保存预设
                  </button>
                </div>
              </div>
              <textarea
                class="form-input form-textarea"
                id="settingsMyPersona"
                placeholder="描述你自己的设定，让AI了解你..."
              ></textarea>
            </div>
            <div class="form-group">
              <label class="form-label"
                >关联世界书
                <span class="form-hint">(多选，勾选生效)</span></label
              >
              <div class="worldbook-select-area" id="settingsWorldbookArea">
                <div class="worldbook-select-empty">
                  还没有世界书，去创建一本吧~
                </div>
              </div>
              <input type="hidden" id="settingsWorldbook" value="" />
            </div>
            <div
              class="form-group"
              style="
                margin-top: 18px;
                padding-top: 18px;
                border-top: 1px dashed #eee;
              "
            >
              <label class="form-label">🗣️ 角色音色 (Voice ID)</label>
              <div class="form-select-wrapper">
                <input
                  type="text"
                  class="form-input"
                  id="settingsVoiceId"
                  placeholder="例如: male-qn-qingse (青涩青年)"
                />
                <button class="form-btn-small" onclick="testCharacterVoice()">
                  试听
                </button>
              </div>
              <div class="form-hint">请填写 MiniMax 的音色 ID</div>
            </div>

            <!-- 通话设置 -->
            <div
              class="form-group"
              style="
                margin-top: 18px;
                padding-top: 18px;
                border-top: 1px dashed #eee;
              "
            >
              <label class="form-label"
                ><svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  style="vertical-align: middle; margin-right: 4px"
                >
                  <path
                    d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                  ></path></svg
                >通话设置</label
              >
              <div class="avatar-toggle-group" style="margin-top: 10px">
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="settingsCallVoiceEnabled"
                    onchange="saveCallSettings()"
                  />
                  <span class="toggle-label"
                    >通话接入语音 (使用上方Voice ID)</span
                  >
                </label>
              </div>
              <div class="avatar-toggle-group" style="margin-top: 8px">
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="settingsAiCallEnabled"
                    onchange="saveCallSettings()"
                  />
                  <span class="toggle-label">允许TA主动打电话给我</span>
                </label>
              </div>
              <div class="form-hint" style="margin-top: 8px">
                开启语音后，通话中AI的回复将自动朗读
              </div>

              <!-- 视频通话画面设置 -->
              <div
                style="
                  margin-top: 16px;
                  padding-top: 16px;
                  border-top: 1px dashed #f0f0f0;
                "
              >
                <label class="form-label" style="font-size: 0.85rem"
                  ><svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    style="vertical-align: middle; margin-right: 4px"
                  >
                    <polygon points="23 7 16 12 23 17 23 7"></polygon>
                    <rect
                      x="1"
                      y="5"
                      width="15"
                      height="14"
                      rx="2"
                      ry="2"
                    ></rect></svg
                  >视频通话画面</label
                >
                <div class="form-hint" style="margin-bottom: 10px">
                  设置视频通话时对方和自己的画面
                </div>

                <div style="display: flex; gap: 16px; margin-top: 12px">
                  <!-- 对方画面 -->
                  <div style="flex: 1; text-align: center">
                    <div
                      style="font-size: 0.8rem; color: #666; margin-bottom: 6px"
                    >
                      TA的画面
                    </div>
                    <div
                      id="videoCallPartnerPreview"
                      style="
                        width: 80px;
                        height: 110px;
                        border-radius: 8px;
                        background: #f5f5f5;
                        margin: 0 auto;
                        overflow: hidden;
                        cursor: pointer;
                        border: 2px dashed #ddd;
                      "
                      onclick="document.getElementById('videoCallPartnerInput').click()"
                    >
                      <img
                        id="videoCallPartnerImg"
                        src=""
                        style="
                          width: 100%;
                          height: 100%;
                          object-fit: cover;
                          display: none;
                        "
                      />
                      <div
                        id="videoCallPartnerPlaceholder"
                        style="
                          height: 100%;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          color: #999;
                          font-size: 0.7rem;
                        "
                      >
                        点击设置
                      </div>
                    </div>
                    <input
                      type="file"
                      id="videoCallPartnerInput"
                      hidden
                      accept="image/*,video/*"
                      onchange="handleVideoCallImageUpload(this, 'partner')"
                    />
                    <button
                      onclick="clearVideoCallImage('partner')"
                      style="
                        margin-top: 6px;
                        font-size: 0.7rem;
                        padding: 2px 8px;
                        background: #f5f5f5;
                        border: none;
                        border-radius: 4px;
                        color: #999;
                      "
                    >
                      清除
                    </button>
                  </div>

                  <!-- 自己画面 -->
                  <div style="flex: 1; text-align: center">
                    <div
                      style="font-size: 0.8rem; color: #666; margin-bottom: 6px"
                    >
                      我的画面
                    </div>
                    <div
                      id="videoCallSelfPreview"
                      style="
                        width: 80px;
                        height: 110px;
                        border-radius: 8px;
                        background: #f5f5f5;
                        margin: 0 auto;
                        overflow: hidden;
                        cursor: pointer;
                        border: 2px dashed #ddd;
                      "
                      onclick="document.getElementById('videoCallSelfInput').click()"
                    >
                      <img
                        id="videoCallSelfImg"
                        src=""
                        style="
                          width: 100%;
                          height: 100%;
                          object-fit: cover;
                          display: none;
                        "
                      />
                      <div
                        id="videoCallSelfPlaceholder"
                        style="
                          height: 100%;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          color: #999;
                          font-size: 0.7rem;
                        "
                      >
                        点击设置
                      </div>
                    </div>
                    <input
                      type="file"
                      id="videoCallSelfInput"
                      hidden
                      accept="image/*,video/*"
                      onchange="handleVideoCallImageUpload(this, 'self')"
                    />
                    <button
                      onclick="clearVideoCallImage('self')"
                      style="
                        margin-top: 6px;
                        font-size: 0.7rem;
                        padding: 2px 8px;
                        background: #f5f5f5;
                        border: none;
                        border-radius: 4px;
                        color: #999;
                      "
                    >
                      清除
                    </button>
                  </div>
                </div>
              </div>

              <!-- 通话气泡颜色设置 -->
              <div
                style="
                  margin-top: 16px;
                  padding-top: 16px;
                  border-top: 1px dashed #f0f0f0;
                "
              >
                <label class="form-label" style="font-size: 0.85rem"
                  >💬 通话气泡样式</label
                >
                <div class="form-hint" style="margin-bottom: 10px">
                  自定义通话时消息气泡的颜色和透明度
                </div>

                <div
                  style="
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                    margin-top: 12px;
                  "
                >
                  <!-- 用户气泡颜色 -->
                  <div style="display: flex; align-items: center; gap: 10px">
                    <span style="font-size: 0.8rem; color: #666; width: 70px"
                      >我的气泡</span
                    >
                    <input
                      type="color"
                      id="settingsCallUserBubbleColor"
                      value="#f48fb1"
                      style="
                        width: 36px;
                        height: 28px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                      "
                      onchange="previewCallBubbleColor()"
                    />
                    <input
                      type="range"
                      id="settingsCallUserBubbleOpacity"
                      min="30"
                      max="100"
                      value="85"
                      style="flex: 1"
                      oninput="previewCallBubbleColor()"
                    />
                    <span
                      id="callUserOpacityLabel"
                      style="font-size: 0.75rem; color: #999; width: 35px"
                      >85%</span
                    >
                  </div>

                  <!-- AI气泡颜色 -->
                  <div style="display: flex; align-items: center; gap: 10px">
                    <span style="font-size: 0.8rem; color: #666; width: 70px"
                      >TA的气泡</span
                    >
                    <input
                      type="color"
                      id="settingsCallAiBubbleColor"
                      value="#ffffff"
                      style="
                        width: 36px;
                        height: 28px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                      "
                      onchange="previewCallBubbleColor()"
                    />
                    <input
                      type="range"
                      id="settingsCallAiBubbleOpacity"
                      min="30"
                      max="100"
                      value="85"
                      style="flex: 1"
                      oninput="previewCallBubbleColor()"
                    />
                    <span
                      id="callAiOpacityLabel"
                      style="font-size: 0.75rem; color: #999; width: 35px"
                      >85%</span
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Section 3: Memory Settings -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon teal">💾</div>
            <span class="section-title">记忆与上下文</span>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label"
                >记忆互通 <span class="form-hint">(可多选)</span></label
              >
              <div class="memory-link-dropdown" id="memoryLinkDropdown">
                <div
                  class="memory-link-select"
                  onclick="toggleMemoryLinkDropdown()"
                >
                  <span class="memory-link-text" id="memoryLinkText"
                    >点击选择要互通的角色...</span
                  >
                  <span class="memory-link-arrow">▼</span>
                </div>
                <div class="memory-link-options" id="memoryLinkOptions">
                  <!-- 动态生成 -->
                </div>
              </div>
              <div class="memory-link-tags" id="memoryLinkTags">
                <!-- 已选中的标签 -->
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">互通条数</label>
              <div class="number-input-row">
                <input
                  type="number"
                  class="number-input"
                  id="settingsMemoryCount"
                  value="5"
                  min="1"
                  max="50"
                />
                <span class="form-hint">条最近消息</span>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">上下文记忆条数</label>
              <div class="number-input-row">
                <input
                  type="number"
                  class="number-input"
                  id="settingsContextCount"
                  value="150"
                  min="10"
                  max="500"
                />
                <span class="form-hint">条</span>
              </div>
            </div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 12px;
                padding: 10px 12px;
                background: #faf8f5;
                border-radius: 10px;
              "
            >
              <span style="font-size: 0.82rem; color: #9a8b7a"
                >总消息：<strong id="settingsTotalMsg">0</strong> 条</span
              >
              <span style="font-size: 0.82rem; color: #c4a87c"
                >token：<strong id="settingsTokenCount">0</strong></span
              >
            </div>
          </div>
        </div>

        <!-- Section 4: Play Mode -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon orange">🎮</div>
            <span class="section-title">玩法与模式</span>
          </div>
          <div class="section-body">
            <div class="toggle-row">
              <div>
                <div class="toggle-label">线下模式 (Online Dating)</div>
                <div class="toggle-sublabel">模拟真实约会场景</div>
              </div>
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  id="settingsOnlineDating"
                  onchange="toggleOfflineSettings()"
                />
                <span class="toggle-slider"></span>
              </label>
            </div>

            <!-- 线下模式高级设置 -->
            <div class="offline-word-settings" id="offlineWordSettings">
              <div class="offline-word-title">★ 线下模式设置</div>
              <div class="offline-word-row">
                <span
                  style="font-size: 0.82rem; color: #8d6e63; min-width: 60px"
                  >回复字数</span
                >
                <input
                  type="number"
                  class="offline-word-input"
                  id="offlineMinWords"
                  value="100"
                  min="10"
                  max="5000"
                />
                <span class="offline-word-sep">～</span>
                <input
                  type="number"
                  class="offline-word-input"
                  id="offlineMaxWords"
                  value="500"
                  min="10"
                  max="5000"
                />
                <span class="offline-word-unit">字</span>
              </div>
              <div class="offline-preset-select">
                <label
                  style="
                    font-size: 0.82rem;
                    color: #8d6e63;
                    display: block;
                    margin-bottom: 8px;
                  "
                  >应用预设</label
                >
                <select
                  class="offline-preset-dropdown"
                  id="offlinePresetSelect"
                >
                  <option value="">-- 不使用预设 --</option>
                </select>
              </div>
            </div>

            <div class="toggle-row">
              <div>
                <div class="toggle-label">长期记忆总结</div>
                <div class="toggle-sublabel">自动总结重要对话</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="settingsLongMemory" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">总结模式</label>
              <div class="radio-group">
                <div
                  class="radio-option"
                  data-value="auto"
                  onclick="selectRadio(this, 'summaryMode')"
                >
                  自动总结
                </div>
                <div
                  class="radio-option active"
                  data-value="manual"
                  onclick="selectRadio(this, 'summaryMode')"
                >
                  手动总结
                </div>
              </div>
              <input type="hidden" id="settingsSummaryMode" value="manual" />
            </div>
            <div class="form-group">
              <label class="form-label">触发条数</label>
              <div class="number-input-row">
                <input
                  type="number"
                  class="number-input"
                  id="settingsTriggerCount"
                  value="500"
                  min="50"
                  max="2000"
                />
                <span class="form-hint">条消息后触发总结</span>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">总结提示词</label>
              <textarea
                class="form-input form-textarea"
                id="settingsSummaryPrompt"
                placeholder="请以第三人称的视角，客观、冷静、不带任何感情色彩地总结以下对话的核心事件和信息。禁止进行任何角色扮演或添加主观评论。"
              ></textarea>
            </div>
            <div class="action-buttons-grid" style="margin-top: 12px">
              <button class="action-btn" onclick="viewSummaries()">
                ≡ 查看/管理总结
              </button>
              <button class="action-btn" onclick="triggerManualSummary()">
                ✎ 立即手动总结
              </button>
            </div>
            <div class="toggle-row" style="margin-top: 12px">
              <div>
                <div class="toggle-label">续火花系统</div>
                <div class="toggle-sublabel">保持对话热度</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="settingsFlame" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="toggle-row">
              <div>
                <div class="toggle-label">实时时间感知</div>
                <div class="toggle-sublabel">AI了解当前时间</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="settingsTimeAware" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>

        <!-- Section 5: Visual Customization -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon blue">🎨</div>
            <span class="section-title">美化</span>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label">聊天背景</label>
              <div class="bg-preview-container">
                <div class="bg-preview-phone" id="bgPreview">
                  <span id="bgPreviewPlaceholder">无背景</span>
                  <img id="bgPreviewImg" src="" style="display: none" />
                </div>
                <button
                  class="bg-upload-btn"
                  onclick="document.getElementById('bgUploadInput').click()"
                >
                  ↑ 点击上传背景图片
                </button>
                <input
                  type="file"
                  id="bgUploadInput"
                  class="hidden-input"
                  accept="image/*"
                  onchange="previewBackground(this)"
                />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">字体大小</label>
              <div class="slider-row">
                <span class="slider-value" id="fontSizeValue">14px</span>
                <input
                  type="range"
                  id="settingsFontSize"
                  min="12"
                  max="20"
                  value="14"
                  oninput="updateFontSizePreview(this.value)"
                />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">聊天气泡样式</label>
              <div class="form-hint" style="margin-bottom: 12px">
                自定义气泡背景、透明度和字体颜色
              </div>

              <!-- 我的气泡 -->
              <div
                style="
                  background: rgba(244, 143, 177, 0.1);
                  padding: 12px;
                  border-radius: 12px;
                  margin-bottom: 12px;
                "
              >
                <div
                  style="
                    font-size: 0.85rem;
                    color: #333;
                    font-weight: 500;
                    margin-bottom: 10px;
                  "
                >
                  💬 我的气泡
                </div>

                <!-- 背景颜色 -->
                <div style="margin-bottom: 10px">
                  <span
                    style="
                      font-size: 0.75rem;
                      color: #666;
                      display: block;
                      margin-bottom: 6px;
                    "
                    >背景颜色</span
                  >
                  <div
                    style="
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      flex-wrap: wrap;
                    "
                  >
                    <div
                      class="color-preset-grid"
                      style="display: flex; gap: 4px; flex-wrap: wrap"
                    >
                      <div
                        class="color-preset"
                        style="background: #fce4ec"
                        onclick="setChatUserBubbleBg('#fce4ec')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #f8bbd9"
                        onclick="setChatUserBubbleBg('#f8bbd9')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #f48fb1"
                        onclick="setChatUserBubbleBg('#f48fb1')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #e1bee7"
                        onclick="setChatUserBubbleBg('#e1bee7')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #bbdefb"
                        onclick="setChatUserBubbleBg('#bbdefb')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #b2ebf2"
                        onclick="setChatUserBubbleBg('#b2ebf2')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #c8e6c9"
                        onclick="setChatUserBubbleBg('#c8e6c9')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #fff9c4"
                        onclick="setChatUserBubbleBg('#fff9c4')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #ffe0b2"
                        onclick="setChatUserBubbleBg('#ffe0b2')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #d7ccc8"
                        onclick="setChatUserBubbleBg('#d7ccc8')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #ffffff"
                        onclick="setChatUserBubbleBg('#ffffff')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #37474f"
                        onclick="setChatUserBubbleBg('#37474f')"
                      ></div>
                    </div>
                    <input
                      type="color"
                      id="settingsChatUserBubbleBg"
                      value="#f8bbd9"
                      class="color-picker-input"
                      onchange="previewChatBubbleStyle()"
                    />
                  </div>
                </div>

                <!-- 透明度 -->
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    margin-bottom: 10px;
                  "
                >
                  <span style="font-size: 0.75rem; color: #666; width: 50px"
                    >透明度</span
                  >
                  <input
                    type="range"
                    id="settingsChatUserBubbleOpacity"
                    min="30"
                    max="100"
                    value="100"
                    style="flex: 1"
                    oninput="previewChatBubbleStyle(); document.getElementById('chatUserOpacityLabel').textContent=this.value+'%'"
                  />
                  <span
                    id="chatUserOpacityLabel"
                    style="font-size: 0.7rem; color: #999; width: 35px"
                    >100%</span
                  >
                </div>

                <!-- 字体颜色 -->
                <div>
                  <span
                    style="
                      font-size: 0.75rem;
                      color: #666;
                      display: block;
                      margin-bottom: 6px;
                    "
                    >字体颜色</span
                  >
                  <div
                    style="
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      flex-wrap: wrap;
                    "
                  >
                    <div
                      class="color-preset-grid"
                      style="display: flex; gap: 4px; flex-wrap: wrap"
                    >
                      <div
                        class="color-preset"
                        style="background: #c2185b"
                        onclick="setChatUserTextColor('#c2185b')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #e91e63"
                        onclick="setChatUserTextColor('#e91e63')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #7b1fa2"
                        onclick="setChatUserTextColor('#7b1fa2')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #512da8"
                        onclick="setChatUserTextColor('#512da8')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #1976d2"
                        onclick="setChatUserTextColor('#1976d2')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #0097a7"
                        onclick="setChatUserTextColor('#0097a7')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #388e3c"
                        onclick="setChatUserTextColor('#388e3c')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #f57c00"
                        onclick="setChatUserTextColor('#f57c00')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #5d4037"
                        onclick="setChatUserTextColor('#5d4037')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #37474f"
                        onclick="setChatUserTextColor('#37474f')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #ffffff"
                        onclick="setChatUserTextColor('#ffffff')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #000000"
                        onclick="setChatUserTextColor('#000000')"
                      ></div>
                    </div>
                    <input
                      type="color"
                      id="settingsChatUserTextColor"
                      value="#c2185b"
                      class="color-picker-input"
                      onchange="previewChatBubbleStyle()"
                    />
                  </div>
                </div>
              </div>

              <!-- TA的气泡 -->
              <div
                style="
                  background: rgba(0, 0, 0, 0.03);
                  padding: 12px;
                  border-radius: 12px;
                "
              >
                <div
                  style="
                    font-size: 0.85rem;
                    color: #333;
                    font-weight: 500;
                    margin-bottom: 10px;
                  "
                >
                  💭 TA的气泡
                </div>

                <!-- 背景颜色 -->
                <div style="margin-bottom: 10px">
                  <span
                    style="
                      font-size: 0.75rem;
                      color: #666;
                      display: block;
                      margin-bottom: 6px;
                    "
                    >背景颜色</span
                  >
                  <div
                    style="
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      flex-wrap: wrap;
                    "
                  >
                    <div
                      class="color-preset-grid"
                      style="display: flex; gap: 4px; flex-wrap: wrap"
                    >
                      <div
                        class="color-preset"
                        style="background: #ffffff"
                        onclick="setChatAiBubbleBg('#ffffff')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #f5f5f5"
                        onclick="setChatAiBubbleBg('#f5f5f5')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #eeeeee"
                        onclick="setChatAiBubbleBg('#eeeeee')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #e0e0e0"
                        onclick="setChatAiBubbleBg('#e0e0e0')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #fce4ec"
                        onclick="setChatAiBubbleBg('#fce4ec')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #e3f2fd"
                        onclick="setChatAiBubbleBg('#e3f2fd')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #e8f5e9"
                        onclick="setChatAiBubbleBg('#e8f5e9')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #fff8e1"
                        onclick="setChatAiBubbleBg('#fff8e1')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #efebe9"
                        onclick="setChatAiBubbleBg('#efebe9')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #eceff1"
                        onclick="setChatAiBubbleBg('#eceff1')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #37474f"
                        onclick="setChatAiBubbleBg('#37474f')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #212121"
                        onclick="setChatAiBubbleBg('#212121')"
                      ></div>
                    </div>
                    <input
                      type="color"
                      id="settingsChatAiBubbleBg"
                      value="#ffffff"
                      class="color-picker-input"
                      onchange="previewChatBubbleStyle()"
                    />
                  </div>
                </div>

                <!-- 透明度 -->
                <div
                  style="
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    margin-bottom: 10px;
                  "
                >
                  <span style="font-size: 0.75rem; color: #666; width: 50px"
                    >透明度</span
                  >
                  <input
                    type="range"
                    id="settingsChatAiBubbleOpacity"
                    min="30"
                    max="100"
                    value="100"
                    style="flex: 1"
                    oninput="previewChatBubbleStyle(); document.getElementById('chatAiOpacityLabel').textContent=this.value+'%'"
                  />
                  <span
                    id="chatAiOpacityLabel"
                    style="font-size: 0.7rem; color: #999; width: 35px"
                    >100%</span
                  >
                </div>

                <!-- 字体颜色 -->
                <div>
                  <span
                    style="
                      font-size: 0.75rem;
                      color: #666;
                      display: block;
                      margin-bottom: 6px;
                    "
                    >字体颜色</span
                  >
                  <div
                    style="
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      flex-wrap: wrap;
                    "
                  >
                    <div
                      class="color-preset-grid"
                      style="display: flex; gap: 4px; flex-wrap: wrap"
                    >
                      <div
                        class="color-preset"
                        style="background: #333333"
                        onclick="setChatAiTextColor('#333333')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #37474f"
                        onclick="setChatAiTextColor('#37474f')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #455a64"
                        onclick="setChatAiTextColor('#455a64')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #616161"
                        onclick="setChatAiTextColor('#616161')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #212121"
                        onclick="setChatAiTextColor('#212121')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #1565c0"
                        onclick="setChatAiTextColor('#1565c0')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #2e7d32"
                        onclick="setChatAiTextColor('#2e7d32')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #ad1457"
                        onclick="setChatAiTextColor('#ad1457')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #6a1b9a"
                        onclick="setChatAiTextColor('#6a1b9a')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #5d4037"
                        onclick="setChatAiTextColor('#5d4037')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #ffffff"
                        onclick="setChatAiTextColor('#ffffff')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #000000"
                        onclick="setChatAiTextColor('#000000')"
                      ></div>
                    </div>
                    <input
                      type="color"
                      id="settingsChatAiTextColor"
                      value="#333333"
                      class="color-picker-input"
                      onchange="previewChatBubbleStyle()"
                    />
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">气泡样式预设</label>
              <div class="form-select-wrapper">
                <select class="form-select" id="settingsBubbleStyle">
                  <option value="none">-- 无预设 --</option>
                  <option value="simple">简约风格</option>
                  <option value="bubble">气泡风格</option>
                  <option value="modern">现代风格</option>
                  <option value="retro">复古风格</option>
                </select>
                <button class="form-btn-small" onclick="manageBubbleStyles()">
                  管理
                </button>
              </div>
            </div>
            <div class="action-buttons-grid">
              <button class="action-btn" onclick="exportBubbleStyle()">
                ↑ 导出
              </button>
              <button class="action-btn" onclick="importBubbleStyle()">
                ↓ 导入
              </button>
            </div>
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">自定义CSS</label>
              <button
                class="form-btn-small"
                onclick="resetCustomCSS()"
                style="float: right; margin-top: -28px"
              >
                重置
              </button>
              <div class="css-editor-container">
                <textarea
                  class="css-editor"
                  id="settingsCustomCSS"
                  placeholder="/* 在此输入自定义CSS代码 */"
                ></textarea>
              </div>
            </div>

            <!-- Chat Preview -->
            <div class="chat-preview-container">
              <div class="preview-label">实时预览</div>
              <div class="preview-msg-row">
                <div class="preview-avatar" id="previewOtherAvatar">AI</div>
                <div>
                  <div class="preview-bubble" id="previewOtherBubble">
                    对方消息预览
                  </div>
                  <div class="preview-time">10:00</div>
                </div>
              </div>
              <div class="preview-msg-row right">
                <div class="preview-avatar" id="previewMyAvatar">我</div>
                <div>
                  <div class="preview-bubble" id="previewMyBubble">
                    我的消息预览
                  </div>
                  <div class="preview-time">10:00</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Section 6: Data & Operations -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon brown">💾</div>
            <span class="section-title">数据与操作</span>
          </div>
          <div class="section-body">
            <div class="action-buttons-grid">
              <button class="action-btn" onclick="importChatHistory()">
                📥 导入聊天记录
              </button>
              <button class="action-btn" onclick="exportChatHistory()">
                📤 导出聊天记录
              </button>
            </div>
            <div style="border-top: 1px dashed #e5ddd3; margin: 20px 0"></div>
            <div class="action-buttons-grid">
              <button
                class="action-btn danger"
                onclick="clearChatHistoryFromSettings()"
              >
                🧹 清空聊天
              </button>
              <button class="action-btn danger" onclick="blockCharacter()">
                🚫 拉黑对方
              </button>
            </div>
            <button
              class="action-btn danger"
              style="width: 100%; margin-top: 12px"
              onclick="deleteCharacterCompletely()"
            >
              🗑️ 删除此联系人
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 外部脚本 -->
    <script src="app.js"></script>
    <div
      class="context-menu-overlay"
      id="contextMenuOverlay"
      onclick="hideContextMenu()"
    >
      <div class="context-menu" id="contextMenu"></div>
    </div>

    <div class="selection-footer" id="selectionFooter">
      <button class="selection-btn cancel" onclick="exitSelectionMode()">
        取消
      </button>
      <span
        style="font-size: 0.9rem; font-weight: 600; color: #333"
        id="selectionCount"
        >已选 0 条</span
      >
      <button
        class="selection-btn forward"
        onclick="showForwardModal()"
        style="
          background: linear-gradient(135deg, #81d4fa, #4fc3f7);
          color: #fff;
          padding: 8px 12px;
          border-radius: 8px;
          font-size: 0.85rem;
        "
      >
        ➤ 转发
      </button>
      <button
        class="selection-btn favorite"
        onclick="favoriteSelectedMessages()"
        style="
          background: linear-gradient(135deg, #f48fb1, #ec407a);
          color: #fff;
          padding: 8px 12px;
          border-radius: 8px;
          font-size: 0.85rem;
        "
      >
        ★ 收藏
      </button>
      <button
        class="selection-btn delete"
        id="multiDeleteBtn"
        onclick="deleteSelectedMessages()"
        style="padding: 8px 12px; font-size: 0.85rem"
      >
        ✕ 删除
      </button>
    </div>

    <!-- 转发弹窗 -->
    <div
      class="forward-modal-overlay"
      id="forwardModalOverlay"
      onclick="hideForwardModal()"
    >
      <div class="forward-modal" onclick="event.stopPropagation()">
        <div class="forward-modal-header">
          <span class="forward-modal-title">选择转发对象</span>
          <button class="forward-modal-close" onclick="hideForwardModal()">
            ✕
          </button>
        </div>
        <div class="forward-modal-content" id="forwardModalContent">
          <!-- 动态生成聊天列表 -->
        </div>
      </div>
    </div>

    <!-- 转发详情弹窗 -->
    <div
      class="forward-detail-overlay"
      id="forwardDetailOverlay"
      onclick="hideForwardDetail()"
    >
      <div class="forward-detail-modal" onclick="event.stopPropagation()">
        <div class="forward-detail-header">
          <span class="forward-detail-title" id="forwardDetailTitle"
            >聊天记录</span
          >
          <button class="forward-detail-close" onclick="hideForwardDetail()">
            ✕
          </button>
        </div>
        <div class="forward-detail-content" id="forwardDetailContent">
          <!-- 动态生成消息列表 -->
        </div>
      </div>
    </div>

    <!-- 心声弹窗 -->
    <div
      class="heart-voice-overlay"
      id="heartVoiceOverlay"
      onclick="hideHeartVoice()"
    >
      <div class="heart-voice-modal" onclick="event.stopPropagation()">
        <div class="heart-voice-header">
          <span class="heart-voice-title">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
              ></path>
            </svg>
            内心独白
          </span>
          <button class="heart-voice-close" onclick="hideHeartVoice()">
            ✕
          </button>
        </div>
        <div class="heart-voice-tabs">
          <button
            class="heart-voice-tab active"
            onclick="switchHeartTab('current')"
          >
            此刻
          </button>
          <button class="heart-voice-tab" onclick="switchHeartTab('history')">
            往昔
          </button>
        </div>
        <div class="heart-voice-content" id="heartVoiceContent">
          <!-- 动态生成心声内容 -->
        </div>
      </div>
    </div>

    <!-- 收藏页面 -->
    <div class="favorites-page" id="favoritesPage">
      <div class="favorites-header">
        <button class="favorites-back" onclick="closeFavoritesPage()">‹</button>
        <span class="favorites-title">我的收藏</span>
        <button class="favorites-add-group" onclick="addFavoriteGroup()">
          + 新建分组
        </button>
      </div>
      <div class="favorites-tabs" id="favoritesTabs">
        <!-- 动态生成分组标签 -->
      </div>
      <div class="favorites-content">
        <div class="favorites-list" id="favoritesList">
          <!-- 动态生成收藏列表 -->
        </div>
      </div>
    </div>

    <!-- 后台活动设置页面 -->
    <div class="favorites-page" id="backgroundActivityPage">
      <div class="favorites-header">
        <button class="favorites-back" onclick="closeBackgroundActivityPage()">
          ‹
        </button>
        <span class="favorites-title">后台活动</span>
        <span style="width: 80px"></span>
      </div>
      <div
        style="
          padding: 16px;
          overflow-y: auto;
          height: calc(100% - 56px);
          background: linear-gradient(180deg, #fef8fa 0%, #fff 100%);
        "
      >
        <!-- 总开关 -->
        <div
          style="
            background: linear-gradient(135deg, #fff 0%, #fff5f8 100%);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 14px;
            box-shadow: 0 2px 12px rgba(236, 64, 122, 0.1);
            border: 1px solid rgba(236, 64, 122, 0.08);
          "
        >
          <div
            style="
              display: flex;
              align-items: center;
              justify-content: space-between;
            "
          >
            <div>
              <div style="font-weight: 600; color: #ad1457; font-size: 1rem">
                启用后台活动
              </div>
              <div
                style="
                  font-size: 0.8rem;
                  color: #e91e63;
                  margin-top: 6px;
                  opacity: 0.7;
                "
              >
                AI角色会主动发消息、发动态、互动
              </div>
            </div>
            <div
              id="bgActivityToggleBtn"
              onclick="toggleBackgroundActivityEnabled()"
              style="
                width: 52px;
                height: 30px;
                border-radius: 15px;
                background: #e0e0e0;
                position: relative;
                cursor: pointer;
                transition: all 0.3s;
                box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
              "
            >
              <div
                style="
                  width: 26px;
                  height: 26px;
                  border-radius: 50%;
                  background: #fff;
                  position: absolute;
                  top: 2px;
                  left: 2px;
                  transition: all 0.3s;
                  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
                "
              ></div>
            </div>
          </div>
        </div>

        <!-- 检查间隔 -->
        <div
          style="
            background: linear-gradient(135deg, #fff 0%, #fff5f8 100%);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 14px;
            box-shadow: 0 2px 12px rgba(236, 64, 122, 0.1);
            border: 1px solid rgba(236, 64, 122, 0.08);
          "
        >
          <div style="font-weight: 600; color: #ad1457; margin-bottom: 12px">
            ⏱️ 检查间隔（秒）
          </div>
          <input
            type="number"
            id="bgActivityInterval"
            value="60"
            min="30"
            max="600"
            style="
              width: 100%;
              padding: 14px;
              border: 2px solid rgba(236, 64, 122, 0.2);
              border-radius: 12px;
              font-size: 1rem;
              box-sizing: border-box;
              background: #fff;
              color: #333;
              transition: all 0.2s;
            "
            onfocus="this.style.borderColor='#f48fb1';this.style.boxShadow='0 0 0 3px rgba(244,143,177,0.2)'"
            onblur="this.style.borderColor='rgba(236,64,122,0.2)';this.style.boxShadow='none'"
            onchange="updateBackgroundActivityInterval()"
          />
          <div
            style="
              font-size: 0.75rem;
              color: #e91e63;
              margin-top: 10px;
              opacity: 0.7;
            "
          >
            每隔多少秒检查一次是否触发后台活动（30-600秒）
          </div>
        </div>

        <!-- 角色频率设置 -->
        <div
          style="
            background: linear-gradient(135deg, #fff 0%, #fff5f8 100%);
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 2px 12px rgba(236, 64, 122, 0.1);
            border: 1px solid rgba(236, 64, 122, 0.08);
          "
        >
          <div style="font-weight: 600; color: #ad1457; margin-bottom: 10px">
            👥 角色活动频率
          </div>
          <div
            style="
              font-size: 0.75rem;
              color: #666;
              margin-bottom: 16px;
              line-height: 1.6;
              background: rgba(236, 64, 122, 0.05);
              padding: 12px;
              border-radius: 10px;
            "
          >
            <span style="color: #e91e63">●</span> 关闭 = 不参与后台活动<br />
            <span style="color: #f48fb1">●</span> 低频 = 每次检查20%概率<br />
            <span style="color: #ec407a">●</span> 中频 = 每次检查40%概率<br />
            <span style="color: #c2185b">●</span> 高频 = 每次检查70%概率
          </div>
          <div
            id="bgActivityCharList"
            style="display: flex; flex-direction: column; gap: 12px"
          >
            <!-- 动态生成角色列表 -->
          </div>
        </div>

        <!-- 手动测试按钮 -->
        <div
          style="
            background: linear-gradient(135deg, #fff 0%, #fff5f8 100%);
            border-radius: 16px;
            padding: 18px;
            margin-top: 14px;
            box-shadow: 0 2px 12px rgba(236, 64, 122, 0.1);
            border: 1px solid rgba(236, 64, 122, 0.08);
          "
        >
          <div style="font-weight: 600; color: #ad1457; margin-bottom: 12px">
            🧪 测试
          </div>
          <button
            onclick="testBackgroundActivity()"
            style="
              width: 100%;
              padding: 14px;
              background: linear-gradient(135deg, #f48fb1, #ec407a);
              color: #fff;
              border: none;
              border-radius: 12px;
              font-size: 1rem;
              font-weight: 500;
              cursor: pointer;
              box-shadow: 0 4px 12px rgba(236, 64, 122, 0.3);
              transition: all 0.2s;
            "
            onmousedown="this.style.transform='scale(0.98)';this.style.boxShadow='0 2px 6px rgba(236,64,122,0.3)'"
            onmouseup="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(236,64,122,0.3)'"
            ontouchstart="this.style.transform='scale(0.98)';this.style.boxShadow='0 2px 6px rgba(236,64,122,0.3)'"
            ontouchend="this.style.transform='scale(1)';this.style.boxShadow='0 4px 12px rgba(236,64,122,0.3)'"
          >
            ✨ 立即触发一次后台活动
          </button>
          <div
            style="
              font-size: 0.75rem;
              color: #e91e63;
              margin-top: 10px;
              text-align: center;
              opacity: 0.7;
            "
          >
            随机选择一个已启用的角色执行后台活动
          </div>
        </div>
      </div>
    </div>

    <!-- 收藏分组选择弹窗 -->
    <div
      class="favorite-group-modal"
      id="favoriteGroupModal"
      onclick="if(event.target===this)closeFavoriteGroupModal()"
    >
      <div class="favorite-group-content">
        <div class="favorite-group-header">选择收藏分组</div>
        <div class="favorite-group-list" id="favoriteGroupList">
          <!-- 动态生成分组列表 -->
        </div>
        <div class="favorite-group-add" onclick="addNewGroupInModal()">
          <span>+</span>
          <span>新建分组</span>
        </div>
        <div class="favorite-group-footer">
          <button
            class="favorite-group-btn cancel"
            onclick="closeFavoriteGroupModal()"
          >
            取消
          </button>
          <button
            class="favorite-group-btn confirm"
            onclick="confirmFavorite()"
          >
            确定
          </button>
        </div>
      </div>
    </div>

    <!-- 新消息通知弹窗 -->
    <div
      class="message-notification"
      id="messageNotification"
      onclick="handleNotificationClick()"
    >
      <div class="notification-avatar" id="notificationAvatar">AI</div>
      <div class="notification-content">
        <div class="notification-name" id="notificationName">角色名</div>
        <div class="notification-text" id="notificationText">消息内容</div>
      </div>
      <div class="notification-time" id="notificationTime">刚刚</div>
    </div>

    <!-- 钱包详情页 -->
    <div class="wallet-page" id="walletPage">
      <div class="wallet-page-header">
        <button class="wallet-page-back" onclick="closeWalletPage()">‹</button>
        <span>我的钱包</span>
        <span style="width: 30px"></span>
      </div>
      <div class="wallet-page-content">
        <div class="wallet-balance-card">
          <div class="wallet-balance-label">账户余额（元）</div>
          <div class="wallet-balance-value" id="walletBalanceDisplay">0.00</div>
          <div class="wallet-balance-actions">
            <button class="wallet-action-btn" onclick="openRechargeModal()">
              <span>💳</span>
              <span>充值</span>
            </button>
          </div>
        </div>
        <div class="wallet-history-section">
          <div class="wallet-history-title">交易记录</div>
          <div class="wallet-history-list" id="walletHistoryListPage">
            <div class="wallet-history-empty">暂无交易记录</div>
          </div>
        </div>
      </div>
    </div>
    <!-- 删除交易记录弹窗 -->
    <div
      class="recharge-modal"
      id="deleteHistoryModal"
      onclick="if(event.target===this)closeDeleteHistoryModal()"
    >
      <div class="recharge-modal-content" style="padding: 20px">
        <div class="recharge-modal-title" style="margin-bottom: 16px">
          🗑️ 删除交易记录
        </div>
        <div
          id="deleteHistoryInfo"
          style="
            background: #f5f5f5;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 16px;
            font-size: 0.9rem;
          "
        >
          <!-- 动态填充 -->
        </div>
        <div style="margin-bottom: 16px">
          <label
            style="
              display: flex;
              align-items: center;
              gap: 10px;
              padding: 12px;
              background: #fff5f5;
              border-radius: 10px;
              cursor: pointer;
            "
          >
            <input
              type="checkbox"
              id="deleteAdjustBalance"
              style="width: 18px; height: 18px; accent-color: #ec407a"
            />
            <div>
              <div style="font-weight: 500; color: #333">同时调整余额</div>
              <div style="font-size: 0.8rem; color: #999">
                勾选后将撤销这笔交易对余额的影响
              </div>
            </div>
          </label>
        </div>
        <div style="display: flex; gap: 12px">
          <button
            onclick="closeDeleteHistoryModal()"
            style="
              flex: 1;
              padding: 12px;
              border-radius: 10px;
              border: 1px solid #ddd;
              background: #fff;
              font-size: 0.95rem;
              cursor: pointer;
            "
          >
            取消
          </button>
          <button
            onclick="confirmDeleteHistory()"
            style="
              flex: 1;
              padding: 12px;
              border-radius: 10px;
              border: none;
              background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
              color: #fff;
              font-size: 0.95rem;
              cursor: pointer;
            "
          >
            删除
          </button>
        </div>
      </div>
    </div>

    <!-- 充值弹窗 -->
    <div
      class="recharge-modal"
      id="rechargeModal"
      onclick="if(event.target===this)closeRechargeModal()"
    >
      <div class="recharge-modal-content">
        <div class="recharge-modal-title">¥ 钱包充值</div>
        <div class="recharge-amount-grid">
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(10)"
          >
            ¥10
          </button>
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(50)"
          >
            ¥50
          </button>
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(100)"
          >
            ¥100
          </button>
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(200)"
          >
            ¥200
          </button>
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(500)"
          >
            ¥500
          </button>
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(1000)"
          >
            ¥1000
          </button>
        </div>
        <input
          type="number"
          class="recharge-custom-input"
          id="rechargeCustomAmount"
          placeholder="自定义金额"
          oninput="clearRechargeSelection()"
        />
        <div class="recharge-modal-btns">
          <button
            class="recharge-modal-btn cancel"
            onclick="closeRechargeModal()"
          >
            取消
          </button>
          <button
            class="recharge-modal-btn confirm"
            onclick="confirmRecharge()"
          >
            确认充值
          </button>
        </div>
      </div>
    </div>

    <!-- 转账弹窗 -->
    <div
      class="send-transfer-modal"
      id="sendTransferModal"
      onclick="if(event.target===this)closeTransferModal()"
    >
      <div class="send-transfer-modal-content">
        <div class="send-transfer-title">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="vertical-align: middle; margin-right: 6px"
          >
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path
              d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
            ></path></svg
          >转账给TA
        </div>
        <div class="send-transfer-to" id="transferToName">转给：角色名</div>
        <!-- 群聊成员选择列表 -->
        <div
          id="transferMemberSelect"
          style="
            display: none;
            margin: 12px 0;
            max-height: 150px;
            overflow-y: auto;
          "
        ></div>
        <input
          type="number"
          class="send-transfer-input"
          id="transferAmountInput"
          placeholder="0.00"
        />
        <div class="send-transfer-balance" id="transferBalanceHint">
          可用余额：¥0.00
        </div>
        <input
          type="text"
          class="send-transfer-note-input"
          id="transferNoteInput"
          placeholder="添加转账说明（可选）"
        />
        <div class="recharge-modal-btns">
          <button
            class="recharge-modal-btn cancel"
            onclick="closeTransferModal()"
          >
            取消
          </button>
          <button
            class="recharge-modal-btn confirm"
            onclick="confirmTransfer()"
          >
            确认转账
          </button>
        </div>
      </div>
    </div>

    <!-- 位置选择弹窗 -->
    <div
      class="send-transfer-modal"
      id="locationModal"
      onclick="if(event.target===this)closeLocationModal()"
    >
      <div class="send-transfer-modal-content">
        <div class="send-transfer-title">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="vertical-align: middle; margin-right: 6px"
          >
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle></svg
          >发送位置
        </div>
        <div style="margin-bottom: 16px">
          <input
            type="text"
            class="send-transfer-note-input"
            id="locationNameInput"
            placeholder="位置名称，如：星巴克咖啡"
            style="margin-bottom: 8px"
          />
          <input
            type="text"
            class="send-transfer-note-input"
            id="locationAddressInput"
            placeholder="详细地址（可选）"
          />
        </div>
        <div class="recharge-modal-btns">
          <button
            class="recharge-modal-btn cancel"
            onclick="closeLocationModal()"
          >
            取消
          </button>
          <button
            class="recharge-modal-btn confirm"
            onclick="confirmSendLocation()"
          >
            发送位置
          </button>
        </div>
      </div>
    </div>

    <!-- 通话悬浮球 -->
    <div
      class="call-floating-bubble"
      id="callFloatingBubble"
      onclick="restoreCall()"
    >
      <span id="floatingBubbleAvatar"
        ><svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
          ></path></svg
      ></span>
      <img id="floatingBubbleImg" src="" style="display: none" />
    </div>

    <!-- 通话界面 -->
    <div class="call-overlay voice-call" id="callOverlay">
      <!-- 视频通话 - 对方画面（全屏） -->
      <div class="video-main" id="videoMain" onclick="toggleVideoSelf()">
        <img id="videoMainImg" src="" style="display: none" />
        <div class="video-main-placeholder" id="videoMainPlaceholder">
          <div class="avatar-large">
            <span id="videoMainAvatarPlaceholder">AI</span>
            <img id="videoMainAvatarImg" src="" style="display: none" />
          </div>
          <span id="videoMainName">等待接通...</span>
        </div>
      </div>

      <!-- 视频通话 - 我的画面（小窗口，可点击切换） -->
      <div class="video-self" id="videoSelf" onclick="toggleVideoSelf()">
        <img id="videoSelfImg" src="" style="display: none" />
        <div class="video-self-placeholder" id="videoSelfPlaceholder">我</div>
      </div>

      <!-- 新的顶部栏 - 左边最小化按钮，中间头像+名字+时间 -->
      <div class="call-top-bar" id="callTopBar">
        <button
          class="call-minimize-btn"
          onclick="minimizeCall()"
          title="最小化"
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="4 14 10 14 10 20"></polyline>
            <polyline points="20 10 14 10 14 4"></polyline>
            <line x1="14" y1="10" x2="21" y2="3"></line>
            <line x1="3" y1="21" x2="10" y2="14"></line>
          </svg>
        </button>
        <div class="call-top-info">
          <div class="call-top-avatar" id="callTopAvatar">
            <span id="callTopAvatarPlaceholder">AI</span>
            <img id="callTopAvatarImg" src="" style="display: none" />
          </div>
          <div class="call-top-name" id="callTopName">角色名</div>
          <div class="call-top-timer" id="callTopTimer">正在呼叫...</div>
        </div>
      </div>

      <!-- 旧的头像区域（隐藏） -->
      <div
        class="call-avatar-section"
        id="callAvatarSection"
        style="display: none"
      >
        <div class="call-avatar" id="callAvatar">
          <span id="callAvatarPlaceholder">AI</span>
          <img id="callAvatarImg" src="" style="display: none" />
        </div>
        <div class="call-name" id="callName">角色名</div>
        <div class="call-status" id="callStatus">正在呼叫...</div>
        <div class="call-timer" id="callTimer" style="display: none">00:00</div>
      </div>

      <!-- 隐藏的兼容元素 -->
      <span id="videoCallTimer" style="display: none">00:00</span>
      <span id="videoCallName" style="display: none"></span>

      <!-- 对话区域 -->
      <div class="call-conversation" id="callConversation">
        <div class="call-messages-wrapper" id="callMessagesWrapper">
          <!-- 消息会动态添加到这里 -->
        </div>
        <!-- AI正在输入指示器 -->
        <div class="call-typing-indicator" id="callTypingIndicator">
          <span></span><span></span><span></span>
        </div>
      </div>

      <!-- 输入区域 -->
      <div class="call-input-area" id="callInputArea">
        <div class="call-input-row">
          <textarea
            class="call-input"
            id="callInput"
            placeholder="说点什么..."
            rows="1"
            onkeydown="handleCallInputKeydown(event)"
          ></textarea>
          <button class="call-send-btn" onclick="sendCallMessage()">
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </div>
      </div>

      <!-- 按钮区域 -->
      <div class="call-buttons-area">
        <!-- 呼叫中的按钮 -->
        <div class="call-buttons" id="callCallingBtns">
          <button class="call-btn end-call" onclick="endCall()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
        </div>

        <!-- 来电的按钮 -->
        <div
          class="call-incoming-buttons"
          id="callIncomingBtns"
          style="display: none"
        >
          <button class="call-btn end-call" onclick="declineCall()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
          <button class="call-btn accept-call" onclick="acceptCall()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
        </div>

        <!-- 通话中的按钮 - 重回、挂断、扬声器 -->
        <div class="call-buttons" id="callInCallBtns" style="display: none">
          <button
            class="call-btn reroll-btn"
            onclick="rerollCallResponse()"
            title="重新回复"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="23 4 23 10 17 10"></polyline>
              <polyline points="1 20 1 14 7 14"></polyline>
              <path
                d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
              ></path>
            </svg>
          </button>
          <button class="call-btn end-call" onclick="endCall()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
          <button
            class="call-btn speaker-btn"
            id="speakerBtn"
            onclick="toggleSpeaker()"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
              <path
                d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- 来电全屏界面 -->
    <div class="incoming-call-overlay" id="incomingCallOverlay">
      <div class="incoming-call-top">
        <div class="incoming-call-label">来电</div>
        <div class="incoming-call-avatar-wrap">
          <div class="incoming-call-ring"></div>
          <div class="incoming-call-ring"></div>
          <div class="incoming-call-ring"></div>
          <div class="incoming-call-avatar" id="incomingCallAvatar">
            <span id="incomingCallAvatarPlaceholder">AI</span>
            <img id="incomingCallAvatarImg" src="" style="display: none" />
          </div>
        </div>
        <div class="incoming-call-name" id="incomingCallName">角色名</div>
        <div class="incoming-call-type" id="incomingCallType">
          <span class="incoming-call-type-icon" id="incomingCallTypeIcon"
            ><svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path></svg
          ></span>
          <span id="incomingCallTypeText">语音通话</span>
        </div>
      </div>

      <div class="incoming-call-actions">
        <div class="incoming-call-btn-wrap">
          <button
            class="incoming-call-btn decline"
            onclick="declineIncomingCall()"
          >
            <svg
              width="28"
              height="28"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
          <span class="incoming-call-btn-label">拒绝</span>
        </div>
        <div class="incoming-call-btn-wrap">
          <button
            class="incoming-call-btn accept"
            onclick="acceptIncomingCall()"
          >
            <svg
              width="28"
              height="28"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
          <span class="incoming-call-btn-label">接听</span>
        </div>
      </div>
    </div>

    <!-- 发送图片选择弹窗 -->
    <div
      class="send-image-modal"
      id="sendImageModal"
      onclick="if(event.target===this)closeSendImageModal()"
    >
      <div class="send-image-options">
        <div class="send-image-title">发送图片</div>
        <div class="send-image-grid two-cols">
          <div class="send-image-item" onclick="selectRealImage()">
            <div class="send-image-icon album">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
            </div>
            <span class="send-image-label">选择图片</span>
            <span class="send-image-hint">相册/拍照/文件</span>
          </div>
          <div class="send-image-item" onclick="openDescImageModal()">
            <div class="send-image-icon desc">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                ></path>
                <path
                  d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                ></path>
              </svg>
            </div>
            <span class="send-image-label">描述图</span>
            <span class="send-image-hint">用文字描述图片</span>
          </div>
        </div>
        <button class="send-image-cancel" onclick="closeSendImageModal()">
          取消
        </button>
      </div>
    </div>

    <!-- 语音消息弹窗 -->
    <div
      class="send-image-modal"
      id="voiceMessageModal"
      onclick="if(event.target===this)closeVoiceMessageModal()"
    >
      <div class="send-image-options" style="max-width: 320px">
        <div class="send-image-title">🎤 发送语音消息</div>
        <div style="padding: 0 20px 20px">
          <div
            style="
              width: 60px;
              height: 60px;
              margin: 0 auto 16px;
              background: linear-gradient(135deg, #fce4ec, #f8bbd9);
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            <svg
              width="30"
              height="30"
              viewBox="0 0 24 24"
              fill="none"
              stroke="#ec407a"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"
              ></path>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
              <line x1="12" y1="19" x2="12" y2="23"></line>
              <line x1="8" y1="23" x2="16" y2="23"></line>
            </svg>
          </div>
          <textarea
            id="voiceMessageInput"
            placeholder="输入你想说的话..."
            style="
              width: 100%;
              height: 80px;
              border: 2px solid rgba(236, 64, 122, 0.2);
              border-radius: 12px;
              padding: 12px;
              font-size: 1rem;
              resize: none;
              box-sizing: border-box;
              outline: none;
              font-family: inherit;
            "
            onfocus="this.style.borderColor='#f48fb1'"
            onblur="this.style.borderColor='rgba(236,64,122,0.2)'"
          ></textarea>
          <div
            style="
              text-align: center;
              font-size: 0.8rem;
              color: #999;
              margin: 10px 0 16px;
            "
          >
            输入内容会转换成语音消息发送
          </div>
          <div style="display: flex; gap: 12px">
            <button
              onclick="closeVoiceMessageModal()"
              style="
                flex: 1;
                padding: 12px;
                border-radius: 12px;
                font-size: 1rem;
                background: #f5f5f5;
                color: #666;
                border: none;
                cursor: pointer;
              "
            >
              取消
            </button>
            <button
              onclick="sendVoiceMessage()"
              style="
                flex: 1;
                padding: 12px;
                border-radius: 12px;
                font-size: 1rem;
                background: linear-gradient(135deg, #f48fb1, #ec407a);
                color: #fff;
                border: none;
                cursor: pointer;
                box-shadow: 0 4px 12px rgba(236, 64, 122, 0.3);
              "
            >
              发送语音
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- 图片描述查看/编辑弹窗 -->
    <div
      class="image-desc-modal"
      id="imageDescModal"
      onclick="if(event.target===this)closeImageDescModal()"
    >
      <div class="image-desc-content">
        <div class="image-desc-header">
          <span class="image-desc-title" id="imageDescTitle">图片描述</span>
          <button class="image-desc-close" onclick="closeImageDescModal()">
            ✕
          </button>
        </div>
        <div class="image-desc-body">
          <div class="image-desc-preview" id="imageDescPreview">
            <div class="image-desc-preview-icon">
              <svg
                width="40"
                height="40"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
              <span style="font-size: 0.8rem">点击查看描述</span>
            </div>
          </div>
          <!-- 查看模式 -->
          <div
            class="image-desc-text"
            id="imageDescText"
            style="display: none"
          ></div>
          <!-- 编辑模式 -->
          <textarea
            class="image-desc-input"
            id="imageDescInput"
            placeholder="描述这张图片的内容...&#10;例如：一张夕阳下海边的照片，金色的阳光洒在海面上..."
            style="display: none"
          ></textarea>
        </div>
        <div
          class="image-desc-footer"
          id="imageDescFooter"
          style="display: none"
        >
          <button class="image-desc-btn cancel" onclick="closeImageDescModal()">
            取消
          </button>
          <button
            class="image-desc-btn confirm"
            onclick="confirmSendDescImage()"
          >
            发送
          </button>
        </div>
      </div>
    </div>

    <!-- 图片查看弹窗 -->
    <div
      class="image-desc-modal"
      id="imageViewModal"
      onclick="closeImageViewModal()"
    >
      <div style="max-width: 90%; max-height: var(--vh-80)">
        <img
          id="imageViewImg"
          src=""
          style="max-width: 100%; max-height: var(--vh-80); border-radius: 12px"
        />
      </div>
    </div>

    <!-- 隐藏的图片输入 -->
    <input
      type="file"
      id="realImageInput"
      hidden
      accept="image/*"
      onchange="handleRealImageSelect(this)"
    />

    <!-- 群公告弹窗 -->
    <div
      class="group-announcement-modal"
      id="groupAnnouncementModal"
      onclick="if(event.target===this)closeGroupAnnouncementModal()"
    >
      <div class="group-announcement-content">
        <div class="group-announcement-header">
          <span class="group-announcement-title">📢 群公告</span>
          <button
            class="group-announcement-close"
            onclick="closeGroupAnnouncementModal()"
          >
            ✕
          </button>
        </div>
        <div class="group-announcement-body">
          <textarea
            class="group-announcement-input"
            id="groupAnnouncementInput"
            placeholder="输入群公告内容...&#10;群成员和AI都可以看到这个公告"
          ></textarea>
        </div>
        <div class="group-announcement-footer">
          <button
            class="group-announcement-btn cancel"
            onclick="closeGroupAnnouncementModal()"
          >
            取消
          </button>
          <button
            class="group-announcement-btn confirm"
            onclick="saveGroupAnnouncement()"
          >
            保存
          </button>
        </div>
      </div>
    </div>
    <!-- 一起听歌页面 -->
    <div class="music-together-page" id="musicTogetherPage">
      <div class="music-header">
        <button class="music-header-back" onclick="closeMusicTogether()">
          ←
        </button>
        <div class="music-header-title">🎵 一起听歌</div>
        <div style="width: 36px"></div>
      </div>

      <div class="music-content">
        <!-- 当前播放 -->
        <div
          class="current-music-section"
          id="currentMusicSection"
          style="display: none"
        >
          <div class="music-player-info">
            <div class="music-cover-wrapper">
              <span class="music-cover-placeholder">🎵</span>
            </div>
            <div class="music-meta">
              <div id="musicName">歌曲名称</div>
              <div id="musicArtist">歌手</div>
            </div>
          </div>

          <!-- 播放控制 -->
          <div class="music-controls">
            <button
              class="music-ctrl-btn small"
              id="playModeBtn"
              onclick="togglePlayMode()"
              title="播放模式"
            >
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="17 1 21 5 17 9"></polyline>
                <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
                <polyline points="7 23 3 19 7 15"></polyline>
                <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
              </svg>
            </button>
            <button class="music-ctrl-btn" onclick="playPrevMusic()">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <polygon points="19 20 9 12 19 4 19 20"></polygon>
                <line
                  x1="5"
                  y1="19"
                  x2="5"
                  y2="5"
                  stroke="currentColor"
                  stroke-width="2"
                ></line>
              </svg>
            </button>
            <button
              class="music-ctrl-btn music-play-btn"
              id="musicPlayBtn"
              onclick="toggleMusicPlay()"
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <polygon points="5 3 19 12 5 21 5 3"></polygon>
              </svg>
            </button>
            <button class="music-ctrl-btn" onclick="playNextMusic()">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <polygon points="5 4 15 12 5 20 5 4"></polygon>
                <line
                  x1="19"
                  y1="5"
                  x2="19"
                  y2="19"
                  stroke="currentColor"
                  stroke-width="2"
                ></line>
              </svg>
            </button>
            <button
              class="music-ctrl-btn small"
              onclick="stopMusic()"
              title="停止"
            >
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <rect x="6" y="6" width="12" height="12" rx="1"></rect>
              </svg>
            </button>
          </div>

          <!-- 进度条 -->
          <div class="music-progress-section">
            <div class="music-progress-bar" onclick="seekMusic(event)">
              <div class="music-progress-fill" id="musicProgressFill"></div>
            </div>
            <div class="music-time">
              <span id="musicCurrentTime">0:00</span>
              <span id="musicDuration">0:00</span>
            </div>
          </div>

          <!-- 歌词区域 -->
          <div class="music-lyrics-section">
            <div class="music-lyrics-header">
              <span class="music-lyrics-title">📝 歌词</span>
              <button class="music-lyrics-edit" onclick="openEditLyricsModal()">
                编辑歌词
              </button>
            </div>
            <div class="music-lyrics-container" id="musicLyricsContainer">
              <div class="lyric-empty">暂无歌词</div>
            </div>
          </div>

          <!-- 操作按钮 -->
          <div class="music-actions">
            <button
              class="music-action-btn primary"
              onclick="startFloatingLyric()"
            >
              🎤 桌面歌词
            </button>
          </div>
        </div>

        <!-- 音乐库 -->
        <div class="music-library-section">
          <div class="music-library-header">
            <div class="music-section-title">🎧 我的音乐库</div>
            <button class="music-add-btn" onclick="openMusicImportModal()">
              + 导入
            </button>
          </div>
          <div class="music-library-list" id="musicLibraryList">
            <!-- 动态渲染 -->
          </div>
        </div>
      </div>
    </div>

    <!-- 导入音乐弹窗 -->
    <div
      class="music-import-modal"
      id="musicImportModal"
      onclick="if(event.target===this)closeMusicImportModal()"
    >
      <div class="music-import-content">
        <div class="music-import-header">
          <div class="music-import-title">🎵 导入音乐</div>
        </div>
        <div class="music-import-body">
          <div class="import-form-group">
            <label class="import-form-label"
              >歌曲名称 <span class="required">*</span></label
            >
            <input
              type="text"
              class="import-form-input"
              id="importMusicName"
              placeholder="输入歌曲名称"
              oninput="checkImportValid()"
            />
          </div>
          <div class="import-form-group">
            <label class="import-form-label">歌手/艺术家</label>
            <input
              type="text"
              class="import-form-input"
              id="importMusicArtist"
              placeholder="输入歌手名（可选）"
            />
          </div>
          <div class="import-form-group">
            <label class="import-form-label"
              >音频文件 <span class="required">*</span></label
            >
            <div
              class="file-select-btn"
              onclick="document.getElementById('audioFileInput').click()"
            >
              <div class="file-select-icon">🎵</div>
              <div class="file-select-info">
                <div class="file-select-name" id="selectedAudioName">
                  点击选择音频文件
                </div>
                <div class="file-select-hint">支持 MP3、M4A、WAV 格式</div>
              </div>
            </div>
            <input
              type="file"
              id="audioFileInput"
              hidden
              accept=".mp3,.m4a,.wav,.flac,.ogg,audio/*"
              onchange="handleAudioFileSelect(this)"
            />
          </div>
          <div class="import-form-group">
            <label class="import-form-label">歌词文件（可选）</label>
            <div
              class="file-select-btn"
              onclick="document.getElementById('lrcFileInput').click()"
            >
              <div class="file-select-icon">📝</div>
              <div class="file-select-info">
                <div class="file-select-name" id="selectedLrcName">
                  点击选择（可选）
                </div>
                <div class="file-select-hint">支持 LRC 格式歌词文件</div>
              </div>
              <button
                class="file-clear-btn"
                onclick="event.stopPropagation(); clearSelectedLrc()"
              >
                ✕
              </button>
            </div>
            <input
              type="file"
              id="lrcFileInput"
              hidden
              accept=".lrc,.txt"
              onchange="handleLrcFileSelect(this)"
            />
          </div>
        </div>
        <div class="music-import-footer">
          <button class="import-btn cancel" onclick="closeMusicImportModal()">
            取消
          </button>
          <button
            class="import-btn confirm"
            id="importMusicConfirmBtn"
            onclick="confirmImportMusic()"
            disabled
          >
            导入
          </button>
        </div>
      </div>
    </div>

    <!-- 桌面歌词（纯文字悬浮） -->
    <div class="desktop-lyric" id="desktopLyric">
      <div class="desktop-lyric-text" id="desktopLyricText">♪ ♪ ♪</div>
      <button class="desktop-lyric-close" onclick="hideFloatingLyric()">
        ✕
      </button>
    </div>

    <!-- 编辑歌词弹窗 -->
    <div
      class="edit-lyrics-modal"
      id="editLyricsModal"
      onclick="if(event.target===this)closeEditLyricsModal()"
    >
      <div class="edit-lyrics-content">
        <div class="edit-lyrics-header">
          <span class="edit-lyrics-title">📝 编辑歌词</span>
          <button class="edit-lyrics-close" onclick="closeEditLyricsModal()">
            ✕
          </button>
        </div>
        <div class="edit-lyrics-body">
          <div class="lyrics-format-hint">
            支持 LRC 格式，例如：<br />
            [00:00.00] 歌词第一句<br />
            [00:05.20] 歌词第二句
          </div>
          <button
            class="lyrics-import-btn"
            onclick="document.getElementById('editLrcFileInput').click()"
          >
            📂 导入 LRC 文件
          </button>
          <input
            type="file"
            id="editLrcFileInput"
            hidden
            accept=".lrc,.txt"
            onchange="importLyricsToEdit(this)"
          />
          <textarea
            id="editLyricsTextarea"
            placeholder="在此粘贴或输入歌词..."
          ></textarea>
        </div>
        <div class="edit-lyrics-footer">
          <button class="lyrics-btn cancel" onclick="closeEditLyricsModal()">
            取消
          </button>
          <button class="lyrics-btn save" onclick="saveEditedLyrics()">
            保存
          </button>
        </div>
      </div>
    </div>
    <script src="phone_peek.js"></script>
    <script src="music_together.js"></script>
    <!-- 论坛帖子详情 -->
    <div class="forum-detail-overlay" id="forumDetailOverlay">
      <div class="forum-detail-header">
        <button class="forum-detail-back" onclick="closeForumPostDetail()">
          ←
        </button>
        <div class="forum-detail-title">帖子详情</div>
        <div style="width: 36px"></div>
      </div>
      <div class="forum-detail-content" id="forumDetailContent"></div>
      <div
        class="forum-reply-indicator"
        id="forumReplyIndicator"
        style="display: none"
      ></div>
      <div class="forum-comment-bar">
        <input
          type="text"
          class="forum-comment-input"
          id="forumCommentInput"
          placeholder="写评论..."
        />
        <button
          class="forum-comment-refresh"
          onclick="generateMoreComments()"
          title="生成更多互动"
        >
          💬
        </button>
        <button class="forum-comment-send" onclick="submitForumComment()">
          发送
        </button>
      </div>
    </div>

    <!-- 论坛设置 -->
    <div class="forum-settings-overlay" id="forumSettingsOverlay">
      <div class="forum-settings-header">
        <button class="forum-settings-back" onclick="closeForumSettings()">
          ←
        </button>
        <div class="forum-settings-title">论坛设置</div>
        <div style="width: 36px"></div>
      </div>
      <div class="forum-settings-content" id="forumSettingsContent"></div>
    </div>

    <!-- 论坛发帖 -->
    <div class="forum-compose-overlay" id="forumComposeOverlay">
      <div class="forum-compose-header">
        <button class="forum-compose-cancel" onclick="closeForumCompose()">
          取消
        </button>
        <div class="forum-compose-title">发帖</div>
        <button class="forum-compose-submit" onclick="submitForumPost()">
          发布
        </button>
      </div>
      <div class="forum-compose-body">
        <div class="forum-compose-user-info" id="forumComposeUserInfo"></div>
        <textarea
          class="forum-compose-textarea"
          id="forumComposeTextarea"
          placeholder="分享你的想法...&#10;&#10;💡 图片提示：&#10;• 点击下方📷添加真实图片&#10;• 或输入 [图片:描述] 添加描述图"
        ></textarea>
        <div class="forum-compose-images" id="forumComposeImages"></div>
        <div class="forum-compose-toolbar">
          <button
            class="forum-compose-tool-btn"
            onclick="document.getElementById('forumComposeImageInput').click()"
            title="添加图片"
          >
            <svg
              viewBox="0 0 24 24"
              width="22"
              height="22"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
          </button>
          <button
            class="forum-compose-tool-btn"
            onclick="insertImagePlaceholder()"
            title="添加图片描述"
          >
            <svg
              viewBox="0 0 24 24"
              width="22"
              height="22"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
              ></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="12" y1="18" x2="12" y2="12"></line>
              <line x1="9" y1="15" x2="15" y2="15"></line>
            </svg>
          </button>
        </div>
        <input
          type="file"
          id="forumComposeImageInput"
          accept="image/*"
          multiple
          style="display: none"
          onchange="handleComposeImageUpload(this)"
        />
      </div>
    </div>

    <script src="continue_chat.js"></script>
    <script src="forum_app.js"></script>
    <!-- 查手机页面 -->
    <div class="phone-peek-page" id="phonePeekPage">
      <button class="phone-peek-close" onclick="closePhonePeek()">✕</button>

      <!-- 手机外壳 -->
      <div class="phone-device">
        <div class="phone-screen">
          <!-- 灵动岛 -->
          <div class="phone-dynamic-island"></div>

          <!-- 状态栏 -->
          <div class="phone-statusbar">
            <div class="phone-statusbar-left" id="phoneTime">9:41</div>
            <div class="phone-statusbar-center"></div>
            <div class="phone-statusbar-right">
              <span class="status-icon">
                <svg width="18" height="12" viewBox="0 0 18 12" fill="white">
                  <path
                    d="M1 4.5C1 3.67 1.67 3 2.5 3h2C5.33 3 6 3.67 6 4.5v3C6 8.33 5.33 9 4.5 9h-2C1.67 9 1 8.33 1 7.5v-3z"
                    fill-opacity="0.35"
                  />
                  <path
                    d="M1 4.5C1 3.67 1.67 3 2.5 3h2C5.33 3 6 3.67 6 4.5v3C6 8.33 5.33 9 4.5 9h-2C1.67 9 1 8.33 1 7.5v-3z"
                  />
                  <path
                    d="M7 5C7 4.17 7.67 3.5 8.5 3.5h2c.83 0 1.5.67 1.5 1.5v2.5c0 .83-.67 1.5-1.5 1.5h-2C7.67 9 7 8.33 7 7.5V5z"
                    fill-opacity="0.35"
                  />
                  <path
                    d="M7 5C7 4.17 7.67 3.5 8.5 3.5h2c.83 0 1.5.67 1.5 1.5v2.5c0 .83-.67 1.5-1.5 1.5h-2C7.67 9 7 8.33 7 7.5V5z"
                  />
                  <path
                    d="M13 5.5c0-.83.67-1.5 1.5-1.5h1c.83 0 1.5.67 1.5 1.5v2c0 .83-.67 1.5-1.5 1.5h-1c-.83 0-1.5-.67-1.5-1.5v-2z"
                    fill-opacity="0.35"
                  />
                  <path
                    d="M13 5.5c0-.83.67-1.5 1.5-1.5h1c.83 0 1.5.67 1.5 1.5v2c0 .83-.67 1.5-1.5 1.5h-1c-.83 0-1.5-.67-1.5-1.5v-2z"
                  />
                </svg>
              </span>
              <span class="status-icon">
                <svg width="25" height="12" viewBox="0 0 25 12" fill="white">
                  <rect
                    x="0.5"
                    y="0.5"
                    width="21"
                    height="11"
                    rx="2.5"
                    stroke="white"
                    stroke-opacity="0.35"
                    fill="none"
                  />
                  <rect
                    x="2"
                    y="2"
                    width="17"
                    height="8"
                    rx="1.5"
                    fill="white"
                  />
                  <path
                    d="M23 4v4c.83-.6 1.33-1.5 1.33-2s-.5-1.4-1.33-2z"
                    fill="white"
                    fill-opacity="0.4"
                  />
                </svg>
              </span>
            </div>
          </div>

          <!-- 手机主体 -->
          <div class="phone-body">
            <!-- App头部（进入App后显示） -->
            <div class="phone-app-header" id="phoneAppHeader">
              <button class="phone-app-back" onclick="showPhoneHome()">
                ‹
              </button>
              <div class="phone-app-title">App</div>
              <div class="phone-app-header-spacer"></div>
            </div>

            <!-- 内容区 -->
            <div class="phone-content" id="phoneContent">
              <!-- 动态渲染 -->
            </div>
          </div>

          <!-- 底部横条 -->
          <div class="phone-home-indicator"></div>
        </div>
      </div>
    </div>
    <script>
      // 注册 Service Worker
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("./sw.js")
            .then((registration) => {
              console.log("Service Worker 注册成功，范围:", registration.scope);
            })
            .catch((err) => {
              console.log("Service Worker 注册失败:", err);
            });
        });
      }

      // 请求通知权限（必须点“允许”才能弹窗）
      function requestNotificationPermission() {
        if ("Notification" in window) {
          Notification.requestPermission().then((permission) => {
            if (permission === "granted") {
              console.log("通知权限已获取");
              if (window.showToast) window.showToast("通知权限已开启");
            }
          });
        }
      }

      // 可以在用户首次点击页面任意位置时触发申请权限，或者做一个专门的按钮
      document.body.addEventListener("click", requestNotificationPermission, {
        once: true,
      });
    </script>
  </body>
</html>
