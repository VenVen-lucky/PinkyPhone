<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <!-- 设置主题颜色，让状态栏区域与背景一致 -->
    <meta name="theme-color" content="#fce4ec" />
    <title>SillyTavern</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;600;700&family=Satisfy&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js?v=1.4"></script>
    <style>
            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
              -webkit-tap-highlight-color: transparent;
              -webkit-touch-callout: none;
              -webkit-user-select: none;
              user-select: none;
            }

            :root {
              --bg-pink: #fce4ec;
              --bg-dots: #f8bbd9;
              --card-bg: rgba(255, 255, 255, 0.85);
              --text-primary: #37474f;
              --text-secondary: #78909c;
              --text-hint: #b0bec5;
              --accent-pink: #f48fb1;
              --accent-green: #c5e1a5;
              --shadow: rgba(0, 0, 0, 0.08);
            }

            html {
              height: 100%;
              -webkit-text-size-adjust: 100%;
              background: #fce4ec;
            }

            body {
              margin: 0;
              height: 100%;
              overflow: hidden;
              font-family: "Noto Sans SC", -apple-system, BlinkMacSystemFont,
                sans-serif;
              background: var(--bg-pink);
            }

            /* Polka dot background */
            body::before {
              content: "";
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background-image: radial-gradient(
                var(--bg-dots) 1.5px,
                transparent 1.5px
              );
              background-size: 20px 20px;
              opacity: 0.5;
              pointer-events: none;
              z-index: 0;
            }

            /* Decorative stars */
            .star {
              position: absolute;
              opacity: 0.15;
              pointer-events: none;
              z-index: 0;
            }

            .star::before {
              content: "★";
              font-size: 40px;
              color: #ec407a;
            }

            .star-1 {
              top: 60%;
              left: 10%;
            }
            .star-2 {
              top: 70%;
              right: 15%;
              transform: scale(0.7);
            }
            .star-3 {
              top: 50%;
              left: 50%;
              transform: scale(0.5);
            }
            .star-4 {
              top: 75%;
              left: 30%;
              transform: scale(0.6);
            }
            .star-5 {
              top: 65%;
              right: 25%;
              transform: scale(0.8);
            }

            .phone-container {
              width: 100%;
              height: 100vh;
              position: relative;
              overflow: hidden;
              display: flex;
              flex-direction: column;
              z-index: 1;
              background: var(--bg-pink);
              /* 确保没有顶部边框或阴影 */
              border: none;
              box-shadow: none;
            }

            /* Main scrollable content */
            .main-content {
              flex: 1;
              padding: 16px;
              padding-top: max(16px, env(safe-area-inset-top));
              padding-bottom: calc(90px + env(safe-area-inset-bottom));
              overflow-y: auto;
              overflow-x: hidden;
              /* 确保没有顶部边框或阴影 */
              border: none;
              box-shadow: none;
            }

            /* Top decorative bar - 完全移除 */
            .top-bar {
              display: none !important;
              height: 0 !important;
              margin: 0 !important;
              padding: 0 !important;
              border: none !important;
              box-shadow: none !important;
            }

            .top-bar::after {
              display: none !important;
            }

            /* Profile Card Widget - 创意透明名片 */
            .profile-widget {
              background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.05));
              backdrop-filter: blur(12px) saturate(150%);
              -webkit-backdrop-filter: blur(12px) saturate(150%);
              border-radius: 24px;
              padding: 24px 16px;
              margin-top: 0;
              position: relative;
              border: 1px solid rgba(255, 255, 255, 0.25);
              overflow: hidden;
              box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
            }

            /* 名片布局容器 - 左列 + 头像 + 右列 */
            .profile-card-layout {
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 24px;
            }

            /* 左右两列标签 */
            .profile-tags-column {
              display: flex;
              flex-direction: column;
              gap: 20px;
            }

            /* 中间头像区域 */
            .profile-avatar-center {
              position: relative;
              flex-shrink: 0;
            }

            .profile-avatar {
              width: 72px;
              height: 72px;
              border-radius: 50%;
              cursor: pointer;
              position: relative;
              overflow: hidden;
            }

            .profile-avatar-inner {
              width: 100%;
              height: 100%;
              border-radius: 50%;
              background: rgba(255, 255, 255, 0.5);
              display: flex;
              align-items: center;
              justify-content: center;
              overflow: hidden;
              font-size: 28px;
            }

            .profile-avatar-inner img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }

            /* 四个标签按钮 */
            .profile-tag {
              display: flex;
              align-items: center;
              justify-content: center;
              background: rgba(180, 180, 180, 0.25);
              backdrop-filter: blur(8px);
              -webkit-backdrop-filter: blur(8px);
              border-radius: 22px;
              padding: 14px 20px;
              cursor: pointer;
              transition: all 0.2s ease;
              border: 1px solid rgba(255, 255, 255, 0.2);
              min-width: 105px;
            }

            .profile-tag:active {
              transform: scale(0.96);
              background: rgba(180, 180, 180, 0.35);
            }

            .profile-tag-text {
              font-size: 0.82rem;
              font-weight: 500;
              color: rgba(60, 60, 60, 0.65);
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
              max-width: 70px;
            }

            /* 隐藏旧的profile-info相关样式，保持兼容 */
            .profile-info {
              display: none;
            }

            .profile-name,
            .profile-handle,
            .profile-bio {
              display: none;
            }

            /* 恋爱纪念日小组件 */
            .love-widget {
              background: linear-gradient(135deg, rgba(255,255,255,0.25), rgba(255,255,255,0.08));
              backdrop-filter: blur(12px) saturate(150%);
              -webkit-backdrop-filter: blur(12px) saturate(150%);
              border-radius: 20px;
              padding: 12px;
              position: relative;
              border: 1px solid rgba(255, 255, 255, 0.25);
              overflow: hidden;
              box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
              text-align: center;
              width: 100%;
              aspect-ratio: 1 / 1;
              display: flex;
              flex-direction: column;
              justify-content: center;
              align-items: center;
            }

            .love-widget-bg {
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background-size: cover;
              background-position: center;
              border-radius: 20px;
              z-index: 0;
            }

            .love-widget > *:not(.love-widget-bg) {
              position: relative;
              z-index: 1;
            }

            .love-days-row {
              display: flex;
              align-items: baseline;
              justify-content: center;
              gap: 4px;
              margin-bottom: 10px;
              cursor: pointer;
            }

            .love-days-number {
              font-size: 1.6rem;
              font-weight: 700;
              color: rgba(60, 60, 60, 0.75);
              letter-spacing: 1px;
            }

            .love-days-unit {
              font-size: 0.85rem;
              color: rgba(60, 60, 60, 0.55);
              font-weight: 500;
            }

            .love-avatars-row {
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 0;
              margin-bottom: 10px;
            }

            .love-avatar {
              width: 50px;
              height: 50px;
              border-radius: 50%;
              cursor: pointer;
              overflow: hidden;
              background: rgba(255, 255, 255, 0.5);
              display: flex;
              align-items: center;
              justify-content: center;
              position: relative;
              z-index: 1;
            }

            .love-avatar:first-child {
              margin-right: -8px;
              z-index: 2;
            }

            .love-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }

            .love-avatar-placeholder {
              font-size: 18px;
              color: rgba(180, 180, 180, 0.6);
            }

            .love-title-row {
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 4px;
              margin-bottom: 4px;
              cursor: pointer;
            }

            .love-title-icon {
              font-size: 11px;
              opacity: 0.7;
            }

            .love-title-text {
              font-size: 0.75rem;
              color: rgba(60, 60, 60, 0.65);
              font-weight: 500;
            }

            .love-date {
              font-size: 0.7rem;
              color: rgba(60, 60, 60, 0.5);
              cursor: pointer;
            }

            /* 小组件浅色/深色字体模式 */
            .love-widget.text-light .love-days-number,
            .love-widget.text-light .love-days-unit,
            .love-widget.text-light .love-title-text,
            .love-widget.text-light .love-date {
              color: rgba(255, 255, 255, 0.9);
              text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            }

            /* 小组件选项弹窗 */
            .love-widget-options {
              display: flex;
              flex-direction: column;
              gap: 8px;
              margin-top: 12px;
            }

            .love-widget-option {
              display: flex;
              align-items: center;
              gap: 12px;
              padding: 14px 16px;
              background: rgba(200, 200, 200, 0.2);
              border-radius: 12px;
              cursor: pointer;
              transition: background 0.2s;
            }

            .love-widget-option:active {
              background: rgba(200, 200, 200, 0.4);
            }

            .love-widget-option-icon {
              font-size: 18px;
            }

            .profile-location {
              display: none;
            }

            .profile-location::before {
              content: "○";
              font-size: 0.75rem;
            }

            /* Apps Grid */
            .apps-section {
              margin-top: 24px;
            }

            .apps-grid {
              display: grid;
              grid-template-columns: repeat(4, 1fr);
              gap: 20px 12px;
              align-items: start;
            }

            /* 小组件占2x2位置 */
            .widget-2x2 {
              grid-column: span 2;
              grid-row: span 2;
            }

            .app-item {
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 6px;
              cursor: pointer;
              transition: transform 0.2s ease;
            }

            .app-item:active {
              transform: scale(0.9);
            }

            .app-icon {
              width: 60px;
              height: 60px;
              border-radius: 14px;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 0;
              color: transparent;
              background: var(--card-bg);
              backdrop-filter: blur(10px);
              -webkit-backdrop-filter: blur(10px);
              box-shadow: 0 2px 10px var(--shadow);
              position: relative;
              overflow: hidden;
            }

            .app-icon img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }

            .app-icon.gradient-pink {
              background: linear-gradient(135deg, #fce4ec, #f8bbd9);
            }

            .app-icon.gradient-blue {
              background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            }

            .app-icon.gradient-green {
              background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            }

            .app-icon.gradient-purple {
              background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            }

            .app-icon.gradient-orange {
              background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            }

            .app-name {
              font-size: 0.75rem;
              font-weight: 500;
              color: var(--text-primary);
              text-align: center;
              max-width: 70px;
              line-height: 1.2;
            }

            /* Bottom Dock - iOS风格浮动胶囊 */
            .dock {
              position: fixed;
              bottom: 24px;
              left: 50%;
              transform: translateX(-50%);
              width: calc(100% - 40px);
              max-width: 360px;
              padding: 8px 24px;
              background: rgba(255, 255, 255, 0.25);
              backdrop-filter: blur(30px) saturate(180%);
              -webkit-backdrop-filter: blur(30px) saturate(180%);
              border-radius: 26px;
              border: 1px solid rgba(255, 255, 255, 0.3);
              box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
              display: flex;
              justify-content: space-between;
              align-items: center;
              z-index: 100;
            }

            .dock-item {
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 4px;
              cursor: pointer;
              transition: transform 0.2s ease;
              padding: 4px;
            }

            .dock-item:active {
              transform: scale(0.9);
            }

            .dock-icon {
              width: 50px;
              height: 50px;
              border-radius: 14px;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 0;
              color: transparent;
              background: rgba(255, 255, 255, 0.6);
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
              overflow: hidden;
            }

            .dock-icon img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }

            .dock-icon.dock-blue {
              background: linear-gradient(135deg, rgba(227, 242, 253, 0.9), rgba(144, 202, 249, 0.9));
            }

            .dock-icon.dock-purple {
              background: linear-gradient(135deg, rgba(243, 229, 245, 0.9), rgba(206, 147, 216, 0.9));
            }

            .dock-icon.dock-orange {
              background: linear-gradient(135deg, rgba(255, 243, 224, 0.9), rgba(255, 204, 128, 0.9));
            }

            .dock-label {
              font-size: 0.65rem;
              font-weight: 500;
              color: var(--text-primary);
              text-align: center;
              max-width: 60px;
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
            }

            /* Hidden input */
            .hidden-input {
              display: none;
            }

            /* Page views */
            .page {
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: var(--bg-pink);
              z-index: 200;
              padding: 16px;
              padding-top: max(16px, env(safe-area-inset-top));
              padding-bottom: calc(20px + env(safe-area-inset-bottom));
              overflow-y: auto;
              /* 确保没有顶部边框或阴影 */
              border: none;
              box-shadow: none;
            }

            .page::before {
              content: "";
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background-image: radial-gradient(
                var(--bg-dots) 1.5px,
                transparent 1.5px
              );
              background-size: 20px 20px;
              opacity: 0.5;
              pointer-events: none;
              z-index: -1;
              /* 确保伪元素不会在顶部创建任何视觉边界 */
              border: none;
              box-shadow: none;
            }

            .page.active {
              display: block;
              animation: slideUp 0.3s ease-out;
            }

            @keyframes slideUp {
              from {
                opacity: 0;
                transform: translateY(100%);
              }
              to {
                opacity: 1;
                transform: translateY(0);
              }
            }

            .page-header {
              display: flex;
              align-items: center;
              gap: 12px;
              margin-bottom: 20px;
            }

            .back-btn {
              width: 36px;
              height: 36px;
              border-radius: 10px;
              background: var(--card-bg);
              border: none;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 18px;
              cursor: pointer;
              box-shadow: 0 2px 8px var(--shadow);
              transition: transform 0.2s;
              color: #000;
            }

            .back-btn:active {
              transform: scale(0.95);
            }

            .page-title {
              font-size: 1.2rem;
              font-weight: 600;
              color: var(--text-primary);
            }

            .page-content {
              background: var(--card-bg);
              backdrop-filter: blur(20px);
              -webkit-backdrop-filter: blur(20px);
              border-radius: 20px;
              padding: 24px;
              min-height: 150px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: var(--text-secondary);
              font-size: 0.95rem;
              box-shadow: 0 4px 20px var(--shadow);
            }

            /* Edit modal for profile */
            .edit-modal {
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0, 0, 0, 0.4);
              z-index: 300;
              align-items: center;
              justify-content: center;
              padding: 20px;
            }

            .edit-modal.active {
              display: flex;
            }

            .edit-modal-content {
              background: white;
              border-radius: 20px;
              padding: 24px;
              width: 100%;
              max-width: 320px;
              box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            }

            .edit-modal-title {
              font-size: 1.1rem;
              font-weight: 600;
              color: var(--text-primary);
              margin-bottom: 16px;
              text-align: center;
            }

            .edit-input {
              width: 100%;
              padding: 12px 16px;
              border: 1px solid #e0e0e0;
              border-radius: 12px;
              font-size: 0.95rem;
              font-family: inherit;
              margin-bottom: 12px;
              outline: none;
              transition: border-color 0.2s;
            }

            .edit-input:focus {
              border-color: var(--accent-pink);
            }

            .edit-buttons {
              display: flex;
              gap: 10px;
              margin-top: 8px;
            }

            .edit-btn {
              flex: 1;
              padding: 12px;
              border: none;
              border-radius: 12px;
              font-size: 0.9rem;
              font-weight: 600;
              cursor: pointer;
              transition: transform 0.2s;
            }

            .edit-btn:active {
              transform: scale(0.98);
            }

            .edit-btn-cancel {
              background: #f5f5f5;
              color: var(--text-secondary);
            }

            .edit-btn-save {
              background: var(--accent-pink);
              color: white;
            }

            /* Scrollbar hide */
            .main-content::-webkit-scrollbar,
            .page::-webkit-scrollbar {
              display: none;
            }

            .main-content,
            .page {
              -ms-overflow-style: none;
              scrollbar-width: none;
            }

            /* ==================== CHAT APP STYLES ==================== */
            .chat-app {
              display: none;
              flex-direction: column;
              padding: 0 !important;
              background: #fdf5f7 !important;
              background-image: radial-gradient(circle, rgba(244,143,177,0.15) 2px, transparent 2px) !important;
              background-size: 20px 20px !important;
              /* 确保顶部没有白色边框或阴影 */
              border: none !important;
              box-shadow: none !important;
            }

            .chat-app.active {
              display: flex !important;
            }

            .chat-app::before {
              display: none !important;
              content: none !important;
            }

            .chat-header {
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 10px 16px;
              padding-top: max(10px, env(safe-area-inset-top));
              background: transparent;
              border: none;
              position: sticky;
              top: 0;
              z-index: 10;
            }

            .chat-header .back-btn {
              background: rgba(255, 255, 255, 0.6);
              backdrop-filter: blur(10px);
              -webkit-backdrop-filter: blur(10px);
            }

            .chat-title {
              font-size: 1.1rem;
              font-weight: 600;
              color: var(--text-primary);
            }

            .chat-header-btn {
              width: 34px;
              height: 34px;
              border-radius: 10px;
              background: rgba(255, 255, 255, 0.6);
              backdrop-filter: blur(10px);
              -webkit-backdrop-filter: blur(10px);
              border: none;
              font-size: 16px;
              cursor: pointer;
              color: #000;
            }
            .chat-header-btn svg {
              stroke: #000;
            }

            .chat-header-btns {
              display: flex;
              gap: 8px;
              align-items: center;
            }

            /* ==================== 群聊相关样式 ==================== */
            .create-group-modal {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0, 0, 0, 0.5);
              z-index: 600;
              display: none;
              align-items: flex-end;
              justify-content: center;
            }
            .create-group-modal.active {
              display: flex;
            }
            .create-group-content {
              background: #fff;
              width: 100%;
              max-height: 85vh;
              border-radius: 24px 24px 0 0;
              display: flex;
              flex-direction: column;
              animation: slideUpModal 0.3s ease;
            }
            .create-group-header {
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 20px;
              border-bottom: 1px solid #f0f0f0;
            }
            .create-group-title {
              font-size: 1.1rem;
              font-weight: 700;
              color: #c2185b;
            }
            .create-group-close {
              width: 32px;
              height: 32px;
              border: none;
              background: rgba(0,0,0,0.05);
              border-radius: 50%;
              font-size: 16px;
              cursor: pointer;
              color: #666;
            }
            .create-group-body {
              flex: 1;
              overflow-y: auto;
              padding: 20px;
            }
            .create-group-input-section {
              margin-bottom: 20px;
            }
            .create-group-label {
              font-size: 0.85rem;
              font-weight: 600;
              color: #666;
              margin-bottom: 8px;
              display: block;
            }
            .create-group-input {
              width: 100%;
              padding: 12px 16px;
              border: 2px solid #f0f0f0;
              border-radius: 12px;
              font-size: 0.95rem;
              outline: none;
              transition: all 0.2s;
              background: #fafafa;
            }
            .create-group-input:focus {
              border-color: #f48fb1;
              background: white;
            }
            .create-group-avatar-section {
              display: flex;
              align-items: center;
              gap: 16px;
              margin-bottom: 20px;
            }
            .create-group-avatar {
              width: 64px;
              height: 64px;
              border-radius: 16px;
              background: linear-gradient(135deg, #fce4ec, #f8bbd9);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 28px;
              cursor: pointer;
              overflow: hidden;
              border: 2px solid rgba(244, 143, 177, 0.3);
            }
            .create-group-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            .create-group-avatar-hint {
              font-size: 0.85rem;
              color: #999;
            }
            .create-group-members-title {
              font-size: 0.9rem;
              font-weight: 600;
              color: #333;
              margin-bottom: 12px;
              display: flex;
              align-items: center;
              justify-content: space-between;
            }
            .create-group-members-count {
              font-size: 0.8rem;
              color: #f48fb1;
              font-weight: 500;
            }
            .create-group-members-list {
              max-height: 300px;
              overflow-y: auto;
            }
            .create-group-member-item {
              display: flex;
              align-items: center;
              gap: 12px;
              padding: 12px;
              background: #f8f8f8;
              border-radius: 12px;
              margin-bottom: 8px;
              cursor: pointer;
              transition: all 0.2s;
              border: 2px solid transparent;
            }
            .create-group-member-item:active {
              transform: scale(0.98);
            }
            .create-group-member-item.selected {
              border-color: #f48fb1;
              background: #fff5f8;
            }
            .create-group-member-avatar {
              width: 44px;
              height: 44px;
              border-radius: 50%;
              background: linear-gradient(135deg, #fce4ec, #fff0f5);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 18px;
              overflow: hidden;
              flex-shrink: 0;
            }
            .create-group-member-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            .create-group-member-info {
              flex: 1;
              min-width: 0;
            }
            .create-group-member-name {
              font-size: 0.95rem;
              font-weight: 600;
              color: #333;
            }
            .create-group-member-note {
              font-size: 0.75rem;
              color: #999;
              margin-top: 2px;
            }
            .create-group-member-check {
              width: 22px;
              height: 22px;
              border-radius: 50%;
              border: 2px solid #e0e0e0;
              display: flex;
              align-items: center;
              justify-content: center;
              transition: all 0.2s;
              flex-shrink: 0;
            }
            .create-group-member-item.selected .create-group-member-check {
              background: linear-gradient(135deg, #f48fb1, #f06292);
              border-color: transparent;
            }
            .create-group-member-item.selected .create-group-member-check::after {
              content: "✓";
              color: white;
              font-size: 12px;
              font-weight: bold;
            }
            .create-group-empty {
              text-align: center;
              padding: 40px 20px;
              color: #999;
            }
            .create-group-empty-icon {
              font-size: 48px;
              margin-bottom: 12px;
              opacity: 0.5;
            }
            .create-group-footer {
              padding: 16px 20px;
              padding-bottom: calc(16px + env(safe-area-inset-bottom));
              border-top: 1px solid #f0f0f0;
              display: flex;
              gap: 12px;
            }
            .create-group-btn {
              flex: 1;
              padding: 14px;
              border: none;
              border-radius: 12px;
              font-size: 1rem;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
            }
            .create-group-btn.cancel {
              background: #f5f5f5;
              color: #666;
            }
            .create-group-btn.confirm {
              background: linear-gradient(135deg, #f48fb1, #f06292);
              color: white;
              box-shadow: 0 4px 15px rgba(244,143,177,0.4);
            }
            .create-group-btn:disabled {
              opacity: 0.5;
              cursor: not-allowed;
            }

            /* 群聊消息项标识 */
            .message-item.group-chat {
              position: relative;
            }
            .message-item.group-chat .message-avatar {
              position: relative;
            }
            .message-item.group-chat .message-avatar::after {
              content: "";
              position: absolute;
              bottom: 0;
              right: 0;
              width: 10px;
              height: 10px;
              background: linear-gradient(135deg, #f48fb1, #f06292);
              border-radius: 50%;
              border: 1.5px solid white;
            }
            .group-avatar-stack {
              width: 48px;
              height: 48px;
              position: relative;
            }
            .group-avatar-stack .avatar-mini {
              position: absolute;
              width: 28px;
              height: 28px;
              border-radius: 50%;
              border: 2px solid white;
              background: linear-gradient(135deg, #fce4ec, #fff0f5);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 12px;
              overflow: hidden;
            }
            .group-avatar-stack .avatar-mini img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            .group-avatar-stack .avatar-mini:nth-child(1) {
              top: 0;
              left: 0;
              z-index: 3;
            }
            .group-avatar-stack .avatar-mini:nth-child(2) {
              top: 0;
              right: 0;
              z-index: 2;
            }
            .group-avatar-stack .avatar-mini:nth-child(3) {
              bottom: 0;
              left: 50%;
              transform: translateX(-50%);
              z-index: 1;
            }
            .group-avatar-stack .avatar-mini.more {
              background: rgba(0,0,0,0.5);
              color: white;
              font-size: 10px;
              font-weight: 600;
            }

            /* 群聊对话页面 - 消息带头像和名字 */
            .msg-row.ai.group-msg {
              padding-left: 40px;
              position: relative;
            }
            .msg-row.ai.group-msg .msg-sender-avatar {
              position: absolute;
              left: 0;
              top: 0;
              width: 32px;
              height: 32px;
              border-radius: 50%;
              background: linear-gradient(135deg, #fce4ec, #fff0f5);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 14px;
              overflow: hidden;
            }
            .msg-row.ai.group-msg .msg-sender-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            .msg-sender-name {
              font-size: 0.75rem;
              color: #f48fb1;
              margin-bottom: 4px;
              font-weight: 500;
            }

            /* 群聊用户消息样式 */
            .msg-row.user.group-msg {
              padding-right: 40px;
              position: relative;
            }
            .msg-row.user.group-msg .msg-user-avatar {
              position: absolute;
              right: 0;
              top: 0;
              width: 32px;
              height: 32px;
              border-radius: 50%;
              background: linear-gradient(135deg, #f48fb1, #ec407a);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 12px;
              color: white;
              overflow: hidden;
            }
            .msg-row.user.group-msg .msg-user-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }

            /* 群聊设置页面 */
            .group-settings-section {
              background: white;
              border-radius: 16px;
              margin-bottom: 16px;
              overflow: hidden;
            }
            .group-settings-title {
              font-size: 0.85rem;
              font-weight: 600;
              color: #999;
              padding: 12px 16px 8px;
            }
            .group-members-grid {
              display: flex;
              flex-wrap: wrap;
              gap: 12px;
              padding: 12px 16px;
            }
            .group-member-card {
              display: flex;
              flex-direction: column;
              align-items: center;
              width: 60px;
            }
            .group-member-card-avatar {
              width: 48px;
              height: 48px;
              border-radius: 50%;
              background: linear-gradient(135deg, #fce4ec, #fff0f5);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 20px;
              margin-bottom: 6px;
              overflow: hidden;
              position: relative;
            }
            .group-member-card-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            .group-member-card-avatar .remove-btn {
              position: absolute;
              top: -4px;
              right: -4px;
              width: 18px;
              height: 18px;
              background: #ff5252;
              color: white;
              border-radius: 50%;
              font-size: 10px;
              display: none;
              align-items: center;
              justify-content: center;
              cursor: pointer;
            }
            .group-member-card:hover .remove-btn {
              display: flex;
            }
            .group-member-card-name {
              font-size: 0.75rem;
              color: #666;
              text-align: center;
              max-width: 100%;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
            }
            .group-add-member-card {
              width: 48px;
              height: 48px;
              border-radius: 50%;
              background: #f5f5f5;
              border: 2px dashed #ddd;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 24px;
              color: #999;
              cursor: pointer;
              margin-bottom: 6px;
            }
            .group-add-member-card:active {
              background: #eee;
            }

            /* 群聊设置增强样式 */
            #groupChatSettingsPage {
              -webkit-overflow-scrolling: touch;
            }
            #groupChatSettingsPage .settings-content {
              -webkit-overflow-scrolling: touch;
              touch-action: pan-y;
            }
            #groupChatSettingsPage .settings-header {
              position: relative;
              z-index: 10;
            }
            #groupChatSettingsPage .settings-close-btn {
              position: relative;
              z-index: 11;
            }
            .group-settings-member-display {
              background: #fafafa;
              border-radius: 12px;
              padding: 16px;
              margin-top: 12px;
            }
            .group-settings-member-row {
              display: flex;
              flex-wrap: wrap;
              gap: 16px;
              justify-content: flex-start;
            }
            .group-settings-member-item {
              display: flex;
              flex-direction: column;
              align-items: center;
              width: 64px;
            }
            .group-settings-member-avatar {
              width: 52px;
              height: 52px;
              border-radius: 50%;
              background: linear-gradient(135deg, #fce4ec, #fff0f5);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 22px;
              overflow: hidden;
              border: 2px solid white;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            .group-settings-member-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            .group-settings-member-name {
              font-size: 0.75rem;
              color: #666;
              margin-top: 6px;
              text-align: center;
              max-width: 64px;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
            }
            .group-manage-btn {
              width: 100%;
              padding: 14px;
              background: linear-gradient(135deg, #fff0f5, #fce4ec);
              border: 1px solid #f8bbd0;
              border-radius: 12px;
              color: #e91e63;
              font-size: 0.9rem;
              font-weight: 500;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
              margin-top: 12px;
            }
            .group-manage-btn:active {
              background: linear-gradient(135deg, #fce4ec, #f8bbd0);
            }

            /* 实时预览区域 */
            .chat-preview-container {
              background: linear-gradient(135deg, #f5f5f5, #eeeeee);
              border-radius: 16px;
              padding: 16px;
              margin-top: 12px;
            }
            .chat-preview-title {
              font-size: 0.82rem;
              color: #999;
              margin-bottom: 12px;
            }
            .chat-preview-box {
              background: white;
              border-radius: 12px;
              padding: 12px;
              box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            }
            .chat-preview-group-name {
              text-align: center;
              font-size: 0.75rem;
              color: #999;
              margin-bottom: 10px;
            }
            .chat-preview-msg {
              display: flex;
              align-items: flex-start;
              gap: 8px;
              margin-bottom: 10px;
            }
            .chat-preview-msg.user {
              flex-direction: row-reverse;
            }
            .chat-preview-avatar {
              width: 32px;
              height: 32px;
              border-radius: 50%;
              background: linear-gradient(135deg, #fce4ec, #fff0f5);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 14px;
              overflow: hidden;
              flex-shrink: 0;
            }
            .chat-preview-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            .chat-preview-content {
              max-width: 70%;
            }
            .chat-preview-name {
              font-size: 0.7rem;
              color: #999;
              margin-bottom: 3px;
            }
            .chat-preview-msg.user .chat-preview-name {
              text-align: right;
            }
            .chat-preview-bubble {
              padding: 8px 12px;
              border-radius: 12px;
              font-size: 0.82rem;
              background: white;
              border: 1px solid #f0f0f0;
            }
            .chat-preview-msg.user .chat-preview-bubble {
              background: linear-gradient(135deg, #f8bbd0, #f48fb1);
              color: white;
              border: none;
            }
            .chat-preview-time {
              font-size: 0.65rem;
              color: #bbb;
              margin-top: 3px;
            }
            .chat-preview-msg.user .chat-preview-time {
              text-align: right;
            }
            .chat-preview-owner-badge {
              display: inline-block;
              background: linear-gradient(135deg, #f48fb1, #e91e63);
              color: white;
              font-size: 0.6rem;
              padding: 2px 6px;
              border-radius: 8px;
              margin-right: 4px;
            }

            /* 数据操作按钮组 */
            .data-actions-grid {
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 10px;
              margin-top: 12px;
            }
            .data-action-btn {
              padding: 14px 12px;
              border: 1px solid #f0f0f0;
              border-radius: 12px;
              background: white;
              color: #666;
              font-size: 0.85rem;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 6px;
            }
            .data-action-btn:active {
              background: #f5f5f5;
            }
            .data-action-btn.full-width {
              grid-column: 1 / -1;
            }
            .data-action-btn.danger {
              background: #fff5f5;
              color: #f44336;
              border-color: #ffcdd2;
            }
            .data-action-btn.danger:active {
              background: #ffebee;
            }

            .chat-content {
              flex: 1;
              overflow-y: auto;
              padding-bottom: calc(70px + env(safe-area-inset-bottom));
            }

            .chat-tab-content {
              display: none;
              min-height: 100%;
              padding: 0 12px;
            }

            .chat-tab-content.active {
              display: block;
            }

            /* Messages Tab - 搜索栏 */
            .search-bar {
              display: flex;
              align-items: center;
              background: rgba(255, 255, 255, 0.8);
              margin: 12px 4px;
              padding: 10px 14px;
              border-radius: 20px;
              gap: 8px;
              backdrop-filter: blur(10px);
              -webkit-backdrop-filter: blur(10px);
            }

            .search-icon {
              font-size: 14px;
              opacity: 0.5;
            }

            .search-input {
              flex: 1;
              border: none;
              background: none;
              font-size: 0.9rem;
              font-family: inherit;
              outline: none;
            }

            .message-list {
              background: rgba(255, 255, 255, 0.7);
              backdrop-filter: blur(20px);
              -webkit-backdrop-filter: blur(20px);
              border-radius: 24px;
              margin: 8px 4px;
              overflow: hidden;
              box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
              border: 1px solid rgba(255, 255, 255, 0.5);
            }

            /* 分组标题 */
            .message-group {
              margin-bottom: 12px;
            }

            .message-group-header {
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 10px 16px;
              cursor: pointer;
            }

            .message-group-title {
              font-size: 0.85rem;
              font-weight: 600;
              color: var(--text-secondary);
              display: flex;
              align-items: center;
              gap: 6px;
            }

            .message-group-arrow {
              font-size: 12px;
              transition: transform 0.3s ease;
            }

            .message-group.collapsed .message-group-arrow {
              transform: rotate(-90deg);
            }

            .message-group.collapsed .message-group-content {
              display: none;
            }

            .message-group-content {
              background: rgba(255, 255, 255, 0.7);
              backdrop-filter: blur(20px);
              -webkit-backdrop-filter: blur(20px);
              border-radius: 20px;
              margin: 0 4px;
              overflow: hidden;
              box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
              border: 1px solid rgba(255, 255, 255, 0.5);
            }

            /* 置顶消息样式 */
            .message-item.pinned {
              background: rgba(252, 228, 236, 0.3);
            }

            .message-item {
              display: flex;
              align-items: center;
              padding: 14px 16px;
              gap: 12px;
              border-bottom: 1px solid rgba(0, 0, 0, 0.04);
              cursor: pointer;
              transition: background 0.2s;
              position: relative;
            }

            .message-item:last-child {
              border-bottom: none;
            }

            .message-item:active {
              background: rgba(244, 143, 177, 0.1);
            }

            .message-avatar {
              width: 50px;
              height: 50px;
              border-radius: 14px;
              background: linear-gradient(135deg, #fce4ec, #e8f5e9);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 24px;
              flex-shrink: 0;
              overflow: hidden;
            }

            .message-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }

            .message-info {
              flex: 1;
              min-width: 0;
            }

            .message-top {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 4px;
            }

            .message-name {
              font-size: 0.95rem;
              font-weight: 600;
              color: var(--text-primary);
            }

            .message-time {
              font-size: 0.75rem;
              color: var(--text-hint);
            }

            .message-preview {
              font-size: 0.85rem;
              color: var(--text-secondary);
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
            }

            .message-badge {
              background: #ff6b6b;
              color: white;
              font-size: 0.7rem;
              font-weight: 600;
              padding: 2px 7px;
              border-radius: 10px;
              min-width: 18px;
              text-align: center;
            }

            /* Empty State */
            .empty-state {
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              padding: 60px 20px;
              text-align: center;
            }

            .empty-icon {
              font-size: 48px;
              margin-bottom: 16px;
              opacity: 0.6;
              color: var(--text-secondary);
              display: flex;
              align-items: center;
              justify-content: center;
            }

            .empty-icon svg {
              stroke: var(--text-secondary);
            }

            .empty-text {
              font-size: 1rem;
              font-weight: 600;
              color: var(--text-primary);
              margin-bottom: 6px;
            }

            .empty-hint {
              font-size: 0.85rem;
              color: var(--text-hint);
            }

            /* 搜索结果样式 */
            .search-results {
              background: rgba(255, 255, 255, 0.9);
              border-radius: 16px;
              margin: 8px 4px;
              overflow: hidden;
              box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
              display: none;
            }

            .search-results.active {
              display: block;
            }

            .search-result-item {
              padding: 12px 16px;
              border-bottom: 1px solid rgba(0, 0, 0, 0.05);
              cursor: pointer;
            }

            .search-result-item:active {
              background: rgba(244, 143, 177, 0.1);
            }

            .search-result-char {
              font-size: 0.8rem;
              color: var(--accent-pink);
              font-weight: 600;
              margin-bottom: 4px;
            }

            .search-result-content {
              font-size: 0.9rem;
              color: var(--text-primary);
            }

            .search-result-content mark {
              background: rgba(244, 143, 177, 0.3);
              color: inherit;
              padding: 0 2px;
              border-radius: 2px;
            }

            /* ==================== 微信朋友圈风格动态页面 ==================== */
            #momentsTab {
              background: #efefef;
              min-height: 100%;
              padding-bottom: 80px;
            }

            /* Stories 横向滚动区 - 保留但简化 */
            .ig-stories {
              background: #fff;
              padding: 16px 0;
              overflow-x: auto;
              overflow-y: hidden;
              -webkit-overflow-scrolling: touch;
              box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            }
            .ig-stories::-webkit-scrollbar {
              display: none;
            }
            .ig-stories-inner {
              display: flex;
              gap: 16px;
              padding: 0 16px;
            }
            .ig-story-item {
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 6px;
              cursor: pointer;
              flex-shrink: 0;
            }
            .ig-story-ring {
              width: 60px;
              height: 60px;
              border-radius: 50%;
              padding: 2px;
              background: linear-gradient(135deg, #ff9a9e, #fecfef, #fecfef, #a18cd1);
            }
            .ig-story-ring.no-story {
              background: #e0e0e0;
            }
            .ig-story-ring.my-story {
              background: transparent;
              border: 2px dashed #ccc;
              position: relative;
            }
            .ig-story-avatar {
              width: 100%;
              height: 100%;
              border-radius: 50%;
              background: #fff;
              padding: 2px;
              overflow: hidden;
              display: flex;
              align-items: center;
              justify-content: center;
            }
            .ig-story-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
              border-radius: 50%;
            }
            .ig-story-avatar-emoji {
              font-size: 28px;
            }
            .ig-story-add {
              position: absolute;
              bottom: -2px;
              right: -2px;
              width: 20px;
              height: 20px;
              background: linear-gradient(135deg, #667eea, #764ba2);
              border: 2px solid #fff;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              color: #fff;
              font-size: 12px;
              font-weight: 700;
            }
            .ig-story-name {
              font-size: 0.7rem;
              color: #666;
              max-width: 60px;
              text-align: center;
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
            }

            /* 用户个人资料卡片 - 简化版 */
            .ig-profile-card {
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              margin: 12px;
              border-radius: 20px;
              padding: 20px;
              box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
              position: relative;
              overflow: hidden;
            }
            .ig-profile-card::before {
              content: "";
              position: absolute;
              top: -50%;
              right: -50%;
              width: 100%;
              height: 100%;
              background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
              pointer-events: none;
            }
            .ig-profile-header {
              display: flex;
              align-items: center;
              gap: 16px;
              position: relative;
              z-index: 1;
            }
            .ig-profile-avatar-wrap {
              position: relative;
              cursor: pointer;
            }
            .ig-profile-avatar {
              width: 70px;
              height: 70px;
              border-radius: 50%;
              background: rgba(255,255,255,0.9);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 35px;
              overflow: hidden;
              border: 3px solid rgba(255,255,255,0.5);
              box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            }
            .ig-profile-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            .ig-profile-edit-icon {
              position: absolute;
              bottom: 0;
              right: 0;
              width: 24px;
              height: 24px;
              background: #fff;
              border: none;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 11px;
              box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }
            .ig-profile-info {
              flex: 1;
            }
            .ig-profile-name {
              font-size: 1.2rem;
              font-weight: 700;
              color: #fff;
              margin-bottom: 4px;
              text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            }
            .ig-profile-handle {
              font-size: 0.8rem;
              color: rgba(255,255,255,0.8);
            }
            .ig-profile-bio {
              font-size: 0.85rem;
              color: rgba(255,255,255,0.9);
              line-height: 1.5;
              margin-top: 12px;
              white-space: pre-wrap;
              position: relative;
              z-index: 1;
            }

            /* 动态列表 */
            .ig-feed {
              padding: 12px;
              display: flex;
              flex-direction: column;
              gap: 16px;
            }

            /* 单条动态卡片 - 朋友圈风格 */
            .ig-post {
              background: #fff;
              border-radius: 16px;
              box-shadow: 0 2px 12px rgba(0,0,0,0.08);
              overflow: hidden;
              transition: transform 0.2s, box-shadow 0.2s;
            }
            .ig-post:active {
              transform: scale(0.995);
            }
            .ig-post-header {
              display: flex;
              align-items: center;
              padding: 14px 16px;
              gap: 12px;
            }
            .ig-post-avatar {
              width: 44px;
              height: 44px;
              border-radius: 50%;
              background: linear-gradient(135deg, #fce4ec, #fff3e0);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 22px;
              flex-shrink: 0;
              overflow: hidden;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            .ig-post-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            .ig-post-user-info {
              flex: 1;
              min-width: 0;
            }
            .ig-post-username {
              font-size: 0.95rem;
              font-weight: 600;
              color: #333;
            }
            .ig-post-time-header {
              font-size: 0.75rem;
              color: #999;
              margin-top: 2px;
            }
            .ig-post-delete {
              background: none;
              border: none;
              font-size: 1rem;
              cursor: pointer;
              padding: 8px;
              color: #ccc;
              border-radius: 50%;
              opacity: 0.6;
              transition: opacity 0.2s, color 0.2s;
            }
            .ig-post-delete:hover, .ig-post-delete:active {
              opacity: 1;
              color: #ff6b6b;
              background: #fff0f0;
            }
            .ig-post-more {
              background: none;
              border: none;
              font-size: 1.2rem;
              cursor: pointer;
              padding: 8px;
              color: #999;
              border-radius: 50%;
            }
            .ig-post-more:active {
              background: #f5f5f5;
            }

            /* 正文内容 - 在图片上方 */
            .ig-post-content {
              padding: 0 16px 12px;
              font-size: 0.95rem;
              color: #333;
              line-height: 1.6;
            }

            /* 图片区域 */
            .ig-post-images {
              width: 100%;
              background: #f8f8f8;
              overflow: hidden;
            }
            .ig-post-images.single-img {
              max-height: 400px;
            }
            .ig-post-images.single-img img {
              width: 100%;
              height: auto;
              max-height: 400px;
              object-fit: cover;
            }
            .ig-post-images img {
              width: 100%;
              display: block;
            }
            .ig-post-text-img {
              width: 100%;
              min-height: 220px;
              display: flex;
              align-items: center;
              justify-content: center;
              padding: 30px;
              font-size: 1.15rem;
              color: #fff;
              text-align: center;
              line-height: 1.8;
              text-shadow: 0 2px 8px rgba(0,0,0,0.3);
              position: relative;
              overflow: hidden;
            }
            /* 文字配图装饰效果 */
            .ig-post-text-img::before {
              content: "";
              position: absolute;
              width: 150%;
              height: 150%;
              top: -25%;
              left: -25%;
              background-image:
                radial-gradient(circle at 20% 30%, rgba(255,255,255,0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255,255,255,0.1) 0%, transparent 40%),
                radial-gradient(circle at 40% 80%, rgba(255,255,255,0.08) 0%, transparent 30%);
              animation: floatBg 15s ease-in-out infinite;
            }
            .ig-post-text-img::after {
              content: "★";
              position: absolute;
              font-size: 3rem;
              opacity: 0.15;
              right: 15px;
              bottom: 15px;
              filter: blur(1px);
            }
            @keyframes floatBg {
              0%, 100% { transform: translate(0, 0) rotate(0deg); }
              33% { transform: translate(2%, 2%) rotate(1deg); }
              66% { transform: translate(-1%, 1%) rotate(-1deg); }
            }
            .ig-post-text-img .text-content {
              position: relative;
              z-index: 2;
              padding: 20px 24px;
              background: rgba(255,255,255,0.1);
              backdrop-filter: blur(8px);
              -webkit-backdrop-filter: blur(8px);
              border-radius: 16px;
              border: 1px solid rgba(255,255,255,0.2);
              box-shadow: 0 4px 24px rgba(0,0,0,0.1);
              max-width: 90%;
            }
            .ig-post-text-img .text-quote {
              position: absolute;
              top: -8px;
              left: 20px;
              font-size: 2.5rem;
              opacity: 0.4;
              font-family: Georgia, serif;
              line-height: 1;
            }

            /* 互动区域 */
            .ig-post-footer {
              padding: 12px 16px;
              border-top: 1px solid #f0f0f0;
            }
            .ig-post-actions {
              display: flex;
              align-items: center;
              gap: 20px;
            }
            .ig-action-btn {
              background: none;
              border: none;
              font-size: 1.3rem;
              cursor: pointer;
              padding: 6px;
              transition: transform 0.2s;
              display: flex;
              align-items: center;
              gap: 6px;
              color: #666;
              border-radius: 8px;
            }
            .ig-action-btn:active {
              transform: scale(0.9);
              background: #f5f5f5;
            }
            .ig-action-btn.liked {
              color: #ff4757;
            }
            .ig-action-btn.bookmarked {
              color: #f5a623;
            }
            .ig-action-btn span {
              font-size: 0.85rem;
            }
            @keyframes likeAnim {
              0% { transform: scale(1); }
              50% { transform: scale(1.3); }
              100% { transform: scale(1); }
            }
            .ig-action-btn.liked svg, .ig-action-btn.liked {
              animation: likeAnim 0.3s ease;
            }

            /* 点赞信息 */
            .ig-post-likes {
              display: flex;
              align-items: center;
              gap: 6px;
              padding: 10px 0;
              font-size: 0.85rem;
              color: #666;
              border-bottom: 1px solid #f5f5f5;
            }
            .ig-post-likes-avatars {
              display: flex;
              margin-right: 4px;
            }
            .ig-post-likes-avatars .like-avatar {
              width: 22px;
              height: 22px;
              border-radius: 50%;
              border: 2px solid #fff;
              margin-left: -8px;
              background: #f0f0f0;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 11px;
              overflow: hidden;
            }
            .ig-post-likes-avatars .like-avatar:first-child {
              margin-left: 0;
            }
            .ig-post-likes-avatars .like-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }

            /* 评论区 */
            .ig-post-comments {
              padding-top: 10px;
            }
            .ig-comment {
              font-size: 0.9rem;
              color: #333;
              margin-bottom: 8px;
              line-height: 1.5;
              padding: 8px 12px;
              background: #f8f8f8;
              border-radius: 10px;
            }
            .ig-comment .username {
              font-weight: 600;
              color: #667eea;
              margin-right: 8px;
            }
            .ig-view-comments {
              font-size: 0.85rem;
              color: #999;
              padding: 8px 0;
              cursor: pointer;
            }

            /* 发布按钮 */
            .ig-fab {
              position: fixed;
              bottom: 100px;
              right: 20px;
              width: 56px;
              height: 56px;
              border-radius: 50%;
              background: linear-gradient(135deg, #667eea, #764ba2);
              border: none;
              box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
              display: flex;
              align-items: center;
              justify-content: center;
              cursor: pointer;
              z-index: 200;
              transition: transform 0.2s, box-shadow 0.2s;
            }
            .ig-fab:active {
              transform: scale(0.92);
            }
            .ig-fab-icon {
              color: #fff;
              font-size: 1.8rem;
              font-weight: 300;
            }

            /* 发布动态弹窗 */
            .ig-post-modal {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.5);
              z-index: 1000;
              display: none;
              align-items: flex-end;
              justify-content: center;
            }
            .ig-post-modal.active {
              display: flex;
            }
            .ig-post-modal-content {
              background: #fff;
              width: 100%;
              max-height: 90vh;
              border-radius: 24px 24px 0 0;
              overflow: hidden;
              animation: slideUpModal 0.3s ease;
            }
            @keyframes slideUpModal {
              from { transform: translateY(100%); }
              to { transform: translateY(0); }
            }
            .ig-modal-header {
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 18px 20px;
              border-bottom: 1px solid #f0f0f0;
            }
            .ig-modal-title {
              font-size: 1.1rem;
              font-weight: 600;
              color: #333;
            }
            .ig-modal-close, .ig-modal-submit {
              background: none;
              border: none;
              font-size: 0.95rem;
              cursor: pointer;
              padding: 6px 12px;
              border-radius: 8px;
            }
            .ig-modal-close {
              color: #666;
            }
            .ig-modal-submit {
              color: #fff;
              background: linear-gradient(135deg, #667eea, #764ba2);
              font-weight: 600;
            }
            .ig-modal-submit:disabled {
              opacity: 0.4;
            }
            .ig-modal-body {
              padding: 20px;
              max-height: 60vh;
              overflow-y: auto;
            }
            .ig-post-textarea {
              width: 100%;
              min-height: 120px;
              border: none;
              font-size: 1rem;
              line-height: 1.6;
              resize: none;
              outline: none;
              font-family: inherit;
            }
            .ig-post-textarea::placeholder {
              color: #aaa;
            }
            .ig-image-options {
              display: flex;
              gap: 12px;
              margin-top: 16px;
              padding-top: 16px;
              border-top: 1px solid #f0f0f0;
            }
            .ig-image-option {
              flex: 1;
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 8px;
              padding: 20px 16px;
              background: #f8f8f8;
              border: 2px dashed #ddd;
              border-radius: 16px;
              cursor: pointer;
              transition: all 0.2s;
            }
            .ig-image-option:active {
              background: #f0f0f0;
            }
            .ig-image-option.selected {
              border-color: #667eea;
              background: #f0f4ff;
            }
            .ig-image-option-icon {
              font-size: 2rem;
            }
            .ig-image-option-text {
              font-size: 0.8rem;
              color: #666;
              text-align: center;
            }

            /* 评论区 */
            .ig-post-comments {
              padding: 0 16px;
            }
            .ig-comment {
              font-size: 0.85rem;
              color: #262626;
              margin-bottom: 6px;
              line-height: 1.4;
            }
            .ig-comment .username {
              font-weight: 600;
              margin-right: 6px;
              color: #262626;
            }
            .ig-view-comments {
              font-size: 0.85rem;
              color: #8e8e8e;
              padding: 4px 16px;
              cursor: pointer;
            }

            /* 时间 */
            .ig-post-time {
              font-size: 0.7rem;
              color: #8e8e8e;
              padding: 4px 16px 12px;
              text-transform: uppercase;
              letter-spacing: 0.5px;
            }

            /* 评论输入框 */
            .ig-comment-input-wrap {
              display: flex;
              align-items: center;
              padding: 12px 16px;
              border-top: 1px solid #efefef;
              gap: 12px;
            }
            .ig-comment-input {
              flex: 1;
              border: none;
              font-size: 0.9rem;
              outline: none;
              background: transparent;
            }
            .ig-comment-input::placeholder {
              color: #8e8e8e;
            }
            .ig-comment-submit {
              background: none;
              border: none;
              color: #0095f6;
              font-weight: 600;
              font-size: 0.9rem;
              cursor: pointer;
              opacity: 0.5;
              transition: opacity 0.2s;
            }
            .ig-comment-submit.active {
              opacity: 1;
            }

            /* 发布动态按钮 - 浮动 */
            .ig-fab {
              position: fixed;
              bottom: 100px;
              right: 20px;
              width: 56px;
              height: 56px;
              border-radius: 50%;
              background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
              border: none;
              box-shadow: 0 4px 16px rgba(225,48,108,0.4);
              display: flex;
              align-items: center;
              justify-content: center;
              cursor: pointer;
              z-index: 200;
              transition: transform 0.2s, box-shadow 0.2s;
            }
            .ig-fab:active {
              transform: scale(0.92);
            }
            .ig-fab-icon {
              color: #fff;
              font-size: 1.6rem;
              font-weight: 300;
            }

            /* 发布动态弹窗 */
            .ig-post-modal {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.6);
              z-index: 1000;
              display: none;
              align-items: flex-end;
              justify-content: center;
            }
            .ig-post-modal.active {
              display: flex;
            }
            .ig-post-modal-content {
              background: #fff;
              width: 100%;
              max-height: 90vh;
              border-radius: 20px 20px 0 0;
              overflow: hidden;
              animation: slideUpModal 0.3s ease;
            }
            @keyframes slideUpModal {
              from { transform: translateY(100%); }
              to { transform: translateY(0); }
            }
            .ig-modal-header {
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 16px 20px;
              border-bottom: 1px solid #efefef;
            }
            .ig-modal-title {
              font-size: 1rem;
              font-weight: 600;
              color: #262626;
            }
            .ig-modal-close, .ig-modal-submit {
              background: none;
              border: none;
              font-size: 0.95rem;
              cursor: pointer;
              padding: 4px 8px;
            }
            .ig-modal-close {
              color: #262626;
            }
            .ig-modal-submit {
              color: #0095f6;
              font-weight: 600;
            }
            .ig-modal-submit:disabled {
              opacity: 0.4;
            }
            .ig-modal-body {
              padding: 16px 20px;
              max-height: 60vh;
              overflow-y: auto;
            }
            .ig-post-textarea {
              width: 100%;
              min-height: 120px;
              border: none;
              font-size: 1rem;
              line-height: 1.6;
              resize: none;
              outline: none;
              font-family: inherit;
            }
            .ig-post-textarea::placeholder {
              color: #8e8e8e;
            }
            .ig-image-options {
              display: flex;
              gap: 12px;
              margin-top: 16px;
              padding-top: 16px;
              border-top: 1px solid #efefef;
            }

            /* 可见范围选择器 */
            .ig-visibility-section {
              margin-top: 16px;
              padding-top: 16px;
              border-top: 1px solid #efefef;
            }

            .ig-visibility-label {
              font-size: 13px;
              color: #666;
              margin-bottom: 10px;
              display: flex;
              align-items: center;
              gap: 6px;
            }

            .ig-visibility-options {
              display: flex;
              flex-wrap: wrap;
              gap: 8px;
            }

            .ig-visibility-option {
              padding: 8px 14px;
              border-radius: 20px;
              border: 1px solid #ddd;
              background: #fff;
              font-size: 13px;
              color: #666;
              cursor: pointer;
              transition: all 0.2s;
              display: flex;
              align-items: center;
              gap: 4px;
            }

            .ig-visibility-option:hover {
              border-color: #f48fb1;
              color: #c2185b;
            }

            .ig-visibility-option.selected {
              background: linear-gradient(135deg, #fce4ec, #f8bbd9);
              border-color: #f48fb1;
              color: #c2185b;
              font-weight: 500;
            }

            .ig-visibility-option .check-icon {
              display: none;
              font-size: 12px;
            }

            .ig-visibility-option.selected .check-icon {
              display: inline;
            }

            .ig-image-option {
              flex: 1;
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 8px;
              padding: 16px;
              background: #fafafa;
              border: 2px dashed #dbdbdb;
              border-radius: 12px;
              cursor: pointer;
              transition: all 0.2s;
            }
            .ig-image-option:active {
              background: #f0f0f0;
              border-color: #0095f6;
            }
            .ig-image-option.selected {
              border-color: #0095f6;
              background: #e8f4fd;
            }
            .ig-image-option-icon {
              font-size: 2rem;
            }
            .ig-image-option-text {
              font-size: 0.8rem;
              color: #8e8e8e;
              text-align: center;
            }
            .ig-text-img-input {
              width: 100%;
              margin-top: 12px;
              padding: 12px;
              border: 1px solid #dbdbdb;
              border-radius: 8px;
              font-size: 0.9rem;
              outline: none;
              display: none;
            }
            .ig-text-img-input.visible {
              display: block;
            }
            .ig-text-img-input:focus {
              border-color: #0095f6;
            }
            .ig-image-preview {
              margin-top: 12px;
              display: none;
            }
            .ig-image-preview.visible {
              display: block;
            }
            .ig-image-preview img {
              max-width: 100%;
              max-height: 200px;
              border-radius: 8px;
              object-fit: cover;
            }
            .ig-image-preview-remove {
              display: inline-block;
              margin-top: 8px;
              color: #ed4956;
              font-size: 0.85rem;
              cursor: pointer;
            }

            /* 个人资料编辑弹窗 */
            .ig-profile-modal {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.6);
              z-index: 1000;
              display: none;
              align-items: center;
              justify-content: center;
              padding: 20px;
            }
            .ig-profile-modal.active {
              display: flex;
            }
            .ig-profile-modal-content {
              background: #fff;
              width: 100%;
              max-width: 400px;
              border-radius: 16px;
              overflow: hidden;
              animation: modalPop 0.3s ease;
            }
            @keyframes modalPop {
              from { transform: scale(0.9); opacity: 0; }
              to { transform: scale(1); opacity: 1; }
            }
            .ig-profile-modal-header {
              padding: 16px 20px;
              border-bottom: 1px solid #efefef;
              display: flex;
              align-items: center;
              justify-content: space-between;
            }
            .ig-profile-modal-title {
              font-size: 1rem;
              font-weight: 600;
            }
            .ig-profile-modal-close {
              background: none;
              border: none;
              font-size: 1.2rem;
              cursor: pointer;
              color: #8e8e8e;
            }
            .ig-profile-modal-body {
              padding: 20px;
            }
            .ig-profile-avatar-edit {
              display: flex;
              flex-direction: column;
              align-items: center;
              margin-bottom: 20px;
            }
            .ig-profile-avatar-preview {
              width: 100px;
              height: 100px;
              border-radius: 50%;
              background: linear-gradient(135deg, #fce4ec, #e1bee7);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 50px;
              overflow: hidden;
              margin-bottom: 12px;
            }
            .ig-profile-avatar-preview img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            .ig-profile-avatar-btns {
              display: flex;
              gap: 12px;
            }
            .ig-profile-avatar-btn {
              padding: 8px 16px;
              background: #fafafa;
              border: 1px solid #dbdbdb;
              border-radius: 8px;
              font-size: 0.85rem;
              cursor: pointer;
              transition: all 0.2s;
            }
            .ig-profile-avatar-btn:active {
              background: #f0f0f0;
            }
            .ig-profile-form-group {
              margin-bottom: 16px;
            }
            .ig-profile-form-label {
              display: block;
              font-size: 0.8rem;
              color: #8e8e8e;
              margin-bottom: 6px;
              font-weight: 500;
            }
            .ig-profile-form-input {
              width: 100%;
              padding: 12px;
              border: 1px solid #dbdbdb;
              border-radius: 8px;
              font-size: 0.95rem;
              outline: none;
              transition: border-color 0.2s;
            }
            .ig-profile-form-input:focus {
              border-color: #0095f6;
            }
            .ig-profile-form-textarea {
              width: 100%;
              padding: 12px;
              border: 1px solid #dbdbdb;
              border-radius: 8px;
              font-size: 0.95rem;
              outline: none;
              min-height: 80px;
              resize: none;
              font-family: inherit;
            }
            .ig-profile-form-textarea:focus {
              border-color: #0095f6;
            }
            .ig-profile-save-btn {
              width: 100%;
              padding: 14px;
              background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
              color: #fff;
              border: none;
              border-radius: 10px;
              font-size: 1rem;
              font-weight: 600;
              cursor: pointer;
              margin-top: 8px;
              transition: opacity 0.2s;
            }
            .ig-profile-save-btn:active {
              opacity: 0.9;
            }

            /* 空状态 */
            .ig-empty-state {
              text-align: center;
              padding: 60px 20px;
            }
            .ig-empty-icon {
              font-size: 4rem;
              margin-bottom: 16px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: #8e8e8e;
            }
            .ig-empty-icon svg {
              stroke: #b0bec5;
            }
            .ig-empty-title {
              font-size: 1.2rem;
              font-weight: 600;
              color: #262626;
              margin-bottom: 8px;
            }
            .ig-empty-text {
              font-size: 0.9rem;
              color: #8e8e8e;
            }

            /* 评论弹窗 */
            .ig-comments-modal {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.6);
              z-index: 1000;
              display: none;
              align-items: flex-end;
            }
            .ig-comments-modal.active {
              display: flex;
            }
            .ig-comments-modal-content {
              background: #fff;
              width: 100%;
              max-height: 70vh;
              border-radius: 20px 20px 0 0;
              display: flex;
              flex-direction: column;
              animation: slideUpModal 0.3s ease;
            }
            .ig-comments-header {
              padding: 16px 20px;
              border-bottom: 1px solid #efefef;
              display: flex;
              align-items: center;
              justify-content: space-between;
            }
            .ig-comments-title {
              font-size: 1rem;
              font-weight: 600;
            }
            .ig-comments-close {
              background: none;
              border: none;
              font-size: 1.2rem;
              cursor: pointer;
            }
            .ig-comments-list {
              flex: 1;
              overflow-y: auto;
              padding: 16px;
            }
            .ig-full-comment {
              display: flex;
              gap: 12px;
              margin-bottom: 16px;
            }
            .ig-full-comment-avatar {
              width: 36px;
              height: 36px;
              border-radius: 50%;
              background: linear-gradient(135deg, #fce4ec, #fff3e0);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 18px;
              flex-shrink: 0;
              overflow: hidden;
            }
            .ig-full-comment-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            .ig-full-comment-content {
              flex: 1;
            }
            .ig-full-comment-user {
              font-weight: 600;
              font-size: 0.9rem;
              color: #262626;
            }
            .ig-full-comment-text {
              font-size: 0.9rem;
              color: #262626;
              margin-top: 2px;
              line-height: 1.4;
            }
            .ig-full-comment-actions {
              display: flex;
              align-items: center;
              gap: 16px;
              margin-top: 6px;
            }
            .ig-full-comment-time {
              font-size: 0.75rem;
              color: #8e8e8e;
            }
            .ig-reply-btn {
              font-size: 0.75rem;
              color: #8e8e8e;
              font-weight: 600;
              cursor: pointer;
            }
            .ig-reply-btn:active {
              color: #262626;
            }
            .ig-reply-tag {
              color: #0095f6;
              font-weight: 500;
            }
            .ig-comments-input-area {
              border-top: 1px solid #efefef;
              padding: 12px 16px;
              padding-bottom: calc(12px + env(safe-area-inset-bottom));
              display: flex;
              gap: 12px;
              align-items: center;
            }
            .ig-comments-input {
              flex: 1;
              padding: 10px 14px;
              border: 1px solid #dbdbdb;
              border-radius: 20px;
              font-size: 0.9rem;
              outline: none;
            }
            .ig-comments-input:focus {
              border-color: #0095f6;
            }
            .ig-comments-send {
              background: none;
              border: none;
              color: #0095f6;
              font-weight: 600;
              font-size: 0.95rem;
              cursor: pointer;
            }

            /* 转发选择弹窗 */
            .ig-share-modal {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.6);
              z-index: 1000;
              display: none;
              align-items: flex-end;
            }
            .ig-share-modal.active {
              display: flex;
            }
            .ig-share-modal-content {
              background: #fff;
              width: 100%;
              max-height: 60vh;
              border-radius: 20px 20px 0 0;
              display: flex;
              flex-direction: column;
              animation: slideUpModal 0.3s ease;
            }
            .ig-share-header {
              padding: 16px 20px;
              border-bottom: 1px solid #efefef;
              display: flex;
              align-items: center;
              justify-content: space-between;
            }
            .ig-share-title {
              font-size: 1rem;
              font-weight: 600;
            }
            .ig-share-close {
              background: none;
              border: none;
              font-size: 1.2rem;
              cursor: pointer;
              color: #666;
            }
            .ig-share-list {
              flex: 1;
              overflow-y: auto;
              padding: 8px 0;
            }
            .ig-share-item {
              display: flex;
              align-items: center;
              gap: 14px;
              padding: 12px 20px;
              cursor: pointer;
              transition: background 0.2s;
            }
            .ig-share-item:active {
              background: #f5f5f5;
            }
            .ig-share-avatar {
              width: 48px;
              height: 48px;
              border-radius: 50%;
              background: linear-gradient(135deg, #667eea, #764ba2);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 24px;
              overflow: hidden;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            .ig-share-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            .ig-share-info {
              flex: 1;
            }
            .ig-share-name {
              font-size: 1rem;
              font-weight: 600;
              color: #333;
            }
            .ig-share-desc {
              font-size: 0.8rem;
              color: #999;
              margin-top: 2px;
            }
            .ig-share-btn {
              padding: 8px 16px;
              background: linear-gradient(135deg, #667eea, #764ba2);
              color: #fff;
              border: none;
              border-radius: 20px;
              font-size: 0.85rem;
              font-weight: 500;
              cursor: pointer;
            }
            .ig-share-btn:active {
              transform: scale(0.95);
            }
            .ig-share-empty {
              text-align: center;
              padding: 40px 20px;
              color: #999;
            }

            /* 动态操作菜单 */
            .ig-post-menu {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.6);
              z-index: 1000;
              display: none;
              align-items: flex-end;
            }
            .ig-post-menu.active {
              display: flex;
            }
            .ig-post-menu-content {
              background: #fff;
              width: 100%;
              border-radius: 20px 20px 0 0;
              padding-bottom: env(safe-area-inset-bottom);
              animation: slideUpModal 0.3s ease;
            }
            .ig-post-menu-item {
              display: flex;
              align-items: center;
              gap: 16px;
              padding: 16px 20px;
              font-size: 1rem;
              color: #262626;
              cursor: pointer;
              border-bottom: 1px solid #efefef;
            }
            .ig-post-menu-item:last-child {
              border-bottom: none;
            }
            .ig-post-menu-item:active {
              background: #fafafa;
            }
            .ig-post-menu-item.danger {
              color: #ed4956;
            }
            .ig-post-menu-icon {
              font-size: 1.2rem;
            }
            .ig-post-menu-cancel {
              text-align: center;
              padding: 16px;
              font-weight: 600;
              color: #262626;
              border-top: 8px solid #fafafa;
              cursor: pointer;
            }

            /* ==================== Todo Tab - 超可爱小夹板设计 ==================== */
            #todoTab {
              padding: 16px;
              padding-bottom: 80px;
              background: #fffafa;
              min-height: 100%;
              position: relative;
            }

            /* 背景装饰 */
            #todoTab::before {
              content: "✿ ❀ ✿ ❀ ✿";
              position: absolute;
              top: 10px;
              left: 50%;
              transform: translateX(-50%);
              font-size: 0.8rem;
              color: rgba(255,182,193,0.4);
              letter-spacing: 8px;
              pointer-events: none;
            }

            /* 可爱标题 */
            .todo-cute-title {
              text-align: center;
              margin-bottom: 16px;
              padding-top: 8px;
            }
            .todo-cute-title-text {
              font-size: 1.1rem;
              font-weight: 700;
              color: #e75480;
              display: inline-flex;
              align-items: center;
              gap: 8px;
            }
            .todo-cute-title-text::before {
              content: "♡";
            }
            .todo-cute-title-text::after {
              content: "♡";
            }

            /* 夹板容器 */
            .clipboard-container {
              position: relative;
              margin-top: 8px;
            }

            /* 可爱粉色夹子 */
            .clipboard-clip {
              position: relative;
              width: 70px;
              height: 24px;
              background: linear-gradient(180deg, #ff9eb5 0%, #ff7a9a 100%);
              border-radius: 8px 8px 4px 4px;
              margin: 0 auto;
              z-index: 10;
              box-shadow: 0 3px 10px rgba(255,122,154,0.3);
            }
            .clipboard-clip::before {
              content: "♡";
              position: absolute;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              font-size: 12px;
              color: rgba(255,255,255,0.8);
            }
            .clipboard-clip::after {
              content: "";
              position: absolute;
              bottom: -6px;
              left: 50%;
              transform: translateX(-50%);
              width: 50px;
              height: 10px;
              background: linear-gradient(180deg, #ff7a9a, #ff6b8a);
              border-radius: 0 0 6px 6px;
              box-shadow: 0 2px 6px rgba(255,107,138,0.2);
            }

            /* 可爱木板（粉色调） */
            .clipboard-board {
              background: linear-gradient(135deg, #ffcdd2 0%, #f8bbd9 50%, #f48fb1 100%);
              border-radius: 16px;
              padding: 10px;
              margin-top: -3px;
              box-shadow:
                0 8px 25px rgba(244,143,177,0.3),
                inset 0 2px 0 rgba(255,255,255,0.4);
              position: relative;
              border: 2px solid rgba(255,255,255,0.5);
            }
            .clipboard-board::before {
              content: "";
              position: absolute;
              top: 4px;
              left: 4px;
              right: 4px;
              bottom: 4px;
              border: 2px dashed rgba(255,255,255,0.4);
              border-radius: 12px;
              pointer-events: none;
            }

            /* 可爱纸张 */
            .clipboard-paper {
              background: linear-gradient(180deg, #ffffff 0%, #fff9fc 50%, #fff5f8 100%);
              border-radius: 12px;
              padding: 20px 16px;
              position: relative;
              box-shadow:
                0 4px 15px rgba(0,0,0,0.06),
                inset 0 0 30px rgba(255,182,193,0.08);
              min-height: 380px;
            }
            /* 纸张装饰 - 小爱心边线 */
            .clipboard-paper::before {
              content: "♡ ♡ ♡ ♡ ♡";
              position: absolute;
              top: 8px;
              left: 50%;
              transform: translateX(-50%);
              font-size: 8px;
              color: rgba(255,182,193,0.5);
              letter-spacing: 12px;
            }
            .clipboard-paper::after {
              content: "";
              position: absolute;
              top: 25px;
              left: 16px;
              right: 16px;
              height: 1px;
              background: linear-gradient(90deg, transparent, rgba(255,182,193,0.3), transparent);
            }

            /* 顶部日期区域 */
            .todo-top-section {
              display: flex;
              align-items: center;
              gap: 14px;
              margin-bottom: 16px;
              margin-top: 20px;
              padding-bottom: 14px;
              border-bottom: 2px dotted rgba(255,182,193,0.4);
            }

            .todo-date-box {
              background: linear-gradient(135deg, #ff8fab 0%, #ff6b8a 100%);
              padding: 12px 16px;
              border-radius: 16px;
              text-align: center;
              box-shadow:
                0 4px 15px rgba(255,107,138,0.35),
                inset 0 2px 0 rgba(255,255,255,0.3);
              position: relative;
              min-width: 65px;
            }
            .todo-date-box::before {
              content: "✧";
              position: absolute;
              top: -4px;
              right: -4px;
              font-size: 12px;
              color: #ffeb3b;
            }
            .todo-date-day {
              font-size: 1.8rem;
              font-weight: 800;
              color: white;
              line-height: 1;
              text-shadow: 0 2px 4px rgba(0,0,0,0.15);
            }
            .todo-date-month {
              font-size: 0.7rem;
              color: rgba(255,255,255,0.95);
              font-weight: 600;
              margin-top: 2px;
            }
            .todo-date-weekday {
              font-size: 0.6rem;
              color: rgba(255,255,255,0.85);
              margin-top: 1px;
            }

            .todo-greeting-box {
              flex: 1;
            }
            .todo-greeting-text {
              font-size: 1rem;
              font-weight: 700;
              color: #e75480;
              margin-bottom: 4px;
              display: flex;
              align-items: center;
              gap: 4px;
            }
            .todo-greeting-sub {
              font-size: 0.75rem;
              color: #c9879f;
              font-style: italic;
            }

            /* 可爱统计卡片 */
            .todo-stats-row {
              display: flex;
              gap: 8px;
              margin-bottom: 16px;
            }
            .todo-stat-card {
              flex: 1;
              background: linear-gradient(135deg, #fff 0%, #fff5f8 100%);
              border-radius: 14px;
              padding: 12px 8px;
              text-align: center;
              border: 2px solid rgba(255,182,193,0.3);
              position: relative;
              overflow: hidden;
            }
            .todo-stat-card::before {
              content: "";
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              height: 3px;
              background: linear-gradient(90deg, #ffb6c1, #ff8fab, #ffb6c1);
            }
            .todo-stat-num {
              font-size: 1.5rem;
              font-weight: 800;
              background: linear-gradient(135deg, #ff6b8a, #e91e63);
              -webkit-background-clip: text;
              -webkit-text-fill-color: transparent;
              background-clip: text;
              line-height: 1.2;
            }
            .todo-stat-label {
              font-size: 0.65rem;
              color: #c9879f;
              font-weight: 600;
              margin-top: 2px;
            }

            /* 分类筛选栏 */
            .todo-filter-bar {
              display: flex;
              gap: 6px;
              margin-bottom: 14px;
              overflow-x: auto;
              padding: 4px 0;
              -webkit-overflow-scrolling: touch;
            }
            .todo-filter-bar::-webkit-scrollbar {
              display: none;
            }
            .todo-filter-btn {
              padding: 6px 12px;
              border-radius: 20px;
              font-size: 0.7rem;
              font-weight: 600;
              border: 2px solid rgba(255,182,193,0.4);
              background: white;
              color: #c9879f;
              cursor: pointer;
              white-space: nowrap;
              transition: all 0.2s;
            }
            .todo-filter-btn.active {
              background: linear-gradient(135deg, #ff8fab, #ff6b8a);
              color: white;
              border-color: transparent;
              box-shadow: 0 3px 10px rgba(255,107,138,0.3);
              transform: scale(1.02);
            }

            /* 待办列表 */
            .todo-list-container {
              margin-bottom: 14px;
            }
            .todo-item {
              display: flex;
              align-items: center;
              gap: 10px;
              padding: 12px;
              background: white;
              border-radius: 14px;
              margin-bottom: 8px;
              cursor: pointer;
              transition: all 0.2s;
              border: 2px solid rgba(255,182,193,0.2);
              position: relative;
            }
            .todo-item::before {
              content: "";
              position: absolute;
              left: 0;
              top: 50%;
              transform: translateY(-50%);
              width: 4px;
              height: 60%;
              background: linear-gradient(180deg, #ffb6c1, #ff8fab);
              border-radius: 0 4px 4px 0;
            }
            .todo-item:active {
              transform: scale(0.98);
              border-color: rgba(255,182,193,0.5);
            }
            .todo-item.done {
              background: linear-gradient(135deg, #f0fff0 0%, #e8f5e9 100%);
              border-color: rgba(165,214,167,0.4);
            }
            .todo-item.done::before {
              background: linear-gradient(180deg, #a5d6a7, #81c784);
            }

            .todo-checkbox {
              width: 24px;
              height: 24px;
              border-radius: 50%;
              border: 2px solid #ffb6c1;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 12px;
              color: transparent;
              flex-shrink: 0;
              transition: all 0.2s;
              background: white;
            }
            .todo-item.done .todo-checkbox {
              background: linear-gradient(135deg, #a5d6a7, #81c784);
              border-color: #81c784;
              color: white;
              box-shadow: 0 2px 8px rgba(129,199,132,0.3);
            }

            .todo-content {
              flex: 1;
              min-width: 0;
            }
            .todo-text {
              font-size: 0.88rem;
              color: #5a4a5a;
              line-height: 1.4;
              font-weight: 500;
            }
            .todo-item.done .todo-text {
              text-decoration: line-through;
              color: #a0a0a0;
            }
            .todo-meta {
              display: flex;
              align-items: center;
              gap: 8px;
              margin-top: 3px;
            }
            .todo-time {
              font-size: 0.6rem;
              color: #cbb0bf;
            }

            .todo-tag {
              font-size: 0.55rem;
              font-weight: 700;
              padding: 3px 8px;
              border-radius: 10px;
              flex-shrink: 0;
              text-transform: uppercase;
            }
            .tag-health { background: linear-gradient(135deg, #c8e6c9, #a5d6a7); color: #2e7d32; }
            .tag-self { background: linear-gradient(135deg, #f8bbd9, #f48fb1); color: #c2185b; }
            .tag-study { background: linear-gradient(135deg, #bbdefb, #90caf9); color: #1565c0; }
            .tag-work { background: linear-gradient(135deg, #ffe0b2, #ffcc80); color: #ef6c00; }
            .tag-life { background: linear-gradient(135deg, #e1bee7, #ce93d8); color: #7b1fa2; }

            .todo-delete-btn {
              width: 26px;
              height: 26px;
              border-radius: 50%;
              background: rgba(255,107,107,0.1);
              border: none;
              color: #ff6b6b;
              font-size: 0.75rem;
              cursor: pointer;
              opacity: 0;
              transition: all 0.2s;
            }
            .todo-item:hover .todo-delete-btn,
            .todo-item:active .todo-delete-btn {
              opacity: 1;
            }

            /* 添加按钮 - 超可爱 */
            .todo-add-btn {
              width: 100%;
              padding: 14px;
              background: linear-gradient(135deg, #fff 0%, #fff5f8 100%);
              border: 2px dashed #ffb6c1;
              border-radius: 16px;
              font-size: 0.85rem;
              font-weight: 700;
              color: #e75480;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
              transition: all 0.2s;
              position: relative;
              overflow: hidden;
            }
            .todo-add-btn::before {
              content: "★";
              position: absolute;
              left: 20px;
              animation: sparkle 2s infinite;
            }
            .todo-add-btn::after {
              content: "★";
              position: absolute;
              right: 20px;
              animation: sparkle 2s infinite 0.5s;
            }
            @keyframes sparkle {
              0%, 100% { opacity: 0.3; transform: scale(0.8); }
              50% { opacity: 1; transform: scale(1.2); }
            }
            .todo-add-btn:active {
              background: linear-gradient(135deg, #fff0f5 0%, #ffe4ec 100%);
              transform: scale(0.98);
              border-style: solid;
            }

            /* AI监督区域 - 可爱版 */
            .todo-ai-section {
              background: linear-gradient(135deg, #fff5f8 0%, #fff0f5 100%);
              border-radius: 20px;
              padding: 16px;
              margin-top: 16px;
              border: 2px solid rgba(255,182,193,0.3);
              position: relative;
            }
            .todo-ai-section::before {
              content: "~ 小助手 ~";
              position: absolute;
              top: -10px;
              left: 50%;
              transform: translateX(-50%);
              background: white;
              padding: 2px 12px;
              font-size: 0.65rem;
              color: #e75480;
              font-weight: 600;
              border-radius: 10px;
              border: 2px solid rgba(255,182,193,0.3);
            }
            .todo-ai-header {
              display: flex;
              align-items: center;
              gap: 10px;
              margin-bottom: 12px;
              margin-top: 8px;
            }
            .todo-ai-icon {
              width: 40px;
              height: 40px;
              border-radius: 50%;
              background: linear-gradient(135deg, #ff8fab, #ff6b8a);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 1.2rem;
              box-shadow: 0 4px 12px rgba(255,107,138,0.35);
              animation: bounce 3s infinite;
            }
            @keyframes bounce {
              0%, 100% { transform: translateY(0); }
              50% { transform: translateY(-3px); }
            }
            .todo-ai-title {
              font-size: 0.9rem;
              font-weight: 700;
              color: #e75480;
            }
            .todo-ai-subtitle {
              font-size: 0.7rem;
              color: #c9879f;
            }
            .todo-ai-char-list {
              display: flex;
              flex-wrap: wrap;
              gap: 8px;
            }
            .todo-ai-char-btn {
              display: flex;
              align-items: center;
              gap: 6px;
              padding: 8px 14px;
              background: white;
              border-radius: 25px;
              border: 2px solid rgba(255,182,193,0.3);
              font-size: 0.75rem;
              font-weight: 600;
              color: #8a6a7f;
              cursor: pointer;
              transition: all 0.2s;
            }
            .todo-ai-char-btn:active {
              transform: scale(0.95);
            }
            .todo-ai-char-btn.active {
              background: linear-gradient(135deg, #ff8fab, #ff6b8a);
              color: white;
              border-color: transparent;
              box-shadow: 0 3px 12px rgba(255,107,138,0.35);
            }
            .todo-ai-char-avatar {
              width: 22px;
              height: 22px;
              border-radius: 50%;
              background: linear-gradient(135deg, #fce4ec, #f8bbd9);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 0.65rem;
              overflow: hidden;
              border: 2px solid rgba(255,255,255,0.5);
            }
            .todo-ai-char-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            .todo-ai-empty {
              text-align: center;
              padding: 16px;
              color: #c9879f;
              font-size: 0.8rem;
            }

            /* ==================== 经期记录系统 ==================== */
            .period-tracker-section {
              margin-top: 20px;
              position: relative;
            }
            .period-card {
              background: linear-gradient(135deg, #fff0f3 0%, #ffe4ec 50%, #ffd6e0 100%);
              border-radius: 24px;
              padding: 20px;
              border: 2px solid rgba(255,182,193,0.4);
              box-shadow: 0 6px 20px rgba(255,182,193,0.2);
              position: relative;
              overflow: hidden;
            }
            .period-card::before {
              content: "";
              position: absolute;
              top: -20px;
              right: -20px;
              width: 80px;
              height: 80px;
              background: radial-gradient(circle, rgba(255,182,193,0.3) 0%, transparent 70%);
              border-radius: 50%;
            }
            .period-card::after {
              content: "";
              position: absolute;
              bottom: -30px;
              left: -30px;
              width: 100px;
              height: 100px;
              background: radial-gradient(circle, rgba(255,107,138,0.15) 0%, transparent 70%);
              border-radius: 50%;
            }

            .period-header {
              display: flex;
              align-items: center;
              gap: 12px;
              margin-bottom: 16px;
              position: relative;
              z-index: 1;
            }
            .period-icon {
              width: 48px;
              height: 48px;
              border-radius: 50%;
              background: linear-gradient(135deg, #ff6b8a 0%, #e91e63 100%);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 1.4rem;
              box-shadow: 0 4px 15px rgba(233,30,99,0.35);
            }
            .period-title-area {
              flex: 1;
            }
            .period-title {
              font-size: 1rem;
              font-weight: 700;
              color: #c2185b;
              display: flex;
              align-items: center;
              gap: 6px;
            }
            .period-subtitle {
              font-size: 0.7rem;
              color: #d4768a;
              margin-top: 2px;
            }

            /* 经期状态显示 */
            .period-status {
              background: white;
              border-radius: 16px;
              padding: 16px;
              margin-bottom: 16px;
              position: relative;
              z-index: 1;
            }
            .period-status-row {
              display: flex;
              align-items: center;
              justify-content: space-between;
              margin-bottom: 12px;
            }
            .period-status-label {
              font-size: 0.8rem;
              color: #8a6a7f;
              font-weight: 500;
            }
            .period-status-value {
              font-size: 0.9rem;
              font-weight: 700;
              color: #c2185b;
            }
            .period-status-value.safe {
              color: #43a047;
            }
            .period-status-value.warning {
              color: #ff9800;
            }
            .period-status-value.period {
              color: #e91e63;
            }

            /* 经期进度条 */
            .period-progress {
              margin-top: 12px;
            }
            .period-progress-bar {
              height: 8px;
              background: rgba(255,182,193,0.3);
              border-radius: 10px;
              overflow: hidden;
              position: relative;
            }
            .period-progress-fill {
              height: 100%;
              background: linear-gradient(90deg, #ff8fab, #e91e63);
              border-radius: 10px;
              transition: width 0.3s ease;
            }
            .period-progress-labels {
              display: flex;
              justify-content: space-between;
              margin-top: 6px;
              font-size: 0.6rem;
              color: #c9879f;
            }

            /* 经期日历 */
            .period-calendar {
              display: grid;
              grid-template-columns: repeat(7, 1fr);
              gap: 4px;
              margin-bottom: 16px;
              position: relative;
              z-index: 1;
            }
            .period-cal-header {
              font-size: 0.6rem;
              color: #c9879f;
              text-align: center;
              font-weight: 600;
              padding: 4px 0;
            }
            .period-cal-day {
              aspect-ratio: 1;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 0.7rem;
              color: #8a6a7f;
              cursor: pointer;
              transition: all 0.2s;
              background: white;
              border: 1px solid transparent;
            }
            .period-cal-day:active {
              transform: scale(0.9);
            }
            .period-cal-day.today {
              border: 2px solid #ff6b8a;
              font-weight: 700;
            }
            .period-cal-day.period {
              background: linear-gradient(135deg, #ff8fab, #ff6b8a);
              color: white;
              font-weight: 600;
            }
            .period-cal-day.predicted {
              background: linear-gradient(135deg, #ffcdd2, #ffb6c1);
              color: #c2185b;
            }
            .period-cal-day.ovulation {
              background: linear-gradient(135deg, #e1f5fe, #b3e5fc);
              color: #0288d1;
            }
            .period-cal-day.empty {
              background: transparent;
              cursor: default;
            }

            /* 操作按钮 */
            .period-actions {
              display: flex;
              gap: 10px;
              position: relative;
              z-index: 1;
            }
            .period-action-btn {
              flex: 1;
              padding: 12px;
              border-radius: 14px;
              font-size: 0.8rem;
              font-weight: 700;
              border: none;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 6px;
              transition: all 0.2s;
            }
            .period-action-btn.primary {
              background: linear-gradient(135deg, #ff6b8a, #e91e63);
              color: white;
              box-shadow: 0 4px 15px rgba(233,30,99,0.3);
            }
            .period-action-btn.primary:active {
              transform: scale(0.98);
              box-shadow: 0 2px 8px rgba(233,30,99,0.3);
            }
            .period-action-btn.secondary {
              background: white;
              color: #c2185b;
              border: 2px solid rgba(255,182,193,0.4);
            }
            .period-action-btn.secondary:active {
              background: #fff5f8;
              transform: scale(0.98);
            }

            /* 经期设置弹窗 */
            .period-modal-overlay {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.5);
              z-index: 10000;
              display: flex;
              align-items: flex-end;
              justify-content: center;
              opacity: 0;
              pointer-events: none;
              transition: opacity 0.2s ease;
            }
            .period-modal-overlay.active {
              opacity: 1;
              pointer-events: auto;
            }
            .period-modal {
              background: linear-gradient(180deg, #fff 0%, #fff5f8 100%);
              border-radius: 24px 24px 0 0;
              width: 100%;
              max-width: 500px;
              max-height: 80vh;
              display: flex;
              flex-direction: column;
              transform: translateY(100%);
              transition: transform 0.3s ease;
            }
            .period-modal-overlay.active .period-modal {
              transform: translateY(0);
            }
            .period-modal-header {
              padding: 20px;
              border-bottom: 2px solid rgba(255,182,193,0.2);
              display: flex;
              align-items: center;
              justify-content: space-between;
            }
            .period-modal-title {
              font-size: 1.1rem;
              font-weight: 700;
              color: #c2185b;
              display: flex;
              align-items: center;
              gap: 8px;
            }
            .period-modal-close {
              width: 32px;
              height: 32px;
              border: none;
              background: rgba(255,182,193,0.2);
              border-radius: 50%;
              font-size: 1.1rem;
              color: #c2185b;
              cursor: pointer;
            }
            .period-modal-body {
              flex: 1;
              overflow-y: auto;
              padding: 20px;
            }
            .period-input-group {
              margin-bottom: 20px;
            }
            .period-input-label {
              font-size: 0.8rem;
              font-weight: 600;
              color: #8a6a7f;
              margin-bottom: 10px;
              display: flex;
              align-items: center;
              gap: 6px;
            }
            .period-input {
              width: 100%;
              padding: 14px 16px;
              border: 2px solid rgba(255,182,193,0.3);
              border-radius: 14px;
              font-size: 1rem;
              color: #5a4a5a;
              background: white;
              outline: none;
              transition: all 0.2s;
            }
            .period-input:focus {
              border-color: #ff6b8a;
              box-shadow: 0 0 0 3px rgba(255,107,138,0.15);
            }
            .period-hint {
              font-size: 0.7rem;
              color: #c9879f;
              margin-top: 6px;
              font-style: italic;
            }
            .period-modal-footer {
              padding: 16px 20px;
              padding-bottom: calc(16px + env(safe-area-inset-bottom));
              border-top: 2px solid rgba(255,182,193,0.2);
            }
            .period-save-btn {
              width: 100%;
              padding: 14px;
              background: linear-gradient(135deg, #ff6b8a, #e91e63);
              border: none;
              border-radius: 14px;
              font-size: 1rem;
              font-weight: 700;
              color: white;
              cursor: pointer;
              box-shadow: 0 4px 15px rgba(233,30,99,0.3);
              transition: all 0.2s;
            }
            .period-save-btn:active {
              transform: scale(0.98);
            }

            /* 经期小贴士 */
            .period-tips {
              background: white;
              border-radius: 14px;
              padding: 14px;
              margin-top: 12px;
              position: relative;
              z-index: 1;
            }
            .period-tips-title {
              font-size: 0.75rem;
              font-weight: 700;
              color: #c2185b;
              margin-bottom: 8px;
              display: flex;
              align-items: center;
              gap: 6px;
            }
            .period-tips-content {
              font-size: 0.75rem;
              color: #8a6a7f;
              line-height: 1.6;
            }

            /* 添加待办弹窗样式 */
            .todo-modal-overlay {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.5);
              z-index: 10000;
              display: flex;
              align-items: flex-end;
              justify-content: center;
              opacity: 0;
              pointer-events: none;
              transition: opacity 0.2s ease;
            }
            .todo-modal-overlay.active {
              opacity: 1;
              pointer-events: auto;
            }
            .todo-modal {
              background: linear-gradient(180deg, #fff 0%, #fff5f8 100%);
              border-radius: 24px 24px 0 0;
              width: 100%;
              max-width: 500px;
              max-height: 85vh;
              display: flex;
              flex-direction: column;
              transform: translateY(100%);
              transition: transform 0.3s ease;
            }
            .todo-modal-overlay.active .todo-modal {
              transform: translateY(0);
            }
            .todo-modal-header {
              padding: 20px;
              border-bottom: 2px solid rgba(255,182,193,0.2);
              display: flex;
              align-items: center;
              justify-content: space-between;
            }
            .todo-modal-title {
              font-size: 1.1rem;
              font-weight: 700;
              color: #e75480;
              display: flex;
              align-items: center;
              gap: 8px;
            }
            .todo-modal-close {
              width: 32px;
              height: 32px;
              border: none;
              background: rgba(255,182,193,0.2);
              border-radius: 50%;
              font-size: 1.1rem;
              color: #e75480;
              cursor: pointer;
            }
            .todo-modal-body {
              flex: 1;
              overflow-y: auto;
              padding: 20px;
            }
            .todo-input-group {
              margin-bottom: 20px;
            }
            .todo-input-label {
              font-size: 0.8rem;
              font-weight: 600;
              color: #8a6a7f;
              margin-bottom: 10px;
              display: block;
            }
            .todo-input {
              width: 100%;
              padding: 14px 16px;
              border: 2px solid rgba(255,182,193,0.3);
              border-radius: 14px;
              font-size: 0.95rem;
              color: #5a4a5a;
              background: white;
              outline: none;
              transition: all 0.2s;
            }
            .todo-input:focus {
              border-color: #ff6b8a;
              box-shadow: 0 0 0 3px rgba(255,107,138,0.15);
            }
            .todo-input::placeholder {
              color: #cbb0bf;
            }
            .todo-tag-select {
              display: flex;
              flex-wrap: wrap;
              gap: 8px;
            }
            .todo-tag-option {
              padding: 10px 16px;
              border-radius: 25px;
              font-size: 0.8rem;
              font-weight: 600;
              border: 2px solid rgba(255,182,193,0.3);
              background: white;
              color: #8a6a7f;
              cursor: pointer;
              transition: all 0.2s;
            }
            .todo-tag-option.selected {
              background: linear-gradient(135deg, #fff0f5, #ffe4ec);
              border-color: #ff6b8a;
              color: #c2185b;
            }
            .todo-modal-footer {
              padding: 16px 20px;
              padding-bottom: calc(16px + env(safe-area-inset-bottom));
              border-top: 2px solid rgba(255,182,193,0.2);
            }
            .todo-save-btn {
              width: 100%;
              padding: 14px;
              background: linear-gradient(135deg, #ff8fab, #ff6b8a);
              border: none;
              border-radius: 14px;
              font-size: 1rem;
              font-weight: 700;
              color: white;
              cursor: pointer;
              box-shadow: 0 4px 15px rgba(255,107,138,0.3);
              transition: all 0.2s;
            }
            .todo-save-btn:active {
              transform: scale(0.98);
            }

            /* 空状态 */
            .todo-empty-state {
              text-align: center;
              padding: 30px 20px;
            }
            .todo-empty-icon {
              font-size: 2.5rem;
              margin-bottom: 10px;
              animation: float 3s ease-in-out infinite;
              display: flex;
              align-items: center;
              justify-content: center;
              color: #c9879f;
            }
            .todo-empty-icon svg {
              stroke: #c9879f;
            }
            @keyframes float {
              0%, 100% { transform: translateY(0); }
              50% { transform: translateY(-8px); }
            }
            .todo-empty-text {
              font-size: 0.9rem;
              color: #c9879f;
              margin-bottom: 4px;
              font-weight: 600;
            }
            .todo-empty-hint {
              font-size: 0.75rem;
              color: #dab0c5;
            }

            /* 待办设置按钮 */
            .todo-settings-btn {
              position: absolute;
              top: 12px;
              right: 12px;
              width: 32px;
              height: 32px;
              border-radius: 50%;
              background: rgba(255,182,193,0.2);
              border: none;
              font-size: 1rem;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              transition: all 0.2s;
              z-index: 5;
            }
            .todo-settings-btn:active {
              transform: scale(0.9);
              background: rgba(255,182,193,0.4);
            }

            /* 待办设置弹窗 */
            .todo-settings-modal {
              background: linear-gradient(180deg, #fff 0%, #fff5f8 100%);
              border-radius: 24px 24px 0 0;
              width: 100%;
              max-width: 500px;
              max-height: 85vh;
              display: flex;
              flex-direction: column;
              transform: translateY(100%);
              transition: transform 0.3s ease;
            }
            .todo-modal-overlay.active .todo-settings-modal {
              transform: translateY(0);
            }

            /* 分类管理 */
            .todo-category-list {
              margin-top: 10px;
            }
            .todo-category-item {
              display: flex;
              align-items: center;
              gap: 10px;
              padding: 12px;
              background: white;
              border-radius: 12px;
              margin-bottom: 8px;
              border: 1px solid rgba(255,182,193,0.2);
            }
            .todo-category-emoji {
              width: 36px;
              height: 36px;
              border-radius: 10px;
              background: linear-gradient(135deg, #fff0f5, #ffe4ec);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 1.1rem;
            }
            .todo-category-name {
              flex: 1;
              font-size: 0.9rem;
              color: #5a4a5a;
              font-weight: 500;
            }
            .todo-category-delete {
              width: 28px;
              height: 28px;
              border-radius: 50%;
              background: rgba(255,107,107,0.1);
              border: none;
              color: #ff6b6b;
              font-size: 0.8rem;
              cursor: pointer;
            }
            .todo-category-delete:disabled {
              opacity: 0.3;
              cursor: not-allowed;
            }
            .todo-add-category-row {
              display: flex;
              gap: 8px;
              margin-top: 12px;
            }
            .todo-add-category-input {
              flex: 1;
              padding: 10px 14px;
              border: 2px solid rgba(255,182,193,0.3);
              border-radius: 12px;
              font-size: 0.9rem;
              outline: none;
            }
            .todo-add-category-input:focus {
              border-color: #ff6b8a;
            }
            .todo-add-category-btn {
              padding: 10px 16px;
              background: linear-gradient(135deg, #ff8fab, #ff6b8a);
              border: none;
              border-radius: 12px;
              color: white;
              font-weight: 600;
              cursor: pointer;
            }

            /* 问候语设置 */
            .greeting-preview {
              background: linear-gradient(135deg, #fff0f5, #ffe4ec);
              border-radius: 12px;
              padding: 14px;
              margin-top: 10px;
              text-align: center;
            }
            .greeting-preview-main {
              font-size: 1rem;
              font-weight: 600;
              color: #e75480;
              margin-bottom: 4px;
            }
            .greeting-preview-sub {
              font-size: 0.75rem;
              color: #c9879f;
            }
            .greeting-input-row {
              display: flex;
              gap: 8px;
              margin-top: 10px;
            }
            .greeting-input-row .todo-input {
              flex: 1;
            }
            .greeting-time-select {
              padding: 10px 12px;
              border: 2px solid rgba(255,182,193,0.3);
              border-radius: 12px;
              font-size: 0.85rem;
              background: white;
              color: #5a4a5a;
              outline: none;
            }

            /* Profile Tab (我的) */
            #profileTab {
              background: #f5f5f5;
              min-height: 100%;
              overflow: hidden;
            }

            .profile-header-card {
              background: white;
              margin: 12px;
              border-radius: 16px;
              overflow: hidden;
              box-shadow: 0 2px 10px var(--shadow);
            }

            .profile-main {
              display: flex;
              align-items: center;
              padding: 20px 16px;
              gap: 14px;
              cursor: pointer;
            }

            .profile-main:active {
              background: #f9f9f9;
            }

            .profile-avatar-large {
              width: 64px;
              height: 64px;
              border-radius: 14px;
              background: linear-gradient(135deg, #fce4ec, #e8f5e9);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 32px;
            }

            .profile-info-main {
              flex: 1;
            }

            .profile-name-large {
              font-size: 1.15rem;
              font-weight: 600;
              color: var(--text-primary);
              margin-bottom: 4px;
            }

            .profile-id {
              font-size: 0.8rem;
              color: var(--text-secondary);
            }

            .profile-arrow {
              font-size: 1.5rem;
              color: var(--text-hint);
            }

            .profile-menu {
              background: white;
              margin: 12px;
              border-radius: 16px;
              overflow: hidden;
              box-shadow: 0 2px 10px var(--shadow);
            }

            .menu-item {
              display: flex;
              align-items: center;
              padding: 16px;
              gap: 14px;
              border-bottom: 1px solid #f5f5f5;
              cursor: pointer;
              transition: background 0.2s;
            }

            .menu-item:last-child {
              border-bottom: none;
            }

            .menu-item:active {
              background: #f9f9f9;
            }

            .menu-icon {
              font-size: 22px;
              display: flex;
              align-items: center;
              justify-content: center;
              width: 24px;
              color: var(--accent-pink);
            }

            .menu-icon svg {
              stroke: var(--accent-pink);
            }

            .menu-text {
              flex: 1;
              font-size: 0.95rem;
              color: var(--text-primary);
            }

            .menu-arrow {
              font-size: 1.2rem;
              color: var(--text-hint);
            }

            /* Chat Tab Bar */
            .chat-tab-bar {
              position: fixed;
              bottom: 20px;
              left: 50%;
              transform: translateX(-50%);
              display: flex;
              justify-content: center;
              gap: 4px;
              background: rgba(255, 255, 255, 0.7);
              backdrop-filter: blur(25px) saturate(180%);
              -webkit-backdrop-filter: blur(25px) saturate(180%);
              padding: 8px 16px;
              border-radius: 25px;
              border: 1px solid rgba(255, 255, 255, 0.5);
              box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
              z-index: 50;
              width: calc(100% - 40px);
              max-width: 400px;
            }

            .chat-tab {
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 2px;
              padding: 6px 0;
              cursor: pointer;
              transition: all 0.2s;
              border-radius: 16px;
              flex: 1;
            }

            .chat-tab:active {
              transform: scale(0.95);
            }

            .chat-tab.active {
              background: rgba(244, 143, 177, 0.15);
            }

            .tab-icon {
              font-size: 20px;
              opacity: 0.5;
              transition: opacity 0.2s;
              display: flex;
              align-items: center;
              justify-content: center;
              color: var(--text-secondary);
            }

            .tab-icon svg {
              stroke: var(--text-secondary);
            }

            .chat-tab.active .tab-icon {
              opacity: 1;
            }

            .chat-tab.active .tab-icon svg {
              stroke: var(--accent-pink);
            }

            .tab-label {
              font-size: 0.6rem;
              color: var(--text-secondary);
              transition: color 0.2s;
            }

            .chat-tab.active .tab-label {
              color: var(--accent-pink);
              font-weight: 600;
            }

            /* Tab Badge 小红点 */
            .tab-badge {
              position: absolute;
              top: 2px;
              right: 50%;
              transform: translateX(12px);
              min-width: 16px;
              height: 16px;
              background: #ff3b30;
              color: white;
              font-size: 10px;
              font-weight: 600;
              border-radius: 8px;
              display: flex;
              align-items: center;
              justify-content: center;
              padding: 0 4px;
              box-shadow: 0 2px 4px rgba(255, 59, 48, 0.4);
              animation: badgePop 0.3s ease;
            }

            .chat-tab {
              position: relative;
            }

            @keyframes badgePop {
              0% { transform: translateX(12px) scale(0); }
              50% { transform: translateX(12px) scale(1.2); }
              100% { transform: translateX(12px) scale(1); }
            }

            /* 新消息通知弹窗 - 可爱小卡片风格 */
            .message-notification {
              position: fixed;
              top: max(16px, env(safe-area-inset-top));
              left: 50%;
              transform: translateX(-50%) translateY(-200%);
              width: calc(100% - 32px);
              max-width: 340px;
              background: linear-gradient(135deg, #fff 0%, #fff5f8 100%);
              backdrop-filter: blur(20px);
              -webkit-backdrop-filter: blur(20px);
              padding: 14px 16px;
              display: flex;
              align-items: center;
              gap: 12px;
              border-radius: 20px;
              box-shadow: 0 8px 32px rgba(244, 143, 177, 0.25),
                          0 2px 8px rgba(0, 0, 0, 0.08),
                          inset 0 1px 0 rgba(255, 255, 255, 0.8);
              border: 1px solid rgba(244, 143, 177, 0.2);
              z-index: 9999;
              transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
              cursor: pointer;
              /* 确保在PWA模式下也完全隐藏 */
              opacity: 0;
              visibility: hidden;
            }

            .message-notification.show {
              transform: translateX(-50%) translateY(0);
              opacity: 1;
              visibility: visible;
            }

            .notification-avatar {
              width: 48px;
              height: 48px;
              border-radius: 14px;
              background: linear-gradient(135deg, #fce4ec, #f8bbd9);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 22px;
              flex-shrink: 0;
              box-shadow: 0 4px 12px rgba(244, 143, 177, 0.3);
              overflow: hidden;
            }

            .notification-avatar img {
              width: 100%;
              height: 100%;
              border-radius: 14px;
              object-fit: cover;
            }

            .notification-content {
              flex: 1;
              min-width: 0;
            }

            .notification-name {
              font-size: 15px;
              font-weight: 600;
              color: #c2185b;
              margin-bottom: 3px;
              display: flex;
              align-items: center;
              gap: 6px;
            }

            .notification-name::after {
              content: '♡';
              font-size: 12px;
            }

            .notification-text {
              font-size: 13px;
              color: #666;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
              line-height: 1.4;
            }

            .notification-time {
              font-size: 11px;
              color: #f48fb1;
              flex-shrink: 0;
              background: rgba(244, 143, 177, 0.1);
              padding: 4px 8px;
              border-radius: 10px;
            }

            /* Create Character Modal */
            .create-char-content {
              background: white;
              border-radius: 24px;
              padding: 28px 24px;
              width: 100%;
              max-width: 340px;
              box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            }

            .create-char-title {
              font-size: 1.2rem;
              font-weight: 700;
              color: var(--text-primary);
              text-align: center;
              margin-bottom: 24px;
            }

            .create-avatar-section {
              display: flex;
              flex-direction: column;
              align-items: center;
              margin-bottom: 24px;
              cursor: pointer;
            }

            .create-avatar {
              width: 90px;
              height: 90px;
              border-radius: 50%;
              background: linear-gradient(135deg, #fce4ec, #f3e5f5);
              display: flex;
              align-items: center;
              justify-content: center;
              margin-bottom: 10px;
              overflow: hidden;
              border: 3px dashed #e0e0e0;
              transition: all 0.3s ease;
            }

            .create-avatar:active {
              transform: scale(0.95);
            }

            .create-avatar.has-image {
              border: 3px solid var(--accent-pink);
            }

            .create-avatar-placeholder {
              font-size: 32px;
              opacity: 0.6;
            }

            .create-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }

            .create-avatar-hint {
              font-size: 0.8rem;
              color: var(--text-hint);
            }

            .create-input-group {
              margin-bottom: 18px;
            }

            .create-label {
              display: block;
              font-size: 0.85rem;
              font-weight: 600;
              color: var(--text-primary);
              margin-bottom: 8px;
            }

            .create-label .required {
              color: #ff6b6b;
            }

            .create-label .optional {
              font-weight: 400;
              color: var(--text-hint);
            }

            .create-input {
              width: 100%;
              padding: 14px 16px;
              border: 1.5px solid #e8e8e8;
              border-radius: 14px;
              font-size: 0.95rem;
              font-family: inherit;
              outline: none;
              transition: border-color 0.2s, box-shadow 0.2s;
              background: #fafafa;
            }

            .create-input:focus {
              border-color: var(--accent-pink);
              background: white;
              box-shadow: 0 0 0 3px rgba(244, 143, 177, 0.15);
            }

            .create-input::placeholder {
              color: var(--text-hint);
            }

            .create-buttons {
              display: flex;
              gap: 12px;
              margin-top: 24px;
            }

            .create-btn {
              flex: 1;
              padding: 14px;
              border: none;
              border-radius: 14px;
              font-size: 0.95rem;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
              font-family: inherit;
            }

            .create-btn:active {
              transform: scale(0.98);
            }

            .create-btn-cancel {
              background: #f5f5f5;
              color: var(--text-secondary);
            }

            .create-btn-cancel:active {
              background: #eeeeee;
            }

            .create-btn-confirm {
              background: linear-gradient(135deg, #f48fb1, #f06292);
              color: white;
              box-shadow: 0 4px 15px rgba(244, 143, 177, 0.4);
            }

            .create-btn-confirm:active {
              box-shadow: 0 2px 8px rgba(244, 143, 177, 0.4);
            }

            /* ==================== API SETTINGS STYLES ==================== */
            .api-settings-page {
              background: #f5f5f5 !important;
              padding: 0 !important;
            }

            .api-settings-page::before {
              display: none;
            }

            .api-settings-page .page-header {
              display: flex;
              align-items: center;
              background: white;
              padding: 12px 16px;
              padding-top: max(12px, env(safe-area-inset-top));
              border-bottom: 1px solid #eee;
            }

            .page-header-add {
              width: 36px;
              height: 36px;
              border: none;
              background: none;
              font-size: 20px;
              cursor: pointer;
            }

            .api-settings-content {
              padding: 16px;
              padding-bottom: calc(40px + env(safe-area-inset-bottom));
            }

            .api-section {
              margin-bottom: 20px;
            }

            .api-section-title {
              font-size: 0.85rem;
              font-weight: 600;
              color: var(--text-secondary);
              margin-bottom: 12px;
              padding-left: 4px;
            }

            .api-preset-list {
              background: white;
              border-radius: 16px;
              overflow: hidden;
              box-shadow: 0 2px 10px var(--shadow);
            }

            .api-preset-item {
              display: flex;
              align-items: center;
              padding: 16px;
              border-bottom: 1px solid #f0f0f0;
              cursor: pointer;
              transition: background 0.2s;
            }

            .api-preset-item:last-child {
              border-bottom: none;
            }

            .api-preset-item:active {
              background: #f9f9f9;
            }

            .api-preset-item.active {
              background: linear-gradient(135deg, #fce4ec, #fff);
            }

            .preset-radio {
              width: 22px;
              height: 22px;
              border-radius: 50%;
              border: 2px solid #ddd;
              margin-right: 14px;
              display: flex;
              align-items: center;
              justify-content: center;
              flex-shrink: 0;
              transition: all 0.2s;
            }

            .api-preset-item.active .preset-radio {
              border-color: var(--accent-pink);
              background: var(--accent-pink);
            }

            .api-preset-item.active .preset-radio::after {
              content: "✓";
              color: white;
              font-size: 12px;
              font-weight: bold;
            }

            .preset-info {
              flex: 1;
              min-width: 0;
            }

            .preset-name {
              font-size: 1rem;
              font-weight: 600;
              color: var(--text-primary);
              margin-bottom: 4px;
            }

            .preset-detail {
              font-size: 0.8rem;
              color: var(--text-hint);
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
            }

            .preset-edit-btn {
              width: 36px;
              height: 36px;
              border: none;
              background: #f5f5f5;
              border-radius: 10px;
              font-size: 14px;
              cursor: pointer;
              transition: all 0.2s;
            }

            .preset-edit-btn:active {
              background: #eee;
            }

            .active-config-card {
              background: white;
              border-radius: 16px;
              padding: 16px;
              box-shadow: 0 2px 10px var(--shadow);
            }

            .active-config-row {
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 10px 0;
              border-bottom: 1px solid #f5f5f5;
            }

            .active-config-row:last-child {
              border-bottom: none;
            }

            .active-label {
              font-size: 0.9rem;
              color: var(--text-secondary);
            }

            .active-value {
              font-size: 0.9rem;
              font-weight: 600;
              color: var(--text-primary);
              max-width: 60%;
              text-align: right;
              word-break: break-all;
            }

            .active-status {
              font-size: 0.8rem;
              font-weight: 600;
              padding: 4px 12px;
              border-radius: 20px;
              background: #e8f5e9;
              color: #4caf50;
            }

            .api-tips {
              background: #fff8e1;
              border-radius: 12px;
              padding: 14px 16px;
              margin-top: 20px;
            }

            .api-tips-title {
              font-size: 0.85rem;
              font-weight: 600;
              color: #f57c00;
              margin-bottom: 6px;
            }

            .api-tips-content {
              font-size: 0.82rem;
              color: #e65100;
              line-height: 1.5;
            }

            /* API Modal */
            .api-modal {
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0, 0, 0, 0.5);
              z-index: 400;
              align-items: flex-end;
              justify-content: center;
            }

            .api-modal.active {
              display: flex;
            }

            .api-modal-content {
              background: white;
              width: 100%;
              max-height: 90vh;
              border-radius: 24px 24px 0 0;
              display: flex;
              flex-direction: column;
              animation: slideUpModal 0.3s ease-out;
            }

            @keyframes slideUpModal {
              from {
                transform: translateY(100%);
              }
              to {
                transform: translateY(0);
              }
            }

            .api-modal-header {
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 20px 20px 16px;
              border-bottom: 1px solid #f0f0f0;
            }

            .api-modal-title {
              font-size: 1.1rem;
              font-weight: 700;
              color: var(--text-primary);
            }

            .api-modal-close {
              width: 32px;
              height: 32px;
              border: none;
              background: #f5f5f5;
              border-radius: 50%;
              font-size: 16px;
              cursor: pointer;
              color: var(--text-secondary);
            }

            .api-modal-body {
              padding: 20px;
              overflow-y: auto;
              flex: 1;
            }

            .api-field {
              margin-bottom: 20px;
            }

            .api-field-label {
              display: block;
              font-size: 0.9rem;
              font-weight: 600;
              color: var(--text-primary);
              margin-bottom: 10px;
            }

            .api-field-input {
              width: 100%;
              padding: 14px 16px;
              border: 1.5px solid #e8e8e8;
              border-radius: 12px;
              font-size: 0.95rem;
              font-family: inherit;
              outline: none;
              transition: all 0.2s;
              background: #fafafa;
            }

            .api-field-input:focus {
              border-color: var(--accent-pink);
              background: white;
              box-shadow: 0 0 0 3px rgba(244, 143, 177, 0.15);
            }

            .api-field-key {
              position: relative;
            }

            .api-field-key .api-field-input {
              padding-right: 50px;
            }

            .key-toggle-btn {
              position: absolute;
              right: 12px;
              top: 50%;
              transform: translateY(-50%);
              background: none;
              border: none;
              font-size: 18px;
              cursor: pointer;
              opacity: 0.6;
            }

            .model-select-row {
              display: flex;
              gap: 10px;
            }

            .model-input {
              flex: 1;
              cursor: pointer;
            }

            .model-fetch-btn {
              padding: 14px 20px;
              background: #f5f5f5;
              border: 1.5px solid #e8e8e8;
              border-radius: 12px;
              font-size: 0.9rem;
              font-weight: 600;
              color: var(--text-primary);
              cursor: pointer;
              white-space: nowrap;
              transition: all 0.2s;
              font-family: inherit;
            }

            .model-fetch-btn:active {
              background: #eee;
            }

            .model-fetch-btn.loading {
              color: var(--text-hint);
              pointer-events: none;
            }

            .model-hint {
              font-size: 0.75rem;
              color: var(--text-hint);
              margin-top: 6px;
              padding-left: 2px;
            }

            .model-dropdown {
              display: none;
              max-height: 200px;
              overflow-y: auto;
              background: white;
              border: 1.5px solid #e8e8e8;
              border-radius: 12px;
              margin-top: 8px;
              box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }

            .model-dropdown.active {
              display: block;
            }

            .model-option {
              padding: 12px 16px;
              font-size: 0.9rem;
              color: var(--text-primary);
              cursor: pointer;
              transition: background 0.2s;
              border-bottom: 1px solid #f5f5f5;
            }

            .model-option:last-child {
              border-bottom: none;
            }

            .model-option:hover,
            .model-option:active {
              background: #f5f5f5;
            }

            .model-option.selected {
              background: #fce4ec;
              color: var(--accent-pink);
              font-weight: 600;
            }

            .api-modal-footer {
              display: flex;
              justify-content: space-between;
              align-items: center;
              padding: 16px 20px;
              padding-bottom: calc(16px + env(safe-area-inset-bottom));
              border-top: 1px solid #f0f0f0;
              background: #fafafa;
            }

            .api-modal-btn-group {
              display: flex;
              gap: 10px;
            }

            .api-modal-btn {
              padding: 12px 24px;
              border: none;
              border-radius: 12px;
              font-size: 0.95rem;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
              font-family: inherit;
            }

            .api-modal-btn:active {
              transform: scale(0.98);
            }

            .btn-cancel {
              background: #f5f5f5;
              color: var(--text-secondary);
            }

            .btn-save {
              background: linear-gradient(135deg, #f48fb1, #f06292);
              color: white;
              box-shadow: 0 4px 15px rgba(244, 143, 177, 0.4);
            }

            .btn-delete {
              background: none;
              color: #ff6b6b;
              padding: 12px 16px;
            }

            /* ==================== CHAT CONVERSATION PAGE ==================== */
            .chat-conversation-page {
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: #f5f5f5;
              z-index: 300;
              flex-direction: column;
            }

            .chat-conversation-page.active {
              display: flex;
            }

            .conv-header {
              display: flex;
              align-items: center;
              padding: 10px 16px;
              padding-top: max(10px, env(safe-area-inset-top));
              background: transparent;
              border: none;
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              z-index: 100;
            }

            .conv-back-btn {
              width: 36px;
              height: 36px;
              border: 1.5px solid rgba(0, 0, 0, 0.15);
              background: rgba(255, 255, 255, 0.6);
              backdrop-filter: blur(10px);
              -webkit-backdrop-filter: blur(10px);
              border-radius: 50%;
              font-size: 18px;
              color: #000;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
            }
            .conv-back-btn svg {
              stroke: #000;
            }

            .conv-title-section {
              flex: 1;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              gap: 2px;
              margin: 0 40px;
            }

            .conv-avatar {
              display: none;
            }

            .conv-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }

            .conv-name {
              font-size: 1rem;
              font-weight: 600;
              color: var(--text-primary);
            }

            .conv-subtitle {
              font-size: 0.75rem;
              color: var(--text-secondary);
            }

            .conv-menu-btn {
              width: 36px;
              height: 36px;
              border: 1.5px solid rgba(0, 0, 0, 0.1);
              background: rgba(255, 255, 255, 0.6);
              backdrop-filter: blur(10px);
              -webkit-backdrop-filter: blur(10px);
              border-radius: 50%;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 3px;
              padding: 0;
            }

            .conv-menu-btn::before,
            .conv-menu-btn::after,
            .conv-menu-btn span {
              content: '';
              width: 4px;
              height: 4px;
              background: #666;
              border-radius: 50%;
              display: block;
            }

            .conv-menu {
              display: none;
              position: absolute;
              top: 100%;
              right: 16px;
              background: rgba(255, 255, 255, 0.95);
              backdrop-filter: saturate(180%) blur(20px);
              -webkit-backdrop-filter: saturate(180%) blur(20px);
              border-radius: 12px;
              box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
              overflow: hidden;
              z-index: 110;
            }

            .conv-menu.active {
              display: block;
            }

            .conv-menu-item {
              padding: 14px 20px;
              font-size: 0.9rem;
              color: var(--text-primary);
              cursor: pointer;
              transition: background 0.2s;
              white-space: nowrap;
            }

            .conv-menu-item:hover {
              background: #f5f5f5;
            }

            .conv-menu-item:last-child {
              color: #ff6b6b;
            }

            .conv-messages {
              flex: 1;
              overflow-y: auto;
              padding: 16px;
              padding-top: 100px;
              padding-bottom: calc(100px + env(safe-area-inset-bottom));
              display: flex;
              flex-direction: column;
              gap: 8px;
              background: transparent;
            }

            .conv-empty {
              display: none;
            }

            .conv-empty-icon {
              font-size: 48px;
              margin-bottom: 12px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: var(--text-secondary);
            }

            .conv-empty-icon svg {
              stroke: var(--text-hint);
            }

            .conv-empty-text {
              font-size: 0.95rem;
              color: var(--text-secondary);
            }

            /* Message bubbles - iMessage style */
            .msg-row {
              display: flex;
              flex-direction: column;
              max-width: 80%;
            }

            .msg-row.user {
              align-self: flex-end;
              align-items: flex-end;
            }

            .msg-row.ai {
              align-self: flex-start;
              align-items: flex-start;
            }
            .msg-bubble {
              padding: 6px 10px;
              border-radius: 14px;
              font-size: 0.95rem;
              line-height: 1.45;
              word-break: break-word;
              margin-bottom: 2px;

              /* 关键修复：让气泡包住文字，且支持长文换行 */
              width: fit-content;
              max-width: 100%;
              display: inline-block;
              white-space: normal;

              position: relative;
              min-height: auto;
            }
            .msg-row.user .msg-bubble {
              background: linear-gradient(135deg, #fce4ec, #f8bbd9);
              color: #c2185b;
              border-bottom-right-radius: 6px;
            }

            .msg-row.user .msg-bubble:last-child {
              border-bottom-right-radius: 18px;
            }

            .msg-row.ai .msg-bubble {
              background: white;
              color: var(--text-primary);
              border-bottom-left-radius: 6px;
              box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            }

            .msg-row.ai .msg-bubble:last-child {
              border-bottom-left-radius: 18px;
            }

            .msg-time {
              font-size: 0.7rem;
              color: var(--text-hint);
              margin-top: 4px;
              padding: 0 4px;
            }

            /* 图片消息样式 */
            .msg-image {
              border-radius: 12px;
              overflow: hidden;
              max-width: 200px;
              cursor: pointer;
              position: relative;
            }
            .msg-image img {
              width: 100%;
              height: auto;
              display: block;
              max-height: 250px;
              object-fit: cover;
            }
            /* 占位图样式 */
            .msg-image-placeholder {
              width: 180px;
              height: 140px;
              border-radius: 12px;
              background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              cursor: pointer;
              position: relative;
              overflow: hidden;
            }
            .msg-row.user .msg-image-placeholder {
              background: linear-gradient(135deg, #f48fb1 0%, #ec407a 100%);
            }
            .msg-image-placeholder-icon {
              width: 48px;
              height: 48px;
              border-radius: 50%;
              background: rgba(255,255,255,0.3);
              display: flex;
              align-items: center;
              justify-content: center;
              margin-bottom: 8px;
            }
            .msg-image-placeholder-icon svg {
              stroke: #66bb6a;
            }
            .msg-row.user .msg-image-placeholder-icon svg {
              stroke: #fff;
            }
            .msg-image-placeholder-text {
              font-size: 0.75rem;
              color: #66bb6a;
              font-weight: 500;
            }
            .msg-row.user .msg-image-placeholder-text {
              color: #fff;
            }
            /* 真实图片消息 */
            .msg-real-image {
              max-width: 200px;
              border-radius: 12px;
              overflow: hidden;
              cursor: pointer;
            }
            .msg-real-image img {
              width: 100%;
              height: auto;
              display: block;
              max-height: 300px;
              object-fit: cover;
            }
            .image-message-bubble {
              padding: 0 !important;
              background: transparent !important;
              box-shadow: none !important;
            }
            /* 图片描述弹窗 */
            .image-desc-modal {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.6);
              z-index: 10005;
              display: none;
              align-items: center;
              justify-content: center;
              padding: 20px;
            }
            .image-desc-modal.active {
              display: flex;
            }
            .image-desc-content {
              background: white;
              border-radius: 20px;
              max-width: 320px;
              width: 100%;
              overflow: hidden;
              animation: modalPop 0.25s ease;
            }
            .image-desc-header {
              padding: 16px 20px;
              border-bottom: 1px solid #f0f0f0;
              display: flex;
              align-items: center;
              justify-content: space-between;
            }
            .image-desc-title {
              font-size: 1rem;
              font-weight: 600;
              color: #333;
            }
            .image-desc-close {
              width: 28px;
              height: 28px;
              border: none;
              background: #f5f5f5;
              border-radius: 50%;
              cursor: pointer;
              font-size: 14px;
            }
            .image-desc-body {
              padding: 20px;
            }
            .image-desc-preview {
              width: 100%;
              height: 160px;
              border-radius: 12px;
              background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
              display: flex;
              align-items: center;
              justify-content: center;
              margin-bottom: 16px;
              overflow: hidden;
            }
            .image-desc-preview img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            .image-desc-preview-icon {
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 8px;
              color: #66bb6a;
            }
            .image-desc-text {
              font-size: 0.95rem;
              line-height: 1.6;
              color: #333;
              background: #f9f9f9;
              padding: 14px 16px;
              border-radius: 12px;
              word-break: break-word;
            }
            .image-desc-input {
              width: 100%;
              min-height: 80px;
              border: 1px solid #e0e0e0;
              border-radius: 12px;
              padding: 12px;
              font-size: 0.9rem;
              resize: none;
              font-family: inherit;
            }
            .image-desc-input:focus {
              outline: none;
              border-color: #f48fb1;
            }
            .image-desc-footer {
              padding: 16px 20px;
              border-top: 1px solid #f0f0f0;
              display: flex;
              gap: 10px;
            }
            .image-desc-btn {
              flex: 1;
              padding: 12px;
              border: none;
              border-radius: 12px;
              font-size: 0.9rem;
              font-weight: 500;
              cursor: pointer;
            }
            .image-desc-btn.cancel {
              background: #f5f5f5;
              color: #666;
            }
            .image-desc-btn.confirm {
              background: linear-gradient(135deg, #f48fb1, #ec407a);
              color: white;
            }
            /* 发送图片选择弹窗 */
            .send-image-modal {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.5);
              z-index: 10004;
              display: none;
              align-items: flex-end;
              justify-content: center;
            }
            .send-image-modal.active {
              display: flex;
            }
            .send-image-options {
              background: white;
              border-radius: 20px 20px 0 0;
              width: 100%;
              max-width: 500px;
              padding: 20px;
              padding-bottom: calc(20px + env(safe-area-inset-bottom));
              animation: slideUp 0.3s ease;
            }
            @keyframes slideUp {
              from { transform: translateY(100%); }
              to { transform: translateY(0); }
            }
            .send-image-title {
              text-align: center;
              font-size: 1rem;
              font-weight: 600;
              color: #333;
              margin-bottom: 20px;
            }
            .send-image-grid {
              display: grid;
              grid-template-columns: repeat(3, 1fr);
              gap: 16px;
              margin-bottom: 16px;
            }
            .send-image-grid.two-cols {
              grid-template-columns: repeat(2, 1fr);
            }
            .send-image-item {
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 6px;
              cursor: pointer;
              padding: 20px 12px;
              border-radius: 16px;
              background: #f9f9f9;
              transition: all 0.2s;
            }
            .send-image-hint {
              font-size: 0.7rem;
              color: #999;
              margin-top: -2px;
            }
            .send-image-item:active {
              transform: scale(0.95);
              background: #f0f0f0;
            }
            .send-image-icon {
              width: 50px;
              height: 50px;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
            }
            .send-image-icon.album {
              background: linear-gradient(135deg, #81d4fa, #4fc3f7);
            }
            .send-image-icon.camera {
              background: linear-gradient(135deg, #a5d6a7, #66bb6a);
            }
            .send-image-icon.desc {
              background: linear-gradient(135deg, #ffcc80, #ffa726);
            }
            .send-image-icon svg {
              stroke: white;
            }
            .send-image-label {
              font-size: 0.8rem;
              color: #666;
            }
            .send-image-cancel {
              width: 100%;
              padding: 14px;
              border: none;
              background: #f5f5f5;
              border-radius: 12px;
              font-size: 0.95rem;
              color: #666;
              cursor: pointer;
            }
            .msg-system-card {
              width: 100%;
              display: flex;
              justify-content: center;
              margin: 16px 0;
            }

            .system-card {
              background: linear-gradient(135deg, #fff5f8 0%, #fce4ec 100%);
              border-radius: 16px;
              padding: 14px 18px;
              max-width: 280px;
              box-shadow: 0 4px 16px rgba(244, 143, 177, 0.15);
              border: 1px solid rgba(244, 143, 177, 0.2);
              text-align: center;
            }

            .system-card-icon {
              font-size: 28px;
              margin-bottom: 8px;
            }

            .system-card-title {
              font-size: 14px;
              font-weight: 600;
              color: #c2185b;
              margin-bottom: 4px;
            }

            .system-card-desc {
              font-size: 12px;
              color: #888;
            }

            .msg-typing {
              display: flex;
              gap: 4px;
              padding: 12px 16px;
            }

            .msg-typing span {
              width: 8px;
              height: 8px;
              background: #ccc;
              border-radius: 50%;
              animation: typing 1.4s infinite;
            }

            .msg-typing span:nth-child(2) {
              animation-delay: 0.2s;
            }

            .msg-typing span:nth-child(3) {
              animation-delay: 0.4s;
            }

            @keyframes typing {
              0%,
              60%,
              100% {
                transform: translateY(0);
                opacity: 0.4;
              }
              30% {
                transform: translateY(-6px);
                opacity: 1;
              }
            }

            /* Input area - 完全透明 */
            .conv-input-area {
              padding: 12px 16px;
              padding-bottom: calc(12px + env(safe-area-inset-bottom));
              background: none;
              backdrop-filter: none;
              -webkit-backdrop-filter: none;
              border: none;
              position: fixed;
              bottom: 0;
              left: 0;
              right: 0;
              z-index: 100;
            }

            .conv-input-wrapper {
              display: flex;
              align-items: flex-end;
              gap: 10px;
              background: rgba(255, 255, 255, 0.85);
              border-radius: 20px;
              padding: 8px 8px 8px 16px;
              margin-bottom: 10px;
            }

            .conv-input {
              flex: 1;
              border: none;
              background: none;
              font-size: 0.95rem;
              font-family: inherit;
              resize: none;
              outline: none;
              max-height: 100px;
              line-height: 1.4;
            }

            .conv-send-btn {
              width: 32px;
              height: 32px;
              border-radius: 50%;
              border: none;
              background: linear-gradient(135deg, #f48fb1, #f06292);
              color: white;
              font-size: 16px;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              flex-shrink: 0;
              transition: all 0.2s;
            }

            .conv-send-btn:active {
              transform: scale(0.9);
            }

            .conv-reply-btn {
              width: 100%;
              padding: 12px;
              background: linear-gradient(135deg, #667eea, #764ba2);
              color: white;
              border: none;
              border-radius: 12px;
              font-size: 0.9rem;
              font-weight: 600;
              cursor: pointer;
              font-family: inherit;
              transition: all 0.2s;
              box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            }

            .conv-reply-btn:active {
              transform: scale(0.98);
            }

            .conv-reply-btn:disabled {
              opacity: 0.6;
              cursor: not-allowed;
            }

            .conv-reply-btn.loading {
              background: #ccc;
              box-shadow: none;
            }

            /* ==================== CHAT SETTINGS STYLES ==================== */
            .chat-settings-page {
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: linear-gradient(180deg, #fff5f8 0%, #ffeef5 100%);
              z-index: 350;
              flex-direction: column;
              overflow: hidden;
            }

            .chat-settings-page.active {
              display: flex;
              animation: slideInRight 0.3s ease-out;
            }

            @keyframes slideInRight {
              from {
                transform: translateX(100%);
                opacity: 0;
              }
              to {
                transform: translateX(0);
                opacity: 1;
              }
            }

            .settings-header {
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 16px 20px;
              padding-top: max(16px, env(safe-area-inset-top));
              background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
              border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            }

            .settings-header-title {
              font-size: 1.15rem;
              font-weight: 700;
              color: #c2185b;
              display: flex;
              align-items: center;
              gap: 8px;
              flex: 1;
              justify-content: center;
            }

            .settings-header-title::before {
              content: "⚙️";
              font-size: 1.1rem;
            }

            .settings-back-btn {
              width: 36px;
              height: 36px;
              border: none;
              background: rgba(255, 255, 255, 0.6);
              border-radius: 50%;
              font-size: 24px;
              cursor: pointer;
              color: #c2185b;
              transition: all 0.2s;
              display: flex;
              align-items: center;
              justify-content: center;
              flex-shrink: 0;
            }

            .settings-back-btn:active {
              transform: scale(0.9);
              background: rgba(255, 255, 255, 0.8);
            }

            .settings-save-btn {
              padding: 8px 16px;
              border: none;
              background: #c2185b;
              border-radius: 20px;
              font-size: 14px;
              font-weight: 600;
              cursor: pointer;
              color: white;
              transition: all 0.2s;
              flex-shrink: 0;
            }

            .settings-save-btn:active {
              transform: scale(0.95);
              background: #ad1457;
            }

            .settings-close-btn {
              width: 36px;
              height: 36px;
              border: none;
              background: rgba(255, 255, 255, 0.6);
              border-radius: 50%;
              font-size: 18px;
              cursor: pointer;
              color: #c2185b;
              transition: all 0.2s;
            }

            .settings-close-btn:active {
              transform: scale(0.9);
              background: rgba(255, 255, 255, 0.8);
            }

            .settings-content {
              flex: 1;
              overflow-y: auto;
              padding: 16px;
              padding-bottom: calc(100px + env(safe-area-inset-bottom));
            }

            .settings-section {
              background: white;
              border-radius: 20px;
              margin-bottom: 16px;
              overflow: hidden;
              box-shadow: 0 2px 12px rgba(194, 24, 91, 0.08);
            }

            .section-header {
              display: flex;
              align-items: center;
              gap: 10px;
              padding: 16px 20px;
              background: linear-gradient(135deg, #fff0f5 0%, #fce4ec 100%);
              border-bottom: 1px solid rgba(0, 0, 0, 0.03);
            }

            .section-icon {
              width: 28px;
              height: 28px;
              border-radius: 8px;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 14px;
            }

            .section-icon.brown {
              background: linear-gradient(135deg, #f8bbd9, #f48fb1);
            }
            .section-icon.purple {
              background: linear-gradient(135deg, #e1bee7, #ce93d8);
            }
            .section-icon.teal {
              background: linear-gradient(135deg, #b2dfdb, #80cbc4);
            }
            .section-icon.orange {
              background: linear-gradient(135deg, #ffe0b2, #ffcc80);
            }
            .section-icon.blue {
              background: linear-gradient(135deg, #bbdefb, #90caf9);
            }

            .section-title {
              font-size: 0.95rem;
              font-weight: 700;
              color: #c2185b;
            }

            .section-body {
              padding: 16px 20px;
            }

            /* 记忆互通多选下拉框样式 */
            .memory-link-dropdown {
              position: relative;
              width: 100%;
            }

            .memory-link-select {
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 12px 16px;
              background: #f8f8f8;
              border: 1px solid rgba(0,0,0,0.1);
              border-radius: 12px;
              cursor: pointer;
              transition: all 0.2s;
            }

            .memory-link-select:hover {
              background: #f0f0f0;
              border-color: rgba(194, 24, 91, 0.3);
            }

            .memory-link-text {
              font-size: 0.9rem;
              color: #666;
              flex: 1;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
            }

            .memory-link-arrow {
              font-size: 0.7rem;
              color: #999;
              margin-left: 8px;
              transition: transform 0.2s;
            }

            .memory-link-dropdown.open .memory-link-arrow {
              transform: rotate(180deg);
            }

            .memory-link-options {
              position: absolute;
              top: 100%;
              left: 0;
              right: 0;
              max-height: 0;
              overflow: hidden;
              background: white;
              border-radius: 12px;
              box-shadow: 0 4px 20px rgba(0,0,0,0.15);
              z-index: 100;
              transition: max-height 0.3s ease;
              margin-top: 4px;
            }

            .memory-link-dropdown.open .memory-link-options {
              max-height: 250px;
              overflow-y: auto;
            }

            .memory-link-option {
              display: flex;
              align-items: center;
              padding: 10px 14px;
              cursor: pointer;
              transition: background 0.2s;
              gap: 10px;
            }

            .memory-link-option:hover {
              background: #fce4ec;
            }

            .memory-link-option.selected {
              background: linear-gradient(135deg, rgba(244,143,177,0.15), rgba(244,143,177,0.08));
            }

            .memory-link-option input[type="checkbox"] {
              width: 18px;
              height: 18px;
              accent-color: #f48fb1;
              flex-shrink: 0;
            }

            .memory-link-option-avatar {
              width: 32px;
              height: 32px;
              border-radius: 50%;
              background: #f5f5f5;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 14px;
              overflow: hidden;
              flex-shrink: 0;
            }

            .memory-link-option-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }

            .memory-link-option-name {
              font-size: 0.9rem;
              color: #333;
              flex: 1;
            }

            .memory-link-tags {
              display: flex;
              flex-wrap: wrap;
              gap: 6px;
              margin-top: 8px;
            }

            .memory-link-tag {
              display: inline-flex;
              align-items: center;
              gap: 4px;
              padding: 4px 10px;
              background: linear-gradient(135deg, #fce4ec, #f8bbd9);
              border-radius: 20px;
              font-size: 0.8rem;
              color: #c2185b;
            }

            .memory-link-tag-remove {
              cursor: pointer;
              font-size: 0.9rem;
              opacity: 0.7;
              margin-left: 2px;
            }

            .memory-link-tag-remove:hover {
              opacity: 1;
            }

            .memory-link-empty {
              text-align: center;
              padding: 20px;
              color: #999;
              font-size: 0.85rem;
            }

            .memory-link-section-title {
              font-size: 0.75rem;
              color: #999;
              padding: 8px 14px 4px;
              font-weight: 600;
              border-bottom: 1px dashed #f0f0f0;
              margin-bottom: 4px;
            }

            /* Form Elements */
            .form-group {
              margin-bottom: 18px;
            }

            .form-group:last-child {
              margin-bottom: 0;
            }

            .form-label {
              display: block;
              font-size: 0.82rem;
              font-weight: 600;
              color: #7a6b5a;
              margin-bottom: 8px;
            }

            .form-hint {
              font-size: 0.72rem;
              color: #a99e8f;
              font-weight: 400;
              margin-left: 4px;
            }

            .form-input {
              width: 100%;
              padding: 12px 16px;
              border: 1.5px solid #e5ddd3;
              border-radius: 12px;
              font-size: 0.9rem;
              font-family: inherit;
              outline: none;
              background: #faf8f5;
              color: #5d4e37;
              transition: all 0.2s;
            }

            .form-input:focus {
              border-color: #c4a87c;
              background: white;
              box-shadow: 0 0 0 3px rgba(196, 168, 124, 0.15);
            }

            .form-input::placeholder {
              color: #bfb5a8;
            }

            .form-textarea {
              min-height: 100px;
              resize: vertical;
              line-height: 1.5;
            }

            .form-select-wrapper {
              display: flex;
              gap: 10px;
            }

            .form-select {
              flex: 1;
              padding: 12px 16px;
              border: 1.5px solid #e5ddd3;
              border-radius: 12px;
              font-size: 0.9rem;
              font-family: inherit;
              outline: none;
              background: #faf8f5;
              color: #5d4e37;
              cursor: pointer;
              appearance: none;
              background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%237a6b5a' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
              background-repeat: no-repeat;
              background-position: right 14px center;
              padding-right: 36px;
            }

            .form-select:focus {
              border-color: #c4a87c;
              background-color: white;
            }

            .form-btn-small {
              padding: 12px 18px;
              border: 1.5px solid #e5ddd3;
              border-radius: 12px;
              font-size: 0.85rem;
              font-weight: 600;
              font-family: inherit;
              background: #faf8f5;
              color: #7a6b5a;
              cursor: pointer;
              transition: all 0.2s;
              white-space: nowrap;
            }

            .form-btn-small:active {
              background: #f0ebe5;
              transform: scale(0.98);
            }

            /* Toggle Switch */
            .toggle-row {
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 12px 0;
              border-bottom: 1px solid #f0ebe5;
            }

            .toggle-row:last-child {
              border-bottom: none;
            }

            .toggle-label {
              font-size: 0.9rem;
              color: #5d4e37;
              font-weight: 500;
            }

            .toggle-sublabel {
              font-size: 0.75rem;
              color: #a99e8f;
              margin-top: 2px;
            }

            .toggle-switch {
              position: relative;
              width: 50px;
              height: 28px;
              cursor: pointer;
            }

            .toggle-switch input {
              opacity: 0;
              width: 0;
              height: 0;
            }

            .toggle-slider {
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: #ddd5ca;
              border-radius: 14px;
              transition: all 0.3s;
            }

            .toggle-slider::before {
              content: "";
              position: absolute;
              width: 22px;
              height: 22px;
              left: 3px;
              bottom: 3px;
              background: white;
              border-radius: 50%;
              transition: all 0.3s;
              box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .toggle-switch input:checked + .toggle-slider {
              background: linear-gradient(135deg, #c4a87c, #b49870);
            }

            .toggle-switch input:checked + .toggle-slider::before {
              transform: translateX(22px);
            }

            /* Radio Options */
            .radio-group {
              display: flex;
              gap: 12px;
            }

            .radio-option {
              flex: 1;
              padding: 12px 16px;
              border: 1.5px solid #e5ddd3;
              border-radius: 12px;
              background: #faf8f5;
              cursor: pointer;
              text-align: center;
              font-size: 0.85rem;
              color: #7a6b5a;
              font-weight: 500;
              transition: all 0.2s;
            }

            .radio-option.active {
              border-color: #c4a87c;
              background: linear-gradient(135deg, #f5efe8, #ebe3d9);
              color: #5d4e37;
              box-shadow: 0 2px 8px rgba(196, 168, 124, 0.2);
            }

            /* Avatar Upload Section */
            .avatar-upload-row {
              display: flex;
              gap: 24px;
              padding: 12px 0;
            }

            .avatar-upload-col {
              flex: 1;
              text-align: center;
            }

            .avatar-upload-label {
              font-size: 0.8rem;
              color: #7a6b5a;
              margin-bottom: 10px;
              font-weight: 600;
            }

            .avatar-preview {
              width: 72px;
              height: 72px;
              border-radius: 16px;
              margin: 0 auto 10px;
              overflow: hidden;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 32px;
              background: linear-gradient(135deg, #f5efe8, #ebe3d9);
              border: 2px dashed #d4c4b0;
              cursor: pointer;
              transition: all 0.2s;
            }

            .avatar-preview:hover {
              border-color: #c4a87c;
              background: linear-gradient(135deg, #ebe3d9, #ddd3c5);
            }

            .avatar-preview.has-image {
              border: 2px solid #c4a87c;
            }

            .avatar-preview img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }

            .avatar-actions {
              display: flex;
              flex-direction: column;
              gap: 6px;
            }

            .avatar-action-btn {
              padding: 8px 12px;
              border: 1px solid #e5ddd3;
              border-radius: 8px;
              background: white;
              font-size: 0.75rem;
              color: #7a6b5a;
              cursor: pointer;
              font-family: inherit;
              transition: all 0.2s;
            }

            .avatar-action-btn:active {
              background: #f5efe8;
            }

            /* Number Input */
            .number-input-row {
              display: flex;
              align-items: center;
              gap: 12px;
            }

            .number-input {
              width: 80px;
              padding: 10px 14px;
              border: 1.5px solid #e5ddd3;
              border-radius: 10px;
              font-size: 0.95rem;
              font-family: inherit;
              text-align: center;
              outline: none;
              background: #faf8f5;
              color: #5d4e37;
            }

            .number-input:focus {
              border-color: #c4a87c;
              background: white;
            }

            /* Slider Input */
            .slider-row {
              display: flex;
              align-items: center;
              gap: 14px;
              padding: 8px 0;
            }

            .slider-value {
              min-width: 40px;
              font-size: 0.9rem;
              font-weight: 600;
              color: #5d4e37;
              text-align: center;
            }

            .slider-track {
              flex: 1;
              height: 6px;
              background: #e5ddd3;
              border-radius: 3px;
              position: relative;
              cursor: pointer;
            }

            .slider-fill {
              position: absolute;
              left: 0;
              top: 0;
              height: 100%;
              background: linear-gradient(135deg, #c4a87c, #b49870);
              border-radius: 3px;
              transition: width 0.1s;
            }

            .slider-thumb {
              position: absolute;
              top: 50%;
              transform: translate(-50%, -50%);
              width: 20px;
              height: 20px;
              background: white;
              border: 3px solid #c4a87c;
              border-radius: 50%;
              cursor: grab;
              box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            }

            input[type="range"] {
              -webkit-appearance: none;
              appearance: none;
              width: 100%;
              height: 6px;
              background: #e5ddd3;
              border-radius: 3px;
              outline: none;
            }

            input[type="range"]::-webkit-slider-thumb {
              -webkit-appearance: none;
              width: 22px;
              height: 22px;
              background: white;
              border: 3px solid #c4a87c;
              border-radius: 50%;
              cursor: pointer;
              box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            }

            /* Action Buttons Section */
            .action-buttons-grid {
              display: grid;
              grid-template-columns: 1fr 1fr;
              gap: 12px;
            }

            .action-btn {
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
              padding: 14px 16px;
              border: 1.5px solid #e5ddd3;
              border-radius: 14px;
              background: white;
              font-size: 0.88rem;
              font-weight: 600;
              color: #5d4e37;
              cursor: pointer;
              font-family: inherit;
              transition: all 0.2s;
            }

            .action-btn:active {
              background: #f5efe8;
              transform: scale(0.98);
            }

            .action-btn.danger {
              border-color: #e8c4c4;
              color: #b85c5c;
            }

            .action-btn.danger:active {
              background: #fdf5f5;
            }

            /* Settings Footer */
            .settings-footer {
              position: fixed;
              bottom: 0;
              left: 0;
              right: 0;
              display: flex;
              gap: 12px;
              padding: 16px 20px;
              padding-bottom: calc(16px + env(safe-area-inset-bottom));
              background: white;
              border-top: 1px solid #e5ddd3;
              z-index: 10;
            }

            .footer-btn {
              flex: 1;
              padding: 14px;
              border: none;
              border-radius: 14px;
              font-size: 0.95rem;
              font-weight: 700;
              cursor: pointer;
              font-family: inherit;
              transition: all 0.2s;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
            }

            .footer-btn:active {
              transform: scale(0.98);
            }

            .footer-btn.cancel {
              background: #f5efe8;
              color: #7a6b5a;
            }

            .footer-btn.save {
              background: linear-gradient(135deg, #c4a87c, #b49870);
              color: white;
              box-shadow: 0 4px 15px rgba(180, 152, 112, 0.35);
            }

            /* Background Preview */
            .bg-preview-container {
              display: flex;
              align-items: center;
              gap: 16px;
              padding: 12px 0;
            }

            .bg-preview-phone {
              width: 80px;
              height: 140px;
              border-radius: 12px;
              background: #f5efe8;
              border: 2px solid #e5ddd3;
              overflow: hidden;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 12px;
              color: #a99e8f;
            }

            .bg-preview-phone img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }

            .bg-upload-btn {
              flex: 1;
              padding: 24px 20px;
              border: 2px dashed #d4c4b0;
              border-radius: 14px;
              background: #faf8f5;
              font-size: 0.9rem;
              font-weight: 600;
              color: #9a8b7a;
              cursor: pointer;
              font-family: inherit;
              text-align: center;
              transition: all 0.2s;
            }

            .bg-upload-btn:hover {
              border-color: #c4a87c;
              background: #f5efe8;
              color: #7a6b5a;
            }

            /* CSS Editor */
            .css-editor-container {
              margin-top: 12px;
            }

            .css-editor {
              width: 100%;
              min-height: 120px;
              padding: 14px;
              border: 1.5px solid #e5ddd3;
              border-radius: 12px;
              font-family: "Monaco", "Menlo", "Consolas", monospace;
              font-size: 0.82rem;
              line-height: 1.5;
              background: #2d2a26;
              color: #e8dfd4;
              resize: vertical;
              outline: none;
            }

            .css-editor::placeholder {
              color: #6d6560;
            }

            .css-editor:focus {
              border-color: #c4a87c;
            }

            .css-actions {
              display: flex;
              gap: 10px;
              margin-top: 10px;
            }

            /* Chat Preview */
            .chat-preview-container {
              background: linear-gradient(135deg, #f5efe8, #ebe3d9);
              border-radius: 14px;
              padding: 16px;
              margin-top: 12px;
            }

            .preview-label {
              font-size: 0.75rem;
              color: #9a8b7a;
              margin-bottom: 12px;
              font-weight: 600;
            }

            .preview-msg-row {
              display: flex;
              align-items: flex-end;
              gap: 8px;
              margin-bottom: 10px;
            }

            .preview-msg-row.right {
              flex-direction: row-reverse;
            }

            .preview-avatar {
              width: 32px;
              height: 32px;
              border-radius: 8px;
              overflow: hidden;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 16px;
              background: white;
              flex-shrink: 0;
            }

            .preview-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }

            .preview-bubble {
              padding: 10px 14px;
              border-radius: 16px;
              font-size: 0.85rem;
              max-width: 180px;
            }

            .preview-msg-row:not(.right) .preview-bubble {
              background: white;
              color: #5d4e37;
              border-bottom-left-radius: 4px;
            }

            .preview-msg-row.right .preview-bubble {
              background: linear-gradient(135deg, #c4a87c, #b49870);
              color: white;
              border-bottom-right-radius: 4px;
            }

            .preview-time {
              font-size: 0.65rem;
              color: #a99e8f;
              margin-top: 4px;
              text-align: center;
            }

            /* Settings Scrollbar */
            .settings-content::-webkit-scrollbar {
              width: 4px;
            }

            .settings-content::-webkit-scrollbar-track {
              background: transparent;
            }

            .settings-content::-webkit-scrollbar-thumb {
              background: #d4c4b0;
              border-radius: 2px;
            }
            /* ==================== 终极版：iMessage 完美连发样式 (纯CSS版) ==================== */

            /* 1. 基础设置：让气泡靠得更近，产生“成组”的感觉 */
            .msg-wrapper .msg-row .msg-bubble {
              margin-bottom: 2px !important;
            }

            /* ================= AI (左侧) 连发逻辑 ================= */
            /* 规则A：只要不是【第一个】气泡，左上角就要变尖 */
            .msg-row.ai .msg-bubble:not(:first-child) {
              border-top-left-radius: 4px !important;
            }
            /* 规则B：只要不是【最后一个】气泡，左下角就要变尖 */
            .msg-row.ai .msg-bubble:not(:last-child) {
              border-bottom-left-radius: 4px !important;
            }
            /* 修复：最后一个气泡的左下角保持圆润（收尾） */
            .msg-row.ai .msg-bubble:last-child {
              border-bottom-left-radius: 14px !important;
            }

            /* ================= 用户 (右侧) 连发逻辑 ================= */
            /* 规则A：只要不是【第一个】气泡，右上角就要变尖 */
            .msg-row.user .msg-bubble:not(:first-child) {
              border-top-right-radius: 4px !important;
            }
            /* 规则B：只要不是【最后一个】气泡，右下角就要变尖 */
            .msg-row.user .msg-bubble:not(:last-child) {
              border-bottom-right-radius: 4px !important;
            }
            /* 修复：最后一个气泡的右下角保持圆润（收尾） */
            .msg-row.user .msg-bubble:last-child {
              border-bottom-right-radius: 14px !important;
            }
            /* ==================== 聊天页面重构 (iMessage 风格) ==================== */

            .menu-item:first-child {
              border-radius: 8px 0 0 8px;
            }
            .menu-item:last-child {
              border-radius: 0 8px 8px 0;
              border-right: none;
            }

            /* 箭头 (指向上方气泡 - 当菜单显示在下方时) */
            .context-menu.arrow-top::after {
              bottom: auto;
              top: -6px;
              border-width: 0 6px 6px;
              border-color: transparent transparent rgba(40, 40, 40, 0.9) transparent;
            }
            /* 修改变换原点，从上方弹出 */
            .context-menu.arrow-top {
              transform-origin: center top;
            }
            /* ==================== 修复版：多选 & 底部栏样式 ==================== */

            /* 1. 多选模式下的气泡交互 */
            /* 当进入多选模式时，气泡变得可以点击 */
            .msg-bubble {
              transition: all 0.2s ease;
              position: relative;
            }

            /* 选中状态的气泡 */
            .msg-bubble.selected {
              background: #e3f2fd !important;
              border: 2px solid #2196f3 !important;
              color: #0d47a1 !important;
              transform: scale(0.98);
            }
            /* 用户发的气泡选中时，颜色稍微深一点以示区分 */
            .msg-row.user .msg-bubble.selected {
              background: #bbdefb !important;
              color: #002171 !important;
            }

            /* 2. 修复底部删除栏 (改为 fixed 定位，层级最高) */
            .selection-footer {
              position: fixed; /* 关键：改为 fixed */
              bottom: 0;
              left: 0;
              right: 0;
              height: 70px; /*稍微高一点 */
              background: rgba(255, 255, 255, 0.95);
              backdrop-filter: blur(20px);
              -webkit-backdrop-filter: blur(20px);
              display: none; /* 默认隐藏 */
              align-items: center;
              justify-content: space-between;
              padding: 0 24px;
              border-top: 1px solid rgba(0, 0, 0, 0.1);
              z-index: 9999; /* 保证在最上层 */
              padding-bottom: env(safe-area-inset-bottom);
              box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
              animation: slideUpFooter 0.3s ease-out;
            }

            .selection-footer.active {
              display: flex !important; /* 强制显示 */
            }

            @keyframes slideUpFooter {
              from {
                transform: translateY(100%);
              }
              to {
                transform: translateY(0);
              }
            }

            /* 按钮样式优化 */
            .selection-btn {
              font-size: 1rem;
              font-weight: 600;
              background: none;
              border: none;
              padding: 10px;
              cursor: pointer;
              border-radius: 8px;
            }
            .selection-btn:active {
              background: #f0f0f0;
            }
            .selection-btn.cancel {
              color: #555;
            }
            .selection-btn.delete {
              color: #ff3b30;
              opacity: 0.3;
              pointer-events: none;
              transition: opacity 0.2s;
            }
            .selection-btn.delete.active {
              opacity: 1;
              pointer-events: auto;
            }

            /* 隐藏之前的 checkbox 圆圈样式，因为我们改用气泡变色了 */
            .selection-checkbox-container {
              display: none !important;
            }
            .msg-wrapper.selecting {
              transform: none !important;
            }

            /* 多选模式 - 每个气泡的选择器 */
            .bubble-with-selector {
              display: flex;
              align-items: center;
              gap: 8px;
            }
            .bubble-with-selector.ai {
              flex-direction: row;
            }
            .bubble-with-selector.user {
              flex-direction: row-reverse;
            }
            .bubble-with-selector .msg-bubble {
              flex: 0 1 auto;
            }
            .bubble-selector {
              width: 24px;
              height: 24px;
              flex-shrink: 0;
              display: flex;
              align-items: center;
              justify-content: center;
              cursor: pointer;
            }
            .bubble-selector-inner {
              width: 20px;
              height: 20px;
              border-radius: 50%;
              border: 2px solid #ccc;
              background: white;
              display: flex;
              align-items: center;
              justify-content: center;
              transition: all 0.15s;
              box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            }
            .bubble-selector.selected .bubble-selector-inner {
              background: linear-gradient(135deg, #f48fb1, #ec407a);
              border-color: #ec407a;
            }
            .bubble-selector:active .bubble-selector-inner {
              transform: scale(0.85);
            }

            /* 4. 撤回消息样式 */
            .msg-system-tip {
              font-size: 0.75rem;
              color: #999;
              text-align: center;
              margin: 8px 0;
              padding: 4px 12px;
              background: rgba(0, 0, 0, 0.03);
              border-radius: 4px;
              align-self: center;
              width: fit-content;
            }
            /* ==================== 小说模式渲染样式 ==================== */
            .msg-bubble i {
              font-style: italic;
              color: #78909c; /* 心理活动用稍微淡一点的颜色 */
              font-family: serif; /* 可选：用衬线体区分心理描写，更像小说 */
            }

            /* ==================== 微信风格语音条样式 ==================== */
            .voice-message {
              display: flex;
              flex-direction: column;
              gap: 4px;
              width: 100%;
            }

            .voice-bar {
              display: flex;
              align-items: center;
              gap: 8px;
              padding: 10px 14px;
              background: rgba(255, 255, 255, 0.95);
              border-radius: 16px;
              cursor: pointer;
              transition: all 0.2s;
              min-width: 80px;
              max-width: 180px;
              position: relative;
              overflow: hidden;
              box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            }

            .voice-bar:active {
              transform: scale(0.98);
              background: rgba(240, 240, 240, 0.95);
            }

            .voice-bar.playing {
              background: rgba(245, 245, 245, 0.98);
            }

            /* 语音波纹动画 */
            .voice-waves {
              display: flex;
              align-items: center;
              gap: 2px;
              height: 16px;
            }

            .voice-waves span {
              width: 3px;
              height: 6px;
              background: #333;
              border-radius: 2px;
              animation: none;
            }

            .voice-bar.playing .voice-waves span {
              animation: voiceWave 0.8s ease-in-out infinite;
            }

            .voice-waves span:nth-child(1) {
              height: 5px;
              animation-delay: 0s;
            }
            .voice-waves span:nth-child(2) {
              height: 10px;
              animation-delay: 0.1s;
            }
            .voice-waves span:nth-child(3) {
              height: 14px;
              animation-delay: 0.2s;
            }
            .voice-waves span:nth-child(4) {
              height: 10px;
              animation-delay: 0.3s;
            }
            .voice-waves span:nth-child(5) {
              height: 5px;
              animation-delay: 0.4s;
            }

            @keyframes voiceWave {
              0%,
              100% {
                transform: scaleY(0.5);
              }
              50% {
                transform: scaleY(1);
              }
            }

            .voice-duration {
              font-size: 0.8rem;
              color: #666;
              font-weight: 500;
              margin-left: auto;
            }

            /* 语音文字内容 - 默认隐藏，点击后显示 */
            .voice-text {
              display: none;
              font-size: 0.82rem;
              color: #555;
              line-height: 1.4;
              padding: 6px 10px;
              background: rgba(0, 0, 0, 0.03);
              border-radius: 8px;
              margin-top: 2px;
            }

            .voice-text.visible {
              display: block;
            }

            /* 转文字按钮 */
            .voice-to-text-btn {
              font-size: 0.72rem;
              color: #999;
              cursor: pointer;
              padding: 2px 0;
              transition: color 0.2s;
            }

            .voice-to-text-btn:active {
              color: #666;
            }

            /* AI发送的语音条 */
            .msg-row.ai .voice-bar {
              background: rgba(255, 255, 255, 0.95);
            }

            .msg-row.ai .voice-waves span {
              background: #333;
            }

            /* 语音加载中状态 */
            .voice-bar.loading {
              opacity: 0.7;
            }

            .voice-bar.loading::after {
              content: "";
              position: absolute;
              top: 0;
              left: -100%;
              width: 100%;
              height: 100%;
              background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
              );
              animation: voiceLoading 1.5s infinite;
            }

            @keyframes voiceLoading {
              0% {
                left: -100%;
              }
              100% {
                left: 100%;
              }
            }

            /* 语音消息气泡特殊样式 - 透明背景 */
            .msg-bubble.voice-message-bubble {
              background: transparent !important;
              box-shadow: none !important;
              padding: 2px 0 !important;
            }

            .msg-row.user .msg-bubble.voice-message-bubble,
            .msg-row.ai .msg-bubble.voice-message-bubble {
              background: transparent !important;
            }

            /* 嵌入式语音标签样式 */
            .inline-voice-tag {
              display: inline-block;
              background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
              padding: 4px 10px;
              border-radius: 12px;
              font-size: 0.85rem;
              color: #2e7d32;
              cursor: pointer;
              margin: 2px 0;
              transition: all 0.2s;
            }
            .inline-voice-tag:active {
              transform: scale(0.96);
              background: #c8e6c9;
            }

            /* ==================== 语音播放器样式 ==================== */
            .audio-player-bubble {
              display: inline-flex;
              align-items: center;
              gap: 8px;
              padding: 6px 12px;
              background: rgba(255, 255, 255, 0.9);
              border-radius: 12px;
              margin-top: 4px;
              box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
              cursor: pointer;
              transition: all 0.2s;
              border: 1px solid rgba(0, 0, 0, 0.05);
              max-width: fit-content;
            }

            .audio-player-bubble:active {
              transform: scale(0.98);
              background: #f0f0f0;
            }

            .audio-icon {
              font-size: 14px;
            }

            .audio-text {
              font-size: 0.8rem;
              color: #666;
              font-weight: 500;
            }

            .audio-player-bubble.playing .audio-icon {
              animation: pulse 1s infinite;
            }

            @keyframes pulse {
              0% {
                opacity: 1;
              }
              50% {
                opacity: 0.5;
              }
              100% {
                opacity: 1;
              }
            }

            /* 在设置页里的小提示 */
            .voice-hint-link {
              color: var(--accent-pink);
              text-decoration: underline;
              cursor: pointer;
            }
            /* ==================== 修复：长按菜单样式 ==================== */
            .context-menu-overlay {
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0, 0, 0, 0.2); /* 轻微暗色背景 */
              z-index: 9998;
              backdrop-filter: blur(2px);
              -webkit-backdrop-filter: blur(2px);
              opacity: 0;
              transition: opacity 0.2s;
            }
            .context-menu-overlay.active {
              display: block;
              opacity: 1;
            }

            .context-menu {
              display: none;
              position: fixed; /* 改为 fixed 居中显示 */
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%) scale(0.9);
              background: rgba(255, 255, 255, 0.95);
              backdrop-filter: blur(20px);
              -webkit-backdrop-filter: blur(20px);
              border-radius: 16px;
              box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
              width: 200px;
              overflow: hidden;
              z-index: 9999;
              opacity: 0;
              transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }

            .context-menu.show {
              display: block;
              opacity: 1;
              transform: translate(-50%, -50%) scale(1);
            }

            .context-menu .menu-item {
              padding: 14px 20px;
              font-size: 16px;
              color: #333;
              border-bottom: 1px solid rgba(0, 0, 0, 0.05);
              text-align: center;
              cursor: pointer;
            }

            .context-menu .menu-item:last-child {
              border-bottom: none;
            }

            .context-menu .menu-item:active {
              background: #f0f0f0;
            }

            /* ==================== 外观设置页面样式 ==================== */
            #appearancePage {
              padding-top: 0 !important;
            }

            #appearancePage .page-header {
              position: sticky;
              top: 0;
              z-index: 100;
              background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
              margin: 0 -16px 16px -16px;
              padding: 16px;
              padding-top: max(16px, env(safe-area-inset-top));
            }

            #appearancePage .page-title {
              color: #c2185b;
            }

            #appearancePage .page-content {
              display: flex !important;
              flex-direction: column !important;
              gap: 16px !important;
            }

            .appearance-section {
              display: block !important;
              width: 100% !important;
              background: rgba(255, 255, 255, 0.7) !important;
              backdrop-filter: blur(20px);
              -webkit-backdrop-filter: blur(20px);
              border-radius: 20px !important;
              padding: 20px !important;
              margin: 0 !important;
              border: 1px solid rgba(255, 255, 255, 0.5);
              box-sizing: border-box !important;
            }

            .appearance-section > h3 {
              display: block !important;
              width: 100% !important;
              font-size: 1rem !important;
              font-weight: 600 !important;
              color: var(--text-primary) !important;
              margin: 0 0 16px 0 !important;
              padding: 0 !important;
              background: none !important;
              border: none !important;
              text-align: left !important;
            }

            .wallpaper-preview {
              display: flex !important;
              width: 100% !important;
              height: 160px !important;
              border-radius: 16px !important;
              background: linear-gradient(135deg, var(--bg-pink), #e8f5e9) !important;
              align-items: center !important;
              justify-content: center !important;
              cursor: pointer;
              overflow: hidden;
              margin-bottom: 12px !important;
              border: 2px dashed rgba(244, 143, 177, 0.4) !important;
            }

            .wallpaper-preview img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }

            .wallpaper-placeholder {
              color: var(--text-secondary);
              font-size: 0.9rem;
            }

            .appearance-btn {
              display: block !important;
              width: 100% !important;
              padding: 12px !important;
              border-radius: 12px !important;
              border: none !important;
              font-size: 0.9rem !important;
              font-weight: 600 !important;
              cursor: pointer;
              text-align: center !important;
            }

            .appearance-btn.secondary {
              background: rgba(0, 0, 0, 0.05) !important;
              color: var(--text-secondary) !important;
            }

            .color-options {
              display: flex !important;
              flex-direction: row !important;
              flex-wrap: wrap !important;
              gap: 12px !important;
              width: 100% !important;
            }

            .color-option {
              width: 40px !important;
              height: 40px !important;
              border-radius: 50% !important;
              cursor: pointer;
              display: flex !important;
              align-items: center !important;
              justify-content: center !important;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
              flex-shrink: 0 !important;
            }

            .color-option.selected {
              box-shadow: 0 0 0 3px var(--accent-pink), 0 2px 8px rgba(0, 0, 0, 0.2) !important;
            }

            .color-option.custom-color {
              background: linear-gradient(135deg, #ff9a9e, #fad0c4, #a18cd1, #fbc2eb) !important;
              color: white !important;
              font-size: 18px !important;
              font-weight: bold !important;
            }

            .app-customize-list {
              display: flex !important;
              flex-direction: column !important;
              gap: 10px !important;
              width: 100% !important;
            }

            .app-customize-item {
              display: flex !important;
              flex-direction: row !important;
              align-items: center !important;
              gap: 12px !important;
              padding: 10px !important;
              background: rgba(255, 255, 255, 0.5) !important;
              border-radius: 12px !important;
              width: 100% !important;
              box-sizing: border-box !important;
            }

            .app-customize-icon {
              width: 44px !important;
              height: 44px !important;
              min-width: 44px !important;
              border-radius: 10px !important;
              background: linear-gradient(135deg, #fce4ec, #f8bbd9) !important;
              display: flex !important;
              align-items: center !important;
              justify-content: center !important;
              font-size: 12px !important;
              font-weight: 600 !important;
              color: var(--text-primary) !important;
              cursor: pointer;
              overflow: hidden;
            }

            .app-customize-icon img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }

            .app-customize-name {
              flex: 1 !important;
              min-width: 0 !important;
              padding: 10px 12px !important;
              border: 1px solid rgba(0, 0, 0, 0.1) !important;
              border-radius: 10px !important;
              font-size: 0.9rem !important;
              background: white !important;
              outline: none;
            }

            .app-customize-name:focus {
              border-color: var(--accent-pink) !important;
            }

            .appearance-save-btn {
              display: block !important;
              width: 100% !important;
              padding: 16px !important;
              border-radius: 16px !important;
              border: none !important;
              background: linear-gradient(135deg, #f48fb1, #f06292) !important;
              color: white !important;
              font-size: 1rem !important;
              font-weight: 700 !important;
              cursor: pointer;
              margin-bottom: 30px !important;
              box-shadow: 0 4px 15px rgba(244, 143, 177, 0.4);
              text-align: center !important;
            }

            .context-menu .menu-item.danger {
              color: #ff3b30;
              font-weight: 500;
            }

            /* 头像显示开关样式 */
            .avatar-toggle-group {
              display: flex;
              flex-direction: column;
              gap: 12px;
            }

            .toggle-item {
              display: flex;
              align-items: center;
              gap: 10px;
              cursor: pointer;
            }

            .toggle-item input[type="checkbox"] {
              width: 44px;
              height: 24px;
              appearance: none;
              -webkit-appearance: none;
              background: #e0e0e0;
              border-radius: 12px;
              position: relative;
              cursor: pointer;
              transition: background 0.3s ease;
            }

            .toggle-item input[type="checkbox"]:checked {
              background: var(--accent-pink);
            }

            .toggle-item input[type="checkbox"]::before {
              content: "";
              position: absolute;
              width: 20px;
              height: 20px;
              background: white;
              border-radius: 50%;
              top: 2px;
              left: 2px;
              transition: transform 0.3s ease;
              box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            }

            .toggle-item input[type="checkbox"]:checked::before {
              transform: translateX(20px);
            }

            .toggle-label {
              font-size: 0.9rem;
              color: var(--text-primary);
            }

            /* 分组管理样式 */
            .group-list {
              max-height: 200px;
              overflow-y: auto;
              margin-bottom: 12px;
            }

            .group-item {
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 10px 12px;
              background: #f5f5f5;
              border-radius: 10px;
              margin-bottom: 8px;
            }

            .group-item-name {
              font-size: 0.9rem;
              color: var(--text-primary);
            }

            .group-item-delete {
              width: 24px;
              height: 24px;
              border: none;
              background: rgba(255, 100, 100, 0.2);
              color: #ff6464;
              border-radius: 6px;
              cursor: pointer;
              font-size: 14px;
            }

            .group-add-row {
              display: flex;
              align-items: center;
              gap: 8px;
            }

            /* 气泡颜色选择器样式 */
            .bubble-color-row {
              display: flex;
              flex-direction: column;
              gap: 16px;
            }

            .bubble-color-item {
              display: flex;
              flex-direction: column;
              gap: 8px;
            }

            .bubble-color-label {
              font-size: 0.85rem;
              color: var(--text-secondary);
            }

            .color-picker-combo {
              display: flex;
              align-items: center;
              gap: 10px;
            }

            .color-preset-grid {
              display: grid;
              grid-template-columns: repeat(6, 1fr);
              gap: 6px;
            }

            .color-preset {
              width: 24px;
              height: 24px;
              border-radius: 6px;
              cursor: pointer;
              border: 2px solid transparent;
              transition: all 0.2s;
            }

            .color-preset:hover {
              transform: scale(1.15);
            }

            .color-preset.selected {
              border-color: #333;
              box-shadow: 0 0 0 2px white, 0 0 0 4px #333;
            }

            .color-picker-input {
              width: 32px;
              height: 32px;
              border: none;
              border-radius: 8px;
              cursor: pointer;
              padding: 0;
              background: none;
            }

            .color-picker-input::-webkit-color-swatch-wrapper {
              padding: 2px;
            }

            .color-picker-input::-webkit-color-swatch {
              border-radius: 6px;
              border: 2px solid rgba(0,0,0,0.1);
            }

            /* ==================== 引用预览样式 ==================== */
            .quote-preview {
              display: flex;
              align-items: center;
              padding: 8px 12px;
              background: rgba(255, 255, 255, 0.95);
              border-bottom: 1px solid rgba(244, 143, 177, 0.2);
              gap: 8px;
            }
            .quote-preview-content {
              flex: 1;
              min-width: 0;
              padding: 6px 10px;
              background: rgba(244, 143, 177, 0.1);
              border-left: 3px solid #f48fb1;
              border-radius: 0 8px 8px 0;
            }
            .quote-preview-sender {
              font-size: 0.75rem;
              color: #f48fb1;
              font-weight: 500;
              margin-bottom: 2px;
            }
            .quote-preview-text {
              font-size: 0.8rem;
              color: #666;
              overflow: hidden;
              text-overflow: ellipsis;
              white-space: nowrap;
              max-width: 100%;
            }
            .quote-preview-close {
              width: 24px;
              height: 24px;
              border-radius: 50%;
              border: none;
              background: rgba(0,0,0,0.1);
              color: #666;
              font-size: 12px;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              flex-shrink: 0;
            }
            .quote-preview-close:active {
              background: rgba(0,0,0,0.2);
            }

            /* 消息中的引用显示样式 */
            .msg-quote {
              padding: 6px 10px;
              background: rgba(0, 0, 0, 0.05);
              border-left: 3px solid rgba(244, 143, 177, 0.6);
              border-radius: 0 8px 8px 0;
              margin-bottom: 6px;
              font-size: 0.8rem;
            }
            .msg-quote-sender {
              font-size: 0.7rem;
              color: #f48fb1;
              font-weight: 500;
              margin-bottom: 2px;
            }
            .msg-quote-text {
              color: #888;
              overflow: hidden;
              text-overflow: ellipsis;
              display: -webkit-box;
              -webkit-line-clamp: 2;
              -webkit-box-orient: vertical;
            }

            /* ==================== 底部栏新布局 ==================== */
            .conv-input-area {
              padding: 0 !important;
              background: transparent !important;
              border: none !important;
              position: fixed !important;
              bottom: 0;
              left: 0;
              right: 0;
              z-index: 200;
              transition: transform 0.3s ease;
            }

            /* 输入栏这一行 */
            .conv-input-bar {
              display: flex;
              align-items: flex-end;
              padding: 8px 12px;
              padding-bottom: calc(8px + env(safe-area-inset-bottom));
              gap: 8px;
              background: transparent;
              border: none;
              flex-wrap: nowrap;
            }

            /* 左侧加号按钮 */
            .tool-btn {
              width: 34px;
              height: 34px;
              min-width: 34px;
              border-radius: 50%;
              border: 1.5px solid rgba(0, 0, 0, 0.12);
              background: transparent;
              display: flex;
              align-items: center;
              justify-content: center;
              color: #888;
              font-size: 22px;
              font-weight: 300;
              cursor: pointer;
              flex-shrink: 0;
              margin-bottom: 2px;
            }
            .tool-btn:active {
              background: rgba(244, 143, 177, 0.1);
            }

            /* 输入框包裹层 (改) */
            .conv-input-wrapper {
              flex: 1;
              min-width: 0;
              background: rgba(255, 255, 255, 0.85);
              border-radius: 20px;
              padding: 8px 12px;
              display: flex;
              align-items: flex-end;
              min-height: 36px;
              margin: 0 !important;
              border: none;
            }

            /* 输入框本体 */
            .conv-input {
              flex: 1;
              min-width: 0;
              max-height: 100px;
              background: transparent;
              padding: 0;
              margin-right: 4px;
              line-height: 1.4;
              font-size: 1rem;
              border: none;
              outline: none;
            }

            /* 输入框里的表情小按钮 */
            .emoji-btn-inner {
              width: 24px;
              height: 24px;
              background: none;
              border: none;
              cursor: pointer;
              opacity: 0.4;
              margin-bottom: 1px;
              flex-shrink: 0;
              display: flex;
              align-items: center;
              justify-content: center;
              color: #666;
            }
            .emoji-btn-inner:active {
              opacity: 0.7;
              transform: scale(1.1);
            }
            .emoji-btn-inner svg {
              width: 20px;
              height: 20px;
            }

            /* --- AI按钮和发送按钮的样式 --- */
            #replyBtn {
              width: 34px !important;
              height: 34px !important;
              min-width: 34px !important;
              border-radius: 50% !important;
              background: linear-gradient(135deg, #fce4ec, #f8bbd9) !important;
              border: none !important;
              margin-bottom: 4px !important;
              flex-shrink: 0 !important;
              display: flex !important;
              align-items: center !important;
              justify-content: center !important;
              font-size: 16px !important;
              color: #e91e63 !important;
              box-shadow: 0 2px 8px rgba(233, 30, 99, 0.15) !important;
              align-self: flex-end !important;
            }
            .conv-send-btn {
              width: 34px !important;
              height: 34px !important;
              min-width: 34px !important;
              border-radius: 50% !important;
              background: linear-gradient(135deg, #f8bbd9, #f48fb1) !important;
              border: none !important;
              margin-bottom: 4px !important;
              flex-shrink: 0 !important;
              box-shadow: 0 2px 8px rgba(233, 30, 99, 0.2) !important;
              align-self: flex-end !important;
            }

            /* 移动端小屏幕优化 */
            @media screen and (max-width: 380px) {
              .conv-input-bar {
                padding: 8px 10px;
                gap: 6px;
              }
              .tool-btn, .conv-send-btn, #replyBtn {
                width: 32px !important;
                height: 32px !important;
                min-width: 32px !important;
              }
            }

            /* ==================== 底部弹出面板 ==================== */
            .chat-panel {
              height: 0;
              overflow-y: auto;
              background: #f5f5f5;
              transition: height 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
              border-top: 1px solid #e5e5e5;
            }

            .chat-panel.open {
              height: 250px; /* 面板弹出的高度 */
              padding-bottom: env(safe-area-inset-bottom);
            }

            /* 加号菜单网格 */
            .panel-grid {
              display: grid;
              grid-template-columns: repeat(4, 1fr);
              gap: 20px;
              padding: 24px;
            }

            .panel-item {
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 8px;
              cursor: pointer;
            }
            .panel-item:active {
              opacity: 0.7;
            }

            .panel-icon-box {
              width: 54px;
              height: 54px;
              border-radius: 50%;
              background: #6b9ac4;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 24px;
              box-shadow: 0 2px 10px rgba(107, 154, 196, 0.25);
              transition: transform 0.2s ease, box-shadow 0.2s ease;
            }

            .panel-item:active .panel-icon-box {
              transform: scale(0.95);
            }

            /* 图标背景色 - 简约圆形风格 */
            .bg-photo {
              background: #78a5c8;
              color: #fff;
            }
            .bg-camera {
              background: #7eb8d8;
              color: #fff;
            }
            .bg-redpacket {
              background: #e88a8a;
              color: #fff;
            }
            .bg-call {
              background: #7ec4b8;
              color: #fff;
            }
            .bg-video {
              background: #9bc88e;
              color: #fff;
            }
            .bg-location {
              background: #6baed6;
              color: #fff;
            }
            .bg-nudge {
              background: #d4a5c9;
              color: #fff;
            }
            .bg-book {
              background: #8fc49b;
              color: #fff;
            }
            .bg-transfer {
              background: #e8a4b8;
              color: #fff;
            }
            .bg-reroll {
              background: #a8b4d4;
              color: #fff;
            }

            .panel-label {
              font-size: 0.75rem;
              color: #666;
            }

            /* ==================== 转账卡片样式 - 微信风格 ==================== */
            .transfer-card {
              background: linear-gradient(135deg, #fff0f5 0%, #ffe8f0 100%);
              border-radius: 12px;
              padding: 12px 14px;
              min-width: 200px;
              max-width: 220px;
              box-shadow: 0 2px 8px rgba(244, 143, 177, 0.15);
              border: 1px solid rgba(244, 143, 177, 0.2);
              cursor: pointer;
            }
            .transfer-card-header {
              display: flex;
              align-items: center;
              gap: 10px;
            }
            .transfer-card-icon {
              width: 40px;
              height: 40px;
              border-radius: 8px;
              background: linear-gradient(135deg, #f48fb1, #ec407a);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 20px;
              flex-shrink: 0;
            }
            .transfer-card-info {
              flex: 1;
              min-width: 0;
            }
            .transfer-card-title {
              font-size: 0.9rem;
              font-weight: 500;
              color: #333;
              margin-bottom: 2px;
            }
            .transfer-card-amount {
              font-size: 0.8rem;
              color: #c2185b;
              font-weight: 600;
            }
            .transfer-card-amount::before {
              content: '¥';
              font-size: 0.7rem;
              margin-right: 2px;
            }
            .transfer-card-footer {
              margin-top: 10px;
              padding-top: 8px;
              border-top: 1px solid rgba(244, 143, 177, 0.2);
              font-size: 0.72rem;
              color: #999;
              display: flex;
              align-items: center;
              justify-content: space-between;
            }
            .transfer-card-status {
              font-size: 0.72rem;
              color: #999;
            }
            .transfer-card-status.pending {
              color: #ff9800;
            }
            .transfer-card-status.accepted {
              color: #4caf50;
            }
            .transfer-card-status.rejected {
              color: #999;
            }
            .transfer-card-btn {
              padding: 4px 10px;
              border: none;
              border-radius: 4px;
              font-size: 0.72rem;
              cursor: pointer;
              transition: all 0.2s;
            }
            .transfer-card-btn.accept {
              background: linear-gradient(135deg, #f48fb1, #ec407a);
              color: white;
            }
            .transfer-card-btn.reject {
              background: #f5f5f5;
              color: #666;
              margin-right: 6px;
            }
            .transfer-card-btn:active {
              transform: scale(0.96);
            }

            /* ==================== 位置卡片样式 ==================== */
            .location-card {
              background: linear-gradient(135deg, #fff0f5 0%, #ffe8f0 100%);
              border-radius: 12px;
              overflow: hidden;
              min-width: 180px;
              max-width: 200px;
              box-shadow: 0 2px 8px rgba(244, 143, 177, 0.15);
              border: 1px solid rgba(244, 143, 177, 0.2);
              cursor: pointer;
            }
            .location-card-map {
              height: 70px;
              background: linear-gradient(135deg, #fce4ec, #f8bbd9);
              display: flex;
              align-items: center;
              justify-content: center;
              position: relative;
            }
            .location-card-map-icon {
              font-size: 28px;
              animation: locationBounce 1.5s ease-in-out infinite;
            }
            @keyframes locationBounce {
              0%, 100% { transform: translateY(0); }
              50% { transform: translateY(-5px); }
            }
            .location-card-map-bg {
              position: absolute;
              inset: 0;
              background-image:
                radial-gradient(circle at 20% 30%, rgba(255,255,255,0.3) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(255,255,255,0.3) 0%, transparent 40%);
            }
            .location-card-info {
              padding: 10px 12px;
              background: white;
            }
            .location-card-name {
              font-size: 0.85rem;
              font-weight: 500;
              color: #333;
              margin-bottom: 2px;
              display: flex;
              align-items: center;
              gap: 4px;
            }
            .location-card-name::before {
              content: '📍';
              font-size: 0.75rem;
            }
            .location-card-address {
              font-size: 0.7rem;
              color: #999;
              line-height: 1.3;
            }

            /* ==================== 钱包详情页样式 ==================== */
            .wallet-page {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: #f5f5f5;
              z-index: 9999;
              display: none;
              flex-direction: column;
            }
            .wallet-page.active {
              display: flex;
            }
            .wallet-page-header {
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 16px;
              padding-top: calc(16px + env(safe-area-inset-top, 20px));
              min-height: 60px;
              background: linear-gradient(135deg, #f48fb1, #ec407a);
              color: white;
              font-size: 1.1rem;
              font-weight: 600;
            }
            .wallet-page-back {
              background: none;
              border: none;
              color: white;
              font-size: 1.8rem;
              cursor: pointer;
              padding: 8px;
              width: 40px;
              height: 40px;
              display: flex;
              align-items: center;
              justify-content: center;
            }
            .wallet-page-content {
              flex: 1;
              overflow-y: auto;
              padding-bottom: 20px;
            }
            .wallet-balance-card {
              background: linear-gradient(135deg, #f48fb1, #ec407a);
              margin: 16px;
              border-radius: 16px;
              padding: 24px;
              text-align: center;
              color: white;
              box-shadow: 0 8px 24px rgba(236, 64, 122, 0.3);
            }
            .wallet-balance-label {
              font-size: 0.85rem;
              opacity: 0.9;
              margin-bottom: 8px;
            }
            .wallet-balance-value {
              font-size: 2.5rem;
              font-weight: 700;
            }
            .wallet-balance-value::before {
              content: '¥';
              font-size: 1.4rem;
              margin-right: 4px;
            }
            .wallet-balance-actions {
              margin-top: 20px;
            }
            .wallet-action-btn {
              background: rgba(255,255,255,0.2);
              border: 1px solid rgba(255,255,255,0.4);
              border-radius: 20px;
              padding: 10px 24px;
              color: white;
              font-size: 0.9rem;
              cursor: pointer;
              display: inline-flex;
              align-items: center;
              gap: 6px;
            }
            .wallet-action-btn:active {
              background: rgba(255,255,255,0.3);
            }
            .wallet-history-section {
              background: white;
              margin: 0 16px;
              border-radius: 16px;
              overflow: hidden;
              box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            }
            .wallet-history-title {
              padding: 14px 16px;
              font-weight: 600;
              color: #333;
              border-bottom: 1px solid #f0f0f0;
            }
            .wallet-history-list {
              max-height: 400px;
              overflow-y: auto;
            }
            .wallet-history-empty {
              padding: 40px;
              text-align: center;
              color: #999;
              font-size: 0.9rem;
            }
            .wallet-history-item {
              display: flex;
              align-items: center;
              padding: 14px 16px;
              border-bottom: 1px solid #f5f5f5;
            }
            .wallet-history-item:last-child {
              border-bottom: none;
            }
            .wallet-history-icon {
              width: 40px;
              height: 40px;
              border-radius: 10px;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 18px;
              margin-right: 12px;
            }
            .wallet-history-icon.income {
              background: #e8f5e9;
            }
            .wallet-history-icon.expense {
              background: #fce4ec;
            }
            .wallet-history-info {
              flex: 1;
            }
            .wallet-history-desc {
              font-size: 0.9rem;
              color: #333;
            }
            .wallet-history-time {
              font-size: 0.75rem;
              color: #999;
              margin-top: 2px;
            }
            .wallet-history-amount {
              font-size: 1rem;
              font-weight: 600;
            }
            .wallet-history-amount.income {
              color: #4caf50;
            }
            .wallet-history-amount.expense {
              color: #e91e63;
            }

            /* ==================== 通话界面样式 ==================== */
            .call-overlay {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              z-index: 10001;
              display: none;
              flex-direction: column;
            }
            .call-overlay.active {
              display: flex;
            }
            .call-overlay.voice-call {
              background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            }
            .call-overlay.video-call {
              background: #000;
            }
            .call-overlay.video-call.active {
              display: block;
            }

            /* 通话悬浮球 */
            .call-floating-bubble {
              position: fixed;
              top: 100px;
              right: 16px;
              width: 60px;
              height: 60px;
              border-radius: 50%;
              background: linear-gradient(135deg, #f48fb1, #ec407a);
              box-shadow: 0 4px 20px rgba(244, 143, 177, 0.5);
              z-index: 10002;
              display: none;
              align-items: center;
              justify-content: center;
              cursor: pointer;
              overflow: hidden;
              border: 3px solid rgba(255,255,255,0.3);
              animation: floatPulse 2s ease-in-out infinite;
              color: white;
            }
            .call-floating-bubble svg {
              stroke: white;
            }
            .call-floating-bubble.active {
              display: flex;
            }
            .call-floating-bubble img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            @keyframes floatPulse {
              0%, 100% { box-shadow: 0 4px 20px rgba(244, 143, 177, 0.5); }
              50% { box-shadow: 0 4px 30px rgba(244, 143, 177, 0.8); }
            }

            /* 通话顶部栏 - 左上角最小化按钮 + 中间头像名字时间 */
            .call-top-bar {
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              padding: 16px;
              padding-top: calc(16px + env(safe-area-inset-top, 20px));
              display: flex;
              align-items: flex-start;
              z-index: 15;
              background: linear-gradient(180deg, rgba(0,0,0,0.4) 0%, transparent 100%);
            }
            .call-minimize-btn {
              width: 36px;
              height: 36px;
              border-radius: 50%;
              border: none;
              background: rgba(255,255,255,0.2);
              backdrop-filter: blur(10px);
              color: white;
              font-size: 16px;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              flex-shrink: 0;
            }
            .call-minimize-btn svg {
              stroke: white;
            }
            .call-top-info {
              flex: 1;
              display: flex;
              flex-direction: column;
              align-items: center;
              margin-right: 36px; /* 平衡左边按钮的宽度 */
            }
            .call-top-avatar {
              width: 60px;
              height: 60px;
              border-radius: 50%;
              background: linear-gradient(135deg, #f48fb1, #ec407a);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 30px;
              margin-bottom: 8px;
              box-shadow: 0 4px 15px rgba(0,0,0,0.3);
              overflow: hidden;
              border: 2px solid rgba(255,255,255,0.3);
            }
            .call-top-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            .call-top-name {
              color: white;
              font-size: 1rem;
              font-weight: 600;
              text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            }
            .call-top-timer {
              color: rgba(255,255,255,0.8);
              font-size: 0.85rem;
              margin-top: 2px;
              text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            }

            /* 隐藏旧的头像区域 - 语音通话也使用顶部栏 */
            .call-avatar-section {
              display: none !important;
            }

            /* 视频通话 - 对方画面（全屏背景） */
            .video-main {
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: #1a1a2e;
              display: none;
              overflow: hidden;
              z-index: 1;
            }
            .call-overlay.video-call .video-main {
              display: block;
            }
            .video-main img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            .video-main-placeholder {
              width: 100%;
              height: 100%;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              color: rgba(255,255,255,0.5);
              font-size: 1rem;
              gap: 12px;
              background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            }
            /* 隐藏视频通话占位头像 */
            .video-main-placeholder .avatar-large {
              display: none;
            }
            .video-main-placeholder .avatar-large img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            /* 视频占位文字样式 */
            .video-main-placeholder span {
              display: none;
            }

            /* 视频通话 - 我的画面（小窗口） */
            .video-self {
              position: absolute;
              top: calc(130px + env(safe-area-inset-top, 20px));
              right: 16px;
              width: 100px;
              height: 140px;
              border-radius: 12px;
              background: #2a2a3e;
              overflow: hidden;
              border: 2px solid rgba(255,255,255,0.3);
              display: none;
              z-index: 9;
              cursor: pointer;
              transition: all 0.3s ease;
            }
            .video-self img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            .video-self-placeholder {
              width: 100%;
              height: 100%;
              display: flex;
              align-items: center;
              justify-content: center;
              color: rgba(255,255,255,0.6);
              font-size: 0.75rem;
              background: linear-gradient(135deg, #2d2d4a, #1f1f35);
            }
            .call-overlay.video-call.in-call .video-self {
              display: block;
            }

            /* 视频画面互换状态 */
            .call-overlay.video-call.swapped .video-main {
              position: absolute;
              top: calc(130px + env(safe-area-inset-top, 20px));
              right: 16px;
              left: auto;
              bottom: auto;
              width: 100px;
              height: 140px;
              border-radius: 12px;
              border: 2px solid rgba(255,255,255,0.3);
              z-index: 9;
            }
            .call-overlay.video-call.swapped .video-self {
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              width: 100%;
              height: 100%;
              border-radius: 0;
              border: none;
              z-index: 5;
            }

            /* 视频通话顶部信息栏 */
            .video-call-header {
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              padding: 16px;
              padding-top: calc(16px + env(safe-area-inset-top, 20px));
              background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 100%);
              display: none;
              z-index: 8;
            }
            .call-overlay.video-call .video-call-header {
              display: block;
            }
            .video-call-info {
              display: flex;
              align-items: center;
              gap: 12px;
            }
            .video-call-name {
              color: white;
              font-size: 1.1rem;
              font-weight: 600;
            }
            .video-call-timer {
              color: rgba(255,255,255,0.8);
              font-size: 0.9rem;
            }

            /* 通话中的对话区域 - 居中显示 */
            .call-conversation {
              position: absolute;
              left: 0;
              right: 0;
              top: 50%;
              transform: translateY(-50%);
              max-height: 40vh;
              overflow-y: auto;
              padding: 16px 20px;
              display: none;
              z-index: 6;
              -webkit-overflow-scrolling: touch;
              flex-direction: column;
              justify-content: flex-end;
            }
            .call-overlay.in-call .call-conversation {
              display: flex;
            }
            /* 视频通话时对话区 */
            .call-overlay.video-call .call-conversation {
              top: auto;
              bottom: 190px;
              transform: none;
              max-height: 35vh;
            }
            .call-overlay.video-call.in-call .call-conversation {
              display: flex;
            }

            /* 通话消息容器 */
            .call-messages-wrapper {
              display: flex;
              flex-direction: column;
              gap: 10px;
              width: 100%;
            }

            /* 通话消息气泡 - 使用CSS变量支持自定义 */
            .call-message {
              max-width: 75%;
              padding: 10px 14px;
              border-radius: 16px;
              font-size: 0.9rem;
              line-height: 1.5;
              animation: callMsgFadeIn 0.3s ease;
              word-wrap: break-word;
              word-break: break-word;
            }
            .call-message.user {
              align-self: flex-end;
              background: var(--call-user-bubble-bg, rgba(244, 143, 177, 0.85));
              color: var(--call-user-bubble-color, white);
              border-bottom-right-radius: 4px;
            }
            .call-message.ai {
              align-self: flex-start;
              background: var(--call-ai-bubble-bg, rgba(255, 255, 255, 0.85));
              color: var(--call-ai-bubble-color, #333);
              border-bottom-left-radius: 4px;
            }
            /* 视频通话时气泡更透明 */
            .call-overlay.video-call .call-message.user {
              background: var(--call-user-bubble-bg, rgba(244, 143, 177, 0.7));
              box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            }
            .call-overlay.video-call .call-message.ai {
              background: var(--call-ai-bubble-bg, rgba(255, 255, 255, 0.7));
              box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            }
            .call-message .action-text {
              color: rgba(0,0,0,0.5);
              font-style: italic;
            }
            .call-message.system {
              align-self: center;
              background: transparent;
              color: rgba(255,255,255,0.7);
              text-align: center;
              font-size: 0.8rem;
              max-width: 100%;
            }

            /* AI正在输入指示器 */
            .call-typing-indicator {
              align-self: flex-start;
              background: var(--call-ai-bubble-bg, rgba(255, 255, 255, 0.85));
              padding: 10px 16px;
              border-radius: 16px;
              border-bottom-left-radius: 4px;
              display: none;
              gap: 4px;
            }
            .call-overlay.video-call .call-typing-indicator {
              background: var(--call-ai-bubble-bg, rgba(255, 255, 255, 0.7));
            }
            .call-typing-indicator.active {
              display: flex;
            }
            .call-typing-indicator span {
              width: 6px;
              height: 6px;
              background: #999;
              border-radius: 50%;
              animation: typingBounce 1.4s infinite;
            }
            .call-typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
            .call-typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

            @keyframes callMsgFadeIn {
              from {
                opacity: 0;
                transform: translateY(10px);
              }
              to {
                opacity: 1;
                transform: translateY(0);
              }
            }
            @keyframes typingBounce {
              0%, 60%, 100% { transform: translateY(0); }
              30% { transform: translateY(-6px); }
            }

            /* 通话输入区域 - 移到按钮上方，增加间距 */
            .call-input-area {
              display: none;
              position: absolute;
              left: 0;
              right: 0;
              bottom: 130px;
              padding: 12px 20px;
              z-index: 7;
              background: transparent;
            }
            .call-overlay.in-call .call-input-area {
              display: block;
            }
            /* 视频通话时输入区 */
            .call-overlay.video-call .call-input-area {
              bottom: 130px;
            }
            .call-input-row {
              display: flex;
              gap: 10px;
              align-items: flex-end;
            }
            .call-input {
              flex: 1;
              background: rgba(255,255,255,0.15);
              border: 1px solid rgba(255,255,255,0.2);
              border-radius: 20px;
              padding: 10px 16px;
              color: white;
              font-size: 0.95rem;
              outline: none;
              resize: none;
              max-height: 80px;
              min-height: 40px;
            }
            .call-input::placeholder {
              color: rgba(255,255,255,0.5);
            }
            .call-send-btn {
              width: 40px;
              height: 40px;
              border-radius: 50%;
              border: none;
              background: linear-gradient(135deg, #f48fb1, #ec407a);
              color: white;
              font-size: 18px;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              flex-shrink: 0;
            }
            .call-send-btn svg {
              stroke: white;
            }

            /* 通话按钮区域 - 透明底栏，按钮分散，增加间距 */
            .call-buttons-area {
              position: absolute;
              bottom: 0;
              left: 0;
              right: 0;
              display: flex;
              justify-content: center;
              padding: 25px 30px;
              padding-bottom: calc(35px + env(safe-area-inset-bottom));
              z-index: 7;
              background: linear-gradient(0deg, rgba(0,0,0,0.4) 0%, transparent 100%);
            }
            .call-overlay.in-call .call-buttons-area {
              background: linear-gradient(0deg, rgba(0,0,0,0.5) 0%, transparent 100%);
            }
            .call-overlay.video-call .call-buttons-area {
              background: linear-gradient(0deg, rgba(0,0,0,0.5) 0%, transparent 100%);
            }
            .call-buttons {
              display: flex;
              gap: 30px;
              align-items: center;
              justify-content: center;
            }
            .call-btn {
              width: 56px;
              height: 56px;
              border-radius: 50%;
              border: none;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 22px;
              cursor: pointer;
              transition: transform 0.2s, box-shadow 0.2s;
              backdrop-filter: blur(10px);
              color: white;
            }
            .call-btn svg {
              stroke: white;
            }
            .call-btn:active {
              transform: scale(0.95);
            }
            .call-btn.end-call {
              background: linear-gradient(135deg, #ff5252, #d32f2f);
              box-shadow: 0 4px 15px rgba(255, 82, 82, 0.4);
              width: 64px;
              height: 64px;
              font-size: 26px;
            }
            .call-btn.accept-call {
              background: linear-gradient(135deg, #4caf50, #388e3c);
              box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
            }
            .call-btn.speaker-btn, .call-btn.reroll-btn {
              background: rgba(255,255,255,0.2);
              box-shadow: 0 4px 12px rgba(0,0,0,0.2);
              backdrop-filter: blur(10px);
            }
            .call-btn.speaker-btn.active {
              background: rgba(76, 175, 80, 0.6);
            }
            .call-btn.reroll-btn {
              font-size: 20px;
            }

            /* 来电界面 */
            .call-incoming-buttons {
              display: flex;
              gap: 50px;
            }

            @keyframes fadeInUp {
              from {
                opacity: 0;
                transform: translateY(10px);
              }
              to {
                opacity: 1;
                transform: translateY(0);
              }
            }

            /* 来电全屏界面 */
            .incoming-call-overlay {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: linear-gradient(180deg, #1a1a2e 0%, #0d0d1a 100%);
              z-index: 10002;
              display: none;
              flex-direction: column;
              align-items: center;
              justify-content: space-between;
              padding: 60px 30px;
              padding-top: calc(80px + env(safe-area-inset-top, 20px));
              padding-bottom: calc(60px + env(safe-area-inset-bottom, 20px));
            }
            .incoming-call-overlay.active {
              display: flex;
            }
            .incoming-call-overlay::before {
              content: '';
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: radial-gradient(circle at 50% 30%, rgba(244, 143, 177, 0.15) 0%, transparent 50%);
              pointer-events: none;
            }

            .incoming-call-top {
              text-align: center;
              position: relative;
              z-index: 1;
            }
            .incoming-call-label {
              color: rgba(255,255,255,0.6);
              font-size: 0.9rem;
              margin-bottom: 8px;
              letter-spacing: 1px;
            }
            .incoming-call-avatar-wrap {
              position: relative;
              margin: 20px auto 24px;
            }
            .incoming-call-avatar {
              width: 120px;
              height: 120px;
              border-radius: 50%;
              background: linear-gradient(135deg, #f48fb1, #ec407a);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 60px;
              overflow: hidden;
              box-shadow: 0 8px 40px rgba(244, 143, 177, 0.4);
              animation: avatarPulse 2s ease-in-out infinite;
            }
            .incoming-call-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            @keyframes avatarPulse {
              0%, 100% { box-shadow: 0 8px 40px rgba(244, 143, 177, 0.4); }
              50% { box-shadow: 0 8px 60px rgba(244, 143, 177, 0.6); }
            }
            .incoming-call-ring {
              position: absolute;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
              width: 140px;
              height: 140px;
              border: 2px solid rgba(244, 143, 177, 0.3);
              border-radius: 50%;
              animation: ringPulse 1.5s ease-out infinite;
            }
            .incoming-call-ring:nth-child(2) {
              animation-delay: 0.5s;
            }
            .incoming-call-ring:nth-child(3) {
              animation-delay: 1s;
            }
            @keyframes ringPulse {
              0% {
                width: 120px;
                height: 120px;
                opacity: 1;
              }
              100% {
                width: 200px;
                height: 200px;
                opacity: 0;
              }
            }
            .incoming-call-name {
              color: white;
              font-size: 1.6rem;
              font-weight: 600;
              margin-bottom: 6px;
            }
            .incoming-call-type {
              color: rgba(255,255,255,0.7);
              font-size: 1rem;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 6px;
            }
            .incoming-call-type-icon {
              font-size: 1.1rem;
              color: white;
            }
            .incoming-call-type-icon svg {
              stroke: white;
            }

            .incoming-call-actions {
              display: flex;
              gap: 60px;
              position: relative;
              z-index: 1;
            }
            .incoming-call-btn-wrap {
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 10px;
            }
            .incoming-call-btn {
              width: 70px;
              height: 70px;
              border-radius: 50%;
              border: none;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 28px;
              cursor: pointer;
              transition: transform 0.2s, box-shadow 0.2s;
              color: white;
            }
            .incoming-call-btn svg {
              stroke: white;
            }
            .incoming-call-btn:active {
              transform: scale(0.95);
            }
            .incoming-call-btn.decline {
              background: linear-gradient(135deg, #ff5252, #d32f2f);
              box-shadow: 0 6px 25px rgba(255, 82, 82, 0.5);
            }
            .incoming-call-btn.accept {
              background: linear-gradient(135deg, #4caf50, #388e3c);
              box-shadow: 0 6px 25px rgba(76, 175, 80, 0.5);
            }
            .incoming-call-btn-label {
              color: rgba(255,255,255,0.7);
              font-size: 0.85rem;
            }

            /* 来电小提示条（备用） */
            .incoming-call-toast {
              position: fixed;
              top: 50px;
              left: 50%;
              transform: translateX(-50%);
              background: linear-gradient(135deg, #1a1a2e, #16213e);
              border-radius: 16px;
              padding: 16px 20px;
              display: none;
              align-items: center;
              gap: 16px;
              z-index: 10000;
              box-shadow: 0 8px 32px rgba(0,0,0,0.3);
              animation: slideDown 0.3s ease;
              max-width: 90%;
            }
            .incoming-call-toast.active {
              display: flex;
            }

            @keyframes slideDown {
              from {
                opacity: 0;
                transform: translate(-50%, -20px);
              }
              to {
                opacity: 1;
                transform: translate(-50%, 0);
              }
            }

            /* ==================== 钱包卡片样式（保留用于转账卡片等） ==================== */
            .wallet-card {
              background: linear-gradient(135deg, #fff0f5 0%, #ffe4ec 100%);
              border-radius: 20px;
              padding: 20px;
              margin: 16px;
              box-shadow: 0 8px 25px rgba(244, 143, 177, 0.25);
              border: 1px solid rgba(244, 143, 177, 0.3);
              position: relative;
              overflow: hidden;
            }
            .wallet-card::before {
              content: '';
              position: absolute;
              top: -50%;
              right: -30%;
              width: 150px;
              height: 150px;
              background: radial-gradient(circle, rgba(244,143,177,0.2) 0%, transparent 70%);
              border-radius: 50%;
            }
            .wallet-card-header {
              display: flex;
              align-items: center;
              gap: 12px;
              margin-bottom: 16px;
              position: relative;
              z-index: 1;
            }
            .wallet-card-icon {
              width: 48px;
              height: 48px;
              border-radius: 14px;
              background: linear-gradient(135deg, #f48fb1, #f06292);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 24px;
              box-shadow: 0 4px 12px rgba(244, 143, 177, 0.4);
            }
            .wallet-card-title {
              font-size: 1rem;
              font-weight: 600;
              color: #c2185b;
            }
            .wallet-card-subtitle {
              font-size: 0.75rem;
              color: #e57373;
              margin-top: 2px;
            }
            .wallet-card-balance {
              text-align: center;
              padding: 20px 0;
              position: relative;
              z-index: 1;
            }
            .wallet-card-balance-label {
              font-size: 0.8rem;
              color: #999;
              margin-bottom: 8px;
            }
            .wallet-card-balance-amount {
              font-size: 2.2rem;
              font-weight: 700;
              color: #c2185b;
            }
            .wallet-card-balance-amount::before {
              content: '¥';
              font-size: 1.2rem;
              margin-right: 4px;
            }
            .wallet-card-actions {
              display: flex;
              gap: 12px;
              margin-top: 16px;
              position: relative;
              z-index: 1;
            }
            .wallet-card-btn {
              flex: 1;
              padding: 12px;
              border: none;
              border-radius: 12px;
              font-size: 0.9rem;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 6px;
            }
            .wallet-card-btn.primary {
              background: linear-gradient(135deg, #f48fb1, #f06292);
              color: white;
              box-shadow: 0 4px 12px rgba(244, 143, 177, 0.4);
            }
            .wallet-card-btn.secondary {
              background: white;
              color: #c2185b;
              border: 2px solid rgba(244, 143, 177, 0.4);
            }
            .wallet-card-btn:active {
              transform: scale(0.98);
            }

            /* 钱包明细列表 */
            .wallet-history {
              margin: 0 16px 16px;
              background: white;
              border-radius: 16px;
              overflow: hidden;
              box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            }
            .wallet-history-header {
              padding: 14px 16px;
              font-size: 0.9rem;
              font-weight: 600;
              color: #c2185b;
              border-bottom: 1px solid #f5f5f5;
              display: flex;
              align-items: center;
              gap: 8px;
            }
            .wallet-history-item {
              display: flex;
              align-items: center;
              padding: 14px 16px;
              border-bottom: 1px solid #f8f8f8;
            }
            .wallet-history-item:last-child {
              border-bottom: none;
            }
            .wallet-history-icon {
              width: 40px;
              height: 40px;
              border-radius: 12px;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 18px;
              margin-right: 12px;
            }
            .wallet-history-icon.income {
              background: #e8f5e9;
            }
            .wallet-history-icon.expense {
              background: #ffebee;
            }
            .wallet-history-info {
              flex: 1;
            }
            .wallet-history-title {
              font-size: 0.9rem;
              color: #333;
              font-weight: 500;
            }
            .wallet-history-time {
              font-size: 0.75rem;
              color: #999;
              margin-top: 2px;
            }
            .wallet-history-amount {
              font-size: 1rem;
              font-weight: 600;
            }
            .wallet-history-amount.income {
              color: #4caf50;
            }
            .wallet-history-amount.expense {
              color: #f44336;
            }
            .wallet-history-empty {
              padding: 30px;
              text-align: center;
              color: #ccc;
              font-size: 0.85rem;
            }

            /* 充值弹窗 */
            .recharge-modal {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.5);
              z-index: 10000;
              display: none;
              align-items: center;
              justify-content: center;
              padding: 20px;
            }
            .recharge-modal.active {
              display: flex;
            }
            .recharge-modal-content {
              background: linear-gradient(180deg, #fff 0%, #fff5f8 100%);
              border-radius: 24px;
              width: 100%;
              max-width: 320px;
              padding: 24px;
              animation: scaleIn 0.2s ease;
            }
            .recharge-modal-title {
              font-size: 1.1rem;
              font-weight: 700;
              color: #c2185b;
              text-align: center;
              margin-bottom: 20px;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
            }
            .recharge-amount-grid {
              display: grid;
              grid-template-columns: repeat(3, 1fr);
              gap: 10px;
              margin-bottom: 16px;
            }
            .recharge-amount-btn {
              padding: 14px 8px;
              border: 2px solid rgba(244, 143, 177, 0.3);
              border-radius: 12px;
              background: white;
              font-size: 0.95rem;
              font-weight: 600;
              color: #c2185b;
              cursor: pointer;
              transition: all 0.2s;
            }
            .recharge-amount-btn.selected {
              border-color: #f48fb1;
              background: linear-gradient(135deg, #fff0f5, #ffe4ec);
              box-shadow: 0 4px 12px rgba(244, 143, 177, 0.2);
            }
            .recharge-amount-btn:active {
              transform: scale(0.98);
            }
            .recharge-custom-input {
              width: 100%;
              padding: 14px 16px;
              border: 2px solid rgba(244, 143, 177, 0.3);
              border-radius: 12px;
              font-size: 1rem;
              text-align: center;
              outline: none;
              margin-bottom: 20px;
              color: #c2185b;
              font-weight: 600;
            }
            .recharge-custom-input:focus {
              border-color: #f48fb1;
            }
            .recharge-custom-input::placeholder {
              color: #ddd;
              font-weight: 400;
            }
            .recharge-modal-btns {
              display: flex;
              gap: 12px;
            }
            .recharge-modal-btn {
              flex: 1;
              padding: 14px;
              border: none;
              border-radius: 12px;
              font-size: 0.95rem;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
            }
            .recharge-modal-btn.cancel {
              background: #f5f5f5;
              color: #999;
            }
            .recharge-modal-btn.confirm {
              background: linear-gradient(135deg, #f48fb1, #f06292);
              color: white;
              box-shadow: 0 4px 12px rgba(244, 143, 177, 0.4);
            }
            .recharge-modal-btn:active {
              transform: scale(0.98);
            }

            /* 转账弹窗 */
            .send-transfer-modal {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.5);
              z-index: 10000;
              display: none;
              align-items: center;
              justify-content: center;
              padding: 20px;
            }
            .send-transfer-modal.active {
              display: flex;
            }
            .send-transfer-modal-content {
              background: linear-gradient(180deg, #fff 0%, #fff5f8 100%);
              border-radius: 24px;
              width: 100%;
              max-width: 320px;
              padding: 24px;
              animation: scaleIn 0.2s ease;
            }
            .send-transfer-title {
              font-size: 1.1rem;
              font-weight: 700;
              color: #c2185b;
              text-align: center;
              margin-bottom: 8px;
            }
            .send-transfer-to {
              font-size: 0.85rem;
              color: #999;
              text-align: center;
              margin-bottom: 20px;
            }
            /* 转账成员选择列表 */
            .transfer-member-item {
              display: flex;
              align-items: center;
              padding: 10px 12px;
              border-radius: 12px;
              margin-bottom: 8px;
              background: #f8f8f8;
              cursor: pointer;
              transition: all 0.2s;
            }
            .transfer-member-item:hover {
              background: #fff0f5;
            }
            .transfer-member-item.selected {
              background: linear-gradient(135deg, #fce4ec, #fff0f5);
              border: 2px solid #f48fb1;
            }
            .transfer-member-avatar {
              width: 36px;
              height: 36px;
              border-radius: 50%;
              background: linear-gradient(135deg, #f48fb1, #ec407a);
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-size: 14px;
              margin-right: 12px;
              overflow: hidden;
            }
            .transfer-member-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            .transfer-member-name {
              flex: 1;
              font-size: 0.9rem;
              color: #333;
            }
            .transfer-member-check {
              width: 24px;
              height: 24px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: #f48fb1;
              font-weight: bold;
            }

            /* 群聊通话消息样式 */
            .call-message.group-call-msg {
              margin-bottom: 12px;
            }
            .group-call-msg-header {
              display: flex;
              align-items: center;
              margin-bottom: 4px;
            }
            .group-call-msg-avatar {
              width: 24px;
              height: 24px;
              border-radius: 50%;
              background: linear-gradient(135deg, #f48fb1, #ec407a);
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-size: 10px;
              margin-right: 8px;
              overflow: hidden;
            }
            .group-call-msg-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            .group-call-msg-name {
              font-size: 0.75rem;
              color: #f48fb1;
              font-weight: 500;
            }

            .send-transfer-input {
              width: 100%;
              padding: 16px;
              border: 2px solid rgba(244, 143, 177, 0.3);
              border-radius: 14px;
              font-size: 1.5rem;
              text-align: center;
              font-weight: 700;
              color: #c2185b;
              outline: none;
              margin-bottom: 12px;
            }
            .send-transfer-input:focus {
              border-color: #f48fb1;
            }
            .send-transfer-balance {
              font-size: 0.8rem;
              color: #999;
              text-align: center;
              margin-bottom: 16px;
            }
            .send-transfer-note-input {
              width: 100%;
              padding: 12px 16px;
              border: 2px solid rgba(244, 143, 177, 0.2);
              border-radius: 12px;
              font-size: 0.9rem;
              outline: none;
              margin-bottom: 20px;
            }
            .send-transfer-note-input::placeholder {
              color: #ccc;
            }

            /* ==================== 一起读书页面 ==================== */
            .read-together-page {
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: linear-gradient(180deg, #fef9e7 0%, #fdf2e9 100%);
              z-index: 400;
              flex-direction: column;
            }
            .read-together-page.active {
              display: flex;
            }
            .read-header {
              display: flex;
              align-items: center;
              padding: 12px 16px;
              padding-top: max(12px, env(safe-area-inset-top));
              background: rgba(255, 255, 255, 0.9);
              backdrop-filter: blur(10px);
              border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            }
            .read-header-back {
              width: 36px;
              height: 36px;
              border: none;
              background: none;
              font-size: 24px;
              color: #4caf50;
              cursor: pointer;
            }
            .read-header-title {
              flex: 1;
              text-align: center;
              font-size: 1.1rem;
              font-weight: 600;
              color: #333;
            }
            .read-header-action {
              width: 36px;
              height: 36px;
              border: none;
              background: none;
              font-size: 20px;
              cursor: pointer;
            }
            .read-content {
              flex: 1;
              overflow-y: auto;
              padding: 20px 16px;
            }
            .read-book-info {
              background: white;
              border-radius: 16px;
              padding: 20px;
              margin-bottom: 16px;
              box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            }
            .read-book-title {
              font-size: 1.2rem;
              font-weight: 600;
              color: #333;
              margin-bottom: 8px;
              display: flex;
              align-items: center;
              gap: 8px;
            }
            .read-book-progress {
              font-size: 0.85rem;
              color: #888;
              margin-bottom: 12px;
            }
            .read-progress-bar {
              height: 6px;
              background: #e0e0e0;
              border-radius: 3px;
              overflow: hidden;
            }
            .read-progress-fill {
              height: 100%;
              background: linear-gradient(90deg, #81c784, #4caf50);
              border-radius: 3px;
              transition: width 0.3s;
            }
            .read-no-book {
              text-align: center;
              padding: 40px 20px;
            }
            .read-no-book-icon {
              font-size: 64px;
              margin-bottom: 16px;
            }
            .read-no-book-text {
              font-size: 1rem;
              color: #666;
              margin-bottom: 20px;
            }
            .read-import-btn {
              display: inline-flex;
              align-items: center;
              gap: 8px;
              padding: 12px 24px;
              background: linear-gradient(135deg, #81c784, #4caf50);
              color: white;
              border: none;
              border-radius: 24px;
              font-size: 1rem;
              cursor: pointer;
              box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            }
            .read-import-btn:active {
              transform: scale(0.96);
            }
            .read-current-section {
              background: white;
              border-radius: 16px;
              padding: 20px;
              margin-bottom: 16px;
              box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            }
            .read-section-label {
              font-size: 0.8rem;
              color: #4caf50;
              margin-bottom: 8px;
              font-weight: 500;
            }
            .read-section-text {
              font-size: 1rem;
              color: #333;
              line-height: 1.8;
              white-space: pre-wrap;
              max-height: 200px;
              overflow-y: auto;
            }
            .read-controls {
              display: flex;
              gap: 12px;
              margin-top: 16px;
            }
            .read-ctrl-btn {
              flex: 1;
              padding: 12px;
              border: none;
              border-radius: 12px;
              font-size: 0.9rem;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 6px;
            }
            .read-ctrl-btn.prev {
              background: #f5f5f5;
              color: #666;
            }
            .read-ctrl-btn.next {
              background: linear-gradient(135deg, #81c784, #4caf50);
              color: white;
            }
            .read-ctrl-btn:disabled {
              opacity: 0.5;
              cursor: not-allowed;
            }
            .read-settings {
              background: white;
              border-radius: 16px;
              padding: 16px 20px;
              box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            }
            .read-setting-row {
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 12px 0;
              border-bottom: 1px solid #f0f0f0;
            }
            .read-setting-row:last-child {
              border-bottom: none;
            }
            .read-setting-label {
              font-size: 0.95rem;
              color: #333;
            }
            .read-setting-value {
              display: flex;
              align-items: center;
              gap: 8px;
            }
            .read-setting-input {
              width: 80px;
              padding: 6px 10px;
              border: 1px solid #ddd;
              border-radius: 8px;
              font-size: 0.9rem;
              text-align: center;
            }
            .read-status-badge {
              display: inline-flex;
              align-items: center;
              gap: 4px;
              padding: 4px 10px;
              background: #e8f5e9;
              color: #4caf50;
              border-radius: 12px;
              font-size: 0.8rem;
            }
            .read-status-badge.inactive {
              background: #f5f5f5;
              color: #999;
            }

            /* ==================== 悬浮窗模式 ==================== */
            .read-floating-btn {
              position: fixed;
              bottom: 160px;
              right: 16px;
              width: 56px;
              height: 56px;
              border-radius: 50%;
              background: linear-gradient(135deg, #81c784, #4caf50);
              color: white;
              border: none;
              font-size: 24px;
              box-shadow: 0 4px 16px rgba(76, 175, 80, 0.4);
              z-index: 350;
              cursor: pointer;
              display: none;
              align-items: center;
              justify-content: center;
              animation: floatBounce 2s ease-in-out infinite;
            }
            .read-floating-btn.active {
              display: flex;
            }
            @keyframes floatBounce {
              0%,
              100% {
                transform: translateY(0);
              }
              50% {
                transform: translateY(-5px);
              }
            }
            .read-floating-panel {
              position: fixed;
              bottom: 230px;
              right: 16px;
              width: 320px;
              min-width: 200px;
              max-width: 90vw;
              height: 300px;
              min-height: 150px;
              max-height: 70vh;
              background: white;
              border-radius: 16px;
              box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
              z-index: 351;
              display: none;
              flex-direction: column;
              overflow: visible;
            }
            .read-floating-panel.active {
              display: flex;
            }
            .read-float-header {
              display: flex;
              align-items: center;
              padding: 10px 14px;
              background: linear-gradient(135deg, #81c784, #4caf50);
              color: white;
              gap: 8px;
              cursor: move;
              user-select: none;
              flex-shrink: 0;
              border-radius: 16px 16px 0 0;
            }
            .read-float-drag-hint {
              font-size: 12px;
              opacity: 0.8;
            }
            .read-float-title {
              flex: 1;
              font-size: 0.9rem;
              font-weight: 500;
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
            }
            .read-float-progress {
              font-size: 0.75rem;
              opacity: 0.9;
              background: rgba(255, 255, 255, 0.2);
              padding: 2px 8px;
              border-radius: 10px;
            }
            .read-float-close {
              background: none;
              border: none;
              color: white;
              font-size: 18px;
              cursor: pointer;
              padding: 4px;
              opacity: 0.9;
            }
            .read-float-close:hover {
              opacity: 1;
            }
            .read-float-content {
              flex: 1;
              padding: 14px 16px;
              font-size: 1rem;
              line-height: 1.8;
              color: #333;
              overflow-y: auto;
              white-space: pre-wrap;
              background: #fffef5;
            }
            .read-float-controls {
              display: flex;
              border-top: 1px solid #eee;
              flex-shrink: 0;
              background: white;
              border-radius: 0 0 16px 16px;
            }
            .read-float-btn {
              flex: 1;
              padding: 12px;
              border: none;
              background: none;
              font-size: 0.85rem;
              cursor: pointer;
              color: #666;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 4px;
            }
            .read-float-btn:active {
              background: #f5f5f5;
            }
            .read-float-btn.primary {
              color: #4caf50;
              font-weight: 500;
            }
            .read-float-btn + .read-float-btn {
              border-left: 1px solid #eee;
            }
            .read-float-resize-handle {
              position: absolute;
              bottom: 0;
              right: 0;
              width: 0;
              height: 0;
              border-style: solid;
              border-width: 0 0 24px 24px;
              border-color: transparent transparent #4caf50 transparent;
              cursor: nwse-resize;
              touch-action: none;
              z-index: 10;
              border-radius: 0 0 16px 0;
            }
            .read-float-resize-handle:active {
              border-color: transparent transparent #388e3c transparent;
            }
            .read-float-resize-handle::after {
              content: '';
              position: absolute;
              bottom: -20px;
              right: 0;
              width: 8px;
              height: 8px;
              border-right: 2px solid rgba(255,255,255,0.8);
              border-bottom: 2px solid rgba(255,255,255,0.8);
            }

            /* ==================== 书架样式 ==================== */
            .bookshelf-section {
              margin-bottom: 20px;
            }
            .bookshelf-title {
              font-size: 1rem;
              font-weight: 600;
              color: #333;
              margin-bottom: 12px;
              display: flex;
              align-items: center;
              gap: 8px;
            }
            .bookshelf-grid {
              display: grid;
              grid-template-columns: repeat(2, 1fr);
              gap: 12px;
            }
            .book-card {
              background: white;
              border-radius: 12px;
              padding: 14px;
              box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
              cursor: pointer;
              transition: transform 0.2s, box-shadow 0.2s;
            }
            .book-card:active {
              transform: scale(0.98);
            }
            .book-card.reading {
              border: 2px solid #4caf50;
            }
            .book-card-icon {
              font-size: 32px;
              margin-bottom: 8px;
            }
            .book-card-name {
              font-size: 0.9rem;
              font-weight: 500;
              color: #333;
              margin-bottom: 4px;
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
            }
            .book-card-info {
              font-size: 0.75rem;
              color: #888;
            }
            .book-card-progress {
              margin-top: 8px;
              height: 4px;
              background: #e0e0e0;
              border-radius: 2px;
              overflow: hidden;
            }
            .book-card-progress-fill {
              height: 100%;
              background: linear-gradient(90deg, #81c784, #4caf50);
              border-radius: 2px;
            }
            .book-card-actions {
              display: flex;
              gap: 8px;
              margin-top: 10px;
            }
            .book-card-btn {
              flex: 1;
              padding: 6px 8px;
              border: none;
              border-radius: 6px;
              font-size: 0.75rem;
              cursor: pointer;
            }
            .book-card-btn.read {
              background: linear-gradient(135deg, #81c784, #4caf50);
              color: white;
            }
            .book-card-btn.delete {
              background: #ffebee;
              color: #f44336;
            }
            .add-book-card {
              background: #f5f5f5;
              border: 2px dashed #ddd;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              min-height: 120px;
              color: #999;
            }
            .add-book-card:active {
              background: #eee;
            }

            .sticker-item:active {
              transform: scale(0.95);
            }

            .sticker-item img {
              width: 100%;
              height: 100%;
              object-fit: contain; /* 保持图片比例 */
              padding: 4px;
            }

            /* 删除按钮（长按显示） */
            .sticker-delete-btn {
              position: absolute;
              top: 0;
              right: 0;
              background: rgba(0, 0, 0, 0.5);
              color: white;
              width: 20px;
              height: 20px;
              font-size: 12px;
              display: flex;
              align-items: center;
              justify-content: center;
              border-bottom-left-radius: 8px;
            }
            .emoji-item:active {
              background: #e0e0e0;
            }

            /* 聊天图片样式 */
            .msg-img-bubble {
              padding: 0 !important;
              overflow: hidden;
              background: transparent !important;
              box-shadow: none !important;
            }
            .msg-img {
              max-width: 200px;
              max-height: 200px;
              border-radius: 12px;
              display: block;
              cursor: pointer;
            }
            /* ==================== 表情包 Pro 样式 ==================== */

            /* 1. 分类栏 */
            .sticker-category-bar {
              display: flex;
              overflow-x: auto;
              padding: 10px 16px;
              gap: 8px;
              background: #f9f9f9;
              border-bottom: 1px solid #eee;
              scrollbar-width: none; /* 隐藏滚动条 */
            }
            .sticker-category-bar::-webkit-scrollbar {
              display: none;
            }

            .category-tab {
              padding: 6px 12px;
              background: white;
              border: 1px solid #e0e0e0;
              border-radius: 16px;
              font-size: 0.8rem;
              color: #666;
              white-space: nowrap;
              cursor: pointer;
              transition: all 0.2s;
              user-select: none; /* 禁止文字选中 */
              -webkit-user-select: none; /* 兼容 Safari */
            }

            .category-tab.active {
              background: var(--accent-pink); /* 使用你的主题色 */
              color: white;
              border-color: var(--accent-pink);
              font-weight: 600;
            }

            .category-add-btn {
              padding: 6px 10px;
              background: #eee;
              border-radius: 16px;
              color: #333;
              font-weight: bold;
              cursor: pointer;
              border: none;
              flex-shrink: 0;
            }

            /* 编辑按钮 */
            .category-edit-btn {
              padding: 6px 12px;
              background: transparent;
              border-radius: 16px;
              color: var(--accent-pink);
              font-size: 0.8rem;
              cursor: pointer;
              border: 1px solid var(--accent-pink);
              flex-shrink: 0;
              margin-left: auto;
            }
            .category-edit-btn:active {
              background: var(--accent-pink);
              color: white;
            }

            /* 编辑模式下的分类标签 */
            .category-tab.editing {
              display: inline-flex;
              align-items: center;
              gap: 4px;
              padding-right: 6px;
            }
            .cat-delete-btn {
              width: 16px;
              height: 16px;
              background: #ff6b6b;
              color: white;
              border-radius: 50%;
              font-size: 10px;
              display: flex;
              align-items: center;
              justify-content: center;
              cursor: pointer;
            }
            .cat-delete-btn:active {
              transform: scale(0.9);
            }

            /* 表情包选中标记 */
            .sticker-select-mark {
              position: absolute;
              top: 4px;
              right: 4px;
              width: 20px;
              height: 20px;
              background: var(--accent-pink);
              color: white;
              border-radius: 50%;
              font-size: 12px;
              display: flex;
              align-items: center;
              justify-content: center;
              opacity: 0;
              transition: opacity 0.15s;
            }
            .sticker-item.editing .sticker-select-mark {
              opacity: 0.5;
              background: #ccc;
            }
            .sticker-item.editing.selected .sticker-select-mark {
              opacity: 1;
              background: var(--accent-pink);
            }
            .sticker-item.editing.selected .sticker-img-box {
              border: 2px solid var(--accent-pink);
            }

            /* 编辑模式操作按钮 */
            .edit-action-btn {
              padding: 6px 12px;
              border-radius: 16px;
              font-size: 0.8rem;
              cursor: pointer;
              border: none;
              flex-shrink: 0;
            }
            .edit-action-btn.select-all {
              background: #f0f0f0;
              color: #333;
            }
            .edit-action-btn.select-all:active {
              background: #e0e0e0;
            }
            .edit-action-btn.delete-btn {
              background: #ffebee;
              color: #f44336;
            }
            .edit-action-btn.delete-btn:active {
              background: #ffcdd2;
            }
            .edit-action-btn.delete-btn:disabled {
              background: #f5f5f5;
              color: #bbb;
              cursor: not-allowed;
            }
            .edit-spacer {
              flex: 1;
            }

            /* 编辑模式下图片容器需要相对定位 */
            .sticker-item.editing .sticker-img-box {
              position: relative;
              cursor: pointer;
            }
            .sticker-item.editing:active {
              transform: scale(0.95);
            }

            /* ==================== 修复版：表情包面板样式 ==================== */

            /* 1. 让面板变成弹性盒子，头部固定，底部滚动 */
            #emojiPanel {
              display: flex !important;
              flex-direction: column !important;
              height: 0 !important;
              padding: 0 !important;
              background: #fff !important;
              overflow: hidden !important;
              transition: height 0.25s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            }
            /* 激活状态：高度展开 */
            #emojiPanel.open {
              height: 320px !important; /* 增加高度容纳搜索框 */
            }

            /* 搜索框样式 */
            .sticker-search-bar {
              flex-shrink: 0;
              padding: 10px 12px;
              background: #fff;
              border-bottom: 1px solid #eee;
              display: flex;
              align-items: center;
              gap: 8px;
            }
            .sticker-search-input {
              flex: 1;
              height: 32px;
              padding: 0 12px;
              border: 1px solid #e0e0e0;
              border-radius: 16px;
              font-size: 0.85rem;
              background: #f5f5f5;
              outline: none;
            }
            .sticker-search-input:focus {
              border-color: var(--accent-pink);
              background: #fff;
            }
            .sticker-search-clear {
              width: 20px;
              height: 20px;
              background: #ccc;
              color: white;
              border-radius: 50%;
              font-size: 12px;
              display: none;
              align-items: center;
              justify-content: center;
              cursor: pointer;
            }
            .sticker-search-clear.show {
              display: flex;
            }

            /* 2. 分类栏：固定在顶部 */
            .sticker-category-bar {
              flex-shrink: 0; /* 禁止压缩 */
              display: flex;
              align-items: center;
              overflow-x: auto;
              padding: 8px 12px;
              gap: 8px;
              background: #f9f9f9;
              border-bottom: 1px solid #eee;
            }

            /* AI绑定标记 - 简洁的小圆点指示器 */
            .category-tab.ai-bound {
              position: relative;
            }
            .category-tab.ai-bound::after {
              content: "";
              position: absolute;
              top: 4px;
              right: 4px;
              width: 6px;
              height: 6px;
              background: #42a5f5;
              border-radius: 50%;
              box-shadow: 0 0 4px rgba(66, 165, 245, 0.5);
            }
            .category-tab.ai-bound.active::after {
              background: #fff;
              box-shadow: 0 0 4px rgba(255, 255, 255, 0.5);
            }

            /* AI绑定按钮 - 简洁图标风格，类似编辑按钮 */
            .ai-bind-btn {
              padding: 4px 10px;
              background: transparent;
              border: 1px solid #ddd;
              border-radius: 12px;
              font-size: 0.75rem;
              color: #666;
              cursor: pointer;
              flex-shrink: 0;
              display: flex;
              align-items: center;
              gap: 3px;
              transition: all 0.2s ease;
            }
            .ai-bind-btn:active {
              background: #f5f5f5;
            }
            .ai-bind-btn.has-bindings {
              background: #e3f2fd;
              border-color: #64b5f6;
              color: #1976d2;
            }

            /* AI绑定管理弹窗 */
            .ai-bind-modal-overlay {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.5);
              z-index: 10000;
              display: flex;
              align-items: center;
              justify-content: center;
              opacity: 0;
              pointer-events: none;
              transition: opacity 0.2s ease;
            }
            .ai-bind-modal-overlay.active {
              opacity: 1;
              pointer-events: auto;
            }
            .ai-bind-modal {
              background: #fff;
              border-radius: 16px;
              width: 90%;
              max-width: 360px;
              max-height: 70vh;
              display: flex;
              flex-direction: column;
              transform: scale(0.9);
              transition: transform 0.2s ease;
              overflow: hidden;
            }
            .ai-bind-modal-overlay.active .ai-bind-modal {
              transform: scale(1);
            }
            .ai-bind-modal-header {
              padding: 16px;
              border-bottom: 1px solid #eee;
              display: flex;
              align-items: center;
              justify-content: space-between;
            }
            .ai-bind-modal-title {
              font-size: 1rem;
              font-weight: 600;
              color: #333;
            }
            .ai-bind-modal-subtitle {
              font-size: 0.75rem;
              color: #999;
              margin-top: 2px;
            }
            .ai-bind-modal-close {
              width: 28px;
              height: 28px;
              border: none;
              background: #f5f5f5;
              border-radius: 50%;
              font-size: 1rem;
              color: #666;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
            }
            .ai-bind-modal-body {
              flex: 1;
              overflow-y: auto;
              padding: 12px 16px;
            }
            .ai-bind-category-item {
              display: flex;
              align-items: center;
              padding: 12px;
              border-radius: 10px;
              margin-bottom: 8px;
              background: #f9f9f9;
              cursor: pointer;
              transition: all 0.15s ease;
            }
            .ai-bind-category-item:active {
              background: #f0f0f0;
              transform: scale(0.98);
            }
            .ai-bind-category-item.selected {
              background: #e3f2fd;
              border: 1px solid #64b5f6;
            }
            .ai-bind-category-checkbox {
              width: 20px;
              height: 20px;
              border: 2px solid #ddd;
              border-radius: 4px;
              margin-right: 12px;
              display: flex;
              align-items: center;
              justify-content: center;
              transition: all 0.15s ease;
              flex-shrink: 0;
            }
            .ai-bind-category-item.selected .ai-bind-category-checkbox {
              background: #42a5f5;
              border-color: #42a5f5;
              color: #fff;
            }
            .ai-bind-category-info {
              flex: 1;
              min-width: 0;
            }
            .ai-bind-category-name {
              font-size: 0.9rem;
              color: #333;
              font-weight: 500;
            }
            .ai-bind-category-count {
              font-size: 0.75rem;
              color: #999;
              margin-top: 2px;
            }
            .ai-bind-modal-footer {
              padding: 12px 16px;
              border-top: 1px solid #eee;
              display: flex;
              gap: 10px;
            }
            .ai-bind-modal-btn {
              flex: 1;
              padding: 10px;
              border: none;
              border-radius: 10px;
              font-size: 0.9rem;
              cursor: pointer;
              transition: all 0.15s ease;
            }
            .ai-bind-modal-btn.cancel {
              background: #f5f5f5;
              color: #666;
            }
            .ai-bind-modal-btn.confirm {
              background: #42a5f5;
              color: #fff;
            }
            .ai-bind-modal-btn:active {
              transform: scale(0.98);
              opacity: 0.9;
            }
            .ai-bind-empty-hint {
              text-align: center;
              padding: 40px 20px;
              color: #999;
              font-size: 0.85rem;
            }
            .ai-bind-char-hint {
              padding: 10px 12px;
              background: #fff8e1;
              border-radius: 8px;
              margin-bottom: 12px;
              font-size: 0.8rem;
              color: #f57c00;
              display: flex;
              align-items: center;
              gap: 6px;
            }

            /* 搜索结果提示 */
            .search-result-hint {
              padding: 8px 12px;
              background: #fff8e1;
              color: #f57c00;
              font-size: 0.8rem;
              text-align: center;
              flex-shrink: 0;
            }

            /* 搜索结果为空提示 */
            .sticker-empty-hint {
              grid-column: 1 / -1;
              text-align: center;
              padding: 40px 20px;
              color: #999;
              font-size: 0.9rem;
            }
              flex-shrink: 0;
            }

            .sticker-img-box:active {
              transform: scale(0.95);
              background: #f5f5f5;
            }
            /* 优化后的网格：微信风格 */
            .emoji-grid {
              flex: 1;
              overflow-y: auto !important;
              overflow-x: hidden !important; /* 禁止左右滑动 */
              display: grid !important;
              /* 核心修改：固定4列 */
              grid-template-columns: repeat(4, 1fr) !important;
              padding: 12px !important;
              gap: 12px 8px !important; /* 行间距12px，列间距8px */
              align-content: start;
              width: 100% !important;
              box-sizing: border-box !important;
            }

            /* 单个表情卡片 */
            .sticker-item {
              display: flex;
              flex-direction: column;
              align-items: center;
              position: relative;
              width: 100%;
              min-width: 0; /* 防止溢出 */
            }

            /* 图片容器：保持正方形 */
            .sticker-img-box {
              width: 100%;
              aspect-ratio: 1 / 1;
              border-radius: 8px;
              background: #fff;
              border: 1px solid rgba(0, 0, 0, 0.05);
              overflow: hidden;
              display: flex;
              align-items: center;
              justify-content: center;
              margin-bottom: 4px;
              position: relative; /* 为删除覆盖层定位 */
            }

            /* 图片本身 */
            .sticker-img-box img {
              width: 100%;
              height: 100%;
              object-fit: contain; /* 保持比例 */
            }

            /* 描述文字 */
            .sticker-desc {
              font-size: 0.65rem;
              color: #999;
              text-align: center;
              width: 100%;
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
              line-height: 1.2;
            }

            /* 添加/链接按钮 - 统一使用sticker-img-box的样式 */
            .sticker-add-btn {
              width: 100%;
              aspect-ratio: 1 / 1;
              border-radius: 8px;
              border: 2px dashed #ddd;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              background: #fafafa;
              color: #bbb;
              margin-bottom: 6px;
            }
            .sticker-add-btn .sticker-add-icon {
              font-size: 20px;
              color: #ccc;
              margin-bottom: 2px;
            }
            .sticker-add-btn .sticker-add-text {
              font-size: 0.65rem;
              color: #aaa;
            }
            /* 微信风格表情包样式 */
            .sticker-img {
              max-width: 120px !important; /* 限制最大宽度 */
              max-height: 120px !important;
              width: auto;
              height: auto;
              vertical-align: middle;
              cursor: pointer;
            }

            /* 这是一个特殊的 class，用于让气泡背景透明 */
            .msg-bubble.sticker-bubble,
            .msg-row.user .msg-bubble.sticker-bubble,
            .msg-row.ai .msg-bubble.sticker-bubble,
            .msg-row.ai.group-msg .msg-bubble.sticker-bubble,
            .msg-row.user.group-msg .msg-bubble.sticker-bubble {
              background: transparent !important; /* 去掉背景色 */
              box-shadow: none !important; /* 去掉阴影 */
              padding: 0 !important; /* 去掉内边距 */
              border-radius: 0 !important; /* 去掉圆角 */
              border: none !important;
            }

            /* 转发动态卡片样式 - 精致版 */
            .shared-post-card {
              background: #fff;
              border-radius: 16px;
              overflow: hidden;
              box-shadow: 0 4px 20px rgba(0,0,0,0.12);
              max-width: 280px;
              border: 1px solid rgba(0,0,0,0.05);
            }
            .shared-post-header {
              display: flex;
              align-items: center;
              gap: 10px;
              padding: 12px 14px;
              background: linear-gradient(135deg, rgba(102,126,234,0.08), rgba(118,75,162,0.08));
            }
            .shared-post-avatar {
              width: 36px;
              height: 36px;
              border-radius: 50%;
              background: linear-gradient(135deg, #667eea, #764ba2);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 18px;
              color: #fff;
              overflow: hidden;
              box-shadow: 0 2px 8px rgba(102,126,234,0.3);
            }
            .shared-post-avatar img {
              width: 100%;
              height: 100%;
              object-fit: cover;
            }
            .shared-post-meta {
              flex: 1;
            }
            .shared-post-author {
              font-size: 0.9rem;
              font-weight: 600;
              color: #333;
              display: block;
            }
            .shared-post-time {
              font-size: 0.7rem;
              color: #999;
              margin-top: 1px;
            }
            .shared-post-label {
              font-size: 0.65rem;
              color: #fff;
              background: linear-gradient(135deg, #667eea, #764ba2);
              padding: 3px 8px;
              border-radius: 10px;
              font-weight: 500;
            }
            .shared-post-body {
              padding: 12px 14px;
            }
            .shared-post-content {
              font-size: 0.9rem;
              color: #333;
              line-height: 1.6;
              margin-bottom: 10px;
              display: -webkit-box;
              -webkit-line-clamp: 4;
              -webkit-box-orient: vertical;
              overflow: hidden;
            }
            .shared-post-image {
              width: 100%;
              max-height: 180px;
              object-fit: cover;
              border-radius: 12px;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            .shared-post-text-img {
              width: 100%;
              height: 100px;
              border-radius: 12px;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 0.9rem;
              color: #fff;
              text-shadow: 0 1px 3px rgba(0,0,0,0.3);
              position: relative;
              overflow: hidden;
            }
            .shared-post-text-img::before {
              content: "";
              position: absolute;
              inset: 0;
              background: rgba(0,0,0,0.1);
              backdrop-filter: blur(1px);
            }
            .shared-post-text-img span {
              position: relative;
              z-index: 1;
              padding: 0 12px;
              text-align: center;
            }
            .shared-post-footer {
              padding: 10px 14px;
              background: linear-gradient(135deg, #f8f9ff, #fdf8ff);
              border-top: 1px solid rgba(102,126,234,0.1);
              display: flex;
              align-items: center;
              justify-content: space-between;
            }
            .shared-post-footer-text {
              font-size: 0.75rem;
              color: #888;
              display: flex;
              align-items: center;
              gap: 4px;
            }
            .shared-post-footer-icon {
              font-size: 0.9rem;
            }
            .shared-post-interact {
              font-size: 0.7rem;
              color: #667eea;
              font-weight: 500;
            }

            /* 禁用长按系统菜单 */
            .category-tab {
              -webkit-touch-callout: none; /* 禁用 iOS 长按弹出菜单 */
              -webkit-user-select: none; /* 禁用文字选中 */
              user-select: none;
              position: relative; /* 确保定位准确 */
            }

            /* ==================== 世界书页面样式 ==================== */
            .worldbook-page {
              background: linear-gradient(180deg, #fff5f8 0%, #ffeef5 100%) !important;
              padding: 0 !important;
            }

            .worldbook-page::before {
              background-image: radial-gradient(rgba(244,143,177,0.15) 1.5px, transparent 1.5px) !important;
            }

            .worldbook-header {
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 16px 20px;
              padding-top: max(16px, env(safe-area-inset-top));
              background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
              border-bottom: 1px solid rgba(255,255,255,0.5);
              position: sticky;
              top: 0;
              z-index: 10;
            }

            .worldbook-header-left {
              display: flex;
              align-items: center;
              gap: 12px;
            }

            .worldbook-title {
              font-size: 1.15rem;
              font-weight: 700;
              color: #c2185b;
              display: flex;
              align-items: center;
              gap: 8px;
            }

            .worldbook-header-actions {
              display: flex;
              gap: 8px;
            }

            .worldbook-header-btn {
              width: 36px;
              height: 36px;
              border: none;
              background: rgba(255,255,255,0.6);
              border-radius: 50%;
              font-size: 18px;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              transition: all 0.2s;
              color: #000;
            }
            .worldbook-header-btn svg {
              stroke: #000;
            }

            .worldbook-header-btn:active {
              transform: scale(0.9);
              background: rgba(255,255,255,0.8);
            }

            .worldbook-content {
              padding: 16px;
              padding-bottom: calc(100px + env(safe-area-inset-bottom));
            }

            /* 分组标签栏 */
            .worldbook-tabs {
              display: flex;
              gap: 8px;
              overflow-x: auto;
              padding: 4px 0 16px 0;
              -webkit-overflow-scrolling: touch;
            }

            .worldbook-tabs::-webkit-scrollbar {
              display: none;
            }

            .worldbook-tab {
              padding: 8px 16px;
              border-radius: 20px;
              font-size: 0.85rem;
              font-weight: 600;
              border: 2px solid rgba(244,143,177,0.3);
              background: white;
              color: #c2185b;
              cursor: pointer;
              white-space: nowrap;
              transition: all 0.2s;
              display: flex;
              align-items: center;
              gap: 6px;
            }

            .worldbook-tab.active {
              background: linear-gradient(135deg, #f48fb1, #f06292);
              color: white;
              border-color: transparent;
              box-shadow: 0 3px 12px rgba(244,143,177,0.4);
            }

            .worldbook-tab-count {
              background: rgba(255,255,255,0.3);
              padding: 2px 8px;
              border-radius: 10px;
              font-size: 0.75rem;
            }

            .worldbook-tab.active .worldbook-tab-count {
              background: rgba(255,255,255,0.3);
            }

            /* 批量操作栏 */
            .worldbook-batch-bar {
              display: none;
              align-items: center;
              justify-content: space-between;
              padding: 12px 16px;
              background: linear-gradient(135deg, #fff0f5, #fce4ec);
              border-radius: 16px;
              margin-bottom: 16px;
              border: 2px solid rgba(244,143,177,0.2);
            }

            .worldbook-batch-bar.active {
              display: flex;
            }

            .worldbook-batch-info {
              font-size: 0.9rem;
              color: #c2185b;
              font-weight: 600;
            }

            .worldbook-batch-actions {
              display: flex;
              gap: 8px;
            }

            .worldbook-batch-btn {
              padding: 8px 16px;
              border-radius: 20px;
              font-size: 0.8rem;
              font-weight: 600;
              border: none;
              cursor: pointer;
              transition: all 0.2s;
            }

            .worldbook-batch-btn.cancel {
              background: rgba(0,0,0,0.05);
              color: #666;
            }

            .worldbook-batch-btn.move {
              background: linear-gradient(135deg, #81d4fa, #4fc3f7);
              color: white;
            }

            .worldbook-batch-btn.delete {
              background: linear-gradient(135deg, #ff8a80, #ff5252);
              color: white;
            }

            /* 世界书列表 */
            .worldbook-list {
              display: flex;
              flex-direction: column;
              gap: 12px;
            }

            .worldbook-item {
              background: white;
              border-radius: 16px;
              padding: 16px;
              box-shadow: 0 2px 12px rgba(194,24,91,0.08);
              border: 2px solid transparent;
              transition: all 0.2s;
              position: relative;
            }

            .worldbook-item.selected {
              border-color: #f48fb1;
              background: #fff5f8;
            }

            .worldbook-item-header {
              display: flex;
              align-items: flex-start;
              gap: 12px;
            }

            .worldbook-item-checkbox {
              width: 22px;
              height: 22px;
              border-radius: 50%;
              border: 2px solid #e0e0e0;
              cursor: pointer;
              display: none;
              align-items: center;
              justify-content: center;
              flex-shrink: 0;
              margin-top: 2px;
              transition: all 0.2s;
            }

            .worldbook-batch-bar.active ~ .worldbook-list .worldbook-item-checkbox {
              display: flex;
            }

            .worldbook-item.selected .worldbook-item-checkbox {
              background: linear-gradient(135deg, #f48fb1, #f06292);
              border-color: #f48fb1;
            }

            .worldbook-item.selected .worldbook-item-checkbox::after {
              content: "✓";
              color: white;
              font-size: 12px;
              font-weight: bold;
            }

            .worldbook-item-main {
              flex: 1;
              min-width: 0;
            }

            .worldbook-item-title {
              font-size: 1rem;
              font-weight: 700;
              color: #333;
              margin-bottom: 6px;
              display: flex;
              align-items: center;
              gap: 8px;
            }

            .worldbook-item-tag {
              font-size: 0.7rem;
              padding: 2px 8px;
              border-radius: 10px;
              background: linear-gradient(135deg, #e1bee7, #ce93d8);
              color: white;
              font-weight: 500;
            }

            .worldbook-item-desc {
              font-size: 0.85rem;
              color: #666;
              line-height: 1.5;
              display: -webkit-box;
              -webkit-line-clamp: 2;
              -webkit-box-orient: vertical;
              overflow: hidden;
              margin-bottom: 10px;
            }

            .worldbook-item-meta {
              display: flex;
              align-items: center;
              gap: 12px;
              font-size: 0.75rem;
              color: #999;
            }

            .worldbook-item-meta-item {
              display: flex;
              align-items: center;
              gap: 4px;
            }

            .worldbook-item-actions {
              display: flex;
              gap: 8px;
              flex-shrink: 0;
            }

            .worldbook-item-btn {
              width: 32px;
              height: 32px;
              border-radius: 10px;
              border: none;
              background: rgba(244,143,177,0.1);
              color: #f48fb1;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 14px;
              transition: all 0.2s;
            }

            .worldbook-item-btn:active {
              transform: scale(0.9);
            }

            .worldbook-item-btn.delete {
              background: rgba(255,82,82,0.1);
              color: #ff5252;
            }

            .worldbook-item-toggle {
              width: 44px;
              height: 24px;
              border-radius: 12px;
              background: #e0e0e0;
              position: relative;
              cursor: pointer;
              transition: all 0.3s;
            }

            .worldbook-item-toggle.active {
              background: linear-gradient(135deg, #f48fb1, #f06292);
            }

            .worldbook-item-toggle::after {
              content: "";
              position: absolute;
              width: 20px;
              height: 20px;
              background: white;
              border-radius: 50%;
              top: 2px;
              left: 2px;
              transition: all 0.3s;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            .worldbook-item-toggle.active::after {
              left: 22px;
            }

            /* 空状态 */
            .worldbook-empty {
              text-align: center;
              padding: 60px 20px;
            }

            .worldbook-empty-icon {
              font-size: 64px;
              margin-bottom: 16px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: #c2185b;
            }

            .worldbook-empty-icon svg {
              stroke: #c2185b;
            }

            .worldbook-empty-title {
              font-size: 1.1rem;
              font-weight: 600;
              color: #c2185b;
              margin-bottom: 8px;
            }

            .worldbook-empty-text {
              font-size: 0.9rem;
              color: #999;
              margin-bottom: 24px;
            }

            .worldbook-empty-btn {
              display: inline-flex;
              align-items: center;
              gap: 8px;
              padding: 12px 24px;
              background: linear-gradient(135deg, #f48fb1, #f06292);
              color: white;
              border: none;
              border-radius: 24px;
              font-size: 1rem;
              font-weight: 600;
              cursor: pointer;
              box-shadow: 0 4px 15px rgba(244,143,177,0.4);
            }

            /* 世界书编辑弹窗 */
            .worldbook-modal {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.5);
              z-index: 500;
              display: none;
              align-items: flex-end;
            }

            .worldbook-modal.active {
              display: flex;
            }

            .worldbook-modal-content {
              background: #fff;
              width: 100%;
              max-height: 90vh;
              border-radius: 24px 24px 0 0;
              display: flex;
              flex-direction: column;
              animation: slideUpModal 0.3s ease;
            }

            .worldbook-modal-header {
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 20px;
              border-bottom: 1px solid #f0f0f0;
            }

            .worldbook-modal-title {
              font-size: 1.1rem;
              font-weight: 700;
              color: #c2185b;
            }

            .worldbook-modal-close {
              width: 32px;
              height: 32px;
              border: none;
              background: rgba(0,0,0,0.05);
              border-radius: 50%;
              font-size: 16px;
              cursor: pointer;
              color: #666;
            }

            .worldbook-modal-body {
              flex: 1;
              overflow-y: auto;
              padding: 20px;
            }

            .worldbook-form-group {
              margin-bottom: 20px;
            }

            .worldbook-form-label {
              display: block;
              font-size: 0.85rem;
              font-weight: 600;
              color: #666;
              margin-bottom: 8px;
            }

            .worldbook-form-hint {
              font-weight: 400;
              color: #999;
              margin-left: 8px;
            }

            .worldbook-form-input {
              width: 100%;
              padding: 12px 16px;
              border: 2px solid #f0f0f0;
              border-radius: 12px;
              font-size: 0.95rem;
              font-family: inherit;
              outline: none;
              transition: all 0.2s;
              background: #fafafa;
            }

            .worldbook-form-input:focus {
              border-color: #f48fb1;
              background: white;
            }

            .worldbook-form-textarea {
              min-height: 120px;
              resize: vertical;
              line-height: 1.6;
            }

            .worldbook-form-select {
              appearance: none;
              background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23999' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
              background-repeat: no-repeat;
              background-position: right 14px center;
              padding-right: 36px;
              cursor: pointer;
            }

            /* 条目列表 (世界书内的条目) */
            .worldbook-entries {
              background: #f8f8f8;
              border-radius: 12px;
              padding: 12px;
            }

            .worldbook-entry {
              background: white;
              border-radius: 10px;
              padding: 12px;
              margin-bottom: 8px;
              border: 1px solid #f0f0f0;
            }

            .worldbook-entry:last-child {
              margin-bottom: 0;
            }

            .worldbook-entry-header {
              display: flex;
              align-items: center;
              justify-content: space-between;
              margin-bottom: 8px;
            }

            .worldbook-entry-toggle {
              width: 40px;
              height: 22px;
              border-radius: 11px;
              background: #e0e0e0;
              position: relative;
              cursor: pointer;
              transition: all 0.3s;
            }

            .worldbook-entry-toggle.active {
              background: linear-gradient(135deg, #81c784, #4caf50);
            }

            .worldbook-entry-toggle::after {
              content: "";
              position: absolute;
              width: 18px;
              height: 18px;
              background: white;
              border-radius: 50%;
              top: 2px;
              left: 2px;
              transition: all 0.3s;
            }

            .worldbook-entry-toggle.active::after {
              left: 20px;
            }

            .worldbook-entry-actions {
              display: flex;
              gap: 6px;
            }

            .worldbook-entry-btn {
              width: 28px;
              height: 28px;
              border-radius: 8px;
              border: none;
              background: #f5f5f5;
              color: #666;
              cursor: pointer;
              font-size: 12px;
            }

            .worldbook-entry-btn.delete {
              background: #ffebee;
              color: #ff5252;
            }

            .worldbook-entry-keywords {
              display: flex;
              flex-wrap: wrap;
              gap: 6px;
              margin-bottom: 8px;
            }

            .worldbook-entry-keyword {
              padding: 4px 10px;
              background: linear-gradient(135deg, #e3f2fd, #bbdefb);
              border-radius: 12px;
              font-size: 0.75rem;
              color: #1976d2;
              font-weight: 500;
            }

            .worldbook-entry-content {
              font-size: 0.85rem;
              color: #666;
              line-height: 1.5;
              display: -webkit-box;
              -webkit-line-clamp: 2;
              -webkit-box-orient: vertical;
              overflow: hidden;
            }

            .worldbook-add-entry-btn {
              width: 100%;
              padding: 12px;
              border: 2px dashed #e0e0e0;
              border-radius: 10px;
              background: transparent;
              color: #999;
              font-size: 0.9rem;
              cursor: pointer;
              transition: all 0.2s;
              margin-top: 8px;
            }

            .worldbook-add-entry-btn:hover {
              border-color: #f48fb1;
              color: #f48fb1;
            }

            .worldbook-modal-footer {
              padding: 16px 20px;
              padding-bottom: calc(16px + env(safe-area-inset-bottom));
              border-top: 1px solid #f0f0f0;
              display: flex;
              gap: 12px;
            }

            .worldbook-modal-btn {
              flex: 1;
              padding: 14px;
              border: none;
              border-radius: 12px;
              font-size: 1rem;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
            }

            .worldbook-modal-btn.cancel {
              background: #f5f5f5;
              color: #666;
            }

            .worldbook-modal-btn.save {
              background: linear-gradient(135deg, #f48fb1, #f06292);
              color: white;
              box-shadow: 0 4px 15px rgba(244,143,177,0.4);
            }

            /* 分组管理弹窗 */
            .worldbook-group-modal {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.5);
              z-index: 510;
              display: none;
              align-items: center;
              justify-content: center;
              padding: 20px;
            }

            .worldbook-group-modal.active {
              display: flex;
            }

            .worldbook-group-modal-content {
              background: white;
              width: 100%;
              max-width: 320px;
              border-radius: 20px;
              padding: 24px;
              animation: scaleIn 0.2s ease;
            }

            @keyframes scaleIn {
              from { transform: scale(0.9); opacity: 0; }
              to { transform: scale(1); opacity: 1; }
            }

            .worldbook-group-title {
              font-size: 1.1rem;
              font-weight: 700;
              color: #c2185b;
              margin-bottom: 16px;
              text-align: center;
            }

            .worldbook-group-list {
              max-height: 200px;
              overflow-y: auto;
              margin-bottom: 16px;
            }

            .worldbook-group-item {
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 12px;
              background: #f8f8f8;
              border-radius: 10px;
              margin-bottom: 8px;
            }

            .worldbook-group-item-name {
              font-size: 0.9rem;
              color: #333;
              font-weight: 500;
            }

            .worldbook-group-item-delete {
              width: 28px;
              height: 28px;
              border: none;
              background: rgba(255,82,82,0.1);
              color: #ff5252;
              border-radius: 8px;
              cursor: pointer;
              font-size: 14px;
            }

            .worldbook-group-add-row {
              display: flex;
              gap: 8px;
              align-items: center;
            }

            .worldbook-group-add-input {
              flex: 1;
              min-width: 0;
              padding: 10px 14px;
              border: 2px solid #f0f0f0;
              border-radius: 10px;
              font-size: 0.9rem;
              outline: none;
            }

            .worldbook-group-add-input:focus {
              border-color: #f48fb1;
            }

            .worldbook-group-add-btn {
              padding: 10px 16px;
              background: linear-gradient(135deg, #f48fb1, #f06292);
              color: white;
              border: none;
              border-radius: 10px;
              font-weight: 600;
              cursor: pointer;
              white-space: nowrap;
              flex-shrink: 0;
            }

            .worldbook-group-close {
              width: 100%;
              padding: 12px;
              background: #f5f5f5;
              border: none;
              border-radius: 10px;
              color: #666;
              font-size: 0.95rem;
              cursor: pointer;
              margin-top: 12px;
            }

            /* 移动分组弹窗 */
            .worldbook-move-modal {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.5);
              z-index: 510;
              display: none;
              align-items: center;
              justify-content: center;
              padding: 20px;
            }

            .worldbook-move-modal.active {
              display: flex;
            }

            .worldbook-move-modal-content {
              background: white;
              width: 100%;
              max-width: 320px;
              border-radius: 20px;
              padding: 24px;
              animation: scaleIn 0.2s ease;
            }

            .worldbook-move-title {
              font-size: 1.1rem;
              font-weight: 700;
              color: #c2185b;
              margin-bottom: 16px;
              text-align: center;
            }

            .worldbook-move-list {
              max-height: 250px;
              overflow-y: auto;
            }

            .worldbook-move-item {
              padding: 14px 16px;
              border-radius: 12px;
              margin-bottom: 8px;
              background: #f8f8f8;
              cursor: pointer;
              transition: all 0.2s;
              font-size: 0.95rem;
              color: #333;
              display: flex;
              align-items: center;
              gap: 10px;
            }

            .worldbook-move-item:hover {
              background: #fff0f5;
            }

            .worldbook-move-item.active {
              background: linear-gradient(135deg, #fce4ec, #f8bbd9);
              color: #c2185b;
              font-weight: 600;
            }

            .worldbook-move-cancel {
              width: 100%;
              padding: 12px;
              background: #f5f5f5;
              border: none;
              border-radius: 10px;
              color: #666;
              font-size: 0.95rem;
              cursor: pointer;
              margin-top: 12px;
            }

            /* 聊天设置中的世界书选择 */
            .worldbook-select-area {
              background: #f8f8f8;
              border-radius: 12px;
              padding: 12px;
              max-height: 200px;
              overflow-y: auto;
            }

            .worldbook-select-item {
              display: flex;
              align-items: center;
              gap: 10px;
              padding: 10px 12px;
              background: white;
              border-radius: 10px;
              margin-bottom: 8px;
              cursor: pointer;
              transition: all 0.2s;
              border: 2px solid transparent;
            }

            .worldbook-select-item:last-child {
              margin-bottom: 0;
            }

            .worldbook-select-item.selected {
              border-color: #f48fb1;
              background: #fff5f8;
            }

            .worldbook-select-checkbox {
              width: 20px;
              height: 20px;
              border-radius: 4px;
              border: 2px solid #e0e0e0;
              display: flex;
              align-items: center;
              justify-content: center;
              flex-shrink: 0;
              transition: all 0.2s;
            }

            .worldbook-select-item.selected .worldbook-select-checkbox {
              background: linear-gradient(135deg, #f48fb1, #f06292);
              border-color: #f48fb1;
            }

            .worldbook-select-item.selected .worldbook-select-checkbox::after {
              content: "✓";
              color: white;
              font-size: 12px;
              font-weight: bold;
            }

            .worldbook-select-info {
              flex: 1;
              min-width: 0;
            }

            .worldbook-select-name {
              font-size: 0.9rem;
              font-weight: 600;
              color: #333;
              margin-bottom: 2px;
            }

            .worldbook-select-desc {
              font-size: 0.75rem;
              color: #999;
              white-space: nowrap;
              overflow: hidden;
              text-overflow: ellipsis;
            }

            .worldbook-select-empty {
              text-align: center;
              padding: 20px;
              color: #999;
              font-size: 0.9rem;
            }

            /* ==================== 预设App系统样式 ==================== */
            .preset-page {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              width: 100%;
              height: 100%;
              background: linear-gradient(180deg, #fce4ec 0%, #fff0f5 100%);
              z-index: 200;
              display: none;
              flex-direction: column;
              padding: 0 !important;
              overflow: hidden;
            }

            .preset-page.active {
              display: flex;
            }

            .preset-header {
              display: flex;
              align-items: center;
              padding: 16px 20px;
              padding-top: max(16px, env(safe-area-inset-top));
              background: linear-gradient(135deg, #fce4ec, #f8bbd9);
              border-bottom: 1px solid rgba(255,255,255,0.5);
              width: 100%;
              flex-shrink: 0;
            }

            .preset-back-btn {
              width: 36px;
              height: 36px;
              border: none;
              background: rgba(255,255,255,0.6);
              border-radius: 12px;
              font-size: 18px;
              cursor: pointer;
              display: flex;
              align-items: center;
              justify-content: center;
              color: #000;
            }
            .preset-back-btn svg {
              stroke: #000;
            }

            .preset-title {
              flex: 1;
              text-align: center;
              font-size: 1.1rem;
              font-weight: 700;
              color: #c2185b;
            }

            .preset-header-btn {
              width: 36px;
              height: 36px;
              border: none;
              background: rgba(255, 255, 255, 0.8);
              border-radius: 12px;
              font-size: 16px;
              cursor: pointer;
              color: #000;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            .preset-header-btn svg {
              stroke: #000;
            }

            .preset-content {
              flex: 1;
              overflow-y: auto;
              padding: 16px;
              padding-bottom: calc(80px + env(safe-area-inset-bottom));
            }

            .preset-tabs {
              display: flex;
              gap: 8px;
              margin-bottom: 16px;
              padding: 4px;
              background: rgba(255,255,255,0.6);
              border-radius: 14px;
            }

            .preset-tab {
              flex: 1;
              padding: 10px;
              border: none;
              background: transparent;
              border-radius: 10px;
              font-size: 0.85rem;
              font-weight: 600;
              color: #999;
              cursor: pointer;
              transition: all 0.2s;
            }

            .preset-tab.active {
              background: white;
              color: #c2185b;
              box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }

            .preset-list {
              display: flex;
              flex-direction: column;
              gap: 12px;
            }

            .preset-item {
              background: white;
              border-radius: 16px;
              padding: 16px;
              box-shadow: 0 2px 12px rgba(194, 24, 91, 0.08);
              position: relative;
              transition: all 0.2s;
            }

            .preset-item:active {
              transform: scale(0.98);
            }

            .preset-item-header {
              display: flex;
              align-items: flex-start;
              gap: 12px;
              margin-bottom: 10px;
            }

            .preset-item-icon {
              width: 44px;
              height: 44px;
              border-radius: 12px;
              background: linear-gradient(135deg, #fce4ec, #f8bbd9);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 22px;
              flex-shrink: 0;
            }

            .preset-item-info {
              flex: 1;
              min-width: 0;
            }

            .preset-item-name {
              font-size: 0.95rem;
              font-weight: 600;
              color: #333;
              margin-bottom: 4px;
              display: -webkit-box;
              -webkit-line-clamp: 1;
              -webkit-box-orient: vertical;
              overflow: hidden;
            }

            .preset-item-desc {
              font-size: 0.75rem;
              color: #999;
              display: -webkit-box;
              -webkit-line-clamp: 2;
              -webkit-box-orient: vertical;
              overflow: hidden;
              line-height: 1.4;
            }

            .preset-item-checkbox {
              width: 22px;
              height: 22px;
              border: 2px solid #e0e0e0;
              border-radius: 6px;
              display: none;
              align-items: center;
              justify-content: center;
              flex-shrink: 0;
              cursor: pointer;
              transition: all 0.2s;
            }

            .preset-item-checkbox.checked {
              background: linear-gradient(135deg, #f48fb1, #f06292);
              border-color: transparent;
              color: white;
            }

            .preset-item.batch-mode .preset-item-checkbox {
              display: flex;
            }

            .preset-item-tags {
              display: flex;
              flex-wrap: wrap;
              gap: 6px;
              margin-top: 10px;
            }

            .preset-item-tag {
              padding: 4px 10px;
              background: linear-gradient(135deg, #fff0f5, #fce4ec);
              border-radius: 20px;
              font-size: 0.7rem;
              color: #c2185b;
              font-weight: 500;
            }

            .preset-item-actions {
              display: flex;
              gap: 8px;
              margin-top: 12px;
              padding-top: 12px;
              border-top: 1px solid #f5f5f5;
            }

            .preset-action-btn {
              flex: 1;
              padding: 10px;
              border: none;
              border-radius: 10px;
              font-size: 0.8rem;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
            }

            .preset-action-btn.edit {
              background: #fff8e1;
              color: #f9a825;
            }

            .preset-action-btn.delete {
              background: #ffebee;
              color: #ef5350;
            }

            .preset-action-btn.export {
              background: #e3f2fd;
              color: #1976d2;
            }

            .preset-empty {
              text-align: center;
              padding: 60px 20px;
              color: #c9879f;
            }

            .preset-empty-icon {
              font-size: 48px;
              margin-bottom: 16px;
              opacity: 0.5;
              display: flex;
              align-items: center;
              justify-content: center;
              color: var(--accent-pink);
            }

            .preset-empty-icon svg {
              stroke: var(--accent-pink);
            }

            .preset-empty-text {
              font-size: 0.9rem;
              margin-bottom: 20px;
            }

            .preset-empty-btn {
              padding: 12px 24px;
              background: linear-gradient(135deg, #f48fb1, #f06292);
              color: white;
              border: none;
              border-radius: 25px;
              font-size: 0.9rem;
              font-weight: 600;
              cursor: pointer;
              box-shadow: 0 4px 15px rgba(244,143,177,0.4);
            }

            /* 预设编辑弹窗 */
            .preset-modal {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.5);
              z-index: 600;
              display: none;
              align-items: flex-end;
            }

            .preset-modal.active {
              display: flex;
            }

            .preset-modal-content {
              background: linear-gradient(180deg, #fff 0%, #fff5f8 100%);
              width: 100%;
              max-height: 90vh;
              border-radius: 24px 24px 0 0;
              display: flex;
              flex-direction: column;
              animation: slideUpModal 0.3s ease;
            }

            .preset-modal-header {
              display: flex;
              align-items: center;
              justify-content: space-between;
              padding: 20px;
              border-bottom: 1px solid rgba(255,182,193,0.3);
            }

            .preset-modal-title {
              font-size: 1.1rem;
              font-weight: 700;
              color: #c2185b;
            }

            .preset-modal-close {
              width: 32px;
              height: 32px;
              border: none;
              background: rgba(255,182,193,0.2);
              border-radius: 50%;
              font-size: 16px;
              cursor: pointer;
              color: #c2185b;
            }

            .preset-modal-body {
              flex: 1;
              overflow-y: auto;
              padding: 20px;
            }

            .preset-form-group {
              margin-bottom: 20px;
            }

            .preset-form-label {
              display: block;
              font-size: 0.85rem;
              font-weight: 600;
              color: #8a6a7f;
              margin-bottom: 8px;
            }

            .preset-form-hint {
              font-weight: 400;
              color: #c9879f;
              font-size: 0.75rem;
              margin-left: 6px;
            }

            .preset-form-input {
              width: 100%;
              padding: 12px 16px;
              border: 2px solid rgba(255,182,193,0.3);
              border-radius: 12px;
              font-size: 0.95rem;
              font-family: inherit;
              outline: none;
              transition: all 0.2s;
              background: white;
            }

            .preset-form-input:focus {
              border-color: #f48fb1;
              box-shadow: 0 0 0 3px rgba(244,143,177,0.15);
            }

            .preset-form-textarea {
              min-height: 120px;
              resize: vertical;
              line-height: 1.6;
            }

            /* 预设条目列表样式 */
            .preset-entries-list {
              display: flex;
              flex-direction: column;
              gap: 12px;
              max-height: 400px;
              overflow-y: auto;
              background: transparent;
              min-height: 100px;
            }

            .preset-entry-card {
              background: #faf8f5 !important;
              border: 1.5px solid rgba(255,182,193,0.3);
              border-radius: 12px;
              overflow: visible;
              position: relative;
              z-index: 1;
            }

            .preset-entry-header {
              display: flex !important;
              align-items: center;
              padding: 12px;
              gap: 10px;
              background: rgba(255,255,255,0.5);
              border-bottom: 1px solid rgba(255,182,193,0.2);
              min-height: 48px;
            }

            .preset-entry-toggle {
              position: relative;
              width: 44px;
              height: 24px;
              min-width: 44px;
              min-height: 24px;
              background: #ddd;
              border-radius: 12px;
              cursor: pointer;
              transition: all 0.3s;
              flex-shrink: 0;
            }

            .preset-entry-toggle.active {
              background: linear-gradient(135deg, #f48fb1, #f06292);
            }

            .preset-entry-toggle::after {
              content: '';
              position: absolute;
              top: 2px;
              left: 2px;
              width: 20px;
              height: 20px;
              background: white;
              border-radius: 50%;
              transition: all 0.3s;
              box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            }

            .preset-entry-toggle.active::after {
              left: 22px;
            }

            .preset-entry-delete {
              width: 28px;
              height: 28px;
              min-width: 28px;
              min-height: 28px;
              border: none;
              background: rgba(255,100,100,0.1);
              color: #e57373;
              border-radius: 8px;
              cursor: pointer;
              font-size: 16px;
              display: flex;
              align-items: center;
              justify-content: center;
              flex-shrink: 0;
            }

            .preset-entry-body {
              padding: 12px;
              display: flex !important;
              flex-direction: column;
              gap: 10px;
            }

            .preset-entry-row {
              display: flex;
              flex-direction: column;
              gap: 4px;
            }

            .preset-entry-label {
              font-size: 0.8rem;
              color: #8a6a7f;
            }

            .preset-entry-input {
              width: 100%;
              padding: 10px 12px;
              border: 1.5px solid #e5ddd3;
              border-radius: 8px;
              font-size: 0.9rem;
              outline: none;
              background: white;
              box-sizing: border-box;
            }

            .preset-entry-input:focus {
              border-color: #f48fb1;
            }

            .preset-entry-textarea {
              min-height: 80px;
              resize: vertical;
              line-height: 1.5;
              font-family: inherit;
            }

            .preset-entry-content-row {
              display: flex;
              align-items: center;
              gap: 8px;
            }

            .preset-entry-expand-btn {
              padding: 8px 12px;
              border: none;
              background: rgba(244,143,177,0.15);
              color: #c2185b;
              border-radius: 8px;
              font-size: 0.85rem;
              cursor: pointer;
              white-space: nowrap;
            }

            .preset-entry-content-wrapper {
              display: none;
              padding: 0 12px 12px 12px;
            }

            .preset-entry-content-wrapper.active {
              display: block;
            }

            .preset-add-entry-btn {
              width: 100%;
              padding: 14px;
              border: 2px dashed rgba(244,143,177,0.4);
              background: rgba(255,255,255,0.5);
              color: #c2185b;
              border-radius: 12px;
              font-size: 0.95rem;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
              margin-top: 8px;
            }

            .preset-add-entry-btn:hover {
              background: rgba(244,143,177,0.1);
              border-color: #f48fb1;
            }

            .preset-form-row {
              display: flex;
              gap: 12px;
            }

            .preset-form-row .preset-form-group {
              flex: 1;
            }

            .preset-modal-footer {
              padding: 16px 20px;
              padding-bottom: calc(16px + env(safe-area-inset-bottom));
              border-top: 1px solid rgba(255,182,193,0.3);
              display: flex;
              gap: 12px;
            }

            .preset-modal-btn {
              flex: 1;
              padding: 14px;
              border: none;
              border-radius: 12px;
              font-size: 1rem;
              font-weight: 600;
              cursor: pointer;
              transition: all 0.2s;
            }

            .preset-modal-btn.cancel {
              background: #f5f5f5;
              color: #666;
            }

            .preset-modal-btn.save {
              background: linear-gradient(135deg, #f48fb1, #f06292);
              color: white;
              box-shadow: 0 4px 15px rgba(244,143,177,0.4);
            }

            /* 导入弹窗 */
            .preset-import-modal {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              bottom: 0;
              background: rgba(0,0,0,0.5);
              z-index: 610;
              display: none;
              align-items: center;
              justify-content: center;
              padding: 20px;
            }

            .preset-import-modal.active {
              display: flex;
            }

            .preset-import-content {
              background: white;
              width: 100%;
              max-width: 340px;
              border-radius: 20px;
              padding: 24px;
              animation: scaleIn 0.2s ease;
            }

            .preset-import-title {
              font-size: 1.1rem;
              font-weight: 700;
              color: #c2185b;
              text-align: center;
              margin-bottom: 20px;
            }

            .preset-import-options {
              display: flex;
              flex-direction: column;
              gap: 10px;
              margin-bottom: 20px;
            }

            .preset-import-option {
              display: flex;
              align-items: center;
              gap: 12px;
              padding: 16px;
              background: #f8f8f8;
              border-radius: 14px;
              cursor: pointer;
              transition: all 0.2s;
            }

            .preset-import-option:hover {
              background: #fff0f5;
            }

            .preset-import-option-icon {
              width: 40px;
              height: 40px;
              border-radius: 10px;
              background: linear-gradient(135deg, #fce4ec, #f8bbd9);
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 20px;
            }

            .preset-import-option-text {
              flex: 1;
            }

            .preset-import-option-title {
              font-size: 0.9rem;
              font-weight: 600;
              color: #333;
            }

            .preset-import-option-desc {
              font-size: 0.75rem;
              color: #999;
              margin-top: 2px;
            }

            .preset-import-cancel {
              width: 100%;
              padding: 12px;
              background: #f5f5f5;
              border: none;
              border-radius: 10px;
              font-size: 0.95rem;
              color: #666;
              cursor: pointer;
            }

            /* 批量操作浮动栏 */
            .preset-batch-bar {
              position: fixed;
              bottom: 0;
              left: 0;
              right: 0;
              padding: 16px 20px;
              padding-bottom: calc(16px + env(safe-area-inset-bottom));
              background: white;
              border-top: 1px solid #f0f0f0;
              display: none;
              gap: 12px;
              z-index: 250;
              box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
            }

            .preset-batch-bar.active {
              display: flex;
            }

            .preset-batch-btn {
              flex: 1;
              padding: 14px;
              border: none;
              border-radius: 12px;
              font-size: 0.95rem;
              font-weight: 600;
              cursor: pointer;
            }

            .preset-batch-btn.cancel {
              background: #f5f5f5;
              color: #666;
            }

            .preset-batch-btn.delete {
              background: linear-gradient(135deg, #ef5350, #e53935);
              color: white;
            }

            /* 线下模式字数设置样式 */
            .offline-word-settings {
              margin-top: 12px;
              padding: 16px;
              background: linear-gradient(135deg, #fff8e1, #fff3e0);
              border-radius: 14px;
              border: 1px solid rgba(255,183,77,0.3);
              display: none;
            }

            .offline-word-settings.active {
              display: block;
            }

            .offline-word-title {
              font-size: 0.85rem;
              font-weight: 600;
              color: #ef6c00;
              margin-bottom: 12px;
              display: flex;
              align-items: center;
              gap: 6px;
            }

            .offline-word-row {
              display: flex;
              align-items: center;
              gap: 10px;
              margin-bottom: 12px;
            }

            .offline-word-input {
              width: 70px;
              padding: 10px 12px;
              border: 1.5px solid rgba(255,183,77,0.4);
              border-radius: 10px;
              font-size: 0.9rem;
              text-align: center;
              outline: none;
              background: white;
            }

            .offline-word-input:focus {
              border-color: #ffb74d;
              box-shadow: 0 0 0 3px rgba(255,183,77,0.15);
            }

            .offline-word-sep {
              color: #ef6c00;
              font-weight: 500;
            }

            .offline-word-unit {
              color: #8d6e63;
              font-size: 0.85rem;
            }

            /* 预设选择下拉 */
            .offline-preset-select {
              margin-top: 12px;
            }

            .offline-preset-dropdown {
              width: 100%;
              padding: 12px 16px;
              border: 1.5px solid rgba(255,183,77,0.4);
              border-radius: 12px;
              font-size: 0.9rem;
              font-family: inherit;
              outline: none;
              background: white;
              color: #5d4e37;
              cursor: pointer;
              appearance: none;
              background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23ef6c00' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
              background-repeat: no-repeat;
              background-position: right 14px center;
              padding-right: 36px;
            }

            .offline-preset-dropdown:focus {
              border-color: #ffb74d;
              box-shadow: 0 0 0 3px rgba(255,183,77,0.15);
            }
            /* --- 修复群聊头像红点显示 --- */
      /* 允许子元素溢出显示 */
      .message-item.group-chat .message-avatar {
        overflow: visible !important;
      }
      /* 依然保持图片的圆角 */
      .message-item.group-chat .message-avatar img {
        border-radius: 14px;
      }
      /* 确保小点层级在最上 */
      .message-item.group-chat .message-avatar::after {
        z-index: 5;
        box-shadow: 0 0 0 2px #fff; /* 增加白色描边让它更清晰 */
      }
    </style>
  </head>
  <body>
    <!-- Decorative stars -->
    <div class="star star-1"></div>
    <div class="star star-2"></div>
    <div class="star star-3"></div>
    <div class="star star-4"></div>
    <div class="star star-5"></div>

    <div class="phone-container">
      <div class="main-content">
        <!-- Profile Widget - 创意名片 -->
        <div class="profile-widget">
          <div class="profile-card-layout">
            <!-- 左侧两个标签 -->
            <div class="profile-tags-column">
              <div class="profile-tag" onclick="openTagEditModal('leftTop')">
                <span class="profile-tag-text" id="tagLeftTop"></span>
              </div>
              <div class="profile-tag" onclick="openTagEditModal('leftBottom')">
                <span class="profile-tag-text" id="tagLeftBottom"></span>
              </div>
            </div>

            <!-- 中间头像 -->
            <div class="profile-avatar-center">
              <div
                class="profile-avatar"
                onclick="document.getElementById('avatarInput').click()"
              >
                <div class="profile-avatar-inner">
                  <span id="avatarPlaceholder">
                    <svg
                      width="28"
                      height="28"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="#f48fb1"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"
                      ></path>
                      <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                  </span>
                  <img id="avatarImg" src="" alt="" style="display: none" />
                </div>
              </div>
            </div>
            <input
              type="file"
              id="avatarInput"
              class="hidden-input"
              accept="image/*"
              onchange="handleAvatarUpload(this)"
            />

            <!-- 右侧两个标签 -->
            <div class="profile-tags-column">
              <div class="profile-tag" onclick="openTagEditModal('rightTop')">
                <span class="profile-tag-text" id="tagRightTop"></span>
              </div>
              <div
                class="profile-tag"
                onclick="openTagEditModal('rightBottom')"
              >
                <span class="profile-tag-text" id="tagRightBottom"></span>
              </div>
            </div>
          </div>

          <!-- 隐藏的旧profile-info，保持数据兼容 -->
          <div class="profile-info" style="display: none">
            <div class="profile-name" id="profileName">用户名</div>
            <div class="profile-handle" id="profileHandle">@YourHandle</div>
            <div class="profile-bio" id="profileBio">
              点击编辑你的个性签名 ★
            </div>
          </div>
        </div>

        <!-- Apps -->
        <div class="apps-section">
          <div class="apps-grid">
            <!-- 恋爱纪念日小组件 (2x2) -->
            <div
              class="love-widget widget-2x2"
              id="loveWidget"
              onclick="handleLoveWidgetClick(event)"
            >
              <div class="love-widget-bg" id="loveWidgetBg"></div>
              <div
                class="love-days-row"
                onclick="openLoveEditModal('startDate')"
              >
                <span class="love-days-number" id="loveDaysNumber">0</span>
                <span class="love-days-unit">天</span>
              </div>

              <div class="love-avatars-row">
                <div
                  class="love-avatar"
                  onclick="document.getElementById('loveAvatar1Input').click()"
                >
                  <img
                    class="love-avatar-placeholder-img"
                    id="loveAvatar1Placeholder"
                    src="https://www.yn12377.cn/jubao/upload/smjb/2025/12/28/b7957012b29e42bdbf237cb27f46bb91.jpg"
                  />
                  <img id="loveAvatar1Img" src="" style="display: none" />
                </div>
                <div
                  class="love-avatar"
                  onclick="document.getElementById('loveAvatar2Input').click()"
                >
                  <img
                    class="love-avatar-placeholder-img"
                    id="loveAvatar2Placeholder"
                    src="https://www.yn12377.cn/jubao/upload/smjb/2025/12/28/b7957012b29e42bdbf237cb27f46bb91.jpg"
                  />
                  <img id="loveAvatar2Img" src="" style="display: none" />
                </div>
              </div>
              <input
                type="file"
                id="loveAvatar1Input"
                class="hidden-input"
                accept="image/*"
                onchange="handleLoveAvatarUpload(1, this)"
              />
              <input
                type="file"
                id="loveAvatar2Input"
                class="hidden-input"
                accept="image/*"
                onchange="handleLoveAvatarUpload(2, this)"
              />
              <input
                type="file"
                id="loveWidgetBgInput"
                class="hidden-input"
                accept="image/*"
                onchange="handleLoveWidgetBgUpload(this)"
              />

              <div class="love-title-row" onclick="openLoveEditModal('title')">
                <span class="love-title-text" id="loveTitleText">恋爱纪念</span>
              </div>

              <div
                class="love-date"
                id="loveDateText"
                onclick="openLoveEditModal('startDate')"
              >
                2024.01.01
              </div>
            </div>

            <!-- App图标 -->
            <div class="app-item" onclick="openPage('chatPage')">
              <div class="app-icon gradient-pink">聊天</div>
              <span class="app-name">聊天</span>
            </div>
            <div class="app-item" onclick="openPage('worldbookPage')">
              <div class="app-icon gradient-green">世界书</div>
              <span class="app-name">世界书</span>
            </div>
            <div class="app-item" onclick="openPage('presetPage')">
              <div class="app-icon gradient-orange">预设</div>
              <span class="app-name">预设</span>
            </div>
            <div class="app-item" onclick="openPage('forumPage')">
              <div class="app-icon gradient-purple">论坛</div>
              <span class="app-name">论坛</span>
            </div>
            <div class="app-item" onclick="openPage('coupleSpacePage')">
              <div class="app-icon gradient-pink">情侣</div>
              <span class="app-name">情侣空间</span>
            </div>
            <div class="app-item" onclick="openPage('companionPage')">
              <div class="app-icon gradient-blue">陪伴</div>
              <span class="app-name">陪伴</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Pages -->
      <div id="chatPage" class="page chat-app">
        <!-- Chat App Header -->
        <div class="chat-header">
          <button class="back-btn" onclick="closePage('chatPage')">←</button>
          <h1 class="chat-title" id="chatAppTitle">Message</h1>
          <div class="chat-header-btns">
            <button
              class="chat-header-btn"
              id="createGroupBtn"
              onclick="openCreateGroupModal()"
              title="创建群聊"
            >
              <svg
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
            </button>
            <button
              class="chat-header-btn"
              id="chatHeaderBtn"
              onclick="handleHeaderBtn()"
            >
              +
            </button>
          </div>
        </div>

        <!-- Chat App Content -->
        <div class="chat-content">
          <!-- Messages Tab -->
          <div class="chat-tab-content active" id="messagesTab">
            <!-- Search bar -->
            <div class="search-bar">
              <span class="search-icon"
                ><svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <circle cx="11" cy="11" r="8"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg
              ></span>
              <input
                type="text"
                placeholder="搜索聊天记录"
                class="search-input"
                id="chatSearchInput"
                oninput="searchChatHistory(this.value)"
              />
            </div>

            <!-- 搜索结果 -->
            <div class="search-results" id="searchResults"></div>

            <!-- Message List -->
            <div class="message-list" id="messageList">
              <!-- Empty state -->
              <div class="empty-state" id="emptyMessages">
                <div class="empty-icon">
                  <svg
                    width="48"
                    height="48"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path
                      d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                    ></path>
                  </svg>
                </div>
                <div class="empty-text">还没有消息哦</div>
                <div class="empty-hint">添加AI角色开始聊天吧～</div>
              </div>
            </div>
          </div>

          <!-- Moments Tab (Instagram风格动态) -->
          <div class="chat-tab-content" id="momentsTab">
            <!-- Stories区域 -->
            <div class="ig-stories">
              <div class="ig-stories-inner" id="igStoriesContainer">
                <!-- 我的Story -->
                <div class="ig-story-item" onclick="openPostModal()">
                  <div class="ig-story-ring my-story">
                    <div class="ig-story-avatar" id="myStoryAvatar">
                      <span class="ig-story-avatar-emoji"
                        ><svg
                          width="20"
                          height="20"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="#f48fb1"
                          stroke-width="1.8"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <path
                            d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"
                          ></path>
                          <circle cx="12" cy="7" r="4"></circle></svg
                      ></span>
                    </div>
                    <div class="ig-story-add">+</div>
                  </div>
                  <span class="ig-story-name">你的动态</span>
                </div>
                <!-- AI角色的Stories会动态渲染 -->
              </div>
            </div>

            <!-- 动态列表 -->
            <div class="ig-feed" id="igFeed">
              <div class="ig-empty-state" id="igEmptyState">
                <div class="ig-empty-icon">
                  <svg
                    width="48"
                    height="48"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <rect
                      x="3"
                      y="3"
                      width="18"
                      height="18"
                      rx="2"
                      ry="2"
                    ></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline>
                  </svg>
                </div>
                <div class="ig-empty-title">分享你的精彩瞬间</div>
                <div class="ig-empty-text">点击右下角按钮发布第一条动态吧~</div>
              </div>
            </div>

            <!-- 发布按钮 -->
            <button class="ig-fab" onclick="openPostModal()">
              <span class="ig-fab-icon">+</span>
            </button>
          </div>

          <!-- 发布动态弹窗 -->
          <div
            class="ig-post-modal"
            id="igPostModal"
            onclick="if(event.target===this)closePostModal()"
          >
            <div class="ig-post-modal-content">
              <div class="ig-modal-header">
                <button class="ig-modal-close" onclick="closePostModal()">
                  取消
                </button>
                <span class="ig-modal-title">新动态</span>
                <button
                  class="ig-modal-submit"
                  id="igPostSubmit"
                  onclick="submitPost()"
                  disabled
                >
                  发布
                </button>
              </div>
              <div class="ig-modal-body">
                <textarea
                  class="ig-post-textarea"
                  id="igPostText"
                  placeholder="分享你的想法..."
                  oninput="checkPostValid()"
                ></textarea>
                <div class="ig-image-options">
                  <div
                    class="ig-image-option"
                    onclick="selectImageOption('album')"
                    id="imgOptionAlbum"
                  >
                    <span class="ig-image-option-icon"
                      ><svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <rect
                          x="3"
                          y="3"
                          width="18"
                          height="18"
                          rx="2"
                          ry="2"
                        ></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline></svg
                    ></span>
                    <span class="ig-image-option-text">从相册选择</span>
                  </div>
                  <div
                    class="ig-image-option"
                    onclick="selectImageOption('text')"
                    id="imgOptionText"
                  >
                    <span class="ig-image-option-icon"
                      ><svg
                        width="20"
                        height="20"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                        <path
                          d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"
                        ></path>
                        <path d="M2 2l7.586 7.586"></path>
                        <circle cx="11" cy="11" r="2"></circle></svg
                    ></span>
                    <span class="ig-image-option-text">文字配图</span>
                  </div>
                </div>
                <input
                  type="file"
                  id="igImageInput"
                  accept="image/*"
                  style="display: none"
                  onchange="handleImageSelect(event)"
                />
                <input
                  type="text"
                  class="ig-text-img-input"
                  id="igTextImgInput"
                  placeholder="输入图片描述，AI将看到这个描述..."
                  oninput="checkPostValid()"
                />
                <div class="ig-image-preview" id="igImagePreview">
                  <img id="igPreviewImg" src="" alt="" />
                  <span class="ig-image-preview-remove" onclick="removeImage()"
                    ><svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    移除图片</span
                  >
                </div>

                <!-- 可见范围选择 -->
                <div class="ig-visibility-section">
                  <div class="ig-visibility-label">
                    <svg
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                      ></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    谁可以看
                  </div>
                  <div class="ig-visibility-options" id="visibilityOptions">
                    <div
                      class="ig-visibility-option selected"
                      data-value="all"
                      onclick="selectVisibility('all', this)"
                    >
                      <span class="check-icon">✓</span> 公开
                    </div>
                    <!-- 分组选项会通过JS动态渲染 -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 个人资料编辑弹窗 -->
          <div
            class="ig-profile-modal"
            id="igProfileModal"
            onclick="if(event.target===this)closeProfileModal()"
          >
            <div class="ig-profile-modal-content">
              <div class="ig-profile-modal-header">
                <span class="ig-profile-modal-title">编辑个人资料</span>
                <button
                  class="ig-profile-modal-close"
                  onclick="closeProfileModal()"
                >
                  ✕
                </button>
              </div>
              <div class="ig-profile-modal-body">
                <div class="ig-profile-avatar-edit">
                  <div class="ig-profile-avatar-preview" id="igAvatarPreview">
                    A
                  </div>
                  <div class="ig-profile-avatar-btns">
                    <button
                      class="ig-profile-avatar-btn"
                      onclick="document.getElementById('igAvatarInput').click()"
                    >
                      上传照片
                    </button>
                    <button
                      class="ig-profile-avatar-btn"
                      onclick="openEmojiPicker()"
                    >
                      选择表情
                    </button>
                  </div>
                  <input
                    type="file"
                    id="igAvatarInput"
                    accept="image/*"
                    style="display: none"
                    onchange="handleAvatarSelect(event)"
                  />
                </div>
                <div class="ig-profile-form-group">
                  <label class="ig-profile-form-label">昵称</label>
                  <input
                    type="text"
                    class="ig-profile-form-input"
                    id="igEditName"
                    placeholder="输入你的昵称"
                  />
                </div>
                <div class="ig-profile-form-group">
                  <label class="ig-profile-form-label">用户名</label>
                  <input
                    type="text"
                    class="ig-profile-form-input"
                    id="igEditHandle"
                    placeholder="@username"
                  />
                </div>
                <div class="ig-profile-form-group">
                  <label class="ig-profile-form-label">个性签名</label>
                  <textarea
                    class="ig-profile-form-textarea"
                    id="igEditBio"
                    placeholder="写点什么介绍一下自己吧~"
                  ></textarea>
                </div>
                <button class="ig-profile-save-btn" onclick="saveProfile()">
                  保存
                </button>
              </div>
            </div>
          </div>

          <!-- 评论弹窗 -->
          <div
            class="ig-comments-modal"
            id="igCommentsModal"
            onclick="if(event.target===this)closeCommentsModal()"
          >
            <div class="ig-comments-modal-content">
              <div class="ig-comments-header">
                <span class="ig-comments-title">评论</span>
                <button
                  class="ig-comments-close"
                  onclick="closeCommentsModal()"
                >
                  ✕
                </button>
              </div>
              <div class="ig-comments-list" id="igCommentsList">
                <!-- 评论会动态渲染 -->
              </div>
              <div class="ig-comments-input-area">
                <input
                  type="text"
                  class="ig-comments-input"
                  id="igCommentInput"
                  placeholder="添加评论..."
                />
                <button class="ig-comments-send" onclick="sendComment()">
                  发送
                </button>
              </div>
            </div>
          </div>

          <!-- 转发选择弹窗 -->
          <div
            class="ig-share-modal"
            id="igShareModal"
            onclick="if(event.target===this)closeShareModal()"
          >
            <div class="ig-share-modal-content">
              <div class="ig-share-header">
                <span class="ig-share-title">转发给</span>
                <button class="ig-share-close" onclick="closeShareModal()">
                  ✕
                </button>
              </div>
              <div class="ig-share-list" id="igShareList">
                <!-- 角色列表会动态渲染 -->
              </div>
            </div>
          </div>

          <!-- 动态操作菜单 -->
          <div
            class="ig-post-menu"
            id="igPostMenu"
            onclick="if(event.target===this)closePostMenu()"
          >
            <div class="ig-post-menu-content">
              <div class="ig-post-menu-item" onclick="deletePost()">
                <span class="ig-post-menu-icon"
                  ><svg
                    width="18"
                    height="18"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path
                      d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                    ></path></svg
                ></span>
                <span>删除动态</span>
              </div>
              <div class="ig-post-menu-cancel" onclick="closePostMenu()">
                取消
              </div>
            </div>
          </div>

          <!-- Todo Tab - 超可爱小夹板设计 -->
          <div class="chat-tab-content" id="todoTab">
            <!-- 可爱标题 -->
            <div class="todo-cute-title">
              <div class="todo-cute-title-text" id="todoTitleText">
                我的小本本
              </div>
            </div>

            <div class="clipboard-container">
              <!-- 夹子 -->
              <div class="clipboard-clip"></div>
              <!-- 木板 -->
              <div class="clipboard-board">
                <!-- 纸张 -->
                <div class="clipboard-paper">
                  <!-- 顶部区域 -->
                  <div class="todo-top-section">
                    <div class="todo-date-box">
                      <div class="todo-date-day" id="todoDateDay">24</div>
                      <div class="todo-date-month" id="todoDateMonth">12月</div>
                      <div class="todo-date-weekday" id="todoDateWeekday">
                        周二
                      </div>
                    </div>
                    <div class="todo-greeting-box">
                      <div class="todo-greeting-text" id="todoGreeting">
                        今天也要加油鸭！
                      </div>
                      <div class="todo-greeting-sub" id="todoGreetingSub">
                        新的一天，新的开始~
                      </div>
                    </div>
                  </div>

                  <!-- 统计卡片 -->
                  <div class="todo-stats-row">
                    <div class="todo-stat-card">
                      <div class="todo-stat-num" id="todoStatTotal">0</div>
                      <div class="todo-stat-label">全部</div>
                    </div>
                    <div class="todo-stat-card">
                      <div class="todo-stat-num" id="todoStatDone">0</div>
                      <div class="todo-stat-label">完成</div>
                    </div>
                    <div class="todo-stat-card">
                      <div class="todo-stat-num" id="todoStatPending">0</div>
                      <div class="todo-stat-label">待办</div>
                    </div>
                  </div>

                  <!-- 分类筛选 - 动态渲染 -->
                  <div class="todo-filter-bar" id="todoFilterBar">
                    <!-- 动态渲染 -->
                  </div>

                  <!-- 待办列表 -->
                  <div class="todo-list-container" id="todoListContainer">
                    <!-- 动态渲染 -->
                  </div>

                  <!-- 添加按钮 -->
                  <button class="todo-add-btn" onclick="openTodoModal()">
                    <span
                      ><svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                      >
                        <path d="M12 20h9"></path>
                        <path
                          d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
                        ></path></svg
                    ></span>
                    添加新待办
                  </button>

                  <!-- 监督区域 -->
                  <div class="todo-ai-section">
                    <div class="todo-ai-header">
                      <div class="todo-ai-icon">
                        <svg
                          width="22"
                          height="22"
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="#e91e63"
                          stroke-width="1.8"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        >
                          <path
                            d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
                          ></path>
                        </svg>
                      </div>
                      <div>
                        <div class="todo-ai-title">督促小助手</div>
                        <div class="todo-ai-subtitle">选择谁来陪伴督促你~</div>
                      </div>
                    </div>
                    <div class="todo-ai-char-list" id="todoAiCharList">
                      <!-- 动态渲染角色列表 -->
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 经期记录系统 -->
            <div class="period-tracker-section">
              <div class="period-card">
                <div class="period-header">
                  <div class="period-icon">
                    <svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="#f48fb1"
                      stroke-width="1.8"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <circle cx="12" cy="12" r="10"></circle>
                      <path d="M12 6v6l4 2"></path>
                    </svg>
                  </div>
                  <div class="period-title-area">
                    <div class="period-title">生理期记录</div>
                    <div class="period-subtitle">记录周期，TA们会更懂你~</div>
                  </div>
                </div>

                <!-- 状态显示 -->
                <div class="period-status">
                  <div class="period-status-row">
                    <span class="period-status-label">当前状态</span>
                    <span class="period-status-value" id="periodStatusText"
                      >点击设置开始记录</span
                    >
                  </div>
                  <div class="period-status-row">
                    <span class="period-status-label">距离下次</span>
                    <span class="period-status-value safe" id="periodNextText"
                      >--</span
                    >
                  </div>
                  <div class="period-progress">
                    <div class="period-progress-bar">
                      <div
                        class="period-progress-fill"
                        id="periodProgressFill"
                        style="width: 0%"
                      ></div>
                    </div>
                    <div class="period-progress-labels">
                      <span>周期开始</span>
                      <span id="periodCycleDay">第 - 天</span>
                      <span>下次经期</span>
                    </div>
                  </div>
                </div>

                <!-- 简易日历 -->
                <div class="period-calendar" id="periodCalendar">
                  <div class="period-cal-header">日</div>
                  <div class="period-cal-header">一</div>
                  <div class="period-cal-header">二</div>
                  <div class="period-cal-header">三</div>
                  <div class="period-cal-header">四</div>
                  <div class="period-cal-header">五</div>
                  <div class="period-cal-header">六</div>
                  <!-- 日期动态渲染 -->
                </div>

                <!-- 小贴士 -->
                <div class="period-tips">
                  <div class="period-tips-title">
                    <svg
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      style="vertical-align: middle; margin-right: 4px"
                    >
                      <circle cx="12" cy="12" r="10"></circle>
                      <line x1="12" y1="16" x2="12" y2="12"></line>
                      <line x1="12" y1="8" x2="12.01" y2="8"></line></svg
                    >温馨提示
                  </div>
                  <div class="period-tips-content" id="periodTipsContent">
                    设置经期信息后，TA们会在特殊时期给你更多关心和温暖哦~
                  </div>
                </div>

                <!-- 操作按钮 -->
                <div class="period-actions">
                  <button
                    class="period-action-btn secondary"
                    onclick="openPeriodModal()"
                  >
                    <svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      style="vertical-align: middle; margin-right: 2px"
                    >
                      <circle cx="12" cy="12" r="3"></circle>
                      <path
                        d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                      ></path>
                    </svg>
                    设置
                  </button>
                  <button
                    class="period-action-btn primary"
                    onclick="recordPeriodStart()"
                  >
                    <svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      style="vertical-align: middle; margin-right: 2px"
                    >
                      <path d="M12 2v4"></path>
                      <path d="M12 18v4"></path>
                      <path d="M4.93 4.93l2.83 2.83"></path>
                      <path d="M16.24 16.24l2.83 2.83"></path>
                      <path d="M2 12h4"></path>
                      <path d="M18 12h4"></path>
                      <path d="M4.93 19.07l2.83-2.83"></path>
                      <path d="M16.24 7.76l2.83-2.83"></path>
                    </svg>
                    记录来了
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- 添加待办弹窗 -->
          <div
            class="todo-modal-overlay"
            id="todoModalOverlay"
            onclick="if(event.target===this)closeTodoModal()"
          >
            <div class="todo-modal">
              <div class="todo-modal-header">
                <div class="todo-modal-title">
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    style="vertical-align: middle; margin-right: 4px"
                  >
                    <path d="M12 20h9"></path>
                    <path
                      d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
                    ></path></svg
                  >添加待办
                </div>
                <button class="todo-modal-close" onclick="closeTodoModal()">
                  ✕
                </button>
              </div>
              <div class="todo-modal-body">
                <div class="todo-input-group">
                  <label class="todo-input-label">待办内容</label>
                  <input
                    type="text"
                    class="todo-input"
                    id="todoInputText"
                    placeholder="今天要做什么呢？"
                    maxlength="100"
                  />
                </div>
                <div class="todo-input-group">
                  <label class="todo-input-label">选择分类</label>
                  <div class="todo-tag-select" id="todoTagSelect">
                    <!-- 动态渲染 -->
                  </div>
                </div>
              </div>
              <div class="todo-modal-footer">
                <button class="todo-save-btn" onclick="saveTodoItem()">
                  添加待办
                </button>
              </div>
            </div>
          </div>

          <!-- 待办设置弹窗 -->
          <div
            class="todo-modal-overlay"
            id="todoSettingsOverlay"
            onclick="if(event.target===this)closeTodoSettingsModal()"
          >
            <div class="todo-settings-modal">
              <div class="todo-modal-header">
                <div class="todo-modal-title">
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    style="vertical-align: middle; margin-right: 4px"
                  >
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                      d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                    ></path></svg
                  >待办设置
                </div>
                <button
                  class="todo-modal-close"
                  onclick="closeTodoSettingsModal()"
                >
                  ✕
                </button>
              </div>
              <div class="todo-modal-body">
                <!-- 标题设置 -->
                <div class="todo-input-group">
                  <label class="todo-input-label"
                    ><svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      style="vertical-align: middle; margin-right: 4px"
                    >
                      <path d="M12 20h9"></path>
                      <path
                        d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
                      ></path></svg
                    >页面标题</label
                  >
                  <input
                    type="text"
                    class="todo-input"
                    id="todoSettingsTitle"
                    placeholder="我的小本本"
                    maxlength="20"
                  />
                </div>

                <!-- 问候语设置 -->
                <div class="todo-input-group">
                  <label class="todo-input-label"
                    ><svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      style="vertical-align: middle; margin-right: 4px"
                    >
                      <path
                        d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                      ></path></svg
                    >自定义问候语</label
                  >
                  <div class="greeting-preview">
                    <div class="greeting-preview-main" id="greetingPreviewMain">
                      今天也要加油鸭！
                    </div>
                    <div class="greeting-preview-sub" id="greetingPreviewSub">
                      新的一天，新的开始~
                    </div>
                  </div>
                  <div class="greeting-input-row">
                    <input
                      type="text"
                      class="todo-input"
                      id="greetingMainInput"
                      placeholder="主问候语"
                      maxlength="30"
                    />
                  </div>
                  <div class="greeting-input-row">
                    <input
                      type="text"
                      class="todo-input"
                      id="greetingSubInput"
                      placeholder="副标题"
                      maxlength="30"
                    />
                    <button
                      class="todo-add-category-btn"
                      onclick="saveGreeting()"
                    >
                      保存
                    </button>
                  </div>
                </div>

                <!-- 分类管理 -->
                <div class="todo-input-group">
                  <label class="todo-input-label"
                    ><svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      style="vertical-align: middle; margin-right: 4px"
                    >
                      <path
                        d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"
                      ></path>
                      <line x1="7" y1="7" x2="7.01" y2="7"></line></svg
                    >管理分类</label
                  >
                  <div class="todo-category-list" id="todoCategoryList">
                    <!-- 动态渲染 -->
                  </div>
                  <div class="todo-add-category-row">
                    <input
                      type="text"
                      class="todo-add-category-input"
                      id="newCategoryEmoji"
                      placeholder="emoji"
                      maxlength="2"
                      style="width: 60px; flex: none"
                    />
                    <input
                      type="text"
                      class="todo-add-category-input"
                      id="newCategoryName"
                      placeholder="分类名称"
                      maxlength="10"
                    />
                    <button
                      class="todo-add-category-btn"
                      onclick="addTodoCategory()"
                    >
                      添加
                    </button>
                  </div>
                </div>
              </div>
              <div class="todo-modal-footer">
                <button class="todo-save-btn" onclick="saveTodoSettings()">
                  保存设置
                </button>
              </div>
            </div>
          </div>

          <!-- 经期设置弹窗 -->
          <div
            class="period-modal-overlay"
            id="periodModalOverlay"
            onclick="if(event.target===this)closePeriodModal()"
          >
            <div class="period-modal">
              <div class="period-modal-header">
                <div class="period-modal-title">
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    style="vertical-align: middle; margin-right: 4px"
                  >
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M12 6v6l4 2"></path></svg
                  >经期设置
                </div>
                <button class="period-modal-close" onclick="closePeriodModal()">
                  ✕
                </button>
              </div>
              <div class="period-modal-body">
                <div class="period-input-group">
                  <label class="period-input-label"
                    ><svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      style="vertical-align: middle; margin-right: 4px"
                    >
                      <rect
                        x="3"
                        y="4"
                        width="18"
                        height="18"
                        rx="2"
                        ry="2"
                      ></rect>
                      <line x1="16" y1="2" x2="16" y2="6"></line>
                      <line x1="8" y1="2" x2="8" y2="6"></line>
                      <line x1="3" y1="10" x2="21" y2="10"></line></svg
                    >上次经期开始日期</label
                  >
                  <input type="date" class="period-input" id="periodLastDate" />
                  <div class="period-hint">选择你上次月经第一天的日期</div>
                </div>
                <div class="period-input-group">
                  <label class="period-input-label"
                    ><svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      style="vertical-align: middle; margin-right: 4px"
                    >
                      <polyline points="23 4 23 10 17 10"></polyline>
                      <polyline points="1 20 1 14 7 14"></polyline>
                      <path
                        d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
                      ></path></svg
                    >平均周期天数</label
                  >
                  <input
                    type="number"
                    class="period-input"
                    id="periodCycleLength"
                    value="28"
                    min="21"
                    max="45"
                  />
                  <div class="period-hint">一般为21-35天，平均28天</div>
                </div>
                <div class="period-input-group">
                  <label class="period-input-label"
                    ><svg
                      width="14"
                      height="14"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      style="vertical-align: middle; margin-right: 4px"
                    >
                      <circle cx="12" cy="12" r="10"></circle>
                      <polyline points="12 6 12 12 16 14"></polyline></svg
                    >平均经期天数</label
                  >
                  <input
                    type="number"
                    class="period-input"
                    id="periodDuration"
                    value="5"
                    min="2"
                    max="10"
                  />
                  <div class="period-hint">一般为3-7天</div>
                </div>
              </div>
              <div class="period-modal-footer">
                <button class="period-save-btn" onclick="savePeriodSettings()">
                  保存设置
                </button>
              </div>
            </div>
          </div>

          <!-- Profile Tab (我的) -->
          <div class="chat-tab-content" id="profileTab">
            <!-- Profile Header -->
            <div class="profile-header-card">
              <div class="profile-main">
                <div class="profile-avatar-large">
                  <svg
                    width="32"
                    height="32"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="#f48fb1"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                  </svg>
                </div>
                <div class="profile-info-main">
                  <div class="profile-name-large">我的昵称</div>
                  <div class="profile-id">SillyTavern ID: ST_12345</div>
                </div>
                <div class="profile-arrow">›</div>
              </div>
            </div>

            <!-- Profile Menu -->
            <div class="profile-menu">
              <div class="menu-item" onclick="openWalletPage()">
                <span class="menu-icon"
                  ><svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <rect
                      x="1"
                      y="4"
                      width="22"
                      height="16"
                      rx="2"
                      ry="2"
                    ></rect>
                    <line x1="1" y1="10" x2="23" y2="10"></line></svg
                ></span>
                <span class="menu-text">我的钱包</span>
                <span class="menu-arrow">›</span>
              </div>
              <div class="menu-item">
                <span class="menu-icon"
                  ><svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <polygon
                      points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"
                    ></polygon></svg
                ></span>
                <span class="menu-text">我的收藏</span>
                <span class="menu-arrow">›</span>
              </div>
              <div class="menu-item">
                <span class="menu-icon"
                  ><svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <rect
                      x="3"
                      y="3"
                      width="18"
                      height="18"
                      rx="2"
                      ry="2"
                    ></rect>
                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                    <polyline points="21 15 16 10 5 21"></polyline></svg
                ></span>
                <span class="menu-text">我的相册</span>
                <span class="menu-arrow">›</span>
              </div>
              <div class="menu-item">
                <span class="menu-icon"
                  ><svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <rect x="3" y="3" width="18" height="18" rx="2"></rect>
                    <path d="M3 9h18"></path>
                    <path d="M9 21V9"></path></svg
                ></span>
                <span class="menu-text">我的卡片</span>
                <span class="menu-arrow">›</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat App Bottom Tab Bar -->
        <div class="chat-tab-bar">
          <div class="chat-tab active" onclick="switchChatTab('messages')">
            <span class="tab-icon"
              ><svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                ></path></svg
            ></span>
            <span class="tab-badge" id="messagesBadge" style="display: none"
              >0</span
            >
            <span class="tab-label">Message</span>
          </div>
          <div class="chat-tab" onclick="switchChatTab('moments')">
            <span class="tab-icon"
              ><svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                <line x1="15" y1="9" x2="15.01" y2="9"></line></svg
            ></span>
            <span class="tab-badge" id="momentsBadge" style="display: none"
              >0</span
            >
            <span class="tab-label">Moment</span>
          </div>
          <div class="chat-tab" onclick="switchChatTab('todo')">
            <span class="tab-icon"
              ><svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M9 11l3 3L22 4"></path>
                <path
                  d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"
                ></path></svg
            ></span>
            <span class="tab-label">To Do</span>
          </div>
          <div class="chat-tab" onclick="switchChatTab('profile')">
            <span class="tab-icon"
              ><svg
                width="22"
                height="22"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.8"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle></svg
            ></span>
            <span class="tab-label">Me</span>
          </div>
        </div>
      </div>

      <!-- 预设App页面 -->
      <div id="presetPage" class="page preset-page">
        <div class="preset-header">
          <button class="preset-back-btn" onclick="closePage('presetPage')">
            ←
          </button>
          <span class="preset-title"
            ><svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="vertical-align: middle; margin-right: 4px"
            >
              <path d="M12 20h9"></path>
              <path
                d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"
              ></path></svg
            >预设管理</span
          >
          <div style="display: flex; gap: 8px">
            <button
              class="preset-header-btn"
              onclick="openPresetImportModal()"
              style="background: linear-gradient(135deg, #81d4fa, #4fc3f7)"
            >
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
              </svg>
            </button>
            <button class="preset-header-btn" onclick="openPresetModal()">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
          </div>
        </div>

        <div class="preset-content">
          <div class="preset-tabs">
            <button class="preset-tab active" onclick="switchPresetTab('all')">
              全部
            </button>
            <button class="preset-tab" onclick="switchPresetTab('character')">
              角色
            </button>
            <button class="preset-tab" onclick="switchPresetTab('style')">
              文风
            </button>
            <button class="preset-tab" onclick="switchPresetTab('scene')">
              场景
            </button>
          </div>

          <div class="preset-list" id="presetList">
            <!-- 预设列表将通过JS渲染 -->
          </div>
        </div>

        <!-- 批量操作浮动栏 -->
        <div class="preset-batch-bar" id="presetBatchBar">
          <button class="preset-batch-btn cancel" onclick="cancelPresetBatch()">
            取消
          </button>
          <button
            class="preset-batch-btn delete"
            onclick="deleteSelectedPresets()"
          >
            <svg
              width="14"
              height="14"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="vertical-align: middle; margin-right: 2px"
            >
              <polyline points="3 6 5 6 21 6"></polyline>
              <path
                d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
              ></path>
            </svg>
            删除所选
          </button>
        </div>
      </div>

      <!-- 预设编辑弹窗 -->
      <div class="preset-modal" id="stylePresetModal">
        <div class="preset-modal-content">
          <div class="preset-modal-header">
            <span class="preset-modal-title" id="stylePresetModalTitle"
              >创建预设</span
            >
            <button class="preset-modal-close" onclick="closePresetModal()">
              ✕
            </button>
          </div>
          <div class="preset-modal-body">
            <div class="preset-form-group">
              <label class="preset-form-label">预设名称</label>
              <input
                type="text"
                class="preset-form-input"
                id="stylePresetName"
                placeholder="给预设起个名字..."
              />
            </div>

            <div class="preset-form-group">
              <label class="preset-form-label">分类</label>
              <select class="preset-form-input" id="stylePresetCategory">
                <option value="character">角色预设</option>
                <option value="style">文风预设</option>
                <option value="scene">场景预设</option>
              </select>
            </div>

            <div class="preset-form-group">
              <label class="preset-form-label">图标</label>
              <input
                type="text"
                class="preset-form-input"
                id="stylePresetIcon"
                placeholder="输入一个符号，如 ★"
              />
            </div>

            <div class="preset-form-group">
              <label class="preset-form-label"
                >描述
                <span class="preset-form-hint">(简短说明预设用途)</span></label
              >
              <input
                type="text"
                class="preset-form-input"
                id="stylePresetDesc"
                placeholder="例如：温柔大姐姐文风"
              />
            </div>

            <div class="preset-form-group">
              <label class="preset-form-label">
                预设条目
                <span class="preset-form-hint">(可添加多个条目，分别开关)</span>
              </label>
              <div class="preset-entries-list" id="presetEntriesList">
                <!-- 条目会在这里动态生成 -->
              </div>
              <button class="preset-add-entry-btn" onclick="addPresetEntry()">
                + 添加条目
              </button>
            </div>
          </div>
          <div class="preset-modal-footer">
            <button
              class="preset-modal-btn cancel"
              onclick="closePresetModal()"
            >
              取消
            </button>
            <button class="preset-modal-btn save" onclick="savePreset()">
              保存
            </button>
          </div>
        </div>
      </div>

      <!-- 预设导入弹窗 -->
      <div class="preset-import-modal" id="presetImportModal">
        <div class="preset-import-content">
          <div class="preset-import-title">导入预设</div>
          <div class="preset-import-options">
            <div class="preset-import-option" onclick="importPresetFromFile()">
              <div class="preset-import-option-icon">📁</div>
              <div class="preset-import-option-text">
                <div class="preset-import-option-title">从文件导入</div>
                <div class="preset-import-option-desc">
                  支持JSON格式的预设文件
                </div>
              </div>
            </div>
            <div
              class="preset-import-option"
              onclick="importPresetFromClipboard()"
            >
              <div class="preset-import-option-icon">≡</div>
              <div class="preset-import-option-text">
                <div class="preset-import-option-title">从剪贴板导入</div>
                <div class="preset-import-option-desc">
                  粘贴Silly Tavern预设JSON
                </div>
              </div>
            </div>
          </div>
          <button
            class="preset-import-cancel"
            onclick="closePresetImportModal()"
          >
            取消
          </button>
        </div>
      </div>
      <input
        type="file"
        id="presetFileInput"
        accept=".json"
        style="display: none"
        onchange="handlePresetFileImport(event)"
      />

      <div id="worldbookPage" class="page worldbook-page">
        <!-- 世界书头部 -->
        <div class="worldbook-header">
          <div class="worldbook-header-left">
            <button class="back-btn" onclick="closePage('worldbookPage')">
              ←
            </button>
            <div class="worldbook-title">≡ 世界书</div>
          </div>
          <div class="worldbook-header-actions">
            <button
              class="worldbook-header-btn"
              onclick="openWorldbookGroupManager()"
              title="管理分组"
            >
              📁
            </button>
            <button
              class="worldbook-header-btn"
              onclick="toggleWorldbookBatchMode()"
              title="批量操作"
            >
              ☑️
            </button>
            <button
              class="worldbook-header-btn"
              onclick="openWorldbookModal()"
              title="新建世界书"
            >
              +
            </button>
          </div>
        </div>

        <div class="worldbook-content">
          <!-- 分组标签栏 -->
          <div class="worldbook-tabs" id="worldbookTabs">
            <div
              class="worldbook-tab active"
              data-group="all"
              onclick="filterWorldbookByGroup('all')"
            >
              全部 <span class="worldbook-tab-count" id="wbCountAll">0</span>
            </div>
          </div>

          <!-- 批量操作栏 -->
          <div class="worldbook-batch-bar" id="worldbookBatchBar">
            <div class="worldbook-batch-info">
              已选择 <span id="worldbookSelectedCount">0</span> 项
            </div>
            <div class="worldbook-batch-actions">
              <button
                class="worldbook-batch-btn cancel"
                onclick="cancelWorldbookBatch()"
              >
                取消
              </button>
              <button
                class="worldbook-batch-btn move"
                onclick="openWorldbookMoveModal()"
              >
                📁 移动
              </button>
              <button
                class="worldbook-batch-btn delete"
                onclick="deleteSelectedWorldbooks()"
              >
                ✕ 删除
              </button>
            </div>
          </div>

          <!-- 世界书列表 -->
          <div class="worldbook-list" id="worldbookList">
            <!-- 动态渲染 -->
          </div>

          <!-- 空状态 -->
          <div
            class="worldbook-empty"
            id="worldbookEmpty"
            style="display: none"
          >
            <div class="worldbook-empty-icon">
              <svg
                width="48"
                height="48"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path
                  d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"
                ></path>
              </svg>
            </div>
            <div class="worldbook-empty-title">还没有世界书</div>
            <div class="worldbook-empty-text">
              创建世界书，让AI角色拥有更丰富的背景设定
            </div>
            <button class="worldbook-empty-btn" onclick="openWorldbookModal()">
              <svg
                width="14"
                height="14"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                style="vertical-align: middle; margin-right: 2px"
              >
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              创建第一本世界书
            </button>
          </div>
        </div>
      </div>

      <!-- 世界书编辑弹窗 -->
      <div
        class="worldbook-modal"
        id="worldbookModal"
        onclick="if(event.target===this)closeWorldbookModal()"
      >
        <div class="worldbook-modal-content">
          <div class="worldbook-modal-header">
            <div class="worldbook-modal-title" id="worldbookModalTitle">
              新建世界书
            </div>
            <button
              class="worldbook-modal-close"
              onclick="closeWorldbookModal()"
            >
              ✕
            </button>
          </div>
          <div class="worldbook-modal-body">
            <div class="worldbook-form-group">
              <label class="worldbook-form-label"
                >世界书名称 <span style="color: #f48fb1">*</span></label
              >
              <input
                type="text"
                class="worldbook-form-input"
                id="worldbookNameInput"
                placeholder="例如：现代都市世界观"
              />
            </div>
            <div class="worldbook-form-group">
              <label class="worldbook-form-label">分组</label>
              <select
                class="worldbook-form-input worldbook-form-select"
                id="worldbookGroupSelect"
              >
                <option value="">未分组</option>
              </select>
            </div>
            <div class="worldbook-form-group">
              <label class="worldbook-form-label"
                >描述 <span class="worldbook-form-hint">(选填)</span></label
              >
              <textarea
                class="worldbook-form-input worldbook-form-textarea"
                id="worldbookDescInput"
                placeholder="简要描述这本世界书的内容..."
              ></textarea>
            </div>
            <div class="worldbook-form-group">
              <label class="worldbook-form-label">条目列表</label>
              <div class="worldbook-entries" id="worldbookEntries">
                <!-- 动态渲染条目 -->
              </div>
              <button
                class="worldbook-add-entry-btn"
                onclick="addWorldbookEntry()"
              >
                + 添加新条目
              </button>
            </div>
          </div>
          <div class="worldbook-modal-footer">
            <button
              class="worldbook-modal-btn cancel"
              onclick="closeWorldbookModal()"
            >
              取消
            </button>
            <button class="worldbook-modal-btn save" onclick="saveWorldbook()">
              保存
            </button>
          </div>
        </div>
      </div>

      <!-- 条目编辑弹窗 -->
      <div
        class="worldbook-modal"
        id="worldbookEntryModal"
        onclick="if(event.target===this)closeWorldbookEntryModal()"
      >
        <div class="worldbook-modal-content">
          <div class="worldbook-modal-header">
            <div class="worldbook-modal-title" id="worldbookEntryModalTitle">
              编辑条目
            </div>
            <button
              class="worldbook-modal-close"
              onclick="closeWorldbookEntryModal()"
            >
              ✕
            </button>
          </div>
          <div class="worldbook-modal-body">
            <div class="worldbook-form-group">
              <label class="worldbook-form-label"
                >备注
                <span class="worldbook-form-hint">(选填，便于管理)</span></label
              >
              <input
                type="text"
                class="worldbook-form-input"
                id="entryCommentInput"
                placeholder="例如：关于主角的童年"
              />
            </div>
            <div class="worldbook-form-group">
              <label class="worldbook-form-label"
                >关键词
                <span class="worldbook-form-hint">(用英文逗号分隔)</span></label
              >
              <input
                type="text"
                class="worldbook-form-input"
                id="entryKeywordsInput"
                placeholder="例如：童年, 小时候, 过去"
              />
            </div>
            <div class="worldbook-form-group">
              <label class="worldbook-form-label"
                >内容 <span style="color: #f48fb1">*</span></label
              >
              <textarea
                class="worldbook-form-input worldbook-form-textarea"
                id="entryContentInput"
                placeholder="当聊天中出现关键词时，这段内容会被注入到AI的记忆中..."
                style="min-height: 150px"
              ></textarea>
            </div>
          </div>
          <div class="worldbook-modal-footer">
            <button
              class="worldbook-modal-btn cancel"
              onclick="closeWorldbookEntryModal()"
            >
              取消
            </button>
            <button
              class="worldbook-modal-btn save"
              onclick="saveWorldbookEntry()"
            >
              保存
            </button>
          </div>
        </div>
      </div>

      <!-- 分组管理弹窗 -->
      <div
        class="worldbook-group-modal"
        id="worldbookGroupModal"
        onclick="if(event.target===this)closeWorldbookGroupManager()"
      >
        <div class="worldbook-group-modal-content">
          <div class="worldbook-group-title">📁 管理分组</div>
          <div class="worldbook-group-list" id="worldbookGroupList">
            <!-- 动态渲染 -->
          </div>
          <div class="worldbook-group-add-row">
            <input
              type="text"
              class="worldbook-group-add-input"
              id="worldbookNewGroupInput"
              placeholder="输入新分组名称..."
            />
            <button
              class="worldbook-group-add-btn"
              onclick="addWorldbookGroup()"
            >
              添加
            </button>
          </div>
          <button
            class="worldbook-group-close"
            onclick="closeWorldbookGroupManager()"
          >
            关闭
          </button>
        </div>
      </div>

      <!-- 移动分组弹窗 -->
      <div
        class="worldbook-move-modal"
        id="worldbookMoveModal"
        onclick="if(event.target===this)closeWorldbookMoveModal()"
      >
        <div class="worldbook-move-modal-content">
          <div class="worldbook-move-title">📁 移动到分组</div>
          <div class="worldbook-move-list" id="worldbookMoveList">
            <!-- 动态渲染 -->
          </div>
          <button
            class="worldbook-move-cancel"
            onclick="closeWorldbookMoveModal()"
          >
            取消
          </button>
        </div>
      </div>

      <div id="forumPage" class="page">
        <div class="page-header">
          <button class="back-btn" onclick="closePage('forumPage')">←</button>
          <h1 class="page-title">论坛</h1>
        </div>
        <div class="page-content">论坛功能开发中...</div>
      </div>

      <div id="coupleSpacePage" class="page">
        <div class="page-header">
          <button class="back-btn" onclick="closePage('coupleSpacePage')">
            ←
          </button>
          <h1 class="page-title">情侣空间</h1>
        </div>
        <div class="page-content">情侣空间功能开发中...</div>
      </div>

      <div id="companionPage" class="page">
        <div class="page-header">
          <button class="back-btn" onclick="closePage('companionPage')">
            ←
          </button>
          <h1 class="page-title">陪伴</h1>
        </div>
        <div class="page-content">陪伴功能开发中...</div>
      </div>

      <div id="apiPage" class="page api-settings-page">
        <div class="page-header">
          <button class="back-btn" onclick="closePage('apiPage')">←</button>
          <h1 class="page-title">API设置</h1>
          <button class="page-header-add" onclick="openApiPresetModal()">
            +
          </button>
        </div>

        <div class="api-settings-content">
          <!-- API Presets List -->
          <div class="api-section">
            <div class="api-section-title">API 预设管理</div>
            <div class="api-preset-list" id="apiPresetList">
              <!-- Presets will be rendered here -->
              <div class="empty-state" id="emptyPresets">
                <div class="empty-icon">
                  <svg
                    width="48"
                    height="48"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                    <line x1="12" y1="2" x2="12" y2="12"></line>
                  </svg>
                </div>
                <div class="empty-text">还没有API预设</div>
                <div class="empty-hint">点击右上角 + 创建预设</div>
              </div>
            </div>
          </div>

          <!-- Current Active Config -->
          <div
            class="api-section"
            id="activeConfigSection"
            style="display: none"
          >
            <div class="api-section-title">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                style="vertical-align: middle; margin-right: 4px"
              >
                <polyline points="20 6 9 17 4 12"></polyline></svg
              >当前使用
            </div>
            <div class="active-config-card">
              <div class="active-config-row">
                <span class="active-label">预设名称</span>
                <span class="active-value" id="activePresetName">-</span>
              </div>
              <div class="active-config-row">
                <span class="active-label">模型</span>
                <span class="active-value" id="activeModelName">-</span>
              </div>
              <div class="active-config-row">
                <span class="active-label">状态</span>
                <span class="active-status">已连接</span>
              </div>
            </div>
          </div>
          <div class="api-section">
            <div class="api-section-title">🎙️ 语音设置 (MiniMax)</div>
            <div
              class="active-config-card"
              style="background: #fff; padding: 16px"
            >
              <div class="form-group">
                <label class="form-label">Group ID</label>
                <input
                  type="text"
                  class="form-input"
                  id="voiceGroupId"
                  placeholder="填写 MiniMax Group ID"
                />
              </div>

              <div class="form-group">
                <label class="form-label">API Key</label>
                <input
                  type="password"
                  class="form-input"
                  id="voiceApiKey"
                  placeholder="填写 MiniMax API Key"
                />
              </div>
              <div class="form-group">
                <label class="form-label">API 线路</label>
                <div class="radio-group">
                  <div
                    class="radio-option active"
                    onclick="switchVoiceUrl('cn')"
                    id="voiceUrlCN"
                  >
                    国内版
                  </div>
                  <div
                    class="radio-option"
                    onclick="switchVoiceUrl('intl')"
                    id="voiceUrlIntl"
                  >
                    海外版
                  </div>
                </div>
                <div class="form-hint" style="margin-top: 6px">
                  国内版: api.minimax.chat | 海外版: api.minimaxi.com
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">语音模型</label>
                <div class="form-select-wrapper">
                  <select class="form-select" id="voiceModelSelect">
                    <option value="speech-2.6-hd">
                      speech-2.6-hd (最新·超清)
                    </option>
                    <option value="speech-2.6-turbo">
                      speech-2.6-turbo (最新·极速)
                    </option>

                    <option disabled>──────────</option>

                    <option value="speech-02-hd">speech-02-hd (高清)</option>
                    <option value="speech-02-turbo">
                      speech-02-turbo (快速)
                    </option>
                    <option value="speech-01-turbo">
                      speech-01-turbo (老旧)
                    </option>
                    <option value="speech-01-hd">speech-01-hd (老旧)</option>
                  </select>
                </div>
              </div>

              <button
                class="action-btn"
                onclick="saveVoiceConfig()"
                style="width: 100%; margin-top: 10px"
              >
                💾 保存语音配置
              </button>
            </div>
          </div>
          <!-- Tips -->
          <div class="api-tips">
            <div class="api-tips-title">💡 提示</div>
            <div class="api-tips-content">
              支持 OpenAI 兼容格式的 API。填写反代地址时无需添加 /v1 后缀。
            </div>
          </div>
        </div>
      </div>

      <!-- API Preset Modal -->
      <div class="api-modal" id="apiPresetModal">
        <div class="api-modal-content">
          <div class="api-modal-header">
            <h2 class="api-modal-title" id="apiModalTitle">创建 API 预设</h2>
            <button class="api-modal-close" onclick="closeApiPresetModal()">
              ✕
            </button>
          </div>
          <div class="api-modal-body">
            <div class="api-field">
              <label class="api-field-label">预设名称</label>
              <input
                type="text"
                class="api-field-input"
                id="presetNameInput"
                placeholder="例如: OpenAI, Claude, 自用API"
              />
            </div>

            <div class="api-field">
              <label class="api-field-label">反代地址</label>
              <input
                type="text"
                class="api-field-input"
                id="presetUrlInput"
                placeholder="https://api.example.com"
              />
            </div>

            <div class="api-field">
              <label class="api-field-label">API Key</label>
              <div class="api-field-key">
                <input
                  type="password"
                  class="api-field-input"
                  id="presetKeyInput"
                  placeholder="sk-xxxxxxxxxxxxxxxx"
                />
                <button
                  class="key-toggle-btn"
                  onclick="togglePresetKeyVisibility()"
                >
                  ○
                </button>
              </div>
            </div>

            <div class="api-field">
              <label class="api-field-label">模型</label>
              <div class="model-select-row">
                <input
                  type="text"
                  class="api-field-input model-input"
                  id="presetModelInput"
                  placeholder="输入或拉取模型名称"
                />
                <button class="model-fetch-btn" onclick="fetchPresetModels()">
                  拉取
                </button>
              </div>
              <div class="model-hint">
                可直接输入模型名称，如 gpt-4o、claude-3-5-sonnet 等
              </div>

              <div class="model-dropdown" id="modelDropdown"></div>
            </div>

            <div
              class="api-field"
              style="
                margin-top: 20px;
                padding-top: 20px;
                border-top: 1px dashed #eee;
              "
            >
              <label class="api-field-label">参数微调 (Advanced)</label>

              <div class="slider-row">
                <div style="width: 70px; font-size: 0.85rem; color: #666">
                  温度<br /><span style="font-size: 0.7rem; color: #999"
                    >(随机性)</span
                  >
                </div>
                <input
                  type="range"
                  id="presetTempInput"
                  min="0"
                  max="2"
                  step="0.1"
                  value="1.0"
                  oninput="document.getElementById('valTemp').textContent = this.value"
                />
                <span class="slider-value" id="valTemp">1.0</span>
              </div>

              <div class="slider-row">
                <div style="width: 70px; font-size: 0.85rem; color: #666">
                  频率惩罚<br /><span style="font-size: 0.7rem; color: #999"
                    >(去重)</span
                  >
                </div>
                <input
                  type="range"
                  id="presetFreqInput"
                  min="-2"
                  max="2"
                  step="0.1"
                  value="0"
                  oninput="document.getElementById('valFreq').textContent = this.value"
                />
                <span class="slider-value" id="valFreq">0.0</span>
              </div>

              <div class="slider-row">
                <div style="width: 70px; font-size: 0.85rem; color: #666">
                  存在惩罚<br /><span style="font-size: 0.7rem; color: #999"
                    >(创新)</span
                  >
                </div>
                <input
                  type="range"
                  id="presetPresInput"
                  min="-2"
                  max="2"
                  step="0.1"
                  value="0"
                  oninput="document.getElementById('valPres').textContent = this.value"
                />
                <span class="slider-value" id="valPres">0.0</span>
              </div>
            </div>
          </div>

          <div class="api-modal-footer">
            <button
              class="api-modal-btn btn-delete"
              id="presetDeleteBtn"
              onclick="deleteApiPreset()"
              style="display: none"
            >
              删除
            </button>
            <div class="api-modal-btn-group">
              <button
                class="api-modal-btn btn-cancel"
                onclick="closeApiPresetModal()"
              >
                取消
              </button>
              <button class="api-modal-btn btn-save" onclick="saveApiPreset()">
                保存
              </button>
            </div>
          </div>
        </div>
      </div>

      <div
        id="fontPage"
        class="page chat-settings-page"
        style="background: #f5f5f5"
      >
        <div
          class="page-header"
          style="background: white; border-bottom: 1px solid #eee"
        >
          <button class="back-btn" onclick="closePage('fontPage')">←</button>
          <h1 class="page-title">字体设置</h1>
        </div>

        <div class="settings-content">
          <div class="settings-section">
            <div class="section-header">
              <div class="section-icon purple">🔤</div>
              <span class="section-title">添加新字体</span>
            </div>
            <div class="section-body">
              <div class="form-group">
                <div class="radio-group">
                  <div
                    class="radio-option active"
                    onclick="switchFontSource('url')"
                    id="tabFontUrl"
                  >
                    网络链接
                  </div>
                  <div
                    class="radio-option"
                    onclick="switchFontSource('file')"
                    id="tabFontFile"
                  >
                    本地上传
                  </div>
                </div>
              </div>

              <div id="fontSourceUrl" class="form-group">
                <label class="form-label">字体 URL (.woff2, .ttf)</label>
                <input
                  type="text"
                  class="form-input"
                  id="fontUrlInput"
                  placeholder="https://example.com/font.woff2"
                />
              </div>

              <div id="fontSourceFile" class="form-group" style="display: none">
                <label class="form-label">上传字体文件</label>
                <div
                  class="bg-upload-btn"
                  onclick="document.getElementById('fontFileInput').click()"
                >
                  📂 点击选择字体文件
                </div>
                <input
                  type="file"
                  id="fontFileInput"
                  class="hidden-input"
                  accept=".ttf,.otf,.woff,.woff2"
                  onchange="handleFontFileUpload(this)"
                />
                <div
                  class="form-hint"
                  id="fontFileName"
                  style="margin-top: 8px"
                >
                  未选择文件
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">预设名称</label>
                <input
                  type="text"
                  class="form-input"
                  id="fontNameInput"
                  placeholder="例如: 少女体, 像素风..."
                />
              </div>

              <div class="form-group">
                <label class="form-label">效果预览</label>
                <div
                  id="fontPreviewBox"
                  style="
                    padding: 16px;
                    background: white;
                    border: 1px solid #e5ddd3;
                    border-radius: 12px;
                    font-size: 16px;
                    line-height: 1.6;
                    color: #5d4e37;
                    transition: all 0.3s;
                  "
                >
                  The quick brown fox jumps over the lazy dog.<br />
                  这是一段中文测试文本，用于预览字体效果。<br />
                  1234567890 !@#$%^&*()
                </div>
              </div>

              <div class="action-buttons-grid">
                <button class="action-btn" onclick="previewCustomFont()">
                  ○ 预览
                </button>
                <button
                  class="action-btn"
                  style="
                    background: linear-gradient(135deg, #a18cd1, #fbc2eb);
                    color: white;
                    border: none;
                  "
                  onclick="saveFontPreset()"
                >
                  💾 保存并应用
                </button>
              </div>
            </div>
          </div>

          <div class="settings-section">
            <div class="section-header">
              <div class="section-icon orange">📚</div>
              <span class="section-title">我的字体库</span>
            </div>
            <div class="section-body">
              <div class="api-preset-list" id="fontPresetList">
                <div class="api-preset-item active" onclick="applySystemFont()">
                  <div class="preset-radio" id="radio-system"></div>
                  <div class="preset-info">
                    <div class="preset-name">系统默认</div>
                    <div class="preset-detail">System Default</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="appearancePage" class="page">
        <div class="page-header">
          <button class="back-btn" onclick="closePage('appearancePage')">
            ←
          </button>
          <h1 class="page-title">外观设置</h1>
        </div>
        <div
          class="page-content"
          style="
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
          "
        >
          <!-- 壁纸设置 -->
          <div class="appearance-section">
            <h3>▣ 主屏幕壁纸</h3>
            <div
              class="wallpaper-preview"
              id="wallpaperPreview"
              onclick="document.getElementById('wallpaperInput').click()"
            >
              <div class="wallpaper-placeholder">点击更换壁纸</div>
            </div>
            <input
              type="file"
              id="wallpaperInput"
              accept="image/*"
              style="display: none"
              onchange="previewWallpaper(this)"
            />
            <button class="appearance-btn secondary" onclick="resetWallpaper()">
              恢复默认
            </button>
          </div>

          <!-- 字体颜色设置 -->
          <div class="appearance-section">
            <h3>🎨 字体颜色</h3>
            <div class="color-options">
              <div
                class="color-option"
                style="background: #37474f"
                onclick="setFontColor('#37474f')"
                data-color="#37474f"
              ></div>
              <div
                class="color-option"
                style="background: #ffffff; border: 1px solid #ddd"
                onclick="setFontColor('#ffffff')"
                data-color="#ffffff"
              ></div>
              <div
                class="color-option"
                style="background: #f48fb1"
                onclick="setFontColor('#f48fb1')"
                data-color="#f48fb1"
              ></div>
              <div
                class="color-option"
                style="background: #90caf9"
                onclick="setFontColor('#90caf9')"
                data-color="#90caf9"
              ></div>
              <div
                class="color-option"
                style="background: #a5d6a7"
                onclick="setFontColor('#a5d6a7')"
                data-color="#a5d6a7"
              ></div>
              <div
                class="color-option"
                style="background: #ffcc80"
                onclick="setFontColor('#ffcc80')"
                data-color="#ffcc80"
              ></div>
              <div
                class="color-option custom-color"
                id="customColorOption"
                onclick="openCustomColorPicker()"
              >
                <span>+</span>
              </div>
            </div>
            <input
              type="color"
              id="customColorInput"
              style="
                display: none;
                position: absolute;
                opacity: 0;
                pointer-events: none;
              "
              onchange="applyCustomFontColor(this.value)"
            />
          </div>

          <!-- APP图标和名称设置 -->
          <div class="appearance-section">
            <h3>□ APP自定义</h3>
            <div class="app-customize-list">
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_chat"
                  onclick="document.getElementById('iconInput_chat').click()"
                >
                  聊天
                </div>
                <input
                  type="file"
                  id="iconInput_chat"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('chat', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_chat"
                  value="聊天"
                  placeholder="APP名称"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_worldbook"
                  onclick="document.getElementById('iconInput_worldbook').click()"
                >
                  世界书
                </div>
                <input
                  type="file"
                  id="iconInput_worldbook"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('worldbook', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_worldbook"
                  value="世界书"
                  placeholder="APP名称"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_preset"
                  onclick="document.getElementById('iconInput_preset').click()"
                >
                  预设
                </div>
                <input
                  type="file"
                  id="iconInput_preset"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('preset', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_preset"
                  value="预设"
                  placeholder="APP名称"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_forum"
                  onclick="document.getElementById('iconInput_forum').click()"
                >
                  论坛
                </div>
                <input
                  type="file"
                  id="iconInput_forum"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('forum', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_forum"
                  value="论坛"
                  placeholder="APP名称"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_api"
                  onclick="document.getElementById('iconInput_api').click()"
                >
                  API
                </div>
                <input
                  type="file"
                  id="iconInput_api"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('api', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_api"
                  value="API设置"
                  placeholder="APP名称"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_font"
                  onclick="document.getElementById('iconInput_font').click()"
                >
                  字体
                </div>
                <input
                  type="file"
                  id="iconInput_font"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('font', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_font"
                  value="字体"
                  placeholder="APP名称"
                />
              </div>
              <div class="app-customize-item">
                <div
                  class="app-customize-icon"
                  id="customIcon_appearance"
                  onclick="document.getElementById('iconInput_appearance').click()"
                >
                  外观
                </div>
                <input
                  type="file"
                  id="iconInput_appearance"
                  accept="image/*"
                  style="display: none"
                  onchange="previewAppIcon('appearance', this)"
                />
                <input
                  type="text"
                  class="app-customize-name"
                  id="customName_appearance"
                  value="外观设置"
                  placeholder="APP名称"
                />
              </div>
            </div>
          </div>

          <!-- 保存按钮 -->
          <button
            class="appearance-save-btn"
            onclick="saveAppearanceSettings()"
          >
            ★ 保存设置
          </button>
        </div>
      </div>

      <!-- Bottom Dock -->
      <div class="dock">
        <div class="dock-item" onclick="openPage('apiPage')">
          <div class="dock-icon dock-blue">API设置</div>
          <span class="dock-label">API设置</span>
        </div>
        <div class="dock-item" onclick="openPage('fontPage')">
          <div class="dock-icon dock-purple">字体</div>
          <span class="dock-label">字体</span>
        </div>
        <div class="dock-item" onclick="openPage('appearancePage')">
          <div class="dock-icon dock-orange">外观设置</div>
          <span class="dock-label">外观设置</span>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div class="edit-modal" id="editModal">
      <div class="edit-modal-content">
        <div class="edit-modal-title" id="editModalTitle">编辑</div>
        <input
          type="text"
          class="edit-input"
          id="editInput"
          placeholder="请输入..."
        />
        <div class="edit-buttons">
          <button class="edit-btn edit-btn-cancel" onclick="closeEditModal()">
            取消
          </button>
          <button class="edit-btn edit-btn-save" onclick="saveEdit()">
            保存
          </button>
        </div>
      </div>
    </div>

    <!-- 名片标签编辑弹窗 -->
    <div class="edit-modal" id="tagEditModal">
      <div class="edit-modal-content">
        <div class="edit-modal-title" id="tagEditTitle">编辑标签</div>
        <input
          type="text"
          class="edit-input"
          id="tagEditInput"
          placeholder="请输入..."
          maxlength="10"
        />
        <div class="edit-buttons">
          <button
            class="edit-btn edit-btn-cancel"
            onclick="closeTagEditModal()"
          >
            取消
          </button>
          <button class="edit-btn edit-btn-save" onclick="saveTagEdit()">
            保存
          </button>
        </div>
      </div>
    </div>

    <!-- 恋爱纪念编辑弹窗 -->
    <div class="edit-modal" id="loveEditModal">
      <div class="edit-modal-content">
        <div class="edit-modal-title" id="loveEditTitle">编辑</div>
        <input
          type="text"
          class="edit-input"
          id="loveEditInput"
          placeholder="请输入..."
        />
        <div class="edit-buttons">
          <button
            class="edit-btn edit-btn-cancel"
            onclick="closeLoveEditModal()"
          >
            取消
          </button>
          <button class="edit-btn edit-btn-save" onclick="saveLoveEdit()">
            保存
          </button>
        </div>
      </div>
    </div>

    <!-- 恋爱小组件选项弹窗 -->
    <div class="edit-modal" id="loveWidgetOptionsModal">
      <div class="edit-modal-content" style="padding: 16px">
        <div class="edit-modal-title">小组件设置</div>
        <div class="love-widget-options">
          <div class="love-widget-option" onclick="triggerLoveWidgetBgUpload()">
            <span class="love-widget-option-icon">🖼️</span>
            <span>更换背景图</span>
          </div>
          <div
            class="love-widget-option"
            onclick="setLoveWidgetTextColor('dark')"
          >
            <span class="love-widget-option-icon">⬛</span>
            <span>字体改黑色</span>
          </div>
          <div
            class="love-widget-option"
            onclick="setLoveWidgetTextColor('light')"
          >
            <span class="love-widget-option-icon">⬜</span>
            <span>字体改白色</span>
          </div>
        </div>
        <button
          class="edit-btn edit-btn-cancel"
          style="width: 100%; margin-top: 12px"
          onclick="closeLoveWidgetOptionsModal()"
        >
          取消
        </button>
      </div>
    </div>

    <!-- 分组管理弹窗 -->
    <div class="edit-modal" id="groupManagerModal" style="z-index: 1000">
      <div class="edit-modal-content" style="max-width: 320px">
        <div class="edit-modal-title">管理分组</div>
        <div class="group-list" id="groupList">
          <!-- 动态渲染分组列表 -->
        </div>
        <div class="group-add-row">
          <input
            type="text"
            class="edit-input"
            id="newGroupInput"
            placeholder="输入新分组名称..."
            style="flex: 1; margin-bottom: 0"
          />
          <button
            class="edit-btn edit-btn-save"
            onclick="addNewGroup()"
            style="margin-left: 8px; width: 60px"
          >
            添加
          </button>
        </div>
        <div class="edit-buttons" style="margin-top: 16px">
          <button
            class="edit-btn edit-btn-cancel"
            onclick="closeGroupManager()"
          >
            关闭
          </button>
        </div>
      </div>
    </div>

    <!-- Create Character Modal -->
    <div class="edit-modal" id="createCharModal">
      <div class="create-char-content">
        <div class="create-char-title">创建新角色</div>

        <!-- Avatar upload -->
        <div
          class="create-avatar-section"
          onclick="document.getElementById('charAvatarInput').click()"
        >
          <div class="create-avatar">
            <span class="create-avatar-placeholder" id="charAvatarPlaceholder"
              ><svg
                width="32"
                height="32"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline></svg
            ></span>
            <img id="charAvatarPreview" src="" alt="" style="display: none" />
          </div>
          <span class="create-avatar-hint">点击上传头像</span>
        </div>
        <input
          type="file"
          id="charAvatarInput"
          class="hidden-input"
          accept="image/*"
          onchange="previewCharAvatar(this)"
        />

        <!-- Name input -->
        <div class="create-input-group">
          <label class="create-label"
            >角色名称 <span class="required">*</span></label
          >
          <input
            type="text"
            class="create-input"
            id="charNameInput"
            placeholder="请输入角色名称"
          />
        </div>

        <!-- Note input -->
        <div class="create-input-group">
          <label class="create-label"
            >备注 <span class="optional">(选填)</span></label
          >
          <input
            type="text"
            class="create-input"
            id="charNoteInput"
            placeholder="添加备注信息"
          />
        </div>

        <!-- Buttons -->
        <div class="create-buttons">
          <button
            class="create-btn create-btn-cancel"
            onclick="closeCreateCharModal()"
          >
            取消
          </button>
          <button
            class="create-btn create-btn-confirm"
            onclick="createCharacter()"
          >
            创建
          </button>
        </div>
      </div>
    </div>

    <!-- Create Group Chat Modal -->
    <div
      class="create-group-modal"
      id="createGroupModal"
      onclick="if(event.target===this)closeCreateGroupModal()"
    >
      <div class="create-group-content">
        <div class="create-group-header">
          <span class="create-group-title">创建群聊</span>
          <button class="create-group-close" onclick="closeCreateGroupModal()">
            ✕
          </button>
        </div>
        <div class="create-group-body">
          <!-- 群聊头像 -->
          <div class="create-group-avatar-section">
            <div
              class="create-group-avatar"
              id="groupAvatarPreview"
              onclick="document.getElementById('groupAvatarInput').click()"
            >
              <span id="groupAvatarPlaceholder">👥</span>
              <img id="groupAvatarImg" src="" style="display: none" />
            </div>
            <div class="create-group-avatar-hint">点击上传群头像（可选）</div>
            <input
              type="file"
              id="groupAvatarInput"
              accept="image/*"
              style="display: none"
              onchange="previewGroupAvatar(this)"
            />
          </div>

          <!-- 群聊名称 -->
          <div class="create-group-input-section">
            <label class="create-group-label"
              >群聊名称 <span style="color: #f48fb1">*</span></label
            >
            <input
              type="text"
              class="create-group-input"
              id="groupNameInput"
              placeholder="输入群聊名称..."
              oninput="checkGroupCreateValid()"
            />
          </div>

          <!-- 选择成员 -->
          <div class="create-group-members-title">
            <span>选择群成员</span>
            <span class="create-group-members-count" id="selectedMembersCount"
              >已选 0 人</span
            >
          </div>
          <div class="create-group-members-list" id="groupMembersList">
            <!-- 角色列表会动态渲染 -->
          </div>
        </div>
        <div class="create-group-footer">
          <button
            class="create-group-btn cancel"
            onclick="closeCreateGroupModal()"
          >
            取消
          </button>
          <button
            class="create-group-btn confirm"
            id="createGroupConfirmBtn"
            onclick="createGroupChat()"
            disabled
          >
            创建群聊
          </button>
        </div>
      </div>
    </div>

    <!-- Group Settings Modal (添加群成员) -->
    <div
      class="create-group-modal"
      id="addGroupMemberModal"
      onclick="if(event.target===this)closeAddGroupMemberModal()"
    >
      <div class="create-group-content">
        <div class="create-group-header">
          <span class="create-group-title">添加群成员</span>
          <button
            class="create-group-close"
            onclick="closeAddGroupMemberModal()"
          >
            ✕
          </button>
        </div>
        <div class="create-group-body">
          <div class="create-group-members-title">
            <span>选择要添加的成员</span>
            <span class="create-group-members-count" id="addMembersCount"
              >已选 0 人</span
            >
          </div>
          <div class="create-group-members-list" id="addMembersList">
            <!-- 可添加的角色列表 -->
          </div>
        </div>
        <div class="create-group-footer">
          <button
            class="create-group-btn cancel"
            onclick="closeAddGroupMemberModal()"
          >
            取消
          </button>
          <button
            class="create-group-btn confirm"
            id="addMemberConfirmBtn"
            onclick="confirmAddGroupMembers()"
            disabled
          >
            添加
          </button>
        </div>
      </div>
    </div>

    <!-- 群聊专用设置页面 -->
    <!-- 群成员管理弹窗 -->
    <div
      class="create-group-modal"
      id="groupMemberManagerModal"
      onclick="if(event.target===this)closeGroupMemberManager()"
    >
      <div class="create-group-content">
        <div class="create-group-header">
          <span class="create-group-title">管理群成员</span>
          <button
            class="create-group-close"
            onclick="closeGroupMemberManager()"
          >
            ✕
          </button>
        </div>
        <div class="create-group-body">
          <div class="create-group-members-title">
            <span>群成员列表</span>
            <span class="create-group-members-count" id="manageMembersCount"
              >共 0 人</span
            >
          </div>
          <div class="create-group-members-list" id="manageMembersList">
            <!-- 群成员列表会动态渲染 -->
          </div>
          <div
            style="
              margin-top: 16px;
              padding-top: 16px;
              border-top: 1px dashed rgba(0, 0, 0, 0.1);
            "
          >
            <button
              class="create-group-btn confirm"
              onclick="closeGroupMemberManager();setTimeout(openAddGroupMemberModal, 300);"
              style="width: 100%"
            >
              ➕ 添加新成员
            </button>
          </div>
        </div>
        <div class="create-group-footer">
          <button
            class="create-group-btn cancel"
            onclick="closeGroupMemberManager()"
            style="width: 100%"
          >
            完成
          </button>
        </div>
      </div>
    </div>

    <!-- 群聊专用设置页面 -->
    <div class="chat-settings-page" id="groupChatSettingsPage">
      <div class="settings-header">
        <button class="settings-back-btn" onclick="closeGroupChatSettings()">
          ‹
        </button>
        <div class="settings-header-title">群聊设置</div>
        <button
          class="settings-save-btn"
          onclick="saveGroupChatSettingsAndClose()"
        >
          保存
        </button>
      </div>
      <div class="settings-content" id="groupSettingsContent">
        <!-- 动态生成内容 -->
      </div>
    </div>

    <div class="chat-conversation-page" id="chatConversationPage">
      <div class="conv-header">
        <button class="conv-back-btn" onclick="closeConversation()">‹</button>
        <div class="conv-title-section">
          <div class="conv-avatar" id="convAvatar">AI</div>
          <span class="conv-name" id="convName">角色名称</span>
        </div>
        <button class="conv-menu-btn" onclick="openChatSettings()">
          <span></span>
        </button>
      </div>

      <div class="conv-menu" id="convMenu">
        <div class="conv-menu-item" onclick="clearChatHistory()">
          ✕ 清空聊天记录
        </div>
        <div class="conv-menu-item" onclick="deleteCharacter()">
          ✕ 删除此角色
        </div>
      </div>

      <div class="conv-messages" id="convMessages" onclick="closeChatPanel()">
        <div class="conv-empty">
          <div class="conv-empty-icon">
            <svg
              width="48"
              height="48"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
              ></path>
            </svg>
          </div>
          <div class="conv-empty-text">开始和TA聊天吧～</div>
        </div>
      </div>

      <div class="conv-input-area" id="inputArea">
        <!-- 引用预览区域 -->
        <div class="quote-preview" id="quotePreview" style="display: none">
          <div class="quote-preview-content">
            <div class="quote-preview-sender" id="quotePreviewSender"></div>
            <div class="quote-preview-text" id="quotePreviewText"></div>
          </div>
          <button class="quote-preview-close" onclick="cancelQuote()">✕</button>
        </div>

        <div class="conv-input-bar">
          <button class="tool-btn icon-btn" onclick="toggleChatPanel('plus')">
            +
          </button>

          <div class="conv-input-wrapper">
            <textarea
              class="conv-input"
              id="convInput"
              placeholder="输入消息..."
              rows="1"
              oninput="autoResizeTextarea(this)"
              onfocus="closeChatPanel()"
            ></textarea>
            <button class="emoji-btn-inner" onclick="toggleChatPanel('emoji')">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
              >
                <circle cx="12" cy="12" r="10" />
                <path d="M8 14s1.5 2 4 2 4-2 4-2" />
                <line x1="9" y1="9" x2="9.01" y2="9" />
                <line x1="15" y1="9" x2="15.01" y2="9" />
              </svg>
            </button>
          </div>

          <button class="ai-magic-btn" onclick="requestAIReply()" id="replyBtn">
            ✦
          </button>

          <button class="conv-send-btn" onclick="sendUserMessage()">
            <span>↑</span>
          </button>
        </div>

        <div class="chat-panel" id="plusPanel">
          <div class="panel-grid">
            <div class="panel-item" onclick="rerollAIReply()">
              <div class="panel-icon-box bg-reroll">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <polyline points="23 4 23 10 17 10"></polyline>
                  <polyline points="1 20 1 14 7 14"></polyline>
                  <path
                    d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
                  ></path>
                </svg>
              </div>
              <span class="panel-label">重roll</span>
            </div>
            <div class="panel-item" onclick="openSendImageModal()">
              <div class="panel-icon-box bg-camera">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <circle cx="8.5" cy="8.5" r="1.5"></circle>
                  <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
              </div>
              <span class="panel-label">照片</span>
            </div>
            <div class="panel-item" onclick="startVoiceCall()">
              <div class="panel-icon-box bg-call">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                  ></path>
                </svg>
              </div>
              <span class="panel-label">语音通话</span>
            </div>
            <div class="panel-item" onclick="startVideoCall()">
              <div class="panel-icon-box bg-video">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <polygon points="23 7 16 12 23 17 23 7"></polygon>
                  <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                </svg>
              </div>
              <span class="panel-label">视频通话</span>
            </div>
            <div class="panel-item" onclick="sendFakeLocation()">
              <div class="panel-icon-box bg-location">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path
                    d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"
                  ></path>
                  <circle cx="12" cy="10" r="3"></circle>
                </svg>
              </div>
              <span class="panel-label">位置</span>
            </div>
            <div class="panel-item" onclick="openTransferModal()">
              <div class="panel-icon-box bg-transfer">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <line x1="12" y1="1" x2="12" y2="23"></line>
                  <path
                    d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
                  ></path>
                </svg>
              </div>
              <span class="panel-label">转账</span>
            </div>
            <div class="panel-item" onclick="openReadTogether()">
              <div class="panel-icon-box bg-book">
                <svg
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="1.8"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                >
                  <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                  <path
                    d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"
                  ></path>
                </svg>
              </div>
              <span class="panel-label">一起读书</span>
            </div>
          </div>
          <input
            type="file"
            id="chatImgInput"
            hidden
            accept="image/*"
            onchange="handleChatImageUpload(this)"
          />
        </div>

        <div class="chat-panel" id="emojiPanel">
          <!-- 搜索框 -->
          <div class="sticker-search-bar">
            <input
              type="text"
              class="sticker-search-input"
              id="stickerSearchInput"
              placeholder="搜索表情包..."
              oninput="handleStickerSearch(this.value)"
            />
            <span
              class="sticker-search-clear"
              id="stickerSearchClear"
              onclick="clearStickerSearch()"
              >✕</span
            >
          </div>

          <div class="sticker-category-bar" id="stickerCategoryBar"></div>

          <div class="emoji-grid" id="stickerGrid"></div>

          <input
            type="file"
            id="stickerInput"
            hidden
            accept="image/*,.txt"
            multiple
            onchange="handleStickerImport(this)"
          />
        </div>
      </div>
    </div>

    <!-- 一起读书页面 -->
    <div class="read-together-page" id="readTogetherPage">
      <div class="read-header">
        <button class="read-header-back" onclick="closeReadTogether()">
          ←
        </button>
        <div class="read-header-title">📖 一起读书</div>
        <div style="width: 36px"></div>
      </div>
      <div class="read-content">
        <!-- 我的书架 -->
        <div class="bookshelf-section">
          <div class="bookshelf-title">≡ 我的书架</div>
          <div class="bookshelf-grid" id="bookshelfGrid">
            <!-- 书籍卡片会动态生成 -->
            <div
              class="book-card add-book-card"
              onclick="document.getElementById('bookFileInput').click()"
            >
              <div style="font-size: 32px; margin-bottom: 8px">+</div>
              <div>导入新书</div>
            </div>
          </div>
          <input
            type="file"
            id="bookFileInput"
            hidden
            accept=".txt"
            onchange="handleBookImport(this)"
          />
        </div>

        <!-- 当前阅读 -->
        <div id="currentReadingSection" style="display: none">
          <div class="bookshelf-title">≡ 当前阅读</div>
          <div class="read-book-info">
            <div class="read-book-title">
              <span>≡</span>
              <span id="readBookName">书名</span>
              <span class="read-status-badge" id="readStatusBadge">
                <span>✓</span> 阅读中
              </span>
            </div>
            <div class="read-book-progress" id="readBookProgress">
              进度：第 1 页 / 共 100 页
            </div>
            <div class="read-progress-bar">
              <div
                class="read-progress-fill"
                id="readProgressFill"
                style="width: 0%"
              ></div>
            </div>
          </div>

          <div class="read-current-section">
            <div class="read-section-label">📍 当前页内容</div>
            <div class="read-section-text" id="readSectionText">
              这里显示当前页的内容...
            </div>
            <div class="read-controls">
              <button class="read-ctrl-btn prev" onclick="readPrevSection()">
                ← 上一页
              </button>
              <button class="read-ctrl-btn next" onclick="readNextSection()">
                下一页 →
              </button>
            </div>
          </div>

          <div class="read-settings">
            <div class="read-setting-row">
              <span class="read-setting-label">跳转到第</span>
              <div class="read-setting-value">
                <input
                  type="number"
                  class="read-setting-input"
                  id="readJumpTo"
                  value="1"
                  min="1"
                />
                <span>页</span>
                <button
                  class="read-ctrl-btn next"
                  style="flex: none; padding: 6px 12px"
                  onclick="jumpToSection()"
                >
                  跳转
                </button>
              </div>
            </div>
            <div class="read-setting-row">
              <span class="read-setting-label">开启悬浮窗</span>
              <div class="read-setting-value">
                <button
                  class="read-ctrl-btn next"
                  style="flex: none; padding: 8px 16px"
                  onclick="startFloatingMode()"
                >
                  • 悬浮阅读
                </button>
              </div>
            </div>
            <div class="read-setting-row">
              <button
                class="read-ctrl-btn prev"
                style="width: 100%; background: #fff3e0; color: #ff9800"
                onclick="stopCurrentReading()"
              >
                ⏸️ 暂停阅读（回到书架）
              </button>
            </div>
          </div>
        </div>

        <!-- 导入设置 -->
        <div class="read-settings" style="margin-top: 16px">
          <div class="bookshelf-title" style="margin-bottom: 12px">
            📥 导入设置
          </div>
          <div class="read-setting-row">
            <span class="read-setting-label">每页字数</span>
            <div class="read-setting-value">
              <input
                type="number"
                class="read-setting-input"
                id="readChunkSize"
                value="500"
                min="100"
                max="3000"
                style="width: 70px"
              />
              <span>字</span>
            </div>
          </div>
          <div style="font-size: 0.8rem; color: #888; margin-top: 8px">
            提示：导入新书时生效。字数越少翻页越频繁，字数越多每页内容越长。
          </div>
        </div>

        <!-- 使用说明 -->
        <div class="read-settings" style="margin-top: 16px">
          <div
            class="read-setting-row"
            style="flex-direction: column; align-items: flex-start; gap: 8px"
          >
            <span class="read-setting-label">📖 使用说明</span>
            <div style="font-size: 0.85rem; color: #666; line-height: 1.6">
              1. 设置每页字数，然后导入TXT书籍<br />
              2. 点击书籍卡片开始阅读<br />
              3. 点击「• 悬浮阅读」开启悬浮窗<br />
              4. 悬浮窗可以拖动、缩放，边看书边聊天<br />
              5. AI会根据当前阅读内容与你互动
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 悬浮阅读按钮 -->
    <button
      class="read-floating-btn"
      id="readFloatingBtn"
      onclick="toggleFloatingPanel()"
    >
      ≡
    </button>

    <!-- 悬浮阅读面板 -->
    <div class="read-floating-panel" id="readFloatingPanel">
      <div class="read-float-header" id="floatPanelHeader">
        <span class="read-float-drag-hint">⋮⋮</span>
        <div class="read-float-title" id="floatBookTitle">书名</div>
        <div class="read-float-progress" id="floatProgress">第1页</div>
        <button class="read-float-close" onclick="toggleFloatingPanel()">
          ✕
        </button>
      </div>
      <div class="read-float-content" id="floatContent">当前页内容...</div>
      <div class="read-float-controls">
        <button
          class="read-float-btn"
          onclick="readPrevSection();updateFloatingPanel();"
        >
          ← 上一页
        </button>
        <button
          class="read-float-btn primary"
          onclick="readNextSection();updateFloatingPanel();"
        >
          下一页 →
        </button>
        <button
          class="read-float-btn"
          onclick="openReadTogether();hideFloatingPanel();"
        >
          📖 书架
        </button>
      </div>
      <div class="read-float-resize-handle" id="floatResizeHandle"></div>
    </div>

    <!-- Chat Settings Page -->
    <div class="chat-settings-page" id="chatSettingsPage">
      <div class="settings-header">
        <button class="settings-back-btn" onclick="closeChatSettings()">
          ‹
        </button>
        <div class="settings-header-title">聊天设置</div>
        <button class="settings-save-btn" onclick="saveChatSettingsAndClose()">
          保存
        </button>
      </div>

      <div class="settings-content">
        <!-- Section 1: Basic Info -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon brown">📝</div>
            <span class="section-title">基础资料</span>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label"
                >角色真名 / 群聊名称
                <span class="form-hint">(AI只认这个)</span></label
              >
              <input
                type="text"
                class="form-input"
                id="settingsCharName"
                placeholder="输入角色名称..."
              />
            </div>
            <div class="form-group">
              <label class="form-label"
                >备注名
                <span class="form-hint">(仅显示用，AI不知道)</span></label
              >
              <input
                type="text"
                class="form-input"
                id="settingsCharNote"
                placeholder="输入备注名..."
              />
            </div>
            <div class="form-group">
              <label class="form-label">好友分组</label>
              <div class="form-select-wrapper">
                <select class="form-select" id="settingsGroup">
                  <option value="none">未分组</option>
                </select>
                <button class="form-btn-small" onclick="openGroupManager()">
                  管理
                </button>
              </div>
            </div>

            <!-- 置顶联系人 -->
            <div class="form-group">
              <label class="form-label">聊天列表设置</label>
              <div class="avatar-toggle-group">
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="settingsPinned"
                    onchange="togglePinContact()"
                  />
                  <span class="toggle-label">• 置顶此联系人</span>
                </label>
              </div>
            </div>

            <!-- Avatar Upload -->
            <div class="avatar-upload-row">
              <div class="avatar-upload-col">
                <div class="avatar-upload-label">对方头像</div>
                <div
                  class="avatar-preview"
                  id="settingsOtherAvatar"
                  onclick="document.getElementById('otherAvatarInput').click()"
                >
                  <span id="otherAvatarPlaceholder"
                    ><svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <rect
                        x="3"
                        y="3"
                        width="18"
                        height="18"
                        rx="2"
                        ry="2"
                      ></rect>
                      <circle cx="8.5" cy="8.5" r="1.5"></circle>
                      <polyline points="21 15 16 10 5 21"></polyline></svg
                  ></span>
                  <img id="otherAvatarImg" src="" style="display: none" />
                </div>
                <input
                  type="file"
                  id="otherAvatarInput"
                  class="hidden-input"
                  accept="image/*"
                  onchange="previewSettingsAvatar(this, 'other')"
                />
                <div class="avatar-actions">
                  <button
                    class="avatar-action-btn"
                    onclick="document.getElementById('otherAvatarInput').click()"
                  >
                    上传
                  </button>
                  <button
                    class="avatar-action-btn"
                    onclick="clearSettingsAvatar('other')"
                  >
                    清除
                  </button>
                </div>
              </div>
              <div class="avatar-upload-col">
                <div class="avatar-upload-label">我的头像</div>
                <div
                  class="avatar-preview"
                  id="settingsMyAvatar"
                  onclick="document.getElementById('myAvatarInput').click()"
                >
                  <span id="myAvatarPlaceholder"
                    ><svg
                      width="24"
                      height="24"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="1.5"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <rect
                        x="3"
                        y="3"
                        width="18"
                        height="18"
                        rx="2"
                        ry="2"
                      ></rect>
                      <circle cx="8.5" cy="8.5" r="1.5"></circle>
                      <polyline points="21 15 16 10 5 21"></polyline></svg
                  ></span>
                  <img id="myAvatarImg" src="" style="display: none" />
                </div>
                <input
                  type="file"
                  id="myAvatarInput"
                  class="hidden-input"
                  accept="image/*"
                  onchange="previewSettingsAvatar(this, 'my')"
                />
                <div class="avatar-actions">
                  <button
                    class="avatar-action-btn"
                    onclick="document.getElementById('myAvatarInput').click()"
                  >
                    上传
                  </button>
                  <button
                    class="avatar-action-btn"
                    onclick="clearSettingsAvatar('my')"
                  >
                    清除
                  </button>
                </div>
              </div>
            </div>

            <!-- 头像显示开关 -->
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">头像显示设置</label>
              <div class="avatar-toggle-group">
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="showAiAvatar"
                    checked
                    onchange="toggleAvatarDisplay()"
                  />
                  <span class="toggle-label">显示AI头像</span>
                </label>
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="showUserAvatar"
                    checked
                    onchange="toggleAvatarDisplay()"
                  />
                  <span class="toggle-label">显示我的头像</span>
                </label>
              </div>
            </div>

            <!-- 头像大小调节 -->
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">头像大小</label>
              <div style="display: flex; align-items: center; gap: 12px">
                <input
                  type="range"
                  id="avatarSizeSlider"
                  min="28"
                  max="56"
                  value="40"
                  style="flex: 1; accent-color: #f48fb1"
                  oninput="updateAvatarSizePreview(this.value)"
                  onchange="saveAvatarSize(this.value)"
                />
                <span
                  id="avatarSizeValue"
                  style="
                    min-width: 45px;
                    text-align: center;
                    font-size: 0.9rem;
                    color: #666;
                  "
                  >40px</span
                >
              </div>
            </div>

            <!-- 气泡间距调节 -->
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">气泡间距</label>
              <div style="display: flex; align-items: center; gap: 12px">
                <input
                  type="range"
                  id="bubbleGapSlider"
                  min="2"
                  max="20"
                  value="6"
                  style="flex: 1; accent-color: #f48fb1"
                  oninput="updateBubbleGapPreview(this.value)"
                  onchange="saveBubbleGap(this.value)"
                />
                <span
                  id="bubbleGapValue"
                  style="
                    min-width: 45px;
                    text-align: center;
                    font-size: 0.9rem;
                    color: #666;
                  "
                  >6px</span
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Section 2: AI Brain & Persona -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon purple">🧠</div>
            <span class="section-title">设定</span>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label">对方人设 (Persona)</label>
              <textarea
                class="form-input form-textarea"
                id="settingsPersona"
                placeholder="描述AI角色的性格、背景、说话方式等..."
              ></textarea>
            </div>
            <div class="form-group">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 8px;
                "
              >
                <label class="form-label" style="margin-bottom: 0"
                  >我的人设 (My Persona)</label
                >
                <div style="display: flex; gap: 8px">
                  <select
                    class="form-select"
                    id="userPersonaPresetSelect"
                    style="
                      padding: 6px 24px 6px 12px;
                      font-size: 0.8rem;
                      background-position: right 8px center;
                    "
                  >
                    <option value="">-- 选择预设 --</option>
                  </select>
                  <button
                    class="form-btn-small"
                    onclick="saveUserPersonaPreset()"
                    style="padding: 6px 12px; font-size: 0.8rem"
                  >
                    保存预设
                  </button>
                </div>
              </div>
              <textarea
                class="form-input form-textarea"
                id="settingsMyPersona"
                placeholder="描述你自己的设定，让AI了解你..."
              ></textarea>
            </div>
            <div class="form-group">
              <label class="form-label"
                >关联世界书
                <span class="form-hint">(多选，勾选生效)</span></label
              >
              <div class="worldbook-select-area" id="settingsWorldbookArea">
                <div class="worldbook-select-empty">
                  还没有世界书，去创建一本吧~
                </div>
              </div>
              <input type="hidden" id="settingsWorldbook" value="" />
            </div>
            <div
              class="form-group"
              style="
                margin-top: 18px;
                padding-top: 18px;
                border-top: 1px dashed #eee;
              "
            >
              <label class="form-label">🗣️ 角色音色 (Voice ID)</label>
              <div class="form-select-wrapper">
                <input
                  type="text"
                  class="form-input"
                  id="settingsVoiceId"
                  placeholder="例如: male-qn-qingse (青涩青年)"
                />
                <button class="form-btn-small" onclick="testCharacterVoice()">
                  试听
                </button>
              </div>
              <div class="form-hint">请填写 MiniMax 的音色 ID</div>
            </div>

            <!-- 通话设置 -->
            <div
              class="form-group"
              style="
                margin-top: 18px;
                padding-top: 18px;
                border-top: 1px dashed #eee;
              "
            >
              <label class="form-label"
                ><svg
                  width="14"
                  height="14"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  style="vertical-align: middle; margin-right: 4px"
                >
                  <path
                    d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                  ></path></svg
                >通话设置</label
              >
              <div class="avatar-toggle-group" style="margin-top: 10px">
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="settingsCallVoiceEnabled"
                    onchange="saveCallSettings()"
                  />
                  <span class="toggle-label"
                    >通话接入语音 (使用上方Voice ID)</span
                  >
                </label>
              </div>
              <div class="avatar-toggle-group" style="margin-top: 8px">
                <label class="toggle-item">
                  <input
                    type="checkbox"
                    id="settingsAiCallEnabled"
                    onchange="saveCallSettings()"
                  />
                  <span class="toggle-label">允许TA主动打电话给我</span>
                </label>
              </div>
              <div class="form-hint" style="margin-top: 8px">
                开启语音后，通话中AI的回复将自动朗读
              </div>

              <!-- 视频通话画面设置 -->
              <div
                style="
                  margin-top: 16px;
                  padding-top: 16px;
                  border-top: 1px dashed #f0f0f0;
                "
              >
                <label class="form-label" style="font-size: 0.85rem"
                  ><svg
                    width="14"
                    height="14"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    style="vertical-align: middle; margin-right: 4px"
                  >
                    <polygon points="23 7 16 12 23 17 23 7"></polygon>
                    <rect
                      x="1"
                      y="5"
                      width="15"
                      height="14"
                      rx="2"
                      ry="2"
                    ></rect></svg
                  >视频通话画面</label
                >
                <div class="form-hint" style="margin-bottom: 10px">
                  设置视频通话时对方和自己的画面
                </div>

                <div style="display: flex; gap: 16px; margin-top: 12px">
                  <!-- 对方画面 -->
                  <div style="flex: 1; text-align: center">
                    <div
                      style="font-size: 0.8rem; color: #666; margin-bottom: 6px"
                    >
                      TA的画面
                    </div>
                    <div
                      id="videoCallPartnerPreview"
                      style="
                        width: 80px;
                        height: 110px;
                        border-radius: 8px;
                        background: #f5f5f5;
                        margin: 0 auto;
                        overflow: hidden;
                        cursor: pointer;
                        border: 2px dashed #ddd;
                      "
                      onclick="document.getElementById('videoCallPartnerInput').click()"
                    >
                      <img
                        id="videoCallPartnerImg"
                        src=""
                        style="
                          width: 100%;
                          height: 100%;
                          object-fit: cover;
                          display: none;
                        "
                      />
                      <div
                        id="videoCallPartnerPlaceholder"
                        style="
                          height: 100%;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          color: #999;
                          font-size: 0.7rem;
                        "
                      >
                        点击设置
                      </div>
                    </div>
                    <input
                      type="file"
                      id="videoCallPartnerInput"
                      hidden
                      accept="image/*,video/*"
                      onchange="handleVideoCallImageUpload(this, 'partner')"
                    />
                    <button
                      onclick="clearVideoCallImage('partner')"
                      style="
                        margin-top: 6px;
                        font-size: 0.7rem;
                        padding: 2px 8px;
                        background: #f5f5f5;
                        border: none;
                        border-radius: 4px;
                        color: #999;
                      "
                    >
                      清除
                    </button>
                  </div>

                  <!-- 自己画面 -->
                  <div style="flex: 1; text-align: center">
                    <div
                      style="font-size: 0.8rem; color: #666; margin-bottom: 6px"
                    >
                      我的画面
                    </div>
                    <div
                      id="videoCallSelfPreview"
                      style="
                        width: 80px;
                        height: 110px;
                        border-radius: 8px;
                        background: #f5f5f5;
                        margin: 0 auto;
                        overflow: hidden;
                        cursor: pointer;
                        border: 2px dashed #ddd;
                      "
                      onclick="document.getElementById('videoCallSelfInput').click()"
                    >
                      <img
                        id="videoCallSelfImg"
                        src=""
                        style="
                          width: 100%;
                          height: 100%;
                          object-fit: cover;
                          display: none;
                        "
                      />
                      <div
                        id="videoCallSelfPlaceholder"
                        style="
                          height: 100%;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          color: #999;
                          font-size: 0.7rem;
                        "
                      >
                        点击设置
                      </div>
                    </div>
                    <input
                      type="file"
                      id="videoCallSelfInput"
                      hidden
                      accept="image/*,video/*"
                      onchange="handleVideoCallImageUpload(this, 'self')"
                    />
                    <button
                      onclick="clearVideoCallImage('self')"
                      style="
                        margin-top: 6px;
                        font-size: 0.7rem;
                        padding: 2px 8px;
                        background: #f5f5f5;
                        border: none;
                        border-radius: 4px;
                        color: #999;
                      "
                    >
                      清除
                    </button>
                  </div>
                </div>
              </div>

              <!-- 通话气泡颜色设置 -->
              <div
                style="
                  margin-top: 16px;
                  padding-top: 16px;
                  border-top: 1px dashed #f0f0f0;
                "
              >
                <label class="form-label" style="font-size: 0.85rem"
                  >💬 通话气泡样式</label
                >
                <div class="form-hint" style="margin-bottom: 10px">
                  自定义通话时消息气泡的颜色和透明度
                </div>

                <div
                  style="
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                    margin-top: 12px;
                  "
                >
                  <!-- 用户气泡颜色 -->
                  <div style="display: flex; align-items: center; gap: 10px">
                    <span style="font-size: 0.8rem; color: #666; width: 70px"
                      >我的气泡</span
                    >
                    <input
                      type="color"
                      id="settingsCallUserBubbleColor"
                      value="#f48fb1"
                      style="
                        width: 36px;
                        height: 28px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                      "
                      onchange="previewCallBubbleColor()"
                    />
                    <input
                      type="range"
                      id="settingsCallUserBubbleOpacity"
                      min="30"
                      max="100"
                      value="85"
                      style="flex: 1"
                      oninput="previewCallBubbleColor()"
                    />
                    <span
                      id="callUserOpacityLabel"
                      style="font-size: 0.75rem; color: #999; width: 35px"
                      >85%</span
                    >
                  </div>

                  <!-- AI气泡颜色 -->
                  <div style="display: flex; align-items: center; gap: 10px">
                    <span style="font-size: 0.8rem; color: #666; width: 70px"
                      >TA的气泡</span
                    >
                    <input
                      type="color"
                      id="settingsCallAiBubbleColor"
                      value="#ffffff"
                      style="
                        width: 36px;
                        height: 28px;
                        border: none;
                        border-radius: 4px;
                        cursor: pointer;
                      "
                      onchange="previewCallBubbleColor()"
                    />
                    <input
                      type="range"
                      id="settingsCallAiBubbleOpacity"
                      min="30"
                      max="100"
                      value="85"
                      style="flex: 1"
                      oninput="previewCallBubbleColor()"
                    />
                    <span
                      id="callAiOpacityLabel"
                      style="font-size: 0.75rem; color: #999; width: 35px"
                      >85%</span
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Section 3: Memory Settings -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon teal">💾</div>
            <span class="section-title">记忆与上下文</span>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label"
                >记忆互通 <span class="form-hint">(可多选)</span></label
              >
              <div class="memory-link-dropdown" id="memoryLinkDropdown">
                <div
                  class="memory-link-select"
                  onclick="toggleMemoryLinkDropdown()"
                >
                  <span class="memory-link-text" id="memoryLinkText"
                    >点击选择要互通的角色...</span
                  >
                  <span class="memory-link-arrow">▼</span>
                </div>
                <div class="memory-link-options" id="memoryLinkOptions">
                  <!-- 动态生成 -->
                </div>
              </div>
              <div class="memory-link-tags" id="memoryLinkTags">
                <!-- 已选中的标签 -->
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">互通条数</label>
              <div class="number-input-row">
                <input
                  type="number"
                  class="number-input"
                  id="settingsMemoryCount"
                  value="5"
                  min="1"
                  max="50"
                />
                <span class="form-hint">条最近消息</span>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">上下文记忆条数</label>
              <div class="number-input-row">
                <input
                  type="number"
                  class="number-input"
                  id="settingsContextCount"
                  value="150"
                  min="10"
                  max="500"
                />
                <span class="form-hint">条</span>
              </div>
            </div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 12px;
                padding: 10px 12px;
                background: #faf8f5;
                border-radius: 10px;
              "
            >
              <span style="font-size: 0.82rem; color: #9a8b7a"
                >总消息：<strong id="settingsTotalMsg">0</strong> 条</span
              >
              <span style="font-size: 0.82rem; color: #c4a87c"
                >token：<strong id="settingsTokenCount">0</strong></span
              >
            </div>
          </div>
        </div>

        <!-- Section 4: Play Mode -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon orange">🎮</div>
            <span class="section-title">玩法与模式</span>
          </div>
          <div class="section-body">
            <div class="toggle-row">
              <div>
                <div class="toggle-label">线下模式 (Online Dating)</div>
                <div class="toggle-sublabel">模拟真实约会场景</div>
              </div>
              <label class="toggle-switch">
                <input
                  type="checkbox"
                  id="settingsOnlineDating"
                  onchange="toggleOfflineSettings()"
                />
                <span class="toggle-slider"></span>
              </label>
            </div>

            <!-- 线下模式高级设置 -->
            <div class="offline-word-settings" id="offlineWordSettings">
              <div class="offline-word-title">★ 线下模式设置</div>
              <div class="offline-word-row">
                <span
                  style="font-size: 0.82rem; color: #8d6e63; min-width: 60px"
                  >回复字数</span
                >
                <input
                  type="number"
                  class="offline-word-input"
                  id="offlineMinWords"
                  value="100"
                  min="10"
                  max="5000"
                />
                <span class="offline-word-sep">～</span>
                <input
                  type="number"
                  class="offline-word-input"
                  id="offlineMaxWords"
                  value="500"
                  min="10"
                  max="5000"
                />
                <span class="offline-word-unit">字</span>
              </div>
              <div class="offline-preset-select">
                <label
                  style="
                    font-size: 0.82rem;
                    color: #8d6e63;
                    display: block;
                    margin-bottom: 8px;
                  "
                  >应用预设</label
                >
                <select
                  class="offline-preset-dropdown"
                  id="offlinePresetSelect"
                >
                  <option value="">-- 不使用预设 --</option>
                </select>
              </div>
            </div>

            <div class="toggle-row">
              <div>
                <div class="toggle-label">长期记忆总结</div>
                <div class="toggle-sublabel">自动总结重要对话</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="settingsLongMemory" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">总结模式</label>
              <div class="radio-group">
                <div
                  class="radio-option"
                  data-value="auto"
                  onclick="selectRadio(this, 'summaryMode')"
                >
                  自动总结
                </div>
                <div
                  class="radio-option active"
                  data-value="manual"
                  onclick="selectRadio(this, 'summaryMode')"
                >
                  手动总结
                </div>
              </div>
              <input type="hidden" id="settingsSummaryMode" value="manual" />
            </div>
            <div class="form-group">
              <label class="form-label">触发条数</label>
              <div class="number-input-row">
                <input
                  type="number"
                  class="number-input"
                  id="settingsTriggerCount"
                  value="500"
                  min="50"
                  max="2000"
                />
                <span class="form-hint">条消息后触发总结</span>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">总结提示词</label>
              <textarea
                class="form-input form-textarea"
                id="settingsSummaryPrompt"
                placeholder="请以第三人称的视角，客观、冷静、不带任何感情色彩地总结以下对话的核心事件和信息。禁止进行任何角色扮演或添加主观评论。"
              ></textarea>
            </div>
            <div class="action-buttons-grid" style="margin-top: 12px">
              <button class="action-btn" onclick="viewSummaries()">
                ≡ 查看/管理总结
              </button>
              <button class="action-btn" onclick="triggerManualSummary()">
                ✎ 立即手动总结
              </button>
            </div>
            <div class="toggle-row" style="margin-top: 12px">
              <div>
                <div class="toggle-label">续火花系统</div>
                <div class="toggle-sublabel">保持对话热度</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="settingsFlame" />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="toggle-row">
              <div>
                <div class="toggle-label">实时时间感知</div>
                <div class="toggle-sublabel">AI了解当前时间</div>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="settingsTimeAware" checked />
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>

        <!-- Section 5: Visual Customization -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon blue">🎨</div>
            <span class="section-title">美化</span>
          </div>
          <div class="section-body">
            <div class="form-group">
              <label class="form-label">聊天背景</label>
              <div class="bg-preview-container">
                <div class="bg-preview-phone" id="bgPreview">
                  <span id="bgPreviewPlaceholder">无背景</span>
                  <img id="bgPreviewImg" src="" style="display: none" />
                </div>
                <button
                  class="bg-upload-btn"
                  onclick="document.getElementById('bgUploadInput').click()"
                >
                  ↑ 点击上传背景图片
                </button>
                <input
                  type="file"
                  id="bgUploadInput"
                  class="hidden-input"
                  accept="image/*"
                  onchange="previewBackground(this)"
                />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">字体大小</label>
              <div class="slider-row">
                <span class="slider-value" id="fontSizeValue">14px</span>
                <input
                  type="range"
                  id="settingsFontSize"
                  min="12"
                  max="20"
                  value="14"
                  oninput="updateFontSizePreview(this.value)"
                />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">气泡字体颜色</label>
              <div class="bubble-color-row">
                <div class="bubble-color-item">
                  <span class="bubble-color-label">我的气泡</span>
                  <div class="color-picker-combo">
                    <div class="color-preset-grid" id="userColorGrid">
                      <div
                        class="color-preset"
                        style="background: #c2185b"
                        onclick="setUserBubbleColor('#c2185b')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #e91e63"
                        onclick="setUserBubbleColor('#e91e63')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #ff4081"
                        onclick="setUserBubbleColor('#ff4081')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #f06292"
                        onclick="setUserBubbleColor('#f06292')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #7b1fa2"
                        onclick="setUserBubbleColor('#7b1fa2')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #512da8"
                        onclick="setUserBubbleColor('#512da8')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #1976d2"
                        onclick="setUserBubbleColor('#1976d2')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #0097a7"
                        onclick="setUserBubbleColor('#0097a7')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #388e3c"
                        onclick="setUserBubbleColor('#388e3c')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #f57c00"
                        onclick="setUserBubbleColor('#f57c00')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #5d4037"
                        onclick="setUserBubbleColor('#5d4037')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #37474f"
                        onclick="setUserBubbleColor('#37474f')"
                      ></div>
                    </div>
                    <input
                      type="color"
                      id="settingsUserBubbleColor"
                      value="#c2185b"
                      class="color-picker-input"
                    />
                  </div>
                </div>
                <div class="bubble-color-item">
                  <span class="bubble-color-label">AI气泡</span>
                  <div class="color-picker-combo">
                    <div class="color-preset-grid" id="aiColorGrid">
                      <div
                        class="color-preset"
                        style="background: #37474f"
                        onclick="setAiBubbleColor('#37474f')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #455a64"
                        onclick="setAiBubbleColor('#455a64')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #616161"
                        onclick="setAiBubbleColor('#616161')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #212121"
                        onclick="setAiBubbleColor('#212121')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #5d4037"
                        onclick="setAiBubbleColor('#5d4037')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #4e342e"
                        onclick="setAiBubbleColor('#4e342e')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #1565c0"
                        onclick="setAiBubbleColor('#1565c0')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #00838f"
                        onclick="setAiBubbleColor('#00838f')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #2e7d32"
                        onclick="setAiBubbleColor('#2e7d32')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #ad1457"
                        onclick="setAiBubbleColor('#ad1457')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #6a1b9a"
                        onclick="setAiBubbleColor('#6a1b9a')"
                      ></div>
                      <div
                        class="color-preset"
                        style="background: #000000"
                        onclick="setAiBubbleColor('#000000')"
                      ></div>
                    </div>
                    <input
                      type="color"
                      id="settingsAiBubbleColor"
                      value="#37474f"
                      class="color-picker-input"
                    />
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">气泡样式预设</label>
              <div class="form-select-wrapper">
                <select class="form-select" id="settingsBubbleStyle">
                  <option value="none">-- 无预设 --</option>
                  <option value="simple">简约风格</option>
                  <option value="bubble">气泡风格</option>
                  <option value="modern">现代风格</option>
                  <option value="retro">复古风格</option>
                </select>
                <button class="form-btn-small" onclick="manageBubbleStyles()">
                  管理
                </button>
              </div>
            </div>
            <div class="action-buttons-grid">
              <button class="action-btn" onclick="exportBubbleStyle()">
                ↑ 导出
              </button>
              <button class="action-btn" onclick="importBubbleStyle()">
                ↓ 导入
              </button>
            </div>
            <div class="form-group" style="margin-top: 16px">
              <label class="form-label">自定义CSS</label>
              <button
                class="form-btn-small"
                onclick="resetCustomCSS()"
                style="float: right; margin-top: -28px"
              >
                重置
              </button>
              <div class="css-editor-container">
                <textarea
                  class="css-editor"
                  id="settingsCustomCSS"
                  placeholder="/* 在此输入自定义CSS代码 */"
                ></textarea>
              </div>
            </div>

            <!-- Chat Preview -->
            <div class="chat-preview-container">
              <div class="preview-label">实时预览</div>
              <div class="preview-msg-row">
                <div class="preview-avatar" id="previewOtherAvatar">AI</div>
                <div>
                  <div class="preview-bubble" id="previewOtherBubble">
                    对方消息预览
                  </div>
                  <div class="preview-time">10:00</div>
                </div>
              </div>
              <div class="preview-msg-row right">
                <div class="preview-avatar" id="previewMyAvatar">我</div>
                <div>
                  <div class="preview-bubble" id="previewMyBubble">
                    我的消息预览
                  </div>
                  <div class="preview-time">10:00</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Section 6: Data & Operations -->
        <div class="settings-section">
          <div class="section-header">
            <div class="section-icon brown">💾</div>
            <span class="section-title">数据与操作</span>
          </div>
          <div class="section-body">
            <div class="action-buttons-grid">
              <button class="action-btn" onclick="importChatHistory()">
                📥 导入聊天记录
              </button>
              <button class="action-btn" onclick="exportChatHistory()">
                📤 导出聊天记录
              </button>
            </div>
            <div style="border-top: 1px dashed #e5ddd3; margin: 20px 0"></div>
            <div class="action-buttons-grid">
              <button
                class="action-btn danger"
                onclick="clearChatHistoryFromSettings()"
              >
                🧹 清空聊天
              </button>
              <button class="action-btn danger" onclick="blockCharacter()">
                🚫 拉黑对方
              </button>
            </div>
            <button
              class="action-btn danger"
              style="width: 100%; margin-top: 12px"
              onclick="deleteCharacterCompletely()"
            >
              🗑️ 删除此联系人
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ==================== 【新】全局变量集中声明与初始化 ====================
      // 1. 先把所有变量定义在 window 上，初始为空
      window.fontPresets = [];
      window.activeFontId = "system";
      window.readTogetherData = {};
      window.characters = []; // 以前散落在 1827 行
      window.apiPresets = []; // 以前散落在 1898 行
      window.chatHistories = {}; // 以前散落在 2095 行
      window.chatSettings = {}; // 以前散落在 2445 行
      window.userPersonaPresets = []; // 以前散落在 2660 行
      window.bookshelfData = []; // 以前散落在 3175 行
      window.voiceConfig = {}; // 以前散落在 2980 行

      // 世界书系统变量
      window.worldbooks = []; // 世界书列表
      window.worldbookGroups = []; // 世界书分组
      window.worldbookBatchMode = false; // 批量操作模式
      window.worldbookSelectedIds = new Set(); // 批量选中的世界书ID
      window.currentWorldbookFilter = "all"; // 当前筛选分组
      window.editingWorldbookId = null; // 正在编辑的世界书ID
      window.editingEntryIndex = null; // 正在编辑的条目索引
      window.tempWorldbookEntries = []; // 临时条目列表

      // 全局安全读取函数，处理数据损坏情况
      async function safeLocalforageGet(key) {
        try {
          return await localforage.getItem(key);
        } catch (e) {
          console.warn(`读取 ${key} 失败:`, e.message);
          return null;
        }
      }

      // 2. 创建一个异步启动函数
      async function initApp() {
        try {
          console.log("正在通过 localforage 加载数据...");

          // 使用全局安全读取函数
          const safeGet = safeLocalforageGet;

          // 并行读取所有数据，速度更快
          const values = await Promise.all([
            safeGet("fontPresets"),
            safeGet("activeFontId"),
            safeGet("readTogetherData"),
            safeGet("characters"),
            safeGet("apiPresets"),
            safeGet("chatHistories"),
            safeGet("chatSettings"),
            safeGet("userPersonaPresets"),
            safeGet("bookshelfData"),
            safeGet("voiceConfig"),
            safeGet("avatarImg"),
            safeGet("activePresetId"),
            safeGet("worldbooks"),
            safeGet("worldbookGroups"),
            safeGet("groupChats"), // 添加群聊数据加载
          ]);

          // 赋值（如果读取为 null，就用默认值）
          window.fontPresets = values[0] || [];
          window.activeFontId = values[1] || "system";
          window.readTogetherData = values[2] || {};
          window.characters = values[3] || [];
          window.apiPresets = values[4] || [];
          window.chatHistories = values[5] || {};
          window.chatSettings = values[6] || {};
          window.userPersonaPresets = values[7] || [];
          window.bookshelfData = values[8] || [];
          window.voiceConfig = values[9] || {};

          const avatarImg = values[10];

          // 保存到全局变量，供后面API预设模块使用
          window.savedActivePresetId = values[11] || null;

          // 世界书数据
          window.worldbooks = values[12] || [];
          window.worldbookGroups = values[13] || [];

          // 群聊数据
          groupChats = values[14] || [];

          // 【✓ 关键修复开始】
          // 必须手动更新 activePresetId 变量，否则界面渲染时不知道刚才读到了什么
          if (window.savedActivePresetId) {
            activePresetId = window.savedActivePresetId;
          }
          // 【✓ 关键修复结束】
          // 加载头像
          if (avatarImg) {
            const img = document.getElementById("avatarImg");
            const ph = document.getElementById("avatarPlaceholder");
            if (img && ph) {
              img.src = avatarImg;
              img.style.display = "block";
              ph.style.display = "none";
            }
          }

          // 加载个人资料 (Profile)
          const fields = ["name", "handle", "bio", "location"];
          const elementMap = {
            name: "profileName",
            handle: "profileHandle",
            bio: "profileBio",
            location: "profileLocation",
          };
          for (const field of fields) {
            const val = await safeGet("profile_" + field);
            if (val) {
              const el = document.getElementById(elementMap[field]);
              if (el) {
                if (field === "handle")
                  el.textContent = "@" + val.replace("@", "");
                else el.textContent = val;
              }
            }
          }

          console.log("数据加载完成，开始渲染界面...");

          // 数据到位了，再调用原来的渲染函数
          // 注意：这里替换了原来的 window.onload 或 DOMContentLoaded 里的逻辑
          renderCharacters();
          renderApiPresets();
          updateActiveConfigDisplay(); // 更新当前激活的API配置显示
          loadVoiceSettings();
          initUserPersonaPresets();
          initPresetSystem(); // 初始化预设系统
          loadSavedData(); // 加载名片、标签、小组件数据

          // 如果有自定义字体，应用它
          if (window.activeFontId !== "system") {
            const font = window.fontPresets.find(
              (f) => f.id == window.activeFontId
            );
            if (font) injectGlobalFont(font.source);
          }
        } catch (err) {
          console.error("初始化失败:", err);

          // 使用默认值初始化，不清除数据
          console.warn("部分数据加载失败，使用默认值继续...");

          window.fontPresets = window.fontPresets || [];
          window.activeFontId = window.activeFontId || "system";
          window.readTogetherData = window.readTogetherData || {};
          window.characters = window.characters || [];
          window.apiPresets = window.apiPresets || [];
          window.chatHistories = window.chatHistories || {};
          window.chatSettings = window.chatSettings || {};
          window.userPersonaPresets = window.userPersonaPresets || [];
          window.bookshelfData = window.bookshelfData || [];
          window.voiceConfig = window.voiceConfig || {};
          window.savedActivePresetId = window.savedActivePresetId || null;
          window.worldbooks = window.worldbooks || [];
          window.worldbookGroups = window.worldbookGroups || [];

          // 尝试渲染界面
          try {
            renderCharacters();
            renderApiPresets();
            updateActiveConfigDisplay();
            loadVoiceSettings();
            initUserPersonaPresets();
            initPresetSystem();
            loadSavedData(); // 加载名片、标签、小组件数据
          } catch (renderErr) {
            console.error("渲染失败:", renderErr);
          }
        }
      }

      // 3. 启动！
      document.addEventListener("DOMContentLoaded", initApp);

      // ==================== 预设系统 ====================
      window.presets = [];
      window.presetBatchMode = false;
      window.selectedPresetIds = [];
      window.editingPresetId = null;
      window.currentPresetFilter = "all";
      window.currentPresetEntries = [];

      // 初始化预设系统
      async function initPresetSystem() {
        try {
          let savedPresets = null;
          try {
            savedPresets = await safeLocalforageGet("userPresets");
          } catch (e) {
            console.warn("读取预设数据失败:", e.message);
          }
          window.presets = savedPresets || [];
          console.log(
            "✓ 预设系统初始化完成，共",
            window.presets.length,
            "个预设"
          );
        } catch (e) {
          console.error("预设加载失败:", e);
          window.presets = [];
        }
      }

      // 渲染预设列表
      function renderPresets() {
        const list = document.getElementById("presetList");
        if (!list) return;

        let filteredPresets = window.presets;
        if (window.currentPresetFilter !== "all") {
          filteredPresets = window.presets.filter(
            (p) => p.category === window.currentPresetFilter
          );
        }

        if (filteredPresets.length === 0) {
          list.innerHTML = `
            <div class="preset-empty">
              <div class="preset-empty-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg></div>
              <div class="preset-empty-text">还没有预设哦~</div>
              <button class="preset-empty-btn" onclick="openPresetModal()">创建第一个预设</button>
            </div>
          `;
          return;
        }

        list.innerHTML = filteredPresets
          .map((preset) => {
            const isSelected = window.selectedPresetIds.includes(preset.id);
            const batchClass = window.presetBatchMode ? "batch-mode" : "";
            const checkedClass = isSelected ? "checked" : "";

            const categoryLabels = {
              character: "角色",
              style: "文风",
              scene: "场景",
            };

            const entryCount = preset.entries ? preset.entries.length : 0;
            const enabledCount = preset.entries
              ? preset.entries.filter((e) => e.enabled).length
              : 0;

            return `
            <div class="preset-item ${batchClass}" onclick="handlePresetClick('${
              preset.id
            }')" oncontextmenu="startPresetBatchMode(event, '${preset.id}')">
              <div class="preset-item-header">
                <div class="preset-item-icon">${preset.icon || "○"}</div>
                <div class="preset-item-info">
                  <div class="preset-item-name">${preset.name}</div>
                  <div class="preset-item-desc">${
                    preset.description || "暂无描述"
                  }</div>
                </div>
                <div class="preset-item-checkbox ${checkedClass}" onclick="event.stopPropagation(); togglePresetSelect('${
              preset.id
            }')">
                  ${isSelected ? "✓" : ""}
                </div>
              </div>
              <div class="preset-item-tags">
                <span class="preset-item-tag">${
                  categoryLabels[preset.category] || "📌 其他"
                }</span>
                <span class="preset-item-tag">≡ ${enabledCount}/${entryCount} 条目</span>
              </div>
              ${
                !window.presetBatchMode
                  ? `
              <div class="preset-item-actions">
                <button class="preset-action-btn edit" onclick="event.stopPropagation(); editPreset('${preset.id}')">✏️ 编辑</button>
                <button class="preset-action-btn export" onclick="event.stopPropagation(); exportPreset('${preset.id}')">↑ 导出</button>
                <button class="preset-action-btn delete" onclick="event.stopPropagation(); deleteSinglePreset('${preset.id}')">✕ 删除</button>
              </div>
              `
                  : ""
              }
            </div>
          `;
          })
          .join("");
      }

      // 切换预设标签页
      function switchPresetTab(tab) {
        window.currentPresetFilter = tab;
        document
          .querySelectorAll(".preset-tab")
          .forEach((t) => t.classList.remove("active"));
        event.target.classList.add("active");
        renderPresets();
      }

      // 当前编辑中的预设条目
      window.currentPresetEntries = [];

      // 打开预设编辑弹窗
      function openPresetModal(presetId = null) {
        window.editingPresetId = presetId;
        const modal = document.getElementById("stylePresetModal");
        const title = document.getElementById("stylePresetModalTitle");

        if (presetId) {
          title.textContent = "编辑预设";
          const preset = window.presets.find((p) => p.id === presetId);
          console.log("编辑预设:", preset);
          console.log("预设entries:", preset?.entries);

          if (preset) {
            document.getElementById("stylePresetName").value =
              preset.name || "";
            document.getElementById("stylePresetCategory").value =
              preset.category || "character";
            document.getElementById("stylePresetIcon").value =
              preset.icon || "";
            document.getElementById("stylePresetDesc").value =
              preset.description || "";
            // 加载条目 - 兼容旧格式
            if (
              preset.entries &&
              Array.isArray(preset.entries) &&
              preset.entries.length > 0
            ) {
              window.currentPresetEntries = JSON.parse(
                JSON.stringify(preset.entries)
              );
              console.log(
                "加载了entries:",
                window.currentPresetEntries.length,
                "个"
              );
            } else if (preset.content) {
              // 旧格式：把content转换为单个条目
              window.currentPresetEntries = [
                {
                  id: "entry_" + Date.now(),
                  name: "主要内容",
                  keywords: "",
                  content: preset.content,
                  enabled: true,
                },
              ];
              console.log("从content转换为条目");
            } else {
              window.currentPresetEntries = [];
              console.log("没有找到entries或content");
            }
          }
        } else {
          title.textContent = "创建预设";
          document.getElementById("stylePresetName").value = "";
          document.getElementById("stylePresetCategory").value = "character";
          document.getElementById("stylePresetIcon").value = "";
          document.getElementById("stylePresetDesc").value = "";
          window.currentPresetEntries = [];
        }

        console.log(
          "准备渲染，currentPresetEntries:",
          window.currentPresetEntries
        );
        window.presetEntryDisplayLimit = 20; // 重置显示限制
        renderPresetEntries();
        modal.classList.add("active");
      }

      // 当前显示的条目数量限制
      window.presetEntryDisplayLimit = 20;

      // 渲染预设条目列表
      function renderPresetEntries() {
        const list = document.getElementById("presetEntriesList");
        if (!list) {
          console.error("找不到presetEntriesList元素");
          return;
        }

        console.log(
          "渲染条目，数量:",
          window.currentPresetEntries ? window.currentPresetEntries.length : 0
        );

        if (
          !window.currentPresetEntries ||
          window.currentPresetEntries.length === 0
        ) {
          list.innerHTML =
            '<div style="text-align:center;color:#999;padding:30px;background:rgba(255,255,255,0.8);border-radius:12px;">暂无条目，点击下方按钮添加</div>';
          return;
        }

        // 限制显示数量
        const displayEntries = window.currentPresetEntries.slice(
          0,
          window.presetEntryDisplayLimit
        );
        const hasMore =
          window.currentPresetEntries.length > window.presetEntryDisplayLimit;

        try {
          let html = displayEntries
            .map((entry, index) => {
              const escapedName = presetEscapeHtml(entry.name || "");
              const escapedKeywords = presetEscapeHtml(entry.keywords || "");
              const escapedContent = presetEscapeHtml(entry.content || "");

              return `
            <div data-index="${index}" style="background:#faf8f5 !important;border:1.5px solid rgba(255,182,193,0.5) !important;border-radius:12px !important;margin-bottom:12px !important;overflow:visible !important;display:block !important;visibility:visible !important;opacity:1 !important;height:auto !important;">
              <div style="display:flex !important;align-items:center !important;padding:12px !important;gap:10px !important;background:rgba(255,255,255,0.7) !important;border-bottom:1px solid rgba(255,182,193,0.3) !important;visibility:visible !important;opacity:1 !important;height:auto !important;">
                <div onclick="togglePresetEntry(${index})" style="width:44px !important;height:24px !important;min-width:44px !important;min-height:24px !important;background:${
                entry.enabled
                  ? "linear-gradient(135deg,#f48fb1,#f06292)"
                  : "#ddd"
              } !important;border-radius:12px !important;position:relative !important;cursor:pointer !important;flex-shrink:0 !important;display:block !important;">
                  <div style="position:absolute !important;top:2px !important;${
                    entry.enabled ? "left:22px" : "left:2px"
                  } !important;width:20px !important;height:20px !important;background:white !important;border-radius:50% !important;box-shadow:0 1px 3px rgba(0,0,0,0.2) !important;"></div>
                </div>
                <input type="text" value="${escapedName}" placeholder="备注 (可选)" onchange="updatePresetEntry(${index}, 'name', this.value)"
                  style="flex:1 !important;padding:10px 12px !important;border:1.5px solid #e5ddd3 !important;border-radius:8px !important;font-size:0.95rem !important;outline:none !important;background:white !important;display:block !important;visibility:visible !important;height:auto !important;">
                <button onclick="deletePresetEntry(${index})" style="width:32px !important;height:32px !important;min-width:32px !important;min-height:32px !important;border:none !important;background:rgba(255,100,100,0.15) !important;color:#e57373 !important;border-radius:8px !important;cursor:pointer !important;font-size:18px !important;display:flex !important;align-items:center !important;justify-content:center !important;flex-shrink:0 !important;">✕</button>
              </div>
              <div style="padding:12px !important;background:#faf8f5 !important;display:block !important;visibility:visible !important;opacity:1 !important;height:auto !important;">
                <div style="margin-bottom:10px !important;display:block !important;visibility:visible !important;">
                  <div style="font-size:0.8rem !important;color:#8a6a7f !important;margin-bottom:4px !important;display:block !important;">关键词 (用英文逗号,分隔)</div>
                  <input type="text" value="${escapedKeywords}" placeholder="例如: key1, key2" onchange="updatePresetEntry(${index}, 'keywords', this.value)"
                    style="width:100% !important;padding:10px 12px !important;border:1.5px solid #e5ddd3 !important;border-radius:8px !important;font-size:0.9rem !important;outline:none !important;background:white !important;box-sizing:border-box !important;display:block !important;">
                </div>
                <div style="display:flex !important;align-items:center !important;justify-content:space-between !important;visibility:visible !important;">
                  <span style="font-size:0.8rem !important;color:#8a6a7f !important;display:inline !important;">内容 (点击右侧展开)</span>
                  <button onclick="toggleEntryContent(${index})" style="padding:6px 12px !important;border:none !important;background:rgba(244,143,177,0.2) !important;color:#c2185b !important;border-radius:6px !important;font-size:0.85rem !important;cursor:pointer !important;display:inline-block !important;">展开</button>
                </div>
              </div>
              <div id="entryContent_${index}" style="display:none;padding:0 12px 12px 12px !important;background:#faf8f5 !important;">
                <textarea placeholder="输入预设内容..." onchange="updatePresetEntry(${index}, 'content', this.value)"
                  style="width:100% !important;min-height:100px !important;padding:10px 12px !important;border:1.5px solid #e5ddd3 !important;border-radius:8px !important;font-size:0.9rem !important;outline:none !important;background:white !important;box-sizing:border-box !important;resize:vertical !important;font-family:inherit !important;line-height:1.5 !important;">${escapedContent}</textarea>
              </div>
            </div>
          `;
            })
            .join("");

          // 如果还有更多条目，显示加载更多按钮
          if (hasMore) {
            const remaining =
              window.currentPresetEntries.length -
              window.presetEntryDisplayLimit;
            html += `
              <div style="text-align:center;padding:15px;">
                <button onclick="loadMorePresetEntries()" style="padding:10px 20px;background:linear-gradient(135deg,#f48fb1,#f06292);color:white;border:none;border-radius:20px;font-size:0.9rem;cursor:pointer;">
                  加载更多 (还有 ${remaining} 个条目)
                </button>
              </div>
            `;
          }

          // 显示条目统计
          const enabledCount = window.currentPresetEntries.filter(
            (e) => e.enabled
          ).length;
          html =
            `<div style="text-align:center;padding:8px;color:#8a6a7f;font-size:0.85rem;background:rgba(255,255,255,0.6);border-radius:8px;margin-bottom:10px;">
            共 ${window.currentPresetEntries.length} 个条目，已启用 ${enabledCount} 个
          </div>` + html;

          console.log("生成的HTML长度:", html.length);
          list.innerHTML = html;
          console.log("渲染完成，list子元素数量:", list.children.length);
        } catch (err) {
          console.error("渲染条目出错:", err);
          list.innerHTML =
            '<div style="color:red;padding:20px;">渲染出错: ' +
            err.message +
            "</div>";
        }
      }

      // 加载更多条目
      function loadMorePresetEntries() {
        window.presetEntryDisplayLimit += 20;
        renderPresetEntries();
      }

      // HTML转义函数
      function presetEscapeHtml(text) {
        if (!text) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // 添加新条目
      function addPresetEntry() {
        console.log(
          "添加新条目，当前数量:",
          window.currentPresetEntries.length
        );
        window.currentPresetEntries.push({
          id: "entry_" + Date.now(),
          name: "",
          keywords: "",
          content: "",
          enabled: true,
        });
        // 增加显示限制以确保新条目可见
        window.presetEntryDisplayLimit = Math.max(
          window.presetEntryDisplayLimit,
          window.currentPresetEntries.length
        );
        renderPresetEntries();
        // 滚动到底部显示新条目
        setTimeout(() => {
          const list = document.getElementById("presetEntriesList");
          if (list) {
            list.scrollTop = list.scrollHeight;
          }
        }, 100);
        console.log("添加后数量:", window.currentPresetEntries.length);
      }

      // 切换条目开关
      function togglePresetEntry(index) {
        if (window.currentPresetEntries[index]) {
          window.currentPresetEntries[index].enabled =
            !window.currentPresetEntries[index].enabled;
          renderPresetEntries();
        }
      }

      // 更新条目字段
      function updatePresetEntry(index, field, value) {
        if (window.currentPresetEntries[index]) {
          window.currentPresetEntries[index][field] = value;
        }
      }

      // 删除条目
      function deletePresetEntry(index) {
        window.currentPresetEntries.splice(index, 1);
        renderPresetEntries();
      }

      // 展开/收起条目内容
      function toggleEntryContent(index) {
        const wrapper = document.getElementById(`entryContent_${index}`);
        if (wrapper) {
          const isHidden =
            wrapper.style.display === "none" || wrapper.style.display === "";
          wrapper.style.display = isHidden ? "block" : "none";

          // 找到对应的按钮并更新文字
          const card = wrapper.parentElement;
          if (card) {
            const btn = card.querySelector(
              'button[onclick*="toggleEntryContent"]'
            );
            if (btn) {
              btn.textContent = isHidden ? "收起" : "展开";
            }
          }
        }
      }

      // 关闭预设编辑弹窗
      function closePresetModal() {
        document.getElementById("stylePresetModal").classList.remove("active");
        window.editingPresetId = null;
        window.currentPresetEntries = [];
      }

      // 保存预设
      async function savePreset() {
        const name = document.getElementById("stylePresetName").value.trim();
        const category = document.getElementById("stylePresetCategory").value;
        const icon =
          document.getElementById("stylePresetIcon").value.trim() || "○";
        const description = document
          .getElementById("stylePresetDesc")
          .value.trim();

        if (!name) {
          showToast("请输入预设名称");
          return;
        }
        if (window.currentPresetEntries.length === 0) {
          showToast("请至少添加一个条目");
          return;
        }

        const preset = {
          id: window.editingPresetId || "preset_" + Date.now(),
          name,
          category,
          icon,
          description,
          entries: window.currentPresetEntries,
          createdAt: window.editingPresetId
            ? window.presets.find((p) => p.id === window.editingPresetId)
                ?.createdAt || Date.now()
            : Date.now(),
          updatedAt: Date.now(),
        };

        if (window.editingPresetId) {
          const index = window.presets.findIndex(
            (p) => p.id === window.editingPresetId
          );
          if (index !== -1) {
            window.presets[index] = preset;
          }
        } else {
          window.presets.push(preset);
        }

        await localforage.setItem("userPresets", window.presets);
        closePresetModal();
        renderPresets();
        updateOfflinePresetDropdown();
        showToast(window.editingPresetId ? "预设已更新" : "预设已创建");
      }

      // 编辑预设
      function editPreset(presetId) {
        openPresetModal(presetId);
      }

      // 删除单个预设
      async function deleteSinglePreset(presetId) {
        if (!confirm("确定要删除这个预设吗？")) return;

        window.presets = window.presets.filter((p) => p.id !== presetId);
        await localforage.setItem("userPresets", window.presets);
        renderPresets();
        updateOfflinePresetDropdown();
        showToast("预设已删除");
      }

      // 导出预设
      function exportPreset(presetId) {
        const preset = window.presets.find((p) => p.id === presetId);
        if (!preset) return;

        // 转换为Silly Tavern兼容格式
        const exportData = {
          name: preset.name,
          description: preset.description,
          content: preset.content,
          category: preset.category,
          icon: preset.icon,
          minWords: preset.minWords,
          maxWords: preset.maxWords,
          // 兼容Silly Tavern的字段
          prompt: preset.content,
          system_prompt: preset.content,
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `preset_${preset.name}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast("预设已导出");
      }

      // 处理预设点击
      function handlePresetClick(presetId) {
        if (window.presetBatchMode) {
          togglePresetSelect(presetId);
        } else {
          // 可以在这里添加预览功能
        }
      }

      // 开始批量模式
      function startPresetBatchMode(e, presetId) {
        e.preventDefault();
        window.presetBatchMode = true;
        window.selectedPresetIds = [presetId];
        document.getElementById("presetBatchBar").classList.add("active");
        renderPresets();
      }

      // 切换选中状态
      function togglePresetSelect(presetId) {
        const index = window.selectedPresetIds.indexOf(presetId);
        if (index === -1) {
          window.selectedPresetIds.push(presetId);
        } else {
          window.selectedPresetIds.splice(index, 1);
        }
        renderPresets();
      }

      // 取消批量模式
      function cancelPresetBatch() {
        window.presetBatchMode = false;
        window.selectedPresetIds = [];
        document.getElementById("presetBatchBar").classList.remove("active");
        renderPresets();
      }

      // 删除选中的预设
      async function deleteSelectedPresets() {
        if (window.selectedPresetIds.length === 0) {
          showToast("请先选择要删除的预设");
          return;
        }

        if (
          !confirm(
            `确定要删除选中的 ${window.selectedPresetIds.length} 个预设吗？`
          )
        )
          return;

        window.presets = window.presets.filter(
          (p) => !window.selectedPresetIds.includes(p.id)
        );
        await localforage.setItem("userPresets", window.presets);
        cancelPresetBatch();
        updateOfflinePresetDropdown();
        showToast("已删除选中的预设");
      }

      // 打开导入弹窗
      function openPresetImportModal() {
        document.getElementById("presetImportModal").classList.add("active");
      }

      // 关闭导入弹窗
      function closePresetImportModal() {
        document.getElementById("presetImportModal").classList.remove("active");
      }

      // 从文件导入
      function importPresetFromFile() {
        closePresetImportModal();
        document.getElementById("presetFileInput").click();
      }

      // 处理文件导入
      async function handlePresetFileImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        try {
          const text = await file.text();
          const data = JSON.parse(text);
          await importPresetData(data);
        } catch (e) {
          console.error("导入失败:", e);
          showToast("导入失败，请检查文件格式");
        }

        event.target.value = "";
      }

      // 从剪贴板导入
      async function importPresetFromClipboard() {
        try {
          const text = await navigator.clipboard.readText();
          const data = JSON.parse(text);
          await importPresetData(data);
          closePresetImportModal();
        } catch (e) {
          console.error("导入失败:", e);
          showToast("导入失败，请检查剪贴板内容");
        }
      }

      // 导入预设数据
      async function importPresetData(data) {
        console.log("开始导入预设数据:", data);
        let entries = [];
        let presetName = data.name || "导入的预设";

        // Silly Tavern格式：内容在prompts数组里
        if (data.prompts && Array.isArray(data.prompts)) {
          console.log("检测到prompts数组，共", data.prompts.length, "个");

          // 获取prompt_order来确定enabled状态
          // Silly Tavern格式: prompt_order是数组，每项有character_id和order
          // order才是包含{identifier, enabled}的数组
          let enabledMap = {};
          if (data.prompt_order && Array.isArray(data.prompt_order)) {
            data.prompt_order.forEach((orderItem) => {
              // Silly Tavern格式：{character_id: xxx, order: [...]}
              if (
                orderItem &&
                orderItem.order &&
                Array.isArray(orderItem.order)
              ) {
                orderItem.order.forEach((item) => {
                  if (item && item.identifier) {
                    enabledMap[item.identifier] = item.enabled === true;
                  }
                });
              }
              // 兼容其他格式
              else if (Array.isArray(orderItem)) {
                orderItem.forEach((item) => {
                  if (item && item.identifier) {
                    enabledMap[item.identifier] = item.enabled === true;
                  }
                });
              } else if (orderItem && orderItem.identifier) {
                enabledMap[orderItem.identifier] = orderItem.enabled === true;
              }
            });
          }

          console.log("解析到的enabledMap:", enabledMap);

          // 提取所有prompt并转换为条目（排除marker）
          const baseTime = Date.now();
          entries = data.prompts
            .filter(
              (p) => p.content && typeof p.content === "string" && !p.marker
            )
            .map((p, index) => {
              // 优先使用prompt_order中的enabled状态
              let isEnabled = false; // 默认关闭
              if (p.identifier && enabledMap.hasOwnProperty(p.identifier)) {
                isEnabled = enabledMap[p.identifier];
                console.log(
                  `条目 ${
                    p.name || p.identifier
                  }: enabled=${isEnabled} (from prompt_order)`
                );
              } else if (p.hasOwnProperty("enabled")) {
                isEnabled = p.enabled === true;
                console.log(
                  `条目 ${
                    p.name || p.identifier
                  }: enabled=${isEnabled} (from prompt.enabled)`
                );
              }

              return {
                id: "entry_" + baseTime + "_" + index,
                name: p.name || "",
                keywords: "",
                content: p.content,
                enabled: isEnabled,
              };
            });

          const enabledCount = entries.filter((e) => e.enabled).length;
          console.log(
            `过滤后得到 ${entries.length} 个条目，其中 ${enabledCount} 个已启用`
          );

          const firstWithContent = data.prompts.find(
            (p) => p.content && p.name
          );
          if (firstWithContent) {
            presetName = firstWithContent.name;
          }
        }

        // 如果prompts里没有找到，尝试其他字段作为单个条目
        if (entries.length === 0) {
          const content =
            data.content || data.prompt || data.system_prompt || "";
          if (content) {
            entries.push({
              id: "entry_" + Date.now(),
              name: data.name || "主要内容",
              keywords: "",
              content: content,
              enabled: true,
            });
          }
        }

        if (entries.length === 0) {
          showToast("预设内容为空，无法导入");
          return;
        }

        const preset = {
          id: "preset_" + Date.now(),
          name: presetName,
          category: data.category || "style",
          icon: data.icon || "↓",
          description: data.description || "从Silly Tavern导入的预设",
          entries: entries,
          createdAt: Date.now(),
          updatedAt: Date.now(),
        };

        console.log("创建预设对象:", preset);
        const enabledCount = entries.filter((e) => e.enabled).length;

        window.presets.push(preset);
        await localforage.setItem("userPresets", window.presets);
        renderPresets();
        updateOfflinePresetDropdown();
        showToast(
          `预设导入成功！共 ${entries.length} 个条目，${enabledCount} 个已启用`
        );
      }

      // ==================== 线下模式设置 ====================

      // 切换线下模式设置面板显示
      function toggleOfflineSettings() {
        const checkbox = document.getElementById("settingsOnlineDating");
        const settingsPanel = document.getElementById("offlineWordSettings");

        if (checkbox.checked) {
          settingsPanel.classList.add("active");
          updateOfflinePresetDropdown();
        } else {
          settingsPanel.classList.remove("active");
        }
      }

      // 更新线下模式预设下拉列表
      function updateOfflinePresetDropdown() {
        const select = document.getElementById("offlinePresetSelect");
        if (!select) return;

        const currentValue = select.value;

        select.innerHTML = '<option value="">-- 不使用预设 --</option>';

        window.presets.forEach((preset) => {
          const option = document.createElement("option");
          option.value = preset.id;
          option.textContent = `${preset.icon || "○"} ${preset.name}`;
          select.appendChild(option);
        });

        // 恢复之前的选择
        if (currentValue && window.presets.find((p) => p.id === currentValue)) {
          select.value = currentValue;
        }
      }

      // 预设选择变化时更新字数范围
      function onOfflinePresetChange() {
        const select = document.getElementById("offlinePresetSelect");
        const presetId = select.value;

        if (presetId) {
          const preset = window.presets.find((p) => p.id === presetId);
          if (preset) {
            document.getElementById("offlineMinWords").value =
              preset.minWords || 100;
            document.getElementById("offlineMaxWords").value =
              preset.maxWords || 500;
          }
        }
      }

      // 页面打开时的处理
      function openPage(pageId) {
        const page = document.getElementById(pageId);
        if (page) {
          page.classList.add("active");

          // 预设页面特殊处理
          if (pageId === "presetPage") {
            renderPresets();
          }
        }
      }

      function closePage(pageId) {
        const page = document.getElementById(pageId);
        if (page) {
          page.classList.remove("active");

          // 预设页面关闭时取消批量模式
          if (pageId === "presetPage") {
            cancelPresetBatch();
          }
        }
      }

      // 必须用 var 定义，防止报错
      var isSelectionMode = false;
      var activeMsgIndex = -1;
      var selectedIndices = new Set();
      var longPressTimer = null;
      var touchStartX = 0;
      var touchStartY = 0;
      var voiceTouchStartTime = 0;
      // ==================== 注入聊天头像样式 ====================
      const avatarStyle = document.createElement("style");
      avatarStyle.innerHTML = `
    /* ========== 修复核心：气泡布局 ========== */
    .msg-wrapper {
        display: flex;
        width: 100%;
        margin-bottom: 16px;
        gap: 10px;
        padding: 0 4px;
    }

    /* 用户消息：头像在右，气泡在左（反向排列） */
    .msg-wrapper.user {
        flex-direction: row-reverse;
    }

    /* AI消息：头像在左，气泡在右 */
    .msg-wrapper.ai {
        flex-direction: row;
    }

    /* 头像样式 */
    .chat-avatar-small {
        width: 42px;
        height: 42px;
        border-radius: 12px;
        background: linear-gradient(135deg, #fce4ec, #e8f5e9);
        flex-shrink: 0;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        margin-top: 0px; 
    }
    .chat-avatar-small img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* 包裹气泡的列容器 */
    .msg-content-container {
        max-width: 72%;
        display: flex;
        flex-direction: column;
    }

    /* 覆盖 msg-row，让它作为 Flex 列 */
    .msg-wrapper .msg-row {
        display: flex;
        flex-direction: column;
        max-width: 100%;
        margin: 0;
    }

    /* 【关键修复】强制气泡不拉伸！ */
    /* 用户气泡：靠右对齐 */
    .msg-wrapper.user .msg-content-container,
    .msg-wrapper.user .msg-row {
        align-items: flex-end !important; 
    }

    /* AI气泡：靠左对齐 */
    .msg-wrapper.ai .msg-content-container,
    .msg-wrapper.ai .msg-row {
        align-items: flex-start !important;
    }

    /* 确保气泡本身的宽度是适应内容的 */
    .msg-bubble {
        width: fit-content !important;
        max-width: 100% !important;
        word-wrap: break-word;
        word-break: break-word;
    }

    /* 时间微调 */
    .msg-time-wrapper {
        font-size: 0.7rem;
        color: var(--text-hint);
        margin-top: 4px;
        padding: 0 2px;
    }
`;
      document.head.appendChild(avatarStyle);
      var currentEditField = "";
      // ==================== 图片压缩工具 ====================
      // file: 上传的文件对象
      // maxWidth: 图片最大宽度 (头像建议300，背景建议800)
      // quality: 压缩质量 (0-1，建议0.7)
      function compressImage(file, maxWidth, quality) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = (event) => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
              // 计算压缩后的尺寸
              let width = img.width;
              let height = img.height;
              if (width > maxWidth) {
                height = Math.round(height * (maxWidth / width));
                width = maxWidth;
              }

              // 使用 Canvas 绘图并压缩
              const canvas = document.createElement("canvas");
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0, width, height);

              // 导出为压缩后的 Base64
              resolve(canvas.toDataURL("image/jpeg", quality));
            };
          };
        });
      }
      // 修改后的个人主页头像上传（带压缩）
      async function handleAvatarUpload(input) {
        const file = input.files[0];
        if (file) {
          try {
            // 头像压缩到 300px 宽，质量 0.7
            const compressedData = await compressImage(file, 300, 0.7);

            const img = document.getElementById("avatarImg");
            const placeholder = document.getElementById("avatarPlaceholder");
            img.src = compressedData;
            img.style.display = "block";
            placeholder.style.display = "none";
            localforage.setItem("avatarImg", compressedData);
          } catch (e) {
            alert("图片处理失败，请重试");
          }
        }
      }

      // Edit modal
      function openEditModal(field) {
        currentEditField = field;
        const modal = document.getElementById("editModal");
        const title = document.getElementById("editModalTitle");
        const input = document.getElementById("editInput");

        const titles = {
          name: "编辑用户名",
          handle: "编辑ID",
          bio: "编辑个性签名",
          location: "编辑位置",
        };

        const placeholders = {
          name: "请输入用户名",
          handle: "请输入@ID",
          bio: "请输入个性签名",
          location: "请输入位置",
        };

        title.textContent = titles[field];
        input.placeholder = placeholders[field];
        input.value = localStorage.getItem("profile_" + field) || "";
        modal.classList.add("active");
        input.focus();
      }

      function closeEditModal() {
        document.getElementById("editModal").classList.remove("active");
      }

      function saveEdit() {
        const input = document.getElementById("editInput");
        const value = input.value.trim();

        if (value) {
          localforage.setItem("profile_" + currentEditField, value);

          const elementMap = {
            name: "profileName",
            handle: "profileHandle",
            bio: "profileBio",
            location: "profileLocation",
          };

          const element = document.getElementById(elementMap[currentEditField]);
          if (currentEditField === "handle") {
            element.textContent = "@" + value.replace("@", "");
          } else {
            element.textContent = value;
          }
        }

        closeEditModal();
      }

      // 标签编辑功能
      let currentTagPosition = null;

      function openTagEditModal(position) {
        currentTagPosition = position;
        const modal = document.getElementById("tagEditModal");
        const title = document.getElementById("tagEditTitle");
        const input = document.getElementById("tagEditInput");

        const positionNames = {
          leftTop: "左上标签",
          leftBottom: "左下标签",
          rightTop: "右上标签",
          rightBottom: "右下标签",
        };

        title.textContent = "编辑" + positionNames[position];

        // 加载已保存的数据
        const savedText =
          localStorage.getItem("tag_" + position + "_text") || "";
        input.value = savedText;

        modal.classList.add("active");
        input.focus();
      }

      function closeTagEditModal() {
        document.getElementById("tagEditModal").classList.remove("active");
      }

      function saveTagEdit() {
        const input = document.getElementById("tagEditInput");
        const value = input.value.trim();

        localStorage.setItem("tag_" + currentTagPosition + "_text", value);

        // 更新界面
        const elementMap = {
          leftTop: "tagLeftTop",
          leftBottom: "tagLeftBottom",
          rightTop: "tagRightTop",
          rightBottom: "tagRightBottom",
        };
        const textElement = document.getElementById(
          elementMap[currentTagPosition]
        );
        if (textElement) {
          textElement.textContent = value;
        }

        closeTagEditModal();
      }

      function loadTagsData() {
        const positions = ["leftTop", "leftBottom", "rightTop", "rightBottom"];
        const elementMap = {
          leftTop: "tagLeftTop",
          leftBottom: "tagLeftBottom",
          rightTop: "tagRightTop",
          rightBottom: "tagRightBottom",
        };

        positions.forEach((position) => {
          const savedText =
            localStorage.getItem("tag_" + position + "_text") || "";
          const textElement = document.getElementById(elementMap[position]);
          if (textElement) {
            textElement.textContent = savedText;
          }
        });
      }

      // ==================== 恋爱纪念组件功能 ====================
      let currentLoveEditField = null;

      function openLoveEditModal(field) {
        currentLoveEditField = field;
        const modal = document.getElementById("loveEditModal");
        const title = document.getElementById("loveEditTitle");
        const input = document.getElementById("loveEditInput");

        if (field === "title") {
          title.textContent = "编辑标题";
          input.placeholder = "请输入标题文字";
          input.type = "text";
          input.value = localStorage.getItem("love_title") || "恋爱纪念";
        } else if (field === "startDate") {
          title.textContent = "设置开始日期";
          input.placeholder = "格式：2024.01.01";
          input.type = "text";
          input.value = localStorage.getItem("love_start_date") || "";
        }

        modal.classList.add("active");
        input.focus();
      }

      function closeLoveEditModal() {
        document.getElementById("loveEditModal").classList.remove("active");
      }

      function saveLoveEdit() {
        const input = document.getElementById("loveEditInput");
        const value = input.value.trim();

        if (currentLoveEditField === "title" && value) {
          localStorage.setItem("love_title", value);
          document.getElementById("loveTitleText").textContent = value;
        } else if (currentLoveEditField === "startDate" && value) {
          localStorage.setItem("love_start_date", value);
          document.getElementById("loveDateText").textContent = value;
          updateLoveDays();
        }

        closeLoveEditModal();
      }

      function updateLoveDays() {
        const dateStr = localStorage.getItem("love_start_date");
        if (dateStr) {
          // 解析日期格式 2024.01.01 或 2024-01-01
          const parts = dateStr.replace(/\./g, "-").split("-");
          if (parts.length === 3) {
            const startDate = new Date(parts[0], parts[1] - 1, parts[2]);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            startDate.setHours(0, 0, 0, 0);
            const diffTime = today - startDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            document.getElementById("loveDaysNumber").textContent =
              diffDays >= 0 ? diffDays : 0;
          }
        }
      }

      async function handleLoveAvatarUpload(index, input) {
        const file = input.files[0];
        if (file) {
          try {
            const compressedData = await compressImage(file, 300, 0.7);
            const img = document.getElementById("loveAvatar" + index + "Img");
            const placeholder = document.getElementById(
              "loveAvatar" + index + "Placeholder"
            );
            img.src = compressedData;
            img.style.display = "block";
            placeholder.style.display = "none";
            localStorage.setItem("love_avatar_" + index, compressedData);
          } catch (e) {
            alert("图片处理失败，请重试");
          }
        }
      }

      function loadLoveWidgetData() {
        // 加载头像
        for (let i = 1; i <= 2; i++) {
          const avatarData = localStorage.getItem("love_avatar_" + i);
          if (avatarData) {
            const img = document.getElementById("loveAvatar" + i + "Img");
            const placeholder = document.getElementById(
              "loveAvatar" + i + "Placeholder"
            );
            img.src = avatarData;
            img.style.display = "block";
            placeholder.style.display = "none";
          }
        }

        // 加载标题
        const title = localStorage.getItem("love_title");
        if (title) {
          document.getElementById("loveTitleText").textContent = title;
        }

        // 加载日期并计算天数
        const dateStr = localStorage.getItem("love_start_date");
        if (dateStr) {
          document.getElementById("loveDateText").textContent = dateStr;
          updateLoveDays();
        }

        // 加载背景图
        const bgData = localStorage.getItem("love_widget_bg");
        if (bgData) {
          document.getElementById("loveWidgetBg").style.backgroundImage =
            "url(" + bgData + ")";
        }

        // 加载字体颜色
        const textColor = localStorage.getItem("love_widget_text_color");
        if (textColor === "light") {
          document.getElementById("loveWidget").classList.add("text-light");
        }
      }

      // 点击小组件空白区域打开选项
      function handleLoveWidgetClick(event) {
        // 如果点击的是小组件本身或背景层，打开选项弹窗
        if (
          event.target.id === "loveWidget" ||
          event.target.id === "loveWidgetBg"
        ) {
          document
            .getElementById("loveWidgetOptionsModal")
            .classList.add("active");
        }
      }

      function closeLoveWidgetOptionsModal() {
        document
          .getElementById("loveWidgetOptionsModal")
          .classList.remove("active");
      }

      function triggerLoveWidgetBgUpload() {
        closeLoveWidgetOptionsModal();
        document.getElementById("loveWidgetBgInput").click();
      }

      function setLoveWidgetTextColor(mode) {
        const widget = document.getElementById("loveWidget");
        if (mode === "light") {
          widget.classList.add("text-light");
          localStorage.setItem("love_widget_text_color", "light");
        } else {
          widget.classList.remove("text-light");
          localStorage.setItem("love_widget_text_color", "dark");
        }
        closeLoveWidgetOptionsModal();
      }

      // 处理背景图上传
      async function handleLoveWidgetBgUpload(input) {
        const file = input.files[0];
        if (file) {
          try {
            const compressedData = await compressImage(file, 500, 0.8);
            document.getElementById("loveWidgetBg").style.backgroundImage =
              "url(" + compressedData + ")";
            localStorage.setItem("love_widget_bg", compressedData);
          } catch (e) {
            alert("图片处理失败，请重试");
          }
        }
      }

      // Page navigation
      // Load saved data
      function loadSavedData() {
        // Avatar
        const avatarData = localStorage.getItem("avatarImg");
        if (avatarData) {
          const img = document.getElementById("avatarImg");
          const placeholder = document.getElementById("avatarPlaceholder");
          img.src = avatarData;
          img.style.display = "block";
          placeholder.style.display = "none";
        }

        // Profile fields
        const fields = ["name", "handle", "bio", "location"];
        const elementMap = {
          name: "profileName",
          handle: "profileHandle",
          bio: "profileBio",
          location: "profileLocation",
        };

        fields.forEach((field) => {
          const saved = localStorage.getItem("profile_" + field);
          if (saved) {
            const element = document.getElementById(elementMap[field]);
            if (field === "handle") {
              element.textContent = "@" + saved.replace("@", "");
            } else {
              element.textContent = saved;
            }
          }
        });

        // 加载名片标签数据
        loadTagsData();

        // 加载恋爱纪念组件数据
        loadLoveWidgetData();
      }

      // Close modal on outside click
      document
        .getElementById("editModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeEditModal();
          }
        });

      // 标签编辑弹窗点击外部关闭
      document
        .getElementById("tagEditModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeTagEditModal();
          }
        });

      // Enter key to save
      document
        .getElementById("editInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            saveEdit();
          }
        });

      // 标签编辑弹窗回车保存
      document
        .getElementById("tagEditInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            saveTagEdit();
          }
        });

      // 恋爱纪念弹窗点击外部关闭
      document
        .getElementById("loveEditModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeLoveEditModal();
          }
        });

      // 恋爱纪念弹窗回车保存
      document
        .getElementById("loveEditInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            saveLoveEdit();
          }
        });

      // 小组件选项弹窗点击外部关闭
      document
        .getElementById("loveWidgetOptionsModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeLoveWidgetOptionsModal();
          }
        });

      // Chat App Tab Switching
      function switchChatTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll(".chat-tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Remove active from all tabs
        document.querySelectorAll(".chat-tab").forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected tab content
        document.getElementById(tabName + "Tab").classList.add("active");

        // Set active tab
        const tabs = document.querySelectorAll(".chat-tab");
        const tabIndex = { messages: 0, moments: 1, todo: 2, profile: 3 };
        tabs[tabIndex[tabName]].classList.add("active");

        // Update header title
        const titles = {
          messages: "Message",
          moments: "Moment",
          todo: "To Do",
          profile: "Me",
        };
        document.getElementById("chatAppTitle").textContent = titles[tabName];

        // Update header button (todo用设置按钮)
        const buttons = {
          messages: "+",
          moments: "📷",
          todo: "○",
          profile: "○",
        };
        document.getElementById("chatHeaderBtn").textContent = buttons[tabName];

        // 控制创建群聊按钮显示（只在messages标签页显示）
        const createGroupBtn = document.getElementById("createGroupBtn");
        if (createGroupBtn) {
          createGroupBtn.style.display = tabName === "messages" ? "" : "none";
        }

        // 切换到moments时清除朋友圈小红点
        if (tabName === "moments") {
          if (typeof clearUnreadMoments === "function") clearUnreadMoments();
        }

        // 背景和滚动控制
        const chatApp = document.querySelector(".chat-app");
        const tabBar = document.querySelector(".chat-tab-bar");
        const chatContent = document.querySelector(".chat-content");

        if (tabName === "messages") {
          // messages页面保留波点背景
          chatApp.style.background = "#fdf5f7";
          chatApp.style.backgroundImage =
            "radial-gradient(circle, rgba(244,143,177,0.15) 2px, transparent 2px)";
          chatApp.style.backgroundSize = "20px 20px";
          chatContent.style.background = "transparent";
          tabBar.style.background = "rgba(255, 255, 255, 0.7)";
          tabBar.style.backdropFilter = "blur(25px) saturate(180%)";
          tabBar.style.webkitBackdropFilter = "blur(25px) saturate(180%)";
          chatContent.style.overflowY = "auto";
        } else if (tabName === "moments") {
          chatApp.style.backgroundImage = "none";
          chatApp.style.background = "#efefef";
          chatContent.style.background = "#efefef";
          tabBar.style.background = "rgba(255, 255, 255, 0.25)";
          tabBar.style.backdropFilter = "blur(30px) saturate(180%)";
          tabBar.style.webkitBackdropFilter = "blur(30px) saturate(180%)";
          chatContent.style.overflowY = "auto";
        } else if (tabName === "todo") {
          chatApp.style.backgroundImage = "none";
          chatApp.style.background = "#fffafa";
          chatContent.style.background = "#fffafa";
          tabBar.style.background = "rgba(255, 255, 255, 0.25)";
          tabBar.style.backdropFilter = "blur(30px) saturate(180%)";
          tabBar.style.webkitBackdropFilter = "blur(30px) saturate(180%)";
          chatContent.style.overflowY = "auto";
        } else {
          // profile页面
          chatApp.style.backgroundImage = "none";
          chatApp.style.background = "#f5f5f5";
          chatContent.style.background = "#f5f5f5";
          tabBar.style.background = "rgba(255, 255, 255, 0.25)";
          tabBar.style.backdropFilter = "blur(30px) saturate(180%)";
          tabBar.style.webkitBackdropFilter = "blur(30px) saturate(180%)";
          chatContent.style.overflowY = "hidden";
        }

        // 切换到待办标签时刷新AI角色列表和日期
        if (tabName === "todo") {
          if (typeof renderTodoAiCharList === "function")
            renderTodoAiCharList();
          if (typeof updateTodoDate === "function") updateTodoDate();
          if (typeof updateTodoStats === "function") updateTodoStats();
        }
      }

      // 旧的todo点击事件已废弃，使用新的待办系统

      // Character data storage
      var tempCharAvatar = null;

      // Header button handler
      function handleHeaderBtn() {
        const currentTab = document.querySelector(
          ".chat-tab.active .tab-label"
        ).textContent;
        if (currentTab === "Message") {
          openCreateCharModal();
        } else if (currentTab === "To Do") {
          openTodoSettingsModal();
        }
      }

      // Open create character modal
      function openCreateCharModal() {
        document.getElementById("createCharModal").classList.add("active");
        document.getElementById("charNameInput").value = "";
        document.getElementById("charNoteInput").value = "";
        document.getElementById("charAvatarPreview").style.display = "none";
        document.getElementById("charAvatarPlaceholder").style.display =
          "block";
        document.querySelector(".create-avatar").classList.remove("has-image");
        tempCharAvatar = null;
      }

      // Close create character modal
      function closeCreateCharModal() {
        document.getElementById("createCharModal").classList.remove("active");
      }

      // 修改后的创建角色头像预览（带压缩）
      async function previewCharAvatar(input) {
        const file = input.files[0];
        if (file) {
          // 头像压缩到 300px
          const compressedData = await compressImage(file, 300, 0.7);

          const preview = document.getElementById("charAvatarPreview");
          const placeholder = document.getElementById("charAvatarPlaceholder");
          preview.src = compressedData;
          preview.style.display = "block";
          placeholder.style.display = "none";
          document.querySelector(".create-avatar").classList.add("has-image");
          tempCharAvatar = compressedData; // 存入临时变量的是压缩后的数据
        }
      }

      // Create character
      function createCharacter() {
        const name = document.getElementById("charNameInput").value.trim();
        const note = document.getElementById("charNoteInput").value.trim();

        if (!name) {
          alert("请输入角色名称");
          return;
        }

        const character = {
          id: Date.now(),
          name: name,
          note: note,
          avatar: tempCharAvatar,
          lastMessage: "",
          lastTime: "刚刚",
          unread: 0,
        };

        characters.push(character);
        localforage.setItem("characters", characters);

        renderCharacters();
        closeCreateCharModal();
      }

      // ==================== 群聊功能 ====================
      var groupChats = []; // 群聊列表
      var tempGroupAvatar = null; // 临时群头像
      var selectedGroupMembers = []; // 选中的群成员
      var currentGroupId = null; // 当前群聊ID
      var tempAddMembers = []; // 临时添加成员

      // 打开创建群聊弹窗
      function openCreateGroupModal() {
        if (characters.length < 2) {
          alert("请先创建至少2个AI角色才能建群哦～");
          return;
        }
        document.getElementById("createGroupModal").classList.add("active");
        document.getElementById("groupNameInput").value = "";
        document.getElementById("groupAvatarImg").style.display = "none";
        document.getElementById("groupAvatarPlaceholder").style.display =
          "block";
        tempGroupAvatar = null;
        selectedGroupMembers = [];
        renderGroupMembersList();
        checkGroupCreateValid();
      }

      // 关闭创建群聊弹窗
      function closeCreateGroupModal() {
        document.getElementById("createGroupModal").classList.remove("active");
        selectedGroupMembers = [];
        tempGroupAvatar = null;
      }

      // 预览群头像
      async function previewGroupAvatar(input) {
        const file = input.files[0];
        if (file) {
          const compressedData = await compressImage(file, 300, 0.7);
          const img = document.getElementById("groupAvatarImg");
          const placeholder = document.getElementById("groupAvatarPlaceholder");
          img.src = compressedData;
          img.style.display = "block";
          placeholder.style.display = "none";
          tempGroupAvatar = compressedData;
        }
      }

      // 渲染群成员选择列表
      function renderGroupMembersList() {
        const container = document.getElementById("groupMembersList");
        if (characters.length === 0) {
          container.innerHTML = `
            <div class="create-group-empty">
              <div class="create-group-empty-icon">😢</div>
              <div>还没有可添加的角色</div>
            </div>
          `;
          return;
        }

        container.innerHTML = characters
          .map((char) => {
            const isSelected = selectedGroupMembers.includes(char.id);
            const displayName = char.note || char.name;
            return `
            <div class="create-group-member-item ${
              isSelected ? "selected" : ""
            }" onclick="toggleGroupMember(${char.id})">
              <div class="create-group-member-avatar">
                ${
                  char.avatar
                    ? `<img src="${char.avatar}" alt="${char.name}">`
                    : char.name.charAt(0)
                }
              </div>
              <div class="create-group-member-info">
                <div class="create-group-member-name">${displayName}</div>
                ${
                  char.note && char.note !== char.name
                    ? `<div class="create-group-member-note">真名: ${char.name}</div>`
                    : ""
                }
              </div>
              <div class="create-group-member-check"></div>
            </div>
          `;
          })
          .join("");
      }

      // 切换成员选中状态
      function toggleGroupMember(charId) {
        const index = selectedGroupMembers.indexOf(charId);
        if (index > -1) {
          selectedGroupMembers.splice(index, 1);
        } else {
          selectedGroupMembers.push(charId);
        }
        renderGroupMembersList();
        checkGroupCreateValid();
      }

      // 检查是否可以创建群聊
      function checkGroupCreateValid() {
        const name = document.getElementById("groupNameInput").value.trim();
        const btn = document.getElementById("createGroupConfirmBtn");
        const countEl = document.getElementById("selectedMembersCount");

        countEl.textContent = `已选 ${selectedGroupMembers.length} 人`;

        if (name && selectedGroupMembers.length >= 2) {
          btn.disabled = false;
        } else {
          btn.disabled = true;
        }
      }

      // 创建群聊
      async function createGroupChat() {
        const name = document.getElementById("groupNameInput").value.trim();
        if (!name || selectedGroupMembers.length < 2) {
          alert("请输入群名称并选择至少2个成员");
          return;
        }

        const groupChat = {
          id: Date.now(),
          isGroup: true,
          name: name,
          avatar: tempGroupAvatar,
          members: selectedGroupMembers,
          lastMessage: "群聊已创建",
          lastTime: "刚刚",
          unread: 0,
          createdAt: new Date().toISOString(),
        };

        groupChats.push(groupChat);
        await localforage.setItem("groupChats", groupChats);

        showToast(`群聊「${name}」创建成功！`);
        closeCreateGroupModal();
        renderCharacters();
      }

      // 生成群聊头像（多人头像堆叠）
      function renderGroupAvatarStack(group) {
        const members = group.members.slice(0, 3);
        let avatarsHtml = members
          .map((memberId) => {
            const char = characters.find((c) => c.id === memberId);
            if (!char) return '<div class="avatar-mini">?</div>';
            return `<div class="avatar-mini">${
              char.avatar ? `<img src="${char.avatar}">` : char.name.charAt(0)
            }</div>`;
          })
          .join("");

        if (group.members.length > 3) {
          avatarsHtml += `<div class="avatar-mini more">+${
            group.members.length - 3
          }</div>`;
        }

        return `<div class="group-avatar-stack">${avatarsHtml}</div>`;
      }

      // 打开群聊对话
      function openGroupConversation(groupId) {
        currentGroupId = groupId;
        currentChatCharId = null; // 清除单聊ID

        const group = groupChats.find((g) => g.id === groupId);
        if (!group) return;

        // 重置回复按钮状态（避免切换对话后按钮仍然禁用）
        const replyBtn = document.getElementById("replyBtn");
        if (replyBtn) {
          replyBtn.disabled = false;
          replyBtn.classList.remove("loading");
          replyBtn.innerHTML = "<span>★</span>";
        }

        document.getElementById("chatConversationPage").classList.add("active");
        document.getElementById("convName").textContent = group.name;

        // 设置群头像
        const avatarEl = document.getElementById("convAvatar");
        if (group.avatar) {
          avatarEl.innerHTML = `<img src="${group.avatar}" style="width:100%;height:100%;object-fit:cover;">`;
        } else {
          avatarEl.innerHTML = "👥";
        }

        // 加载群聊消息
        loadGroupMessages(groupId);

        // 隐藏创建群聊按钮（只在消息列表页显示）
        const createGroupBtn = document.getElementById("createGroupBtn");
        if (createGroupBtn) createGroupBtn.style.display = "none";
      }

      // 加载群聊消息
      async function loadGroupMessages(groupId) {
        const messagesKey = `group_messages_${groupId}`;
        const messages = (await localforage.getItem(messagesKey)) || [];
        const container = document.getElementById("convMessages");

        if (messages.length === 0) {
          container.innerHTML = `
            <div class="conv-empty">
              <div class="conv-empty-icon">👥</div>
              <div class="conv-empty-text">群聊已创建，开始聊天吧～</div>
            </div>
          `;
          return;
        }

        // 获取用户头像
        const globalUserAvatar = localStorage.getItem("avatarImg");
        const group = groupChats.find((g) => g.id === groupId);
        const groupSettings = group?.settings || {};
        const userAvatar = groupSettings.userAvatar || globalUserAvatar || "";

        container.innerHTML = messages
          .filter((msg) => !msg.isHidden) // 过滤掉隐藏消息
          .map((msg, index) => {
            if (msg.role === "user") {
              // 检查是否是HTML消息（如表情包）
              const isHtmlMsg = msg.isHtml === true;
              const contentHtml = isHtmlMsg
                ? msg.content
                : escapeHtml(msg.content);
              // 检测是否是表情包消息
              const isSticker =
                isHtmlMsg &&
                (msg.content.includes('class="sticker-img"') ||
                  /^\[(sticker|表情|表情包)[：:][^\]]+\]$/i.test(
                    msg.content.trim()
                  ));
              return `
              <div class="msg-row user group-msg" 
                   data-index="${index}"
                   ontouchstart="handleGroupTouchStart(event, ${index})"
                   ontouchmove="handleGroupTouchMove(event)"
                   ontouchend="handleGroupTouchEnd(event)"
                   onmousedown="handleGroupMouseDown(event, ${index})"
                   onmouseup="handleGroupMouseUp(event)">
                <div class="msg-bubble${
                  isSticker ? " sticker-bubble" : ""
                }">${contentHtml}</div>
                <div class="msg-time">${msg.time || ""}</div>
                <div class="msg-user-avatar">
                  ${userAvatar ? `<img src="${userAvatar}">` : "我"}
                </div>
              </div>
            `;
            } else if (msg.role === "system") {
              // 系统消息 - 检查是否是HTML（如通话卡片）
              const isHtmlMsg = msg.isHtml === true;
              const contentHtml = isHtmlMsg
                ? msg.content
                : escapeHtml(msg.content);
              return `
              <div class="msg-row system" style="text-align:center;margin:8px 0;">
                <div style="display:inline-block;${
                  isHtmlMsg
                    ? ""
                    : "padding:4px 12px;background:rgba(0,0,0,0.05);border-radius:12px;font-size:0.75rem;color:#999;"
                }">
                  ${contentHtml}
                </div>
              </div>
            `;
            } else {
              // AI消息显示发送者名字
              const char = characters.find((c) => c.id === msg.charId);
              const charName = char ? char.note || char.name : "成员";
              const charAvatar = char?.avatar;

              // 处理表情包标签 - 使用该角色绑定的表情包
              let contentHtml = escapeHtml(msg.content);
              if (msg.content) {
                contentHtml = processGroupStickerTags(msg.content, msg.charId);
              }

              // 检测是否是表情包消息
              const isSticker =
                /^\[(sticker|表情|表情包)[：:][^\]]+\]$/i.test(
                  msg.content.trim()
                ) || contentHtml.includes('class="sticker-img"');

              return `
              <div class="msg-row ai group-msg"
                   data-index="${index}"
                   ontouchstart="handleGroupTouchStart(event, ${index})"
                   ontouchmove="handleGroupTouchMove(event)"
                   ontouchend="handleGroupTouchEnd(event)"
                   onmousedown="handleGroupMouseDown(event, ${index})"
                   onmouseup="handleGroupMouseUp(event)">
                <div class="msg-sender-avatar">
                  ${
                    charAvatar
                      ? `<img src="${charAvatar}">`
                      : charName.charAt(0)
                  }
                </div>
                <div class="msg-sender-name">${charName}</div>
                <div class="msg-bubble${
                  isSticker ? " sticker-bubble" : ""
                }">${contentHtml}</div>
                <div class="msg-time">${msg.time || ""}</div>
              </div>
            `;
            }
          })
          .join("");

        container.scrollTop = container.scrollHeight;

        // 应用群聊样式
        if (typeof applyGroupChatStyle === "function") {
          applyGroupChatStyle();
        }
      }

      // 处理群聊中的表情包标签（使用角色绑定的表情包）
      function processGroupStickerTags(text, charId) {
        if (!text) return escapeHtml(text);

        // 匹配 [sticker:xxx] 或 [表情:xxx] 或 [表情包:xxx] 格式
        const stickerPattern = /\[(sticker|表情|表情包)[：:]\s*([^\]]+)\]/gi;

        // 检查是否有表情包
        if (!stickerPattern.test(text)) {
          return escapeHtml(text);
        }

        // 提取纯文字（移除所有表情包标签）
        const pureText = text
          .replace(/\[(sticker|表情|表情包)[：:]\s*([^\]]+)\]/gi, "")
          .trim();

        // 处理表情包 - 使用新的正则实例
        const processedStickers = [];
        const stickerRegex = /\[(sticker|表情|表情包)[：:]\s*([^\]]+)\]/gi;
        let match;
        while ((match = stickerRegex.exec(text)) !== null) {
          const keyword = match[2];

          // 获取该角色绑定的表情包
          const charIdStr = charId ? String(charId) : "__global__";
          const boundCategories = window.aiStickerBindings
            ? window.aiStickerBindings[charIdStr] || []
            : [];

          let charStickers = [];
          if (boundCategories.length > 0 && window.customStickers) {
            charStickers = window.customStickers.filter((stk) =>
              boundCategories.includes(stk.category)
            );
          }

          if (
            charStickers.length === 0 &&
            window.customStickers &&
            window.customStickers.length > 0
          ) {
            charStickers = window.customStickers;
          }

          if (charStickers.length > 0) {
            const keywordTrim = keyword.trim().toLowerCase();
            let sticker = charStickers.find(
              (s) => s.desc && s.desc.toLowerCase() === keywordTrim
            );
            if (!sticker) {
              sticker = charStickers.find(
                (s) => s.desc && s.desc.toLowerCase().includes(keywordTrim)
              );
            }
            if (!sticker) {
              sticker =
                charStickers[Math.floor(Math.random() * charStickers.length)];
            }
            if (sticker) {
              processedStickers.push(
                `<img src="${sticker.src}" class="sticker-img" alt="${
                  sticker.desc || "表情"
                }" onclick="showFullImage('${sticker.src}')">`
              );
            }
          }
        }

        // 组合输出
        let result = "";
        if (pureText && processedStickers.length > 0) {
          // 有文字也有表情包：文字在上，表情包在下（分开显示）
          result = `<div style="margin-bottom:8px;">${escapeHtml(
            pureText
          )}</div>${processedStickers.join("")}`;
        } else if (pureText) {
          // 只有文字
          result = escapeHtml(pureText);
        } else if (processedStickers.length > 0) {
          // 只有表情包
          result = processedStickers.join("");
        } else {
          result = escapeHtml(text);
        }

        return result;
      }

      // ==================== 群聊长按菜单功能 ====================
      var groupLongPressTimer = null;
      var groupTouchStartX = 0;
      var groupTouchStartY = 0;
      var activeGroupMsgIndex = null;

      function handleGroupTouchStart(e, index) {
        groupTouchStartX = e.touches[0].clientX;
        groupTouchStartY = e.touches[0].clientY;
        groupLongPressTimer = setTimeout(() => {
          showGroupContextMenu(
            e.touches[0].clientX,
            e.touches[0].clientY,
            index
          );
        }, 500);
      }

      function handleGroupTouchMove(e) {
        if (!groupLongPressTimer) return;
        let moveX = e.touches[0].clientX;
        let moveY = e.touches[0].clientY;
        if (
          Math.abs(moveX - groupTouchStartX) > 10 ||
          Math.abs(moveY - groupTouchStartY) > 10
        ) {
          clearTimeout(groupLongPressTimer);
          groupLongPressTimer = null;
        }
      }

      function handleGroupTouchEnd(e) {
        if (groupLongPressTimer) {
          clearTimeout(groupLongPressTimer);
          groupLongPressTimer = null;
        }
      }

      function handleGroupMouseDown(e, index) {
        groupLongPressTimer = setTimeout(() => {
          showGroupContextMenu(e.clientX, e.clientY, index);
        }, 500);
      }

      function handleGroupMouseUp(e) {
        if (groupLongPressTimer) {
          clearTimeout(groupLongPressTimer);
          groupLongPressTimer = null;
        }
      }

      async function showGroupContextMenu(x, y, index) {
        if (navigator.vibrate) navigator.vibrate(50);

        activeGroupMsgIndex = index;
        const overlay = document.getElementById("contextMenuOverlay");
        const menu = document.getElementById("contextMenu");

        // 获取群聊消息
        const messagesKey = `group_messages_${currentGroupId}`;
        const messages = (await localforage.getItem(messagesKey)) || [];
        const msg = messages[index];
        if (!msg) return;

        const isUser = msg.role === "user";

        // 构建菜单内容
        let menuHtml = `<div class="menu-item" onclick="handleGroupCopyMsg()">复制</div>`;

        if (isUser) {
          menuHtml += `<div class="menu-item" onclick="handleGroupRecallMsg()">撤回</div>`;
        }

        menuHtml += `
          <div class="menu-item" onclick="handleGroupEditMsg()">编辑</div>
          <div class="menu-item" onclick="handleGroupMultiSelect()">多选</div>
          <div class="menu-item danger" onclick="handleGroupDeleteMsg()">删除</div>
        `;

        menu.innerHTML = menuHtml;
        menu.style.left = "";
        menu.style.top = "";
        menu.classList.remove("arrow-top");

        overlay.classList.add("active");
        setTimeout(() => menu.classList.add("show"), 10);
      }

      // 群聊复制消息
      async function handleGroupCopyMsg() {
        const messagesKey = `group_messages_${currentGroupId}`;
        const messages = (await localforage.getItem(messagesKey)) || [];
        const msg = messages[activeGroupMsgIndex];
        if (!msg) return;

        let textToCopy = msg.content;
        // 移除HTML标签
        textToCopy = textToCopy.replace(/<[^>]*>/g, "").trim();

        if (navigator.clipboard) {
          navigator.clipboard.writeText(textToCopy);
          showToast("已复制");
        }
        hideContextMenu();
      }

      // 群聊撤回消息
      async function handleGroupRecallMsg() {
        const messagesKey = `group_messages_${currentGroupId}`;
        const messages = (await localforage.getItem(messagesKey)) || [];
        const msg = messages[activeGroupMsgIndex];
        if (!msg || msg.role !== "user") return;

        // 替换为撤回提示
        messages[activeGroupMsgIndex] = {
          role: "system",
          content: "你撤回了一条消息",
          time: msg.time,
        };

        await localforage.setItem(messagesKey, messages);
        loadGroupMessages(currentGroupId);
        hideContextMenu();
        showToast("消息已撤回");
      }

      // 群聊编辑消息
      async function handleGroupEditMsg() {
        const messagesKey = `group_messages_${currentGroupId}`;
        const messages = (await localforage.getItem(messagesKey)) || [];
        const msg = messages[activeGroupMsgIndex];
        if (!msg) return;

        let content = msg.content;
        // 如果是HTML，提取文本
        if (msg.isHtml) {
          content = content.replace(/<[^>]*>/g, "").trim();
        }

        const newContent = prompt("编辑消息：", content);
        if (newContent === null) {
          hideContextMenu();
          return;
        }

        messages[activeGroupMsgIndex].content = newContent;
        messages[activeGroupMsgIndex].isHtml = false;

        await localforage.setItem(messagesKey, messages);
        loadGroupMessages(currentGroupId);
        hideContextMenu();
        showToast("消息已编辑");
      }

      // 群聊删除消息
      async function handleGroupDeleteMsg() {
        if (!confirm("确定删除这条消息？")) {
          hideContextMenu();
          return;
        }

        const messagesKey = `group_messages_${currentGroupId}`;
        const messages = (await localforage.getItem(messagesKey)) || [];
        messages.splice(activeGroupMsgIndex, 1);

        await localforage.setItem(messagesKey, messages);
        loadGroupMessages(currentGroupId);
        hideContextMenu();
        showToast("消息已删除");
      }

      // ==================== 群聊多选功能 ====================
      var isGroupSelectionMode = false;
      var groupSelectedIndices = new Set();

      function handleGroupMultiSelect() {
        hideContextMenu();
        isGroupSelectionMode = true;
        groupSelectedIndices.clear();
        groupSelectedIndices.add(activeGroupMsgIndex);

        // 隐藏输入框，显示选择工具栏
        document.querySelector(".conv-input-area").style.display = "none";
        showGroupSelectionToolbar();

        renderGroupSelectionMode();
      }

      async function renderGroupSelectionMode() {
        const messagesKey = `group_messages_${currentGroupId}`;
        const messages = (await localforage.getItem(messagesKey)) || [];
        const container = document.getElementById("convMessages");

        const globalUserAvatar = localStorage.getItem("avatarImg");
        const group = groupChats.find((g) => g.id === currentGroupId);
        const groupSettings = group?.settings || {};
        const userAvatar = groupSettings.userAvatar || globalUserAvatar || "";

        container.innerHTML = messages
          .map((msg, index) => {
            if (msg.role === "system") {
              return `
              <div class="msg-row system" style="text-align:center;margin:8px 0;">
                <div style="display:inline-block;padding:4px 12px;background:rgba(0,0,0,0.05);border-radius:12px;font-size:0.75rem;color:#999;">
                  ${escapeHtml(msg.content)}
                </div>
              </div>
            `;
            }

            const isSelected = groupSelectedIndices.has(index);
            const isUser = msg.role === "user";
            const isHtmlMsg = msg.isHtml === true;
            const contentHtml = isHtmlMsg
              ? msg.content
              : escapeHtml(msg.content);
            const isSticker =
              isHtmlMsg && msg.content.includes('class="sticker-img"');

            // 选择器HTML - 和单聊一样的样式
            const selectorHtml = `
            <div class="bubble-selector ${isSelected ? "selected" : ""}" 
                 onclick="event.stopPropagation();toggleGroupMessageSelection(${index})">
              <div class="bubble-selector-inner">
                ${
                  isSelected
                    ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>'
                    : ""
                }
              </div>
            </div>
          `;

            if (isUser) {
              const bubbleHtml = `
              <div class="msg-bubble${isSticker ? " sticker-bubble" : ""}${
                isSelected ? " selected" : ""
              }"
                   data-index="${index}"
                   onclick="toggleGroupMessageSelection(${index})">
                ${contentHtml}
              </div>
            `;
              return `
              <div class="msg-row user group-msg" data-index="${index}">
                <div class="bubble-with-selector user">
                  ${selectorHtml}
                  ${bubbleHtml}
                </div>
                <div class="msg-time">${msg.time || ""}</div>
                <div class="msg-user-avatar">
                  ${userAvatar ? `<img src="${userAvatar}">` : "我"}
                </div>
              </div>
            `;
            } else {
              const char = characters.find((c) => c.id === msg.charId);
              const charName = char ? char.note || char.name : "成员";
              const charAvatar = char?.avatar;
              let aiContentHtml = escapeHtml(msg.content);
              if (msg.content) {
                aiContentHtml = processGroupStickerTags(
                  msg.content,
                  msg.charId
                );
              }
              const aiIsSticker =
                /^\[(sticker|表情|表情包)[：:][^\]]+\]$/i.test(
                  msg.content.trim()
                ) || aiContentHtml.includes('class="sticker-img"');

              const bubbleHtml = `
              <div class="msg-bubble${aiIsSticker ? " sticker-bubble" : ""}${
                isSelected ? " selected" : ""
              }"
                   data-index="${index}"
                   onclick="toggleGroupMessageSelection(${index})">
                ${aiContentHtml}
              </div>
            `;
              return `
              <div class="msg-row ai group-msg" data-index="${index}">
                <div class="bubble-with-selector ai">
                  ${selectorHtml}
                  <div class="msg-sender-avatar">
                    ${
                      charAvatar
                        ? `<img src="${charAvatar}">`
                        : charName.charAt(0)
                    }
                  </div>
                </div>
                <div style="flex:1;">
                  <div class="msg-sender-name">${charName}</div>
                  ${bubbleHtml}
                </div>
                <div class="msg-time">${msg.time || ""}</div>
              </div>
            `;
            }
          })
          .join("");

        updateGroupSelectionUI();
        container.scrollTop = container.scrollHeight;
      }

      function toggleGroupMessageSelection(index) {
        if (!isGroupSelectionMode) return;
        if (groupSelectedIndices.has(index)) {
          groupSelectedIndices.delete(index);
        } else {
          groupSelectedIndices.add(index);
        }
        renderGroupSelectionMode();
      }

      function showGroupSelectionToolbar() {
        let toolbar = document.getElementById("groupSelectionToolbar");
        if (!toolbar) {
          toolbar = document.createElement("div");
          toolbar.id = "groupSelectionToolbar";
          toolbar.className = "selection-footer";
          document.body.appendChild(toolbar);
        }

        toolbar.innerHTML = `
          <button class="selection-footer-btn" onclick="exitGroupSelectionMode()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            取消
          </button>
          <span class="selection-footer-count" id="groupSelectionCount">已选 0 条</span>
          <button class="selection-footer-btn danger" onclick="deleteGroupSelectedMessages()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            删除
          </button>
        `;
        toolbar.classList.add("active");
      }

      function updateGroupSelectionUI() {
        const countEl = document.getElementById("groupSelectionCount");
        if (countEl) {
          countEl.textContent = `已选 ${groupSelectedIndices.size} 条`;
        }
      }

      function exitGroupSelectionMode() {
        isGroupSelectionMode = false;
        groupSelectedIndices.clear();

        const toolbar = document.getElementById("groupSelectionToolbar");
        if (toolbar) toolbar.classList.remove("active");

        document.querySelector(".conv-input-area").style.display = "block";
        loadGroupMessages(currentGroupId);
      }

      async function deleteGroupSelectedMessages() {
        if (groupSelectedIndices.size === 0) {
          showToast("请选择要删除的消息");
          return;
        }

        if (!confirm(`确定删除选中的 ${groupSelectedIndices.size} 条消息？`))
          return;

        const messagesKey = `group_messages_${currentGroupId}`;
        const messages = (await localforage.getItem(messagesKey)) || [];

        // 从后往前删除，避免索引变化
        const sortedIndices = Array.from(groupSelectedIndices).sort(
          (a, b) => b - a
        );
        sortedIndices.forEach((idx) => {
          messages.splice(idx, 1);
        });

        await localforage.setItem(messagesKey, messages);
        showToast(`已删除 ${groupSelectedIndices.size} 条消息`);
        exitGroupSelectionMode();
      }

      // 群聊发送消息
      async function sendGroupMessage(content, autoReply = false) {
        if (!currentGroupId) return;

        // 如果不是自动回复模式，需要有内容
        if (!autoReply && !content.trim()) return;

        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;

        const messagesKey = `group_messages_${currentGroupId}`;
        const messages = (await localforage.getItem(messagesKey)) || [];

        // 如果有用户消息内容，添加用户消息
        if (content && content.trim()) {
          const userMsg = {
            role: "user",
            content: content.trim(),
            time: new Date().toLocaleTimeString("zh-CN", {
              hour: "2-digit",
              minute: "2-digit",
            }),
          };
          messages.push(userMsg);
          await localforage.setItem(messagesKey, messages);

          // 重新渲染
          loadGroupMessages(currentGroupId);

          // 更新群聊最后消息
          group.lastMessage = content.trim().substring(0, 30);
          group.lastTime = "刚刚";
          await localforage.setItem("groupChats", groupChats);
          renderCharacters();
        }

        // 如果是自动回复模式（通话结束后），触发AI回复
        if (autoReply) {
          await requestGroupAIReply("(请根据刚才的通话内容自然地继续对话)");
        }

        // 不再自动触发AI回复，需要用户手动点击生成回复按钮
      }

      // 群聊AI回复（让AI一次性扮演所有角色）
      async function requestGroupAIReply(userMessage) {
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group || group.members.length === 0) return;

        const preset = apiPresets.find((p) => p.id == activePresetId);
        if (!preset || !preset.url || !preset.key) {
          showToast("请先配置API预设");
          return;
        }

        // 显示正在输入指示器
        const container = document.getElementById("convMessages");
        const typingHtml = `
          <div class="msg-row ai" id="groupTypingIndicator">
            <div class="msg-bubble">
              <div class="msg-typing"><span></span><span></span><span></span></div>
            </div>
          </div>`;
        container.insertAdjacentHTML("beforeend", typingHtml);
        container.scrollTop = container.scrollHeight;

        try {
          // 获取群聊设置
          const groupSettings = group.settings || {};
          const userNickname = groupSettings.myNickname || "我";
          const userPersona = groupSettings.myPersona || "";
          const currentTime = new Date().toLocaleString("zh-CN");

          // 构建群成员列表及人设
          const memberInfos = group.members
            .map((id) => {
              const c = characters.find((ch) => ch.id === id);
              if (!c) return null;
              const s = chatSettings[c.id] || {};
              // 获取该角色绑定的表情包
              const charIdStr = String(c.id);
              const boundCategories = window.aiStickerBindings
                ? window.aiStickerBindings[charIdStr] || []
                : [];
              let charStickers = [];
              if (boundCategories.length > 0 && window.customStickers) {
                charStickers = window.customStickers
                  .filter((stk) => boundCategories.includes(stk.category))
                  .map((stk) => stk.desc || "表情");
              }
              return {
                id: c.id,
                name: s.charName || c.name,
                displayName: c.note || c.name,
                persona: s.persona || c.description || "暂无人设",
                stickers: charStickers,
              };
            })
            .filter(Boolean);

          const membersList = memberInfos
            .map((m) => `- **${m.displayName}**: ${m.persona}`)
            .join("\n");

          // 构建表情包提示（每个角色可用的表情包）
          let stickerPrompt = "";
          const membersWithStickers = memberInfos.filter(
            (m) => m.stickers && m.stickers.length > 0
          );
          if (membersWithStickers.length > 0) {
            stickerPrompt = `\n\n# 【表情包功能】
每个角色可以使用自己绑定的表情包来表达情绪。使用格式：[sticker:表情名称]
各角色可用的表情包：
${membersWithStickers
  .map(
    (m) =>
      `- **${m.displayName}**: ${m.stickers.slice(0, 10).join("、")}${
        m.stickers.length > 10 ? "等" : ""
      }`
  )
  .join("\n")}

注意：
- 表情包是独立的消息，不要和文字混在同一条content里
- 要发表情包时，content字段只填表情包标签，如：{"name": "角色A", "content": "[sticker:开心]"}
- 不要过度使用表情包，适当点缀即可`;
          }

          // 构建群聊系统提示
          let systemPrompt = `# 角色
你是一个群聊AI，负责扮演【除了用户以外】的所有角色。

# 【对话节奏规则】
你的回复【必须】模拟真人的打字和思考习惯。不要一次性发送一大段文字，你应该将你想说的话，拆分成【多条、简短的】消息来发送，每条消息最好不要超过50个字。
**角色回复顺序不固定，可以交叉回复，例如角色A、角色B、角色B、角色A这样的交叉顺序。不一定要一个人全部说完了才轮到下一个人。角色之间【必须】有互动对话。**

# 【身份规则】
1. **核心任务**: 你的唯一任务是扮演下方"群成员列表"中的角色。
2. **用户识别**: 用户的身份是【${userNickname}】。你【绝对不能】生成用户的消息。
3. **禁止杜撰**: 【绝对禁止】扮演任何未在"群成员列表"中出现的角色。
4. **【格式规则】**:
   - 你的回复【必须且只能】是一个严格的JSON数组格式。
   - 数组中的每一个元素都必须是一个JSON对象，包含 "name" 和 "content" 字段。
   - "name" 字段的值必须是下方列表中角色的名字。
5. **角色扮演**: 严格遵守每个角色的人设，保持各自的说话风格和性格特点。
6. **禁止出戏**: 绝不能透露你是AI，保持自然的聊天氛围。
7. **时间感知**: 当前时间是 ${currentTime}。

# 群成员列表及人设
${membersList}

# 用户信息
- **${userNickname}**: ${userPersona || "群主"}
${stickerPrompt}

# 输出格式示例
你必须严格按照以下JSON数组格式回复，不要添加任何其他文字：
[
  {"name": "角色A", "content": "这是角色A说的话"},
  {"name": "角色B", "content": "角色B的回应"},
  {"name": "角色A", "content": "[sticker:开心]"},
  {"name": "角色C", "content": "角色C也加入讨论"}
]

注意：
- 必须生成3-8条消息，让对话活跃起来
- 角色之间要有互动，可以互相回应、调侃、讨论
- 每条消息要简短自然，像真实群聊一样
- 只输出JSON数组，不要有任何前缀或后缀文字`;

          // 获取群聊历史消息作为上下文
          const messagesKey = `group_messages_${group.id}`;
          let groupHistory = (await localforage.getItem(messagesKey)) || [];
          const contextCount = groupSettings.contextCount || 20;
          // 过滤掉隐藏消息和通话卡片，只保留正常对话
          groupHistory = groupHistory
            .filter((msg) => !msg.isHidden && !msg.isCallCard)
            .slice(-contextCount);

          // 构建对话历史文本
          let historyText = "";
          groupHistory.forEach((msg) => {
            if (msg.role === "user" && !msg.isHtml) {
              historyText += `[${userNickname}]: ${msg.content}\n`;
            } else if (msg.role === "assistant") {
              const sender = characters.find((c) => c.id === msg.charId);
              const senderName = sender ? sender.note || sender.name : "成员";
              historyText += `[${senderName}]: ${msg.content}\n`;
            }
          });

          // 处理记忆互通（支持单聊和其他群聊）
          const memoryLinkCount = groupSettings.memoryLinkCount || 5;
          const linkedIds =
            groupSettings.memoryLinks ||
            (groupSettings.memoryLink
              ? [parseInt(groupSettings.memoryLink)]
              : []);

          let memoryLinkContent = "";
          if (linkedIds.length > 0 && memoryLinkCount > 0) {
            let allLinkedContent = [];
            for (const linkId of linkedIds) {
              // 判断是其他群聊还是单聊
              if (typeof linkId === "string" && linkId.startsWith("group_")) {
                // 其他群聊
                const otherGroupId = parseInt(linkId.replace("group_", ""));
                const otherGroup = groupChats.find(
                  (g) => g.id === otherGroupId
                );
                if (otherGroup) {
                  try {
                    const otherMessagesKey = `group_messages_${otherGroupId}`;
                    const otherMessages =
                      (await localforage.getItem(otherMessagesKey)) || [];
                    const recentMessages = otherMessages
                      .filter((m) => !m.isHidden && !m.isCallCard)
                      .slice(-memoryLinkCount);

                    if (recentMessages.length > 0) {
                      const otherSettings = otherGroup.settings || {};
                      const otherUserNickname =
                        otherSettings.myNickname || "用户";

                      let singleLinkContent = `群聊「${
                        otherGroup.name || "群聊"
                      }」的对话：\n`;
                      recentMessages.forEach((msg) => {
                        if (msg.role === "user") {
                          singleLinkContent += `${otherUserNickname}: ${(
                            msg.content || ""
                          ).replace(/<[^>]*>/g, "")}\n`;
                        } else {
                          const msgChar = characters.find(
                            (c) => c.id === msg.charId
                          );
                          const msgCharName = msgChar
                            ? msgChar.note || msgChar.name
                            : "成员";
                          singleLinkContent += `${msgCharName}: ${(
                            msg.content || ""
                          ).replace(/<[^>]*>/g, "")}\n`;
                        }
                      });
                      allLinkedContent.push(singleLinkContent);
                    }
                  } catch (e) {
                    console.warn("读取其他群聊消息失败:", e);
                  }
                }
              } else {
                // 单聊
                const linkedCharId = linkId;
                if (linkedCharId && chatHistories[linkedCharId]) {
                  const linkedHistory = chatHistories[linkedCharId].slice(
                    -memoryLinkCount
                  );
                  const linkedChar = characters.find(
                    (c) => c.id === linkedCharId
                  );
                  const linkedCharName = linkedChar
                    ? linkedChar.note || linkedChar.name
                    : "角色";
                  if (linkedHistory.length > 0) {
                    let singleLinkContent = `与「${linkedCharName}」的聊天：\n`;
                    linkedHistory.forEach((msg) => {
                      if (msg.role === "user") {
                        singleLinkContent += `${userNickname}: ${msg.content}\n`;
                      } else if (msg.role === "assistant") {
                        singleLinkContent += `${linkedCharName}: ${msg.content}\n`;
                      }
                    });
                    allLinkedContent.push(singleLinkContent);
                  }
                }
              }
            }
            if (allLinkedContent.length > 0) {
              memoryLinkContent = `\n# 记忆互通（用户的其他聊天记录）\n${allLinkedContent.join(
                "\n"
              )}\n`;
            }
          }

          if (memoryLinkContent) {
            systemPrompt += memoryLinkContent;
          }

          // 构建消息数组
          const messages = [{ role: "system", content: systemPrompt }];

          if (historyText) {
            messages.push({
              role: "system",
              content: `# 群聊历史记录\n${historyText}`,
            });
          }

          messages.push({
            role: "user",
            content: `[${userNickname}]: ${userMessage}\n\n请以JSON数组格式回复，让群成员们对这条消息做出反应和互动：`,
          });

          // 调用API
          let apiUrl = preset.url.replace(/\/$/, "");
          if (!apiUrl.endsWith("/chat/completions")) {
            if (apiUrl.endsWith("/v1")) {
              apiUrl += "/chat/completions";
            } else if (!apiUrl.includes("/chat/completions")) {
              apiUrl += "/v1/chat/completions";
            }
          }

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${preset.key}`,
            },
            body: JSON.stringify({
              model: preset.model || "gpt-3.5-turbo",
              messages: messages,
              max_tokens: 1500,
              temperature:
                preset.temperature !== undefined
                  ? Number(preset.temperature)
                  : 0.9,
            }),
          });

          if (!response.ok) {
            // 尝试获取详细错误信息
            let errorDetail = `HTTP ${response.status}`;
            try {
              const errorData = await response.json();
              if (errorData.error) {
                errorDetail =
                  errorData.error.message ||
                  errorData.error.code ||
                  JSON.stringify(errorData.error);
              } else if (errorData.message) {
                errorDetail = errorData.message;
              }
            } catch (e) {
              // 无法解析JSON，使用状态码
            }
            throw new Error(errorDetail);
          }

          const data = await response.json();

          // 移除输入指示器
          const typingIndicator = document.getElementById(
            "groupTypingIndicator"
          );
          if (typingIndicator) typingIndicator.remove();

          if (data.choices && data.choices[0]) {
            let replyText = data.choices[0].message.content.trim();

            // 尝试提取JSON数组
            let jsonMatch = replyText.match(/\[[\s\S]*\]/);
            if (jsonMatch) {
              replyText = jsonMatch[0];
            }

            try {
              const repliesArray = JSON.parse(replyText);

              if (Array.isArray(repliesArray) && repliesArray.length > 0) {
                const currentMessages =
                  (await localforage.getItem(messagesKey)) || [];
                let lastCharName = "";
                let lastContent = "";
                let hasValidMessage = false;

                for (let i = 0; i < repliesArray.length; i++) {
                  const reply = repliesArray[i];

                  // 兼容多种字段名：content, message, text
                  const replyContent =
                    reply.content || reply.message || reply.text || "";
                  const replyName =
                    reply.name || reply.sender || reply.character || "";

                  if (!replyName || !replyContent) {
                    console.warn("跳过无效消息:", reply);
                    continue;
                  }

                  // 查找对应的角色（更宽松的匹配）
                  const matchedMember = memberInfos.find(
                    (m) =>
                      m.displayName === replyName ||
                      m.name === replyName ||
                      m.displayName.includes(replyName) ||
                      replyName.includes(m.displayName)
                  );

                  if (!matchedMember) {
                    console.warn(
                      `未找到角色: ${replyName}，尝试使用第一个成员`
                    );
                    // 如果找不到匹配的成员，使用第一个成员
                    const fallbackMember = memberInfos[0];
                    if (fallbackMember && replyContent.trim()) {
                      currentMessages.push({
                        role: "assistant",
                        charId: fallbackMember.id,
                        content: replyContent.trim(),
                        time: new Date().toLocaleTimeString("zh-CN", {
                          hour: "2-digit",
                          minute: "2-digit",
                        }),
                      });
                      lastCharName = fallbackMember.displayName;
                      lastContent = replyContent.trim();
                      hasValidMessage = true;
                    }
                    continue;
                  }

                  // 添加消息
                  currentMessages.push({
                    role: "assistant",
                    charId: matchedMember.id,
                    content: replyContent.trim(),
                    time: new Date().toLocaleTimeString("zh-CN", {
                      hour: "2-digit",
                      minute: "2-digit",
                    }),
                  });

                  lastCharName = matchedMember.displayName;
                  lastContent = replyContent.trim();
                  hasValidMessage = true;

                  // 保存并渲染
                  await localforage.setItem(messagesKey, currentMessages);
                  loadGroupMessages(currentGroupId);

                  // 延迟显示下一条，模拟真实聊天
                  if (i < repliesArray.length - 1) {
                    await new Promise((r) =>
                      setTimeout(r, 600 + Math.random() * 800)
                    );
                  }
                }

                // 更新群聊最后消息
                if (hasValidMessage && lastCharName && lastContent) {
                  group.lastMessage = `${lastCharName}: ${lastContent.substring(
                    0,
                    20
                  )}`;
                  group.lastTime = "刚刚";
                  await localforage.setItem("groupChats", groupChats);
                  renderCharacters();
                }

                // 如果没有有效消息，使用回退处理
                if (!hasValidMessage) {
                  throw new Error("没有解析到有效消息");
                }
              } else {
                throw new Error("回复数组为空");
              }
            } catch (parseError) {
              console.error(
                "解析群聊回复JSON失败:",
                parseError,
                "原始回复:",
                replyText
              );
              // 回退处理：如果JSON解析失败，尝试作为普通文本处理
              const firstMember = memberInfos[0];
              if (firstMember && replyText.trim()) {
                const currentMessages =
                  (await localforage.getItem(messagesKey)) || [];
                // 清理可能的JSON残留符号
                let cleanText = replyText.replace(/^\[|\]$/g, "").trim();
                cleanText = cleanText
                  .replace(/^\{.*?"content"\s*:\s*"?|"?\s*\}$/g, "")
                  .trim();
                cleanText = cleanText.replace(/^["']|["']$/g, "").trim();

                if (cleanText) {
                  currentMessages.push({
                    role: "assistant",
                    charId: firstMember.id,
                    content: cleanText,
                    time: new Date().toLocaleTimeString("zh-CN", {
                      hour: "2-digit",
                      minute: "2-digit",
                    }),
                  });
                  await localforage.setItem(messagesKey, currentMessages);
                  loadGroupMessages(currentGroupId);

                  // 更新最后消息
                  group.lastMessage = `${
                    firstMember.displayName
                  }: ${cleanText.substring(0, 20)}`;
                  group.lastTime = "刚刚";
                  await localforage.setItem("groupChats", groupChats);
                  renderCharacters();
                }
              }
            }
          } else {
            console.error("API返回无效响应:", data);
            showToast("AI返回了空响应");
          }
        } catch (e) {
          console.error("群聊AI回复失败:", e);
          showToast("AI回复失败: " + (e.message || "请检查API配置"));
          const typingIndicator = document.getElementById(
            "groupTypingIndicator"
          );
          if (typingIndicator) typingIndicator.remove();
        }
      }

      // 获取群成员的AI回复（保留用于兼容）
      async function getGroupMemberReply(char, userMessage, group) {
        const preset = apiPresets.find((p) => p.id == activePresetId);
        if (!preset || !preset.url || !preset.key) {
          return `[${char.note || char.name}]：API未配置，无法回复`;
        }

        // 获取该角色的个人设置（人设等）
        const charSettings = chatSettings[char.id] || {};
        const charName = charSettings.charName || char.name;
        const charPersona = charSettings.persona || char.description || "";

        // 获取群聊设置
        const groupSettings = group.settings || {};
        const userNickname = groupSettings.myNickname || "用户";
        const userPersona = groupSettings.myPersona || "";

        // 获取所有群成员信息
        const memberInfos = group.members
          .map((id) => {
            const c = characters.find((ch) => ch.id === id);
            if (!c) return null;
            const s = chatSettings[c.id] || {};
            return {
              id: c.id,
              name: s.charName || c.name,
              displayName: c.note || c.name,
              persona: s.persona || c.description || "",
            };
          })
          .filter(Boolean);

        const memberNames = memberInfos.map((m) => m.displayName).join("、");

        // 构建群聊系统提示 - 严格遵循人设
        let systemPrompt = `【角色设定】
你是「${charName}」，正在一个群聊中参与对话。

【你的人设 - 必须严格遵守】
${charPersona || `你是${charName}，性格友好，说话自然。`}

【群聊信息】
- 群名：${group.name}
- 群成员：${memberNames}

【用户信息】
- 用户昵称：${userNickname}
${userPersona ? `- 用户人设：${userPersona}` : ""}

【其他群成员的人设参考】
${memberInfos
  .filter((m) => m.id !== char.id)
  .map((m) => `- ${m.displayName}：${m.persona || "暂无人设"}`)
  .join("\n")}

【回复规则 - 必须遵守】
1. 你必须始终以「${charName}」的身份和人设回复，不可偏离角色
2. 保持你的性格特点、说话风格、口头禅等
3. 回复要简短自然，像真实群聊一样（通常1-3句话）
4. 可以与其他成员互动，也可以只回复用户
5. 不要使用过于正式的语言，保持轻松的群聊氛围
6. 不要在回复中标注自己的名字或身份`;

        // 加入时间感知
        if (groupSettings.timeAware !== false) {
          systemPrompt += `\n\n【当前时间】${new Date().toLocaleString(
            "zh-CN"
          )}`;
        }

        // 获取群聊历史消息作为上下文
        const messagesKey = `group_messages_${group.id}`;
        let groupHistory = (await localforage.getItem(messagesKey)) || [];
        const contextCount = groupSettings.contextCount || 20;
        groupHistory = groupHistory.slice(-contextCount);

        // 构建对话历史
        const conversationHistory = groupHistory
          .map((msg) => {
            if (msg.role === "user") {
              return {
                role: "user",
                content: `[${userNickname}]: ${msg.content}`,
              };
            } else if (msg.role === "assistant") {
              const sender = characters.find((c) => c.id === msg.charId);
              const senderName = sender ? sender.note || sender.name : "成员";
              return {
                role: "assistant",
                content: `[${senderName}]: ${msg.content}`,
              };
            } else if (msg.role === "system") {
              return { role: "system", content: msg.content };
            }
            return null;
          })
          .filter(Boolean);

        // 处理记忆互通（支持多选，包括单聊和其他群聊）
        let memoryLinkContent = "";
        const memoryLinkCount = groupSettings.memoryLinkCount || 5;

        // 优先使用新的多选数组，兼容旧的单选
        const linkedIds =
          groupSettings.memoryLinks ||
          (groupSettings.memoryLink
            ? [parseInt(groupSettings.memoryLink)]
            : []);

        if (linkedIds.length > 0 && memoryLinkCount > 0) {
          let allLinkedContent = [];

          for (const linkId of linkedIds) {
            // 判断是其他群聊还是单聊
            if (typeof linkId === "string" && linkId.startsWith("group_")) {
              // 其他群聊
              const otherGroupId = parseInt(linkId.replace("group_", ""));
              const otherGroup = groupChats.find((g) => g.id === otherGroupId);
              if (otherGroup) {
                try {
                  const otherMessagesKey = `group_messages_${otherGroupId}`;
                  const otherMessages =
                    (await localforage.getItem(otherMessagesKey)) || [];
                  const recentMessages = otherMessages
                    .filter((m) => !m.isHidden && !m.isCallCard)
                    .slice(-memoryLinkCount);

                  if (recentMessages.length > 0) {
                    const otherSettings = otherGroup.settings || {};
                    const otherUserNickname =
                      otherSettings.myNickname || "用户";

                    let singleLinkContent = `【群聊「${
                      otherGroup.name || "群聊"
                    }」的聊天记录】\n`;
                    recentMessages.forEach((msg) => {
                      if (msg.role === "user") {
                        singleLinkContent += `${otherUserNickname}: ${(
                          msg.content || ""
                        ).replace(/<[^>]*>/g, "")}\n`;
                      } else {
                        const msgChar = characters.find(
                          (c) => c.id === msg.charId
                        );
                        const msgCharName = msgChar
                          ? msgChar.note || msgChar.name
                          : "成员";
                        singleLinkContent += `${msgCharName}: ${(
                          msg.content || ""
                        ).replace(/<[^>]*>/g, "")}\n`;
                      }
                    });
                    allLinkedContent.push(singleLinkContent);
                  }
                } catch (e) {
                  console.warn("读取其他群聊消息失败:", e);
                }
              }
            } else {
              // 单聊
              const linkedCharId = linkId;
              if (linkedCharId && chatHistories[linkedCharId]) {
                const linkedHistory = chatHistories[linkedCharId].slice(
                  -memoryLinkCount
                );
                const linkedChar = characters.find(
                  (c) => c.id === linkedCharId
                );
                const linkedCharName = linkedChar
                  ? linkedChar.note || linkedChar.name
                  : "角色";

                if (linkedHistory.length > 0) {
                  let singleLinkContent = `【与「${linkedCharName}」的聊天记录】\n`;
                  linkedHistory.forEach((msg) => {
                    if (msg.role === "user") {
                      singleLinkContent += `${userNickname}: ${msg.content}\n`;
                    } else if (msg.role === "assistant") {
                      singleLinkContent += `${linkedCharName}: ${msg.content}\n`;
                    }
                  });
                  allLinkedContent.push(singleLinkContent);
                }
              }
            }
          }

          if (allLinkedContent.length > 0) {
            memoryLinkContent = `\n\n【记忆互通 - 共${allLinkedContent.length}个聊天记录】\n以下是用户的其他聊天记录，供你参考了解用户的近况：\n\n`;
            memoryLinkContent += allLinkedContent.join("\n");
            memoryLinkContent += `\n【记忆互通结束】\n`;
          }
        }

        if (memoryLinkContent) {
          systemPrompt += memoryLinkContent;
        }

        // 构建最终的消息数组
        const messages = [{ role: "system", content: systemPrompt }];

        // 添加历史对话
        if (conversationHistory.length > 0) {
          // 将历史消息合并为一条系统消息，提供上下文
          const historyText = conversationHistory
            .map((m) => m.content)
            .join("\n");
          messages.push({
            role: "system",
            content: `【群聊历史记录】\n${historyText}\n【历史记录结束】`,
          });
        }

        // 添加当前用户消息
        messages.push({
          role: "user",
          content: `[${userNickname}]: ${userMessage}\n\n请以「${charName}」的身份回复（直接输出回复内容，不要带角色名前缀）：`,
        });

        try {
          // 确保URL格式正确
          let apiUrl = preset.url.replace(/\/$/, "");
          if (!apiUrl.endsWith("/chat/completions")) {
            if (apiUrl.endsWith("/v1")) {
              apiUrl += "/chat/completions";
            } else if (!apiUrl.includes("/chat/completions")) {
              apiUrl += "/v1/chat/completions";
            }
          }

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${preset.key}`,
            },
            body: JSON.stringify({
              model: preset.model || "gpt-3.5-turbo",
              messages: messages,
              max_tokens: 300,
              temperature:
                preset.temperature !== undefined
                  ? Number(preset.temperature)
                  : 0.8,
            }),
          });

          const data = await response.json();
          if (data.choices && data.choices[0]) {
            let reply = data.choices[0].message.content;
            // 清理可能的角色名前缀
            reply = reply.replace(/^\[.*?\]:\s*/g, "").trim();
            reply = reply
              .replace(new RegExp(`^${charName}[：:]\s*`, "g"), "")
              .trim();
            return reply;
          }
        } catch (e) {
          console.error("群聊AI请求失败:", e);
        }
        return null;
      }

      // 打开添加群成员弹窗
      function openAddGroupMemberModal() {
        if (!currentGroupId) return;
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;

        tempAddMembers = [];
        document.getElementById("addGroupMemberModal").classList.add("active");
        renderAddMembersList(group);
      }

      // 关闭添加群成员弹窗
      function closeAddGroupMemberModal() {
        document
          .getElementById("addGroupMemberModal")
          .classList.remove("active");
        tempAddMembers = [];
      }

      // 渲染可添加的成员列表
      function renderAddMembersList(group) {
        const container = document.getElementById("addMembersList");
        const availableChars = characters.filter(
          (c) => !group.members.includes(c.id)
        );

        if (availableChars.length === 0) {
          container.innerHTML = `
            <div class="create-group-empty">
              <div class="create-group-empty-icon">🎉</div>
              <div>所有角色都已在群里啦</div>
            </div>
          `;
          return;
        }

        container.innerHTML = availableChars
          .map((char) => {
            const isSelected = tempAddMembers.includes(char.id);
            const displayName = char.note || char.name;
            return `
            <div class="create-group-member-item ${
              isSelected ? "selected" : ""
            }" onclick="toggleAddMember(${char.id})">
              <div class="create-group-member-avatar">
                ${
                  char.avatar
                    ? `<img src="${char.avatar}">`
                    : char.name.charAt(0)
                }
              </div>
              <div class="create-group-member-info">
                <div class="create-group-member-name">${displayName}</div>
              </div>
              <div class="create-group-member-check"></div>
            </div>
          `;
          })
          .join("");
      }

      // 切换添加成员选中状态
      function toggleAddMember(charId) {
        const index = tempAddMembers.indexOf(charId);
        if (index > -1) {
          tempAddMembers.splice(index, 1);
        } else {
          tempAddMembers.push(charId);
        }

        const group = groupChats.find((g) => g.id === currentGroupId);
        if (group) renderAddMembersList(group);

        document.getElementById(
          "addMembersCount"
        ).textContent = `已选 ${tempAddMembers.length} 人`;
        document.getElementById("addMemberConfirmBtn").disabled =
          tempAddMembers.length === 0;
      }

      // 确认添加群成员
      async function confirmAddGroupMembers() {
        if (tempAddMembers.length === 0 || !currentGroupId) return;

        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;

        group.members = [...group.members, ...tempAddMembers];
        await localforage.setItem("groupChats", groupChats);

        // 添加系统消息
        const messagesKey = `group_messages_${currentGroupId}`;
        const messages = (await localforage.getItem(messagesKey)) || [];
        const addedNames = tempAddMembers
          .map((id) => {
            const char = characters.find((c) => c.id === id);
            return char ? char.note || char.name : "成员";
          })
          .join("、");

        messages.push({
          role: "system",
          content: `${addedNames} 加入了群聊`,
          time: new Date().toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          }),
        });
        await localforage.setItem(messagesKey, messages);

        showToast(`已添加 ${tempAddMembers.length} 位成员`);
        closeAddGroupMemberModal();
        loadGroupMessages(currentGroupId);
        renderGroupSettingsMembers();
      }

      // 从群聊中移除成员
      async function removeGroupMember(charId) {
        if (!currentGroupId) return;
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;

        if (group.members.length <= 2) {
          alert("群聊至少需要2个成员");
          return;
        }

        const char = characters.find((c) => c.id === charId);
        const charName = char ? char.note || char.name : "成员";

        if (!confirm(`确定要将「${charName}」移出群聊吗？`)) return;

        group.members = group.members.filter((id) => id !== charId);
        await localforage.setItem("groupChats", groupChats);

        // 添加系统消息
        const messagesKey = `group_messages_${currentGroupId}`;
        const messages = (await localforage.getItem(messagesKey)) || [];
        messages.push({
          role: "system",
          content: `${charName} 离开了群聊`,
          time: new Date().toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          }),
        });
        await localforage.setItem(messagesKey, messages);

        showToast(`已移除 ${charName}`);
        loadGroupMessages(currentGroupId);
        renderGroupSettingsMembers();
      }

      // 解散群聊
      window.dissolveGroup = async function () {
        if (!currentGroupId) return;
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;

        if (!confirm(`确定要解散群聊「${group.name}」吗？聊天记录将被删除。`))
          return;

        // 删除聊天记录
        await localforage.removeItem(`group_messages_${currentGroupId}`);

        // 删除群聊
        groupChats = groupChats.filter((g) => g.id !== currentGroupId);
        await localforage.setItem("groupChats", groupChats);

        showToast("群聊已解散");
        closeGroupChatSettings();
        closeConversation();
        renderCharacters();
      };

      // 导出群聊聊天记录
      window.exportGroupChat = async function () {
        if (!currentGroupId) return;
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;

        const messagesKey = `group_messages_${currentGroupId}`;
        const messages = (await localforage.getItem(messagesKey)) || [];

        if (messages.length === 0) {
          showToast("没有聊天记录可导出");
          return;
        }

        // 导出包含群聊信息和消息
        const exportData = {
          type: "pinky_group_chat_export",
          version: 1,
          groupInfo: {
            name: group.name,
            avatar: group.avatar,
            members: group.members,
            settings: group.settings,
          },
          messages: messages,
          exportTime: new Date().toISOString(),
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `group-chat-${group.name || "export"}-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast("聊天记录已导出");
      };

      // 导入群聊聊天记录
      window.importGroupChat = function () {
        if (!currentGroupId) return;

        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";
        input.onchange = async function (e) {
          const file = e.target.files[0];
          if (!file) return;

          try {
            const text = await file.text();
            const data = JSON.parse(text);

            let messages = [];

            // 支持两种格式：完整导出格式和纯消息数组
            if (
              data.type === "pinky_group_chat_export" &&
              Array.isArray(data.messages)
            ) {
              messages = data.messages;
            } else if (Array.isArray(data)) {
              messages = data;
            } else {
              throw new Error("无效的聊天记录格式");
            }

            // 询问用户是覆盖还是追加
            const choice = confirm(
              "点击「确定」覆盖现有记录，点击「取消」追加到现有记录末尾"
            );

            const messagesKey = `group_messages_${currentGroupId}`;

            if (choice) {
              // 覆盖
              await localforage.setItem(messagesKey, messages);
            } else {
              // 追加
              const existingMessages =
                (await localforage.getItem(messagesKey)) || [];
              await localforage.setItem(messagesKey, [
                ...existingMessages,
                ...messages,
              ]);
            }

            loadGroupMessages(currentGroupId);
            showToast(`成功导入 ${messages.length} 条消息`);

            // 更新消息计数
            const newMessages = (await localforage.getItem(messagesKey)) || [];
            const countEl = document.getElementById("groupMsgCount");
            if (countEl) countEl.textContent = newMessages.length;
          } catch (err) {
            alert("导入失败：" + err.message);
          }
        };
        input.click();
      };

      // 清空群聊聊天记录
      window.clearGroupChat = async function () {
        if (!currentGroupId) return;
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;

        if (
          !confirm(
            `确定要清空群聊「${group.name}」的所有聊天记录吗？此操作不可撤销！`
          )
        )
          return;

        const messagesKey = `group_messages_${currentGroupId}`;
        await localforage.setItem(messagesKey, []);

        loadGroupMessages(currentGroupId);
        showToast("聊天记录已清空");

        // 更新消息计数
        const countEl = document.getElementById("groupMsgCount");
        if (countEl) countEl.textContent = "0";
      };

      // 删除联系人（完全删除角色及其所有数据）
      window.deleteCharacterCompletely = async function () {
        if (!currentChatCharId) return;
        const char = characters.find((c) => c.id === currentChatCharId);
        if (!char) return;

        const charName = char.note || char.name;

        if (
          !confirm(
            `⚠️ 警告：确定要删除联系人「${charName}」吗？\n\n这将删除：\n• 角色卡片和所有设置\n• 全部聊天记录\n• 记忆总结数据\n\n此操作不可撤销！`
          )
        )
          return;

        // 再次确认
        if (!confirm(`最后确认：真的要永久删除「${charName}」吗？`)) return;

        const charId = currentChatCharId;

        // 1. 删除聊天记录
        delete chatHistories[charId];
        await localforage.setItem("chatHistories", chatHistories);

        // 2. 删除聊天设置
        delete chatSettings[charId];
        await localforage.setItem("chatSettings", chatSettings);

        // 3. 删除记忆总结
        if (window.memorySummaries) {
          delete window.memorySummaries[charId];
          await localforage.setItem("memorySummaries", window.memorySummaries);
        }

        // 4. 从群聊中移除该角色
        for (const group of groupChats) {
          if (group.members && group.members.includes(charId)) {
            group.members = group.members.filter((id) => id !== charId);
          }
          // 清除记忆互通中的引用
          if (group.settings && group.settings.memoryLinks) {
            group.settings.memoryLinks = group.settings.memoryLinks.filter(
              (id) => id !== charId
            );
          }
        }
        await localforage.setItem("groupChats", groupChats);

        // 5. 清除其他角色对此角色的记忆互通引用
        for (const key in chatSettings) {
          if (chatSettings[key].memoryLinks) {
            chatSettings[key].memoryLinks = chatSettings[
              key
            ].memoryLinks.filter((id) => id !== charId);
          }
          if (chatSettings[key].memoryLink == charId) {
            chatSettings[key].memoryLink = "";
          }
        }
        await localforage.setItem("chatSettings", chatSettings);

        // 6. 清除表情包绑定
        if (window.aiStickerBindings) {
          delete window.aiStickerBindings[String(charId)];
          await localforage.setItem(
            "aiStickerBindings",
            window.aiStickerBindings
          );
        }

        // 7. 删除角色本身
        characters = characters.filter((c) => c.id !== charId);
        await localforage.setItem("characters", characters);

        showToast(`已删除联系人「${charName}」`);
        closeChatSettings();
        closeConversation();
        renderCharacters();
      };

      // 渲染群聊设置中的成员列表
      function renderGroupSettingsMembers() {
        if (!currentGroupId) return;
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;

        // 更新旧的群成员网格（如果存在）
        const container = document.getElementById("groupMembersGrid");
        if (container) {
          let html = group.members
            .map((memberId) => {
              const char = characters.find((c) => c.id === memberId);
              if (!char) return "";
              const displayName = char.note || char.name;
              return `
              <div class="group-member-card">
                <div class="group-member-card-avatar">
                  ${
                    char.avatar
                      ? `<img src="${char.avatar}">`
                      : char.name.charAt(0)
                  }
                  <div class="remove-btn" onclick="removeGroupMember(${
                    char.id
                  })">✕</div>
                </div>
                <div class="group-member-card-name">${displayName}</div>
              </div>
            `;
            })
            .join("");

          // 添加"添加成员"按钮
          html += `
            <div class="group-member-card">
              <div class="group-add-member-card" onclick="openAddGroupMemberModal()">+</div>
              <div class="group-member-card-name">添加</div>
            </div>
          `;

          container.innerHTML = html;
        }

        // 更新新的群聊设置页面成员列表（如果存在）
        const newContainer = document.getElementById(
          "groupSettingsMembersList"
        );
        if (newContainer) {
          const members = group.members
            .map((id) => characters.find((c) => c.id === id))
            .filter(Boolean);
          newContainer.innerHTML = members
            .map(
              (m) => `
            <div class="group-settings-member-item">
              <div class="group-settings-member-avatar">
                ${
                  m.avatar ? `<img src="${m.avatar}" alt="">` : m.name.charAt(0)
                }
              </div>
              <div class="group-settings-member-name">${m.name}</div>
            </div>
          `
            )
            .join("");
        }
      }

      // 初始化加载群聊数据
      async function loadGroupChats() {
        try {
          groupChats = (await localforage.getItem("groupChats")) || [];
        } catch (e) {
          groupChats = [];
        }
      }

      function renderCharacters() {
        const container = document.getElementById("messageList");

        // 检查是否既没有角色也没有群聊
        if (
          characters.length === 0 &&
          (!groupChats || groupChats.length === 0)
        ) {
          container.innerHTML = `
                                    <div class="empty-state" id="emptyMessages">
                                        <div class="empty-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></div>
                                        <div class="empty-text">还没有消息哦</div>
                                        <div class="empty-hint">添加AI角色开始聊天吧～</div>
                                    </div>
                                `;
          return;
        }

        // 分离置顶和普通角色
        const pinnedChars = [];
        const normalChars = [];
        const groupedChars = {};

        characters.forEach((char) => {
          const settings = chatSettings[char.id] || {};
          if (settings.pinned) {
            pinnedChars.push(char);
          } else if (settings.group && settings.group !== "none") {
            if (!groupedChars[settings.group]) {
              groupedChars[settings.group] = [];
            }
            groupedChars[settings.group].push(char);
          } else {
            normalChars.push(char);
          }
        });

        // 生成角色卡片HTML的函数
        const renderCharCard = (char, isPinned = false) => {
          const displayName = char.note || char.name;
          let sparkHtml = "";
          if (char.flameData && char.flameData.active) {
            sparkHtml = `<span class="spark-badge">${char.flameData.icon} ${char.flameData.days}</span>`;
          }
          // 获取未读消息数
          const unreadCount =
            (typeof unreadMessages !== "undefined" &&
              unreadMessages[char.id]) ||
            char.unread ||
            0;
          return `
            <div class="message-item ${isPinned ? "pinned" : ""}" data-id="${
            char.id
          }">
              <div class="message-avatar">
                ${
                  char.avatar
                    ? `<img src="${char.avatar}" alt="${char.name}">`
                    : "AI"
                }
              </div>
              <div class="message-info">
                <div class="message-top">
                  <span class="message-name">${displayName} ${sparkHtml}</span>
                  <span class="message-time">${char.lastTime || ""}</span>
                </div>
                <div class="message-preview">${
                  char.lastMessage || "点击开始聊天～"
                }</div>
              </div>
              ${
                unreadCount > 0
                  ? `<div class="message-badge">${unreadCount}</div>`
                  : ""
              }
            </div>
          `;
        };

        // 生成群聊卡片HTML的函数
        const renderGroupCard = (group) => {
          const memberCount = group.members ? group.members.length : 0;
          let avatarHtml = "";

          if (group.avatar) {
            avatarHtml = `<img src="${group.avatar}" alt="${group.name}">`;
          } else if (group.members && group.members.length > 0) {
            // 生成成员头像堆叠
            const members = group.members.slice(0, 3);
            let stackHtml = members
              .map((memberId) => {
                const char = characters.find((c) => c.id === memberId);
                if (!char) return '<div class="avatar-mini">?</div>';
                return `<div class="avatar-mini">${
                  char.avatar
                    ? `<img src="${char.avatar}">`
                    : char.name.charAt(0)
                }</div>`;
              })
              .join("");
            if (group.members.length > 3) {
              stackHtml += `<div class="avatar-mini more">+${
                group.members.length - 3
              }</div>`;
            }
            avatarHtml = `<div class="group-avatar-stack">${stackHtml}</div>`;
          } else {
            avatarHtml = "👥";
          }

          return `
            <div class="message-item group-chat" data-group-id="${group.id}">
              <div class="message-avatar">
                ${avatarHtml}
              </div>
              <div class="message-info">
                <div class="message-top">
                  <span class="message-name">${
                    group.name
                  } <span style="font-size:0.7rem;color:#999;">(${memberCount}人)</span></span>
                  <span class="message-time">${group.lastTime || ""}</span>
                </div>
                <div class="message-preview">${
                  group.lastMessage || "点击开始群聊～"
                }</div>
              </div>
              ${
                group.unread > 0
                  ? `<div class="message-badge">${group.unread}</div>`
                  : ""
              }
            </div>
          `;
        };

        let html = "";

        // 先渲染群聊
        if (groupChats && groupChats.length > 0) {
          html += groupChats.map((group) => renderGroupCard(group)).join("");
        }

        // 置顶的角色
        if (pinnedChars.length > 0) {
          html += pinnedChars
            .map((char) => renderCharCard(char, true))
            .join("");
        }

        // 分组的角色
        Object.keys(groupedChars).forEach((groupName) => {
          const chars = groupedChars[groupName];
          html += `
            <div class="message-group" id="group_${groupName}">
              <div class="message-group-header" onclick="toggleGroup('${groupName}')">
                <span class="message-group-title">
                  <span class="message-group-arrow">▼</span>
                  ${groupName} (${chars.length})
                </span>
              </div>
              <div class="message-group-content">
                ${chars.map((char) => renderCharCard(char)).join("")}
              </div>
            </div>
          `;
        });

        // 未分组的角色
        if (normalChars.length > 0) {
          html += normalChars.map((char) => renderCharCard(char)).join("");
        }

        container.innerHTML = html;

        // 绑定单聊点击事件
        document
          .querySelectorAll(".message-item:not(.group-chat)")
          .forEach((item) => {
            item.onclick = function () {
              const charId = parseInt(this.dataset.id);
              openConversation(charId);
            };
          });

        // 绑定群聊点击事件
        document
          .querySelectorAll(".message-item.group-chat")
          .forEach((item) => {
            item.onclick = function () {
              const groupId = parseInt(this.dataset.groupId);
              openGroupConversation(groupId);
            };
          });
      }

      // 切换分组展开/收起
      function toggleGroup(groupName) {
        const group = document.getElementById(`group_${groupName}`);
        if (group) {
          group.classList.toggle("collapsed");
        }
      }

      // Close modal on outside click
      document
        .getElementById("createCharModal")
        .addEventListener("click", function (e) {
          if (e.target === this) {
            closeCreateCharModal();
          }
        });

      // ==================== API PRESETS MANAGEMENT ====================
      // 使用从localforage加载的值，如果没有则尝试localStorage（兼容旧数据）
      var activePresetId =
        window.savedActivePresetId ||
        localStorage.getItem("activePresetId") ||
        null;
      var editingPresetId = null;
      var tempModelList = [];

      // Render API presets list
      function renderApiPresets() {
        const container = document.getElementById("apiPresetList");

        if (apiPresets.length === 0) {
          container.innerHTML = `
                                            <div class="empty-state" id="emptyPresets">
                                                <div class="empty-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path><line x1="12" y1="2" x2="12" y2="12"></line></svg></div>
                                                <div class="empty-text">还没有API预设</div>
                                                <div class="empty-hint">点击右上角 + 创建预设</div>
                                            </div>
                                        `;
          return;
        }

        container.innerHTML = apiPresets
          .map(
            (preset) => `
                                        <div class="api-preset-item ${
                                          activePresetId == preset.id
                                            ? "active"
                                            : ""
                                        }" onclick="selectApiPreset(${
              preset.id
            })">
                                            <div class="preset-radio"></div>
                                            <div class="preset-info">
                                                <div class="preset-name">${escapeHtml(
                                                  preset.name
                                                )}</div>
                                                <div class="preset-detail">${
                                                  preset.model || "未选择模型"
                                                }</div>
                                            </div>
                                            <button class="preset-edit-btn" onclick="event.stopPropagation(); editApiPreset(${
                                              preset.id
                                            })">✏️</button>
                                        </div>
                                    `
          )
          .join("");
      }

      // Select API preset as active
      function selectApiPreset(presetId) {
        activePresetId = presetId;
        localforage.setItem("activePresetId", presetId); // 这里其实已经自动保存了
        renderApiPresets();
        updateActiveConfigDisplay();

        // 【✓ 新增：给个提示，让你知道保存成功了】
        const preset = apiPresets.find((p) => p.id == presetId);
        if (preset) {
          showToast(`已切换并保存预设：${preset.name}`);
        }
      }

      // Update active config display
      function updateActiveConfigDisplay() {
        const section = document.getElementById("activeConfigSection");
        if (!activePresetId) {
          section.style.display = "none";
          return;
        }

        const preset = apiPresets.find((p) => p.id == activePresetId);
        if (!preset) {
          section.style.display = "none";
          return;
        }

        document.getElementById("activePresetName").textContent = preset.name;
        document.getElementById("activeModelName").textContent =
          preset.model || "未选择";
        section.style.display = "block";
      }

      // Close API preset modal
      function closeApiPresetModal() {
        document.getElementById("apiPresetModal").classList.remove("active");
        editingPresetId = null;
      }

      // Toggle API key visibility in modal
      function togglePresetKeyVisibility() {
        const input = document.getElementById("presetKeyInput");
        const btn = document.querySelector(".key-toggle-btn");
        if (input.type === "password") {
          input.type = "text";
          btn.textContent = "○";
        } else {
          input.type = "password";
          btn.textContent = "○";
        }
      }

      // Fetch models for preset
      async function fetchPresetModels() {
        const url = document.getElementById("presetUrlInput").value.trim();
        const key = document.getElementById("presetKeyInput").value.trim();

        if (!url || !key) {
          alert("请先填写反代地址和 API Key");
          return;
        }

        const btn = document.querySelector(".model-fetch-btn");
        btn.textContent = "拉取中...";
        btn.classList.add("loading");

        try {
          // Ensure URL is properly formatted
          let baseUrl = url.replace(/\/+$/, "");
          if (!baseUrl.includes("/v1")) {
            baseUrl += "/v1";
          }

          const response = await fetch(`${baseUrl}/models`, {
            method: "GET",
            mode: "cors",
            headers: {
              Authorization: `Bearer ${key}`,
            },
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          tempModelList = data.data || [];

          if (tempModelList.length === 0) {
            alert("没有获取到可用模型");
            return;
          }

          // Render model dropdown
          renderModelDropdown();
          document.getElementById("modelDropdown").classList.add("active");
        } catch (error) {
          console.error("Fetch models error:", error);
          // 如果是CORS错误，提示用户手动输入
          if (
            error.message.includes("Failed to fetch") ||
            error.message.includes("NetworkError") ||
            error.message.includes("CORS")
          ) {
            alert(
              "拉取失败（可能是跨域限制）\n\n您可以直接在模型输入框中手动输入模型名称，例如:\n• gpt-4o\n• gpt-4-turbo\n• claude-3-opus-20240229\n• claude-3-sonnet-20240229"
            );
            // 启用手动输入
            document
              .getElementById("presetModelInput")
              .removeAttribute("readonly");
            document.getElementById("presetModelInput").placeholder =
              "手动输入模型名称";
          } else {
            alert("拉取模型失败: " + error.message);
          }
        } finally {
          btn.textContent = "拉取";
          btn.classList.remove("loading");
        }
      }

      // Render model dropdown
      function renderModelDropdown() {
        const container = document.getElementById("modelDropdown");
        const currentModel = document.getElementById("presetModelInput").value;

        container.innerHTML = tempModelList
          .map(
            (model) => `
                                        <div class="model-option ${
                                          model.id === currentModel
                                            ? "selected"
                                            : ""
                                        }" onclick="selectPresetModel('${
              model.id
            }')">
                                            ${model.id}
                                        </div>
                                    `
          )
          .join("");
      }

      // Select model for preset
      function selectPresetModel(modelId) {
        document.getElementById("presetModelInput").value = modelId;
        document.getElementById("modelDropdown").classList.remove("active");
      }
      // 打开新建窗口：重置所有滑块为默认值
      function openApiPresetModal() {
        editingPresetId = null;
        document.getElementById("apiModalTitle").textContent = "创建 API 预设";
        document.getElementById("presetNameInput").value = "";
        document.getElementById("presetUrlInput").value = "";
        document.getElementById("presetKeyInput").value = "";
        document.getElementById("presetModelInput").value = "";
        document.getElementById("presetKeyInput").type = "password";
        document.getElementById("modelDropdown").classList.remove("active");
        document.getElementById("presetDeleteBtn").style.display = "none";

        // --- 新增：重置参数滑块 ---
        document.getElementById("presetTempInput").value = "1.0";
        document.getElementById("valTemp").textContent = "1.0";

        document.getElementById("presetFreqInput").value = "0.0";
        document.getElementById("valFreq").textContent = "0.0";

        document.getElementById("presetPresInput").value = "0.0";
        document.getElementById("valPres").textContent = "0.0";
        // ------------------------

        tempModelList = [];
        document.getElementById("apiPresetModal").classList.add("active");
      }

      // 打开编辑窗口：回显保存的参数
      function editApiPreset(presetId) {
        const preset = apiPresets.find((p) => p.id === presetId);
        if (!preset) return;

        editingPresetId = presetId;
        document.getElementById("apiModalTitle").textContent = "编辑 API 预设";
        document.getElementById("presetNameInput").value = preset.name;
        document.getElementById("presetUrlInput").value = preset.url;
        document.getElementById("presetKeyInput").value = preset.key;
        document.getElementById("presetModelInput").value = preset.model || "";
        document.getElementById("modelDropdown").classList.remove("active");
        document.getElementById("presetDeleteBtn").style.display = "block";

        // --- 新增：回显参数滑块 (如果没有值则使用默认) ---
        const temp =
          preset.temperature !== undefined ? preset.temperature : 1.0;
        const freq =
          preset.frequency_penalty !== undefined
            ? preset.frequency_penalty
            : 0.0;
        const pres =
          preset.presence_penalty !== undefined ? preset.presence_penalty : 0.0;

        document.getElementById("presetTempInput").value = temp;
        document.getElementById("valTemp").textContent = temp;

        document.getElementById("presetFreqInput").value = freq;
        document.getElementById("valFreq").textContent = freq;

        document.getElementById("presetPresInput").value = pres;
        document.getElementById("valPres").textContent = pres;
        // ------------------------

        tempModelList = [];
        document.getElementById("apiPresetModal").classList.add("active");
      }

      // 保存逻辑：将滑块的值存入预设对象
      function saveApiPreset() {
        const name = document.getElementById("presetNameInput").value.trim();
        const url = document.getElementById("presetUrlInput").value.trim();
        const key = document.getElementById("presetKeyInput").value.trim();
        const model = document.getElementById("presetModelInput").value.trim();

        // --- 新增：获取参数值 ---
        const temperature = parseFloat(
          document.getElementById("presetTempInput").value
        );
        const frequency_penalty = parseFloat(
          document.getElementById("presetFreqInput").value
        );
        const presence_penalty = parseFloat(
          document.getElementById("presetPresInput").value
        );
        // ---------------------

        if (!name) {
          alert("请输入预设名称");
          return;
        }
        if (!url) {
          alert("请输入反代地址");
          return;
        }
        if (!key) {
          alert("请输入 API Key");
          return;
        }

        let baseUrl = url.replace(/\/+$/, "");
        if (!baseUrl.includes("/v1")) {
          baseUrl += "/v1";
        }

        // 构建新的数据对象
        const presetData = {
          name,
          url: baseUrl,
          key,
          model,
          // 保存新参数
          temperature,
          frequency_penalty,
          presence_penalty,
        };

        if (editingPresetId) {
          const index = apiPresets.findIndex((p) => p.id === editingPresetId);
          if (index !== -1) {
            // 合并数据，保留 id
            apiPresets[index] = { ...apiPresets[index], ...presetData };
          }
        } else {
          const newPreset = {
            id: Date.now(),
            ...presetData,
          };
          apiPresets.push(newPreset);
          if (apiPresets.length === 1) {
            activePresetId = newPreset.id;
            localforage.setItem("activePresetId", activePresetId);
          }
        }

        localforage.setItem("apiPresets", apiPresets);
        renderApiPresets();
        updateActiveConfigDisplay();
        closeApiPresetModal();
      }
      // Delete API preset
      function deleteApiPreset() {
        if (!editingPresetId) return;

        if (confirm("确定要删除这个预设吗？")) {
          apiPresets = apiPresets.filter((p) => p.id !== editingPresetId);
          localforage.setItem("apiPresets", apiPresets);

          // Clear active if deleted
          if (activePresetId == editingPresetId) {
            activePresetId = apiPresets.length > 0 ? apiPresets[0].id : null;
            localforage.setItem("activePresetId", activePresetId || "");
          }

          renderApiPresets();
          updateActiveConfigDisplay();
          closeApiPresetModal();
        }
      }

      // Get current active API config
      function getActiveApiConfig() {
        if (!activePresetId) return null;
        return apiPresets.find((p) => p.id == activePresetId) || null;
      }

      // Close dropdown when clicking outside
      document.addEventListener("click", function (e) {
        const dropdown = document.getElementById("modelDropdown");
        const modelInput = document.getElementById("presetModelInput");
        const fetchBtn = document.querySelector(".model-fetch-btn");

        if (
          dropdown &&
          !dropdown.contains(e.target) &&
          e.target !== modelInput &&
          e.target !== fetchBtn
        ) {
          dropdown.classList.remove("active");
        }
      });

      // ==================== CHAT CONVERSATION ====================
      var currentChatCharId = null;

      // Open conversation
      async function openConversation(charId) {
        // 设置标题栏 (带火花)
        const settings = chatSettings[charId] || {};
        currentChatCharId = charId;
        currentGroupId = null; // 确保清除群聊ID
        const char = characters.find((c) => c.id === charId);
        if (!char) return;

        // 重置回复按钮状态（避免切换对话后按钮仍然禁用）
        const replyBtn = document.getElementById("replyBtn");
        if (replyBtn) {
          replyBtn.disabled = false;
          replyBtn.classList.remove("loading");
          replyBtn.innerHTML = "<span>★</span>";
        }

        // 清除该角色的未读消息
        if (typeof clearUnreadForChar === "function") {
          clearUnreadForChar(charId);
        }

        // Set header info
        document.getElementById("convName").textContent = char.name;
        const avatarEl = document.getElementById("convAvatar");
        if (char.avatar) {
          avatarEl.innerHTML = `<img src="${char.avatar}" alt="${char.name}">`;
        } else {
          avatarEl.innerHTML = "🤖";
        }

        // 确保chatHistories是最新的 - 从localforage重新读取
        try {
          const savedHistories = await safeLocalforageGet("chatHistories");
          if (savedHistories && typeof savedHistories === "object") {
            // 合并而不是完全替换，保护已有数据
            for (const key in savedHistories) {
              if (savedHistories[key] && Array.isArray(savedHistories[key])) {
                chatHistories[key] = savedHistories[key];
              }
            }
          }
        } catch (e) {
          console.warn("读取聊天记录失败:", e.message);
          // 使用内存中的数据继续
        }

        // Load chat history
        renderConversation();

        // 应用头像可见性设置
        applyAvatarVisibility(
          settings.showAiAvatar !== false,
          settings.showUserAvatar !== false
        );

        // 应用头像大小设置
        const avatarSize = char.avatarSize || 40;
        applyAvatarSize(avatarSize);

        // 应用气泡间距设置
        const bubbleGap = char.bubbleGap || 6;
        applyBubbleGap(bubbleGap);

        // 生成火花 HTML
        let sparkHtml = "";
        // 注意：这里读取的是 chatSettings 里的 flameData，或者 characters 里的
        const fData = settings.flameData || char.flameData;
        if (fData && fData.active) {
          sparkHtml = `<span class="spark-badge">${fData.icon} ${fData.days}</span>`;
        }
        const displayTitle =
          settings.charNote || settings.charName || char.name;
        document.getElementById("convName").innerHTML =
          displayTitle + sparkHtml;
        // Show page
        document.getElementById("chatConversationPage").classList.add("active");

        // 隐藏创建群聊按钮（只在消息列表页显示）
        const createGroupBtn = document.getElementById("createGroupBtn");
        if (createGroupBtn) createGroupBtn.style.display = "none";
      }

      // Close conversation
      function closeConversation() {
        document
          .getElementById("chatConversationPage")
          .classList.remove("active");
        document.getElementById("convMenu").classList.remove("active");
        currentChatCharId = null;
        currentGroupId = null; // 清除群聊ID

        // 刷新表情面板的绑定状态显示
        if (typeof renderCategoryBar === "function") {
          renderCategoryBar();
        }

        // 显示创建群聊按钮（返回消息列表页）
        const createGroupBtn = document.getElementById("createGroupBtn");
        if (createGroupBtn) createGroupBtn.style.display = "";
      }

      // Toggle conversation menu
      function toggleConvMenu() {
        document.getElementById("convMenu").classList.toggle("active");
      }

      // ==================== 修复：完整的 renderMessageGroup 函数 ====================
      // ==================== 修复：完整的消息渲染函数 ====================
      window.renderMessageGroup = function (
        messages,
        role,
        aiAvatarSrc,
        userAvatarSrc
      ) {
        const isUser = role === "user";

        const bubbles = messages
          .map((m) => {
            // 1. 多选状态判断
            // 注意：isSelecting 是“是否处于多选模式”
            const isSelecting =
              typeof isSelectionMode !== "undefined" && isSelectionMode;

            // 2. 单条选中判断
            // 注意：isSelected 是“这条消息是否被勾选”
            const isSelected =
              isSelecting &&
              typeof selectedIndices !== "undefined" &&
              selectedIndices.has(m.originalIndex);

            // 3. 核心修复：检测是否为表情包
            const rawContent = m.content || "";
            // 检测已渲染的表情包图片，或者原始的表情包标签
            const isSticker =
              rawContent.includes('class="sticker-img"') ||
              /^\[(sticker|表情|表情包)[：:][^\]]+\]$/i.test(rawContent.trim());

            // 4. 生成气泡样式
            // 如果是表情包，加上 sticker-bubble 类；如果是选中状态，加上 selected 类
            const bubbleClass = `msg-bubble ${isSelected ? "selected" : ""} ${
              isSticker ? "sticker-bubble" : ""
            }`;

            // 5. 语音消息处理
            const voiceMatch =
              rawContent.match && rawContent.match(/^\[语音[ :：〃\s]*(.+)\]$/);

            if (voiceMatch && !isUser) {
              const voiceText = voiceMatch[1];
              const hasAudio = m.audioUrl ? "has-audio" : "";
              const duration =
                m.audioDuration || Math.ceil(voiceText.length / 5) + '"';
              const textVisible = m.voiceTextVisible ? "visible" : "";

              // 多选模式下的选择器
              const voiceSelectorHtml = isSelecting
                ? `
                <div class="bubble-selector ${
                  isSelected ? "selected" : ""
                }" onclick="event.stopPropagation();toggleMessageSelection(${
                    m.originalIndex
                  })">
                  <div class="bubble-selector-inner">
                    ${
                      isSelected
                        ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>'
                        : ""
                    }
                  </div>
                </div>
              `
                : "";

              const voiceBubbleHtml = `
            <div class="${bubbleClass} voice-message-bubble"
                    data-index="${m.originalIndex}"
                    data-voice-text="${escapeHtml(voiceText)}"
                    oncontextmenu="return false;"
                    ontouchstart="handleVoiceBubbleTouchStart(event, ${
                      m.originalIndex
                    })"
                    ontouchend="handleVoiceBubbleTouchEnd(event, ${
                      m.originalIndex
                    })"
                    ontouchmove="handleTouchMove(event)"
                    onmousedown="handleMouseDown(event, ${m.originalIndex})"
                    onmouseup="handleMouseUp()"
            >
                <div class="voice-message">
                    <div class="voice-bar ${hasAudio}" data-audio-url="${
                m.audioUrl || ""
              }" onclick="playVoiceMessage(event, ${m.originalIndex})">
                        <div class="voice-waves">
                            <span></span><span></span><span></span><span></span><span></span>
                        </div>
                        <span class="voice-duration">${duration}</span>
                    </div>
                    <div class="voice-text ${textVisible}" id="voiceText-${
                m.originalIndex
              }">${escapeHtml(voiceText)}</div>
                    <div class="voice-to-text-btn" onclick="toggleVoiceText(event, ${
                      m.originalIndex
                    })">
                        ${m.voiceTextVisible ? "收起文字" : "转文字"}
                    </div>
                </div>
            </div>`;

              if (isSelecting) {
                return `<div class="bubble-with-selector ai">${voiceSelectorHtml}${voiceBubbleHtml}</div>`;
              }
              return voiceBubbleHtml;
            }

            // 5.5 图片消息处理
            if (m.type === "image") {
              const isAi = m.role === "assistant";

              // 多选模式下的选择器
              const imgSelectorHtml = isSelecting
                ? `
                <div class="bubble-selector ${
                  isSelected ? "selected" : ""
                }" onclick="event.stopPropagation();toggleMessageSelection(${
                    m.originalIndex
                  })">
                  <div class="bubble-selector-inner">
                    ${
                      isSelected
                        ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>'
                        : ""
                    }
                  </div>
                </div>
              `
                : "";

              if (m.imageType === "real" && m.imageData) {
                // 真实图片
                const realImgHtml = `
            <div class="${bubbleClass} image-message-bubble"
                    data-index="${m.originalIndex}"
                    oncontextmenu="return false;"
                    ontouchstart="handleTouchStart(event, ${m.originalIndex})"
                    ontouchend="handleTouchEnd()"
                    ontouchmove="handleTouchMove(event)"
                    onmousedown="handleMouseDown(event, ${m.originalIndex})"
                    onmouseup="handleMouseUp()"
            >
                <div class="msg-real-image" onclick="viewRealImage('${m.imageData}')">
                    <img src="${m.imageData}" alt="图片"/>
                </div>
            </div>`;
                if (isSelecting) {
                  return `<div class="bubble-with-selector ${
                    isUser ? "user" : "ai"
                  }">${imgSelectorHtml}${realImgHtml}</div>`;
                }
                return realImgHtml;
              } else if (m.imageType === "placeholder" && m.imageDesc) {
                // 占位图
                const iconColor = isAi ? "#66bb6a" : "#fff";
                const bgGradient = isAi
                  ? "linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)"
                  : "linear-gradient(135deg, #f48fb1 0%, #ec407a 100%)";
                const placeholderHtml = `
            <div class="${bubbleClass} image-message-bubble"
                    data-index="${m.originalIndex}"
                    oncontextmenu="return false;"
                    ontouchstart="handleTouchStart(event, ${m.originalIndex})"
                    ontouchend="handleTouchEnd()"
                    ontouchmove="handleTouchMove(event)"
                    onmousedown="handleMouseDown(event, ${m.originalIndex})"
                    onmouseup="handleMouseUp()"
            >
                <div class="msg-image-placeholder" style="background:${bgGradient};" onclick="viewImageDescription('${escapeHtml(
                  m.imageDesc
                ).replace(/'/g, "\\'")}', ${isAi})">
                    <div class="msg-image-placeholder-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                    </div>
                    <div class="msg-image-placeholder-text" style="color:${iconColor};">点击查看图片描述</div>
                </div>
            </div>`;
                if (isSelecting) {
                  return `<div class="bubble-with-selector ${
                    isUser ? "user" : "ai"
                  }">${imgSelectorHtml}${placeholderHtml}</div>`;
                }
                return placeholderHtml;
              }
            }

            // 5.6 检查AI发送的图片标签 [图片:内容] 或 [图片]-内容
            let imageContent = null;
            // 格式1: [图片:xxx] 或 [图片：xxx]
            let imageTagMatch =
              rawContent.match && rawContent.match(/^\[图片[:：]([^\]]+)\]$/);
            if (imageTagMatch) {
              imageContent = imageTagMatch[1].trim();
            } else {
              // 格式2: [图片]-xxx 或 [图片] xxx
              imageTagMatch =
                rawContent.match && rawContent.match(/^\[图片\][-\s]+(.+)$/);
              if (imageTagMatch) {
                imageContent = imageTagMatch[1].trim();
              }
            }

            if (imageContent && !isUser) {
              // 检测是否为URL
              const isUrl = /^https?:\/\//i.test(imageContent);

              // 多选模式下的选择器
              const aiImgSelectorHtml = isSelecting
                ? `
                <div class="bubble-selector ${
                  isSelected ? "selected" : ""
                }" onclick="event.stopPropagation();toggleMessageSelection(${
                    m.originalIndex
                  })">
                  <div class="bubble-selector-inner">
                    ${
                      isSelected
                        ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>'
                        : ""
                    }
                  </div>
                </div>
              `
                : "";

              if (isUrl) {
                // 如果是URL，直接显示图片
                const urlImgHtml = `
            <div class="${bubbleClass} image-message-bubble"
                    data-index="${m.originalIndex}"
                    oncontextmenu="return false;"
                    ontouchstart="handleTouchStart(event, ${m.originalIndex})"
                    ontouchend="handleTouchEnd()"
                    ontouchmove="handleTouchMove(event)"
                    onmousedown="handleMouseDown(event, ${m.originalIndex})"
                    onmouseup="handleMouseUp()"
            >
                <div class="msg-real-image" onclick="viewRealImage('${imageContent}')">
                    <img src="${imageContent}" alt="图片" onerror="this.parentElement.innerHTML='<div style=\\'padding:20px;color:#999;\\'>图片加载失败</div>'"/>
                </div>
            </div>`;
                if (isSelecting) {
                  return `<div class="bubble-with-selector ai">${aiImgSelectorHtml}${urlImgHtml}</div>`;
                }
                return urlImgHtml;
              } else {
                // 如果是描述文字，显示占位图
                const descImgHtml = `
            <div class="${bubbleClass} image-message-bubble"
                    data-index="${m.originalIndex}"
                    oncontextmenu="return false;"
                    ontouchstart="handleTouchStart(event, ${m.originalIndex})"
                    ontouchend="handleTouchEnd()"
                    ontouchmove="handleTouchMove(event)"
                    onmousedown="handleMouseDown(event, ${m.originalIndex})"
                    onmouseup="handleMouseUp()"
            >
                <div class="msg-image-placeholder" style="background:linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);" onclick="viewImageDescription('${escapeHtml(
                  imageContent
                ).replace(/'/g, "\\'")}', true)">
                    <div class="msg-image-placeholder-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#66bb6a" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                        </svg>
                    </div>
                    <div class="msg-image-placeholder-text" style="color:#66bb6a;">点击查看图片描述</div>
                </div>
            </div>`;
                if (isSelecting) {
                  return `<div class="bubble-with-selector ai">${aiImgSelectorHtml}${descImgHtml}</div>`;
                }
                return descImgHtml;
              }
            }

            // 6. 普通/富文本消息处理
            let contentHtml;
            if (
              m.isHtml ||
              rawContent.includes("<img") ||
              rawContent.includes("location-card")
            ) {
              // 如果是转账卡片HTML，需要根据状态更新显示
              if (rawContent.includes("transfer-card") && m.transferStatus) {
                const status = m.transferStatus;
                if (status === "accepted" || status === "rejected") {
                  const statusText =
                    status === "accepted" ? "已收款" : "已退回";
                  // 替换状态显示
                  contentHtml = rawContent
                    .replace(
                      /class="transfer-card-status[^"]*">[^<]*</g,
                      `class="transfer-card-status ${status}">${statusText}<`
                    )
                    .replace(/data-status="[^"]*"/g, `data-status="${status}"`);
                } else {
                  contentHtml = rawContent;
                }
              } else {
                contentHtml = rawContent;
              }
            } else if (rawContent.includes("transfer-card")) {
              // AI发的转账卡片（存储为HTML格式）
              contentHtml = rawContent;
            } else {
              // 检查是否包含特殊标签
              const hasTransfer = /\[转账[:：]/.test(rawContent);
              const hasRedpacket = /\[红包[:：]/.test(rawContent);
              const hasLocation = /\[位置[:：]/.test(rawContent);

              if (hasTransfer || hasRedpacket || hasLocation) {
                // 处理特殊标签，生成卡片
                let processed = rawContent;
                const msgIdx = m.originalIndex; // 使用消息索引作为唯一标识

                // 检查消息是否已被处理过（有状态）
                const msgStatus = m.transferStatus || "pending";
                const isProcessed = msgStatus !== "pending";

                // 处理转账标签
                processed = processed.replace(
                  /\[转账[:：](\d+(?:\.\d+)?)(?:[:：]([^\]]*))?\]/g,
                  (match, amount, note) => {
                    const footerContent = isProcessed
                      ? `<span class="transfer-card-status ${msgStatus}">${
                          msgStatus === "accepted" ? "已收款" : "已退回"
                        }</span>`
                      : `<div class="transfer-card-btns">
                          <button class="transfer-card-btn reject" onclick="event.stopPropagation();rejectAITransfer(${msgIdx},this)">退回</button>
                          <button class="transfer-card-btn accept" onclick="event.stopPropagation();acceptAITransfer(${msgIdx},${amount},this)">收款</button>
                        </div>`;
                    return `<div class="transfer-card" data-msg-idx="${msgIdx}" data-amount="${amount}">
                      <div class="transfer-card-header">
                        <div class="transfer-card-icon">¥</div>
                        <div class="transfer-card-info">
                          <div class="transfer-card-title">${
                            note || "转账给你"
                          }</div>
                          <div class="transfer-card-amount">${parseFloat(
                            amount
                          ).toFixed(2)}</div>
                        </div>
                      </div>
                      <div class="transfer-card-footer">
                        <span>微信转账</span>
                        ${footerContent}
                      </div>
                    </div>`;
                  }
                );

                // 处理红包标签
                processed = processed.replace(
                  /\[红包[:：](\d+(?:\.\d+)?)(?:[:：]([^\]]*))?\]/g,
                  (match, amount, note) => {
                    const footerContent = isProcessed
                      ? `<span class="transfer-card-status ${msgStatus}">${
                          msgStatus === "accepted" ? "已领取" : "已退回"
                        }</span>`
                      : `<div class="transfer-card-btns">
                          <button class="transfer-card-btn reject" onclick="event.stopPropagation();rejectAITransfer(${msgIdx},this)">退回</button>
                          <button class="transfer-card-btn accept" onclick="event.stopPropagation();acceptAITransfer(${msgIdx},${amount},this)">领取</button>
                        </div>`;
                    return `<div class="transfer-card" data-msg-idx="${msgIdx}" data-amount="${amount}">
                      <div class="transfer-card-header">
                        <div class="transfer-card-icon">🧧</div>
                        <div class="transfer-card-info">
                          <div class="transfer-card-title">${
                            note || "恭喜发财"
                          }</div>
                          <div class="transfer-card-amount">${parseFloat(
                            amount
                          ).toFixed(2)}</div>
                        </div>
                      </div>
                      <div class="transfer-card-footer">
                        <span>微信红包</span>
                        ${footerContent}
                      </div>
                    </div>`;
                  }
                );

                // 处理位置标签
                processed = processed.replace(
                  /\[位置[:：]([^\]:：]+)(?:[:：]([^\]]*))?\]/g,
                  (match, name, address) => {
                    return `<div class="location-card">
                      <div class="location-card-map">
                        <div class="location-card-map-bg"></div>
                        <div class="location-card-map-icon">📍</div>
                      </div>
                      <div class="location-card-info">
                        <div class="location-card-name">${name}</div>
                        <div class="location-card-address">${
                          address || "点击查看详情"
                        }</div>
                      </div>
                    </div>`;
                  }
                );

                contentHtml = processed;
              } else {
                // 普通消息
                let processed = rawContent;

                // 处理嵌入的语音标签 [语音:xxx] - 转换为可点击的语音提示（仅AI消息）
                if (!isUser) {
                  processed = processed.replace(
                    /\[语音[:：]([^\]]+)\]/g,
                    (match, text) =>
                      `<span class="inline-voice-tag" onclick="playInlineVoice(this, '${escapeHtml(
                        text
                      ).replace(/'/g, "\\'")}')">♪ ${
                        text.length > 20 ? text.substring(0, 20) + "..." : text
                      }</span>`
                  );

                  // 处理AI表情包标签 [sticker:xxx]
                  contentHtml = processAiStickerTags(processed);
                  // 再处理其他格式化
                  if (
                    !contentHtml.includes('class="sticker-img"') &&
                    !contentHtml.includes("inline-voice-tag")
                  ) {
                    contentHtml = formatNovelMessage(contentHtml);
                  }
                } else {
                  // 用户消息：不处理表情包标签，只做HTML转义和基本格式化
                  contentHtml = escapeHtml(processed);
                }
              }
            }

            // 检测是否为特殊卡片消息，决定气泡样式
            const isSpecialCard =
              contentHtml.includes("transfer-card") ||
              contentHtml.includes("location-card");
            const specialBubbleStyle = isSpecialCard
              ? 'style="background:transparent!important;box-shadow:none!important;padding:0!important;"'
              : "";

            // 生成引用显示HTML
            let quoteHtml = "";
            if (m.quote) {
              const quoteSender =
                m.quote.sender || (m.quote.senderRole === "user" ? "我" : "TA");
              const quoteText =
                m.quote.displayContent ||
                (m.quote.content || "")
                  .replace(/<[^>]+>/g, "")
                  .substring(0, 50);
              quoteHtml = `
                <div class="msg-quote">
                  <div class="msg-quote-sender">${quoteSender}</div>
                  <div class="msg-quote-text">${escapeHtml(quoteText)}</div>
                </div>
              `;
            }

            // 多选模式下为每个气泡生成选择器
            const bubbleSelectorHtml = isSelecting
              ? `
              <div class="bubble-selector ${
                isSelected ? "selected" : ""
              }" onclick="event.stopPropagation();toggleMessageSelection(${
                  m.originalIndex
                })">
                <div class="bubble-selector-inner">
                  ${
                    isSelected
                      ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>'
                      : ""
                  }
                </div>
              </div>
            `
              : "";

            // 普通气泡 HTML - 多选模式时包裹选择器
            if (isSelecting) {
              return `
        <div class="bubble-with-selector ${isUser ? "user" : "ai"}">
            ${bubbleSelectorHtml}
            <div class="${bubbleClass}"
                    data-index="${m.originalIndex}"
                    ${specialBubbleStyle}
                    oncontextmenu="return false;"
                    ontouchstart="handleTouchStart(event, ${m.originalIndex})"
                    ontouchend="handleTouchEnd()"
                    ontouchmove="handleTouchMove(event)"
                    onmousedown="handleMouseDown(event, ${m.originalIndex})"
                    onmouseup="handleMouseUp()"
                    onclick="handleBubbleClick(event, ${m.originalIndex})"
            >
                ${quoteHtml}${contentHtml}
            </div>
        </div>`;
            }

            // 普通模式气泡 HTML
            return `
        <div class="${bubbleClass}"
                data-index="${m.originalIndex}"
                ${specialBubbleStyle}
                oncontextmenu="return false;"
                ontouchstart="handleTouchStart(event, ${m.originalIndex})"
                ontouchend="handleTouchEnd()"
                ontouchmove="handleTouchMove(event)"
                onmousedown="handleMouseDown(event, ${m.originalIndex})"
                onmouseup="handleMouseUp()"
                onclick="handleBubbleClick(event, ${m.originalIndex})"
        >
            ${quoteHtml}${contentHtml}
        </div>`;
          })
          .join("");

        // 7. 头像与时间
        const time = messages[messages.length - 1].time || "";
        const avatarUrl = isUser ? userAvatarSrc : aiAvatarSrc;
        const defaultEmoji = isUser ? "我" : "AI";
        const avatarHtml = avatarUrl
          ? `<img src="${avatarUrl}" />`
          : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:20px;">${defaultEmoji}</div>`;

        // 8. 组合最终 HTML
        // 在多选模式下，整行可点击
        const isSelecting =
          typeof isSelectionMode !== "undefined" && isSelectionMode;
        const wrapperFirstMsgIdx = messages[0]?.originalIndex;
        const wrapperClickHandler = isSelecting
          ? `onclick="handleWrapperClick(event, ${wrapperFirstMsgIdx})"`
          : "";

        return `
    <div class="msg-wrapper ${isUser ? "user" : "ai"} ${
          isSelecting ? "selecting" : ""
        }" ${wrapperClickHandler}>
        <div class="chat-avatar-small">
            ${avatarHtml}
        </div>
        <div class="msg-content-container">
            <div class="msg-row ${isUser ? "user" : "ai"}">
                ${bubbles}
            </div>
            <div class="msg-time-wrapper">${time}</div>
        </div>
    </div>
    `;
      };
      // Escape HTML
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Auto resize textarea
      function autoResizeTextarea(el) {
        el.style.height = "auto";
        el.style.height = Math.min(el.scrollHeight, 100) + "px";
      }

      function sendUserMessage() {
        const input = document.getElementById("convInput");
        const text = input.value.trim();
        if (!text) return;

        // 检查是否是群聊
        if (currentGroupId) {
          sendGroupMessage(text);
          input.value = "";
          input.style.height = "auto";
          return;
        }

        if (!chatHistories[currentChatCharId]) {
          chatHistories[currentChatCharId] = [];
        }

        // 构建消息对象，包含引用信息
        const msgObj = {
          role: "user",
          content: text,
          time: new Date().toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          }),
        };

        // 如果有引用，添加引用信息
        if (currentQuote) {
          msgObj.quote = {
            sender: currentQuote.sender,
            senderRole: currentQuote.senderRole,
            content: currentQuote.content,
            displayContent: currentQuote.displayContent,
          };
          // 清除引用
          cancelQuote();
        }

        chatHistories[currentChatCharId].push(msgObj);

        // Save and render
        localforage.setItem("chatHistories", chatHistories);
        renderConversation();

        // 【新增】更新列表预览
        updateCharacterLastMessage(currentChatCharId, text);

        // Clear input
        input.value = "";
        input.style.height = "auto";
      }

      async function requestAIReply() {
        // 检查是否是群聊
        if (currentGroupId) {
          const input = document.getElementById("convInput");
          const text = input.value.trim();
          if (text) {
            // 有输入内容，先发送消息再等待AI回复
            sendGroupMessage(text);
            input.value = "";
            input.style.height = "auto";
          } else {
            // 没有输入内容，检查最后一条消息
            const group = groupChats.find((g) => g.id === currentGroupId);
            if (group && group.members.length > 0) {
              // 获取最近一条消息，检查是否是用户消息
              const messagesKey = `group_messages_${currentGroupId}`;
              const messages = (await localforage.getItem(messagesKey)) || [];
              const lastMsg = messages
                .filter((m) => m.role !== "system")
                .slice(-1)[0];

              // 如果没有消息或最后一条不是用户消息，提示用户
              if (!lastMsg || lastMsg.role !== "user") {
                showToast("请先发送一条消息");
                return;
              }

              const contextMsg = lastMsg.content;
              requestGroupAIReply(contextMsg);
            } else {
              showToast("群里没有成员可以回复");
            }
          }
          return;
        }

        const apiConfig = getActiveApiConfig();
        if (!apiConfig || !apiConfig.url || !apiConfig.key) {
          showToast("请先配置并选择 API 预设");
          return;
        }

        // 【修复】保存当前聊天角色ID，防止用户在API请求期间返回导致currentChatCharId变为null
        const savedCharId = currentChatCharId;
        if (!savedCharId) {
          showToast("请先打开一个对话");
          return;
        }

        // 确保chatHistories中有该角色的记录
        if (!chatHistories[savedCharId]) {
          chatHistories[savedCharId] = [];
        }

        const history = chatHistories[savedCharId] || [];
        if (history.length === 0) {
          showToast("请先发送一条消息");
          return;
        }

        // 检查最后一条非系统消息是否是用户消息，如果不是则不回复
        const lastNonSystemMsg = history
          .filter((m) => m.role !== "system")
          .slice(-1)[0];
        if (!lastNonSystemMsg || lastNonSystemMsg.role !== "user") {
          showToast("请先发送一条消息");
          return;
        }

        const settings = chatSettings[savedCharId] || {};
        const char = characters.find((c) => c.id === savedCharId);

        // UI 状态
        const btn = document.getElementById("replyBtn");
        btn.disabled = true;
        btn.classList.add("loading");

        const container = document.getElementById("convMessages");
        const typingHtml = `
                                <div class="msg-row ai" id="typingIndicator">
                                    <div class="msg-bubble">
                                        <div class="msg-typing"><span></span><span></span><span></span></div>
                                    </div>
                                </div>`;
        container.insertAdjacentHTML("beforeend", typingHtml);
        container.scrollTop = container.scrollHeight;

        try {
          const contextLimit = settings.contextCount || 150;
          const shortTermMemory = history.slice(-contextLimit);

          let systemContent = `Instruction:\nName: ${
            settings.charName || char.name
          }\n`;
          systemContent += `Character Persona:\n${
            settings.persona || "你是一个友好的聊天伴侣。"
          }\n\n`;
          systemContent += `User Info / User Persona:\n${
            settings.myPersona || "用户"
          }\n\n`;

          if (settings.summaries && settings.summaries.length > 0) {
            systemContent += `[Long-term Memory]:\n${settings.summaries.join(
              "\n"
            )}\n\n`;
          }

          // 世界书内容注入
          if (settings.worldbook) {
            const worldbookIds = settings.worldbook.split(",").filter((s) => s);
            // 将最近的聊天内容拼接起来用于关键词匹配
            const recentChat = shortTermMemory
              .slice(-10)
              .map((m) => m.content)
              .join(" ");
            const worldbookContent = getWorldbookContentForAI(
              worldbookIds,
              recentChat
            );
            if (worldbookContent) {
              systemContent += worldbookContent;
            }
          }

          // 处理记忆互通（支持多选，包括单聊和群聊）
          const memoryLinkCount = settings.memoryCount || 5;
          const linkedIds =
            settings.memoryLinks ||
            (settings.memoryLink ? [parseInt(settings.memoryLink)] : []);

          if (linkedIds.length > 0 && memoryLinkCount > 0) {
            let allLinkedContent = [];
            for (const linkId of linkedIds) {
              // 判断是群聊还是单聊
              if (typeof linkId === "string" && linkId.startsWith("group_")) {
                // 群聊记忆互通
                const groupId = parseInt(linkId.replace("group_", ""));
                const group = groupChats.find((g) => g.id === groupId);
                if (group) {
                  try {
                    const messagesKey = `group_messages_${groupId}`;
                    const groupMessages =
                      (await localforage.getItem(messagesKey)) || [];
                    const recentMessages = groupMessages
                      .filter((m) => !m.isHidden && !m.isCallCard)
                      .slice(-memoryLinkCount);

                    if (recentMessages.length > 0) {
                      const groupSettings = group.settings || {};
                      const userNickname = groupSettings.myNickname || "用户";

                      const linkedContent = recentMessages
                        .map((m) => {
                          if (m.role === "user") {
                            return `${userNickname}: ${(
                              m.content || ""
                            ).replace(/<[^>]*>/g, "")}`;
                          } else {
                            const msgChar = characters.find(
                              (c) => c.id === m.charId
                            );
                            const msgCharName = msgChar
                              ? msgChar.note || msgChar.name
                              : "成员";
                            return `${msgCharName}: ${(m.content || "").replace(
                              /<[^>]*>/g,
                              ""
                            )}`;
                          }
                        })
                        .join("\n");

                      if (linkedContent) {
                        allLinkedContent.push(
                          `## 群聊「${
                            group.name || "群聊"
                          }」的近期对话：\n${linkedContent}`
                        );
                      }
                    }
                  } catch (e) {
                    console.warn("读取群聊消息失败:", e);
                  }
                }
              } else {
                // 单聊记忆互通
                const linkedCharId = linkId;
                if (
                  chatHistories[linkedCharId] &&
                  chatHistories[linkedCharId].length > 0
                ) {
                  const linkedChar = characters.find(
                    (c) => c.id === linkedCharId
                  );
                  const linkedSettings = chatSettings[linkedCharId] || {};
                  const linkedName =
                    linkedSettings.charName || linkedChar?.name || "某人";
                  const linkedHistory = chatHistories[linkedCharId]
                    .filter((m) => !m.isHidden)
                    .slice(-memoryLinkCount);

                  const linkedContent = linkedHistory
                    .map((m) => {
                      const speaker =
                        m.role === "user"
                          ? settings.userNickname || "用户"
                          : linkedName;
                      return `${speaker}: ${m.content}`;
                    })
                    .join("\n");

                  if (linkedContent) {
                    allLinkedContent.push(
                      `## 用户与「${linkedName}」的近期对话：\n${linkedContent}`
                    );
                  }
                }
              }
            }

            if (allLinkedContent.length > 0) {
              systemContent += `\n【记忆互通 - 共${allLinkedContent.length}个聊天记录】\n以下是用户的其他聊天记录，供你参考了解用户的近况：\n\n`;
              systemContent += allLinkedContent.join("\n\n");
              systemContent += `\n\n【记忆互通结束】\n`;
            }
          }

          if (settings.timeAware) {
            systemContent += `Current Time: ${new Date().toLocaleString()}\n`;
          }

          // 一起读书功能 - 将书籍内容注入到系统提示词
          const readingContent = getCurrentReadingContent();
          if (readingContent && readingContent.currentSection) {
            // 限制书籍内容长度，避免超出token限制
            let bookContent = readingContent.currentSection;
            if (bookContent.length > 2000) {
              bookContent =
                bookContent.substring(0, 2000) + "...（内容已截断）";
            }
            systemContent += `\n【一起读书模式】\n`;
            systemContent += `当前正在和用户一起阅读《${readingContent.bookName}》\n`;
            systemContent += `阅读进度：第 ${readingContent.sectionIndex} 页 / 共 ${readingContent.totalSections} 页\n`;
            systemContent += `当前页内容：\n---\n${bookContent}\n---\n`;
            systemContent += `请基于以上书籍内容与用户互动讨论，但回复时不要复述整段内容，自然地聊天即可。\n\n`;
          }

          if (settings.onlineDating) {
            // 线下模式基础提示词
            systemContent += `\n【模式：沉浸式角色扮演】\n1. 以小说笔触回复。\n2. **必须严格遵守以下格式规范**：\n   - **环境/动作/神态描写**：直接书写，不加任何符号。\n   - **心理活动/内心独白**：必须用一对星号包裹，例如 *她看起来真可爱*。\n   - **语言对话**：必须用直角引号包裹，例如 「早安，亲爱的。」\n3. **禁止**拆分消息，请输出一段完整流畅的文本。\n4. **禁止**发送表情包（[sticker:xxx]格式）。\n5. **禁止**发送语音消息（[语音:xxx]格式）。\n`;

            // 添加字数要求
            const minWords = settings.offlineMinWords || 100;
            const maxWords = settings.offlineMaxWords || 500;
            systemContent += `6. **字数要求**：回复字数必须在 ${minWords} 到 ${maxWords} 字之间。请务必遵守此限制。\n`;

            // 如果选择了预设，添加预设内容
            if (settings.offlinePresetId && window.presets) {
              const selectedPreset = window.presets.find(
                (p) => p.id === settings.offlinePresetId
              );
              if (selectedPreset) {
                let presetContent = "";

                // 新格式：从entries数组获取启用的条目
                if (
                  selectedPreset.entries &&
                  Array.isArray(selectedPreset.entries)
                ) {
                  const enabledEntries = selectedPreset.entries.filter(
                    (e) => e.enabled
                  );
                  if (enabledEntries.length > 0) {
                    presetContent = enabledEntries
                      .map((e) => {
                        if (e.name) {
                          return `【${e.name}】\n${e.content}`;
                        }
                        return e.content;
                      })
                      .join("\n\n");
                  }
                }
                // 兼容旧格式：直接使用content字段
                else if (selectedPreset.content) {
                  presetContent = selectedPreset.content;
                }

                if (presetContent) {
                  systemContent += `\n【预设风格指令】\n${presetContent}\n`;
                }
              }
            }
          } else {
            systemContent += `\n【模式：即时通讯】\n1. 像真人一样口语化聊天，**禁止使用括号()包裹任何内容**，直接说话即可。\n2. **必须**拆分为多条短消息，使用 ||| 分隔。\n3. **语音消息功能**：你可以发送语音消息！格式为 [语音:要说的内容]。\n   - 语音消息适合表达亲密、撒娇、安慰等情感场景\n   - 不要每条都发语音，自然地穿插在文字消息中（大约20-30%概率）\n   - 语音内容应该口语化、自然，可以带语气词如"嗯~"、"啊"、"呢"\n   - 示例：宝贝 ||| [语音:想你了呢，今天有没有乖乖吃饭呀~] ||| 记得早点休息哦\n4. **发送转账**：你可以给用户发转账！格式为 [转账:金额:说明]\n   - 适合在节日祝福、表达感谢、安慰心情等场景使用\n   - 金额一般在1-200之间，不要太频繁使用\n   - 示例：生日快乐！ ||| [转账:88.88:生日红包~] ||| 希望你喜欢\n5. **接收/退回用户转账**：当用户给你发转账时，你可以选择接收或退回\n   - 接收转账格式：[收款]  退回转账格式：[退款]\n   - 收到转账后自然地感谢或拒绝，不要每次都收，偶尔也要客气地退回\n   - 示例（接收）：哇谢谢宝贝！ ||| [收款] ||| 我会好好用的～\n   - 示例（退回）：这个我不能收啦！ ||| [退款] ||| 你自己留着花吧～\n6. **位置功能**：你可以发送位置卡片！格式为 [位置:地点名称:详细地址]\n   - 适合在约会、见面、分享当前位置等场景使用\n   - 示例：我到啦！ ||| [位置:星巴克咖啡:南京路步行街店] ||| 你快来～\n7. **撤回功能**：你可以撤回刚发的消息！格式为 [撤回]\n   - 适合在说错话、发错消息、后悔、害羞等场景使用\n   - 撤回后用户仍能看到你撤回了什么\n   - 示例：我喜欢你... ||| [撤回] ||| 没什么！\n8. **引用回复功能**：你可以引用用户之前说的某句话来针对性回复！格式为 [引用:要引用的原文内容]回复内容\n   - 适合在回应用户之前说的某句具体的话、澄清误解、表达对某句话的感受时使用\n   - 引用的内容会显示在你消息的上方，让用户知道你在回复哪句话\n   - 示例：[引用:我今天好累啊]心疼你... ||| 早点休息好不好？\n9. **发起通话功能**：你可以主动给用户打电话！格式为 [打电话:语音] 或 [打电话:视频]\n   - 适合在想念用户、有重要事情要说、想听用户声音等场景使用\n   - 不要太频繁使用，在对话自然发展到想通话的时候再用\n   - 示例：好想你啊... ||| [打电话:语音] ||| 我想听听你的声音\n10. **发送图片功能**：你可以发送图片！格式为 [图片:图片描述]\n   - 适合在分享自拍、风景、宠物照片等场景使用\n   - 图片描述要具体生动，描述图片内容（因为用户会看到这个描述）\n   - 示例：看看我今天的穿搭！ ||| [图片:穿着白色连衣裙，在阳光下微笑自拍，背景是公园的樱花树]\n   - 示例：[图片:一只橘猫正在键盘上打滚，毛茸茸的很可爱] ||| 我家猫又在捣乱啦\n`;
          }

          // 添加AI表情包功能提示（仅在非线下模式时启用）
          if (!settings.onlineDating) {
            const aiStickerPrompt = generateAiStickerPrompt();
            if (aiStickerPrompt) {
              systemContent += aiStickerPrompt;
            }
          }

          // 添加待办监督提示词（仅对绑定了待办的角色生效）
          if (typeof generateTodoPromptForAi === "function") {
            const todoPrompt = generateTodoPromptForAi(currentChatCharId);
            if (todoPrompt) {
              systemContent += todoPrompt;
            }
          }

          // 添加经期关心提示词（所有角色都能看到）
          if (typeof generatePeriodPromptForAi === "function") {
            const periodPrompt = generatePeriodPromptForAi();
            if (periodPrompt) {
              systemContent += periodPrompt;
            }
          }

          // 添加用户动态提示词（让AI知道用户最近分享了什么）
          if (typeof generateMomentsPromptForAi === "function") {
            const momentsPrompt = generateMomentsPromptForAi(savedCharId);
            if (momentsPrompt) {
              systemContent += momentsPrompt;
            }
          }

          const messages = [
            { role: "system", content: systemContent },
            ...shortTermMemory
              .map((m) => {
                // 处理隐藏的系统消息（如通话记录）
                if (m.role === "system" && m.isHidden) {
                  return { role: "system", content: m.content };
                }

                // 处理图片消息 - 支持多模态
                if (
                  m.type === "image" &&
                  m.imageType === "real" &&
                  m.imageData
                ) {
                  // 用户发送的真实图片，构建多模态消息
                  return {
                    role: "user",
                    content: [
                      {
                        type: "text",
                        text:
                          m.content ||
                          "用户发送了一张图片，请描述或回应这张图片。",
                      },
                      {
                        type: "image_url",
                        image_url: {
                          url: m.imageData,
                          detail: "auto",
                        },
                      },
                    ],
                  };
                }

                // 普通消息
                return {
                  role: m.role === "user" ? "user" : "assistant",
                  content: m.content,
                };
              })
              .filter((m) => m.content), // 过滤空消息
          ];

          const reqTemperature =
            apiConfig.temperature !== undefined
              ? Number(apiConfig.temperature)
              : 1.0;
          const reqFreqPenalty =
            apiConfig.frequency_penalty !== undefined
              ? Number(apiConfig.frequency_penalty)
              : 0.0;
          const reqPresPenalty =
            apiConfig.presence_penalty !== undefined
              ? Number(apiConfig.presence_penalty)
              : 0.0;

          const response = await fetch(`${apiConfig.url}/chat/completions`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${apiConfig.key}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: apiConfig.model,
              messages: messages,
              temperature: reqTemperature,
              frequency_penalty: reqFreqPenalty,
              presence_penalty: reqPresPenalty,
            }),
          });

          if (!response.ok) {
            // 尝试获取详细错误信息
            let errorDetail = `HTTP ${response.status}`;
            try {
              const errorData = await response.json();
              if (errorData.error) {
                errorDetail =
                  errorData.error.message ||
                  errorData.error.code ||
                  JSON.stringify(errorData.error);
              } else if (errorData.message) {
                errorDetail = errorData.message;
              }
            } catch (e) {
              // 无法解析JSON，使用状态码
            }
            throw new Error(errorDetail);
          }
          const data = await response.json();
          let aiReply = data.choices[0]?.message?.content || "";

          // 如果AI没有返回内容，静默处理不显示消息
          if (!aiReply || aiReply.trim() === "") {
            document.getElementById("typingIndicator")?.remove();
            console.warn("AI返回空内容");
            return;
          }

          document.getElementById("typingIndicator")?.remove();

          let textToRead = ""; // 记录需要朗读的文本

          if (settings.onlineDating) {
            const msgObj = {
              role: "assistant",
              content: aiReply,
              time: new Date().toLocaleTimeString("zh-CN", {
                hour: "2-digit",
                minute: "2-digit",
              }),
              audioUrl: null, // 预留音频字段
            };
            // 提取对话内容用于朗读 (只读 「...」 里的内容)
            const matches = aiReply.match(/「([^」]+)」/g);
            textToRead = matches
              ? matches.map((s) => s.slice(1, -1)).join("，")
              : aiReply;

            chatHistories[savedCharId].push(msgObj);
            saveAndRenderForChar(savedCharId);
            // 【新增】更新列表预览
            updateCharacterLastMessage(savedCharId, aiReply);

            // 【修复】检查聊天对话页面是否打开，如果没打开则显示通知弹窗和红点
            const convPage = document.getElementById("chatConversationPage");
            const isConvPageActive =
              convPage && convPage.classList.contains("active");
            if (!isConvPageActive || currentChatCharId !== savedCharId) {
              showMessageNotification(
                savedCharId,
                char.name,
                char.avatar,
                aiReply
              );
              addUnreadMessage(savedCharId);
            }

            // === 触发语音 ===
            triggerVoiceForChar(savedCharId, msgObj, textToRead, settings);
          } else {
            // 先用 ||| 分割
            let replyParts = aiReply
              .split("|||")
              .map((s) => s.trim())
              .filter((s) => s && s !== "...");

            // 如果分割后没有有效内容，使用原始回复
            if (replyParts.length === 0) {
              replyParts = [aiReply.trim() || "嗯～"];
            }

            // 进一步分割：把特殊标签分离成单独的消息
            replyParts = replyParts.flatMap((part) => {
              // 匹配所有特殊标签：表情包、转账、红包、位置、语音、撤回、收款、退款、打电话
              const specialTagRegex =
                /(\[(sticker|表情|表情包|转账|红包|位置|语音|打电话)[：:][^\]]+\]|\[撤回\]|\[收款\]|\[退款\])/gi;
              // 用标签分割，同时保留标签本身
              const segments = part
                .split(specialTagRegex)
                .filter(
                  (s) =>
                    s &&
                    s.trim() &&
                    ![
                      "sticker",
                      "表情",
                      "表情包",
                      "转账",
                      "红包",
                      "位置",
                      "语音",
                      "撤回",
                      "收款",
                      "退款",
                      "打电话",
                    ].includes(s)
                );
              return segments.map((s) => s.trim()).filter((s) => s);
            });

            // 只朗读文字消息
            textToRead = replyParts
              .filter(
                (p) =>
                  !p.match(
                    /^\[(sticker|表情|表情包|转账|红包|位置|语音|撤回|收款|退款|打电话)[：:]?/i
                  )
              )
              .join("，");

            for (let i = 0; i < replyParts.length; i++) {
              await new Promise((resolve) =>
                setTimeout(resolve, i === 0 ? 0 : 800 + Math.random() * 500)
              );

              const partContent = replyParts[i];

              // 检查是否是打电话标签
              const callMatch =
                partContent.match(/^\[打电话[:：](语音|视频)\]$/i);
              if (callMatch) {
                const callType = callMatch[1] === "视频" ? "video" : "voice";
                // 延迟一下再发起来电
                setTimeout(() => {
                  aiInitiateCall(savedCharId, callType);
                }, 1000);
                continue; // 不保存打电话标签本身
              }

              // 检查是否是撤回标签
              const isRecallTag = /^\[撤回\]$/i.test(partContent.trim());
              if (isRecallTag) {
                // 撤回上一条AI消息
                const history = chatHistories[savedCharId];
                if (history && history.length > 0) {
                  // 找到最后一条AI消息并标记为撤回
                  for (let j = history.length - 1; j >= 0; j--) {
                    if (
                      history[j].role === "assistant" &&
                      !history[j].isRecalled
                    ) {
                      history[j].isRecalled = true;
                      break;
                    }
                  }
                  saveAndRenderForChar(savedCharId);
                }
                continue; // 不保存撤回标签本身
              }

              // 检查是否是收款标签
              const isAcceptTag = /^\[收款\]$/i.test(partContent.trim());
              if (isAcceptTag) {
                // 找到最近一条用户发的待处理转账并接收
                const history = chatHistories[savedCharId];
                if (history) {
                  for (let j = history.length - 1; j >= 0; j--) {
                    if (
                      history[j].role === "user" &&
                      history[j].transferId &&
                      history[j].transferStatus === "pending"
                    ) {
                      updateUserTransferStatus(history[j].transferId, true);
                      break;
                    }
                  }
                }
                continue; // 不保存收款标签本身
              }

              // 检查是否是退款标签
              const isRejectTag = /^\[退款\]$/i.test(partContent.trim());
              if (isRejectTag) {
                // 找到最近一条用户发的待处理转账并退回
                const history = chatHistories[savedCharId];
                if (history) {
                  for (let j = history.length - 1; j >= 0; j--) {
                    if (
                      history[j].role === "user" &&
                      history[j].transferId &&
                      history[j].transferStatus === "pending"
                    ) {
                      updateUserTransferStatus(history[j].transferId, false);
                      break;
                    }
                  }
                }
                continue; // 不保存退款标签本身
              }

              const isVoiceMsg = /^\[语音[:：](.+)\]$/.test(partContent);
              const isStickerMsg = /^\[(sticker|表情|表情包)[：:]/i.test(
                partContent
              );

              // 检查是否包含引用标签 [引用:xxx]内容
              let quoteInfo = null;
              let actualContent = partContent;
              const quoteMatch = partContent.match(
                /^\[引用[:：]([^\]]+)\](.*)$/s
              );
              if (quoteMatch) {
                quoteInfo = {
                  sender: "我", // AI引用的是用户说的话
                  senderRole: "user",
                  content: quoteMatch[1],
                  displayContent:
                    quoteMatch[1].length > 50
                      ? quoteMatch[1].substring(0, 50) + "..."
                      : quoteMatch[1],
                };
                actualContent = quoteMatch[2].trim() || partContent; // 如果没有回复内容，保留原始
              }

              const msgObj = {
                role: "assistant",
                content: actualContent,
                time: new Date().toLocaleTimeString("zh-CN", {
                  hour: "2-digit",
                  minute: "2-digit",
                }),
                audioUrl: null,
              };

              // 添加引用信息
              if (quoteInfo) {
                msgObj.quote = quoteInfo;
              }

              chatHistories[savedCharId].push(msgObj);
              saveAndRenderForChar(savedCharId);
              // 【新增】更新列表预览 (每次循环都更新，这样可以看到对方正在一句句发)
              updateCharacterLastMessage(savedCharId, actualContent);

              // 【修复】检查聊天对话页面是否打开，如果没打开则显示通知弹窗和红点（只在最后一条消息时）
              if (i === replyParts.length - 1) {
                const convPage = document.getElementById(
                  "chatConversationPage"
                );
                const isConvPageActive =
                  convPage && convPage.classList.contains("active");
                if (!isConvPageActive || currentChatCharId !== savedCharId) {
                  showMessageNotification(
                    savedCharId,
                    char.name,
                    char.avatar,
                    partContent
                  );
                  addUnreadMessage(savedCharId);
                }
              }

              // 如果是语音消息，自动生成音频
              if (isVoiceMsg && settings.voiceId) {
                const voiceText = partContent.match(/^\[语音[:：](.+)\]$/)[1];
                const msgIndex = chatHistories[savedCharId].length - 1;

                // 异步生成语音，不阻塞后续消息
                generateVoiceForMessageForChar(
                  savedCharId,
                  msgIndex,
                  voiceText,
                  settings
                );
              } else if (i === replyParts.length - 1 && !isVoiceMsg) {
                // 如果最后一条不是语音消息，且开启了自动朗读，触发TTS
                triggerVoiceForChar(savedCharId, msgObj, textToRead, settings);
              }
            }
          }

          if (typeof checkAndTriggerSummary === "function") {
            checkAndTriggerSummary(settings);
          }

          // 自动推进阅读进度（如果开启了一起读书功能）
          advanceReadingProgress();
        } catch (error) {
          document.getElementById("typingIndicator")?.remove();
          alert("AI回复失败: " + error.message);
        } finally {
          btn.disabled = false;
          btn.classList.remove("loading");
          btn.innerHTML = "<span>★</span>";
        }
      }

      function saveAndRender() {
        // localforage 不需要 JSON.stringify
        localforage.setItem("chatHistories", chatHistories);
        renderConversation();
      }

      // 【新增】支持指定charId的保存和渲染函数
      function saveAndRenderForChar(charId) {
        localforage.setItem("chatHistories", chatHistories);
        // 只有当前打开的对话才需要渲染
        if (currentChatCharId === charId) {
          renderConversation();
        }
      }

      // 辅助函数：触发语音生成
      async function triggerVoice(msgObj, text, settings) {
        // 如果用户配置了音色
        if (settings.voiceId) {
          // 找到消息在数组中的索引 (也就是最后一个)
          const history = chatHistories[currentChatCharId];
          const msgIndex = history.length - 1;

          // 异步生成，不阻塞界面（静默生成，不显示提示）
          const audioUrl = await generateSpeech(text, currentChatCharId);

          if (audioUrl) {
            history[msgIndex].audioUrl = audioUrl;
            saveAndRender(); // 重新渲染以显示播放条
          }
        }
      }

      // 【新增】支持指定charId的语音触发函数
      async function triggerVoiceForChar(charId, msgObj, text, settings) {
        if (settings.voiceId) {
          const history = chatHistories[charId];
          if (!history) return;
          const msgIndex = history.length - 1;

          const audioUrl = await generateSpeech(text, charId);

          if (audioUrl && history[msgIndex]) {
            history[msgIndex].audioUrl = audioUrl;
            saveAndRenderForChar(charId);
          }
        }
      }

      // 辅助函数：为语音消息自动生成音频
      async function generateVoiceForMessage(msgIndex, voiceText, settings) {
        if (!settings.voiceId) return;

        const history = chatHistories[currentChatCharId];
        if (!history || !history[msgIndex]) return;

        try {
          const audioUrl = await generateSpeech(voiceText, currentChatCharId);

          if (audioUrl && history[msgIndex]) {
            history[msgIndex].audioUrl = audioUrl;
            // 计算语音时长（估算）
            history[msgIndex].audioDuration =
              Math.ceil(voiceText.length / 5) + '"';
            saveAndRender();
          }
        } catch (e) {
          console.error("Auto voice generation error:", e);
        }
      }

      // 【新增】支持指定charId的语音消息生成函数
      async function generateVoiceForMessageForChar(
        charId,
        msgIndex,
        voiceText,
        settings
      ) {
        if (!settings.voiceId) return;

        const history = chatHistories[charId];
        if (!history || !history[msgIndex]) return;

        try {
          const audioUrl = await generateSpeech(voiceText, charId);

          if (audioUrl && history[msgIndex]) {
            history[msgIndex].audioUrl = audioUrl;
            history[msgIndex].audioDuration =
              Math.ceil(voiceText.length / 5) + '"';
            saveAndRenderForChar(charId);
          }
        } catch (e) {
          console.error("Auto voice generation error:", e);
        }
      }

      // Update character's last message preview
      function updateCharacterLastMessage(charId, message) {
        const char = characters.find((c) => c.id === charId);
        if (char) {
          char.lastMessage = message;
          char.lastTime = new Date().toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          });
          localforage.setItem("characters", characters);
          renderCharacters();
        }
      }

      // Clear chat history
      function clearChatHistory() {
        if (confirm("确定要清空聊天记录吗？")) {
          chatHistories[currentChatCharId] = [];
          localforage.setItem("chatHistories", chatHistories);
          renderConversation();
          toggleConvMenu();
        }
      }

      // Delete character
      function deleteCharacter() {
        if (confirm("确定要删除这个角色吗？聊天记录也会被删除。")) {
          characters = characters.filter((c) => c.id !== currentChatCharId);
          delete chatHistories[currentChatCharId];
          localforage.setItem("characters", characters);
          localforage.setItem("chatHistories", chatHistories);
          closeConversation();
          renderCharacters();
        }
      }

      // Close click outside conversation menu
      document.addEventListener("click", function (e) {
        const menu = document.getElementById("convMenu");
        const menuBtn = document.querySelector(".conv-menu-btn");
        if (
          menu &&
          menu.classList.contains("active") &&
          !menu.contains(e.target) &&
          e.target !== menuBtn
        ) {
          menu.classList.remove("active");
        }
      });

      // ==================== CHAT SETTINGS ====================
      var tempSettingsData = {};

      // Open chat settings
      function openChatSettings() {
        // 检查是否是群聊设置
        if (currentGroupId) {
          openGroupChatSettings();
          return;
        }

        if (!currentChatCharId) return;

        const char = characters.find((c) => c.id === currentChatCharId);
        if (!char) return;

        // Initialize settings for this character if not exists
        if (!chatSettings[currentChatCharId]) {
          chatSettings[currentChatCharId] = {
            charName: char.name || "",
            charNote: char.note || "",
            group: "none",
            otherAvatar: char.avatar || "",
            myAvatar: "",
            persona: "",
            myPersona: "",
            worldbook: "",
            memoryLink: "",
            memoryCount: 5,
            contextCount: 150,
            onlineDating: false,
            longMemory: true,
            summaryMode: "manual",
            triggerCount: 500,
            summaryPrompt:
              "请你以第三人称的视角，客观、冷静、不带任何感情色彩地总结以下对话的核心事件和信息。禁止进行任何角色扮演或添加主观评论。",
            flame: false,
            timeAware: true,
            background: "",
            fontSize: 14,
            bubbleStyle: "none",
            customCSS: "",
          };
        }

        // Load settings into form
        loadSettingsToForm(chatSettings[currentChatCharId], char);

        // Update memory link dropdown
        updateMemoryLinkDropdown();

        // Show settings page
        document.getElementById("chatSettingsPage").classList.add("active");
      }

      // 打开群聊设置
      function openGroupChatSettings() {
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;

        // 初始化群聊设置
        if (!group.settings) {
          group.settings = {
            myNickname: "我",
            myPersona: "",
            backgroundActivity: false,
            timeAware: true,
            background: "",
            memoryLink: "",
            memoryLinks: [],
            memoryLinkCount: 5,
            contextCount: 20,
          };
        }
        // 确保新字段存在
        if (group.settings.memoryLink === undefined)
          group.settings.memoryLink = "";
        if (group.settings.memoryLinks === undefined)
          group.settings.memoryLinks = group.settings.memoryLink
            ? [parseInt(group.settings.memoryLink)]
            : [];
        if (group.settings.memoryLinkCount === undefined)
          group.settings.memoryLinkCount = 5;
        if (group.settings.contextCount === undefined)
          group.settings.contextCount = 20;

        const settingsPage = document.getElementById("groupChatSettingsPage");
        const content = document.getElementById("groupSettingsContent");

        // 获取群成员信息
        const members = group.members
          .map((id) => characters.find((c) => c.id === id))
          .filter(Boolean);

        // 获取群聊消息数
        const messagesKey = "group_messages_" + currentGroupId;
        localforage.getItem(messagesKey).then((msgs) => {
          const msgCount = (msgs || []).length;
          document.getElementById("groupMsgCount").textContent = msgCount;
        });

        // 生成成员显示HTML
        const membersHtml = members
          .map(
            (m) => `
          <div class="group-settings-member-item">
            <div class="group-settings-member-avatar">
              ${m.avatar ? `<img src="${m.avatar}" alt="">` : m.name.charAt(0)}
            </div>
            <div class="group-settings-member-name">${m.name}</div>
          </div>
        `
          )
          .join("");

        // 生成实时预览HTML
        const firstMember = members[0];
        const previewHtml = `
          <div class="chat-preview-group-name">${group.name}</div>
          <div class="chat-preview-msg">
            <div class="chat-preview-avatar">
              ${
                firstMember?.avatar
                  ? `<img src="${firstMember.avatar}" alt="">`
                  : firstMember?.name?.charAt(0) || "?"
              }
            </div>
            <div class="chat-preview-content">
              <div class="chat-preview-name">${
                firstMember?.name || "成员"
              }</div>
              <div class="chat-preview-bubble">对方消息预览</div>
              <div class="chat-preview-time">10:00</div>
            </div>
          </div>
          <div class="chat-preview-msg user">
            <div class="chat-preview-avatar">
              ${
                group.settings.myAvatar
                  ? `<img src="${group.settings.myAvatar}" alt="">`
                  : "👤"
              }
            </div>
            <div class="chat-preview-content">
              <div class="chat-preview-name"><span class="chat-preview-owner-badge">群主</span>${
                group.settings.myNickname || "我"
              }</div>
              <div class="chat-preview-bubble">我的消息预览</div>
              <div class="chat-preview-time">10:00</div>
            </div>
          </div>
        `;

        content.innerHTML = `
          <!-- 基础资料 -->
          <div class="settings-section">
            <div class="section-header">
              <div class="section-icon" style="background:linear-gradient(135deg, #fff3e0, #ffe0b2);">📝</div>
              <span class="section-title">基础资料</span>
            </div>
            <div class="section-body">
              <div class="form-group">
                <label class="form-label">群聊名称 <span class="form-hint">(AI只认这个，修改会影响记忆)</span></label>
                <input type="text" class="form-input" id="groupSettingsName" value="${
                  group.name || ""
                }" placeholder="输入群聊名称...">
              </div>
              <div class="form-group">
                <label class="form-label">我的群昵称</label>
                <input type="text" class="form-input" id="groupSettingsMyNickname" value="${
                  group.settings.myNickname || "我"
                }" placeholder="输入我的群昵称...">
              </div>
              <div class="avatar-upload-row">
                <div class="avatar-upload-col">
                  <div class="avatar-upload-label">群头像</div>
                  <div class="avatar-preview" id="groupAvatarPreview" onclick="document.getElementById('groupSettingsAvatarInput').click()">
                    ${
                      group.avatar
                        ? `<img src="${group.avatar}" style="width:100%;height:100%;object-fit:cover;display:block;">`
                        : '<span style="font-size:24px;">👥</span>'
                    }
                  </div>
                  <input type="file" id="groupSettingsAvatarInput" class="hidden-input" accept="image/*" onchange="previewGroupSettingsAvatar(this)">
                  <div class="avatar-actions">
                    <button class="avatar-action-btn" onclick="document.getElementById('groupSettingsAvatarInput').click()">上传</button>
                  </div>
                </div>
                <div class="avatar-upload-col">
                  <div class="avatar-upload-label">我的头像</div>
                  <div class="avatar-preview" id="groupMyAvatarPreview" onclick="document.getElementById('groupSettingsMyAvatarInput').click()">
                    ${
                      group.settings.myAvatar
                        ? `<img src="${group.settings.myAvatar}" style="width:100%;height:100%;object-fit:cover;display:block;">`
                        : '<span style="font-size:24px;">👤</span>'
                    }
                  </div>
                  <input type="file" id="groupSettingsMyAvatarInput" class="hidden-input" accept="image/*" onchange="previewGroupSettingsMyAvatar(this)">
                  <div class="avatar-actions">
                    <button class="avatar-action-btn" onclick="document.getElementById('groupSettingsMyAvatarInput').click()">上传</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- AI大脑与设定 -->
          <div class="settings-section">
            <div class="section-header">
              <div class="section-icon" style="background:linear-gradient(135deg, #fce4ec, #f8bbd0);">🧠</div>
              <span class="section-title">AI大脑与设定</span>
            </div>
            <div class="section-body">
              <div class="form-group">
                <label class="form-label">我的人设 (My Persona)</label>
                <div style="display:flex;gap:8px;margin-bottom:8px;">
                  <select class="form-select" id="groupPersonaPresetSelect" onchange="loadGroupPersonaPreset(this.value)" style="flex:1;">
                    <option value="">-- 选择预设 --</option>
                  </select>
                  <button class="avatar-action-btn" onclick="saveGroupPersonaPreset()" style="white-space:nowrap;">保存预设</button>
                </div>
                <textarea class="form-input form-textarea" id="groupSettingsMyPersona" placeholder="描述你在群聊中的身份和设定...">${
                  group.settings.myPersona || ""
                }</textarea>
              </div>
              <div class="form-group">
                <label class="form-label">群成员设定</label>
                <div class="group-settings-member-display">
                  <div class="group-settings-member-row" id="groupSettingsMembersList">
                    ${membersHtml}
                  </div>
                </div>
                <button class="group-manage-btn" onclick="openGroupMemberManager()">
                  👥 管理群成员
                </button>
              </div>
              <div class="form-group">
                <label class="form-label">记忆互通 <span class="form-hint">(可多选)</span></label>
                <div class="memory-link-dropdown" id="groupMemoryLinkDropdown">
                  <div class="memory-link-select" onclick="toggleGroupMemoryLinkDropdown()">
                    <span class="memory-link-text" id="groupMemoryLinkText">${
                      (group.settings.memoryLinks || []).length > 0
                        ? "已选择 " +
                          (group.settings.memoryLinks || []).length +
                          " 个聊天"
                        : "点击选择要互通的聊天..."
                    }</span>
                    <span class="memory-link-arrow">▼</span>
                  </div>
                  <div class="memory-link-options" id="groupMemoryLinkOptions">
                    ${(function () {
                      let html = "";
                      // 单聊角色
                      if (characters.length > 0) {
                        html +=
                          '<div class="memory-link-section-title">单聊</div>';
                        html += characters
                          .map((c) => {
                            const isLinked = (
                              group.settings.memoryLinks || []
                            ).includes(c.id);
                            const displayName = c.note || c.name;
                            const isInGroup = group.members.includes(c.id);
                            return (
                              '<div class="memory-link-option ' +
                              (isLinked ? "selected" : "") +
                              '" onclick="toggleGroupMemoryLinkOption(' +
                              c.id +
                              ', this)" data-type="char" data-id="' +
                              c.id +
                              '">' +
                              '<input type="checkbox" ' +
                              (isLinked ? "checked" : "") +
                              ' onclick="event.stopPropagation()">' +
                              '<div class="memory-link-option-avatar">' +
                              (c.avatar
                                ? '<img src="' + c.avatar + '">'
                                : displayName.charAt(0)) +
                              "</div>" +
                              '<span class="memory-link-option-name">' +
                              displayName +
                              (isInGroup
                                ? ' <span style="font-size:10px;color:#999;">(群成员)</span>'
                                : "") +
                              "</span>" +
                              "</div>"
                            );
                          })
                          .join("");
                      }
                      // 其他群聊
                      const otherGroups = groupChats.filter(
                        (g) => g.id !== group.id
                      );
                      if (otherGroups.length > 0) {
                        html +=
                          '<div class="memory-link-section-title">群聊</div>';
                        html += otherGroups
                          .map((g) => {
                            const groupLinkId = "group_" + g.id;
                            const isLinked = (
                              group.settings.memoryLinks || []
                            ).includes(groupLinkId);
                            return (
                              '<div class="memory-link-option ' +
                              (isLinked ? "selected" : "") +
                              '" onclick="toggleGroupMemoryLinkOption(' +
                              "'" +
                              groupLinkId +
                              "'" +
                              ', this)" data-type="group" data-id="' +
                              groupLinkId +
                              '">' +
                              '<input type="checkbox" ' +
                              (isLinked ? "checked" : "") +
                              ' onclick="event.stopPropagation()">' +
                              '<div class="memory-link-option-avatar">' +
                              (g.avatar
                                ? '<img src="' + g.avatar + '">'
                                : "👥") +
                              "</div>" +
                              '<span class="memory-link-option-name">' +
                              (g.name || "群聊") +
                              "</span>" +
                              "</div>"
                            );
                          })
                          .join("");
                      }
                      return (
                        html ||
                        '<div class="memory-link-empty">暂无可互通的聊天</div>'
                      );
                    })()}
                  </div>
                </div>
                <div class="memory-link-tags" id="groupMemoryLinkTags">
                  ${(group.settings.memoryLinks || [])
                    .map((linkId) => {
                      if (
                        typeof linkId === "string" &&
                        linkId.startsWith("group_")
                      ) {
                        const gId = parseInt(linkId.replace("group_", ""));
                        const g = groupChats.find((x) => x.id === gId);
                        if (!g) return "";
                        return (
                          '<span class="memory-link-tag">👥 ' +
                          (g.name || "群聊") +
                          '<span class="memory-link-tag-remove" onclick="removeGroupMemoryLinkTag(' +
                          "'" +
                          linkId +
                          "'" +
                          ')">×</span></span>'
                        );
                      } else {
                        const char = characters.find((c) => c.id === linkId);
                        if (!char) return "";
                        const displayName = char.note || char.name;
                        return (
                          '<span class="memory-link-tag">' +
                          displayName +
                          '<span class="memory-link-tag-remove" onclick="removeGroupMemoryLinkTag(' +
                          linkId +
                          ')">×</span></span>'
                        );
                      }
                    })
                    .join("")}
                </div>
                <div class="form-hint" style="margin-top:6px;font-size:0.75rem;color:#999;">
                  选中后，群里的AI可以了解你与这些聊天的内容
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">互通条数</label>
                <div class="number-input-row">
                  <input type="number" class="number-input" id="groupSettingsMemoryLinkCount" 
                    value="${
                      group.settings.memoryLinkCount || 5
                    }" min="1" max="50" 
                    onchange="updateGroupMemoryLinkCount()">
                  <span class="form-hint">条最近消息</span>
                </div>
              </div>
              <div class="form-group">
                <label class="form-label">上下文记忆条数</label>
                <div class="number-input-row">
                  <input type="number" class="number-input" id="groupSettingsContextCount" 
                    value="${
                      group.settings.contextCount || 20
                    }" min="5" max="100"
                    onchange="updateGroupContextCount()">
                  <span class="form-hint">条群聊历史消息</span>
                </div>
              </div>
            </div>
          </div>

          <!-- 玩法与模式 -->
          <div class="settings-section">
            <div class="section-header">
              <div class="section-icon" style="background:linear-gradient(135deg, #e3f2fd, #bbdefb);">🎮</div>
              <span class="section-title">玩法与模式</span>
            </div>
            <div class="section-body">
              <div class="toggle-row">
                <div>
                  <div class="toggle-label">群聊后台实时活动</div>
                  <div class="toggle-sublabel">成员会在后台自动聊天</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="groupSettingsBackgroundActivity" ${
                    group.settings.backgroundActivity ? "checked" : ""
                  }>
                  <span class="toggle-slider"></span>
                </label>
              </div>
              <div class="toggle-row">
                <div>
                  <div class="toggle-label">实时时间感知</div>
                  <div class="toggle-sublabel">AI感知当前时间</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" id="groupSettingsTimeAware" ${
                    group.settings.timeAware !== false ? "checked" : ""
                  }>
                  <span class="toggle-slider"></span>
                </label>
              </div>
            </div>
          </div>

          <!-- 视觉美化 -->
          <div class="settings-section">
            <div class="section-header">
              <div class="section-icon" style="background:linear-gradient(135deg, #f3e5f5, #e1bee7);">🎨</div>
              <span class="section-title">视觉美化</span>
            </div>
            <div class="section-body">
              <div class="chat-preview-container">
                <div class="chat-preview-title">实时预览</div>
                <div class="chat-preview-box" id="groupChatPreviewBox">
                  ${previewHtml}
                </div>
              </div>
              
              <!-- 聊天背景 -->
              <div class="form-group" style="margin-top:16px;">
                <label class="form-label">聊天背景</label>
                <div class="avatar-upload-row" style="justify-content:flex-start;">
                  <div class="avatar-upload-col">
                    <div class="avatar-preview" id="groupBgPreview" onclick="document.getElementById('groupSettingsBgInput').click()" style="width:80px;height:140px;border-radius:12px;">
                      ${
                        group.settings.background
                          ? `<img src="${group.settings.background}" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:12px;">`
                          : '<span style="font-size:12px;color:#ccc;">无背景</span>'
                      }
                    </div>
                    <input type="file" id="groupSettingsBgInput" class="hidden-input" accept="image/*" onchange="previewGroupSettingsBackground(this)">
                    <div class="avatar-actions">
                      <button class="avatar-action-btn" onclick="document.getElementById('groupSettingsBgInput').click()">上传</button>
                      <button class="avatar-action-btn" onclick="clearGroupSettingsBackground()">清除</button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 视频通话背景 -->
              <div class="form-group" style="margin-top:16px;padding-top:16px;border-top:1px dashed #f0f0f0;">
                <label class="form-label">视频通话背景</label>
                <div class="avatar-upload-row" style="justify-content:flex-start;gap:16px;">
                  <div class="avatar-upload-col">
                    <div class="avatar-upload-label">对方画面</div>
                    <div class="avatar-preview" id="groupVideoPartnerPreview" onclick="document.getElementById('groupVideoPartnerInput').click()" style="width:80px;height:140px;border-radius:12px;">
                      ${
                        group.settings.videoCallPartnerImage
                          ? `<img src="${group.settings.videoCallPartnerImage}" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:12px;">`
                          : '<span style="font-size:12px;color:#ccc;">无背景</span>'
                      }
                    </div>
                    <input type="file" id="groupVideoPartnerInput" class="hidden-input" accept="image/*" onchange="previewGroupVideoPartner(this)">
                    <div class="avatar-actions">
                      <button class="avatar-action-btn" onclick="document.getElementById('groupVideoPartnerInput').click()">上传</button>
                      <button class="avatar-action-btn" onclick="clearGroupVideoPartner()">清除</button>
                    </div>
                  </div>
                  <div class="avatar-upload-col">
                    <div class="avatar-upload-label">我的画面</div>
                    <div class="avatar-preview" id="groupVideoSelfPreview" onclick="document.getElementById('groupVideoSelfInput').click()" style="width:80px;height:140px;border-radius:12px;">
                      ${
                        group.settings.videoCallSelfImage
                          ? `<img src="${group.settings.videoCallSelfImage}" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:12px;">`
                          : '<span style="font-size:12px;color:#ccc;">无背景</span>'
                      }
                    </div>
                    <input type="file" id="groupVideoSelfInput" class="hidden-input" accept="image/*" onchange="previewGroupVideoSelf(this)">
                    <div class="avatar-actions">
                      <button class="avatar-action-btn" onclick="document.getElementById('groupVideoSelfInput').click()">上传</button>
                      <button class="avatar-action-btn" onclick="clearGroupVideoSelf()">清除</button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 气泡颜色设置 -->
              <div class="form-group" style="margin-top:16px;padding-top:16px;border-top:1px dashed #f0f0f0;">
                <label class="form-label">💬 气泡样式</label>
                <div class="form-hint" style="margin-bottom:10px;">自定义消息气泡的颜色和透明度</div>
                
                <!-- 我的气泡 -->
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
                  <span style="font-size:0.8rem;color:#666;width:70px;">我的气泡</span>
                  <input type="color" id="groupUserBubbleColor" 
                    value="${group.settings.userBubbleColor || "#f48fb1"}"
                    style="width:36px;height:28px;border:none;border-radius:4px;cursor:pointer;"
                    onchange="updateGroupChatStyle()">
                  <input type="range" id="groupUserBubbleOpacity" 
                    min="30" max="100" value="${
                      group.settings.userBubbleOpacity || 85
                    }"
                    style="flex:1;"
                    oninput="updateGroupChatStyle(); document.getElementById('groupUserOpacityLabel').textContent=this.value+'%'">
                  <span id="groupUserOpacityLabel" style="font-size:0.75rem;color:#999;width:35px;">${
                    group.settings.userBubbleOpacity || 85
                  }%</span>
                </div>
                
                <!-- AI气泡 -->
                <div style="display:flex;align-items:center;gap:10px;">
                  <span style="font-size:0.8rem;color:#666;width:70px;">TA的气泡</span>
                  <input type="color" id="groupAiBubbleColor" 
                    value="${group.settings.aiBubbleColor || "#ffffff"}"
                    style="width:36px;height:28px;border:none;border-radius:4px;cursor:pointer;"
                    onchange="updateGroupChatStyle()">
                  <input type="range" id="groupAiBubbleOpacity" 
                    min="30" max="100" value="${
                      group.settings.aiBubbleOpacity || 85
                    }"
                    style="flex:1;"
                    oninput="updateGroupChatStyle(); document.getElementById('groupAiOpacityLabel').textContent=this.value+'%'">
                  <span id="groupAiOpacityLabel" style="font-size:0.75rem;color:#999;width:35px;">${
                    group.settings.aiBubbleOpacity || 85
                  }%</span>
                </div>
              </div>
              
              <!-- 字体颜色设置 -->
              <div class="form-group" style="margin-top:16px;">
                <label class="form-label">🎨 字体颜色</label>
                <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                  <span style="font-size:0.8rem;color:#666;width:70px;">我的文字</span>
                  <input type="color" id="groupUserFontColor" 
                    value="${group.settings.userFontColor || "#ffffff"}"
                    style="width:36px;height:28px;border:none;border-radius:4px;cursor:pointer;"
                    onchange="updateGroupChatStyle()">
                </div>
                <div style="display:flex;align-items:center;gap:10px;">
                  <span style="font-size:0.8rem;color:#666;width:70px;">TA的文字</span>
                  <input type="color" id="groupAiFontColor" 
                    value="${group.settings.aiFontColor || "#37474f"}"
                    style="width:36px;height:28px;border:none;border-radius:4px;cursor:pointer;"
                    onchange="updateGroupChatStyle()">
                </div>
              </div>
              
              <!-- 气泡间距设置 -->
              <div class="form-group" style="margin-top:16px;">
                <label class="form-label">📏 气泡间距</label>
                <div style="display:flex;align-items:center;gap:10px;">
                  <input type="range" id="groupBubbleSpacing" 
                    min="4" max="24" value="${
                      group.settings.bubbleSpacing || 12
                    }"
                    style="flex:1;"
                    oninput="updateGroupChatStyle(); document.getElementById('groupSpacingLabel').textContent=this.value+'px'">
                  <span id="groupSpacingLabel" style="font-size:0.75rem;color:#999;width:40px;">${
                    group.settings.bubbleSpacing || 12
                  }px</span>
                </div>
              </div>
              
              <!-- 头像大小设置 -->
              <div class="form-group" style="margin-top:16px;">
                <label class="form-label">👤 群成员头像大小</label>
                <div style="display:flex;align-items:center;gap:10px;">
                  <input type="range" id="groupAvatarSize" 
                    min="24" max="48" value="${group.settings.avatarSize || 32}"
                    style="flex:1;"
                    oninput="updateGroupChatStyle(); document.getElementById('groupAvatarSizeLabel').textContent=this.value+'px'">
                  <span id="groupAvatarSizeLabel" style="font-size:0.75rem;color:#999;width:40px;">${
                    group.settings.avatarSize || 32
                  }px</span>
                </div>
              </div>
              
              <!-- 重置样式按钮 -->
              <div style="margin-top:16px;text-align:center;">
                <button class="avatar-action-btn" onclick="resetGroupChatStyle()" style="background:#f5f5f5;">恢复默认样式</button>
              </div>
            </div>
          </div>

          <!-- 数据与操作 -->
          <div class="settings-section">
            <div class="section-header">
              <div class="section-icon" style="background:linear-gradient(135deg, #e8f5e9, #c8e6c9);">💾</div>
              <span class="section-title">数据与操作</span>
            </div>
            <div class="section-body">
              <div style="display:flex;gap:16px;margin-bottom:16px;">
                <div style="flex:1;text-align:center;padding:12px;background:#f5f5f5;border-radius:12px;">
                  <div style="font-size:0.75rem;color:#999;">总消息</div>
                  <div style="font-size:1.2rem;font-weight:600;color:#666;" id="groupMsgCount">0</div>
                </div>
                <div style="flex:1;text-align:center;padding:12px;background:#f5f5f5;border-radius:12px;">
                  <div style="font-size:0.75rem;color:#999;">群成员</div>
                  <div style="font-size:1.2rem;font-weight:600;color:#666;">${
                    members.length
                  }</div>
                </div>
              </div>
              <div class="data-actions-grid">
                <button class="data-action-btn" onclick="importGroupChat()">📥 导入聊天记录</button>
                <button class="data-action-btn" onclick="exportGroupChat()">📤 导出聊天记录</button>
                <button class="data-action-btn full-width" onclick="clearGroupChat()">🧹 清空聊天记录</button>
                <button class="data-action-btn full-width danger" onclick="dissolveGroup()">⚠️ 解散群聊</button>
              </div>
            </div>
          </div>
        `;

        settingsPage.classList.add("active");

        // 初始化人设预设下拉框
        setTimeout(() => {
          initGroupPersonaPresets();
          applyGroupChatStyle();
        }, 100);
      }

      // 关闭群聊设置
      window.closeGroupChatSettings = function () {
        // 保存设置
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (group) {
          const nameInput = document.getElementById("groupSettingsName");
          const nicknameInput = document.getElementById(
            "groupSettingsMyNickname"
          );
          const personaInput = document.getElementById(
            "groupSettingsMyPersona"
          );
          const bgActivityInput = document.getElementById(
            "groupSettingsBackgroundActivity"
          );
          const timeAwareInput = document.getElementById(
            "groupSettingsTimeAware"
          );
          const memoryLinkCountInput = document.getElementById(
            "groupSettingsMemoryLinkCount"
          );
          const contextCountInput = document.getElementById(
            "groupSettingsContextCount"
          );

          if (nameInput) group.name = nameInput.value || group.name;

          group.settings = group.settings || {};
          if (nicknameInput)
            group.settings.myNickname = nicknameInput.value || "我";
          if (personaInput) group.settings.myPersona = personaInput.value || "";
          if (bgActivityInput)
            group.settings.backgroundActivity = bgActivityInput.checked;
          if (timeAwareInput) group.settings.timeAware = timeAwareInput.checked;

          // 记忆互通已通过下拉框实时保存，这里不需要再处理

          if (memoryLinkCountInput)
            group.settings.memoryLinkCount =
              parseInt(memoryLinkCountInput.value) || 5;
          if (contextCountInput)
            group.settings.contextCount =
              parseInt(contextCountInput.value) || 20;

          // 保存样式设置
          const userBubbleColor = document.getElementById(
            "groupUserBubbleColor"
          );
          const userBubbleOpacity = document.getElementById(
            "groupUserBubbleOpacity"
          );
          const aiBubbleColor = document.getElementById("groupAiBubbleColor");
          const aiBubbleOpacity = document.getElementById(
            "groupAiBubbleOpacity"
          );
          const userFontColor = document.getElementById("groupUserFontColor");
          const aiFontColor = document.getElementById("groupAiFontColor");
          const bubbleSpacing = document.getElementById("groupBubbleSpacing");
          const avatarSize = document.getElementById("groupAvatarSize");

          if (userBubbleColor)
            group.settings.userBubbleColor = userBubbleColor.value;
          if (userBubbleOpacity)
            group.settings.userBubbleOpacity = parseInt(
              userBubbleOpacity.value
            );
          if (aiBubbleColor) group.settings.aiBubbleColor = aiBubbleColor.value;
          if (aiBubbleOpacity)
            group.settings.aiBubbleOpacity = parseInt(aiBubbleOpacity.value);
          if (userFontColor) group.settings.userFontColor = userFontColor.value;
          if (aiFontColor) group.settings.aiFontColor = aiFontColor.value;
          if (bubbleSpacing)
            group.settings.bubbleSpacing = parseInt(bubbleSpacing.value);
          if (avatarSize)
            group.settings.avatarSize = parseInt(avatarSize.value);

          localforage.setItem("groupChats", groupChats);

          // 应用样式到聊天界面
          applyGroupChatStyle();
        }

        const settingsPage = document.getElementById("groupChatSettingsPage");
        if (settingsPage) {
          settingsPage.classList.remove("active");
        }
      };

      // 保存并关闭群聊设置
      window.saveGroupChatSettingsAndClose = function () {
        closeGroupChatSettings();
        showToast("设置已保存");
      };

      // 群聊记忆互通 - 当前选中的角色ID列表
      window.selectedGroupMemoryLinks = [];

      // 切换群聊记忆互通下拉框
      window.toggleGroupMemoryLinkDropdown = function () {
        const dropdown = document.getElementById("groupMemoryLinkDropdown");
        dropdown.classList.toggle("open");

        if (dropdown.classList.contains("open")) {
          setTimeout(() => {
            document.addEventListener(
              "click",
              closeGroupMemoryLinkDropdownOnClickOutside
            );
          }, 0);
        }
      };

      // 点击外部关闭群聊记忆互通下拉框
      function closeGroupMemoryLinkDropdownOnClickOutside(e) {
        const dropdown = document.getElementById("groupMemoryLinkDropdown");
        if (dropdown && !dropdown.contains(e.target)) {
          dropdown.classList.remove("open");
          document.removeEventListener(
            "click",
            closeGroupMemoryLinkDropdownOnClickOutside
          );
        }
      }

      // 切换群聊记忆互通选项（支持角色ID和群聊ID）
      window.toggleGroupMemoryLinkOption = function (linkId, element) {
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;

        group.settings = group.settings || {};
        if (!group.settings.memoryLinks) group.settings.memoryLinks = [];

        const checkbox = element.querySelector('input[type="checkbox"]');
        const index = group.settings.memoryLinks.indexOf(linkId);

        if (index > -1) {
          group.settings.memoryLinks.splice(index, 1);
          element.classList.remove("selected");
          checkbox.checked = false;
        } else {
          group.settings.memoryLinks.push(linkId);
          element.classList.add("selected");
          checkbox.checked = true;
        }

        // 兼容旧版（仅对数字ID）
        const numericLinks = group.settings.memoryLinks.filter(
          (id) => typeof id === "number"
        );
        group.settings.memoryLink =
          numericLinks.length > 0 ? numericLinks[0].toString() : "";

        updateGroupMemoryLinkDisplay();
        localforage.setItem("groupChats", groupChats);
      };

      // 移除群聊记忆互通标签（支持角色ID和群聊ID）
      window.removeGroupMemoryLinkTag = function (linkId) {
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group || !group.settings || !group.settings.memoryLinks) return;

        const index = group.settings.memoryLinks.indexOf(linkId);
        if (index > -1) {
          group.settings.memoryLinks.splice(index, 1);
        }

        // 更新下拉列表中的选中状态
        const options = document.querySelectorAll(
          "#groupMemoryLinkOptions .memory-link-option"
        );
        options.forEach((opt) => {
          const optId = opt.dataset.id;
          if (optId == linkId || parseInt(optId) === linkId) {
            opt.classList.remove("selected");
            const checkbox = opt.querySelector('input[type="checkbox"]');
            if (checkbox) checkbox.checked = false;
          }
        });

        // 兼容旧版
        const numericLinks = group.settings.memoryLinks.filter(
          (id) => typeof id === "number"
        );
        group.settings.memoryLink =
          numericLinks.length > 0 ? numericLinks[0].toString() : "";

        updateGroupMemoryLinkDisplay();
        localforage.setItem("groupChats", groupChats);
      };

      // 更新群聊记忆互通显示（支持角色和群聊）
      function updateGroupMemoryLinkDisplay() {
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;

        const memoryLinks = group.settings?.memoryLinks || [];
        const textEl = document.getElementById("groupMemoryLinkText");
        const tagsEl = document.getElementById("groupMemoryLinkTags");

        if (!textEl || !tagsEl) return;

        if (memoryLinks.length === 0) {
          textEl.textContent = "点击选择要互通的聊天...";
          textEl.style.color = "#999";
          tagsEl.innerHTML = "";
        } else {
          textEl.textContent = `已选择 ${memoryLinks.length} 个聊天`;
          textEl.style.color = "#333";

          // 生成标签
          tagsEl.innerHTML = memoryLinks
            .map((linkId) => {
              if (typeof linkId === "string" && linkId.startsWith("group_")) {
                const gId = parseInt(linkId.replace("group_", ""));
                const g = groupChats.find((x) => x.id === gId);
                if (!g) return "";
                return `
                <span class="memory-link-tag">
                  👥 ${g.name || "群聊"}
                  <span class="memory-link-tag-remove" onclick="removeGroupMemoryLinkTag('${linkId}')">×</span>
                </span>
              `;
              } else {
                const char = characters.find((c) => c.id === linkId);
                if (!char) return "";
                const displayName = char.note || char.name;
                return `
                <span class="memory-link-tag">
                  ${displayName}
                  <span class="memory-link-tag-remove" onclick="removeGroupMemoryLinkTag(${linkId})">×</span>
                </span>
              `;
              }
            })
            .join("");
        }
      }

      // 更新群聊记忆互通设置（兼容旧版）
      window.updateGroupMemoryLinks = function () {
        // 新版使用下拉框，这个函数保留兼容
      };

      // 更新群聊记忆互通设置
      window.updateGroupMemoryLink = function () {
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;
        group.settings = group.settings || {};
        group.settings.memoryLink =
          document.getElementById("groupSettingsMemoryLink")?.value || "";
        localforage.setItem("groupChats", groupChats);
      };

      window.updateGroupMemoryLinkCount = function () {
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;
        group.settings = group.settings || {};
        group.settings.memoryLinkCount =
          parseInt(
            document.getElementById("groupSettingsMemoryLinkCount").value
          ) || 5;
        localforage.setItem("groupChats", groupChats);
      };

      window.updateGroupContextCount = function () {
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;
        group.settings = group.settings || {};
        group.settings.contextCount =
          parseInt(
            document.getElementById("groupSettingsContextCount").value
          ) || 20;
        localforage.setItem("groupChats", groupChats);
      };

      // 保存群聊设置
      function saveGroupSettings() {
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;

        group.name =
          document.getElementById("groupSettingsName").value || group.name;
        group.settings = group.settings || {};
        group.settings.myNickname =
          document.getElementById("groupSettingsMyNickname").value || "我";
        group.settings.myPersona =
          document.getElementById("groupSettingsMyPersona").value || "";
        group.settings.backgroundActivity = document.getElementById(
          "groupSettingsBackgroundActivity"
        ).checked;
        group.settings.timeAware = document.getElementById(
          "groupSettingsTimeAware"
        ).checked;

        // 记忆互通设置
        const memoryLinkInput = document.getElementById(
          "groupSettingsMemoryLink"
        );
        const memoryLinkCountInput = document.getElementById(
          "groupSettingsMemoryLinkCount"
        );
        const contextCountInput = document.getElementById(
          "groupSettingsContextCount"
        );
        if (memoryLinkInput)
          group.settings.memoryLink = memoryLinkInput.value || "";
        if (memoryLinkCountInput)
          group.settings.memoryLinkCount =
            parseInt(memoryLinkCountInput.value) || 5;
        if (contextCountInput)
          group.settings.contextCount = parseInt(contextCountInput.value) || 20;

        localforage.setItem("groupChats", groupChats);
        showToast("群聊设置已保存");
      }

      // 预览群设置中的群头像
      window.previewGroupSettingsAvatar = function (input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const preview = document.getElementById("groupAvatarPreview");
            preview.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;display:block;">`;

            const group = groupChats.find((g) => g.id === currentGroupId);
            if (group) {
              group.avatar = e.target.result;
              localforage.setItem("groupChats", groupChats);
            }
          };
          reader.readAsDataURL(input.files[0]);
        }
      };

      // 预览群设置中我的头像
      window.previewGroupSettingsMyAvatar = function (input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const preview = document.getElementById("groupMyAvatarPreview");
            preview.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;display:block;">`;

            const group = groupChats.find((g) => g.id === currentGroupId);
            if (group) {
              group.settings = group.settings || {};
              group.settings.myAvatar = e.target.result;
              localforage.setItem("groupChats", groupChats);
              updateGroupChatPreview();
            }
          };
          reader.readAsDataURL(input.files[0]);
        }
      };

      // 预览群聊背景
      window.previewGroupSettingsBackground = function (input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const preview = document.getElementById("groupBgPreview");
            preview.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:12px;">`;

            const group = groupChats.find((g) => g.id === currentGroupId);
            if (group) {
              group.settings = group.settings || {};
              group.settings.background = e.target.result;
              localforage.setItem("groupChats", groupChats);
            }
          };
          reader.readAsDataURL(input.files[0]);
        }
      };

      // 清除群聊背景
      window.clearGroupSettingsBackground = function () {
        const preview = document.getElementById("groupBgPreview");
        preview.innerHTML =
          '<span style="font-size:12px;color:#ccc;">无背景</span>';

        const group = groupChats.find((g) => g.id === currentGroupId);
        if (group && group.settings) {
          group.settings.background = "";
          localforage.setItem("groupChats", groupChats);
        }
      };

      // 群聊视频通话背景 - 对方画面
      window.previewGroupVideoPartner = function (input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const preview = document.getElementById("groupVideoPartnerPreview");
            preview.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:12px;">`;

            const group = groupChats.find((g) => g.id === currentGroupId);
            if (group) {
              group.settings = group.settings || {};
              group.settings.videoCallPartnerImage = e.target.result;
              localforage.setItem("groupChats", groupChats);
            }
          };
          reader.readAsDataURL(input.files[0]);
        }
      };

      window.clearGroupVideoPartner = function () {
        const preview = document.getElementById("groupVideoPartnerPreview");
        preview.innerHTML =
          '<span style="font-size:12px;color:#ccc;">无背景</span>';

        const group = groupChats.find((g) => g.id === currentGroupId);
        if (group && group.settings) {
          group.settings.videoCallPartnerImage = "";
          localforage.setItem("groupChats", groupChats);
        }
      };

      // 群聊视频通话背景 - 我的画面
      window.previewGroupVideoSelf = function (input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const preview = document.getElementById("groupVideoSelfPreview");
            preview.innerHTML = `<img src="${e.target.result}" style="width:100%;height:100%;object-fit:cover;display:block;border-radius:12px;">`;

            const group = groupChats.find((g) => g.id === currentGroupId);
            if (group) {
              group.settings = group.settings || {};
              group.settings.videoCallSelfImage = e.target.result;
              localforage.setItem("groupChats", groupChats);
            }
          };
          reader.readAsDataURL(input.files[0]);
        }
      };

      window.clearGroupVideoSelf = function () {
        const preview = document.getElementById("groupVideoSelfPreview");
        preview.innerHTML =
          '<span style="font-size:12px;color:#ccc;">无背景</span>';

        const group = groupChats.find((g) => g.id === currentGroupId);
        if (group && group.settings) {
          group.settings.videoCallSelfImage = "";
          localforage.setItem("groupChats", groupChats);
        }
      };

      // ==================== 群聊样式设置函数 ====================

      // 更新群聊样式（实时预览和保存）
      window.updateGroupChatStyle = function () {
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;

        group.settings = group.settings || {};

        // 读取当前设置值
        const userBubbleColor =
          document.getElementById("groupUserBubbleColor")?.value || "#f48fb1";
        const userBubbleOpacity =
          parseInt(document.getElementById("groupUserBubbleOpacity")?.value) ||
          85;
        const aiBubbleColor =
          document.getElementById("groupAiBubbleColor")?.value || "#ffffff";
        const aiBubbleOpacity =
          parseInt(document.getElementById("groupAiBubbleOpacity")?.value) ||
          85;
        const userFontColor =
          document.getElementById("groupUserFontColor")?.value || "#ffffff";
        const aiFontColor =
          document.getElementById("groupAiFontColor")?.value || "#37474f";
        const bubbleSpacing =
          parseInt(document.getElementById("groupBubbleSpacing")?.value) || 12;
        const avatarSize =
          parseInt(document.getElementById("groupAvatarSize")?.value) || 32;

        // 保存设置
        group.settings.userBubbleColor = userBubbleColor;
        group.settings.userBubbleOpacity = userBubbleOpacity;
        group.settings.aiBubbleColor = aiBubbleColor;
        group.settings.aiBubbleOpacity = aiBubbleOpacity;
        group.settings.userFontColor = userFontColor;
        group.settings.aiFontColor = aiFontColor;
        group.settings.bubbleSpacing = bubbleSpacing;
        group.settings.avatarSize = avatarSize;

        localforage.setItem("groupChats", groupChats);

        // 更新预览
        updateGroupChatPreviewStyle();

        // 应用到聊天界面
        applyGroupChatStyle();
      };

      // 更新设置页面中的预览样式
      function updateGroupChatPreviewStyle() {
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group || !group.settings) return;

        const previewBox = document.getElementById("groupChatPreviewBox");
        if (!previewBox) return;

        const userBubbles = previewBox.querySelectorAll(
          ".chat-preview-msg.user .chat-preview-bubble"
        );
        const aiBubbles = previewBox.querySelectorAll(
          ".chat-preview-msg:not(.user) .chat-preview-bubble"
        );

        const userBubbleColor = group.settings.userBubbleColor || "#f48fb1";
        const userBubbleOpacity =
          (group.settings.userBubbleOpacity || 85) / 100;
        const aiBubbleColor = group.settings.aiBubbleColor || "#ffffff";
        const aiBubbleOpacity = (group.settings.aiBubbleOpacity || 85) / 100;

        userBubbles.forEach((bubble) => {
          bubble.style.background = hexToRgba(
            userBubbleColor,
            userBubbleOpacity
          );
          bubble.style.color = group.settings.userFontColor || "#ffffff";
        });

        aiBubbles.forEach((bubble) => {
          bubble.style.background = hexToRgba(aiBubbleColor, aiBubbleOpacity);
          bubble.style.color = group.settings.aiFontColor || "#37474f";
        });
      }

      // 应用群聊样式到聊天界面
      function applyGroupChatStyle() {
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group || !group.settings) return;

        // 移除旧样式
        const existingStyle = document.getElementById("groupChatStyle");
        if (existingStyle) existingStyle.remove();

        const userBubbleColor = group.settings.userBubbleColor || "#f48fb1";
        const userBubbleOpacity =
          (group.settings.userBubbleOpacity || 85) / 100;
        const aiBubbleColor = group.settings.aiBubbleColor || "#ffffff";
        const aiBubbleOpacity = (group.settings.aiBubbleOpacity || 85) / 100;
        const userFontColor = group.settings.userFontColor || "#ffffff";
        const aiFontColor = group.settings.aiFontColor || "#37474f";
        const bubbleSpacing = group.settings.bubbleSpacing || 12;
        const avatarSize = group.settings.avatarSize || 32;

        const styleSheet = document.createElement("style");
        styleSheet.id = "groupChatStyle";
        styleSheet.textContent = `
          /* 群聊用户气泡（排除表情包） */
          .msg-row.user .msg-bubble:not(.sticker-bubble) {
            background: ${hexToRgba(
              userBubbleColor,
              userBubbleOpacity
            )} !important;
            color: ${userFontColor} !important;
          }
          /* 群聊AI气泡（排除表情包） */
          .msg-row.ai.group-msg .msg-bubble:not(.sticker-bubble) {
            background: ${hexToRgba(aiBubbleColor, aiBubbleOpacity)} !important;
            color: ${aiFontColor} !important;
          }
          /* 气泡间距 */
          .msg-row {
            margin-bottom: ${bubbleSpacing}px !important;
          }
          /* 群成员头像大小 */
          .msg-row.ai.group-msg .msg-sender-avatar {
            width: ${avatarSize}px !important;
            height: ${avatarSize}px !important;
          }
          .msg-row.ai.group-msg {
            padding-left: ${avatarSize + 8}px !important;
          }
        `;
        document.head.appendChild(styleSheet);
      }

      // 重置群聊样式
      window.resetGroupChatStyle = function () {
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;

        group.settings = group.settings || {};
        group.settings.userBubbleColor = "#f48fb1";
        group.settings.userBubbleOpacity = 85;
        group.settings.aiBubbleColor = "#ffffff";
        group.settings.aiBubbleOpacity = 85;
        group.settings.userFontColor = "#ffffff";
        group.settings.aiFontColor = "#37474f";
        group.settings.bubbleSpacing = 12;
        group.settings.avatarSize = 32;

        // 更新界面控件
        const userBubbleColor = document.getElementById("groupUserBubbleColor");
        const userBubbleOpacity = document.getElementById(
          "groupUserBubbleOpacity"
        );
        const aiBubbleColor = document.getElementById("groupAiBubbleColor");
        const aiBubbleOpacity = document.getElementById("groupAiBubbleOpacity");
        const userFontColor = document.getElementById("groupUserFontColor");
        const aiFontColor = document.getElementById("groupAiFontColor");
        const bubbleSpacing = document.getElementById("groupBubbleSpacing");
        const avatarSize = document.getElementById("groupAvatarSize");

        if (userBubbleColor) userBubbleColor.value = "#f48fb1";
        if (userBubbleOpacity) userBubbleOpacity.value = 85;
        if (aiBubbleColor) aiBubbleColor.value = "#ffffff";
        if (aiBubbleOpacity) aiBubbleOpacity.value = 85;
        if (userFontColor) userFontColor.value = "#ffffff";
        if (aiFontColor) aiFontColor.value = "#37474f";
        if (bubbleSpacing) bubbleSpacing.value = 12;
        if (avatarSize) avatarSize.value = 32;

        // 更新标签
        const userOpacityLabel = document.getElementById(
          "groupUserOpacityLabel"
        );
        const aiOpacityLabel = document.getElementById("groupAiOpacityLabel");
        const spacingLabel = document.getElementById("groupSpacingLabel");
        const avatarSizeLabel = document.getElementById("groupAvatarSizeLabel");

        if (userOpacityLabel) userOpacityLabel.textContent = "85%";
        if (aiOpacityLabel) aiOpacityLabel.textContent = "85%";
        if (spacingLabel) spacingLabel.textContent = "12px";
        if (avatarSizeLabel) avatarSizeLabel.textContent = "32px";

        localforage.setItem("groupChats", groupChats);
        updateGroupChatPreviewStyle();
        applyGroupChatStyle();

        showToast("样式已重置 ★");
      };

      // 辅助函数：十六进制颜色转RGBA
      function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }

      // ==================== 群聊人设预设函数 ====================

      // 初始化群聊人设预设下拉菜单（与单人聊天共享预设）
      function initGroupPersonaPresets() {
        const select = document.getElementById("groupPersonaPresetSelect");
        if (!select) return;

        // 保留第一个默认选项，清除其他的
        while (select.options.length > 1) {
          select.remove(1);
        }

        // 使用与单人聊天相同的预设列表
        if (userPersonaPresets && userPersonaPresets.length > 0) {
          userPersonaPresets.forEach((preset) => {
            const option = document.createElement("option");
            option.value = preset.id;
            option.textContent = preset.name;
            select.appendChild(option);
          });
        }
      }

      // 加载群聊人设预设
      window.loadGroupPersonaPreset = function (presetId) {
        if (!presetId) return;

        const preset = userPersonaPresets.find((p) => p.id === presetId);
        if (!preset) return;

        // 填入人设文本
        const personaInput = document.getElementById("groupSettingsMyPersona");
        if (personaInput) {
          personaInput.value = preset.persona;
        }

        // 如果预设里有头像，也一起加载
        if (preset.avatar && preset.avatar.startsWith("data:")) {
          const group = groupChats.find((g) => g.id === currentGroupId);
          if (group) {
            group.settings = group.settings || {};
            group.settings.myAvatar = preset.avatar;

            const preview = document.getElementById("groupMyAvatarPreview");
            if (preview) {
              preview.innerHTML = `<img src="${preset.avatar}" style="width:100%;height:100%;object-fit:cover;display:block;">`;
            }

            localforage.setItem("groupChats", groupChats);
            updateGroupChatPreview();
          }
        }

        showToast(`已切换至：${preset.name}`);
      };

      // 保存当前群聊配置为新预设（与单人聊天预设共享）
      window.saveGroupPersonaPreset = function () {
        const personaInput = document.getElementById("groupSettingsMyPersona");
        const currentPersona = personaInput?.value?.trim() || "";

        if (!currentPersona) {
          alert("请先填写人设内容再保存预设！");
          return;
        }

        const name = prompt(
          "请为当前人设取个名字（例如：高冷霸总、撒娇小猫）："
        );
        if (!name) return;

        const group = groupChats.find((g) => g.id === currentGroupId);
        const currentAvatar = group?.settings?.myAvatar || "";

        const newPreset = {
          id: Date.now().toString(),
          name: name,
          persona: currentPersona,
          avatar: currentAvatar,
        };

        userPersonaPresets.push(newPreset);
        localforage.setItem("userPersonaPresets", userPersonaPresets);

        showToast("预设已保存 ★");
        initGroupPersonaPresets(); // 刷新下拉框
      };

      // 更新群聊预览
      function updateGroupChatPreview() {
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;

        const members = group.members
          .map((id) => characters.find((c) => c.id === id))
          .filter(Boolean);
        const firstMember = members[0];

        const previewBox = document.getElementById("groupChatPreviewBox");
        if (previewBox) {
          previewBox.innerHTML = `
            <div class="chat-preview-group-name">${group.name}</div>
            <div class="chat-preview-msg">
              <div class="chat-preview-avatar">
                ${
                  firstMember?.avatar
                    ? `<img src="${firstMember.avatar}" alt="">`
                    : firstMember?.name?.charAt(0) || "?"
                }
              </div>
              <div class="chat-preview-content">
                <div class="chat-preview-name">${
                  firstMember?.name || "成员"
                }</div>
                <div class="chat-preview-bubble">对方消息预览</div>
                <div class="chat-preview-time">10:00</div>
              </div>
            </div>
            <div class="chat-preview-msg user">
              <div class="chat-preview-avatar">
                ${
                  group.settings?.myAvatar
                    ? `<img src="${group.settings.myAvatar}" alt="">`
                    : "👤"
                }
              </div>
              <div class="chat-preview-content">
                <div class="chat-preview-name"><span class="chat-preview-owner-badge">群主</span>${
                  group.settings?.myNickname || "我"
                }</div>
                <div class="chat-preview-bubble">我的消息预览</div>
                <div class="chat-preview-time">10:00</div>
              </div>
            </div>
          `;
        }
      }

      // 打开群成员管理
      window.openGroupMemberManager = function () {
        if (!currentGroupId) return;
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;

        // 不关闭设置页面，直接在上层显示管理弹窗
        renderManageMembersList(group);
        document
          .getElementById("groupMemberManagerModal")
          .classList.add("active");
      };

      // 关闭群成员管理弹窗
      window.closeGroupMemberManager = function () {
        document
          .getElementById("groupMemberManagerModal")
          .classList.remove("active");
        // 刷新群聊设置页面中的成员显示
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (group) {
          renderGroupSettingsMembers();
        }
      };

      // 渲染群成员管理列表
      function renderManageMembersList(group) {
        const container = document.getElementById("manageMembersList");
        const members = group.members
          .map((id) => characters.find((c) => c.id === id))
          .filter(Boolean);

        document.getElementById(
          "manageMembersCount"
        ).textContent = `共 ${members.length} 人`;

        if (members.length === 0) {
          container.innerHTML = `
            <div class="create-group-empty">
              <div class="create-group-empty-icon">😅</div>
              <div>群里还没有成员</div>
            </div>
          `;
          return;
        }

        container.innerHTML = members
          .map((char) => {
            const displayName = char.note || char.name;
            const canRemove = members.length > 2; // 至少保留2人
            return `
            <div class="create-group-member-item" style="cursor: default;">
              <div class="create-group-member-avatar">
                ${
                  char.avatar
                    ? `<img src="${char.avatar}">`
                    : char.name.charAt(0)
                }
              </div>
              <div class="create-group-member-info" style="flex: 1;">
                <div class="create-group-member-name">${displayName}</div>
              </div>
              ${
                canRemove
                  ? `
                <button class="group-member-remove-btn" onclick="event.stopPropagation();removeGroupMemberFromManager(${char.id})" 
                  style="background: linear-gradient(135deg, #ff6b6b, #ee5a5a); color: white; border: none; 
                    border-radius: 16px; padding: 6px 14px; font-size: 12px; cursor: pointer;
                    box-shadow: 0 2px 8px rgba(255,107,107,0.3);">
                  移出
                </button>
              `
                  : `
                <span style="font-size: 11px; color: #999; padding: 6px 10px;">群主</span>
              `
              }
            </div>
          `;
          })
          .join("");
      }

      // 从管理界面移除群成员
      async function removeGroupMemberFromManager(charId) {
        if (!currentGroupId) return;
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;

        if (group.members.length <= 2) {
          showToast("群聊至少需要2个成员");
          return;
        }

        const char = characters.find((c) => c.id === charId);
        const charName = char ? char.note || char.name : "成员";

        if (!confirm(`确定要将「${charName}」移出群聊吗？`)) return;

        group.members = group.members.filter((id) => id !== charId);
        await localforage.setItem("groupChats", groupChats);

        // 添加系统消息
        const messagesKey = `group_messages_${currentGroupId}`;
        const messages = (await localforage.getItem(messagesKey)) || [];
        messages.push({
          role: "system",
          content: `${charName} 离开了群聊`,
          time: new Date().toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          }),
        });
        await localforage.setItem(messagesKey, messages);

        showToast(`已移除 ${charName}`);
        renderManageMembersList(group);
        loadGroupMessages(currentGroupId);
      }

      // 导出群聊记录
      window.exportGroupChat = function () {
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;

        const messagesKey = "group_messages_" + currentGroupId;
        localforage.getItem(messagesKey).then((messages) => {
          if (!messages || messages.length === 0) {
            showToast("没有聊天记录可导出");
            return;
          }

          const members = group.members
            .map((id) => characters.find((c) => c.id === id))
            .filter(Boolean);
          let text = `群聊: ${group.name}\n成员: ${members
            .map((m) => m.name)
            .join(", ")}\n导出时间: ${new Date().toLocaleString()}\n\n`;

          messages.forEach((msg) => {
            if (msg.role === "user") {
              text += `[${msg.time || ""}] ${
                group.settings?.myNickname || "我"
              }: ${msg.content}\n`;
            } else if (msg.role === "assistant") {
              const member = characters.find((c) => c.id === msg.charId);
              text += `[${msg.time || ""}] ${member?.name || "成员"}: ${
                msg.content
              }\n`;
            } else if (msg.role === "system") {
              text += `--- ${msg.content} ---\n`;
            }
          });

          const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `群聊_${group.name}_${new Date()
            .toISOString()
            .slice(0, 10)}.txt`;
          a.click();
          URL.revokeObjectURL(url);
          showToast("导出成功");
        });
      };

      // 清空群聊记录
      window.clearGroupChat = function () {
        if (!currentGroupId) {
          showToast("没有选中的群聊");
          return;
        }
        if (!confirm("确定要清空所有群聊记录吗？此操作不可恢复！")) return;

        const messagesKey = "group_messages_" + currentGroupId;
        localforage.setItem(messagesKey, []).then(() => {
          showToast("聊天记录已清空");
          const msgCountEl = document.getElementById("groupMsgCount");
          if (msgCountEl) msgCountEl.textContent = "0";

          // 刷新群聊消息显示
          loadGroupMessages(currentGroupId);

          // 更新群聊列表的最后消息
          const group = groupChats.find((g) => g.id === currentGroupId);
          if (group) {
            group.lastMessage = "";
            group.lastTime = "";
            localforage.setItem("groupChats", groupChats);
            renderCharacters();
          }
        });
      };

      // Load settings data into form
      function loadSettingsToForm(settings, char) {
        // Basic info
        document.getElementById("settingsCharName").value =
          settings.charName || char.name || "";
        document.getElementById("settingsCharNote").value =
          settings.charNote || char.note || "";
        document.getElementById("settingsGroup").value =
          settings.group || "none";

        // Avatars
        loadAvatarPreview("other", settings.otherAvatar || char.avatar);
        loadAvatarPreview("my", settings.myAvatar);

        // 头像显示开关
        document.getElementById("showAiAvatar").checked =
          settings.showAiAvatar !== false;
        document.getElementById("showUserAvatar").checked =
          settings.showUserAvatar !== false;

        // 头像大小
        const avatarSize = char.avatarSize || 40;
        document.getElementById("avatarSizeSlider").value = avatarSize;
        document.getElementById("avatarSizeValue").textContent =
          avatarSize + "px";
        applyAvatarSize(avatarSize);

        // 气泡间距
        const bubbleGap = char.bubbleGap || 6;
        document.getElementById("bubbleGapSlider").value = bubbleGap;
        document.getElementById("bubbleGapValue").textContent =
          bubbleGap + "px";
        applyBubbleGap(bubbleGap);

        // 置顶设置
        document.getElementById("settingsPinned").checked =
          settings.pinned || false;

        // AI Brain
        document.getElementById("settingsPersona").value =
          settings.persona || "";
        document.getElementById("settingsMyPersona").value =
          settings.myPersona || "";

        // 世界书（支持多选）
        const worldbookIds = settings.worldbook
          ? settings.worldbook.split(",").filter((s) => s)
          : [];
        document.getElementById("settingsWorldbook").value =
          settings.worldbook || "";
        renderWorldbookSelectList(worldbookIds);

        // Memory
        document.getElementById("settingsMemoryCount").value =
          settings.memoryCount || 5;
        document.getElementById("settingsContextCount").value =
          settings.contextCount || 150;

        // Update message count
        const history = chatHistories[currentChatCharId] || [];
        document.getElementById("settingsTotalMsg").textContent =
          history.length;
        document.getElementById("settingsTokenCount").textContent =
          estimateTokens(history);

        // Play mode
        document.getElementById("settingsOnlineDating").checked =
          settings.onlineDating || false;
        document.getElementById("settingsLongMemory").checked =
          settings.longMemory !== false;
        document.getElementById("settingsTriggerCount").value =
          settings.triggerCount || 500;
        document.getElementById("settingsSummaryPrompt").value =
          settings.summaryPrompt || "";
        document.getElementById("settingsFlame").checked =
          settings.flame || false;
        document.getElementById("settingsTimeAware").checked =
          settings.timeAware !== false;

        // Summary mode radio
        const summaryMode = settings.summaryMode || "manual";
        document.getElementById("settingsSummaryMode").value = summaryMode;
        document.querySelectorAll(".radio-option").forEach((opt) => {
          opt.classList.toggle("active", opt.dataset.value === summaryMode);
        });

        // Visual
        loadBackgroundPreview(settings.background);
        document.getElementById("settingsFontSize").value =
          settings.fontSize || 14;
        document.getElementById("fontSizeValue").textContent =
          (settings.fontSize || 14) + "px";
        document.getElementById("settingsUserBubbleColor").value =
          settings.userBubbleColor || "#c2185b";
        document.getElementById("settingsAiBubbleColor").value =
          settings.aiBubbleColor || "#37474f";
        document.getElementById("settingsBubbleStyle").value =
          settings.bubbleStyle || "none";
        document.getElementById("settingsCustomCSS").value =
          settings.customCSS || "";

        // Update preview avatars
        updateChatPreview(settings, char);
        // ... 之前的代码 ...

        // 【新增】初始化火花设置 UI 和数据回显
        initFlameSettingsUI(); // 先注入 UI

        // 稍微延迟一点点赋值，确保 DOM 已经生成
        setTimeout(() => {
          if (document.getElementById("settingsFlameIcon")) {
            const fData = settings.flameData || { icon: "♨", days: 1 };
            document.getElementById("settingsFlameIcon").value =
              fData.icon || "♨";
            document.getElementById("settingsFlameDays").value =
              fData.days || 1;

            // 触发一次显示/隐藏逻辑
            const area = document.getElementById("flameSettingsArea");
            if (area)
              area.style.display = document.getElementById("settingsFlame")
                .checked
                ? "block"
                : "none";
          }
        }, 0);
        // ✓ 加在这里 (loadSettingsToForm 函数内部的末尾)：
        document.getElementById("settingsVoiceId").value =
          settings.voiceId || "";

        // 通话设置加载
        const callVoiceCheckbox = document.getElementById(
          "settingsCallVoiceEnabled"
        );
        const aiCallCheckbox = document.getElementById("settingsAiCallEnabled");
        if (callVoiceCheckbox) {
          callVoiceCheckbox.checked = settings.callVoiceEnabled || false;
        }
        if (aiCallCheckbox) {
          aiCallCheckbox.checked = settings.aiCallEnabled || false;
        }

        // 视频通话画面加载
        const partnerImg = document.getElementById("videoCallPartnerImg");
        const partnerPlaceholder = document.getElementById(
          "videoCallPartnerPlaceholder"
        );
        const selfImg = document.getElementById("videoCallSelfImg");
        const selfPlaceholder = document.getElementById(
          "videoCallSelfPlaceholder"
        );

        if (settings.videoCallPartnerImage && partnerImg) {
          partnerImg.src = settings.videoCallPartnerImage;
          partnerImg.style.display = "block";
          if (partnerPlaceholder) partnerPlaceholder.style.display = "none";
        } else if (partnerImg) {
          partnerImg.style.display = "none";
          if (partnerPlaceholder) partnerPlaceholder.style.display = "flex";
        }

        if (settings.videoCallSelfImage && selfImg) {
          selfImg.src = settings.videoCallSelfImage;
          selfImg.style.display = "block";
          if (selfPlaceholder) selfPlaceholder.style.display = "none";
        } else if (selfImg) {
          selfImg.style.display = "none";
          if (selfPlaceholder) selfPlaceholder.style.display = "flex";
        }

        // 通话气泡颜色加载
        const callUserColorInput = document.getElementById(
          "settingsCallUserBubbleColor"
        );
        const callUserOpacityInput = document.getElementById(
          "settingsCallUserBubbleOpacity"
        );
        const callAiColorInput = document.getElementById(
          "settingsCallAiBubbleColor"
        );
        const callAiOpacityInput = document.getElementById(
          "settingsCallAiBubbleOpacity"
        );

        if (callUserColorInput) {
          callUserColorInput.value = settings.callUserBubbleColor || "#f48fb1";
        }
        if (callUserOpacityInput) {
          callUserOpacityInput.value = settings.callUserBubbleOpacity || 85;
          const label = document.getElementById("callUserOpacityLabel");
          if (label)
            label.textContent = (settings.callUserBubbleOpacity || 85) + "%";
        }
        if (callAiColorInput) {
          callAiColorInput.value = settings.callAiBubbleColor || "#ffffff";
        }
        if (callAiOpacityInput) {
          callAiOpacityInput.value = settings.callAiBubbleOpacity || 85;
          const label = document.getElementById("callAiOpacityLabel");
          if (label)
            label.textContent = (settings.callAiBubbleOpacity || 85) + "%";
        }

        // 线下模式设置初始化
        const offlineWordSettings = document.getElementById(
          "offlineWordSettings"
        );
        if (offlineWordSettings) {
          if (settings.onlineDating) {
            offlineWordSettings.classList.add("active");
          } else {
            offlineWordSettings.classList.remove("active");
          }
        }

        // 设置字数范围
        if (document.getElementById("offlineMinWords")) {
          document.getElementById("offlineMinWords").value =
            settings.offlineMinWords || 100;
        }
        if (document.getElementById("offlineMaxWords")) {
          document.getElementById("offlineMaxWords").value =
            settings.offlineMaxWords || 500;
        }

        // 更新并设置预设下拉框
        updateOfflinePresetDropdown();
        if (document.getElementById("offlinePresetSelect")) {
          document.getElementById("offlinePresetSelect").value =
            settings.offlinePresetId || "";
        }
      }

      // Load avatar preview
      function loadAvatarPreview(type, src) {
        const placeholder = document.getElementById(type + "AvatarPlaceholder");
        const img = document.getElementById(type + "AvatarImg");
        const container = document.getElementById(
          "settings" + (type === "other" ? "Other" : "My") + "Avatar"
        );

        if (src) {
          img.src = src;
          img.style.display = "block";
          placeholder.style.display = "none";
          container.classList.add("has-image");
        } else {
          img.style.display = "none";
          placeholder.style.display = "block";
          container.classList.remove("has-image");
        }
      }

      // 修改后的设置页头像预览（带压缩）
      async function previewSettingsAvatar(input, type) {
        const file = input.files[0];
        if (file) {
          // 头像压缩到 300px
          const compressedData = await compressImage(file, 300, 0.7);

          loadAvatarPreview(type, compressedData);
          // 更新预览显示
          if (type === "other") {
            document.getElementById(
              "previewOtherAvatar"
            ).innerHTML = `<img src="${compressedData}">`;
          } else {
            document.getElementById(
              "previewMyAvatar"
            ).innerHTML = `<img src="${compressedData}">`;
          }
        }
      }

      // Clear settings avatar
      function clearSettingsAvatar(type) {
        loadAvatarPreview(type, "");
        if (type === "other") {
          document.getElementById("previewOtherAvatar").innerHTML = "🤖";
          document.getElementById("otherAvatarInput").value = "";
        } else {
          document.getElementById("previewMyAvatar").innerHTML = "我";
          document.getElementById("myAvatarInput").value = "";
        }
      }

      // Load background preview
      function loadBackgroundPreview(src) {
        const placeholder = document.getElementById("bgPreviewPlaceholder");
        const img = document.getElementById("bgPreviewImg");

        if (src) {
          img.src = src;
          img.style.display = "block";
          placeholder.style.display = "none";
        } else {
          img.style.display = "none";
          placeholder.style.display = "block";
        }
      }

      // 修改后的背景图预览（带压缩）
      async function previewBackground(input) {
        const file = input.files[0];
        if (file) {
          // 背景图宽一点，设为 800px，质量 0.6 足够了
          const compressedData = await compressImage(file, 800, 0.6);
          loadBackgroundPreview(compressedData);
        }
      }

      // Update font size preview
      function updateFontSizePreview(value) {
        document.getElementById("fontSizeValue").textContent = value + "px";
        document.getElementById("previewOtherBubble").style.fontSize =
          value + "px";
        document.getElementById("previewMyBubble").style.fontSize =
          value + "px";
      }

      // Select radio option
      function selectRadio(element, groupName) {
        const group = element.parentElement;
        group
          .querySelectorAll(".radio-option")
          .forEach((opt) => opt.classList.remove("active"));
        element.classList.add("active");
        document.getElementById(
          "settings" + groupName.charAt(0).toUpperCase() + groupName.slice(1)
        ).value = element.dataset.value;
      }

      // Update memory link dropdown
      function updateMemoryLinkDropdown() {
        // 新版多选下拉框
        initMemoryLinkMultiSelect();
      }

      // 单聊记忆互通 - 当前选中的ID列表（角色ID或群聊ID如"group_1"）
      window.selectedMemoryLinks = [];

      // 初始化记忆互通多选下拉框
      function initMemoryLinkMultiSelect() {
        const optionsContainer = document.getElementById("memoryLinkOptions");
        if (!optionsContainer) return;

        // 获取当前设置中已选中的
        const settings = chatSettings[currentChatCharId] || {};
        window.selectedMemoryLinks = settings.memoryLinks || [];
        // 兼容旧版单选
        if (window.selectedMemoryLinks.length === 0 && settings.memoryLink) {
          window.selectedMemoryLinks = [parseInt(settings.memoryLink)];
        }

        // 过滤掉当前角色的单聊
        const availableChars = characters.filter(
          (c) => c.id !== currentChatCharId
        );

        // 获取群聊列表
        const availableGroups = groupChats || [];

        let optionsHtml = "";

        // 先显示单聊角色
        if (availableChars.length > 0) {
          optionsHtml += '<div class="memory-link-section-title">单聊</div>';
          optionsHtml += availableChars
            .map((char) => {
              const isSelected = window.selectedMemoryLinks.includes(char.id);
              const displayName = char.note || char.name;
              return `
              <div class="memory-link-option ${
                isSelected ? "selected" : ""
              }" onclick="toggleMemoryLinkOption(${
                char.id
              }, this)" data-type="char" data-id="${char.id}">
                <input type="checkbox" ${
                  isSelected ? "checked" : ""
                } onclick="event.stopPropagation()">
                <div class="memory-link-option-avatar">
                  ${
                    char.avatar
                      ? `<img src="${char.avatar}">`
                      : displayName.charAt(0)
                  }
                </div>
                <span class="memory-link-option-name">${displayName}</span>
              </div>
            `;
            })
            .join("");
        }

        // 再显示群聊
        if (availableGroups.length > 0) {
          optionsHtml += '<div class="memory-link-section-title">群聊</div>';
          optionsHtml += availableGroups
            .map((group) => {
              const groupLinkId = "group_" + group.id;
              const isSelected =
                window.selectedMemoryLinks.includes(groupLinkId);
              return `
              <div class="memory-link-option ${
                isSelected ? "selected" : ""
              }" onclick="toggleMemoryLinkOption('${groupLinkId}', this)" data-type="group" data-id="${groupLinkId}">
                <input type="checkbox" ${
                  isSelected ? "checked" : ""
                } onclick="event.stopPropagation()">
                <div class="memory-link-option-avatar">
                  ${group.avatar ? `<img src="${group.avatar}">` : "👥"}
                </div>
                <span class="memory-link-option-name">${
                  group.name || "群聊"
                }</span>
              </div>
            `;
            })
            .join("");
        }

        if (!optionsHtml) {
          optionsContainer.innerHTML =
            '<div class="memory-link-empty">暂无可互通的聊天</div>';
        } else {
          optionsContainer.innerHTML = optionsHtml;
        }

        updateMemoryLinkDisplay();
      }

      // 切换下拉框展开/收起
      function toggleMemoryLinkDropdown() {
        const dropdown = document.getElementById("memoryLinkDropdown");
        dropdown.classList.toggle("open");

        // 点击外部关闭
        if (dropdown.classList.contains("open")) {
          setTimeout(() => {
            document.addEventListener(
              "click",
              closeMemoryLinkDropdownOnClickOutside
            );
          }, 0);
        }
      }

      // 点击外部关闭下拉框
      function closeMemoryLinkDropdownOnClickOutside(e) {
        const dropdown = document.getElementById("memoryLinkDropdown");
        if (dropdown && !dropdown.contains(e.target)) {
          dropdown.classList.remove("open");
          document.removeEventListener(
            "click",
            closeMemoryLinkDropdownOnClickOutside
          );
        }
      }

      // 切换选项（支持角色ID和群聊ID）
      function toggleMemoryLinkOption(linkId, element) {
        const checkbox = element.querySelector('input[type="checkbox"]');
        const index = window.selectedMemoryLinks.indexOf(linkId);

        if (index > -1) {
          window.selectedMemoryLinks.splice(index, 1);
          element.classList.remove("selected");
          checkbox.checked = false;
        } else {
          window.selectedMemoryLinks.push(linkId);
          element.classList.add("selected");
          checkbox.checked = true;
        }

        updateMemoryLinkDisplay();
        saveMemoryLinksToSettings();
      }

      // 移除已选标签（支持角色ID和群聊ID）
      function removeMemoryLinkTag(linkId) {
        const index = window.selectedMemoryLinks.indexOf(linkId);
        if (index > -1) {
          window.selectedMemoryLinks.splice(index, 1);
        }

        // 更新下拉列表中的选中状态
        const options = document.querySelectorAll(
          "#memoryLinkOptions .memory-link-option"
        );
        options.forEach((opt) => {
          const optId = opt.dataset.id;
          // 比较时统一转换
          if (optId == linkId || parseInt(optId) === linkId) {
            opt.classList.remove("selected");
            const checkbox = opt.querySelector('input[type="checkbox"]');
            if (checkbox) checkbox.checked = false;
          }
        });

        updateMemoryLinkDisplay();
        saveMemoryLinksToSettings();
      }

      // 更新显示（支持角色和群聊）
      function updateMemoryLinkDisplay() {
        const textEl = document.getElementById("memoryLinkText");
        const tagsEl = document.getElementById("memoryLinkTags");

        if (window.selectedMemoryLinks.length === 0) {
          textEl.textContent = "点击选择要互通的聊天...";
          textEl.style.color = "#999";
          tagsEl.innerHTML = "";
        } else {
          textEl.textContent = `已选择 ${window.selectedMemoryLinks.length} 个聊天`;
          textEl.style.color = "#333";

          // 生成标签
          tagsEl.innerHTML = window.selectedMemoryLinks
            .map((linkId) => {
              // 判断是群聊还是单聊
              if (typeof linkId === "string" && linkId.startsWith("group_")) {
                const groupId = parseInt(linkId.replace("group_", ""));
                const group = groupChats.find((g) => g.id === groupId);
                if (!group) return "";
                return `
                <span class="memory-link-tag">
                  👥 ${group.name || "群聊"}
                  <span class="memory-link-tag-remove" onclick="removeMemoryLinkTag('${linkId}')">×</span>
                </span>
              `;
              } else {
                const char = characters.find((c) => c.id === linkId);
                if (!char) return "";
                const displayName = char.note || char.name;
                return `
                <span class="memory-link-tag">
                  ${displayName}
                  <span class="memory-link-tag-remove" onclick="removeMemoryLinkTag(${linkId})">×</span>
                </span>
              `;
              }
            })
            .join("");
        }
      }

      // 保存到设置
      function saveMemoryLinksToSettings() {
        if (!currentChatCharId) return;

        if (!chatSettings[currentChatCharId]) {
          chatSettings[currentChatCharId] = {};
        }

        chatSettings[currentChatCharId].memoryLinks = [
          ...window.selectedMemoryLinks,
        ];
        // 兼容旧版
        chatSettings[currentChatCharId].memoryLink =
          window.selectedMemoryLinks.length > 0
            ? window.selectedMemoryLinks[0].toString()
            : "";

        localforage.setItem("chatSettings", chatSettings);
      }

      // Estimate tokens
      function estimateTokens(history) {
        if (!history || history.length === 0) return 0;
        const text = history.map((m) => m.content).join("");
        // Rough estimate: ~1.5 tokens per Chinese character, ~0.75 per English word
        return Math.round(text.length * 1.2);
      }

      // Update chat preview
      function updateChatPreview(settings, char) {
        const otherAvatar = settings.otherAvatar || char.avatar;
        const myAvatar = settings.myAvatar;

        document.getElementById("previewOtherAvatar").innerHTML = otherAvatar
          ? `<img src="${otherAvatar}">`
          : "AI";
        document.getElementById("previewMyAvatar").innerHTML = myAvatar
          ? `<img src="${myAvatar}">`
          : "我";
      }

      // 切换头像显示
      function toggleAvatarDisplay() {
        const showAi = document.getElementById("showAiAvatar").checked;
        const showUser = document.getElementById("showUserAvatar").checked;

        // 应用到当前聊天界面
        applyAvatarVisibility(showAi, showUser);

        // 即时保存设置
        if (currentChatCharId && chatSettings[currentChatCharId]) {
          chatSettings[currentChatCharId].showAiAvatar = showAi;
          chatSettings[currentChatCharId].showUserAvatar = showUser;
          localforage.setItem("chatSettings", chatSettings);
        }
      }

      // 更新头像大小预览
      function updateAvatarSizePreview(size) {
        document.getElementById("avatarSizeValue").textContent = size + "px";
        applyAvatarSize(size);
      }

      // 保存头像大小设置
      async function saveAvatarSize(size) {
        if (!currentChatCharId) return;

        const char = window.characters.find((c) => c.id === currentChatCharId);
        if (char) {
          char.avatarSize = parseInt(size);
          await localforage.setItem("characters", window.characters);
        }
      }

      // 应用头像大小
      function applyAvatarSize(size) {
        const style =
          document.getElementById("avatarSizeStyle") ||
          document.createElement("style");
        style.id = "avatarSizeStyle";

        const sizeNum = parseInt(size);
        style.textContent = `
          .chat-avatar-small {
            width: ${sizeNum}px !important;
            height: ${sizeNum}px !important;
            min-width: ${sizeNum}px !important;
            min-height: ${sizeNum}px !important;
          }
        `;

        if (!document.getElementById("avatarSizeStyle")) {
          document.head.appendChild(style);
        }
      }

      // 更新气泡间距预览
      function updateBubbleGapPreview(gap) {
        document.getElementById("bubbleGapValue").textContent = gap + "px";
        applyBubbleGap(gap);
      }

      // 保存气泡间距设置
      async function saveBubbleGap(gap) {
        if (!currentChatCharId) return;

        const char = window.characters.find((c) => c.id === currentChatCharId);
        if (char) {
          char.bubbleGap = parseInt(gap);
          await localforage.setItem("characters", window.characters);
        }
      }

      // 应用气泡间距
      function applyBubbleGap(gap) {
        const style =
          document.getElementById("bubbleGapStyle") ||
          document.createElement("style");
        style.id = "bubbleGapStyle";

        const gapNum = parseInt(gap);
        style.textContent = `
          .msg-wrapper {
            margin-bottom: ${gapNum}px !important;
          }
          .msg-row {
            gap: ${gapNum}px !important;
          }
        `;

        if (!document.getElementById("bubbleGapStyle")) {
          document.head.appendChild(style);
        }
      }

      // 应用头像可见性
      function applyAvatarVisibility(showAi, showUser) {
        const style =
          document.getElementById("avatarVisibilityStyle") ||
          document.createElement("style");
        style.id = "avatarVisibilityStyle";

        let css = "";
        if (!showAi) {
          css +=
            ".msg-wrapper.ai .chat-avatar-small { display: none !important; }";
        }
        if (!showUser) {
          css +=
            ".msg-wrapper.user .chat-avatar-small { display: none !important; }";
        }

        style.textContent = css;
        if (!document.getElementById("avatarVisibilityStyle")) {
          document.head.appendChild(style);
        }
      }

      // Close chat settings
      function closeChatSettings() {
        document.getElementById("chatSettingsPage").classList.remove("active");
        // 隐藏群成员设置区域（如果存在）
        const membersSection = document.getElementById("groupMembersSection");
        if (membersSection) {
          membersSection.style.display = "none";
        }
      }

      // 保存并关闭聊天设置
      function saveChatSettingsAndClose() {
        saveChatSettings();
        showToast("设置已保存");
        closeChatSettings();
      }

      function saveChatSettings() {
        if (!currentChatCharId) return;

        // 1. 获取基础数据
        const charName = document
          .getElementById("settingsCharName")
          .value.trim();
        const charNote = document
          .getElementById("settingsCharNote")
          .value.trim();
        const otherAvatarSrc = document.getElementById("otherAvatarImg").src;
        const myAvatarSrc = document.getElementById("myAvatarImg").src;
        const bgSrc = document.getElementById("bgPreviewImg").src;

        const safeOtherAvatar =
          otherAvatarSrc && otherAvatarSrc.startsWith("data:")
            ? otherAvatarSrc
            : "";
        const safeMyAvatar =
          myAvatarSrc && myAvatarSrc.startsWith("data:") ? myAvatarSrc : "";
        const safeBg = bgSrc && bgSrc.startsWith("data:") ? bgSrc : "";

        // 2. 获取火花数据 (新增部分)
        const isFlameActive = document.getElementById("settingsFlame").checked;
        const flameIcon = document.getElementById("settingsFlameIcon")
          ? document.getElementById("settingsFlameIcon").value
          : "♨";
        const flameDays = document.getElementById("settingsFlameDays")
          ? parseInt(document.getElementById("settingsFlameDays").value)
          : 1;

        // 3. 构建设置对象
        const settings = {
          charName: charName,
          charNote: charNote,
          group: document.getElementById("settingsGroup").value,
          pinned: document.getElementById("settingsPinned").checked,
          otherAvatar: safeOtherAvatar,
          myAvatar: safeMyAvatar,
          showAiAvatar: document.getElementById("showAiAvatar").checked,
          showUserAvatar: document.getElementById("showUserAvatar").checked,
          persona: document.getElementById("settingsPersona").value.trim(),
          myPersona: document.getElementById("settingsMyPersona").value.trim(),
          worldbook: document.getElementById("settingsWorldbook").value,
          // 记忆互通 - 新版多选
          memoryLinks: window.selectedMemoryLinks || [],
          memoryLink:
            window.selectedMemoryLinks && window.selectedMemoryLinks.length > 0
              ? window.selectedMemoryLinks[0].toString()
              : "",
          memoryCount:
            parseInt(document.getElementById("settingsMemoryCount").value) || 5,
          contextCount:
            parseInt(document.getElementById("settingsContextCount").value) ||
            150,
          onlineDating: document.getElementById("settingsOnlineDating").checked,
          longMemory: document.getElementById("settingsLongMemory").checked,
          summaryMode: document.getElementById("settingsSummaryMode").value,
          triggerCount:
            parseInt(document.getElementById("settingsTriggerCount").value) ||
            500,
          summaryPrompt: document
            .getElementById("settingsSummaryPrompt")
            .value.trim(),
          // 在 saveChatSettings 构建 settings 对象时添加：
          voiceId: document.getElementById("settingsVoiceId").value.trim(),

          // 通话设置
          callVoiceEnabled:
            document.getElementById("settingsCallVoiceEnabled")?.checked ||
            false,
          aiCallEnabled:
            document.getElementById("settingsAiCallEnabled")?.checked || false,

          // 通话气泡颜色设置
          callUserBubbleColor:
            document.getElementById("settingsCallUserBubbleColor")?.value ||
            "#f48fb1",
          callUserBubbleOpacity:
            parseInt(
              document.getElementById("settingsCallUserBubbleOpacity")?.value
            ) || 85,
          callAiBubbleColor:
            document.getElementById("settingsCallAiBubbleColor")?.value ||
            "#ffffff",
          callAiBubbleOpacity:
            parseInt(
              document.getElementById("settingsCallAiBubbleOpacity")?.value
            ) || 85,

          // 线下模式设置
          offlineMinWords:
            parseInt(document.getElementById("offlineMinWords")?.value) || 100,
          offlineMaxWords:
            parseInt(document.getElementById("offlineMaxWords")?.value) || 500,
          offlinePresetId:
            document.getElementById("offlinePresetSelect")?.value || "",

          // 火花字段更新
          flame: isFlameActive,
          flameData: {
            active: isFlameActive,
            icon: flameIcon || "♨",
            days: flameDays || 1,
          },

          timeAware: document.getElementById("settingsTimeAware").checked,
          background: safeBg,
          fontSize:
            parseInt(document.getElementById("settingsFontSize").value) || 14,
          userBubbleColor:
            document.getElementById("settingsUserBubbleColor").value ||
            "#c2185b",
          aiBubbleColor:
            document.getElementById("settingsAiBubbleColor").value || "#37474f",
          bubbleStyle: document.getElementById("settingsBubbleStyle").value,
          customCSS: document.getElementById("settingsCustomCSS").value.trim(),

          // 保持记忆总结不被覆盖
          summaries: chatSettings[currentChatCharId]?.summaries || [],
          summarizedCount:
            chatSettings[currentChatCharId]?.summarizedCount || 0,

          // 保持视频通话图片不被覆盖
          videoCallPartnerImage:
            chatSettings[currentChatCharId]?.videoCallPartnerImage || null,
          videoCallSelfImage:
            chatSettings[currentChatCharId]?.videoCallSelfImage || null,
        };

        // 4. 保存
        chatSettings[currentChatCharId] = settings;
        localforage.setItem("chatSettings", chatSettings);

        // 5. 更新全局角色列表数据
        const charIndex = characters.findIndex(
          (c) => c.id === currentChatCharId
        );
        if (charIndex !== -1) {
          if (settings.charName) characters[charIndex].name = settings.charName;
          characters[charIndex].note = settings.charNote;
          if (settings.otherAvatar)
            characters[charIndex].avatar = settings.otherAvatar;

          // 同步火花数据到列表，这样列表页也能显示
          characters[charIndex].flameData = settings.flameData;

          localforage.setItem("characters", characters);
        }

        // 6. 实时更新界面 (UI Update)

        // 生成火花 HTML
        let sparkHtml = "";
        if (settings.flameData && settings.flameData.active) {
          sparkHtml = `<span class="spark-badge">${settings.flameData.icon} ${settings.flameData.days}</span>`;
        }

        // 更新标题 (名字 + 火花)
        const displayTitle =
          settings.charNote ||
          settings.charName ||
          (charIndex !== -1 ? characters[charIndex].name : "角色");
        document.getElementById("convName").innerHTML =
          displayTitle + sparkHtml;

        if (settings.otherAvatar) {
          document.getElementById(
            "convAvatar"
          ).innerHTML = `<img src="${settings.otherAvatar}" alt="">`;
        }

        // 刷新列表和样式
        renderCharacters();
        renderConversation();
        applyCustomStyles(settings);

        // 应用头像可见性设置
        applyAvatarVisibility(
          settings.showAiAvatar !== false,
          settings.showUserAvatar !== false
        );

        closeChatSettings();
        // 判断一下：只有开启了火花，才提示“续火花”
        if (isFlameActive) {
          showToast("设置已保存，火花已续上 ♨");
        } else {
          showToast("设置已保存");
        }
      }

      // Apply custom styles
      function applyCustomStyles(settings) {
        // Remove existing custom style
        const existingStyle = document.getElementById("chatCustomStyle");
        if (existingStyle) existingStyle.remove();

        // Remove existing bubble color style
        const existingBubbleStyle = document.getElementById("bubbleColorStyle");
        if (existingBubbleStyle) existingBubbleStyle.remove();

        // Apply background to the entire conversation page
        const convPage = document.getElementById("chatConversationPage");
        const convMessages = document.getElementById("convMessages");

        if (settings.background) {
          convPage.style.backgroundImage = `url(${settings.background})`;
          convPage.style.backgroundSize = "cover";
          convPage.style.backgroundPosition = "center";
          convPage.style.backgroundAttachment = "fixed";
          convMessages.style.backgroundImage = "";
        } else {
          convPage.style.backgroundImage = "";
          convPage.style.background = "#f5f5f5";
          convMessages.style.backgroundImage = "";
        }

        // Apply font size
        const bubbles = document.querySelectorAll(".msg-bubble");
        bubbles.forEach((b) => (b.style.fontSize = settings.fontSize + "px"));

        // Apply bubble text colors
        const userColor = settings.userBubbleColor || "#c2185b";
        const aiColor = settings.aiBubbleColor || "#37474f";
        const bubbleColorStyle = document.createElement("style");
        bubbleColorStyle.id = "bubbleColorStyle";
        bubbleColorStyle.textContent = `
          .msg-row.user .msg-bubble { color: ${userColor} !important; }
          .msg-row.ai .msg-bubble { color: ${aiColor} !important; }
        `;
        document.head.appendChild(bubbleColorStyle);

        // Apply custom CSS - 使用 !important 确保用户样式优先级最高
        if (settings.customCSS) {
          const style = document.createElement("style");
          style.id = "chatCustomStyle";
          // 用户自定义CSS放在最后，优先级最高
          style.textContent = `/* 用户自定义样式 - 优先级最高 */\n${settings.customCSS}`;
          document.head.appendChild(style);
        }
      }

      // Show toast message
      function showToast(message) {
        // Create toast element
        const toast = document.createElement("div");
        toast.className = "toast-message";
        toast.textContent = message;
        toast.style.cssText = `
                                  position: fixed;
                                  bottom: 120px;
                                  left: 50%;
                                  transform: translateX(-50%);
                                  background: rgba(0,0,0,0.75);
                                  color: white;
                                  padding: 12px 24px;
                                  border-radius: 24px;
                                  font-size: 0.9rem;
                                  z-index: 9999;
                                  animation: fadeInUp 0.3s ease-out;
                                `;
        document.body.appendChild(toast);

        // Remove after delay
        setTimeout(() => {
          toast.style.animation = "fadeOut 0.3s ease-out";
          setTimeout(() => toast.remove(), 300);
        }, 2000);
      }

      // Add toast animations
      const toastStyle = document.createElement("style");
      toastStyle.textContent = `
                                @keyframes fadeInUp {
                                  from { opacity: 0; transform: translateX(-50%) translateY(20px); }
                                  to { opacity: 1; transform: translateX(-50%) translateY(0); }
                                }
                                @keyframes fadeOut {
                                  from { opacity: 1; }
                                  to { opacity: 0; }
                                }
                              `;
      document.head.appendChild(toastStyle);

      // ========== 新消息通知系统 ==========
      var unreadMessages = {}; // { charId: count }
      var unreadMoments = 0;
      var notificationTimeout = null;
      var pendingNotificationCharId = null;

      // 显示新消息通知弹窗
      function showMessageNotification(
        charId,
        charName,
        charAvatar,
        messageText
      ) {
        const notification = document.getElementById("messageNotification");
        const avatarEl = document.getElementById("notificationAvatar");
        const nameEl = document.getElementById("notificationName");
        const textEl = document.getElementById("notificationText");
        const timeEl = document.getElementById("notificationTime");

        // 设置内容
        if (charAvatar) {
          avatarEl.innerHTML = `<img src="${charAvatar}" alt="">`;
        } else {
          avatarEl.innerHTML = charName ? charName.charAt(0) : "AI";
        }
        nameEl.textContent = charName || "未知";
        textEl.textContent = messageText || "发来一条消息";
        timeEl.textContent = "刚刚";

        pendingNotificationCharId = charId;

        // 显示通知
        notification.classList.add("show");

        // 清除之前的定时器
        if (notificationTimeout) {
          clearTimeout(notificationTimeout);
        }

        // 4秒后自动隐藏
        notificationTimeout = setTimeout(() => {
          notification.classList.remove("show");
        }, 4000);
      }

      // 点击通知跳转到对应聊天
      function handleNotificationClick() {
        const notification = document.getElementById("messageNotification");
        notification.classList.remove("show");

        if (pendingNotificationCharId) {
          // 切换到消息tab
          switchChatTab("messages");
          // 打开对应聊天
          setTimeout(() => {
            openConversation(pendingNotificationCharId);
            // 清除该角色的未读
            clearUnreadForChar(pendingNotificationCharId);
          }, 100);
        }
        pendingNotificationCharId = null;
      }

      // 增加未读消息计数
      function addUnreadMessage(charId) {
        unreadMessages[charId] = (unreadMessages[charId] || 0) + 1;
        updateMessagesBadge();
        // 刷新消息列表显示红点
        if (typeof renderCharacters === "function") {
          renderCharacters();
        }
      }

      // 清除某个角色的未读消息
      function clearUnreadForChar(charId) {
        if (unreadMessages[charId]) {
          delete unreadMessages[charId];
          updateMessagesBadge();
          // 刷新消息列表移除红点
          if (typeof renderCharacters === "function") {
            renderCharacters();
          }
        }
      }

      // 更新消息tab的小红点
      function updateMessagesBadge() {
        const badge = document.getElementById("messagesBadge");
        const total = Object.values(unreadMessages).reduce((a, b) => a + b, 0);

        if (total > 0) {
          badge.textContent = total > 99 ? "99+" : total;
          badge.style.display = "flex";
        } else {
          badge.style.display = "none";
        }
      }

      // 增加朋友圈未读
      function addUnreadMoment() {
        unreadMoments++;
        updateMomentsBadge();
      }

      // 清除朋友圈未读
      function clearUnreadMoments() {
        unreadMoments = 0;
        updateMomentsBadge();
      }

      // 更新朋友圈tab的小红点
      function updateMomentsBadge() {
        const badge = document.getElementById("momentsBadge");

        if (unreadMoments > 0) {
          badge.textContent = unreadMoments > 99 ? "99+" : unreadMoments;
          badge.style.display = "flex";
        } else {
          badge.style.display = "none";
        }
      }

      // Placeholder functions for settings actions
      function manageFriendGroups() {
        alert("好友分组管理功能开发中...");
      }

      function triggerManualSummary() {
        const history = chatHistories[currentChatCharId] || [];
        if (history.length < 10) {
          alert("聊天记录太少，无法生成总结");
          return;
        }
        alert("正在生成总结...\n\n此功能需要配合API使用");
      }

      function manageBubbleStyles() {
        alert("气泡样式管理功能开发中...");
      }

      function exportBubbleStyle() {
        const css = document.getElementById("settingsCustomCSS").value;
        if (!css) {
          alert("没有自定义样式可导出");
          return;
        }
        const blob = new Blob([css], { type: "text/css" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "chat-style.css";
        a.click();
        URL.revokeObjectURL(url);
      }

      function importBubbleStyle() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".css,.txt";
        input.onchange = function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              document.getElementById("settingsCustomCSS").value =
                e.target.result;
            };
            reader.readAsText(file);
          }
        };
        input.click();
      }

      function resetCustomCSS() {
        if (confirm("确定要重置自定义CSS吗？")) {
          document.getElementById("settingsCustomCSS").value = "";
        }
      }

      function importChatHistory() {
        if (!currentChatCharId) return;

        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";
        input.onchange = async function (e) {
          const file = e.target.files[0];
          if (!file) return;

          try {
            const text = await file.text();
            const data = JSON.parse(text);

            let messages = [];

            // 支持两种格式：完整导出格式和纯消息数组
            if (
              data.type === "pinky_chat_export" &&
              Array.isArray(data.messages)
            ) {
              messages = data.messages;
            } else if (Array.isArray(data)) {
              messages = data;
            } else {
              throw new Error("无效的聊天记录格式");
            }

            // 询问用户是覆盖还是追加
            const choice = confirm(
              "点击「确定」覆盖现有记录，点击「取消」追加到现有记录末尾"
            );

            if (choice) {
              // 覆盖
              chatHistories[currentChatCharId] = messages;
            } else {
              // 追加
              const existing = chatHistories[currentChatCharId] || [];
              chatHistories[currentChatCharId] = [...existing, ...messages];
            }

            await localforage.setItem("chatHistories", chatHistories);
            renderConversation();
            showToast(`成功导入 ${messages.length} 条消息`);
          } catch (err) {
            alert("导入失败：" + err.message);
          }
        };
        input.click();
      }

      function exportChatHistory() {
        if (!currentChatCharId) return;

        const history = chatHistories[currentChatCharId] || [];
        if (history.length === 0) {
          showToast("没有聊天记录可导出");
          return;
        }

        const char = characters.find((c) => c.id === currentChatCharId);
        const settings = chatSettings[currentChatCharId] || {};

        // 导出包含角色信息和消息
        const exportData = {
          type: "pinky_chat_export",
          version: 1,
          charInfo: {
            name: char?.name,
            note: char?.note,
            avatar: char?.avatar,
          },
          settings: {
            charName: settings.charName,
            userNickname: settings.userNickname,
          },
          messages: history,
          exportTime: new Date().toISOString(),
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `chat-${char?.name || "export"}-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast("聊天记录已导出");
      }

      function clearChatHistoryFromSettings() {
        if (confirm("确定要清空所有聊天记录吗？此操作不可撤销！")) {
          chatHistories[currentChatCharId] = [];
          localforage.setItem("chatHistories", chatHistories);
          document.getElementById("settingsTotalMsg").textContent = "0";
          document.getElementById("settingsTokenCount").textContent = "0";
          renderConversation();
          showToast("聊天记录已清空");
        }
      }

      function blockCharacter() {
        if (confirm("确定要拉黑此角色吗？拉黑后将无法收发消息。")) {
          const char = characters.find((c) => c.id === currentChatCharId);
          if (char) {
            char.blocked = true;
            localforage.setItem("characters", characters);
            showToast("已拉黑 " + char.name);
            closeChatSettings();
            closeConversation();
          }
        }
      }

      // Load settings when opening conversation
      const originalOpenConversation = openConversation;
      openConversation = function (charId) {
        originalOpenConversation(charId);

        // Apply saved settings if exist
        if (chatSettings[charId]) {
          applyCustomStyles(chatSettings[charId]);
        }

        // 刷新表情面板的绑定状态显示（因为不同角色有不同的绑定）
        if (typeof renderCategoryBar === "function") {
          renderCategoryBar();
        }
      };
      // ==================== 用户人设预设逻辑 ====================
      var userPersonaPresets;
      try {
        userPersonaPresets = JSON.parse(
          localStorage.getItem("userPersonaPresets") || "[]"
        );
        if (!Array.isArray(userPersonaPresets)) userPersonaPresets = [];
      } catch (e) {
        console.error("userPersonaPresets解析失败", e);
        userPersonaPresets = [];
      }

      // 初始化预设下拉菜单
      function initUserPersonaPresets() {
        const select = document.getElementById("userPersonaPresetSelect");
        // 保留第一个默认选项，清除其他的
        while (select.options.length > 1) {
          select.remove(1);
        }

        userPersonaPresets.forEach((preset) => {
          const option = document.createElement("option");
          option.value = preset.id;
          option.textContent = preset.name;
          select.appendChild(option);
        });

        // 绑定 change 事件
        select.onchange = function () {
          if (this.value) {
            loadUserPersonaPreset(this.value);
          }
        };
      }

      // 保存当前配置为新预设
      function saveUserPersonaPreset() {
        const currentPersona = document
          .getElementById("settingsMyPersona")
          .value.trim();
        const currentAvatar = document.getElementById("myAvatarImg").src;

        if (!currentPersona) {
          alert("请先填写人设内容再保存预设！");
          return;
        }

        const name = prompt(
          "请为当前人设取个名字（例如：高冷霸总、撒娇小猫）："
        );
        if (!name) return;

        const newPreset = {
          id: Date.now().toString(),
          name: name,
          persona: currentPersona,
          avatar: currentAvatar, // 连同头像一起保存
        };

        userPersonaPresets.push(newPreset);
        localforage.setItem("userPersonaPresets", userPersonaPresets);

        showToast("预设已保存 ★");
        initUserPersonaPresets(); // 刷新下拉框
      }

      // 加载预设
      function loadUserPersonaPreset(presetId) {
        const preset = userPersonaPresets.find((p) => p.id === presetId);
        if (!preset) return;

        // 1. 填入人设文本
        document.getElementById("settingsMyPersona").value = preset.persona;

        // 2. 如果预设里有头像，也一起加载
        if (preset.avatar && preset.avatar.startsWith("data:")) {
          loadAvatarPreview("my", preset.avatar);
          document.getElementById(
            "previewMyAvatar"
          ).innerHTML = `<img src="${preset.avatar}">`;
        }

        showToast(`已切换至：${preset.name}`);
      }

      // 在页面加载完成时初始化
      document.addEventListener("DOMContentLoaded", function () {
        // ... 原有的初始化代码 ...
        initUserPersonaPresets(); // 添加这一行
      });
      // ==================== 长期记忆总结系统 ====================

      // 1. 检查是否达到触发条件
      function checkAndTriggerSummary(settings) {
        if (!settings.longMemory) return; // 如果开关没开，直接退出

        const history = chatHistories[currentChatCharId] || [];
        const totalMsg = history.length;
        // 默认已总结条数为0
        const summarizedCount = settings.summarizedCount || 0;
        // 获取触发阈值
        const triggerCount = settings.triggerCount || 500;

        // 计算新增的、未总结的消息数
        const newMsgCount = totalMsg - summarizedCount;

        if (newMsgCount >= triggerCount) {
          if (settings.summaryMode === "auto") {
            // 自动模式：直接开始总结
            performSummary(settings, history, summarizedCount, totalMsg);
          } else {
            // 手动模式：提示用户
            showToast(`📬 新消息已达 ${newMsgCount} 条，建议进行总结`);
            // 这里可以加一个小红点逻辑，或者弹窗，目前用Toast提示
          }
        }
      }

      // 2. 执行总结 (调用 AI)
      async function performSummary(
        settings,
        history,
        startIndex,
        endIndex,
        isManual = false
      ) {
        const apiConfig = getActiveApiConfig();
        if (!apiConfig) {
          if (isManual) alert("API未配置，无法总结");
          return;
        }

        // 截取需要总结的片段
        const messagesToSummarize = history.slice(startIndex, endIndex);
        if (messagesToSummarize.length === 0) return;

        // 将聊天记录转换为文本
        const chatText = messagesToSummarize
          .map(
            (m) =>
              `${m.role === "user" ? "用户" : settings.charName || "AI"}: ${
                m.content
              }`
          )
          .join("\n");

        const summaryPrompt =
          settings.summaryPrompt || "请总结以下对话的核心事件。";

        // 显示正在处理的提示
        if (isManual) showToast("正在生成记忆总结...");

        try {
          const response = await fetch(`${apiConfig.url}/chat/completions`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${apiConfig.key}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: apiConfig.model,
              messages: [
                { role: "system", content: summaryPrompt },
                { role: "user", content: chatText },
              ],
              temperature: 0.5, // 总结需要准确，温度调低
            }),
          });

          const data = await response.json();
          const summaryText = data.choices[0]?.message?.content;

          if (summaryText) {
            // 保存总结
            if (!settings.summaries) settings.summaries = [];

            // 添加带日期的总结
            const dateStr = new Date().toLocaleDateString();
            settings.summaries.push(`[${dateStr}] ${summaryText}`);

            // 更新已总结的计数指针
            settings.summarizedCount = endIndex;

            // 保存到 LocalStorage
            chatSettings[currentChatCharId] = settings;
            localforage.setItem("chatSettings", chatSettings);

            showToast("✓ 长期记忆已更新");
          }
        } catch (e) {
          console.error(e);
          if (isManual) alert("总结失败: " + e.message);
        }
      }

      // 3. 手动触发按钮逻辑 (对应设置页的按钮)
      function triggerManualSummary() {
        if (!currentChatCharId) return;
        const settings = chatSettings[currentChatCharId];
        const history = chatHistories[currentChatCharId] || [];

        const summarizedCount = settings.summarizedCount || 0;
        const totalMsg = history.length;

        if (totalMsg <= summarizedCount) {
          alert("当前没有新的消息需要总结。");
          return;
        }

        if (
          confirm(
            `有 ${
              totalMsg - summarizedCount
            } 条新消息未总结，确定现在生成总结吗？`
          )
        ) {
          performSummary(settings, history, summarizedCount, totalMsg, true);
        }
      }
      // ==================== 查看/管理总结 UI (升级版：支持编辑) ====================
      function viewSummaries() {
        if (!currentChatCharId) return;
        const settings = chatSettings[currentChatCharId];
        const summaries = settings.summaries || [];

        // 1. 创建遮罩层 (如果有旧的先移除，防止重复)
        const oldModal = document.getElementById("summaryManagerModal");
        if (oldModal) oldModal.remove();

        const overlay = document.createElement("div");
        overlay.className = "api-modal active";
        overlay.id = "summaryManagerModal";

        // 2. 构建内容 HTML
        let listHtml = "";
        if (summaries.length === 0) {
          listHtml = `<div class="empty-state" style="padding:20px;">
                                    <div class="empty-text">暂无长期记忆</div>
                                    <div class="empty-hint">AI 还没有生成过总结哦</div>
                                </div>`;
        } else {
          summaries.forEach((sum, index) => {
            // 这里使用了行内编辑的布局
            // 默认显示：summary-view (文字 + 按钮)
            // 编辑状态：summary-edit (输入框 + 保存/取消) -> 默认隐藏
            listHtml += `
                                        <div id="summary-item-${index}" style="background:#f5f5f5; padding:12px; border-radius:12px; margin-bottom:10px; position:relative; transition: all 0.2s;">

                                            <div id="summary-view-${index}">
                                                <div style="font-size:0.9rem; color:#333; line-height:1.5; padding-right:60px; word-break: break-word;">${escapeHtml(
                                                  sum
                                                )}</div>

                                                <div style="position:absolute; top:8px; right:8px; display:flex; gap:4px;">
                                                    <button onclick="startEditSummary(${index})" style="border:none; background:white; width:28px; height:28px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1); color:#5d4e37; cursor:pointer; display:flex; align-items:center; justify-content:center;">✏️</button>
                                                    <button onclick="deleteSummary(${index})" style="border:none; background:white; width:28px; height:28px; border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,0.1); color:#ff6b6b; cursor:pointer; display:flex; align-items:center; justify-content:center;">✕</button>
                                                </div>
                                            </div>

                                            <div id="summary-edit-${index}" style="display:none;">
                                                <textarea id="summary-input-${index}" class="edit-input" style="width:100%; height:80px; resize:vertical; margin-bottom:8px; background:white;">${sum}</textarea>
                                                <div style="display:flex; gap:8px; justify-content:flex-end;">
                                                    <button onclick="cancelEditSummary(${index})" class="form-btn-small" style="padding:6px 12px; background:#eee;">取消</button>
                                                    <button onclick="saveSummaryEdit(${index})" class="form-btn-small" style="padding:6px 12px; background:var(--accent-pink); color:white; border:none; box-shadow:0 2px 8px rgba(244, 143, 177, 0.4);">保存</button>
                                                </div>
                                            </div>

                                        </div>
                                    `;
          });
        }

        overlay.innerHTML = `
                                <div class="api-modal-content" style="height: 70vh;">
                                    <div class="api-modal-header">
                                        <h2 class="api-modal-title">长期记忆管理 (${summaries.length})</h2>
                                        <button class="api-modal-close" onclick="closeSummaryModal()">✕</button>
                                    </div>
                                    <div class="api-modal-body" id="summaryListContainer" style="padding-bottom: 40px;">
                                        ${listHtml}
                                    </div>
                                    <div class="api-modal-footer">
                                        <button class="api-modal-btn btn-cancel" style="width:100%" onclick="closeSummaryModal()">关闭</button>
                                    </div>
                                </div>
                            `;

        document.body.appendChild(overlay);
      }
      // 开始编辑：切换显示状态
      function startEditSummary(index) {
        document.getElementById(`summary-view-${index}`).style.display = "none";
        document.getElementById(`summary-edit-${index}`).style.display =
          "block";

        // 自动聚焦并把光标移到最后
        const textarea = document.getElementById(`summary-input-${index}`);
        textarea.focus();
        textarea.setSelectionRange(
          textarea.value.length,
          textarea.value.length
        );
      }

      // 取消编辑：还原显示状态
      function cancelEditSummary(index) {
        document.getElementById(`summary-view-${index}`).style.display =
          "block";
        document.getElementById(`summary-edit-${index}`).style.display = "none";

        // 还原文本（防止用户修改了一半没保存）
        const settings = chatSettings[currentChatCharId];
        document.getElementById(`summary-input-${index}`).value =
          settings.summaries[index];
      }

      // 保存编辑
      function saveSummaryEdit(index) {
        const newVal = document
          .getElementById(`summary-input-${index}`)
          .value.trim();
        if (!newVal) {
          alert("记忆内容不能为空");
          return;
        }

        // 更新数据
        const settings = chatSettings[currentChatCharId];
        settings.summaries[index] = newVal;

        // 保存到本地存储
        chatSettings[currentChatCharId] = settings;
        localforage.setItem("chatSettings", chatSettings);

        showToast("记忆已修正 ★");

        // 重新渲染列表（最简单的方法，确保UI同步）
        viewSummaries();
      }

      // 删除总结（保持原来的逻辑，稍微优化一下UI刷新）
      window.deleteSummary = function (index) {
        if (confirm("确定要遗忘这段记忆吗？")) {
          const settings = chatSettings[currentChatCharId];
          settings.summaries.splice(index, 1);

          localforage.setItem("chatSettings", chatSettings);

          viewSummaries(); // 重新渲染
          showToast("已删除该条记忆");
        }
      };

      // 关闭总结弹窗
      function closeSummaryModal() {
        const modal = document.getElementById("summaryManagerModal");
        if (modal) {
          modal.classList.remove("active"); // 播放退出动画（如果有）
          setTimeout(() => modal.remove(), 300);
        }
      }

      // 删除单条总结
      window.deleteSummary = function (index) {
        if (confirm("确定要遗忘这段记忆吗？")) {
          const settings = chatSettings[currentChatCharId];
          settings.summaries.splice(index, 1);

          // 保存
          localforage.setItem("chatSettings", chatSettings);

          // 刷新列表（简单粗暴：关闭再重开，或者重新生成HTML）
          closeSummaryModal();
          setTimeout(viewSummaries, 100); // 稍微延迟一下重新打开
          showToast("已删除该条记忆");
        }
      };
      // ==================== 快捷键：回车发送 ====================
      document
        .getElementById("convInput")
        .addEventListener("keydown", function (e) {
          // 判断：如果是 Enter 键，并且没有按住 Shift 键
          // (!e.isComposing 用于防止在输入中文拼音时按下回车误发送)
          if (e.key === "Enter" && !e.shiftKey && !e.isComposing) {
            e.preventDefault(); // 阻止默认的“换行”行为
            sendUserMessage(); // 执行发送函数
          }
        });
      // ==================== 火花样式 ====================
      const flameStyle = document.createElement("style");
      flameStyle.innerHTML = `
                            /* 火花小徽章容器 */
                            .spark-badge {
                                display: inline-flex;
                                align-items: center;
                                gap: 2px;
                                padding: 2px 6px;
                                background: #fff0f6; /* 浅粉背景 */
                                border: 1px solid #ffadd2; /* 深粉描边 */
                                border-radius: 12px;
                                color: #eb2f96;
                                font-size: 0.75rem;
                                font-weight: 600;
                                margin-left: 6px;
                                vertical-align: middle;
                                transform: translateY(-1px);
                                box-shadow: 0 1px 2px rgba(235, 47, 150, 0.1);
                            }

                            /* 列表里的火花（稍微小一点） */
                            .message-name .spark-badge {
                                font-size: 0.7rem;
                                padding: 1px 5px;
                            }

                            /* 设置页里的火花配置区域 */
                            #flameSettingsArea {
                                background: #fafafa;
                                padding: 12px;
                                border-radius: 12px;
                                margin-top: 10px;
                                border: 1px solid #eee;
                                animation: slideDown 0.2s ease-out;
                            }

                            @keyframes slideDown {
                                from { opacity: 0; transform: translateY(-10px); }
                                to { opacity: 1; transform: translateY(0); }
                            }
                        `;
      document.head.appendChild(flameStyle);
      // ==================== 续火花设置逻辑 (UI注入) ====================
      function initFlameSettingsUI() {
        const toggleSwitch = document.getElementById("settingsFlame");
        const toggleRow = toggleSwitch.closest(".toggle-row");

        // 1. 如果配置区域还没创建，就创建它
        if (!document.getElementById("flameSettingsArea")) {
          const area = document.createElement("div");
          area.id = "flameSettingsArea";
          area.style.display = "none"; // 默认隐藏

          area.innerHTML = `
                                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                        <div style="flex: 1;">
                                            <label class="form-label" style="font-size: 0.75rem;">火花样式</label>
                                            <input type="text" id="settingsFlameIcon" class="form-input" style="text-align:center;" placeholder="♨" value="♨">
                                        </div>
                                        <div style="flex: 2;">
                                            <label class="form-label" style="font-size: 0.75rem;">已续天数</label>
                                            <input type="number" id="settingsFlameDays" class="form-input" value="1" min="1">
                                        </div>
                                    </div>
                                    <div style="font-size: 0.7rem; color: #999;">★ 每天聊天会自动 +1 哦</div>
                                `;

          // 插入到开关行的后面
          toggleRow.parentNode.insertBefore(area, toggleRow.nextSibling);
        }

        // 2. 绑定开关事件：开关打开时显示配置区
        const area = document.getElementById("flameSettingsArea");

        function toggleArea() {
          area.style.display = toggleSwitch.checked ? "block" : "none";
        }

        // 监听变化
        toggleSwitch.onchange = toggleArea;

        // 初始化状态
        toggleArea();
      }
      // ==================== UI 美化：毛玻璃 & 按钮布局优化 ====================

      // 1. 注入样式 (隐藏头像、毛玻璃、圆形按钮)
      const uiUpgradeStyle = document.createElement("style");
      uiUpgradeStyle.innerHTML = `
                            /* --- 1. 隐藏聊天顶部标题栏的那个小头像 --- */
                            .conv-title-section .conv-avatar {
                                display: none !important;
                            }
                            /* 调整名字的位置，因为头像没了，名字要居中显示 */
                            .conv-title-section {
                                margin: 0 !important;
                                justify-content: center;
                            }

                            /* --- 2. 完全透明效果 --- */
                            /* 顶部栏 */
                            .conv-header {
                                background: none !important;
                                backdrop-filter: none !important;
                                -webkit-backdrop-filter: none !important;
                                border: none !important;
                                box-shadow: none !important;
                            }

                            /* 底部输入栏 */
                            .conv-input-area {
                                background: none !important;
                                backdrop-filter: none !important;
                                -webkit-backdrop-filter: none !important;
                                border: none !important;
                            }

                            /* --- 3. 改造 AI 按钮 (变成圆形小按钮) --- */
                            #replyBtn {
                                width: 34px !important;
                                height: 34px !important;
                                min-height: unset !important;
                                border-radius: 50% !important;
                                padding: 0 !important;

                                /* 浅粉色渐变 */
                                background: linear-gradient(135deg, #fce4ec, #f8bbd9) !important;
                                color: #e91e63 !important;
                                box-shadow: 0 2px 8px rgba(233, 30, 99, 0.15) !important;

                                /* 布局 */
                                display: flex !important;
                                align-items: center !important;
                                justify-content: center !important;
                                font-size: 16px !important;
                                margin-bottom: 4px !important;
                                flex-shrink: 0 !important;
                                align-self: flex-end !important;
                            }

                            /* 正常状态下：隐藏文字，只显示我设定的图标 */
                            #replyBtn span { display: none; } /* 如果有 span */

                            /* 加载状态处理 (当变为"思考中..."时) */
                            #replyBtn.loading {
                                font-size: 0 !important;
                                background: #ddd !important;
                                color: #999 !important;
                                pointer-events: none;
                            }
                            #replyBtn.loading::after {
                                content: "⏳";
                                font-size: 14px !important;
                                animation: spin 1s infinite linear;
                            }

                            @keyframes spin { 100% { transform: rotate(360deg); } }
                        `;
      document.head.appendChild(uiUpgradeStyle);

      // 2. JS 逻辑：把 AI 按钮"搬运"到输入框里面去（延迟执行）
      document.addEventListener("DOMContentLoaded", function () {
        const wrapper = document.querySelector(".conv-input-wrapper");
        const replyBtn = document.getElementById("replyBtn");
        const sendBtn = document.querySelector(".conv-send-btn");
        if (
          wrapper &&
          replyBtn &&
          sendBtn &&
          sendBtn.parentNode === wrapper &&
          replyBtn.parentNode !== wrapper
        ) {
          replyBtn.innerHTML = "✦";
          wrapper.insertBefore(replyBtn, sendBtn);
          const input = document.getElementById("convInput");
          if (input) input.style.marginRight = "4px";
        }
      });
      const simpleBtnStyle = document.createElement("style");
      simpleBtnStyle.innerHTML = `
                            /* 覆盖之前的样式，让它变回普通圆形按钮 */
                            #replyBtn {
                                width: 34px !important;
                                height: 34px !important;
                                border-radius: 50% !important;
                                border: none !important;
                                padding: 0 !important;

                                /* 浅粉色渐变 */
                                background: linear-gradient(135deg, #fce4ec, #f8bbd9) !important;
                                color: #e91e63 !important;

                                display: flex !important;
                                align-items: center !important;
                                justify-content: center !important;
                                font-size: 16px !important;

                                cursor: pointer !important;
                                box-shadow: 0 2px 8px rgba(233, 30, 99, 0.15) !important;
                                margin-bottom: 4px !important;
                                transition: opacity 0.2s !important;
                                align-self: flex-end !important;
                            }

                            /* 点击时的效果 */
                            #replyBtn:active {
                                transform: scale(0.9);
                            }

                            /* 加载时的效果 */
                            #replyBtn.loading {
                                opacity: 0.5 !important;
                                cursor: not-allowed !important;
                                background: #ddd !important;
                            }

                            /* 强制隐藏之前可能存在的伪元素动画 */
                            #replyBtn.loading::after {
                                display: none !important;
                            }
                        `;
      document.head.appendChild(simpleBtnStyle);
      // ==================== 字体管理系统 ====================
      // 变量已在script开头初始化

      // 初始化
      document.addEventListener("DOMContentLoaded", function () {
        renderFontPresets();
        // 如果有激活的字体，应用它
        if (window.activeFontId !== "system") {
          const font = window.fontPresets.find(
            (f) => f.id == window.activeFontId
          );
          if (font) injectGlobalFont(font.source);
        }
      });

      // 切换来源 Tab (URL / 本地文件)
      function switchFontSource(type) {
        document
          .querySelectorAll("#fontPage .radio-option")
          .forEach((el) => el.classList.remove("active"));
        if (type === "url") {
          document.getElementById("tabFontUrl").classList.add("active");
          document.getElementById("fontSourceUrl").style.display = "block";
          document.getElementById("fontSourceFile").style.display = "none";
          window.tempFontData = null;
        } else {
          document.getElementById("tabFontFile").classList.add("active");
          document.getElementById("fontSourceUrl").style.display = "none";
          document.getElementById("fontSourceFile").style.display = "block";
        }
      }

      // 处理文件上传 (转 Base64)
      function handleFontFileUpload(input) {
        const file = input.files[0];
        if (!file) return;

        document.getElementById("fontFileName").textContent = file.name;

        const reader = new FileReader();
        reader.onload = function (e) {
          window.tempFontData = e.target.result; // Base64 字符串
          showToast("文件已读取，请点击预览");
        };
        reader.readAsDataURL(file);
      }

      // 预览字体
      function previewCustomFont() {
        let source = "";
        // 判断当前是 URL 模式还是文件模式
        if (
          document.getElementById("tabFontUrl").classList.contains("active")
        ) {
          source = `url('${document
            .getElementById("fontUrlInput")
            .value.trim()}')`;
        } else {
          if (!window.tempFontData) {
            alert("请先上传字体文件");
            return;
          }
          source = `url('${window.tempFontData}')`;
        }

        if (!source || source === "url('')") {
          alert("请输入 URL 或上传文件");
          return;
        }

        // 创建临时 Style 注入预览
        const previewId = "temp-preview-font";
        let style = document.getElementById(previewId);
        if (style) style.remove();

        style = document.createElement("style");
        style.id = previewId;
        style.innerHTML = `
                                    @font-face {
                                        font-family: 'PreviewFont';
                                        src: ${source};
                                    }
                                  `;
        document.head.appendChild(style);

        // 应用到预览框
        const box = document.getElementById("fontPreviewBox");
        box.style.fontFamily = "'PreviewFont', sans-serif";
        showToast("预览已应用");
      }

      // 保存并应用字体
      function saveFontPreset() {
        // 确保fontPresets已初始化
        if (!window.fontPresets) window.fontPresets = [];

        const name = document.getElementById("fontNameInput").value.trim();
        let source = "";

        if (
          document.getElementById("tabFontUrl").classList.contains("active")
        ) {
          const url = document.getElementById("fontUrlInput").value.trim();
          if (!url) {
            alert("请输入字体 URL");
            return;
          }
          source = `url('${url}')`;
        } else {
          if (!window.tempFontData) {
            alert("请先上传字体文件");
            return;
          }
          source = `url('${window.tempFontData}')`;
        }

        if (!name) {
          alert("请给字体起个名字");
          return;
        }

        const newPreset = {
          id: Date.now(),
          name: name,
          source: source,
        };

        window.fontPresets.push(newPreset);
        localforage.setItem("fontPresets", window.fontPresets);

        // 立即应用
        activateFont(newPreset.id);
        renderFontPresets();

        // 清空输入
        document.getElementById("fontNameInput").value = "";
        document.getElementById("fontUrlInput").value = "";
        document.getElementById("fontFileInput").value = "";
        document.getElementById("fontFileName").textContent = "未选择文件";
        window.tempFontData = null;

        showToast("字体保存并应用成功 ★");
      }

      // 渲染字体列表
      function renderFontPresets() {
        // 确保变量已初始化
        if (!window.fontPresets) window.fontPresets = [];
        if (!window.activeFontId) window.activeFontId = "system";

        const container = document.getElementById("fontPresetList");

        // 保留第一个系统默认
        let html = `
                                     <div class="api-preset-item ${
                                       window.activeFontId === "system"
                                         ? "active"
                                         : ""
                                     }" onclick="applySystemFont()">
                                        <div class="preset-radio" id="radio-system"></div>
                                        <div class="preset-info">
                                           <div class="preset-name">系统默认</div>
                                           <div class="preset-detail">System Default</div>
                                        </div>
                                     </div>
                                  `;

        window.fontPresets.forEach((preset) => {
          const isActive = window.activeFontId == preset.id;
          html += `
                                        <div class="api-preset-item ${
                                          isActive ? "active" : ""
                                        }" onclick="activateFont(${preset.id})">
                                            <div class="preset-radio"></div>
                                            <div class="preset-info">
                                                <div class="preset-name" style="${
                                                  isActive
                                                    ? "font-family: CustomGlobalFont;"
                                                    : ""
                                                }">${escapeHtml(
            preset.name
          )}</div>
                                                <div class="preset-detail">自定义字体</div>
                                            </div>
                                            <button class="preset-edit-btn" style="color:#ff6b6b;" onclick="event.stopPropagation(); deleteFontPreset(${
                                              preset.id
                                            })">✕</button>
                                        </div>
                                      `;
        });

        container.innerHTML = html;
      }

      // 激活自定义字体
      function activateFont(id) {
        if (!window.fontPresets) window.fontPresets = [];
        const preset = window.fontPresets.find((p) => p.id == id);
        if (!preset) return;

        window.activeFontId = id;
        localforage.setItem("activeFontId", id);

        injectGlobalFont(preset.source);
        renderFontPresets();
      }

      // 恢复系统默认字体
      function applySystemFont() {
        window.activeFontId = "system";
        localforage.setItem("activeFontId", "system");

        // 移除全局样式
        const style = document.getElementById("global-custom-font");
        if (style) style.remove();

        renderFontPresets();
        showToast("已恢复默认字体");
      }

      // 核心：注入全局 CSS
      function injectGlobalFont(sourceStr) {
        const styleId = "global-custom-font";
        let style = document.getElementById(styleId);
        if (style) style.remove();

        style = document.createElement("style");
        style.id = styleId;
        style.innerHTML = `
                                    @font-face {
                                        font-family: 'CustomGlobalFont';
                                        src: ${sourceStr};
                                        font-display: swap;
                                    }
                                    /* 强制覆盖所有元素的字体 */
                                    body, button, input, textarea, select, .chat-title, .message-preview, .msg-bubble {
                                        font-family: 'CustomGlobalFont', "Noto Sans SC", sans-serif !important;
                                    }
                                  `;
        document.head.appendChild(style);
      }

      // 删除字体
      function deleteFontPreset(id) {
        if (!window.fontPresets) window.fontPresets = [];
        if (confirm("确定要删除这个字体预设吗？")) {
          window.fontPresets = window.fontPresets.filter((p) => p.id != id);
          localforage.setItem("fontPresets", window.fontPresets);

          if (window.activeFontId == id) {
            applySystemFont();
          } else {
            renderFontPresets();
          }
        }
      }

      // ==================== 修复：聊天自动滚动到底部 ====================
      function renderConversation() {
        const container = document.getElementById("convMessages");
        const history = chatHistories[currentChatCharId] || [];

        if (history.length === 0) {
          container.innerHTML = `
            <div class="conv-empty">
                <div class="conv-empty-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></div>
                <div class="conv-empty-text">开始和TA聊天吧～</div>
            </div>`;
          return;
        }

        const settings = chatSettings[currentChatCharId] || {};
        const char = characters.find((c) => c.id === currentChatCharId);

        // 头像逻辑
        const aiAvatarSrc =
          settings.otherAvatar || (char ? char.avatar : "") || "";
        const globalUserAvatar = localStorage.getItem("avatarImg");
        const userAvatarSrc = settings.myAvatar || globalUserAvatar || "";

        let html = "";
        let lastRole = null;
        let currentGroup = [];

        // 遍历生成 HTML (逻辑保持不变)
        history.forEach((msg, index) => {
          // 跳过隐藏的系统消息（如通话记录）
          if (msg.isHidden) {
            return;
          }

          const isRecalled = msg.isRecalled === true;

          if (isRecalled) {
            if (currentGroup.length > 0) {
              html += renderMessageGroup(
                currentGroup,
                lastRole,
                aiAvatarSrc,
                userAvatarSrc
              );
              currentGroup = [];
            }

            // 区分用户撤回和AI撤回
            if (msg.role === "user") {
              html += `<div class="msg-system-tip">你撤回了一条消息</div>`;
            } else {
              // AI撤回，用户可以点击查看原内容
              const recalledContent = (msg.content || "")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .substring(0, 50);
              html += `<div class="msg-system-tip msg-recalled-ai" onclick="showRecalledContent(${index})">
                对方撤回了一条消息 <span style="color:#f48fb1;font-size:0.75rem;">[点击查看]</span>
              </div>`;
            }
            lastRole = null;
            return;
          }

          // 处理系统卡片
          if (msg.type === "system-card") {
            if (currentGroup.length > 0) {
              html += renderMessageGroup(
                currentGroup,
                lastRole,
                aiAvatarSrc,
                userAvatarSrc
              );
              currentGroup = [];
            }
            html += `<div class="msg-system-card">
              <div class="system-card">
                <div class="system-card-icon">${msg.cardIcon || "•"}</div>
                <div class="system-card-title">${
                  msg.cardTitle || "系统消息"
                }</div>
                <div class="system-card-desc">${msg.cardDesc || ""}</div>
              </div>
            </div>`;
            lastRole = null;
            return;
          }

          if (msg.role !== lastRole && currentGroup.length > 0) {
            html += renderMessageGroup(
              currentGroup,
              lastRole,
              aiAvatarSrc,
              userAvatarSrc
            );
            currentGroup = [];
          }

          currentGroup.push({ ...msg, originalIndex: index });
          lastRole = msg.role;

          if (index === history.length - 1) {
            html += renderMessageGroup(
              currentGroup,
              lastRole,
              aiAvatarSrc,
              userAvatarSrc
            );
          }
        });

        container.innerHTML = html;

        // 【关键修改】如果不是在多选模式，强制滚动到底部
        // 使用 setTimeout 确保 DOM 渲染完成后再滚动
        if (typeof isSelectionMode === "undefined" || !isSelectionMode) {
          setTimeout(() => {
            container.scrollTop = container.scrollHeight;
          }, 0);
        }
      }

      // 3. 长按处理逻辑
      function handleTouchStart(e, index) {
        if (isSelectionMode) return; // 多选模式下不触发长按
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;

        longPressTimer = setTimeout(() => {
          showContextMenu(e.touches[0].clientX, e.touches[0].clientY, index);
        }, 500); // 500ms 长按触发
      }

      function handleTouchMove(e) {
        if (!longPressTimer) return;
        // 如果移动超过一定距离，取消长按
        let moveX = e.touches[0].clientX;
        let moveY = e.touches[0].clientY;
        if (
          Math.abs(moveX - touchStartX) > 10 ||
          Math.abs(moveY - touchStartY) > 10
        ) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      }

      function handleTouchEnd() {
        if (longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      }

      // 鼠标兼容 (PC端调试用)
      function handleMouseDown(e, index) {
        if (isSelectionMode) return;
        longPressTimer = setTimeout(() => {
          showContextMenu(e.clientX, e.clientY, index);
        }, 500);
      }
      function handleMouseUp() {
        if (longPressTimer) clearTimeout(longPressTimer);
      }

      // ==================== 简化版：显示居中菜单 ====================
      // ==================== 最终定稿：屏幕居中逻辑 ====================

      function showContextMenu(x, y, index) {
        if (navigator.vibrate) navigator.vibrate(50);

        activeMsgIndex = index;
        const overlay = document.getElementById("contextMenuOverlay");
        const menu = document.getElementById("contextMenu");

        // 获取当前消息角色
        const history = chatHistories[currentChatCharId];
        const msg = history[index];
        const isUser = msg.role === "user";

        // 构建菜单内容
        let menuHtml = `<div class="menu-item" onclick="handleCopyMsg()">复制</div>`;
        menuHtml += `<div class="menu-item" onclick="handleQuoteMsg()">引用</div>`;

        if (isUser) {
          menuHtml += `<div class="menu-item" onclick="handleRecallMsg()">撤回</div>`;
        }

        menuHtml += `
                                <div class="menu-item" onclick="handleEditMsg()">编辑</div>
                                <div class="menu-item" onclick="handleMultiSelect()">多选</div>
                                <div class="menu-item danger" onclick="handleDeleteMsg()">删除</div>
                            `;

        menu.innerHTML = menuHtml;

        // 清除可能残留的内联样式
        menu.style.left = "";
        menu.style.top = "";
        menu.classList.remove("arrow-top");

        // 显示
        overlay.classList.add("active");
        setTimeout(() => menu.classList.add("show"), 10);
      }
      // ==================== 最终版：锚定气泡的菜单逻辑 ====================

      function hideContextMenu() {
        const overlay = document.getElementById("contextMenuOverlay");
        const menu = document.getElementById("contextMenu");
        menu.classList.remove("show");
        setTimeout(() => overlay.classList.remove("active"), 200);
      }

      // 气泡点击处理（多选模式下切换选中状态）
      function handleBubbleClick(event, index) {
        if (isSelectionMode) {
          event.stopPropagation();
          if (selectedIndices.has(index)) {
            selectedIndices.delete(index);
          } else {
            selectedIndices.add(index);
          }
          updateSelectionUI();
          renderConversation();
        }
      }

      // 选择器点击切换选中状态
      function toggleMessageSelection(index) {
        if (!isSelectionMode) return;
        if (selectedIndices.has(index)) {
          selectedIndices.delete(index);
        } else {
          selectedIndices.add(index);
        }
        updateSelectionUI();
        renderConversation();
      }

      // 整行点击处理（多选模式下）
      function handleWrapperClick(event, index) {
        if (isSelectionMode && index !== undefined) {
          event.stopPropagation();
          if (selectedIndices.has(index)) {
            selectedIndices.delete(index);
          } else {
            selectedIndices.add(index);
          }
          updateSelectionUI();
          renderConversation();
        }
      }

      // 5. 菜单功能实现

      // 当前引用的消息
      var currentQuote = null;

      // 复制
      function handleCopyMsg() {
        const msg = chatHistories[currentChatCharId][activeMsgIndex];
        navigator.clipboard.writeText(msg.content).then(() => {
          showToast("已复制");
        });
        hideContextMenu();
      }

      // 引用消息
      function handleQuoteMsg() {
        const msg = chatHistories[currentChatCharId][activeMsgIndex];
        const char = characters.find((c) => c.id === currentChatCharId);

        // 获取发送者名称
        const senderName =
          msg.role === "user" ? "我" : char?.note || char?.name || "TA";

        // 清理消息内容用于显示（去掉HTML标签）
        let content = msg.content || "";
        content = content.replace(/<[^>]+>/g, "").trim();
        if (content.length > 50) content = content.substring(0, 50) + "...";

        // 保存引用信息
        currentQuote = {
          msgIndex: activeMsgIndex,
          sender: senderName,
          senderRole: msg.role,
          content: msg.content,
          displayContent: content,
        };

        // 显示引用预览
        document.getElementById("quotePreview").style.display = "flex";
        document.getElementById("quotePreviewSender").textContent = senderName;
        document.getElementById("quotePreviewText").textContent = content;

        // 聚焦输入框
        document.getElementById("convInput").focus();

        hideContextMenu();
        showToast("已引用消息");
      }

      // 取消引用
      function cancelQuote() {
        currentQuote = null;
        document.getElementById("quotePreview").style.display = "none";
      }

      // 撤回 (核心功能：AI可见，用户不可见)
      function handleRecallMsg() {
        if (!confirm("确定撤回这条消息吗？(AI仍会记得此内容)")) return;

        // 标记为已撤回，不删除
        chatHistories[currentChatCharId][activeMsgIndex].isRecalled = true;
        localforage.setItem("chatHistories", chatHistories);

        renderConversation();
        showToast("消息已撤回");
        hideContextMenu();
      }

      // 查看AI撤回的消息内容
      function showRecalledContent(msgIndex) {
        const msg = chatHistories[currentChatCharId][msgIndex];
        if (!msg) return;

        let content = msg.content || "";
        // 清理HTML标签用于显示
        content = content.replace(/<[^>]+>/g, "").substring(0, 200);
        if (content.length >= 200) content += "...";

        alert(`对方撤回的内容：\n\n${content}`);
      }

      // 删除 (核心功能：AI失忆)
      function handleDeleteMsg() {
        if (!confirm("确定删除？(AI将忘记这条消息)")) return;

        // 彻底从数组移除
        chatHistories[currentChatCharId].splice(activeMsgIndex, 1);
        localforage.setItem("chatHistories", chatHistories);

        // 更新设置页的统计
        document.getElementById("settingsTotalMsg").textContent =
          chatHistories[currentChatCharId].length;

        renderConversation();
        showToast("消息已删除");
      }

      // 编辑 (核心功能：AI记忆更新)
      function handleEditMsg() {
        const msg = chatHistories[currentChatCharId][activeMsgIndex];

        // 弹出一个 prompt 或者使用之前的 editModal (为了简单这里用 prompt，你可以改用 editModal)
        // 使用多行输入框效果更好
        const newContent = prompt("编辑消息 (AI记忆将更新):", msg.content);

        if (newContent !== null && newContent.trim() !== "") {
          chatHistories[currentChatCharId][activeMsgIndex].content =
            newContent.trim();
          localforage.setItem("chatHistories", chatHistories);

          renderConversation();
          showToast("消息已编辑");
        }
      }

      // 多选模式入口
      function handleMultiSelect() {
        isSelectionMode = true;
        selectedIndices.clear();

        // 默认选中触发长按的那一条
        selectedIndices.add(activeMsgIndex);

        // 更新 UI 状态
        document.getElementById("convInput").blur(); // 收起键盘
        document.querySelector(".conv-input-area").style.display = "none"; // 隐藏输入框
        document.getElementById("selectionFooter").classList.add("active"); // 显示删除栏

        renderConversation(); // 重新渲染以显示 checkbox
        updateSelectionUI();
      }

      // 6. 多选模式逻辑

      // 点击消息 (在多选模式下)
      function handleClickMsg(index) {
        if (!isSelectionMode) return;
        // 这里因为我们在 render 时是按组渲染 onclick，所以这个函数可能被组点击覆盖
        // 但如果直接点气泡，事件冒泡，可以在这里处理
      }

      // 切换一组消息的选中状态
      function toggleSelectionGroup(indices) {
        // 检查这组是否全选了，如果是，则反选；否则全选
        const allSelected = indices.every((i) => selectedIndices.has(i));

        if (allSelected) {
          indices.forEach((i) => selectedIndices.delete(i));
        } else {
          indices.forEach((i) => selectedIndices.add(i));
        }

        // 强制更新 UI (不完全重绘，只切换 class)
        const firstIdx = indices[0];
        const wrapper = document.getElementById(`msg-wrapper-${firstIdx}`);
        if (wrapper) {
          if (!allSelected) wrapper.classList.add("selected");
          else wrapper.classList.remove("selected");
        }

        updateSelectionUI();
      }

      function exitSelectionMode() {
        isSelectionMode = false;
        selectedIndices.clear();

        document.querySelector(".conv-input-area").style.display = "block";
        document.getElementById("selectionFooter").classList.remove("active");

        renderConversation();
      }
      // ==================== 消息格式解析器 ====================
      function formatNovelMessage(text) {
        // 1. 先进行 HTML 转义，防止 XSS
        let safeText = escapeHtml(text);

        // 2. 处理心理活动：把 *内容* 替换为 <i>内容</i>
        // 使用正则：\* 匹配星号，([^*]+) 捕获中间非星号的内容
        safeText = safeText.replace(/\*([^*]+)\*/g, "<i>*$1*</i>");

        // 3. 处理换行：把 \n 替换为 <br>
        safeText = safeText.replace(/\n/g, "<br>");

        return safeText;
      }

      // ==================== 语音条播放功能 ====================
      let currentPlayingAudio = null;
      let currentPlayingBar = null;
      // voiceTouchStartTime 已在文件开头用var声明

      // 语音气泡的touchstart处理 - 记录开始时间
      function handleVoiceBubbleTouchStart(event, msgIndex) {
        voiceTouchStartTime = Date.now();
        // 调用原来的长按处理
        handleTouchStart(event, msgIndex);
      }

      // 语音气泡的touchend处理 - 判断是短按还是长按
      function handleVoiceBubbleTouchEnd(event, msgIndex) {
        const touchDuration = Date.now() - voiceTouchStartTime;

        // 如果触摸时间小于450ms，且longPressTimer还存在（说明长按还没触发）
        // 则视为点击，播放语音
        if (touchDuration < 450 && longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;

          // 播放语音
          const voiceBar = event.currentTarget.querySelector(".voice-bar");
          if (voiceBar) {
            playVoiceMessageByIndex(msgIndex, voiceBar);
          }
        } else if (longPressTimer) {
          // 超过450ms但菜单还没显示，清除计时器
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
        // 如果longPressTimer已经是null，说明长按菜单已经显示了，不需要做任何事
      }

      // 通过索引播放语音
      function playVoiceMessageByIndex(msgIndex, voiceBar) {
        const history = chatHistories[currentChatCharId] || [];
        const msg = history[msgIndex];
        if (!msg) return;

        // 如果正在播放，停止
        if (currentPlayingAudio && currentPlayingBar === voiceBar) {
          currentPlayingAudio.pause();
          currentPlayingAudio.currentTime = 0;
          currentPlayingAudio = null;
          voiceBar.classList.remove("playing");
          currentPlayingBar = null;
          return;
        }

        // 停止之前的播放
        if (currentPlayingAudio) {
          currentPlayingAudio.pause();
          currentPlayingAudio.currentTime = 0;
          if (currentPlayingBar) {
            currentPlayingBar.classList.remove("playing");
          }
        }

        // 如果已经有音频URL，直接播放
        if (msg.audioUrl) {
          playAudioFromUrl(msg.audioUrl, voiceBar);
          return;
        }

        // 否则，生成语音
        generateAndPlayVoice(msg, msgIndex, voiceBar);
      }

      // 生成并播放语音
      async function generateAndPlayVoice(msg, msgIndex, voiceBar) {
        const settings = chatSettings[currentChatCharId] || {};

        // 如果没有配置语音ID，直接显示文字而不是弹出提示
        if (!settings.voiceId) {
          // 自动展开文字
          msg.voiceTextVisible = true;
          localforage.setItem("chatHistories", chatHistories);

          // 更新UI显示文字
          const textEl = document.getElementById(`voiceText-${msgIndex}`);
          if (textEl) {
            textEl.classList.add("visible");
          }

          // 更新按钮文字
          const voiceMessage = voiceBar.closest(".voice-message");
          if (voiceMessage) {
            const btn = voiceMessage.querySelector(".voice-to-text-btn");
            if (btn) btn.textContent = "收起文字";
          }
          return;
        }

        // 获取语音文本
        const voiceMatch = msg.content.match(/^\[语音[ :：〃\s]*(.+)\]$/);
        if (!voiceMatch) return;

        const voiceText = voiceMatch[1];

        // 显示加载状态（静默生成，不显示Toast提示）
        voiceBar.classList.add("loading");

        try {
          const audioUrl = await generateSpeech(voiceText, currentChatCharId);

          if (audioUrl) {
            // 保存到消息中
            const history = chatHistories[currentChatCharId];
            if (history && history[msgIndex]) {
              history[msgIndex].audioUrl = audioUrl;
              localforage.setItem("chatHistories", chatHistories);
            }

            voiceBar.classList.remove("loading");
            voiceBar.classList.add("has-audio");
            voiceBar.dataset.audioUrl = audioUrl;

            // 播放
            playAudioFromUrl(audioUrl, voiceBar);
          } else {
            voiceBar.classList.remove("loading");
            showToast("语音生成失败");
          }
        } catch (e) {
          console.error("Voice generation error:", e);
          voiceBar.classList.remove("loading");
          showToast("语音生成出错");
        }
      }

      // 播放语音消息 (onclick用，PC端)
      async function playVoiceMessage(event, msgIndex) {
        event.stopPropagation();
        const voiceBar = event.currentTarget;
        playVoiceMessageByIndex(msgIndex, voiceBar);
      }

      // 播放音频
      function playAudioFromUrl(url, voiceBar) {
        console.log("[Voice] Playing audio from URL:", url);
        const audio = new Audio(url);
        currentPlayingAudio = audio;
        currentPlayingBar = voiceBar;

        voiceBar.classList.add("playing");

        audio.oncanplaythrough = () => {
          console.log("[Voice] Audio can play through");
        };

        audio.onended = () => {
          console.log("[Voice] Audio ended");
          voiceBar.classList.remove("playing");
          currentPlayingAudio = null;
          currentPlayingBar = null;
        };

        audio.onerror = (e) => {
          console.error("[Voice] Audio error:", audio.error);
          voiceBar.classList.remove("playing");
          currentPlayingAudio = null;
          currentPlayingBar = null;
          showToast("音频播放失败: " + (audio.error?.message || "未知错误"));
        };

        audio
          .play()
          .then(() => {
            console.log("[Voice] Audio playing...");
          })
          .catch((e) => {
            console.error("[Voice] Audio play error:", e);
            voiceBar.classList.remove("playing");
            currentPlayingAudio = null;
            currentPlayingBar = null;
            showToast("播放失败: " + e.message);
          });
      }

      // 切换语音文字显示
      function toggleVoiceText(event, msgIndex) {
        event.stopPropagation();

        const history = chatHistories[currentChatCharId] || [];
        const msg = history[msgIndex];
        if (!msg) return;

        // 切换状态
        msg.voiceTextVisible = !msg.voiceTextVisible;
        localforage.setItem("chatHistories", chatHistories);

        // 更新UI
        const textEl = document.getElementById(`voiceText-${msgIndex}`);
        const btn = event.currentTarget;

        if (msg.voiceTextVisible) {
          textEl.classList.add("visible");
          btn.textContent = "收起文字";
        } else {
          textEl.classList.remove("visible");
          btn.textContent = "转文字";
        }
      }

      // ==================== 语音功能 (MiniMax TTS 完整最终版) ====================

      // 1. 全局变量voiceConfig已在初始化时从localforage加载到window.voiceConfig
      // 这里不需要重新定义

      // 2. 切换线路 UI
      function switchVoiceUrl(type) {
        const cnBtn = document.getElementById("voiceUrlCN");
        const intlBtn = document.getElementById("voiceUrlIntl");

        if (!cnBtn || !intlBtn) return; // 防止找不到元素报错

        cnBtn.classList.remove("active");
        intlBtn.classList.remove("active");

        if (type === "cn") {
          cnBtn.classList.add("active");
        } else {
          intlBtn.classList.add("active");
        }
      }

      // 3. 初始化加载配置到界面
      function loadVoiceSettings() {
        // voiceConfig已经在初始化时加载到window.voiceConfig
        const config = window.voiceConfig || {};

        if (config.groupId) {
          const groupIdEl = document.getElementById("voiceGroupId");
          if (groupIdEl) groupIdEl.value = config.groupId;
        }
        if (config.apiKey) {
          const apiKeyEl = document.getElementById("voiceApiKey");
          if (apiKeyEl) apiKeyEl.value = config.apiKey;
        }
        if (config.model) {
          const modelEl = document.getElementById("voiceModelSelect");
          if (modelEl) modelEl.value = config.model;
        }

        // 加载线路选择 (默认国内)
        const baseUrl = config.baseUrl || "https://api.minimax.chat";
        if (baseUrl.includes("minimaxi.chat")) {
          switchVoiceUrl("intl");
        } else {
          switchVoiceUrl("cn");
        }

        console.log("语音配置已加载:", {
          groupId: config.groupId ? "已设置" : "未设置",
          model: config.model,
        });
      }
      // 监听加载 - 延迟执行确保数据已从localforage加载
      document.addEventListener("DOMContentLoaded", () => {
        setTimeout(loadVoiceSettings, 500);
      });

      // 4. 保存配置
      function saveVoiceConfig() {
        const groupId = document.getElementById("voiceGroupId").value.trim();
        const apiKey = document.getElementById("voiceApiKey").value.trim();
        const model = document.getElementById("voiceModelSelect").value;

        // 获取当前选中的线路
        const intlBtn = document.getElementById("voiceUrlIntl");
        const isIntl = intlBtn && intlBtn.classList.contains("active");
        const baseUrl = isIntl
          ? "https://api.minimaxi.chat"
          : "https://api.minimax.chat";

        if (!groupId || !apiKey) {
          alert("请填写完整的 Group ID 和 API Key");
          return;
        }

        window.voiceConfig = { groupId, apiKey, model, baseUrl };
        localforage.setItem("voiceConfig", window.voiceConfig);
        showToast("语音配置已保存 🎙️");
      }

      // 播放嵌入式语音标签
      async function playInlineVoice(el, text) {
        if (!text) return;

        // 检查是否有语音配置
        const settings = chatSettings[currentChatCharId] || {};
        if (!settings.voiceId) {
          showToast("此角色未配置语音");
          return;
        }

        el.innerHTML = "▶ 播放中...";
        el.style.pointerEvents = "none";

        try {
          const audioUrl = await generateSpeech(text, currentChatCharId);
          if (audioUrl) {
            const audio = new Audio(audioUrl);
            audio.play();
            audio.onended = () => {
              el.innerHTML = `♪ ${
                text.length > 20 ? text.substring(0, 20) + "..." : text
              }`;
              el.style.pointerEvents = "auto";
            };
          } else {
            el.innerHTML = `♪ ${
              text.length > 20 ? text.substring(0, 20) + "..." : text
            }`;
            el.style.pointerEvents = "auto";
          }
        } catch (e) {
          console.error("语音播放失败", e);
          el.innerHTML = `♪ ${
            text.length > 20 ? text.substring(0, 20) + "..." : text
          }`;
          el.style.pointerEvents = "auto";
        }
      }

      // ==================== 优化版：generateSpeech (更自然的断句) ====================
      async function generateSpeech(text, charId) {
        // 1. 获取 ID 和 Key
        let currentGroupId =
          (window.voiceConfig && window.voiceConfig.groupId) ||
          document.getElementById("voiceGroupId")?.value;
        let currentApiKey =
          (window.voiceConfig && window.voiceConfig.apiKey) ||
          document.getElementById("voiceApiKey")?.value;

        if (!currentGroupId || !currentApiKey) {
          alert("请先在 API 设置页填写 MiniMax Group ID 和 API Key！");
          return null;
        }

        // 2. 获取 Voice ID
        const settings = chatSettings[charId];
        let voiceId = settings?.voiceId;
        if (charId === "temp_test") {
          voiceId = document.getElementById("settingsVoiceId").value.trim();
        }

        if (!voiceId) {
          alert("请先填写 Voice ID！");
          return null;
        }

        // ========== 核心优化：文本清洗 (Prompt 也就是在这里调整) ==========
        let cleanText = text;

        // 1. 去除动作描写和心理活动 (括号或星号里的内容不读)
        cleanText = cleanText
          .replace(/[\(（][^\)）]*[\)）]/g, "")
          .replace(/\*[^\*]+\*/g, "");

        // 2. 【关键】处理换行符：把换行变成逗号，防止由于排版导致的奇怪长停顿
        cleanText = cleanText.replace(/\n/g, "，");

        // 3. 处理可能导致卡顿的特殊符号
        cleanText = cleanText
          .replace(/……/g, "，") // 省略号太长会卡，改成逗号
          .replace(/…/g, "，")
          .replace(/—/g, "，") // 破折号改成逗号
          .replace(/~/g, "阿") // 【小技巧】波浪号如果是语气词(如:好哒~)，改成"阿"或"耶"会更自然，或者直接去掉
          .replace(/["]/g, ""); // 去掉双引号，防止语调奇怪

        // 4. 最后只保留中文、英文、数字和基本标点 (空格保留，用于英文分词)
        cleanText = cleanText.replace(
          /[^\u4e00-\u9fa5a-zA-Z0-9，。！？,.?! ]/g,
          ""
        );

        // 如果洗完没词了（比如只发了个表情），就不生成
        if (cleanText.trim().length < 1) return null;

        // =============================================================

        // 辅助函数：Blob 转 Base64
        const blobToBase64 = (blob) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(blob);
          });
        };

        const tryFetch = async (baseUrl) => {
          const url = `${baseUrl}/v1/t2a_v2?GroupId=${currentGroupId}`;
          const response = await fetch(url, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${currentApiKey}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              // 【建议】如果你觉得 Turbo 模型太卡，可以在 API 设置里选 speech-02-hd
              model: window.voiceConfig.model || "speech-01-turbo",
              text: cleanText,
              stream: false,
              voice_setting: {
                voice_id: voiceId,
                speed: 1.0,
                vol: 1.0,
                pitch: 0,
              },
              audio_setting: {
                sample_rate: 32000,
                bitrate: 128000,
                format: "mp3",
                channel: 1,
              },
            }),
          });
          return response;
        };

        try {
          const activeIntlBtn = document.getElementById("voiceUrlIntl");
          const isIntlSelected =
            activeIntlBtn && activeIntlBtn.classList.contains("active");
          let firstUrl = isIntlSelected
            ? "https://api.minimaxi.chat"
            : "https://api.minimax.chat";
          let secondUrl = isIntlSelected
            ? "https://api.minimax.chat"
            : "https://api.minimaxi.chat";

          let response = await tryFetch(firstUrl);
          if (response.status === 404) response = await tryFetch(secondUrl);

          if (!response.ok) throw new Error(`API Error ${response.status}`);
          const result = await response.json();

          if (result.base_resp && result.base_resp.status_code !== 0) {
            throw new Error(result.base_resp.status_msg);
          }

          const audioHex = result.data?.audio || result.audio;
          if (audioHex) {
            const bytes = new Uint8Array(audioHex.length / 2);
            for (let i = 0; i < audioHex.length; i += 2) {
              bytes[i / 2] = parseInt(audioHex.substr(i, 2), 16);
            }
            const blob = new Blob([bytes.buffer], { type: "audio/mp3" });
            return await blobToBase64(blob);
          }

          // 备用：URL处理
          const audioUrl = result.data?.audio_url || result.audio_url;
          if (audioUrl) {
            try {
              const urlResp = await fetch(audioUrl);
              const urlBlob = await urlResp.blob();
              return await blobToBase64(urlBlob);
            } catch (e) {
              return audioUrl;
            }
          }
          return null;
        } catch (e) {
          console.error(e);
          // 静默失败，不打扰用户聊天体验
          return null;
        }
      }
      // 6. 试听功能
      async function testCharacterVoice() {
        const voiceId = document.getElementById("settingsVoiceId").value.trim();
        if (!voiceId) {
          alert("请先填写 Voice ID");
          return;
        }

        const btn = document.querySelector(
          'button[onclick="testCharacterVoice()"]'
        );
        const originalText = btn.textContent;
        btn.textContent = "生成中...";
        btn.disabled = true;

        try {
          const tempCharId = "temp_test";
          // 临时存入设置，以便 generateSpeech 读取
          if (!chatSettings[tempCharId]) chatSettings[tempCharId] = {};
          chatSettings[tempCharId].voiceId = voiceId;

          const audioUrl = await generateSpeech(
            "你好，我是你的专属AI伴侣，这是我的声音。",
            tempCharId
          );

          if (audioUrl) {
            const audio = new Audio(audioUrl);
            audio.play();
            btn.textContent = "播放中...";
            audio.onended = () => {
              btn.textContent = originalText;
              btn.disabled = false;
            };
          } else {
            btn.textContent = originalText;
            btn.disabled = false;
          }
          delete chatSettings[tempCharId];
        } catch (e) {
          alert("试听失败");
          btn.textContent = originalText;
          btn.disabled = false;
        }
      }
      /* ==================== 修复：缺失的多选逻辑函数 ==================== */

      // 1. 更新底部多选栏 UI (修复显示 0 条的问题)
      function updateSelectionUI() {
        const count = selectedIndices.size;
        const countEl = document.getElementById("selectionCount");
        const deleteBtn = document.getElementById("multiDeleteBtn");

        // 更新文字
        if (countEl) {
          countEl.textContent = `已选 ${count} 条`;
        }

        // 更新删除按钮状态 (有选中时变红，无选中时变灰)
        if (deleteBtn) {
          if (count > 0) {
            deleteBtn.classList.add("active"); // 这里的 active 类在 CSS 里控制透明度和点击
            deleteBtn.style.opacity = "1";
            deleteBtn.style.pointerEvents = "auto";
          } else {
            deleteBtn.classList.remove("active");
            deleteBtn.style.opacity = "0.3";
            deleteBtn.style.pointerEvents = "none";
          }
        }
      }

      // 2. 执行删除选中的消息 (修复删除按钮无反应)
      function deleteSelectedMessages() {
        if (selectedIndices.size === 0) return;

        if (confirm(`确定要删除这 ${selectedIndices.size} 条消息吗？`)) {
          const history = chatHistories[currentChatCharId] || [];

          // 核心逻辑：过滤掉 index 在 selectedIndices 里的消息
          // 注意：这里利用 filter 产生新数组，非常安全
          const newHistory = history.filter(
            (_, index) => !selectedIndices.has(index)
          );

          // 更新数据
          chatHistories[currentChatCharId] = newHistory;
          localforage.setItem("chatHistories", chatHistories);

          // 更新统计数据
          const totalMsgEl = document.getElementById("settingsTotalMsg");
          if (totalMsgEl) totalMsgEl.textContent = newHistory.length;

          // 退出多选模式并刷新
          exitSelectionMode();
          showToast("删除成功");
        }
      }

      // 3. 补丁：确保 handleMultiSelect 能正确初始化第一条选中
      // (将原来的 handleMultiSelect 替换或覆盖为这个增强版)
      window.handleMultiSelect = function () {
        isSelectionMode = true;
        selectedIndices.clear();

        // 默认选中长按的那一条
        if (activeMsgIndex !== -1) {
          selectedIndices.add(activeMsgIndex);
        }

        // 隐藏输入框，显示删除栏
        const inputArea = document.querySelector(".conv-input-area");
        const footer = document.getElementById("selectionFooter");

        if (inputArea) inputArea.style.display = "none";
        if (footer) {
          footer.style.display = "flex"; // 强制显示
          // 稍微延迟加 active class 以触发动画（如果有）
          setTimeout(() => footer.classList.add("active"), 10);
        }

        // 隐藏长按菜单
        hideContextMenu();

        // 刷新 UI
        updateSelectionUI(); // 立即更新一次文字
        renderConversation(); // 重新渲染气泡以显示勾选状态
      };

      // 4. 补丁：确保退出多选时 UI 复原
      window.exitSelectionMode = function () {
        isSelectionMode = false;
        selectedIndices.clear();

        // 恢复输入框
        const inputArea = document.querySelector(".conv-input-area");
        if (inputArea) inputArea.style.display = "block";

        // 隐藏底部栏
        const footer = document.getElementById("selectionFooter");
        if (footer) {
          footer.classList.remove("active");
          setTimeout(() => (footer.style.display = "none"), 300); // 等动画播完再隐藏
        }

        renderConversation();
      };
      /* ==================== 修复：语音条无法多选的问题 ==================== */

      // 1. 覆盖原有的 playVoiceMessage 函数
      window.playVoiceMessage = async function (event, msgIndex) {
        // 【关键修复】检测是否处于多选模式
        if (typeof isSelectionMode !== "undefined" && isSelectionMode) {
          // 如果是多选模式：
          event.stopPropagation(); // 阻止事件扩散
          event.preventDefault(); // 阻止默认行为

          // 手动调用选中逻辑 (假装我们点击了气泡)
          if (typeof handleBubbleClick === "function") {
            handleBubbleClick(event, msgIndex);
          }
          return; // 直接退出，【不播放】音频
        }

        // --- 以下是原有的播放逻辑 ---
        event.stopPropagation();
        const voiceBar = event.currentTarget;
        playVoiceMessageByIndex(msgIndex, voiceBar);
      };

      // 2. 覆盖原有的 toggleVoiceText 函数 (防止点击"转文字"按钮也选中不了)
      window.toggleVoiceText = function (event, msgIndex) {
        // 【关键修复】检测是否处于多选模式
        if (typeof isSelectionMode !== "undefined" && isSelectionMode) {
          event.stopPropagation();
          if (typeof handleBubbleClick === "function") {
            handleBubbleClick(event, msgIndex);
          }
          return; // 直接退出，不切换文字显示
        }

        // --- 以下是原有的转文字逻辑 ---
        event.stopPropagation();

        const history = chatHistories[currentChatCharId] || [];
        const msg = history[msgIndex];
        if (!msg) return;

        // 切换状态
        msg.voiceTextVisible = !msg.voiceTextVisible;
        localforage.setItem("chatHistories", chatHistories);

        // 更新UI
        const textEl = document.getElementById(`voiceText-${msgIndex}`);
        const btn = event.currentTarget;

        if (msg.voiceTextVisible) {
          textEl.classList.add("visible");
          btn.textContent = "收起文字";
        } else {
          textEl.classList.remove("visible");
          btn.textContent = "转文字";
        }
      };
      // ==================== 新增：更新列表预览文字 ====================
      function updateCharacterLastMessage(charId, rawContent) {
        const charIndex = characters.findIndex((c) => c.id === charId);
        if (charIndex === -1) return;

        let previewText = rawContent;

        // 1. 判断是不是语音消息
        if (rawContent.match(/^\[语音[:：](.+)\]$/)) {
          previewText = "[语音]"; // 或者显示 "[语音] 文本内容"
        } else {
          // 2. 清洗 HTML 标签 (把 <i>心理</i> 变成纯文本)
          // 这一步很重要，否则列表会显示 <i>...</i>
          previewText = rawContent.replace(/<[^>]+>/g, "");

          // 3. 处理小说模式的标记 (把 *动作* 变成纯文本)
          previewText = previewText.replace(/\*/g, "");
        }

        // 更新数据
        characters[charIndex].lastMessage = previewText;
        characters[charIndex].lastTime = new Date().toLocaleTimeString(
          "zh-CN",
          { hour: "2-digit", minute: "2-digit" }
        );

        // 移到置顶 (像微信一样，最新消息排最前) - 可选
        // const updatedChar = characters.splice(charIndex, 1)[0];
        // characters.unshift(updatedChar);

        localforage.setItem("characters", characters);
        renderCharacters(); // 刷新列表界面
      }
      /* ==================== 底部菜单与表情功能 ==================== */
      /* ==================== 全新：自定义表情包功能 (Pro Max版) ==================== */

      // 全局变量
      window.customStickers = []; // 存具体表情对象 {id, src, desc, category}
      window.stickerCategories = []; // 存分类列表 ["默认", "开心", ...]
      window.currentCategory = "默认";
      window.aiStickerBindings = {}; // 每个角色绑定的分类 {charId: ["分类1", "分类2", ...]} // 当前选中的分类

      // 1. 初始化加载
      async function initStickerPanel() {
        try {
          // 读取数据
          const savedStickers = await safeLocalforageGet("customStickers");
          const savedCategories = await safeLocalforageGet("stickerCategories");

          // === 数据迁移逻辑 (防止旧用户报错) ===
          if (Array.isArray(savedStickers) && savedStickers.length > 0) {
            // 检查是不是旧的字符串格式
            if (typeof savedStickers[0] === "string") {
              console.log("正在迁移旧版表情包数据...");
              window.customStickers = savedStickers.map((src) => ({
                id: Date.now() + Math.random(),
                src: src,
                desc: "表情包", // 旧数据默认描述
                category: "默认",
              }));
            } else {
              window.customStickers = savedStickers;
            }
          } else {
            window.customStickers = [];
          }

          // 初始化分类
          window.stickerCategories = savedCategories || ["默认"];

          // 确保“默认”分类永远存在
          if (!window.stickerCategories.includes("默认")) {
            window.stickerCategories.unshift("默认");
          }

          // 编辑模式标记
          window.stickerEditMode = false;
          // 选中的表情包ID列表
          window.selectedStickerIds = [];
          // 搜索关键词
          window.stickerSearchKeyword = "";
          // AI绑定的分类（从本地存储读取）
          const savedAiCat = await safeLocalforageGet("aiStickerCategory");
          // AI绑定数据（新版：每个角色可绑定多个分类）
          const savedBindings = await safeLocalforageGet("aiStickerBindings");
          window.aiStickerBindings = savedBindings || {};

          // 迁移旧版单一绑定数据
          const oldSingleBinding = await safeLocalforageGet(
            "aiStickerCategory"
          );
          if (
            oldSingleBinding &&
            Object.keys(window.aiStickerBindings).length === 0
          ) {
            window.aiStickerBindings["__global__"] = [oldSingleBinding];
            await localforage.setItem(
              "aiStickerBindings",
              window.aiStickerBindings
            );
            await localforage.removeItem("aiStickerCategory");
            console.log("已迁移旧版AI绑定数据");
          }
        } catch (e) {
          console.error("表情包加载失败", e);
          window.customStickers = [];
          window.stickerCategories = ["默认"];
          window.aiStickerBindings = {};
        }

        renderStickerPanel();
      }

      // 页面加载时启动
      document.addEventListener("DOMContentLoaded", initStickerPanel);

      // 2. 渲染整个面板 (分类栏 + 网格)
      function renderStickerPanel() {
        renderCategoryBar();
        renderStickerGrid();
      }

      // 2.1 渲染分类栏
      function renderCategoryBar() {
        const bar = document.getElementById("stickerCategoryBar");
        if (!bar) return;

        let html = "";
        const isEdit = window.stickerEditMode;
        const isSearching =
          window.stickerSearchKeyword &&
          window.stickerSearchKeyword.trim() !== "";

        if (isEdit) {
          // 编辑模式：显示全选和删除按钮
          const currentStickers = window.customStickers.filter(
            (s) => s.category === window.currentCategory
          );
          const currentIds = currentStickers.map((s) => s.id);
          const selectedIds = window.selectedStickerIds || [];
          const allSelected =
            currentIds.length > 0 &&
            currentIds.every((id) => selectedIds.includes(id));

          html += `<button class="edit-action-btn select-all" onclick="toggleSelectAll()">${
            allSelected ? "取消全选" : "全选"
          }</button>`;
          html += `<button class="edit-action-btn delete-btn" id="batchDeleteBtn" onclick="deleteSelectedStickers()" ${
            selectedIds.length === 0 ? "disabled" : ""
          }>删除${
            selectedIds.length > 0 ? " (" + selectedIds.length + ")" : ""
          }</button>`;
          html += `<span class="edit-spacer"></span>`;
        }

        // 搜索模式下显示返回按钮
        if (isSearching && !isEdit) {
          html += `<button class="edit-action-btn" onclick="clearStickerSearch()" style="background:#fff3e0;color:#f57c00;">← 返回</button>`;
        }

        // 获取当前角色的绑定分类（确保使用字符串类型的charId）
        const charId = currentChatCharId
          ? String(currentChatCharId)
          : "__global__";
        const boundCategories = window.aiStickerBindings[charId] || [];

        // 渲染所有分类标签
        window.stickerCategories.forEach((cat) => {
          const activeClass = cat === window.currentCategory ? "active" : "";
          const aiClass = boundCategories.includes(cat) ? "ai-bound" : "";

          if (isEdit && cat !== "默认") {
            // 编辑模式：显示删除按钮
            html += `<div class="category-tab ${activeClass} ${aiClass} editing">
              <span onclick="switchCategory('${cat}')">${cat}</span>
              <span class="cat-delete-btn" onclick="event.stopPropagation();deleteCategory('${cat}')">✕</span>
            </div>`;
          } else if (isEdit && cat === "默认") {
            html += `<div class="category-tab ${activeClass} ${aiClass}" onclick="switchCategory('${cat}')">${cat}</div>`;
          } else {
            html += `<div class="category-tab ${activeClass} ${aiClass}" onclick="switchCategory('${cat}')">${cat}</div>`;
          }
        });

        // 非编辑模式显示添加分类按钮和AI绑定按钮（群聊中不显示AI绑定按钮）
        if (!isEdit && !isSearching) {
          html += `<button class="category-add-btn" onclick="addCategory()">＋</button>`;
          // AI绑定按钮（简洁风格）- 群聊中不显示
          if (!currentGroupId) {
            const hasBindings = boundCategories.length > 0;
            html += `<button class="ai-bind-btn ${
              hasBindings ? "has-bindings" : ""
            }" onclick="openAiBindModal()">
              ⊕ ${hasBindings ? boundCategories.length : ""}
            </button>`;
          }
        }

        // 编辑按钮
        if (!isSearching) {
          const editBtnText = isEdit ? "完成" : "编辑";
          html += `<button class="category-edit-btn" onclick="toggleStickerEditMode()">${editBtnText}</button>`;
        }

        bar.innerHTML = html;
      }

      // 2.2 渲染表情网格
      function renderStickerGrid() {
        const grid = document.getElementById("stickerGrid");
        if (!grid) return;

        const isEdit = window.stickerEditMode;
        const selectedIds = window.selectedStickerIds || [];
        const keyword = (window.stickerSearchKeyword || "")
          .trim()
          .toLowerCase();
        const isSearching = keyword !== "";

        let stickersToShow;

        if (isSearching) {
          // 搜索模式：搜索所有分类
          stickersToShow = window.customStickers.filter((s) =>
            (s.desc || "").toLowerCase().includes(keyword)
          );
        } else {
          // 正常模式：只显示当前分类
          stickersToShow = window.customStickers.filter(
            (s) => s.category === window.currentCategory
          );
        }

        let html = "";

        // 非编辑模式且非搜索模式才显示导入按钮
        if (!isEdit && !isSearching) {
          // 按钮：导入
          html += `
          <div class="sticker-item" onclick="document.getElementById('stickerInput').click()">
              <div class="sticker-add-btn">
                  <div class="sticker-add-icon">📂</div>
                  <div class="sticker-add-text">导入</div>
              </div>
              <div class="sticker-desc">支持相册/TXT</div>
          </div>
      `;

          // 按钮：粘贴链接
          html += `
          <div class="sticker-item" onclick="importStickersFromUrl()">
              <div class="sticker-add-btn">
                  <div class="sticker-add-icon">⊕</div>
                  <div class="sticker-add-text">链接</div>
              </div>
              <div class="sticker-desc">网络图片</div>
          </div>
      `;
        }

        // 搜索结果为空提示
        if (isSearching && stickersToShow.length === 0) {
          html += `<div class="sticker-empty-hint">没有找到"${keyword}"相关的表情包</div>`;
        }

        // 渲染表情列表 (倒序，新的在前)
        stickersToShow
          .slice()
          .reverse()
          .forEach((sticker) => {
            if (isEdit) {
              // 编辑模式：显示选择框
              const isSelected = selectedIds.includes(sticker.id);
              const selectedClass = isSelected ? "selected" : "";
              html += `
              <div class="sticker-item editing ${selectedClass}" onclick="toggleStickerSelect('${
                sticker.id
              }')">
                  <div class="sticker-img-box">
                      <img src="${sticker.src}" loading="lazy">
                      <div class="sticker-select-mark">${
                        isSelected ? "✓" : ""
                      }</div>
                  </div>
                  <div class="sticker-desc">${sticker.desc || "表情"}</div>
              </div>
          `;
            } else {
              // 正常模式
              html += `
              <div class="sticker-item" 
                   onclick="sendSticker('${sticker.id}')">
                  <div class="sticker-img-box">
                      <img src="${sticker.src}" loading="lazy">
                  </div>
                  <div class="sticker-desc">${sticker.desc || "表情"}</div>
              </div>
          `;
            }
          });

        grid.innerHTML = html;
      }

      // 3. 切换分类
      function switchCategory(cat) {
        window.currentCategory = cat;
        renderStickerPanel();
      }

      // 4. 添加新分类
      async function addCategory() {
        const name = prompt("请输入新分类名称（如：猫猫头）：");
        if (!name) return;

        if (window.stickerCategories.includes(name)) {
          alert("这个分类已经有了！");
          return;
        }

        window.stickerCategories.push(name);
        await localforage.setItem(
          "stickerCategories",
          window.stickerCategories
        );

        // 自动切换到新分类
        switchCategory(name);
      }

      // 5. 删除分类
      async function deleteCategory(cat) {
        if (cat === "默认") return;

        if (
          confirm(
            `确定要删除分类"${cat}"吗？
该分类下的表情包会移动到"默认"分类。`
          )
        ) {
          // 把该分类下的表情移动到默认
          window.customStickers.forEach((s) => {
            if (s.category === cat) s.category = "默认";
          });

          // 移除分类
          window.stickerCategories = window.stickerCategories.filter(
            (c) => c !== cat
          );

          // 保存
          await Promise.all([
            localforage.setItem("customStickers", window.customStickers),
            localforage.setItem("stickerCategories", window.stickerCategories),
          ]);

          // 切换回默认
          switchCategory("默认");
          showToast("分类已删除");
        }
      }

      // 切换编辑模式
      function toggleStickerEditMode() {
        window.stickerEditMode = !window.stickerEditMode;
        // 退出编辑模式时清空选中
        if (!window.stickerEditMode) {
          window.selectedStickerIds = [];
        }
        renderStickerPanel();
      }

      // 切换选中状态
      function toggleStickerSelect(id) {
        const numId = Number(id);
        if (!window.selectedStickerIds) {
          window.selectedStickerIds = [];
        }
        const idx = window.selectedStickerIds.indexOf(numId);
        if (idx === -1) {
          window.selectedStickerIds.push(numId);
        } else {
          window.selectedStickerIds.splice(idx, 1);
        }
        renderStickerGrid();
        updateDeleteBtnState();
      }

      // 全选/取消全选当前分类的表情
      function toggleSelectAll() {
        const currentStickers = window.customStickers.filter(
          (s) => s.category === window.currentCategory
        );
        const currentIds = currentStickers.map((s) => s.id);

        // 检查是否已全选
        const allSelected = currentIds.every(
          (id) =>
            window.selectedStickerIds && window.selectedStickerIds.includes(id)
        );

        if (allSelected) {
          // 取消全选：移除当前分类的所有id
          window.selectedStickerIds = (window.selectedStickerIds || []).filter(
            (id) => !currentIds.includes(id)
          );
        } else {
          // 全选：添加当前分类的所有id
          if (!window.selectedStickerIds) window.selectedStickerIds = [];
          currentIds.forEach((id) => {
            if (!window.selectedStickerIds.includes(id)) {
              window.selectedStickerIds.push(id);
            }
          });
        }
        renderStickerGrid();
        updateDeleteBtnState();
      }

      // 更新删除按钮状态
      function updateDeleteBtnState() {
        const btn = document.getElementById("batchDeleteBtn");
        const count = (window.selectedStickerIds || []).length;
        if (btn) {
          btn.textContent = count > 0 ? `删除 (${count})` : "删除";
          btn.disabled = count === 0;
        }
      }

      // 批量删除选中的表情包
      async function deleteSelectedStickers() {
        const count = (window.selectedStickerIds || []).length;
        if (count === 0) {
          showToast("请先选择表情包");
          return;
        }

        if (!confirm(`确定要删除选中的 ${count} 个表情包吗？`)) return;

        window.customStickers = window.customStickers.filter(
          (s) => !window.selectedStickerIds.includes(s.id)
        );
        await localforage.setItem("customStickers", window.customStickers);
        window.selectedStickerIds = [];
        renderStickerGrid();
        updateDeleteBtnState();
        showToast(`已删除 ${count} 个表情包`);
      }

      // 删除单个表情包（保留兼容）
      async function deleteStickerById(id) {
        // 转换为数字类型进行比较（因为id是Date.now()+Math.random()生成的数字）
        const numId = Number(id);
        window.customStickers = window.customStickers.filter(
          (s) => s.id !== numId
        );
        await localforage.setItem("customStickers", window.customStickers);
        // 同时从选中列表移除
        if (window.selectedStickerIds) {
          window.selectedStickerIds = window.selectedStickerIds.filter(
            (id) => id !== numId
          );
        }
        renderStickerGrid();
        showToast("已删除");
      }

      // ==================== 搜索功能 ====================
      function handleStickerSearch(value) {
        window.stickerSearchKeyword = value;
        // 显示/隐藏清除按钮
        const clearBtn = document.getElementById("stickerSearchClear");
        if (clearBtn) {
          clearBtn.classList.toggle("show", value.trim() !== "");
        }
        renderStickerPanel();
      }

      function clearStickerSearch() {
        window.stickerSearchKeyword = "";
        const input = document.getElementById("stickerSearchInput");
        if (input) input.value = "";
        const clearBtn = document.getElementById("stickerSearchClear");
        if (clearBtn) clearBtn.classList.remove("show");
        renderStickerPanel();
      }

      // ==================== AI表情包绑定功能（新版：多分类+每角色）====================

      // 打开AI绑定弹窗
      function openAiBindModal() {
        // 检查是否在对话中（确保使用字符串类型的charId）
        const charId = currentChatCharId ? String(currentChatCharId) : null;
        const charName = charId
          ? characters.find((c) => String(c.id) === charId)?.name || "当前角色"
          : null;

        // 获取当前角色的绑定（注意：要深拷贝，避免引用问题）
        const currentBindings = window.aiStickerBindings[charId] || [];
        const boundCategories = [...currentBindings]; // 深拷贝

        // 保存当前正在编辑的角色ID和初始选中状态
        window._tempAiBindCharId = charId;
        window._tempAiBindCategories = [...boundCategories];

        console.log(
          "打开绑定弹窗 - 角色ID:",
          charId,
          "当前绑定:",
          boundCategories
        );

        // 创建弹窗HTML
        let modalHtml = `
          <div class="ai-bind-modal-overlay" id="aiBindModalOverlay" onclick="if(event.target===this)closeAiBindModal()">
            <div class="ai-bind-modal">
              <div class="ai-bind-modal-header">
                <div>
                  <div class="ai-bind-modal-title">⊕ 绑定表情包</div>
                  <div class="ai-bind-modal-subtitle">${
                    charName
                      ? `为「${charName}」选择表情包`
                      : "请先打开一个对话"
                  }</div>
                </div>
                <button class="ai-bind-modal-close" onclick="closeAiBindModal()">✕</button>
              </div>
              <div class="ai-bind-modal-body">
        `;

        if (!charId) {
          modalHtml += `<div class="ai-bind-empty-hint">💡 请先进入一个角色的对话，<br>然后再来绑定表情包</div>`;
        } else if (window.stickerCategories.length === 0) {
          modalHtml += `<div class="ai-bind-empty-hint">暂无表情分类<br>请先添加一些表情包</div>`;
        } else {
          modalHtml += `<div class="ai-bind-char-hint">💡 每个角色可以绑定不同的表情包分类</div>`;

          window.stickerCategories.forEach((cat) => {
            const count = window.customStickers.filter(
              (s) => s.category === cat
            ).length;
            const isSelected = boundCategories.includes(cat);
            modalHtml += `
              <div class="ai-bind-category-item ${
                isSelected ? "selected" : ""
              }" onclick="toggleAiBindCategory('${cat}')">
                <div class="ai-bind-category-checkbox">${
                  isSelected ? "✓" : ""
                }</div>
                <div class="ai-bind-category-info">
                  <div class="ai-bind-category-name">${cat}</div>
                  <div class="ai-bind-category-count">${count} 个表情</div>
                </div>
              </div>
            `;
          });
        }

        modalHtml += `
              </div>
              <div class="ai-bind-modal-footer">
                <button class="ai-bind-modal-btn cancel" onclick="closeAiBindModal()">取消</button>
                <button class="ai-bind-modal-btn confirm" onclick="saveAiBindings()" ${
                  !charId ? "disabled" : ""
                }>确定</button>
              </div>
            </div>
          </div>
        `;

        // 移除旧弹窗（如果存在）
        const oldModal = document.getElementById("aiBindModalOverlay");
        if (oldModal) oldModal.remove();

        // 插入弹窗
        document.body.insertAdjacentHTML("beforeend", modalHtml);

        // 显示弹窗
        setTimeout(() => {
          document.getElementById("aiBindModalOverlay").classList.add("active");
        }, 10);
      }

      // 关闭AI绑定弹窗
      function closeAiBindModal() {
        const modal = document.getElementById("aiBindModalOverlay");
        if (modal) {
          modal.classList.remove("active");
          setTimeout(() => modal.remove(), 200);
        }
        // 清理所有临时变量
        window._tempAiBindCategories = null;
        window._tempAiBindCharId = null;
      }

      // 切换分类选中状态
      function toggleAiBindCategory(cat) {
        if (!window._tempAiBindCategories) window._tempAiBindCategories = [];

        const index = window._tempAiBindCategories.indexOf(cat);
        if (index > -1) {
          window._tempAiBindCategories.splice(index, 1);
        } else {
          window._tempAiBindCategories.push(cat);
        }

        // 更新UI
        const items = document.querySelectorAll(".ai-bind-category-item");
        items.forEach((item) => {
          const name = item.querySelector(".ai-bind-category-name").textContent;
          const isSelected = window._tempAiBindCategories.includes(name);
          item.classList.toggle("selected", isSelected);
          item.querySelector(".ai-bind-category-checkbox").textContent =
            isSelected ? "✓" : "";
        });
      }

      // 保存绑定
      async function saveAiBindings() {
        // 使用打开弹窗时保存的角色ID，而不是当前可能已改变的角色ID
        const charId = window._tempAiBindCharId;
        if (!charId) {
          showToast("请先打开一个对话");
          return;
        }

        const selectedCategories = window._tempAiBindCategories || [];

        console.log(
          "保存绑定 - 角色ID:",
          charId,
          "选中分类:",
          selectedCategories
        );
        console.log(
          "保存前的绑定数据:",
          JSON.stringify(window.aiStickerBindings)
        );

        // 更新绑定（使用字符串charId作为键，深拷贝数组）
        if (selectedCategories.length > 0) {
          window.aiStickerBindings[charId] = [...selectedCategories];
        } else {
          delete window.aiStickerBindings[charId];
        }

        console.log(
          "保存后的绑定数据:",
          JSON.stringify(window.aiStickerBindings)
        );

        // 保存到本地存储
        await localforage.setItem(
          "aiStickerBindings",
          window.aiStickerBindings
        );

        // 统计表情数量
        const totalCount = selectedCategories.reduce((sum, cat) => {
          return (
            sum + window.customStickers.filter((s) => s.category === cat).length
          );
        }, 0);

        if (selectedCategories.length > 0) {
          showToast(
            `已绑定 ${selectedCategories.length} 个分类（${totalCount} 个表情）`
          );
        } else {
          showToast("已清除表情包绑定");
        }

        closeAiBindModal();
        renderCategoryBar();
      }

      // 获取AI可用的表情包列表（供AI调用）- 新版支持多分类
      function getAiStickers() {
        // 确保使用字符串类型的charId
        const charId = currentChatCharId
          ? String(currentChatCharId)
          : "__global__";
        const boundCategories = window.aiStickerBindings[charId] || [];

        if (boundCategories.length === 0) return [];

        return window.customStickers.filter((s) =>
          boundCategories.includes(s.category)
        );
      }

      // AI发送表情包（根据描述匹配）
      function getAiStickerByKeyword(keyword) {
        const stickers = getAiStickers();
        if (stickers.length === 0) return null;

        // 优先精确匹配
        let match = stickers.find(
          (s) => s.desc && s.desc.toLowerCase() === keyword.toLowerCase()
        );
        if (match) return match;

        // 模糊匹配
        match = stickers.find(
          (s) => s.desc && s.desc.toLowerCase().includes(keyword.toLowerCase())
        );
        if (match) return match;

        // 随机返回一个
        return stickers[Math.floor(Math.random() * stickers.length)];
      }

      // 处理AI回复中的表情包标签 [sticker:xxx]
      function processAiStickerTags(text) {
        if (!text) return text;

        // 匹配 [sticker:xxx] 或 [表情:xxx] 或 [表情包:xxx] 格式
        const stickerRegex = /\[(sticker|表情|表情包)[：:]\s*([^\]]+)\]/gi;

        return text.replace(stickerRegex, (match, type, keyword) => {
          const sticker = getAiStickerByKeyword(keyword.trim());
          if (sticker) {
            return `<img src="${sticker.src}" class="sticker-img" alt="${
              sticker.desc || "表情"
            }" onclick="showFullImage('${sticker.src}')">`;
          }
          // 如果找不到匹配的表情包，返回原文本
          return match;
        });
      }

      // 生成AI表情包提示词（用于发送给AI的system prompt）
      function generateAiStickerPrompt() {
        const stickers = getAiStickers();
        if (stickers.length === 0) return "";

        const stickerList = stickers.map((s) => s.desc || "表情").join("、");
        return `\n\n【表情包功能】你可以在回复中使用表情包来表达情绪！使用格式：[sticker:表情名称]
可用的表情包有：${stickerList}
例如：[sticker:开心] 或 [sticker:害羞]
请根据对话情境自然地使用表情包，但不要过度使用。`;
      }

      // 6. 导入逻辑 (升级版：支持自动识别 TXT 描述)
      async function handleStickerImport(input) {
        const files = Array.from(input.files);
        if (files.length === 0) return;

        // 默认描述（仅作为兜底）
        let fallbackDesc = null;

        let addedCount = 0;
        showToast("正在处理...");

        for (const file of files) {
          let newStickers = [];

          // === 情况A: TXT文件 (智能解析) ===
          if (file.name.endsWith(".txt") || file.type === "text/plain") {
            const text = await readFileAsText(file);
            // 使用新写的解析函数
            const parsedItems = parseStickersFromText(text);

            // 检查是否需要兜底描述（如果解析出来的 desc 都是空的）
            const needFallback = parsedItems.some((item) => !item.desc);
            if (needFallback && !fallbackDesc) {
              fallbackDesc =
                prompt(`部分图片未识别到名称，请输入默认描述：`, "表情包") ||
                "表情包";
            }

            newStickers = parsedItems.map((item) => ({
              id: Date.now() + Math.random(),
              src: item.src,
              desc: item.desc || fallbackDesc, // 优先用文件里的，没有则用兜底
              category: window.currentCategory,
            }));
          }
          // === 情况B: 图片文件 (相册上传) ===
          else if (file.type.startsWith("image/")) {
            // 图片肯定没有描述，必须问一次
            if (!fallbackDesc) {
              fallbackDesc =
                prompt(
                  `正在导入到【${window.currentCategory}】分类。\n请输入这些表情的意思：`,
                  "表情包"
                ) || "表情包";
            }
            try {
              const compressedData = await compressImage(file, 200, 0.7);
              newStickers.push({
                id: Date.now() + Math.random(),
                src: compressedData,
                desc: fallbackDesc,
                category: window.currentCategory,
              });
            } catch (e) {
              console.error(e);
            }
          }

          if (newStickers.length > 0) {
            window.customStickers.push(...newStickers);
            addedCount += newStickers.length;
          }
        }

        if (addedCount > 0) {
          await localforage.setItem("customStickers", window.customStickers);
          renderStickerGrid();
          showToast(`成功导入 ${addedCount} 个表情！`);
        } else {
          showToast("未找到有效内容");
        }

        input.value = "";
      }

      // 7. 粘贴链接导入 (升级版：支持 关键词：URL 格式)
      function importStickersFromUrl() {
        const text = prompt(
          "请粘贴内容（支持 '关键词：URL' 格式，一行一个）："
        );
        if (!text) return;

        // 1. 智能解析
        const parsedItems = parseStickersFromText(text);

        if (parsedItems.length === 0) {
          showToast("未检测到有效链接");
          return;
        }

        // 2. 检查是否有缺失描述的项
        let fallbackDesc = null;
        const needFallback = parsedItems.some((item) => !item.desc);

        if (needFallback) {
          fallbackDesc =
            prompt("部分链接没有写描述，请输入默认意思：", "表情包") ||
            "表情包";
        }

        // 3. 构建数据
        const newStickers = parsedItems.map((item) => ({
          id: Date.now() + Math.random(),
          src: item.src,
          desc: item.desc || fallbackDesc,
          category: window.currentCategory,
        }));

        window.customStickers.push(...newStickers);
        localforage.setItem("customStickers", window.customStickers);
        renderStickerGrid();
        showToast(`成功添加 ${newStickers.length} 个表情`);
      }

      // 8. 发送表情 (微信风格版)
      async function sendSticker(stickerId) {
        const sticker = window.customStickers.find((s) => s.id == stickerId);
        if (!sticker) return;

        // 检查是否在群聊中
        if (currentGroupId) {
          // 群聊发送表情包
          await sendGroupSticker(sticker);
          closeChatPanel();
          return;
        }

        // 单聊发送表情包
        // 构造 HTML：加上 class="sticker-img"
        const hiddenDesc = `<span style="display:none">[表情包：${sticker.desc}]</span>`;
        const imgHtml = `<img src="${sticker.src}" class="sticker-img" onclick="showFullImage(this.src)">`;
        const finalContent = `${hiddenDesc}${imgHtml}`;

        // 发送（等待完成）
        await sendRichMessage(finalContent, `[表情包] ${sticker.desc}`);

        // 发送后关闭面板 (可选)
        closeChatPanel();
      }

      // 群聊发送表情包
      async function sendGroupSticker(sticker) {
        if (!currentGroupId) return;

        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group) return;

        const messagesKey = `group_messages_${currentGroupId}`;
        const messages = (await localforage.getItem(messagesKey)) || [];

        // 构造表情包HTML
        const hiddenDesc = `<span style="display:none">[表情包：${sticker.desc}]</span>`;
        const imgHtml = `<img src="${sticker.src}" class="sticker-img" onclick="showFullImage(this.src)">`;
        const finalContent = `${hiddenDesc}${imgHtml}`;

        // 添加用户消息
        const userMsg = {
          role: "user",
          content: finalContent,
          isHtml: true,
          time: new Date().toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          }),
        };
        messages.push(userMsg);
        await localforage.setItem(messagesKey, messages);

        // 重新渲染
        loadGroupMessages(currentGroupId);

        // 更新群聊最后消息
        group.lastMessage = `[表情包] ${sticker.desc}`;
        group.lastTime = "刚刚";
        await localforage.setItem("groupChats", groupChats);
        renderCharacters();
      }

      // 9. 编辑/删除表情 (右键或长按)
      async function editSticker(event, stickerId) {
        event.preventDefault();
        const stickerIndex = window.customStickers.findIndex(
          (s) => s.id == stickerId
        );
        if (stickerIndex === -1) return;

        const action = prompt(
          "请输入新的描述（清空则删除该表情）：",
          window.customStickers[stickerIndex].desc
        );

        if (action === null) return; // 取消

        if (action.trim() === "") {
          // 删除
          window.customStickers.splice(stickerIndex, 1);
          showToast("表情已删除");
        } else {
          // 修改描述
          window.customStickers[stickerIndex].desc = action.trim();
          showToast("描述已更新");
        }

        await localforage.setItem("customStickers", window.customStickers);
        renderStickerGrid();
      }

      // 🆕 新增：通用的富文本发送函数 (替代 sendMediaMessage 的部分功能)
      async function sendRichMessage(htmlContent, previewText) {
        if (!currentChatCharId) {
          console.warn("sendRichMessage: currentChatCharId is null");
          return;
        }

        if (!chatHistories[currentChatCharId])
          chatHistories[currentChatCharId] = [];

        const msgObj = {
          role: "user",
          content: htmlContent, // 这里面包含了 <span style="display:none">描述</span>
          time: new Date().toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          }),
          isHtml: true,
        };

        chatHistories[currentChatCharId].push(msgObj);

        // 等待保存完成再渲染
        await localforage.setItem("chatHistories", chatHistories);

        renderConversation();
        updateCharacterLastMessage(currentChatCharId, previewText);
      }

      // 复用辅助函数
      function readFileAsText(file) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.readAsText(file);
        });
      }
      function extractUrlsFromText(text) {
        const regex = /(https?:\/\/[^\s"']+)/g;
        const matches = text.match(regex);
        return matches
          ? [...new Set(matches)].filter((u) => u.length > 10)
          : [];
      }
      /* ==================== 补回：面板切换逻辑 ==================== */
      /* ==================== 修复版：面板切换逻辑 ==================== */

      // 1. 切换面板 (加号面板 vs 表情面板)
      function toggleChatPanel(type) {
        const plusPanel = document.getElementById("plusPanel");
        const emojiPanel = document.getElementById("emojiPanel");
        const inputArea = document.getElementById("convInput");

        // 只要点了按钮，就先收起键盘
        if (inputArea) inputArea.blur();

        if (type === "plus") {
          // 如果加号面板已经开了 -> 关闭它
          if (plusPanel.classList.contains("open")) {
            closeChatPanel();
          }
          // 如果没开 -> 打开它，并关闭表情面板
          else {
            plusPanel.classList.add("open");
            emojiPanel.classList.remove("open");
            setTimeout(scrollToBottom, 300);
          }
        } else if (type === "emoji") {
          // 如果表情面板已经开了 -> 关闭它
          if (emojiPanel.classList.contains("open")) {
            closeChatPanel();
          }
          // 如果没开 -> 打开它，并关闭加号面板
          else {
            emojiPanel.classList.add("open");
            plusPanel.classList.remove("open");
            // 重新渲染分类栏（确保群聊中不显示绑定按钮）
            renderCategoryBar();
            setTimeout(scrollToBottom, 300);
          }
        }
      }

      // 2. 关闭所有面板 (点击空白处调用)
      function closeChatPanel() {
        const plusPanel = document.getElementById("plusPanel");
        const emojiPanel = document.getElementById("emojiPanel");

        let isClosed = true;

        if (plusPanel && plusPanel.classList.contains("open")) {
          plusPanel.classList.remove("open");
          isClosed = false;
        }
        if (emojiPanel && emojiPanel.classList.contains("open")) {
          emojiPanel.classList.remove("open");
          isClosed = false;
        }

        // 如果本来就是关着的，就不需要做额外操作
        if (!isClosed) {
          // 可以加一些其他的复位逻辑
        }
      }
      // 3. 辅助：滚动到底部
      function scrollToBottom() {
        const container = document.getElementById("convMessages");
        if (container) container.scrollTop = container.scrollHeight;
      }
      // 4. 发送图片功能
      async function handleChatImageUpload(input) {
        const file = input.files[0];
        if (!file) return;

        // 压缩图片
        const compressedData = await compressImage(file, 800, 0.8);

        // 发送图片消息
        sendMediaMessage(compressedData, "image");

        // 关闭面板
        closeChatPanel();
        // 清空 input 否则无法连续发同一张图
        input.value = "";
      }

      // 通用媒体消息发送函数
      function sendMediaMessage(content, type) {
        if (!chatHistories[currentChatCharId])
          chatHistories[currentChatCharId] = [];

        let msgContent = content;
        if (type === "image") {
          msgContent = `<img src="${content}" class="msg-img" onclick="showFullImage(this.src)">`;
        }

        const msgObj = {
          role: "user",
          content: msgContent,
          time: new Date().toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          }),
          // 标记这是一个富文本/HTML消息，可以特殊处理
          isHtml: true,
        };

        chatHistories[currentChatCharId].push(msgObj);
        localforage.setItem("chatHistories", chatHistories);

        renderConversation();
        updateCharacterLastMessage(
          currentChatCharId,
          type === "image" ? "[图片]" : "[消息]"
        );
      }

      // 查看大图 (简单的全屏预览)
      function showFullImage(src) {
        // 多选模式下不放大图片
        if (typeof isSelectionMode !== "undefined" && isSelectionMode) {
          return;
        }

        const overlay = document.createElement("div");
        overlay.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.9); z-index: 1000;
        display: flex; align-items: center; justify-content: center;
        animation: fadeIn 0.2s;
    `;
        overlay.onclick = () => overlay.remove();

        const img = document.createElement("img");
        img.src = src;
        img.style.cssText = `max-width: 100%; max-height: 100%; object-fit: contain;`;

        overlay.appendChild(img);
        document.body.appendChild(overlay);
      }

      // 5. 模拟功能：发红包
      function sendRedPacket() {
        const amount = (Math.random() * 200).toFixed(2);
        const html = `
        <div style="background:#fa9d3b; padding:12px 16px; border-radius:10px; display:flex; align-items:center; gap:12px; min-width:200px; cursor:pointer;" onclick="alert('领取了 ${amount} 元！')">
            <div style="background:#fce6c5; width:36px; height:36px; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:20px;">🧧</div>
            <div style="color:white; font-size:0.95rem;">
                <div>恭喜发财，大吉大利</div>
                <div style="font-size:0.7rem; opacity:0.8; margin-top:2px;">微信红包</div>
            </div>
        </div>
    `;
        sendMediaMessage(html, "redpacket");
        closeChatPanel();
      }

      // 6. 模拟功能：拍一拍
      function sendNudge() {
        closeChatPanel();
        // 拍一拍通常是系统提示，不作为一条普通消息
        const container = document.getElementById("convMessages");
        const html = `<div class="msg-system-tip">你拍了拍 "对方" 的脑袋</div>`;
        container.insertAdjacentHTML("beforeend", html);
        container.scrollTop = container.scrollHeight;

        // 如果你想让AI回应，可以伪造一条 AI 消息
        // setTimeout(() => { ... }, 1000);
      }

      // 7. 模拟功能：拍照/位置
      function handleCameraAction() {
        alert("相机功能开发中... (可使用相册发图)");
      }

      /* ==================== 图片消息功能 ==================== */
      // 打开发送图片选择弹窗
      function openSendImageModal() {
        closeChatPanel();
        document.getElementById("sendImageModal").classList.add("active");
      }

      // 关闭发送图片选择弹窗
      function closeSendImageModal() {
        document.getElementById("sendImageModal").classList.remove("active");
      }

      // 选择真实图片（支持相册、拍照、文件）
      function selectRealImage() {
        closeSendImageModal();
        document.getElementById("realImageInput").click();
      }

      // 处理选择的图片
      async function handleRealImageSelect(input) {
        if (input.files && input.files[0]) {
          const file = input.files[0];
          try {
            const compressedData = await compressImage(file, 600, 0.7);
            sendRealImage(compressedData);
          } catch (e) {
            // 压缩失败时直接读取
            const reader = new FileReader();
            reader.onload = function (e) {
              sendRealImage(e.target.result);
            };
            reader.readAsDataURL(file);
          }
          input.value = "";
        }
      }

      // 发送真实图片
      function sendRealImage(dataUrl) {
        if (!currentChatCharId) {
          showToast("请先打开一个对话");
          return;
        }

        if (!chatHistories[currentChatCharId]) {
          chatHistories[currentChatCharId] = [];
        }

        const msgObj = {
          role: "user",
          type: "image",
          imageType: "real",
          imageData: dataUrl,
          content: "[用户发送了一张图片]",
          time: new Date().toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          }),
        };

        chatHistories[currentChatCharId].push(msgObj);
        localforage.setItem("chatHistories", chatHistories);
        renderConversation();
        updateCharacterLastMessage(currentChatCharId, "[图片]");
        showToast("图片已发送");
      }

      // 打开描述图编辑弹窗
      function openDescImageModal() {
        closeSendImageModal();
        const modal = document.getElementById("imageDescModal");
        const title = document.getElementById("imageDescTitle");
        const text = document.getElementById("imageDescText");
        const input = document.getElementById("imageDescInput");
        const footer = document.getElementById("imageDescFooter");
        const preview = document.getElementById("imageDescPreview");

        title.textContent = "发送描述图";
        text.style.display = "none";
        input.style.display = "block";
        input.value = "";
        footer.style.display = "flex";
        preview.innerHTML = `
          <div class="image-desc-preview-icon">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
            <span style="font-size:0.8rem;color:#66bb6a;">描述图片内容</span>
          </div>
        `;

        modal.classList.add("active");
        modal.dataset.mode = "edit";
      }

      // 确认发送描述图
      function confirmSendDescImage() {
        const input = document.getElementById("imageDescInput");
        const desc = input.value.trim();

        if (!desc) {
          showToast("请输入图片描述");
          return;
        }

        if (!currentChatCharId) {
          showToast("请先打开一个对话");
          return;
        }

        if (!chatHistories[currentChatCharId]) {
          chatHistories[currentChatCharId] = [];
        }

        const msgObj = {
          role: "user",
          type: "image",
          imageType: "placeholder",
          imageDesc: desc,
          content: "[用户发送了一张图片: " + desc + "]",
          time: new Date().toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          }),
        };

        chatHistories[currentChatCharId].push(msgObj);
        localforage.setItem("chatHistories", chatHistories);
        renderConversation();
        updateCharacterLastMessage(currentChatCharId, "[图片]");

        closeImageDescModal();
        showToast("描述图已发送");
      }

      // 关闭图片描述弹窗
      function closeImageDescModal() {
        document.getElementById("imageDescModal").classList.remove("active");
      }

      // 查看图片描述（点击占位图时调用）
      function viewImageDescription(desc, isAi) {
        const modal = document.getElementById("imageDescModal");
        const title = document.getElementById("imageDescTitle");
        const text = document.getElementById("imageDescText");
        const input = document.getElementById("imageDescInput");
        const footer = document.getElementById("imageDescFooter");
        const preview = document.getElementById("imageDescPreview");

        title.textContent = isAi ? "AI发送的图片" : "你发送的图片";
        text.textContent = desc;
        text.style.display = "block";
        input.style.display = "none";
        footer.style.display = "none";

        const iconColor = isAi ? "#66bb6a" : "#ec407a";
        const bgGradient = isAi
          ? "linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)"
          : "linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%)";

        preview.style.background = bgGradient;
        preview.innerHTML = `
          <div class="image-desc-preview-icon">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="${iconColor}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <circle cx="8.5" cy="8.5" r="1.5"></circle>
              <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
          </div>
        `;

        modal.classList.add("active");
        modal.dataset.mode = "view";
      }

      // 查看真实图片
      function viewRealImage(imageData) {
        const modal = document.getElementById("imageViewModal");
        const img = document.getElementById("imageViewImg");
        img.src = imageData;
        modal.classList.add("active");
      }

      // 关闭图片查看弹窗
      function closeImageViewModal() {
        document.getElementById("imageViewModal").classList.remove("active");
      }

      /* ==================== 语音/视频通话功能 ==================== */
      var callState = {
        active: false,
        type: "voice", // 'voice' or 'video'
        status: "idle", // 'idle', 'calling', 'incoming', 'connected'
        charId: null,
        startTime: null,
        timerInterval: null,
        isMuted: false,
        isSpeaker: true,
        currentAudio: null,
        conversationHistory: [],
        isAiSpeaking: false,
        videoSelfExpanded: false,
      };

      // 保存通话设置
      function saveCallSettings() {
        if (!currentChatCharId) return;
        const settings = chatSettings[currentChatCharId] || {};
        settings.callVoiceEnabled =
          document.getElementById("settingsCallVoiceEnabled")?.checked || false;
        settings.aiCallEnabled =
          document.getElementById("settingsAiCallEnabled")?.checked || false;
        chatSettings[currentChatCharId] = settings;
        localforage.setItem("chatSettings", chatSettings);
      }

      // 预览通话气泡颜色
      function previewCallBubbleColor() {
        const userColor =
          document.getElementById("settingsCallUserBubbleColor")?.value ||
          "#f48fb1";
        const userOpacity =
          parseInt(
            document.getElementById("settingsCallUserBubbleOpacity")?.value
          ) || 85;
        const aiColor =
          document.getElementById("settingsCallAiBubbleColor")?.value ||
          "#ffffff";
        const aiOpacity =
          parseInt(
            document.getElementById("settingsCallAiBubbleOpacity")?.value
          ) || 85;

        // 更新标签
        const userLabel = document.getElementById("callUserOpacityLabel");
        const aiLabel = document.getElementById("callAiOpacityLabel");
        if (userLabel) userLabel.textContent = userOpacity + "%";
        if (aiLabel) aiLabel.textContent = aiOpacity + "%";

        // 应用到CSS变量
        applyCallBubbleColors(userColor, userOpacity, aiColor, aiOpacity);
      }

      // 应用通话气泡颜色
      function applyCallBubbleColors(
        userColor,
        userOpacity,
        aiColor,
        aiOpacity
      ) {
        // 转换颜色为RGBA
        const hexToRgba = (hex, opacity) => {
          const r = parseInt(hex.slice(1, 3), 16);
          const g = parseInt(hex.slice(3, 5), 16);
          const b = parseInt(hex.slice(5, 7), 16);
          return `rgba(${r}, ${g}, ${b}, ${opacity / 100})`;
        };

        const userBg = hexToRgba(userColor, userOpacity);
        const aiBg = hexToRgba(aiColor, aiOpacity);

        // 判断颜色深浅来决定文字颜色
        const isLight = (hex) => {
          const r = parseInt(hex.slice(1, 3), 16);
          const g = parseInt(hex.slice(3, 5), 16);
          const b = parseInt(hex.slice(5, 7), 16);
          return (r * 299 + g * 587 + b * 114) / 1000 > 128;
        };

        const userTextColor = isLight(userColor) ? "#333" : "white";
        const aiTextColor = isLight(aiColor) ? "#333" : "white";

        // 设置CSS变量
        document.documentElement.style.setProperty(
          "--call-user-bubble-bg",
          userBg
        );
        document.documentElement.style.setProperty(
          "--call-user-bubble-color",
          userTextColor
        );
        document.documentElement.style.setProperty("--call-ai-bubble-bg", aiBg);
        document.documentElement.style.setProperty(
          "--call-ai-bubble-color",
          aiTextColor
        );
      }

      // 页面加载时应用保存的通话气泡颜色
      function loadCallBubbleColors(charId) {
        const settings = chatSettings[charId] || {};
        const userColor = settings.callUserBubbleColor || "#f48fb1";
        const userOpacity = settings.callUserBubbleOpacity || 85;
        const aiColor = settings.callAiBubbleColor || "#ffffff";
        const aiOpacity = settings.callAiBubbleOpacity || 85;
        applyCallBubbleColors(userColor, userOpacity, aiColor, aiOpacity);
      }

      // 处理视频通话画面上传（带压缩）
      function handleVideoCallImageUpload(input, type) {
        const file = input.files[0];
        if (!file) return;

        // 如果是图片，进行轻度压缩（保持高清）
        if (file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const img = new Image();
            img.onload = function () {
              // 轻度压缩图片 - 保持高清
              const canvas = document.createElement("canvas");
              const maxSize = 1920; // 最大宽高（1080p级别）
              let width = img.width;
              let height = img.height;

              // 只有超过最大尺寸才缩放
              if (width > maxSize || height > maxSize) {
                if (width > height) {
                  height = (height * maxSize) / width;
                  width = maxSize;
                } else {
                  width = (width * maxSize) / height;
                  height = maxSize;
                }
              }

              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(img, 0, 0, width, height);

              // 高质量JPEG（0.92质量）
              const dataUrl = canvas.toDataURL("image/jpeg", 0.92);

              applyVideoCallImage(dataUrl, type);
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        } else {
          // 视频文件直接使用（不压缩）
          const reader = new FileReader();
          reader.onload = function (e) {
            applyVideoCallImage(e.target.result, type);
          };
          reader.readAsDataURL(file);
        }
      }

      // 应用视频通话图片
      function applyVideoCallImage(dataUrl, type) {
        if (type === "partner") {
          document.getElementById("videoCallPartnerImg").src = dataUrl;
          document.getElementById("videoCallPartnerImg").style.display =
            "block";
          document.getElementById("videoCallPartnerPlaceholder").style.display =
            "none";
        } else {
          document.getElementById("videoCallSelfImg").src = dataUrl;
          document.getElementById("videoCallSelfImg").style.display = "block";
          document.getElementById("videoCallSelfPlaceholder").style.display =
            "none";
        }

        // 保存到设置
        if (!currentChatCharId) return;
        const settings = chatSettings[currentChatCharId] || {};
        if (type === "partner") {
          settings.videoCallPartnerImage = dataUrl;
        } else {
          settings.videoCallSelfImage = dataUrl;
        }
        chatSettings[currentChatCharId] = settings;
        localforage
          .setItem("chatSettings", chatSettings)
          .then(() => {
            console.log("视频通话图片已保存", type);
          })
          .catch((err) => {
            console.error("保存视频通话图片失败:", err);
            showToast("图片太大，保存失败");
          });
      }

      // 清除视频画面
      function clearVideoCallImage(type) {
        if (type === "partner") {
          document.getElementById("videoCallPartnerImg").src = "";
          document.getElementById("videoCallPartnerImg").style.display = "none";
          document.getElementById("videoCallPartnerPlaceholder").style.display =
            "flex";
        } else {
          document.getElementById("videoCallSelfImg").src = "";
          document.getElementById("videoCallSelfImg").style.display = "none";
          document.getElementById("videoCallSelfPlaceholder").style.display =
            "flex";
        }

        if (!currentChatCharId) return;
        const settings = chatSettings[currentChatCharId] || {};
        if (type === "partner") {
          delete settings.videoCallPartnerImage;
        } else {
          delete settings.videoCallSelfImage;
        }
        chatSettings[currentChatCharId] = settings;
        localforage.setItem("chatSettings", chatSettings);
      }

      // 发起语音通话
      function startVoiceCall() {
        closeChatPanel();
        initiateCall("voice");
      }

      // 发起视频通话
      function startVideoCall() {
        closeChatPanel();
        initiateCall("video");
      }

      // 发起通话
      function initiateCall(type) {
        // 群聊通话 - 所有成员参与
        if (currentGroupId) {
          startGroupCall(type);
          return;
        }

        if (!currentChatCharId) {
          showToast("请先打开一个对话");
          return;
        }

        startCallWithChar(currentChatCharId, type);
      }

      // 群聊通话 - 所有成员参与
      function startGroupCall(type) {
        const group = groupChats.find((g) => g.id === currentGroupId);
        if (!group || !group.members || group.members.length === 0) {
          showToast("群里没有成员");
          return;
        }

        // 获取所有成员信息
        const memberChars = group.members
          .map((id) => characters.find((c) => c.id === id))
          .filter(Boolean);
        if (memberChars.length === 0) {
          showToast("群成员信息获取失败");
          return;
        }

        // 设置群通话状态
        callState.active = true;
        callState.type = type;
        callState.status = "calling";
        callState.isGroupCall = true;
        callState.groupId = currentGroupId;
        callState.groupMembers = group.members;
        callState.currentSpeakerIndex = 0;
        callState.charId = null; // 群聊通话不设置charId，避免记录保存到单聊
        callState.conversationHistory = [];
        callState.videoSelfExpanded = false;

        // 设置界面
        const overlay = document.getElementById("callOverlay");
        overlay.className = `call-overlay ${type}-call active group-call`;
        overlay.classList.remove("in-call");

        // 显示群名和成员数
        const groupName = group.name || "群聊";
        document.getElementById("callTopName").textContent = `${groupName} (${
          memberChars.length + 1
        }人)`;
        document.getElementById("callTopTimer").textContent = "正在呼叫...";
        document.getElementById("callName").textContent = `${groupName}`;
        document.getElementById("callStatus").textContent = `正在呼叫 ${
          memberChars.length + 1
        } 人...`;

        // 设置群头像（而不是成员头像）
        const topAvatarImg = document.getElementById("callTopAvatarImg");
        const topAvatarPlaceholder = document.getElementById(
          "callTopAvatarPlaceholder"
        );
        if (group.avatar) {
          topAvatarImg.src = group.avatar;
          topAvatarImg.style.display = "block";
          topAvatarPlaceholder.style.display = "none";
        } else {
          topAvatarImg.style.display = "none";
          topAvatarPlaceholder.textContent = "👥";
          topAvatarPlaceholder.style.display = "block";
        }

        // 旧的头像设置（兼容）- 也用群头像
        const avatarImg = document.getElementById("callAvatarImg");
        const avatarPlaceholder = document.getElementById(
          "callAvatarPlaceholder"
        );
        if (group.avatar) {
          avatarImg.src = group.avatar;
          avatarImg.style.display = "block";
          avatarPlaceholder.style.display = "none";
        } else {
          avatarImg.style.display = "none";
          avatarPlaceholder.textContent = "👥";
          avatarPlaceholder.style.display = "block";
        }

        document.getElementById("callTimer").style.display = "none";
        document.getElementById("callMessagesWrapper").innerHTML = "";
        showCallTypingIndicator(false);

        // 显示呼叫按钮，隐藏通话中按钮
        document.getElementById("callCallingBtns").style.display = "flex";
        document.getElementById("callIncomingBtns").style.display = "none";
        document.getElementById("callInCallBtns").style.display = "none";

        // 视频通话设置 - 使用群聊设置的视频通话背景
        if (type === "video") {
          const groupSettings = group.settings || {};
          const videoPartnerImg = document.getElementById("videoPartnerImage");
          const videoPartnerPlaceholder = document.getElementById(
            "videoPartnerPlaceholder"
          );
          const videoSelfImg = document.getElementById("videoSelfImage");
          const videoSelfPlaceholder = document.getElementById(
            "videoSelfPlaceholder"
          );

          // 对方画面背景
          if (groupSettings.videoCallPartnerImage && videoPartnerImg) {
            videoPartnerImg.src = groupSettings.videoCallPartnerImage;
            videoPartnerImg.style.display = "block";
            if (videoPartnerPlaceholder)
              videoPartnerPlaceholder.style.display = "none";
          } else {
            if (videoPartnerImg) videoPartnerImg.style.display = "none";
            if (videoPartnerPlaceholder) {
              videoPartnerPlaceholder.style.display = "flex";
              // 显示群头像
              videoPartnerPlaceholder.innerHTML = group.avatar
                ? `<img src="${group.avatar}" style="width:80px;height:80px;border-radius:50%;object-fit:cover;">`
                : `<span style="font-size:48px;">👥</span>`;
            }
          }

          // 我的画面背景
          if (groupSettings.videoCallSelfImage && videoSelfImg) {
            videoSelfImg.src = groupSettings.videoCallSelfImage;
            videoSelfImg.style.display = "block";
            if (videoSelfPlaceholder)
              videoSelfPlaceholder.style.display = "none";
          } else {
            if (videoSelfImg) videoSelfImg.style.display = "none";
            if (videoSelfPlaceholder)
              videoSelfPlaceholder.style.display = "flex";
          }

          // 视频通话计时器
          const videoCallTimer = document.getElementById("videoCallTimer");
          if (videoCallTimer) videoCallTimer.textContent = "正在呼叫...";

          // 视频通话主名字
          const videoMainName = document.getElementById("videoMainName");
          if (videoMainName) videoMainName.textContent = groupName;
        }

        // 模拟接听（2-3秒后）
        setTimeout(() => {
          if (callState.active && callState.status === "calling") {
            answerGroupCall();
          }
        }, 2000 + Math.random() * 1000);
      }

      // 群聊接听
      function answerGroupCall() {
        callState.status = "connected";
        callState.startTime = Date.now();

        const overlay = document.getElementById("callOverlay");
        overlay.classList.add("in-call");

        document.getElementById("callTopTimer").textContent = "00:00";

        // 更新状态显示
        const group = groupChats.find((g) => g.id === callState.groupId);
        // 人数 = AI角色数量 + 用户自己
        const memberCount = group ? group.members.length + 1 : 1;

        if (callState.type === "video") {
          const videoCallTimer = document.getElementById("videoCallTimer");
          if (videoCallTimer) videoCallTimer.textContent = "00:00";
          document.getElementById(
            "callStatus"
          ).textContent = `${memberCount}人视频通话中`;
        } else {
          document.getElementById(
            "callStatus"
          ).textContent = `${memberCount}人语音通话中`;
          document.getElementById("callTimer").style.display = "block";
          document.getElementById("callTimer").textContent = "00:00";
        }

        // 切换按钮显示
        document.getElementById("callCallingBtns").style.display = "none";
        document.getElementById("callInCallBtns").style.display = "flex";

        startCallTimer();

        // 群聊第一条消息 - 所有成员打招呼，结合群聊历史
        if (group && group.members.length > 0) {
          setTimeout(async () => {
            if (callState.active) {
              await requestGroupCallAIResponse(
                "通话刚接通，请根据之前群里聊的内容自然地打招呼或继续话题"
              );
            }
          }, 800);
        }
      }

      // 群聊通话AI回复（所有成员轮流发言）
      async function requestGroupCallAIResponse(userMessage) {
        if (!callState.active || !callState.isGroupCall) {
          console.log("群聊通话：状态检查失败", callState);
          return;
        }

        const group = groupChats.find((g) => g.id === callState.groupId);
        if (!group || !group.members || group.members.length === 0) {
          console.log("群聊通话：找不到群组或成员", callState.groupId);
          return;
        }

        console.log("群聊通话：开始请求AI回复，成员数:", group.members.length);

        // 所有成员都会回复
        for (let i = 0; i < group.members.length; i++) {
          if (!callState.active) break; // 如果通话已结束则停止

          const charId = group.members[i];
          const char = characters.find((c) => c.id === charId);
          if (!char) {
            console.log("群聊通话：找不到角色", charId);
            continue;
          }

          console.log("群聊通话：请求角色回复", char.name);

          // 更新当前说话者头像
          updateGroupCallSpeaker(char);

          showCallTypingIndicator(true);

          // 请求AI回复
          let response = null;
          try {
            response = await getGroupCallAIMessage(charId, userMessage, i);
          } catch (e) {
            console.error("群聊通话：getGroupCallAIMessage异常", e);
          }

          showCallTypingIndicator(false);

          if (response && callState.active) {
            // 显示带角色名的消息
            addGroupCallMessage(response, charId);
            console.log(
              "群聊通话：成功添加消息",
              char.name,
              response.substring(0, 50)
            );

            // 间隔一下再让下一个人说话
            if (i < group.members.length - 1) {
              await new Promise((resolve) =>
                setTimeout(resolve, 600 + Math.random() * 400)
              );
            }
          } else {
            console.log("群聊通话：AI回复为空或通话已结束", {
              response,
              active: callState.active,
            });
          }
        }
      }

      // 更新群聊通话中当前说话者
      function updateGroupCallSpeaker(char) {
        const topAvatarImg = document.getElementById("callTopAvatarImg");
        const topAvatarPlaceholder = document.getElementById(
          "callTopAvatarPlaceholder"
        );

        if (char.avatar) {
          topAvatarImg.src = char.avatar;
          topAvatarImg.style.display = "block";
          topAvatarPlaceholder.style.display = "none";
        } else {
          topAvatarImg.style.display = "none";
          topAvatarPlaceholder.textContent = char.name.charAt(0);
          topAvatarPlaceholder.style.display = "block";
        }

        // 视频通话也更新头像
        if (callState.type === "video") {
          const videoPartnerPlaceholder = document.getElementById(
            "videoPartnerPlaceholder"
          );
          if (videoPartnerPlaceholder) {
            videoPartnerPlaceholder.innerHTML = char.avatar
              ? `<img src="${char.avatar}" style="width:100%;height:100%;object-fit:cover;">`
              : `<span style="font-size:48px;">${char.name.charAt(0)}</span>`;
          }
        }
      }

      // 获取群聊通话AI消息
      async function getGroupCallAIMessage(charId, context, speakerIndex) {
        const char = characters.find((c) => c.id === charId);
        if (!char) {
          console.error("群聊通话：找不到角色", charId);
          return null;
        }

        // 使用和单聊通话一样的API配置获取方式
        const apiConfig = getActiveApiConfig();
        if (!apiConfig || !apiConfig.url || !apiConfig.key) {
          console.error("群聊通话：API配置缺失");
          return `你好呀～`;
        }

        const charName = char.note || char.name;
        const settings = chatSettings[charId] || {};
        // 完整读取人设
        const persona =
          settings.persona || char.prompt || char.description || "";

        // 获取群聊设置
        const group = groupChats.find((g) => g.id === callState.groupId);
        const groupSettings = group?.settings || {};
        const userNickname =
          groupSettings.myNickname ||
          localStorage.getItem("userName") ||
          "用户";
        const userPersona = groupSettings.myPersona || "";
        // 使用群聊设置中的历史消息条数
        const contextCount = groupSettings.contextCount || 20;

        // 获取群聊历史消息
        let groupChatHistory = "";
        try {
          const messagesKey = `group_messages_${callState.groupId}`;
          const groupMessages = (await localforage.getItem(messagesKey)) || [];

          // 按群聊设置的条数获取历史消息，过滤隐藏消息和通话卡片
          const recentGroupMessages = groupMessages
            .filter((m) => !m.isHidden && !m.isCallCard && !m.isHtml)
            .slice(-contextCount);

          if (recentGroupMessages.length > 0) {
            groupChatHistory = recentGroupMessages
              .map((m) => {
                const content = (m.content || "").replace(/<[^>]*>/g, "");
                if (m.role === "user") {
                  return `[${userNickname}]: ${content}`;
                } else {
                  const msgChar = characters.find((c) => c.id === m.charId);
                  const msgCharName = msgChar
                    ? msgChar.note || msgChar.name
                    : "成员";
                  return `[${msgCharName}]: ${content}`;
                }
              })
              .join("\n");
          }
        } catch (e) {
          console.error("群聊通话：读取群聊历史失败", e);
        }

        // 获取当前通话中的对话记录
        let callHistoryText = "";
        const recentCallHistory = callState.conversationHistory.slice(-10);
        if (recentCallHistory.length > 0) {
          callHistoryText = recentCallHistory
            .map((h) => {
              if (h.role === "user") return `[${userNickname}]: ${h.content}`;
              const speakerChar = characters.find((c) => c.id === h.charId);
              const speakerName = speakerChar
                ? speakerChar.note || speakerChar.name
                : "成员";
              return `[${speakerName}]: ${h.content}`;
            })
            .join("\n");
        }

        // 获取群里其他成员信息
        let otherMembersInfo = "";
        if (group && group.members) {
          const otherMembers = group.members
            .filter((id) => id !== charId)
            .map((id) => {
              const c = characters.find((ch) => ch.id === id);
              if (!c) return null;
              const s = chatSettings[id] || {};
              const name = c.note || c.name;
              const p = s.persona || c.prompt || c.description || "";
              return `- ${name}: ${p.substring(0, 100)}${
                p.length > 100 ? "..." : ""
              }`;
            })
            .filter(Boolean);
          if (otherMembers.length > 0) {
            otherMembersInfo = otherMembers.join("\n");
          }
        }

        const currentTime = new Date().toLocaleString("zh-CN");

        // 根据通话类型设置不同的格式要求
        let formatRequirement = "";
        if (callState.type === "video") {
          formatRequirement = `# 视频通话格式要求
这是视频通话，你们可以看到彼此。
用【】描述你的动作、表情、神态，穿插在对话中，让对话更生动。
示例：【看着屏幕笑了笑】你好呀～【歪头看着你】怎么突然想起给我打视频了？
示例：【揉了揉眼睛】嗯...刚睡醒【打了个哈欠】你找我有事吗？`;
        } else {
          formatRequirement = `# 语音通话格式要求
这是语音通话，只能听到声音，看不到对方。
直接用对话回复，不要描写动作，不要用【】或括号。
像真人打电话一样自然地说话。`;
        }

        // 完整的系统提示词
        const systemPrompt = `# 你的身份
你是【${charName}】，正在参与一个群聊${
          callState.type === "video" ? "视频" : "语音"
        }通话。

# 你的完整人设
${persona || "（暂无人设，请自由发挥）"}

# 用户信息
- 用户昵称：${userNickname}
- 用户人设：${userPersona || "普通用户"}

# 群里其他成员
${otherMembersInfo || "暂无其他成员信息"}

# 最近的群聊记录
${groupChatHistory || "（暂无聊天记录）"}

# 当前通话内容
${callHistoryText || "（通话刚刚开始）"}

# 当前时间
${currentTime}

${formatRequirement}

# 回复要求
1. 你必须完全按照【${charName}】的人设性格来说话，保持角色一致性
2. 参考之前的群聊记录，了解大家在聊什么，可以提及之前聊过的内容
3. 用简短口语化方式回应，像真人打电话一样自然，每次回复1-3句话
4. ${
          speakerIndex === 0
            ? "你是第一个说话的人，可以先打个招呼或者接着之前群里的话题继续聊"
            : "前面已经有人说过了，请自然地接话、回应或补充"
        }
5. 保持${charName}特有的语气、口癖和说话习惯
6. 只输出${charName}说的话，不要输出其他角色的对白`;

        console.log(
          "群聊通话：发送API请求",
          charName,
          "提示词长度:",
          systemPrompt.length
        );

        try {
          const response = await fetch(`${apiConfig.url}/chat/completions`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${apiConfig.key}`,
            },
            body: JSON.stringify({
              model: apiConfig.model || "gpt-3.5-turbo",
              messages: [
                { role: "system", content: systemPrompt },
                { role: "user", content: context || "请自然地说话" },
              ],
              temperature:
                apiConfig.temperature !== undefined
                  ? Number(apiConfig.temperature)
                  : 0.8,
            }),
          });

          if (!response.ok) {
            const errText = await response.text();
            console.error("群聊通话：API响应错误", response.status, errText);
            return `嗯嗯～`;
          }

          const data = await response.json();
          console.log("群聊通话：API返回", data);

          // 尝试多种方式提取回复
          let reply = null;
          if (data.choices && data.choices[0]) {
            const choice = data.choices[0];
            if (choice.message && choice.message.content) {
              reply = choice.message.content;
            } else if (choice.text) {
              reply = choice.text;
            }
            // 检查是否被截断
            if (choice.finish_reason === "length") {
              console.warn("群聊通话：回复被截断");
            }
          }

          if (!reply || !reply.trim()) {
            console.error("群聊通话：AI返回空", data);
            return `好的～`;
          }

          // 清理回复中可能的格式问题
          reply = reply.trim();
          // 移除可能的引号包裹
          if (
            (reply.startsWith('"') && reply.endsWith('"')) ||
            (reply.startsWith("'") && reply.endsWith("'"))
          ) {
            reply = reply.slice(1, -1);
          }

          console.log("群聊通话：最终回复", reply);
          return reply;
        } catch (e) {
          console.error("群聊通话：API请求异常", e);
          return `嗯嗯～`;
        }
      }

      // 添加群聊通话消息（带角色名）
      function addGroupCallMessage(content, charId) {
        const char = characters.find((c) => c.id === charId);
        const charName = char ? char.note || char.name : "成员";
        const charAvatar = char?.avatar;

        const wrapper = document.getElementById("callMessagesWrapper");
        const msgDiv = document.createElement("div");
        msgDiv.className = "call-message ai group-call-msg";
        msgDiv.innerHTML = `
          <div class="group-call-msg-header">
            <div class="group-call-msg-avatar">
              ${charAvatar ? `<img src="${charAvatar}">` : charName.charAt(0)}
            </div>
            <span class="group-call-msg-name">${charName}</span>
          </div>
          <div class="call-message-content">${escapeHtml(content)}</div>
        `;
        wrapper.appendChild(msgDiv);
        wrapper.scrollTop = wrapper.scrollHeight;

        // 记录到历史
        callState.conversationHistory.push({
          role: "assistant",
          charId: charId,
          content: content,
        });
      }

      // 实际发起通话的函数（单聊）
      function startCallWithChar(charId, type) {
        const char = characters.find((c) => c.id === charId);
        if (!char) return;

        const settings = chatSettings[charId] || {};

        // 调试：检查视频通话图片
        console.log("发起通话，检查设置:", {
          type,
          hasPartnerImage: !!settings.videoCallPartnerImage,
          hasSelfImage: !!settings.videoCallSelfImage,
          partnerImageLength: settings.videoCallPartnerImage?.length,
          selfImageLength: settings.videoCallSelfImage?.length,
        });

        // 加载通话气泡颜色
        loadCallBubbleColors(charId);

        callState.active = true;
        callState.type = type;
        callState.status = "calling";
        callState.charId = charId;
        callState.isGroupCall = false;
        callState.groupId = null;
        callState.conversationHistory = [];
        callState.videoSelfExpanded = false;

        // 设置界面
        const overlay = document.getElementById("callOverlay");
        overlay.className = `call-overlay ${type}-call active`;
        overlay.classList.remove("in-call");

        const charName = settings.charNote || char.note || char.name;

        // 设置新的顶部栏
        const topAvatarImg = document.getElementById("callTopAvatarImg");
        const topAvatarPlaceholder = document.getElementById(
          "callTopAvatarPlaceholder"
        );
        if (char.avatar) {
          topAvatarImg.src = char.avatar;
          topAvatarImg.style.display = "block";
          topAvatarPlaceholder.style.display = "none";
        } else {
          topAvatarImg.style.display = "none";
          topAvatarPlaceholder.style.display = "block";
        }
        document.getElementById("callTopName").textContent = charName;
        document.getElementById("callTopTimer").textContent = "正在呼叫...";

        // 旧的头像设置（兼容）
        const avatarImg = document.getElementById("callAvatarImg");
        const avatarPlaceholder = document.getElementById(
          "callAvatarPlaceholder"
        );
        if (char.avatar) {
          avatarImg.src = char.avatar;
          avatarImg.style.display = "block";
          avatarPlaceholder.style.display = "none";
        } else {
          avatarImg.style.display = "none";
          avatarPlaceholder.style.display = "block";
        }

        document.getElementById("callName").textContent = charName;
        document.getElementById("callStatus").textContent = "正在呼叫...";
        document.getElementById("callTimer").style.display = "none";
        // 清空消息但保留结构
        document.getElementById("callMessagesWrapper").innerHTML = "";
        showCallTypingIndicator(false);

        // 视频通话设置
        if (type === "video") {
          document.getElementById("videoCallName").textContent = charName;
          document.getElementById("videoCallTimer").textContent = "连接中...";

          // 设置对方画面
          const videoMainImg = document.getElementById("videoMainImg");
          const videoMainPlaceholder = document.getElementById(
            "videoMainPlaceholder"
          );
          if (settings.videoCallPartnerImage) {
            videoMainImg.src = settings.videoCallPartnerImage;
            videoMainImg.style.display = "block";
            videoMainPlaceholder.style.display = "none";
          } else {
            videoMainImg.style.display = "none";
            videoMainPlaceholder.style.display = "flex";
            // 设置占位头像
            const mainAvatarImg = document.getElementById("videoMainAvatarImg");
            const mainAvatarPlaceholder = document.getElementById(
              "videoMainAvatarPlaceholder"
            );
            if (char.avatar) {
              mainAvatarImg.src = char.avatar;
              mainAvatarImg.style.display = "block";
              mainAvatarPlaceholder.style.display = "none";
            } else {
              mainAvatarImg.style.display = "none";
              mainAvatarPlaceholder.style.display = "block";
            }
            document.getElementById("videoMainName").textContent = charName;
          }

          // 设置自己画面
          const videoSelfImg = document.getElementById("videoSelfImg");
          const videoSelfPlaceholder = document.getElementById(
            "videoSelfPlaceholder"
          );
          if (settings.videoCallSelfImage) {
            videoSelfImg.src = settings.videoCallSelfImage;
            videoSelfImg.style.display = "block";
            videoSelfPlaceholder.style.display = "none";
          } else {
            videoSelfImg.style.display = "none";
            videoSelfPlaceholder.style.display = "flex";
          }
          document.getElementById("videoSelf").classList.remove("expanded");
        }

        // 显示呼叫按钮
        document.getElementById("callCallingBtns").style.display = "flex";
        document.getElementById("callIncomingBtns").style.display = "none";
        document.getElementById("callInCallBtns").style.display = "none";

        // 模拟AI接听（2-4秒后）
        setTimeout(() => {
          if (callState.status === "calling") {
            aiAnswerCall();
          }
        }, 2000 + Math.random() * 2000);
      }

      // 切换视频画面位置（互换大小窗口）
      function toggleVideoSelf() {
        const overlay = document.getElementById("callOverlay");
        callState.videoSelfExpanded = !callState.videoSelfExpanded;
        overlay.classList.toggle("swapped", callState.videoSelfExpanded);
      }

      // AI接听通话
      async function aiAnswerCall() {
        const settings = chatSettings[callState.charId] || {};
        const char = characters.find((c) => c.id === callState.charId);

        // 简单模拟：大部分情况接听，小概率拒绝
        const willAnswer = Math.random() > 0.15;

        if (willAnswer) {
          callState.status = "connected";
          callState.startTime = Date.now();

          const overlay = document.getElementById("callOverlay");
          overlay.classList.add("in-call");

          // 更新顶部栏状态
          document.getElementById("callTopTimer").textContent = "00:00";

          if (callState.type === "video") {
            document.getElementById("videoCallTimer").textContent = "00:00";
          } else {
            document.getElementById("callStatus").textContent = "语音通话中";
            document.getElementById("callTimer").style.display = "block";
          }

          // 显示通话中按钮
          document.getElementById("callCallingBtns").style.display = "none";
          document.getElementById("callInCallBtns").style.display = "flex";

          // 开始计时
          startCallTimer();

          // AI开场白
          await generateCallResponse("通话刚接通，请自然地打招呼");
        } else {
          // AI拒绝接听
          document.getElementById("callStatus").textContent = "对方已拒绝";
          document.getElementById("callTopTimer").textContent = "对方已拒绝";
          if (callState.type === "video") {
            document.getElementById("videoMainName").textContent = "对方已拒绝";
          }
          setTimeout(() => {
            endCall();
            addCallRecord("refused");
          }, 1500);
        }
      }

      // 用户接听来电
      function acceptCall() {
        if (callState.status !== "incoming") return;

        callState.status = "connected";
        callState.startTime = Date.now();

        const overlay = document.getElementById("callOverlay");
        overlay.classList.add("in-call");

        if (callState.type === "video") {
          document.getElementById("videoCallTimer").textContent = "00:00";
        } else {
          document.getElementById("callStatus").textContent = "语音通话中";
          document.getElementById("callTimer").style.display = "block";
        }

        // 显示通话中按钮
        document.getElementById("callIncomingBtns").style.display = "none";
        document.getElementById("callInCallBtns").style.display = "flex";

        // 开始计时
        startCallTimer();
      }

      // 用户拒绝来电
      function declineCall() {
        document.getElementById("callStatus").textContent = "已拒绝";
        setTimeout(() => {
          endCall();
          addCallRecord("declined");
        }, 500);
      }

      // 结束通话
      function endCall() {
        // 保存通话信息用于后续AI回复
        const savedCharId = callState.charId;
        const hadConversation = callState.conversationHistory.length > 0;
        const wasConnected =
          callState.status === "connected" && callState.startTime;
        const wasGroupCall = callState.isGroupCall;
        const savedGroupId = callState.groupId;
        const savedConversationHistory = [...callState.conversationHistory];
        const savedCallType = callState.type;
        const savedStartTime = callState.startTime;

        if (callState.timerInterval) {
          clearInterval(callState.timerInterval);
          callState.timerInterval = null;
        }

        // 停止当前播放的音频
        if (callState.currentAudio) {
          callState.currentAudio.pause();
          callState.currentAudio = null;
        }

        // 如果是正常通话结束，添加通话记录
        if (wasConnected) {
          if (wasGroupCall) {
            addGroupCallRecord(
              "completed",
              savedGroupId,
              savedConversationHistory,
              savedCallType,
              savedStartTime
            );
          } else {
            addCallRecord("completed");
          }
        }

        // 隐藏悬浮球
        document
          .getElementById("callFloatingBubble")
          .classList.remove("active");

        // 重置状态
        callState.active = false;
        callState.status = "idle";
        callState.startTime = null;
        callState.conversationHistory = [];
        callState.videoSelfExpanded = false;
        callState.isGroupCall = false;
        callState.groupId = null;

        // 隐藏界面 - 移除所有相关类并强制隐藏
        const overlay = document.getElementById("callOverlay");
        overlay.classList.remove(
          "active",
          "in-call",
          "video-call",
          "voice-call",
          "swapped",
          "group-call"
        );
        overlay.style.display = "none";

        // 恢复默认类
        setTimeout(() => {
          overlay.style.display = "";
          overlay.className = "call-overlay voice-call";
        }, 100);

        // 【核心新增】挂断后自动触发AI回复
        if (wasConnected && hadConversation) {
          // 延迟一点再触发，确保界面已经切换回聊天
          setTimeout(() => {
            if (wasGroupCall && savedGroupId) {
              triggerGroupPostCallAiResponse(
                savedGroupId,
                savedConversationHistory,
                savedCallType
              );
            } else if (savedCharId) {
              triggerPostCallAiResponse(savedCharId);
            }
          }, 500);
        }
      }

      // 添加群聊通话记录（只显示挂断卡片，通话内容隐藏供AI参考）
      async function addGroupCallRecord(
        result,
        groupId,
        conversationHistory,
        callType,
        startTime
      ) {
        if (!groupId) return;

        const group = groupChats.find((g) => g.id === groupId);
        if (!group) return;

        const duration = startTime
          ? Math.floor((Date.now() - startTime) / 1000)
          : 0;
        const mins = Math.floor(duration / 60)
          .toString()
          .padStart(2, "0");
        const secs = (duration % 60).toString().padStart(2, "0");

        let statusText = "";
        let icon = callType === "video" ? "▶" : "☎";

        switch (result) {
          case "completed":
            statusText = `通话时长 ${mins}:${secs}`;
            break;
          case "refused":
            statusText = "对方已拒绝";
            break;
          case "declined":
            statusText = "已拒绝";
            break;
          case "missed":
            statusText = "未接来电";
            break;
          default:
            statusText = "通话结束";
        }

        // 人数 = AI角色数量 + 用户自己
        const memberCount = (group.members ? group.members.length : 0) + 1;

        // 挂断卡片HTML - 居中显示
        const callHtml = `
          <div style="background:white; padding:10px 14px; border-radius:10px; display:inline-flex; align-items:center; gap:10px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
            <div style="background:#f5f5f5; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:${
              callType === "video" ? "#4caf50" : "#ff9800"
            };">${icon}</div>
            <div>
              <div style="font-size:0.9rem;">${
                callType === "video" ? "视频通话" : "语音通话"
              } (${memberCount}人)</div>
              <div style="font-size:0.7rem; color:#999;">${statusText}</div>
            </div>
          </div>
        `;

        // 获取群聊消息
        const messagesKey = `group_messages_${groupId}`;
        let messages = (await localforage.getItem(messagesKey)) || [];

        // 添加可见的挂断卡片（作为用户消息显示在右侧）
        messages.push({
          role: "user",
          content: callHtml,
          isHtml: true,
          isCallCard: true,
          time: new Date().toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          }),
        });

        // 如果有通话内容，添加隐藏的通话记录供AI参考（用户看不到）
        if (
          result === "completed" &&
          conversationHistory &&
          conversationHistory.length > 0
        ) {
          const groupSettings = group.settings || {};
          const userNickname =
            groupSettings.myNickname ||
            localStorage.getItem("userName") ||
            "用户";

          // 格式化通话记录
          const callTranscript = conversationHistory
            .map((msg) => {
              if (msg.role === "user") {
                const content = msg.content.replace(/【[^】]*】/g, "").trim();
                return `${userNickname}: ${content}`;
              } else {
                const char = characters.find((c) => c.id === msg.charId);
                const charName = char ? char.note || char.name : "成员";
                const content = msg.content.replace(/【[^】]*】/g, "").trim();
                return `${charName}: ${content}`;
              }
            })
            .join("\n");

          // 添加隐藏的系统消息，AI能看到但用户看不到
          messages.push({
            role: "system",
            content: `[群聊通话记录 - ${
              callType === "video" ? "视频" : "语音"
            }通话，时长${mins}:${secs}，${memberCount}人参与]\n${callTranscript}\n[通话结束]`,
            isHidden: true,
            time: new Date().toLocaleTimeString("zh-CN", {
              hour: "2-digit",
              minute: "2-digit",
            }),
          });
        }

        // 保存消息
        await localforage.setItem(messagesKey, messages);

        // 更新群聊列表预览
        const previewText = callType === "video" ? "[视频通话]" : "[语音通话]";
        group.lastMessage = previewText;
        group.lastTime = new Date().toLocaleTimeString("zh-CN", {
          hour: "2-digit",
          minute: "2-digit",
        });
        await localforage.setItem("groupChats", groupChats);

        // 刷新界面
        if (currentGroupId === groupId) {
          loadGroupMessages(groupId);
        }
        renderCharacters();
      }

      // 群聊通话结束后触发AI回复
      async function triggerGroupPostCallAiResponse(
        groupId,
        conversationHistory,
        callType
      ) {
        if (!groupId) return;

        const group = groupChats.find((g) => g.id === groupId);
        if (!group || !group.members || group.members.length === 0) return;

        // 确保当前在群聊界面
        if (currentGroupId !== groupId) {
          console.log("群聊通话结束后AI回复: 当前不在该群聊界面");
          return;
        }

        // 直接触发群聊AI回复，让AI根据隐藏的通话记录续写
        await requestGroupAIReply(
          "(通话刚刚结束，请根据通话内容自然地继续对话)"
        );
      }

      // 挂断后触发AI回复
      async function triggerPostCallAiResponse(charId) {
        if (!charId) return;

        const char = characters.find((c) => c.id === charId);
        if (!char) return;

        const settings = chatSettings[charId] || {};
        const apiConfig = getActiveApiConfig();
        if (!apiConfig || !apiConfig.url || !apiConfig.key) {
          console.log("通话结束后AI回复: API未配置");
          return;
        }

        // 确保当前在这个聊天界面
        if (currentChatCharId !== charId) {
          console.log("通话结束后AI回复: 当前不在该聊天界面");
          return;
        }

        // 直接调用AI回复
        requestAIReply();
      }

      // 最小化通话（显示悬浮球）
      function minimizeCall() {
        if (!callState.active || callState.status !== "connected") return;

        const char = characters.find((c) => c.id === callState.charId);
        const bubble = document.getElementById("callFloatingBubble");
        const bubbleImg = document.getElementById("floatingBubbleImg");
        const bubbleAvatar = document.getElementById("floatingBubbleAvatar");

        // 设置悬浮球头像
        if (char && char.avatar) {
          bubbleImg.src = char.avatar;
          bubbleImg.style.display = "block";
          bubbleAvatar.style.display = "none";
        } else {
          bubbleImg.style.display = "none";
          bubbleAvatar.style.display = "block";
          bubbleAvatar.textContent = callState.type === "video" ? "▶" : "☎";
        }

        // 显示悬浮球
        bubble.classList.add("active");

        // 隐藏通话界面
        const overlay = document.getElementById("callOverlay");
        overlay.classList.remove("active");
      }

      // 恢复通话（从悬浮球点击）
      function restoreCall() {
        if (!callState.active) return;

        // 隐藏悬浮球
        document
          .getElementById("callFloatingBubble")
          .classList.remove("active");

        // 显示通话界面
        const overlay = document.getElementById("callOverlay");
        overlay.classList.add("active");
      }

      // 初始化悬浮球拖拽
      function initCallBubbleDrag() {
        const bubble = document.getElementById("callFloatingBubble");
        let isDragging = false;
        let startX, startY, initialLeft, initialTop;
        let hasMoved = false;

        const onStart = (e) => {
          isDragging = true;
          hasMoved = false;

          const clientX = e.type.includes("mouse")
            ? e.clientX
            : e.touches[0].clientX;
          const clientY = e.type.includes("mouse")
            ? e.clientY
            : e.touches[0].clientY;

          startX = clientX;
          startY = clientY;

          const rect = bubble.getBoundingClientRect();
          initialLeft = rect.left;
          initialTop = rect.top;
        };

        const onMove = (e) => {
          if (!isDragging) return;
          e.preventDefault();

          const clientX = e.type.includes("mouse")
            ? e.clientX
            : e.touches[0].clientX;
          const clientY = e.type.includes("mouse")
            ? e.clientY
            : e.touches[0].clientY;

          const deltaX = clientX - startX;
          const deltaY = clientY - startY;

          if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
            hasMoved = true;
          }

          let newLeft = initialLeft + deltaX;
          let newTop = initialTop + deltaY;

          // 边界限制
          const maxLeft = window.innerWidth - bubble.offsetWidth;
          const maxTop = window.innerHeight - bubble.offsetHeight;

          newLeft = Math.max(0, Math.min(newLeft, maxLeft));
          newTop = Math.max(0, Math.min(newTop, maxTop));

          bubble.style.left = `${newLeft}px`;
          bubble.style.top = `${newTop}px`;
          bubble.style.right = "auto";
        };

        const onEnd = () => {
          if (!isDragging) return;
          isDragging = false;

          // 如果没有移动，视为点击，恢复通话
          if (!hasMoved) {
            restoreCall();
          }
        };

        bubble.addEventListener("mousedown", onStart);
        document.addEventListener("mousemove", onMove);
        document.addEventListener("mouseup", onEnd);

        bubble.addEventListener("touchstart", onStart, { passive: false });
        document.addEventListener("touchmove", onMove, { passive: false });
        document.addEventListener("touchend", onEnd);
      }

      // 页面加载时初始化悬浮球拖拽
      document.addEventListener("DOMContentLoaded", initCallBubbleDrag);

      // 开始通话计时
      function startCallTimer() {
        const voiceTimer = document.getElementById("callTimer");
        const videoTimer = document.getElementById("videoCallTimer");
        const topTimer = document.getElementById("callTopTimer");

        callState.timerInterval = setInterval(() => {
          if (!callState.startTime) return;
          const elapsed = Math.floor((Date.now() - callState.startTime) / 1000);
          const mins = Math.floor(elapsed / 60)
            .toString()
            .padStart(2, "0");
          const secs = (elapsed % 60).toString().padStart(2, "0");
          const timeStr = `${mins}:${secs}`;

          // 更新顶部栏时间
          topTimer.textContent = timeStr;

          if (callState.type === "video") {
            videoTimer.textContent = timeStr;
          } else {
            voiceTimer.textContent = timeStr;
          }
        }, 1000);
      }

      // 添加通话记录到聊天
      function addCallRecord(result) {
        if (!callState.charId) return;

        const duration = callState.startTime
          ? Math.floor((Date.now() - callState.startTime) / 1000)
          : 0;
        const mins = Math.floor(duration / 60)
          .toString()
          .padStart(2, "0");
        const secs = (duration % 60).toString().padStart(2, "0");

        let statusText = "";
        let icon = callState.type === "video" ? "▶" : "☎";

        switch (result) {
          case "completed":
            statusText = `通话时长 ${mins}:${secs}`;
            break;
          case "refused":
            statusText = "对方已拒绝";
            break;
          case "declined":
            statusText = "已拒绝";
            break;
          case "missed":
            statusText = "未接来电";
            break;
          default:
            statusText = "通话结束";
        }

        const callHtml = `
          <div style="background:white; padding:10px 14px; border-radius:10px; display:flex; align-items:center; gap:10px; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
            <div style="background:#f5f5f5; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; color:${
              callState.type === "video" ? "#4caf50" : "#ff9800"
            };">${icon}</div>
            <div>
              <div style="font-size:0.9rem;">${
                callState.type === "video" ? "视频通话" : "语音通话"
              }</div>
              <div style="font-size:0.7rem; color:#999;">${statusText}</div>
            </div>
          </div>
        `;

        if (!chatHistories[callState.charId]) {
          chatHistories[callState.charId] = [];
        }

        // 添加可见的通话卡片
        chatHistories[callState.charId].push({
          role: "user",
          content: callHtml,
          isHtml: true,
          time: new Date().toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          }),
        });

        // 如果有通话内容，添加隐藏的通话记录供AI参考
        if (
          result === "completed" &&
          callState.conversationHistory.length > 0
        ) {
          const settings = chatSettings[callState.charId] || {};
          const userNickname = settings.userNickname || "用户";
          const charName = settings.charName || "对方";

          // 格式化通话记录
          const callTranscript = callState.conversationHistory
            .map((msg) => {
              const speaker = msg.role === "user" ? userNickname : charName;
              // 移除【】中的动作描写，只保留对话内容用于记录
              const content = msg.content.replace(/【[^】]*】/g, "").trim();
              return `${speaker}: ${content}`;
            })
            .join("\n");

          // 添加隐藏的系统消息，AI能看到但用户看不到
          chatHistories[callState.charId].push({
            role: "system",
            content: `[通话记录 - ${
              callState.type === "video" ? "视频" : "语音"
            }通话，时长${mins}:${secs}]\n${callTranscript}\n[通话结束]`,
            isHidden: true,
            time: new Date().toLocaleTimeString("zh-CN", {
              hour: "2-digit",
              minute: "2-digit",
            }),
          });
        }

        // 更新聊天列表预览
        const previewText =
          callState.type === "video" ? "[视频通话]" : "[语音通话]";
        if (typeof updateCharacterLastMessage === "function") {
          updateCharacterLastMessage(callState.charId, previewText);
        }

        // 保存聊天记录并强制刷新界面
        const savedCharId = callState.charId;
        localforage.setItem("chatHistories", chatHistories).then(() => {
          // 等待 localforage 保存完成后再刷新界面
          requestAnimationFrame(() => {
            // 使用 == 而非 === 以避免类型不匹配的问题
            if (currentChatCharId && currentChatCharId == savedCharId) {
              renderConversation();
            }
            // 同时刷新聊天列表
            if (typeof renderCharacterList === "function") {
              renderCharacterList();
            }
          });
        });
      }

      // 切换静音
      function toggleMute() {
        callState.isMuted = !callState.isMuted;
        const btn = document.getElementById("muteBtn");
        btn.classList.toggle("active", callState.isMuted);
        btn.textContent = callState.isMuted ? "○" : "♪";
      }

      // 切换扬声器
      function toggleSpeaker() {
        callState.isSpeaker = !callState.isSpeaker;
        const btn = document.getElementById("speakerBtn");
        btn.classList.toggle("active", callState.isSpeaker);
        btn.textContent = callState.isSpeaker ? "◉" : "○";
      }

      // 用户发送通话消息
      function sendCallMessage() {
        const input = document.getElementById("callInput");
        const text = input.value.trim();
        if (!text || callState.status !== "connected") return;

        input.value = "";

        // 显示用户消息
        addCallMessage(text, "user");

        // 保存到通话历史
        callState.conversationHistory.push({ role: "user", content: text });

        // AI回复 - 区分群聊和单聊
        if (callState.isGroupCall) {
          requestGroupCallAIResponse(text);
        } else {
          generateCallResponse(text);
        }
      }

      // 处理输入框回车
      function handleCallInputKeydown(event) {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          sendCallMessage();
        }
      }

      // 生成通话中的AI回复
      async function generateCallResponse(context) {
        if (!callState.active || callState.status !== "connected") return;

        const apiConfig = getActiveApiConfig();
        if (!apiConfig || !apiConfig.url || !apiConfig.key) {
          console.error("通话: API配置缺失");
          addCallMessage("(API未配置，请在设置中配置API)", "system");
          return;
        }

        const settings = chatSettings[callState.charId] || {};
        const char = characters.find((c) => c.id === callState.charId);
        if (!char) return;

        const charName = settings.charName || char.name || "对方";
        const persona = settings.persona || "";
        const userNickname = settings.userNickname || "用户";

        console.log("通话人设:", { charName, personaLength: persona.length });

        // 显示正在输入指示器
        showCallTypingIndicator(true);

        try {
          // 获取之前的聊天记录摘要
          const chatHistory = chatHistories[callState.charId] || [];
          let recentChatSummary = "";

          if (chatHistory.length > 0) {
            // 获取最近的聊天记录（最多20条非隐藏消息）
            const recentMessages = chatHistory
              .filter((msg) => !msg.isHidden && msg.role !== "system")
              .slice(-20);

            if (recentMessages.length > 0) {
              recentChatSummary = "\n【通话前的聊天记录摘要】\n";
              recentChatSummary +=
                "以下是你们最近的聊天内容，请记住这些对话，在通话中保持连贯性：\n";
              recentMessages.forEach((msg) => {
                const sender = msg.role === "user" ? userNickname : charName;
                // 简化消息内容，去掉过长的部分
                let content = msg.content || "";
                if (content.length > 100) {
                  content = content.substring(0, 100) + "...";
                }
                recentChatSummary += `${sender}: ${content}\n`;
              });
              recentChatSummary += "---\n";
            }
          }

          // 构建系统提示词
          let inCallPrompt = "";

          // 人设放在最前面
          if (persona && persona.trim()) {
            inCallPrompt = persona.trim() + "\n\n";
          }

          // 添加聊天记录摘要
          if (recentChatSummary) {
            inCallPrompt += recentChatSummary + "\n";
          }

          // 通话场景说明
          inCallPrompt += `---\n【当前场景】\n`;
          inCallPrompt += `你正在和${userNickname}进行${
            callState.type === "video" ? "视频" : "语音"
          }通话。\n`;
          inCallPrompt += `请完全按照上面的人设来说话，保持角色的性格、语气和说话习惯。\n`;
          inCallPrompt += `重要：你要记住之前聊天的内容，不要表现得像失忆了一样！\n\n`;

          if (callState.type === "video") {
            inCallPrompt += `【视频通话格式】\n`;
            inCallPrompt += `用【】描述动作、表情、神态，穿插在对话中。\n`;
            inCallPrompt += `示例：【看着屏幕笑了笑】你好呀～【歪头看着你】怎么突然想起给我打视频了？\n`;
          } else {
            inCallPrompt += `【语音通话格式】\n`;
            inCallPrompt += `这是语音通话，只能听到声音。\n`;
            inCallPrompt += `直接用对话回复，不要描写动作，不要用【】或括号。\n`;
            inCallPrompt += `像真人打电话一样自然地说话。\n`;
          }

          const messages = [{ role: "system", content: inCallPrompt }];

          // 添加通话历史
          if (callState.conversationHistory.length > 0) {
            callState.conversationHistory.forEach((msg) => {
              messages.push({ role: msg.role, content: msg.content });
            });
          }

          // 添加当前触发
          if (callState.conversationHistory.length === 0) {
            messages.push({ role: "user", content: "(电话接通了)" });
          } else if (
            context &&
            !callState.conversationHistory.find((m) => m.content === context)
          ) {
            messages.push({ role: "user", content: context });
          }

          console.log("通话API请求:", {
            url: apiConfig.url,
            model: apiConfig.model,
            messagesCount: messages.length,
            systemPrompt: inCallPrompt.substring(0, 200),
          });

          const reqTemperature =
            apiConfig.temperature !== undefined
              ? Number(apiConfig.temperature)
              : 0.8;

          const response = await fetch(`${apiConfig.url}/chat/completions`, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${apiConfig.key}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: apiConfig.model,
              messages: messages,
              temperature: reqTemperature,
            }),
          });

          if (!response.ok) {
            const errText = await response.text();
            console.error("通话API错误:", response.status, errText);
            addCallMessage("(连接失败，请重试)", "system");
            return;
          }

          const data = await response.json();

          // 详细调试输出
          console.log("通话API完整响应:", data);
          console.log("choices[0]:", data.choices?.[0]);
          console.log("message:", data.choices?.[0]?.message);
          console.log("content:", data.choices?.[0]?.message?.content);
          console.log("finish_reason:", data.choices?.[0]?.finish_reason);

          let aiReply = "";

          // 尝试多种方式提取回复
          if (data.choices && data.choices[0]) {
            const choice = data.choices[0];
            if (choice.message && choice.message.content) {
              aiReply = choice.message.content;
            } else if (choice.text) {
              aiReply = choice.text;
            }
            // 检查是否被过滤
            if (choice.finish_reason === "content_filter") {
              console.warn("通话: 内容被过滤");
            }
          }

          // 检查是否为空
          if (!aiReply || !aiReply.trim() || aiReply.trim().length < 2) {
            console.error("通话: AI回复为空", {
              aiReply,
              choicesLength: data.choices?.length,
              firstChoice: data.choices?.[0],
            });

            // 使用备用回复
            if (callState.conversationHistory.length === 0) {
              aiReply =
                callState.type === "video"
                  ? `【看到屏幕亮起，脸上浮现出一丝笑意】接通了。怎么突然想起给我打视频？【微微歪头】是想我了？`
                  : `喂？是你呀。怎么这个时候打电话过来？`;
            } else {
              aiReply =
                callState.type === "video"
                  ? `【眨了眨眼看着你】嗯？你说什么？`
                  : `嗯？你说什么？`;
            }
          }

          // 保存到通话历史
          callState.conversationHistory.push({
            role: "assistant",
            content: aiReply,
          });

          // 隐藏正在输入指示器
          showCallTypingIndicator(false);

          // 显示在通话界面（视频通话保留动作描写）
          addCallMessage(aiReply, "ai", callState.type === "video");

          // 如果开启了语音，朗读回复（只读对话部分，不读动作）
          if (
            settings.callVoiceEnabled &&
            settings.voiceId &&
            !callState.isMuted
          ) {
            const textToSpeak = aiReply.replace(/【[^】]*】/g, "").trim();
            if (textToSpeak) {
              await speakInCall(textToSpeak, settings.voiceId);
            }
          }
        } catch (error) {
          console.error("通话AI回复失败:", error);
          showCallTypingIndicator(false);
          addCallMessage("(出错了，请重试)", "system");
        }
      }

      // 重回通话中AI的回复
      async function rerollCallResponse() {
        if (!callState.active || callState.status !== "connected") return;
        if (callState.conversationHistory.length === 0) return;

        // 找到最后一条AI回复
        let lastAiIndex = -1;
        for (let i = callState.conversationHistory.length - 1; i >= 0; i--) {
          if (callState.conversationHistory[i].role === "assistant") {
            lastAiIndex = i;
            break;
          }
        }

        if (lastAiIndex === -1) return;

        // 删除最后一条AI回复
        callState.conversationHistory.splice(lastAiIndex, 1);

        // 删除界面上的最后一条AI消息
        const wrapper = document.getElementById("callMessagesWrapper");
        const messages = wrapper.querySelectorAll(".call-message.ai");
        if (messages.length > 0) {
          messages[messages.length - 1].remove();
        }

        // 停止当前播放的音频
        if (callState.currentAudio) {
          callState.currentAudio.pause();
          callState.currentAudio = null;
        }

        // 找到最后一条用户消息作为上下文
        let lastUserMsg = "";
        for (let i = callState.conversationHistory.length - 1; i >= 0; i--) {
          if (callState.conversationHistory[i].role === "user") {
            lastUserMsg = callState.conversationHistory[i].content;
            break;
          }
        }

        // 重新生成回复
        await generateCallResponse(lastUserMsg || "请继续对话");
      }

      // 添加通话消息到界面
      function addCallMessage(text, sender, preserveActions = false) {
        const wrapper = document.getElementById("callMessagesWrapper");
        const msgDiv = document.createElement("div");
        msgDiv.className = `call-message ${sender}`;

        if (sender === "ai" && preserveActions) {
          // 视频通话：【】动作描写用不同样式
          const html = text.replace(
            /【([^】]*)】/g,
            '<span class="action-text">【$1】</span>'
          );
          msgDiv.innerHTML = html;
        } else {
          msgDiv.textContent = text;
        }

        wrapper.appendChild(msgDiv);

        // 滚动到底部
        const container = document.getElementById("callConversation");
        container.scrollTop = container.scrollHeight;
      }

      // 显示/隐藏AI正在输入指示器
      function showCallTypingIndicator(show) {
        const indicator = document.getElementById("callTypingIndicator");
        if (indicator) {
          indicator.classList.toggle("active", show);
          if (show) {
            const container = document.getElementById("callConversation");
            container.scrollTop = container.scrollHeight;
          }
        }
      }

      // 在通话中朗读文字
      async function speakInCall(text, voiceId) {
        if (callState.isAiSpeaking) return;
        callState.isAiSpeaking = true;

        // 使用和试听一样的配置来源
        const currentGroupId =
          (window.voiceConfig && window.voiceConfig.groupId) ||
          document.getElementById("voiceGroupId")?.value;
        const currentApiKey =
          (window.voiceConfig && window.voiceConfig.apiKey) ||
          document.getElementById("voiceApiKey")?.value;

        if (!currentGroupId || !currentApiKey) {
          console.error("通话语音: MiniMax配置缺失");
          callState.isAiSpeaking = false;
          return;
        }

        if (!voiceId) {
          console.error("通话语音: Voice ID缺失");
          callState.isAiSpeaking = false;
          return;
        }

        // 清洗文本 - 移除动作描写
        let cleanText = text;
        cleanText = cleanText
          .replace(/[\(（][^\)）]*[\)）]/g, "")
          .replace(/\*[^\*]+\*/g, "")
          .replace(/【[^】]*】/g, "");
        cleanText = cleanText.replace(/\n/g, "，");
        cleanText = cleanText
          .replace(/……/g, "，")
          .replace(/…/g, "，")
          .replace(/—/g, "，")
          .replace(/~/g, "")
          .replace(/["]/g, "");
        cleanText = cleanText.replace(
          /[^\u4e00-\u9fa5a-zA-Z0-9，。！？,.?! ]/g,
          ""
        );

        if (cleanText.trim().length < 1) {
          callState.isAiSpeaking = false;
          return;
        }

        console.log("通话语音合成:", {
          voiceId,
          textLength: cleanText.length,
          text: cleanText.substring(0, 50),
        });

        try {
          // 检查是否使用国际线路
          const activeIntlBtn = document.getElementById("voiceUrlIntl");
          const isIntlSelected =
            activeIntlBtn && activeIntlBtn.classList.contains("active");
          const apiUrl = isIntlSelected
            ? "https://api.minimaxi.chat"
            : "https://api.minimax.chat";

          const response = await fetch(
            `${apiUrl}/v1/t2a_v2?GroupId=${currentGroupId}`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${currentApiKey}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                model:
                  (window.voiceConfig && window.voiceConfig.model) ||
                  "speech-01-turbo",
                text: cleanText,
                stream: false,
                voice_setting: {
                  voice_id: voiceId,
                  speed: 1.0,
                  vol: 1.0,
                  pitch: 0,
                },
                audio_setting: {
                  sample_rate: 32000,
                  bitrate: 128000,
                  format: "mp3",
                  channel: 1,
                },
              }),
            }
          );

          if (!response.ok) {
            console.error("通话语音API错误:", response.status);
            throw new Error(`HTTP ${response.status}`);
          }

          const result = await response.json();
          console.log("通话语音API响应:", result.base_resp);

          if (result.base_resp && result.base_resp.status_code !== 0) {
            throw new Error(result.base_resp.status_msg);
          }

          // 处理音频数据 - hex转bytes（和generateSpeech一样）
          const audioHex = result.data?.audio || result.audio;
          if (audioHex) {
            const bytes = new Uint8Array(audioHex.length / 2);
            for (let i = 0; i < audioHex.length; i += 2) {
              bytes[i / 2] = parseInt(audioHex.substr(i, 2), 16);
            }
            const blob = new Blob([bytes.buffer], { type: "audio/mp3" });
            const audioUrl = URL.createObjectURL(blob);

            const audio = new Audio(audioUrl);
            callState.currentAudio = audio;

            audio.onended = () => {
              callState.isAiSpeaking = false;
              callState.currentAudio = null;
              URL.revokeObjectURL(audioUrl);
            };

            audio.onerror = (e) => {
              console.error("通话语音播放错误:", e);
              callState.isAiSpeaking = false;
              callState.currentAudio = null;
              URL.revokeObjectURL(audioUrl);
            };

            await audio.play();
            return;
          }

          // 备用：URL处理
          const audioUrl = result.data?.audio_url || result.audio_url;
          if (audioUrl) {
            const audio = new Audio(audioUrl);
            callState.currentAudio = audio;

            audio.onended = () => {
              callState.isAiSpeaking = false;
              callState.currentAudio = null;
            };

            audio.onerror = (e) => {
              console.error("通话语音播放错误:", e);
              callState.isAiSpeaking = false;
              callState.currentAudio = null;
            };

            await audio.play();
            return;
          }

          console.error("通话语音: 无音频数据");
          callState.isAiSpeaking = false;
        } catch (error) {
          console.error("通话语音合成失败:", error);
          callState.isAiSpeaking = false;
        }
      }

      // AI主动来电
      function aiInitiateCall(charId, type = "voice") {
        const settings = chatSettings[charId] || {};
        if (!settings.aiCallEnabled) return;

        const char = characters.find((c) => c.id === charId);
        if (!char) return;

        // 显示来电通知
        callState.charId = charId;
        callState.type = type;
        callState.status = "incoming";

        const overlay = document.getElementById("incomingCallOverlay");
        const avatarImg = document.getElementById("incomingCallAvatarImg");
        const avatarPlaceholder = document.getElementById(
          "incomingCallAvatarPlaceholder"
        );

        if (char.avatar) {
          avatarImg.src = char.avatar;
          avatarImg.style.display = "block";
          avatarPlaceholder.style.display = "none";
        } else {
          avatarImg.style.display = "none";
          avatarPlaceholder.style.display = "block";
        }

        document.getElementById("incomingCallName").textContent =
          settings.charNote || char.note || char.name;
        document.getElementById("incomingCallTypeIcon").textContent =
          type === "video" ? "▶" : "☎";
        document.getElementById("incomingCallTypeText").textContent =
          type === "video" ? "视频通话" : "语音通话";

        overlay.classList.add("active");

        // 30秒后自动取消
        setTimeout(() => {
          if (callState.status === "incoming") {
            declineIncomingCall();
            addCallRecord("missed");
          }
        }, 30000);
      }

      // 接听来电通知
      function acceptIncomingCall() {
        document
          .getElementById("incomingCallOverlay")
          .classList.remove("active");

        // 打开通话界面
        const char = characters.find((c) => c.id === callState.charId);
        if (!char) return;

        const settings = chatSettings[callState.charId] || {};

        callState.active = true;
        callState.conversationHistory = [];
        callState.videoSelfExpanded = false;

        const overlay = document.getElementById("callOverlay");
        overlay.className = `call-overlay ${callState.type}-call active`;

        const charName = settings.charNote || char.note || char.name;

        const avatarImg = document.getElementById("callAvatarImg");
        const avatarPlaceholder = document.getElementById(
          "callAvatarPlaceholder"
        );
        if (char.avatar) {
          avatarImg.src = char.avatar;
          avatarImg.style.display = "block";
          avatarPlaceholder.style.display = "none";
        } else {
          avatarImg.style.display = "none";
          avatarPlaceholder.style.display = "block";
        }

        document.getElementById("callName").textContent = charName;
        // 清空消息但保留结构
        document.getElementById("callMessagesWrapper").innerHTML = "";
        showCallTypingIndicator(false);

        // 视频通话设置
        if (callState.type === "video") {
          document.getElementById("videoCallName").textContent = charName;

          const videoMainImg = document.getElementById("videoMainImg");
          const videoMainPlaceholder = document.getElementById(
            "videoMainPlaceholder"
          );
          if (settings.videoCallPartnerImage) {
            videoMainImg.src = settings.videoCallPartnerImage;
            videoMainImg.style.display = "block";
            videoMainPlaceholder.style.display = "none";
          } else {
            videoMainImg.style.display = "none";
            videoMainPlaceholder.style.display = "flex";
            const mainAvatarImg = document.getElementById("videoMainAvatarImg");
            const mainAvatarPlaceholder = document.getElementById(
              "videoMainAvatarPlaceholder"
            );
            if (char.avatar) {
              mainAvatarImg.src = char.avatar;
              mainAvatarImg.style.display = "block";
              mainAvatarPlaceholder.style.display = "none";
            }
            document.getElementById("videoMainName").textContent = charName;
          }

          const videoSelfImg = document.getElementById("videoSelfImg");
          const videoSelfPlaceholder = document.getElementById(
            "videoSelfPlaceholder"
          );
          if (settings.videoCallSelfImage) {
            videoSelfImg.src = settings.videoCallSelfImage;
            videoSelfImg.style.display = "block";
            videoSelfPlaceholder.style.display = "none";
          } else {
            videoSelfImg.style.display = "none";
            videoSelfPlaceholder.style.display = "flex";
          }
          document.getElementById("videoSelf").classList.remove("expanded");
        }

        // 显示来电按钮
        document.getElementById("callCallingBtns").style.display = "none";
        document.getElementById("callIncomingBtns").style.display = "flex";
        document.getElementById("callInCallBtns").style.display = "none";

        // 直接进入通话
        acceptCall();

        // AI说话
        generateCallResponse("用户接听了你的来电，自然地开始对话");
      }

      // 拒绝来电通知
      function declineIncomingCall() {
        document
          .getElementById("incomingCallOverlay")
          .classList.remove("active");
        callState.status = "idle";
        callState.charId = null;
      }

      function sendFakeLocation() {
        // 打开位置选择弹窗
        document.getElementById("locationModal").classList.add("active");
        document.getElementById("locationNameInput").value = "";
        document.getElementById("locationAddressInput").value = "";
        closeChatPanel();
      }

      function closeLocationModal() {
        document.getElementById("locationModal").classList.remove("active");
      }

      function confirmSendLocation() {
        const name =
          document.getElementById("locationNameInput").value.trim() ||
          "我的位置";
        const address =
          document.getElementById("locationAddressInput").value.trim() ||
          "点击查看详情";

        const locationHtml = `
          <div class="location-card">
            <div class="location-card-map">
              <div class="location-card-map-bg"></div>
              <div class="location-card-map-icon">📍</div>
            </div>
            <div class="location-card-info">
              <div class="location-card-name">${name}</div>
              <div class="location-card-address">${address}</div>
            </div>
          </div>
        `;

        sendMediaMessage(locationHtml, "location");
        closeLocationModal();
      }

      // AI发送位置卡片 (保留兼容)
      function aiSendLocation(name, address) {
        return `
          <div class="location-card">
            <div class="location-card-map">
              <div class="location-card-map-bg"></div>
              <div class="location-card-map-icon">📍</div>
            </div>
            <div class="location-card-info">
              <div class="location-card-name">${name || "TA的位置"}</div>
              <div class="location-card-address">${
                address || "点击查看详情"
              }</div>
            </div>
          </div>
        `;
      }

      /* ==================== 钱包系统 ==================== */
      window.walletData = {
        balance: 0,
        history: [],
      };

      // 初始化钱包数据
      async function initWalletData() {
        try {
          const saved = await safeLocalforageGet("walletData");
          if (saved) {
            window.walletData = saved;
          }
          updateWalletDisplay();
        } catch (e) {
          console.error("钱包数据加载失败", e);
        }
      }

      // 保存钱包数据
      async function saveWalletData() {
        try {
          await localforage.setItem("walletData", window.walletData);
        } catch (e) {
          console.error("钱包数据保存失败", e);
        }
      }

      // 更新钱包显示
      function updateWalletDisplay() {
        // 更新钱包页面的余额
        const balanceEl = document.getElementById("walletBalanceDisplay");
        if (balanceEl) {
          balanceEl.textContent = window.walletData.balance.toFixed(2);
        }
      }

      // 打开钱包页面
      function openWalletPage() {
        document.getElementById("walletPage").classList.add("active");
        updateWalletDisplay();
        renderWalletHistoryPage();
      }

      // 关闭钱包页面
      function closeWalletPage() {
        document.getElementById("walletPage").classList.remove("active");
      }

      // 渲染钱包历史记录
      function renderWalletHistoryPage() {
        const list = document.getElementById("walletHistoryListPage");
        const history = window.walletData.history || [];

        if (history.length === 0) {
          list.innerHTML =
            '<div class="wallet-history-empty">暂无交易记录</div>';
          return;
        }

        let html = "";
        history.slice(0, 50).forEach((item) => {
          const isIncome = item.type === "recharge" || item.type === "receive";
          html += `
            <div class="wallet-history-item">
              <div class="wallet-history-icon ${
                isIncome ? "income" : "expense"
              }">
                ${
                  item.type === "recharge"
                    ? "💳"
                    : item.type === "receive"
                    ? "↓"
                    : "↑"
                }
              </div>
              <div class="wallet-history-info">
                <div class="wallet-history-desc">${item.desc}</div>
                <div class="wallet-history-time">${item.time}</div>
              </div>
              <div class="wallet-history-amount ${
                isIncome ? "income" : "expense"
              }">
                ${isIncome ? "+" : "-"}¥${item.amount.toFixed(2)}
              </div>
            </div>
          `;
        });

        list.innerHTML = html;
      }

      // 打开充值弹窗
      function openRechargeModal() {
        document.getElementById("rechargeModal").classList.add("active");
        document.getElementById("rechargeCustomAmount").value = "";
        // 清除选中状态
        document.querySelectorAll(".recharge-amount-btn").forEach((btn) => {
          btn.classList.remove("selected");
        });
      }

      function closeRechargeModal() {
        document.getElementById("rechargeModal").classList.remove("active");
      }

      function selectRechargeAmount(amount) {
        document.getElementById("rechargeCustomAmount").value = amount;
        document.querySelectorAll(".recharge-amount-btn").forEach((btn) => {
          btn.classList.remove("selected");
          if (btn.textContent.includes(amount)) {
            btn.classList.add("selected");
          }
        });
      }

      function clearRechargeSelection() {
        document.querySelectorAll(".recharge-amount-btn").forEach((btn) => {
          btn.classList.remove("selected");
        });
      }

      function confirmRecharge() {
        const amount = parseFloat(
          document.getElementById("rechargeCustomAmount").value
        );
        if (!amount || amount <= 0) {
          showToast("请输入有效金额");
          return;
        }

        window.walletData.balance += amount;
        window.walletData.history.unshift({
          id: Date.now(),
          type: "recharge",
          amount: amount,
          desc: "钱包充值",
          time: new Date().toLocaleString("zh-CN", {
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
          }),
        });

        saveWalletData();
        updateWalletDisplay();
        renderWalletHistoryPage(); // 刷新历史列表
        closeRechargeModal();
        showToast(`充值成功！余额 ¥${window.walletData.balance.toFixed(2)}`);
      }

      /* ==================== 转账功能 ==================== */
      var selectedTransferTarget = null; // 群聊中选择的转账目标

      function openTransferModal() {
        // 群聊中也支持转账
        if (!currentChatCharId && !currentGroupId) {
          showToast("请先打开一个对话");
          return;
        }

        const memberSelectDiv = document.getElementById("transferMemberSelect");

        if (currentGroupId) {
          // 群聊：显示成员选择列表
          const group = groupChats.find((g) => g.id === currentGroupId);
          if (!group || !group.members || group.members.length === 0) {
            showToast("群里没有成员");
            return;
          }

          document.getElementById("transferToName").textContent =
            "选择转账对象：";

          // 生成成员选择列表
          let membersHtml = "";
          group.members.forEach((charId, idx) => {
            const char = characters.find((c) => c.id === charId);
            if (char) {
              const isSelected = idx === 0;
              if (isSelected) selectedTransferTarget = charId;
              membersHtml += `
                <div class="transfer-member-item ${
                  isSelected ? "selected" : ""
                }" 
                     data-char-id="${charId}"
                     onclick="selectTransferTarget(${charId})">
                  <div class="transfer-member-avatar">
                    ${
                      char.avatar
                        ? `<img src="${char.avatar}">`
                        : char.name.charAt(0)
                    }
                  </div>
                  <div class="transfer-member-name">${
                    char.note || char.name
                  }</div>
                  <div class="transfer-member-check">${
                    isSelected ? "✓" : ""
                  }</div>
                </div>
              `;
            }
          });
          memberSelectDiv.innerHTML = membersHtml;
          memberSelectDiv.style.display = "block";
        } else {
          // 单聊
          const char = characters.find((c) => c.id === currentChatCharId);
          if (!char) return;
          document.getElementById("transferToName").textContent = `转给：${
            char.note || char.name
          }`;
          memberSelectDiv.style.display = "none";
          selectedTransferTarget = null;
        }

        document.getElementById("sendTransferModal").classList.add("active");
        document.getElementById("transferAmountInput").value = "";
        document.getElementById("transferNoteInput").value = "";
        document.getElementById(
          "transferBalanceHint"
        ).textContent = `可用余额：¥${window.walletData.balance.toFixed(2)}`;
        closeChatPanel();
      }

      function selectTransferTarget(charId) {
        selectedTransferTarget = charId;
        const char = characters.find((c) => c.id === charId);
        if (char) {
          document.getElementById("transferToName").textContent = `转给：${
            char.note || char.name
          }`;
        }
        // 更新选中状态
        document.querySelectorAll(".transfer-member-item").forEach((item) => {
          const itemCharId = parseInt(item.dataset.charId);
          if (itemCharId === charId) {
            item.classList.add("selected");
            item.querySelector(".transfer-member-check").textContent = "✓";
          } else {
            item.classList.remove("selected");
            item.querySelector(".transfer-member-check").textContent = "";
          }
        });
      }

      function closeTransferModal() {
        document.getElementById("sendTransferModal").classList.remove("active");
        selectedTransferTarget = null;
      }

      async function confirmTransfer() {
        const amount = parseFloat(
          document.getElementById("transferAmountInput").value
        );
        const note =
          document.getElementById("transferNoteInput").value.trim() || "转账";

        if (!amount || amount <= 0) {
          showToast("请输入有效金额");
          return;
        }

        if (amount > window.walletData.balance) {
          showToast("余额不足");
          return;
        }

        let targetName = "";
        let targetCharId = null;

        if (currentGroupId) {
          // 群聊：使用选择的目标
          if (!selectedTransferTarget) {
            showToast("请选择转账对象");
            return;
          }
          targetCharId = selectedTransferTarget;
          const char = characters.find((c) => c.id === targetCharId);
          targetName = char ? char.note || char.name : "群成员";
        } else {
          const char = characters.find((c) => c.id === currentChatCharId);
          if (!char) return;
          targetName = char.note || char.name;
          targetCharId = currentChatCharId;
        }

        // 扣款
        window.walletData.balance -= amount;
        window.walletData.history.unshift({
          id: Date.now(),
          type: "send",
          amount: amount,
          desc: `转账给 ${targetName}`,
          time: new Date().toLocaleString("zh-CN", {
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
          }),
        });
        saveWalletData();
        updateWalletDisplay();

        // 发送转账卡片消息（包含目标信息）
        const transferId = "user_tf_" + Date.now();
        const transferCardHtml = `<div class="transfer-card" data-transfer-id="${transferId}" data-status="pending" data-target-id="${targetCharId}">
            <div class="transfer-card-header">
              <div class="transfer-card-icon">¥</div>
              <div class="transfer-card-info">
                <div class="transfer-card-title">${note}${
          currentGroupId ? ` (给${targetName})` : ""
        }</div>
                <div class="transfer-card-amount">${amount.toFixed(2)}</div>
              </div>
            </div>
            <div class="transfer-card-footer">
              <span>微信转账</span>
              <span class="transfer-card-status pending">待确认</span>
            </div>
          </div>`;

        if (currentGroupId) {
          // 群聊转账
          const messagesKey = `group_messages_${currentGroupId}`;
          const messages = (await localforage.getItem(messagesKey)) || [];
          messages.push({
            role: "user",
            content: transferCardHtml,
            isHtml: true,
            transferId: transferId,
            transferAmount: amount,
            transferStatus: "pending",
            transferTargetId: targetCharId,
            time: new Date().toLocaleTimeString("zh-CN", {
              hour: "2-digit",
              minute: "2-digit",
            }),
          });
          await localforage.setItem(messagesKey, messages);
          loadGroupMessages(currentGroupId);
        } else {
          // 单聊转账
          if (!chatHistories[currentChatCharId])
            chatHistories[currentChatCharId] = [];
          chatHistories[currentChatCharId].push({
            role: "user",
            content: transferCardHtml,
            isHtml: true,
            transferId: transferId,
            transferAmount: amount,
            transferStatus: "pending",
            time: new Date().toLocaleTimeString("zh-CN", {
              hour: "2-digit",
              minute: "2-digit",
            }),
          });
          await localforage.setItem("chatHistories", chatHistories);
          renderConversation();
        }

        closeTransferModal();
      }

      // 更新用户发送的转账状态（AI接受或拒绝时调用）
      function updateUserTransferStatus(transferId, accepted) {
        const history = chatHistories[currentChatCharId] || [];
        for (let i = 0; i < history.length; i++) {
          if (history[i].transferId === transferId) {
            history[i].transferStatus = accepted ? "accepted" : "rejected";
            // 更新HTML内容
            history[i].content = history[i].content
              .replace(
                'data-status="pending"',
                `data-status="${accepted ? "accepted" : "rejected"}"`
              )
              .replace(
                'class="transfer-card-status pending">待确认',
                `class="transfer-card-status ${
                  accepted ? "accepted" : "rejected"
                }">${accepted ? "已收款" : "已退回"}`
              );

            if (!accepted) {
              // 退款
              window.walletData.balance += history[i].transferAmount;
              window.walletData.history.unshift({
                id: Date.now(),
                type: "receive",
                amount: history[i].transferAmount,
                desc: "转账被退回",
                time: new Date().toLocaleString("zh-CN", {
                  month: "2-digit",
                  day: "2-digit",
                  hour: "2-digit",
                  minute: "2-digit",
                }),
              });
              saveWalletData();
              updateWalletDisplay();
            }
            break;
          }
        }
        localforage.setItem("chatHistories", chatHistories);
        renderConversation();
      }

      // AI向用户转账 - 收款/退回
      function acceptAITransfer(msgIdx, amount, btnEl) {
        // 获取角色名字
        const char = characters.find((c) => c.id === currentChatCharId);
        const charName = char ? char.name : "TA";

        // 收款
        window.walletData.balance += parseFloat(amount);
        window.walletData.history.unshift({
          id: Date.now(),
          type: "receive",
          amount: parseFloat(amount),
          desc: `收到 ${charName} 的转账`,
          time: new Date().toLocaleString("zh-CN", {
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
          }),
        });
        saveWalletData();
        updateWalletDisplay();

        // 更新消息状态
        const history = chatHistories[currentChatCharId] || [];
        if (history[msgIdx]) {
          history[msgIdx].transferStatus = "accepted";
          localforage.setItem("chatHistories", chatHistories);
          renderConversation();
        }

        showToast(`收款成功！+¥${parseFloat(amount).toFixed(2)}`);
      }

      function rejectAITransfer(msgIdx, btnEl) {
        // 更新消息状态
        const history = chatHistories[currentChatCharId] || [];
        if (history[msgIdx]) {
          history[msgIdx].transferStatus = "rejected";
          localforage.setItem("chatHistories", chatHistories);
          renderConversation();
        }

        showToast("已退回转账");
      }

      /* ==================== 重Roll功能 ==================== */
      async function rerollAIReply() {
        // 检查是否是群聊
        if (currentGroupId) {
          await rerollGroupAIReply();
          return;
        }

        if (!currentChatCharId) {
          showToast("请先打开一个对话");
          return;
        }

        const history = chatHistories[currentChatCharId] || [];
        if (history.length === 0) {
          showToast("没有可以重新生成的消息");
          return;
        }

        // 从后往前删除所有连续的AI消息（因为即时模式下AI会发多条）
        let deletedCount = 0;
        while (
          history.length > 0 &&
          history[history.length - 1].role === "assistant"
        ) {
          history.pop();
          deletedCount++;
        }

        if (deletedCount === 0) {
          showToast("最后一条不是AI消息，无法重roll");
          return;
        }

        // 保存并重新渲染
        chatHistories[currentChatCharId] = history;
        await localforage.setItem("chatHistories", chatHistories);
        renderConversation();

        // 关闭面板
        closeChatPanel();

        // 重新请求AI回复（不显示提示）
        requestAIReply();
      }

      // 群聊重roll
      async function rerollGroupAIReply() {
        if (!currentGroupId) return;

        const messagesKey = `group_messages_${currentGroupId}`;
        const messages = (await localforage.getItem(messagesKey)) || [];

        if (messages.length === 0) {
          showToast("没有可以重新生成的消息");
          return;
        }

        // 从后往前删除所有连续的AI消息
        let deletedCount = 0;
        while (
          messages.length > 0 &&
          messages[messages.length - 1].role === "assistant"
        ) {
          messages.pop();
          deletedCount++;
        }

        if (deletedCount === 0) {
          showToast("最后一条不是AI消息，无法重roll");
          return;
        }

        // 关闭面板
        closeChatPanel();

        // 保存并重新渲染
        await localforage.setItem(messagesKey, messages);
        await loadGroupMessages(currentGroupId);

        // 获取最后一条消息作为上下文
        const lastMsg = messages
          .filter((m) => m.role !== "system")
          .slice(-1)[0];
        const contextMsg = lastMsg ? lastMsg.content : "请在群里说点什么吧";

        // 重新请求群聊AI回复（这里会添加typing动画）
        requestGroupAIReply(contextMsg);
      }

      /* ==================== AI特殊消息处理 ==================== */
      // 处理AI回复中的特殊标签
      function processAISpecialTags(content) {
        let processed = content;

        // 处理转账标签 [转账:金额:说明] 或 [转账:金额]
        const transferMatch = processed.match(
          /\[转账[:：](\d+(?:\.\d+)?)(?:[:：]([^\]]*))?\]/
        );
        if (transferMatch) {
          const amount = transferMatch[1];
          const note = transferMatch[2] || "转账给你";
          processed = processed.replace(transferMatch[0], "");
          return {
            text: processed.trim(),
            specialCard: generateAITransferCard(amount, note),
            type: "transfer",
          };
        }

        // 处理位置标签 [位置:名称:地址] 或 [位置:名称]
        const locationMatch = processed.match(
          /\[位置[:：]([^\]:：]+)(?:[:：]([^\]]*))?\]/
        );
        if (locationMatch) {
          const name = locationMatch[1];
          const address = locationMatch[2] || "";
          processed = processed.replace(locationMatch[0], "");
          return {
            text: processed.trim(),
            specialCard: generateAILocationCard(name, address),
            type: "location",
          };
        }

        // 处理红包标签 [红包:金额:说明]
        const redpacketMatch = processed.match(
          /\[红包[:：](\d+(?:\.\d+)?)(?:[:：]([^\]]*))?\]/
        );
        if (redpacketMatch) {
          const amount = redpacketMatch[1];
          const note = redpacketMatch[2] || "恭喜发财";
          processed = processed.replace(redpacketMatch[0], "");
          return {
            text: processed.trim(),
            specialCard: generateAITransferCard(amount, note),
            type: "redpacket",
          };
        }

        return { text: processed, specialCard: null, type: null };
      }

      // 页面加载时初始化钱包
      setTimeout(initWalletData, 500);

      /* ==================== 修复：一键刷新消息列表预览 ==================== */
      function fixAllLastMessages() {
        console.log("开始修复列表预览...");
        characters.forEach((char) => {
          const history = chatHistories[char.id] || [];
          if (history.length > 0) {
            // 取最后一条消息
            const lastMsg = history[history.length - 1];
            let previewText = lastMsg.content || "";

            // 根据类型生成预览
            if (previewText.match && previewText.match(/^\[语音[:：](.+)\]$/)) {
              previewText = "[语音]";
            } else if (lastMsg.isHtml || previewText.includes("<img")) {
              previewText = "[图片/消息]";
            } else {
              // 清除 HTML 标签和小说标记
              previewText = previewText
                .replace(/<[^>]+>/g, "")
                .replace(/\*/g, "");
            }

            // 更新并保存
            char.lastMessage = previewText;
            char.lastTime = lastMsg.time;
          }
        });
        localforage.setItem("characters", characters);
        renderCharacters(); // 刷新界面
        console.log("列表预览修复完成 ✓");
      }

      // 页面加载后自动运行一次修复
      setTimeout(fixAllLastMessages, 1000);
      /* ==================== 修复：交互函数 (防冲突安全版) ==================== */

      // 注意：这里不再用 var/let 声明变量，直接使用全局已存在的变量

      // 1. 通用触摸处理 (补全逻辑)
      window.handleTouchStart = function (e, index) {
        if (typeof isSelectionMode !== "undefined" && isSelectionMode) return;

        if (e.touches && e.touches[0]) {
          // 直接赋值给全局变量
          touchStartX = e.touches[0].clientX;
          touchStartY = e.touches[0].clientY;

          // 清除旧定时器
          if (typeof longPressTimer !== "undefined" && longPressTimer) {
            clearTimeout(longPressTimer);
          }

          longPressTimer = setTimeout(() => {
            if (typeof showContextMenu === "function") {
              showContextMenu(touchStartX, touchStartY, index);
            }
          }, 500);
        }
      };

      window.handleTouchMove = function (e) {
        if (typeof longPressTimer !== "undefined" && !longPressTimer) return;

        if (e.touches && e.touches[0]) {
          let moveX = e.touches[0].clientX;
          let moveY = e.touches[0].clientY;
          // 如果移动超过 10px，取消长按
          if (
            Math.abs(moveX - touchStartX) > 10 ||
            Math.abs(moveY - touchStartY) > 10
          ) {
            if (typeof longPressTimer !== "undefined") {
              clearTimeout(longPressTimer);
              longPressTimer = null;
            }
          }
        }
      };

      window.handleTouchEnd = function () {
        if (typeof longPressTimer !== "undefined" && longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      };

      // 2. 鼠标处理 (兼容电脑端)
      window.handleMouseDown = function (e, index) {
        if (typeof isSelectionMode !== "undefined" && isSelectionMode) return;

        if (typeof longPressTimer !== "undefined" && longPressTimer)
          clearTimeout(longPressTimer);

        longPressTimer = setTimeout(() => {
          if (typeof showContextMenu === "function") {
            showContextMenu(e.clientX, e.clientY, index);
          }
        }, 500);
      };

      window.handleMouseUp = function () {
        if (typeof longPressTimer !== "undefined" && longPressTimer) {
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      };

      // 3. 语音气泡专用处理 (防止长按和点击冲突)
      // voiceTouchStartTime 如果没定义，我们在 window 上定义它
      if (typeof window.voiceTouchStartTime === "undefined") {
        window.voiceTouchStartTime = 0;
      }

      window.handleVoiceBubbleTouchStart = function (event, msgIndex) {
        window.voiceTouchStartTime = Date.now();
        if (typeof handleTouchStart === "function") {
          handleTouchStart(event, msgIndex);
        }
      };

      window.handleVoiceBubbleTouchEnd = function (event, msgIndex) {
        const touchDuration = Date.now() - window.voiceTouchStartTime;
        // 如果按住时间短于 450ms，且定时器还存在（说明长按还没触发）
        // 则视为点击，播放语音
        if (
          touchDuration < 450 &&
          typeof longPressTimer !== "undefined" &&
          longPressTimer
        ) {
          clearTimeout(longPressTimer);
          longPressTimer = null;

          // 尝试播放
          const voiceBar = event.currentTarget.querySelector(".voice-bar");
          if (voiceBar && typeof playVoiceMessageByIndex === "function") {
            playVoiceMessageByIndex(msgIndex, voiceBar);
          }
        } else {
          if (typeof handleTouchEnd === "function") {
            handleTouchEnd();
          }
        }
      };
      // ==================== 一起读书功能 ====================

      function openReadTogether() {
        closeChatPanel();
        document.getElementById("readTogetherPage").classList.add("active");
        renderBookshelf();
        renderCurrentReading();
      }

      function closeReadTogether() {
        document.getElementById("readTogetherPage").classList.remove("active");
      }

      // 渲染书架
      function renderBookshelf() {
        const grid = document.getElementById("bookshelfGrid");
        let html = "";

        window.bookshelfData.forEach((book, index) => {
          const progress =
            Math.round(((book.currentIndex + 1) / book.chunks.length) * 100) ||
            0;
          const isReading = isCurrentlyReading(book.id);
          html += `
            <div class="book-card ${
              isReading ? "reading" : ""
            }" onclick="selectBook('${book.id}')">
              <div class="book-card-icon">≡</div>
              <div class="book-card-name">${escapeHtml(book.bookName)}</div>
              <div class="book-card-info">${
                book.chunks.length
              } 页 · ${progress}%</div>
              <div class="book-card-progress">
                <div class="book-card-progress-fill" style="width:${progress}%"></div>
              </div>
              <div class="book-card-actions" onclick="event.stopPropagation()">
                <button class="book-card-btn read" onclick="startReading('${
                  book.id
                }')">${isReading ? "继续读" : "开始读"}</button>
                <button class="book-card-btn delete" onclick="deleteBook('${
                  book.id
                }')">删除</button>
              </div>
            </div>
          `;
        });

        // 添加新书按钮
        html += `
          <div class="book-card add-book-card" onclick="document.getElementById('bookFileInput').click()">
            <div style="font-size:32px;margin-bottom:8px;">+</div>
            <div>导入新书</div>
          </div>
        `;

        grid.innerHTML = html;
      }

      // 检查某本书是否正在被当前角色阅读
      function isCurrentlyReading(bookId) {
        const charId = currentChatCharId;
        const data = window.readTogetherData[charId];
        return data && data.bookId === bookId && data.active;
      }

      // 渲染当前阅读区域
      function renderCurrentReading() {
        const charId = currentChatCharId;
        const data = window.readTogetherData[charId];
        const section = document.getElementById("currentReadingSection");

        if (!data || !data.active) {
          section.style.display = "none";
          return;
        }

        section.style.display = "block";

        const book = window.bookshelfData.find((b) => b.id === data.bookId);
        if (!book) {
          section.style.display = "none";
          return;
        }

        document.getElementById("readBookName").textContent = book.bookName;

        const current = book.currentIndex + 1;
        const total = book.chunks.length;
        const percent = Math.round((current / total) * 100);

        document.getElementById(
          "readBookProgress"
        ).textContent = `进度：第 ${current} 页 / 共 ${total} 页 (${percent}%)`;
        document.getElementById("readProgressFill").style.width = percent + "%";
        document.getElementById("readJumpTo").max = total;
        document.getElementById("readJumpTo").value = current;

        const currentText = book.chunks[book.currentIndex] || "（已读完）";
        document.getElementById("readSectionText").textContent = currentText;

        // 更新状态徽章
        const badge = document.getElementById("readStatusBadge");
        badge.innerHTML = "<span>✓</span> 阅读中";
        badge.classList.remove("inactive");
      }

      // 导入书籍到书架
      function handleBookImport(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          const content = e.target.result;
          // 使用用户设置的每页字数
          const chunkSizeInput = document.getElementById("readChunkSize");
          const chunkSize = parseInt(chunkSizeInput?.value) || 500;
          const chunks = splitTextIntoChunks(content, chunkSize);

          const bookId = "book_" + Date.now();
          const newBook = {
            id: bookId,
            bookName: file.name.replace(".txt", ""),
            chunks: chunks,
            currentIndex: 0,
            chunkSize: chunkSize,
            importTime: Date.now(),
          };

          window.bookshelfData.push(newBook);
          localforage
            .setItem("bookshelfData", window.bookshelfData)
            .then(() => {
              renderBookshelf();
              alert("导入成功！");
            })
            .catch((err) => alert("保存失败: " + err));
          showToast(
            "≡ 《" +
              newBook.bookName +
              "》已加入书架！共 " +
              chunks.length +
              " 页"
          );
        };
        reader.readAsText(file);
        input.value = "";
      }

      function splitTextIntoChunks(text, chunkSize) {
        const chunks = [];
        const paragraphs = text.split(/\n\s*\n|\r\n\s*\r\n/);
        let currentChunk = "";

        for (const para of paragraphs) {
          const trimmed = para.trim();
          if (!trimmed) continue;

          if (
            currentChunk.length + trimmed.length > chunkSize &&
            currentChunk.length > 0
          ) {
            chunks.push(currentChunk.trim());
            currentChunk = trimmed;
          } else {
            currentChunk += (currentChunk ? "\n\n" : "") + trimmed;
          }
        }

        if (currentChunk.trim()) {
          chunks.push(currentChunk.trim());
        }

        if (chunks.length === 0 && text.trim()) {
          for (let i = 0; i < text.length; i += chunkSize) {
            chunks.push(text.slice(i, i + chunkSize).trim());
          }
        }

        return chunks;
      }

      // 选择书籍（点击书籍卡片）
      function selectBook(bookId) {
        startReading(bookId);
      }

      // 开始/继续阅读某本书
      function startReading(bookId) {
        const charId = currentChatCharId;
        const book = window.bookshelfData.find((b) => b.id === bookId);
        if (!book) return;

        window.readTogetherData[charId] = {
          bookId: bookId,
          active: true,
          mode: window.readTogetherData[charId]?.mode || "auto",
        };

        localforage.setItem("readTogetherData", window.readTogetherData);
        renderBookshelf();
        renderCurrentReading();
        showToast("≡ 开始阅读《" + book.bookName + "》");
      }

      // 暂停阅读（回到书架）
      function stopCurrentReading() {
        const charId = currentChatCharId;
        if (window.readTogetherData[charId]) {
          window.readTogetherData[charId].active = false;
          localforage.setItem("readTogetherData", window.readTogetherData);
        }
        renderBookshelf();
        renderCurrentReading();
        hideFloatingBtn();
        showToast("⏸️ 已暂停阅读");
      }

      // 删除书籍
      function deleteBook(bookId) {
        if (!confirm("确定要从书架删除这本书吗？")) return;

        window.bookshelfData = window.bookshelfData.filter(
          (b) => b.id !== bookId
        );
        localforage.setItem("bookshelfData", window.bookshelfData);

        // 如果正在阅读这本书，停止阅读
        const charId = currentChatCharId;
        if (window.readTogetherData[charId]?.bookId === bookId) {
          delete window.readTogetherData[charId];
          localforage.setItem("readTogetherData", window.readTogetherData);
        }

        renderBookshelf();
        renderCurrentReading();
        hideFloatingBtn();
        showToast("✕ 书籍已删除");
      }

      // 翻页功能
      function readPrevSection() {
        const charId = currentChatCharId;
        const data = window.readTogetherData[charId];
        if (!data || !data.active) return;

        const book = window.bookshelfData.find((b) => b.id === data.bookId);
        if (!book || book.currentIndex <= 0) return;

        book.currentIndex--;
        localforage.setItem("bookshelfData", window.bookshelfData);
        renderCurrentReading();
        updateFloatingPanel();
      }

      function readNextSection() {
        const charId = currentChatCharId;
        const data = window.readTogetherData[charId];
        if (!data || !data.active) return;

        const book = window.bookshelfData.find((b) => b.id === data.bookId);
        if (!book || book.currentIndex >= book.chunks.length - 1) return;

        book.currentIndex++;
        localforage.setItem("bookshelfData", window.bookshelfData);
        renderCurrentReading();
        updateFloatingPanel();
      }

      function jumpToSection() {
        const charId = currentChatCharId;
        const data = window.readTogetherData[charId];
        if (!data || !data.active) return;

        const book = window.bookshelfData.find((b) => b.id === data.bookId);
        if (!book) return;

        const target =
          parseInt(document.getElementById("readJumpTo").value) - 1;
        if (target >= 0 && target < book.chunks.length) {
          book.currentIndex = target;
          localforage.setItem("bookshelfData", window.bookshelfData);
          renderCurrentReading();
          updateFloatingPanel();
          showToast("已跳转到第 " + (target + 1) + " 页");
        }
      }

      // ==================== 悬浮窗功能 ====================
      function startFloatingMode() {
        closeReadTogether();
        showFloatingBtn();
        showToast("• 悬浮窗已开启，点击≡按钮可查看当前内容");
      }

      function showFloatingBtn() {
        document.getElementById("readFloatingBtn").classList.add("active");
      }

      function hideFloatingBtn() {
        document.getElementById("readFloatingBtn").classList.remove("active");
        document.getElementById("readFloatingPanel").classList.remove("active");
      }

      function toggleFloatingPanel() {
        const panel = document.getElementById("readFloatingPanel");
        if (panel.classList.contains("active")) {
          panel.classList.remove("active");
        } else {
          updateFloatingPanel();
          panel.classList.add("active");
        }
      }

      function hideFloatingPanel() {
        document.getElementById("readFloatingPanel").classList.remove("active");
      }

      function updateFloatingPanel() {
        const charId = currentChatCharId;
        const data = window.readTogetherData[charId];
        if (!data || !data.active) return;

        const book = window.bookshelfData.find((b) => b.id === data.bookId);
        if (!book) return;

        document.getElementById("floatBookTitle").textContent = book.bookName;
        document.getElementById("floatProgress").textContent = `第${
          book.currentIndex + 1
        }页 / 共${book.chunks.length}页`;
        document.getElementById("floatContent").textContent =
          book.chunks[book.currentIndex] || "（已读完）";
      }

      // 悬浮窗拖动功能
      (function initFloatingPanelDrag() {
        document.addEventListener("DOMContentLoaded", function () {
          const panel = document.getElementById("readFloatingPanel");
          const header = document.getElementById("floatPanelHeader");
          if (!panel || !header) return;

          let isDragging = false;
          let startX, startY, startLeft, startTop;

          header.addEventListener("mousedown", startDrag);
          header.addEventListener("touchstart", startDrag, { passive: false });

          function startDrag(e) {
            if (e.target.classList.contains("read-float-close")) return;
            isDragging = true;

            const rect = panel.getBoundingClientRect();
            startLeft = rect.left;
            startTop = rect.top;

            if (e.type === "touchstart") {
              startX = e.touches[0].clientX;
              startY = e.touches[0].clientY;
            } else {
              startX = e.clientX;
              startY = e.clientY;
            }

            // 移除bottom/right定位，改用left/top
            panel.style.left = startLeft + "px";
            panel.style.top = startTop + "px";
            panel.style.right = "auto";
            panel.style.bottom = "auto";

            document.addEventListener("mousemove", onDrag);
            document.addEventListener("mouseup", stopDrag);
            document.addEventListener("touchmove", onDrag, { passive: false });
            document.addEventListener("touchend", stopDrag);

            e.preventDefault();
          }

          function onDrag(e) {
            if (!isDragging) return;

            let currentX, currentY;
            if (e.type === "touchmove") {
              currentX = e.touches[0].clientX;
              currentY = e.touches[0].clientY;
            } else {
              currentX = e.clientX;
              currentY = e.clientY;
            }

            const deltaX = currentX - startX;
            const deltaY = currentY - startY;

            let newLeft = startLeft + deltaX;
            let newTop = startTop + deltaY;

            // 边界限制
            const maxLeft = window.innerWidth - panel.offsetWidth;
            const maxTop = window.innerHeight - panel.offsetHeight;
            newLeft = Math.max(0, Math.min(newLeft, maxLeft));
            newTop = Math.max(0, Math.min(newTop, maxTop));

            panel.style.left = newLeft + "px";
            panel.style.top = newTop + "px";

            e.preventDefault();
          }

          function stopDrag() {
            isDragging = false;
            document.removeEventListener("mousemove", onDrag);
            document.removeEventListener("mouseup", stopDrag);
            document.removeEventListener("touchmove", onDrag);
            document.removeEventListener("touchend", stopDrag);
          }
        });
      })();

      // 悬浮窗缩放功能（支持触摸）
      (function initFloatingPanelResize() {
        document.addEventListener("DOMContentLoaded", function () {
          const panel = document.getElementById("readFloatingPanel");
          const handle = document.getElementById("floatResizeHandle");
          if (!panel || !handle) return;

          let isResizing = false;
          let startX, startY, startWidth, startHeight;

          handle.addEventListener("mousedown", startResize);
          handle.addEventListener("touchstart", startResize, {
            passive: false,
          });

          function startResize(e) {
            isResizing = true;

            startWidth = panel.offsetWidth;
            startHeight = panel.offsetHeight;

            if (e.type === "touchstart") {
              startX = e.touches[0].clientX;
              startY = e.touches[0].clientY;
            } else {
              startX = e.clientX;
              startY = e.clientY;
            }

            document.addEventListener("mousemove", onResize);
            document.addEventListener("mouseup", stopResize);
            document.addEventListener("touchmove", onResize, {
              passive: false,
            });
            document.addEventListener("touchend", stopResize);

            e.preventDefault();
            e.stopPropagation();
          }

          function onResize(e) {
            if (!isResizing) return;

            let currentX, currentY;
            if (e.type === "touchmove") {
              currentX = e.touches[0].clientX;
              currentY = e.touches[0].clientY;
            } else {
              currentX = e.clientX;
              currentY = e.clientY;
            }

            const deltaX = currentX - startX;
            const deltaY = currentY - startY;

            let newWidth = startWidth + deltaX;
            let newHeight = startHeight + deltaY;

            // 限制最小/最大尺寸
            newWidth = Math.max(
              200,
              Math.min(newWidth, window.innerWidth * 0.9)
            );
            newHeight = Math.max(
              150,
              Math.min(newHeight, window.innerHeight * 0.7)
            );

            panel.style.width = newWidth + "px";
            panel.style.height = newHeight + "px";

            e.preventDefault();
          }

          function stopResize() {
            isResizing = false;
            document.removeEventListener("mousemove", onResize);
            document.removeEventListener("mouseup", stopResize);
            document.removeEventListener("touchmove", onResize);
            document.removeEventListener("touchend", stopResize);
          }
        });
      })();

      // 打开对话时检查是否需要显示悬浮按钮
      function checkFloatingBtn() {
        const charId = currentChatCharId;
        const data = window.readTogetherData[charId];
        if (data && data.active) {
          // 不自动显示悬浮按钮，让用户主动开启
        }
      }

      // 获取当前阅读内容（供AI使用）
      function getCurrentReadingContent() {
        const charId = currentChatCharId;
        const data = window.readTogetherData[charId];
        if (!data || !data.active) return null;

        const book = window.bookshelfData.find((b) => b.id === data.bookId);
        if (!book) return null;

        return {
          bookName: book.bookName,
          currentSection: book.chunks[book.currentIndex],
          sectionIndex: book.currentIndex + 1,
          totalSections: book.chunks.length,
        };
      }

      // 保留这个函数但不再自动调用
      function advanceReadingProgress() {
        // 已禁用自动翻页功能，用户手动翻页
      }

      // ==================== 待办事项功能 ====================
      window.todoList = [];
      window.todoAiBindings = {};
      window.currentTodoFilter = "all";

      // 默认分类
      window.todoCategories = [
        { id: "self", emoji: "★", name: "自我" },
        { id: "health", emoji: "○", name: "健康" },
        { id: "study", emoji: "≡", name: "学习" },
        { id: "work", emoji: "○", name: "工作" },
        { id: "life", emoji: "○", name: "生活" },
      ];

      // 自定义设置
      window.todoSettings = {
        title: "我的小本本",
        greeting: { main: "今天也要加油鸭！", sub: "新的一天，新的开始~" },
      };

      async function initTodoSystem() {
        try {
          const savedTodos = await safeLocalforageGet("todoList");
          window.todoList = savedTodos || [];

          const savedBindings = await safeLocalforageGet("todoAiBindings");
          window.todoAiBindings = savedBindings || {};

          const savedCategories = await safeLocalforageGet("todoCategories");
          if (savedCategories && savedCategories.length > 0)
            window.todoCategories = savedCategories;

          const savedSettings = await safeLocalforageGet("todoSettings");
          if (savedSettings)
            window.todoSettings = { ...window.todoSettings, ...savedSettings };

          renderTodoFilterBar();
          renderTodoList();
          renderTodoAiCharList();
          updateTodoDate();
          updateTodoStats();

          // 更新标题
          const titleEl = document.getElementById("todoTitleText");
          if (titleEl) titleEl.textContent = window.todoSettings.title;
        } catch (e) {
          console.error("待办初始化失败", e);
        }
      }

      function updateTodoDate() {
        const now = new Date();
        const dayEl = document.getElementById("todoDateDay");
        const monthEl = document.getElementById("todoDateMonth");
        const weekdayEl = document.getElementById("todoDateWeekday");
        const weekdays = [
          "周日",
          "周一",
          "周二",
          "周三",
          "周四",
          "周五",
          "周六",
        ];

        if (dayEl) dayEl.textContent = now.getDate();
        if (monthEl) monthEl.textContent = now.getMonth() + 1 + "月";
        if (weekdayEl) weekdayEl.textContent = weekdays[now.getDay()];

        // 显示统一问候语
        const greeting = window.todoSettings.greeting || {
          main: "今天也要加油鸭！",
          sub: "新的一天，新的开始~",
        };
        const greetingEl = document.getElementById("todoGreeting");
        const subEl = document.getElementById("todoGreetingSub");
        if (greetingEl) greetingEl.textContent = greeting.main;
        if (subEl) subEl.textContent = greeting.sub;
      }

      function updateTodoStats() {
        const total = window.todoList.length;
        const done = window.todoList.filter((t) => t.done).length;
        document.getElementById("todoStatTotal")?.textContent &&
          (document.getElementById("todoStatTotal").textContent = total);
        document.getElementById("todoStatDone")?.textContent &&
          (document.getElementById("todoStatDone").textContent = done);
        document.getElementById("todoStatPending")?.textContent &&
          (document.getElementById("todoStatPending").textContent =
            total - done);
      }

      function renderTodoFilterBar() {
        const bar = document.getElementById("todoFilterBar");
        if (!bar) return;

        let html = `<button class="todo-filter-btn ${
          window.currentTodoFilter === "all" ? "active" : ""
        }" onclick="filterTodos('all')">◇ 全部</button>`;
        window.todoCategories.forEach((cat) => {
          html += `<button class="todo-filter-btn ${
            window.currentTodoFilter === cat.id ? "active" : ""
          }" onclick="filterTodos('${cat.id}')">${cat.emoji} ${
            cat.name
          }</button>`;
        });
        bar.innerHTML = html;
      }

      function filterTodos(filter) {
        window.currentTodoFilter = filter;
        renderTodoFilterBar();
        renderTodoList();
      }

      function renderTodoList() {
        const container = document.getElementById("todoListContainer");
        if (!container) return;

        let todos = window.todoList;
        if (window.currentTodoFilter !== "all") {
          todos = todos.filter((t) => t.tag === window.currentTodoFilter);
        }

        if (todos.length === 0) {
          container.innerHTML = `<div class="todo-empty-state"><div class="todo-empty-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg></div><div class="todo-empty-text">还没有待办事项</div><div class="todo-empty-hint">点击下方按钮添加一个吧~</div></div>`;
          return;
        }

        todos = [...todos].sort((a, b) => {
          if (a.done !== b.done) return a.done ? 1 : -1;
          return b.createdAt - a.createdAt;
        });

        let html = "";
        todos.forEach((todo) => {
          const cat = window.todoCategories.find((c) => c.id === todo.tag) || {
            name: "其他",
            emoji: "•",
          };
          html += `
            <div class="todo-item ${todo.done ? "done" : ""}" data-id="${
            todo.id
          }">
              <div class="todo-checkbox" onclick="toggleTodoDone('${
                todo.id
              }')">${todo.done ? "✓" : ""}</div>
              <div class="todo-content" onclick="toggleTodoDone('${todo.id}')">
                <div class="todo-text">${escapeHtml(todo.text)}</div>
                <div class="todo-meta"><span class="todo-time">${formatTodoTime(
                  todo.createdAt
                )}</span></div>
              </div>
              <div class="todo-tag tag-${todo.tag}">${cat.name}</div>
              <button class="todo-delete-btn" onclick="deleteTodoItem('${
                todo.id
              }')">✕</button>
            </div>`;
        });
        container.innerHTML = html;
      }

      function formatTodoTime(ts) {
        const d = new Date(ts),
          now = new Date();
        if (d.toDateString() === now.toDateString())
          return (
            "今天 " +
            d.getHours().toString().padStart(2, "0") +
            ":" +
            d.getMinutes().toString().padStart(2, "0")
          );
        const y = new Date(now);
        y.setDate(y.getDate() - 1);
        if (d.toDateString() === y.toDateString()) return "昨天";
        return d.getMonth() + 1 + "/" + d.getDate();
      }

      function escapeHtml(t) {
        const d = document.createElement("div");
        d.textContent = t;
        return d.innerHTML;
      }

      function openTodoModal() {
        const modal = document.getElementById("todoModalOverlay");
        if (modal) {
          modal.classList.add("active");
          document.getElementById("todoInputText").value = "";
          renderTodoTagSelect();
          document.getElementById("todoInputText").focus();
        }
      }

      function renderTodoTagSelect() {
        const container = document.getElementById("todoTagSelect");
        if (!container) return;
        let html = "";
        window.todoCategories.forEach((cat, i) => {
          html += `<div class="todo-tag-option ${
            i === 0 ? "selected" : ""
          }" data-tag="${cat.id}" onclick="selectTodoTag(this)">${cat.emoji} ${
            cat.name
          }</div>`;
        });
        container.innerHTML = html;
      }

      function closeTodoModal() {
        document.getElementById("todoModalOverlay")?.classList.remove("active");
      }
      function selectTodoTag(el) {
        document
          .querySelectorAll(".todo-tag-option")
          .forEach((o) => o.classList.remove("selected"));
        el.classList.add("selected");
      }

      async function saveTodoItem() {
        const text = document.getElementById("todoInputText").value.trim();
        if (!text) {
          showToast("请输入待办内容");
          return;
        }
        const sel = document.querySelector(".todo-tag-option.selected");
        const tag = sel
          ? sel.dataset.tag
          : window.todoCategories[0]?.id || "self";
        window.todoList.push({
          id: "todo_" + Date.now(),
          text,
          tag,
          done: false,
          createdAt: Date.now(),
        });
        await localforage.setItem("todoList", window.todoList);
        closeTodoModal();
        renderTodoList();
        updateTodoStats();
        showToast("添加成功！");
      }

      async function toggleTodoDone(id) {
        const todo = window.todoList.find((t) => t.id === id);
        if (todo) {
          const wasDone = todo.done;
          todo.done = !todo.done;
          todo.doneAt = todo.done ? Date.now() : null;
          await localforage.setItem("todoList", window.todoList);
          renderTodoList();
          updateTodoStats();

          if (todo.done && !wasDone) {
            showToast("太棒了！完成一项 ♪");
            // 通知所有绑定的AI角色
            notifyAiTodoCompleted(todo);
          }
        }
      }

      // 通知AI用户完成了待办事项
      async function notifyAiTodoCompleted(todo) {
        const bindingIds = Object.keys(window.todoAiBindings).filter(
          (id) => window.todoAiBindings[id]
        );
        if (bindingIds.length === 0) return;

        const category = window.todoCategories.find(
          (c) => c.id === todo.category
        );
        const categoryName = category ? category.name : "其他";

        for (const charId of bindingIds) {
          const char = characters.find((c) => String(c.id) === charId);
          if (!char) continue;

          // 【修复】确保charId类型与chatHistories中的key一致（转为数字）
          const numCharId = parseInt(charId) || charId;
          let history = chatHistories[numCharId] || [];

          history.push({
            role: "user",
            content: `[系统提示: 用户刚刚完成了一项待办事项「${todo.text}」(分类:${categoryName})，请根据你的人设简短地夸奖或鼓励用户！]`,
            isSystemHint: true,
            timestamp: Date.now(),
          });

          // 【修复】更新内存和正确保存
          chatHistories[numCharId] = history;
          await localforage.setItem("chatHistories", chatHistories);
        }
      }

      async function deleteTodoItem(id) {
        if (!confirm("确定要删除这条待办吗？")) return;
        window.todoList = window.todoList.filter((t) => t.id !== id);
        await localforage.setItem("todoList", window.todoList);
        renderTodoList();
        updateTodoStats();
        showToast("已删除");
      }

      function renderTodoAiCharList() {
        const container = document.getElementById("todoAiCharList");
        if (!container) return;
        if (!characters || characters.length === 0) {
          container.innerHTML = `<div class="todo-ai-empty">还没有创建角色哦~</div>`;
          return;
        }
        let html = "";
        characters.forEach((char) => {
          const charId = String(char.id);
          const isActive = window.todoAiBindings[charId];
          const avatar = char.avatar
            ? `<img src="${char.avatar}" alt="">`
            : char.name
            ? char.name.charAt(0)
            : "?";
          html += `<button class="todo-ai-char-btn ${
            isActive ? "active" : ""
          }" onclick="toggleTodoAiBinding('${charId}')"><div class="todo-ai-char-avatar">${avatar}</div><span>${
            char.name || "未命名"
          }</span></button>`;
        });
        container.innerHTML = html;
      }

      async function toggleTodoAiBinding(charId) {
        if (window.todoAiBindings[charId]) {
          delete window.todoAiBindings[charId];
          showToast("已取消督促");
        } else {
          window.todoAiBindings[charId] = true;
          const char = characters.find((c) => String(c.id) === charId);
          showToast(`${char?.name || "TA"}会督促你完成待办哦~`);
          // AI主动发起对话
          aiGreetForTodoBinding(charId);
        }
        await localforage.setItem("todoAiBindings", window.todoAiBindings);
        renderTodoAiCharList();
      }

      // AI被选为督促助手时主动发起对话
      async function aiGreetForTodoBinding(charId) {
        const char = characters.find((c) => String(c.id) === charId);
        if (!char) return;

        console.log("AI督促助手问候开始:", char.name);

        const pending = window.todoList.filter((t) => !t.done);
        const todoSummary =
          pending.length > 0
            ? pending
                .slice(0, 5)
                .map((t) => `「${t.text}」`)
                .join("、") + (pending.length > 5 ? "等" : "")
            : "暂无待办事项";

        const settings = chatSettings[charId] || {};
        const persona =
          settings.persona || `你是${char.name}，一个友善的AI助手。`;

        const prompt = `${persona}

[场景设定]
用户刚刚在待办事项应用中选择你作为督促小助手。你现在可以看到用户的待办列表了。

当前待办事项: ${todoSummary}
待办总数: ${window.todoList.length}项，已完成: ${
          window.todoList.filter((t) => t.done).length
        }项

请以你的人设身份，用简短的1-2句话回应用户，表示你看到了他们的待办列表，并根据你的性格特点展开一个简短的话题或给予鼓励。记住保持角色特色！`;

        try {
          const apiPreset =
            apiPresets.find((p) => p.id === settings.apiPreset) ||
            apiPresets[0];
          if (!apiPreset || !apiPreset.key) {
            console.log("未配置API，跳过AI问候");
            return;
          }

          // 处理API URL - 确保以/chat/completions结尾
          let apiUrl = apiPreset.url.replace(/\/$/, "");
          if (!apiUrl.endsWith("/chat/completions")) {
            if (apiUrl.endsWith("/v1")) {
              apiUrl += "/chat/completions";
            } else if (apiUrl.includes("/v1/")) {
              // URL中间有/v1/但不是结尾，可能已经是完整路径
              if (!apiUrl.includes("/chat/completions")) {
                apiUrl += "/chat/completions";
              }
            } else {
              apiUrl += "/v1/chat/completions";
            }
          }

          console.log("API调用URL:", apiUrl);

          // 构建系统提示词 - 强调只输出一条回复
          const systemPrompt = `${persona}

【重要规则】你必须直接用1-2句话回应，不要列举多个选项，不要编号，不要解释，不要任何前缀。`;

          const userMessage = `用户刚刚选你当待办督促助手。待办列表: ${todoSummary}。请直接回应（1-2句话）:`;

          // 构建请求body - 使用system+user的标准格式，添加stream:false
          const requestBody = {
            model: apiPreset.model,
            messages: [
              { role: "system", content: systemPrompt },
              { role: "user", content: userMessage },
            ],
            temperature: 0.8,
            stream: false,
          };

          console.log("请求参数:", JSON.stringify(requestBody));

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${apiPreset.key}`,
            },
            body: JSON.stringify(requestBody),
          });

          if (!response.ok) {
            const errText = await response.text();
            console.error("API请求失败:", response.status, errText);
            return;
          }

          const data = await response.json();
          console.log("API完整返回:", JSON.stringify(data));

          // 兼容不同模型的返回格式
          const choice = data.choices?.[0];
          let aiReply = choice?.message?.content;

          // 如果content为空，尝试其他可能的字段（推理模型可能把内容放在其他地方）
          if (!aiReply && choice?.message?.reasoning_content) {
            aiReply = choice.message.reasoning_content;
          }
          if (!aiReply && choice?.message?.reasoning) {
            aiReply = choice.message.reasoning;
          }
          if (!aiReply && choice?.text) {
            aiReply = choice.text;
          }
          // 某些API会返回delta格式
          if (!aiReply && choice?.delta?.content) {
            aiReply = choice.delta.content;
          }

          console.log("AI回复:", aiReply);

          // 如果还是空的，检测是否是推理模型问题
          if (!aiReply) {
            const hasReasoningTokens =
              data.usage?.reasoning_tokens > 0 ||
              data.usage?.completion_tokens_details?.reasoning_tokens > 0;
            if (hasReasoningTokens) {
              console.warn(
                "检测到推理模型返回空内容，这可能是API中转的问题。建议更换为非推理模型（如gpt-4o-mini, claude-3-haiku等）"
              );
              showToast(
                `${char.name}已成为督促助手（推理模型暂不支持自动回复）`
              );

              // 【修复】确保charId类型与chatHistories中的key一致（转为数字）
              const numCharId = parseInt(charId) || charId;
              let history = chatHistories[numCharId] || [];
              history.push({
                role: "assistant",
                content: `[我现在是你的待办督促助手啦！有什么需要帮忙的随时找我~]`,
                timestamp: Date.now(),
              });
              // 【修复】更新内存和正确保存
              chatHistories[numCharId] = history;
              await localforage.setItem("chatHistories", chatHistories);
              return;
            }
          }

          // 如果还是空的，可能是推理模型需要更多token或不同的请求方式
          if (!aiReply) {
            console.log("AI回复为空，尝试使用简化prompt重新请求");
            // 用更简单的prompt再试一次
            const simplePrompt = `你是${char.name}。用户刚刚选你当待办督促助手，请用1句话简短回应，表示你会帮助督促他完成待办事项。直接说话，不要任何前缀。`;

            const retryResponse = await fetch(apiUrl, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${apiPreset.key}`,
              },
              body: JSON.stringify({
                model: apiPreset.model,
                messages: [{ role: "user", content: simplePrompt }],
                max_tokens: 100,
                temperature: 0.7,
              }),
            });

            if (retryResponse.ok) {
              const retryData = await retryResponse.json();
              console.log("重试API返回:", JSON.stringify(retryData));
              aiReply = retryData.choices?.[0]?.message?.content;
            }
          }

          if (aiReply) {
            // 【修复】确保charId类型与chatHistories中的key一致（转为数字）
            const numCharId = parseInt(charId) || charId;
            let history = chatHistories[numCharId] || [];

            // 使用系统卡片形式而不是普通消息
            history.push({
              role: "system",
              type: "system-card",
              cardType: "todo-binding",
              cardIcon: "≡",
              cardTitle: "已设为待办督促助手",
              cardDesc: "Ta 将帮你督促完成待办事项",
              timestamp: Date.now(),
            });

            history.push({
              role: "assistant",
              content: aiReply,
              timestamp: Date.now(),
            });

            // 更新内存中的聊天记录
            chatHistories[numCharId] = history;

            // 【修复】正确保存到chatHistories对象
            await localforage.setItem("chatHistories", chatHistories);

            // 更新角色的lastMessage用于消息列表显示
            // 【修复】使用String比较确保类型一致
            const charIndex = characters.findIndex(
              (c) => String(c.id) === String(charId)
            );
            if (charIndex !== -1) {
              characters[charIndex].lastMessage =
                aiReply.slice(0, 30) + (aiReply.length > 30 ? "..." : "");
              characters[charIndex].lastTime = "刚刚";
              await localforage.setItem("characters", characters);
              // 【修复】刷新消息列表界面
              renderCharacters();
            }

            // 显示通知弹窗
            showMessageNotification(charId, char.name, char.avatar, aiReply);

            // 增加未读消息计数
            addUnreadMessage(charId);
          } else {
            console.log("AI回复最终为空");
            showToast(`${char.name}已成为你的督促助手~`);
          }
        } catch (e) {
          console.error("AI问候失败:", e);
        }
      }

      // ========== 设置弹窗 ==========
      function openTodoSettingsModal() {
        const modal = document.getElementById("todoSettingsOverlay");
        if (modal) {
          modal.classList.add("active");
          document.getElementById("todoSettingsTitle").value =
            window.todoSettings.title;
          renderCategoryList();
          loadGreetingForEdit();
        }
      }

      function closeTodoSettingsModal() {
        document
          .getElementById("todoSettingsOverlay")
          ?.classList.remove("active");
      }

      function renderCategoryList() {
        const container = document.getElementById("todoCategoryList");
        if (!container) return;
        let html = "";
        window.todoCategories.forEach((cat, i) => {
          const canDelete = window.todoCategories.length > 1;
          html += `<div class="todo-category-item"><div class="todo-category-emoji">${
            cat.emoji
          }</div><div class="todo-category-name">${
            cat.name
          }</div><button class="todo-category-delete" onclick="deleteTodoCategory(${i})" ${
            canDelete ? "" : "disabled"
          }>✕</button></div>`;
        });
        container.innerHTML = html;
      }

      async function addTodoCategory() {
        const emoji =
          document.getElementById("newCategoryEmoji").value.trim() || "•";
        const name = document.getElementById("newCategoryName").value.trim();
        if (!name) {
          showToast("请输入分类名称");
          return;
        }
        if (window.todoCategories.some((c) => c.name === name)) {
          showToast("分类已存在");
          return;
        }
        const id = "cat_" + Date.now();
        window.todoCategories.push({ id, emoji, name });
        await localforage.setItem("todoCategories", window.todoCategories);
        document.getElementById("newCategoryEmoji").value = "";
        document.getElementById("newCategoryName").value = "";
        renderCategoryList();
        showToast("分类添加成功！");
      }

      async function deleteTodoCategory(index) {
        if (window.todoCategories.length <= 1) return;
        const cat = window.todoCategories[index];
        if (!confirm(`确定删除「${cat.name}」分类吗？`)) return;
        window.todoCategories.splice(index, 1);
        await localforage.setItem("todoCategories", window.todoCategories);
        renderCategoryList();
        showToast("已删除");
      }

      function loadGreetingForEdit() {
        const g = window.todoSettings.greeting || { main: "", sub: "" };
        document.getElementById("greetingMainInput").value = g.main;
        document.getElementById("greetingSubInput").value = g.sub;
        document.getElementById("greetingPreviewMain").textContent =
          g.main || "(未设置)";
        document.getElementById("greetingPreviewSub").textContent = g.sub || "";
      }

      async function saveGreeting() {
        const main = document.getElementById("greetingMainInput").value.trim();
        const sub = document.getElementById("greetingSubInput").value.trim();
        if (!main) {
          showToast("请输入主问候语");
          return;
        }
        window.todoSettings.greeting = { main, sub };
        await localforage.setItem("todoSettings", window.todoSettings);
        document.getElementById("greetingPreviewMain").textContent = main;
        document.getElementById("greetingPreviewSub").textContent = sub;
        updateTodoDate();
        showToast("问候语已保存！");
      }

      async function saveTodoSettings() {
        const title =
          document.getElementById("todoSettingsTitle").value.trim() ||
          "我的小本本";
        window.todoSettings.title = title;
        await localforage.setItem("todoSettings", window.todoSettings);
        document.getElementById("todoTitleText").textContent = title;
        closeTodoSettingsModal();
        renderTodoFilterBar();
        updateTodoDate();
        showToast("设置已保存！");
      }

      function generateTodoPromptForAi(charId) {
        const id = String(charId);
        if (!window.todoAiBindings[id]) return "";
        const pending = window.todoList.filter((t) => !t.done);
        const doneToday = window.todoList.filter(
          (t) =>
            t.done &&
            t.doneAt &&
            new Date(t.doneAt).toDateString() === new Date().toDateString()
        );
        if (pending.length === 0 && doneToday.length === 0) return "";

        let prompt =
          "\n\n【待办事项】用户让你帮忙督促TA完成待办，请在对话中自然地关心和提醒，但不要每条消息都提，大约每3-5条消息自然地提一次就好。语气要温柔鼓励。\n";
        if (pending.length > 0) {
          const texts = pending
            .slice(0, 5)
            .map((t) => t.text)
            .join("、");
          prompt += `还有${pending.length}项待办没完成：${texts}。可以偶尔温柔地问问进度，鼓励TA完成。\n`;
        }
        if (doneToday.length > 0)
          prompt += `今天已经完成了${doneToday.length}项，很棒！可以适时夸夸TA。\n`;
        prompt +=
          "记住：主要还是正常聊天，待办督促只是附加功能，要自然地融入对话，不要生硬。";
        return prompt;
      }
      // ==================== 经期记录系统 ====================
      window.periodData = {
        lastPeriodDate: null,
        cycleLength: 28,
        duration: 5,
        records: [],
      };

      async function initPeriodSystem() {
        try {
          const saved = await safeLocalforageGet("periodData");
          if (saved) window.periodData = { ...window.periodData, ...saved };
          updatePeriodDisplay();
          renderPeriodCalendar();
        } catch (e) {
          console.error("经期数据加载失败", e);
        }
      }

      function updatePeriodDisplay() {
        const data = window.periodData;
        const statusEl = document.getElementById("periodStatusText");
        const nextEl = document.getElementById("periodNextText");
        const progressEl = document.getElementById("periodProgressFill");
        const cycleDayEl = document.getElementById("periodCycleDay");
        const tipsEl = document.getElementById("periodTipsContent");

        if (!data.lastPeriodDate) {
          if (statusEl) statusEl.textContent = "点击设置开始记录";
          if (nextEl) nextEl.textContent = "--";
          if (cycleDayEl) cycleDayEl.textContent = "第 - 天";
          if (progressEl) progressEl.style.width = "0%";
          return;
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const lastDate = new Date(data.lastPeriodDate);
        lastDate.setHours(0, 0, 0, 0);
        const daysSince = Math.floor((today - lastDate) / 86400000);
        const cycleDay = (daysSince % data.cycleLength) + 1;
        const daysUntilNext = data.cycleLength - (daysSince % data.cycleLength);

        let status = "",
          statusClass = "safe",
          tips = "";

        if (cycleDay <= data.duration) {
          status = `经期第 ${cycleDay} 天 ●`;
          statusClass = "period";
          tips = "♡ 经期期间要多休息，注意保暖，多喝热水，保持心情愉快~";
        } else if (cycleDay >= data.cycleLength - 3) {
          status = `经期前期 (还有${daysUntilNext}天)`;
          statusClass = "warning";
          tips = "🌸 经期快来了，提前准备好，注意休息哦~";
        } else if (cycleDay >= 12 && cycleDay <= 16) {
          status = `排卵期 ◇`;
          statusClass = "safe";
          tips = "☆ 排卵期身体状态较好，是运动和学习的好时机！";
        } else {
          status = `安全期 ★`;
          statusClass = "safe";
          tips = "💪 身体状态不错，保持好心情，继续加油~";
        }

        if (statusEl) {
          statusEl.textContent = status;
          statusEl.className = `period-status-value ${statusClass}`;
        }
        if (nextEl) {
          nextEl.textContent = `${daysUntilNext} 天后`;
          nextEl.className = `period-status-value ${
            daysUntilNext <= 3 ? "warning" : "safe"
          }`;
        }
        if (cycleDayEl) cycleDayEl.textContent = `第 ${cycleDay} 天`;
        if (progressEl)
          progressEl.style.width = (cycleDay / data.cycleLength) * 100 + "%";
        if (tipsEl) tipsEl.textContent = tips;
      }

      function renderPeriodCalendar() {
        const cal = document.getElementById("periodCalendar");
        if (!cal) return;
        const data = window.periodData;
        const today = new Date();
        const year = today.getFullYear(),
          month = today.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        let html = `<div class="period-cal-header">日</div><div class="period-cal-header">一</div><div class="period-cal-header">二</div><div class="period-cal-header">三</div><div class="period-cal-header">四</div><div class="period-cal-header">五</div><div class="period-cal-header">六</div>`;

        for (let i = 0; i < firstDay.getDay(); i++)
          html += `<div class="period-cal-day empty"></div>`;

        for (let day = 1; day <= lastDay.getDate(); day++) {
          const date = new Date(year, month, day);
          let cls = ["period-cal-day"];
          if (day === today.getDate()) cls.push("today");

          if (data.lastPeriodDate) {
            const lastDate = new Date(data.lastPeriodDate);
            const daysDiff = Math.floor((date - lastDate) / 86400000);
            if (daysDiff >= 0) {
              const cycleDay = (daysDiff % data.cycleLength) + 1;
              if (cycleDay <= data.duration) cls.push("period");
              else if (cycleDay >= 12 && cycleDay <= 16) cls.push("ovulation");
            }
          }
          html += `<div class="${cls.join(" ")}">${day}</div>`;
        }
        cal.innerHTML = html;
      }

      function openPeriodModal() {
        const modal = document.getElementById("periodModalOverlay");
        if (modal) {
          modal.classList.add("active");
          const data = window.periodData;
          if (data.lastPeriodDate)
            document.getElementById("periodLastDate").value =
              data.lastPeriodDate;
          document.getElementById("periodCycleLength").value =
            data.cycleLength || 28;
          document.getElementById("periodDuration").value = data.duration || 5;
        }
      }

      function closePeriodModal() {
        const modal = document.getElementById("periodModalOverlay");
        if (modal) modal.classList.remove("active");
      }

      async function savePeriodSettings() {
        const lastDate = document.getElementById("periodLastDate").value;
        const cycleLength =
          parseInt(document.getElementById("periodCycleLength").value) || 28;
        const duration =
          parseInt(document.getElementById("periodDuration").value) || 5;

        if (!lastDate) {
          showToast("请选择上次经期日期");
          return;
        }

        window.periodData.lastPeriodDate = lastDate;
        window.periodData.cycleLength = Math.max(21, Math.min(45, cycleLength));
        window.periodData.duration = Math.max(2, Math.min(10, duration));

        await localforage.setItem("periodData", window.periodData);
        closePeriodModal();
        updatePeriodDisplay();
        renderPeriodCalendar();
        showToast("设置已保存 ♡");
      }

      async function recordPeriodStart() {
        const today = new Date().toISOString().split("T")[0];
        if (window.periodData.lastPeriodDate === today) {
          showToast("今天已经记录过啦~");
          return;
        }

        window.periodData.lastPeriodDate = today;
        window.periodData.records.push({ date: today, type: "start" });
        await localforage.setItem("periodData", window.periodData);

        updatePeriodDisplay();
        renderPeriodCalendar();
        showToast("已记录，要多注意休息哦 ♡");
      }

      // 生成经期提示词（所有AI角色都能看到）
      function generatePeriodPromptForAi() {
        const data = window.periodData;
        if (!data.lastPeriodDate) return "";

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const lastDate = new Date(data.lastPeriodDate);
        lastDate.setHours(0, 0, 0, 0);
        const daysSince = Math.floor((today - lastDate) / 86400000);
        const cycleDay = (daysSince % data.cycleLength) + 1;

        let prompt = "";

        if (cycleDay <= data.duration) {
          prompt = `\n\n【特别关心】用户目前正处于生理期第${cycleDay}天，请在对话中自然地表达关心：
- 偶尔温柔地问候身体状况
- 提醒多休息、注意保暖、多喝热水
- 语气要更加温柔体贴
- 如果用户表示不舒服，要给予安慰和关心
- 不要每条消息都提，自然地穿插在对话中即可`;
        } else if (cycleDay >= data.cycleLength - 3) {
          prompt = `\n\n【温馨提醒】用户的生理期预计在${
            data.cycleLength - cycleDay + 1
          }天后到来，如果聊天中合适的话，可以温柔地提醒注意休息，但不要刻意提起。`;
        }

        return prompt;
      }

      // ==================== Instagram风格动态系统 ====================
      window.momentsData = {
        posts: [], // 所有动态
        userProfile: {
          avatar: "A",
          avatarImg: null,
          name: "我的昵称",
          handle: "@username",
          bio: "点击头像编辑个人资料和签名~",
        },
      };

      // 初始化动态系统
      async function initMomentsSystem() {
        const saved = await safeLocalforageGet("momentsData");
        if (saved) {
          window.momentsData = saved;
        }
        renderMomentsUI();
        renderStoriesBar();
      }

      // 渲染动态页面UI
      function renderMomentsUI() {
        const data = window.momentsData;
        const profile = data.userProfile;

        // 更新Story头像
        const storyAvatar = document.getElementById("myStoryAvatar");
        if (storyAvatar) {
          if (profile.avatarImg) {
            storyAvatar.innerHTML = `<img src="${profile.avatarImg}" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`;
          } else {
            storyAvatar.innerHTML = `<span class="ig-story-avatar-emoji">${
              profile.avatar || "A"
            }</span>`;
          }
        }

        // 渲染动态列表
        renderFeed();
      }

      // 渲染Stories条
      function renderStoriesBar() {
        const container = document.getElementById("igStoriesContainer");
        const profile = window.momentsData.userProfile;

        // 先保留用户自己的Story
        let html = `
          <div class="ig-story-item" onclick="openPostModal()">
            <div class="ig-story-ring my-story">
              <div class="ig-story-avatar" id="myStoryAvatar">
                ${
                  profile.avatarImg
                    ? `<img src="${profile.avatarImg}" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`
                    : `<span class="ig-story-avatar-emoji">${
                        profile.avatar || "A"
                      }</span>`
                }
              </div>
              <div class="ig-story-add">+</div>
            </div>
            <span class="ig-story-name">你的动态</span>
          </div>
        `;

        // 添加AI角色的Stories
        if (window.characters && window.characters.length > 0) {
          window.characters.forEach((char) => {
            const hasNewPost = window.momentsData.posts.some(
              (p) =>
                p.authorId === String(char.id) &&
                Date.now() - p.timestamp < 24 * 60 * 60 * 1000
            );

            html += `
              <div class="ig-story-item" onclick="showCharacterPosts('${
                char.id
              }')">
                <div class="ig-story-ring ${hasNewPost ? "" : "no-story"}">
                  <div class="ig-story-avatar">
                    ${
                      char.avatar
                        ? `<img src="${char.avatar}" alt="${char.name}">`
                        : `<span class="ig-story-avatar-emoji">AI</span>`
                    }
                  </div>
                </div>
                <span class="ig-story-name">${char.note || char.name}</span>
              </div>
            `;
          });
        }

        container.innerHTML = html;
      }

      // 渲染动态列表
      function renderFeed() {
        const container = document.getElementById("igFeed");
        const posts = window.momentsData.posts.sort(
          (a, b) => b.timestamp - a.timestamp
        );

        if (posts.length === 0) {
          container.innerHTML = `
            <div class="ig-empty-state" id="igEmptyState">
              <div class="ig-empty-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></div>
              <div class="ig-empty-title">分享你的精彩瞬间</div>
              <div class="ig-empty-text">点击右下角按钮发布第一条动态吧~</div>
            </div>
          `;
          return;
        }

        container.innerHTML = posts
          .map((post) => renderPostCard(post))
          .join("");
      }

      // 渲染单条动态卡片
      function renderPostCard(post) {
        const profile = window.momentsData.userProfile;
        const isUser = post.isUser;

        // 获取作者信息
        let authorName, authorAvatar, authorAvatarImg;
        if (isUser) {
          authorName = profile.name;
          authorAvatar = profile.avatar;
          authorAvatarImg = profile.avatarImg;
        } else {
          const char = window.characters?.find(
            (c) => String(c.id) === post.authorId
          );
          authorName = char ? char.note || char.name : "未知用户";
          authorAvatar = "🤖";
          authorAvatarImg = char?.avatar;
        }

        // 正文内容
        let contentHtml = "";
        if (post.content && post.content.trim()) {
          contentHtml = `<div class="ig-post-content">${post.content}</div>`;
        }

        // 图片区域
        let imageHtml = "";
        if (post.image) {
          imageHtml = `<div class="ig-post-images single-img"><img src="${post.image}" alt="" onclick="showFullImage('${post.image}')"></div>`;
        } else if (post.textImage) {
          // 精美渐变背景组合
          const bgStyles = [
            {
              bg: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)",
              emoji: "★",
            },
            {
              bg: "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)",
              emoji: "○",
            },
            {
              bg: "linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)",
              emoji: "◇",
            },
            {
              bg: "linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)",
              emoji: "🌿",
            },
            {
              bg: "linear-gradient(135deg, #fa709a 0%, #fee140 100%)",
              emoji: "🌅",
            },
            {
              bg: "linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)",
              emoji: "♡",
            },
            {
              bg: "linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)",
              emoji: "🌷",
            },
            {
              bg: "linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)",
              emoji: "○",
            },
          ];
          const style = bgStyles[Math.floor(post.id) % bgStyles.length];
          imageHtml = `
            <div class="ig-post-images">
              <div class="ig-post-text-img" style="background:${style.bg}">
                <div class="text-content">
                  <span class="text-quote">"</span>
                  ${post.textImage}
                </div>
              </div>
            </div>`;
        }

        // 点赞状态和头像列表
        const liked = (post.likes || []).includes("user");
        const likeData = (post.likes || [])
          .map((likeId) => {
            if (likeId === "user") {
              return {
                name: profile.name,
                avatar: profile.avatar,
                avatarImg: profile.avatarImg,
              };
            }
            const char = window.characters?.find(
              (c) => String(c.id) === likeId
            );
            if (char) {
              return {
                name: char.note || char.name,
                avatar: "AI",
                avatarImg: char.avatar,
              };
            }
            return null;
          })
          .filter(Boolean);

        // 收藏状态
        const bookmarked = (post.bookmarks || []).includes("user");

        // 点赞显示 - 带头像
        let likesHtml = "";
        if (likeData.length > 0) {
          const avatarsHtml = likeData
            .slice(0, 5)
            .map(
              (l) =>
                `<div class="like-avatar">${
                  l.avatarImg ? `<img src="${l.avatarImg}" alt="">` : l.avatar
                }</div>`
            )
            .join("");
          const namesText =
            likeData.length <= 2
              ? likeData.map((l) => l.name).join("、")
              : `${likeData[0].name} 等 ${likeData.length} 人`;
          likesHtml = `
            <div class="ig-post-likes">
              <div class="ig-post-likes-avatars">${avatarsHtml}</div>
              <span>${namesText} 觉得很赞</span>
            </div>
          `;
        }

        // 评论
        const comments = post.comments || [];
        const previewComments = comments.slice(0, 2);

        // 评论区HTML
        let commentsHtml = "";
        if (previewComments.length > 0) {
          commentsHtml = `
            <div class="ig-post-comments">
              ${previewComments
                .map(
                  (c) => `
                <div class="ig-comment" onclick="openComments('${post.id}')">
                  <span class="username">${c.authorName}</span>${c.content}
                </div>
              `
                )
                .join("")}
            </div>
          `;
        }

        const postIdStr = String(post.id);

        return `
          <div class="ig-post" data-post-id="${postIdStr}">
            <div class="ig-post-header">
              <div class="ig-post-avatar">
                ${
                  authorAvatarImg
                    ? `<img src="${authorAvatarImg}" alt="">`
                    : authorAvatar
                }
              </div>
              <div class="ig-post-user-info">
                <div class="ig-post-username">${authorName}</div>
                <div class="ig-post-time-header">${formatPostTime(
                  post.timestamp
                )}</div>
              </div>
              <button class="ig-post-delete" onclick="confirmDeletePost('${postIdStr}')" title="删除">✕</button>
            </div>
            ${contentHtml}
            ${imageHtml}
            <div class="ig-post-footer">
              <div class="ig-post-actions">
                <button class="ig-action-btn ${
                  liked ? "liked" : ""
                }" onclick="toggleLike('${postIdStr}')">
                  ${liked ? "♡" : "♡"}<span>${likeData.length || ""}</span>
                </button>
                <button class="ig-action-btn" onclick="openComments('${postIdStr}')">
                  ○<span>${comments.length || ""}</span>
                </button>
                <button class="ig-action-btn" onclick="sharePostToChat('${postIdStr}')" title="转发到聊天">↑</button>
                <div class="ig-action-spacer"></div>
                <button class="ig-action-btn ${
                  bookmarked ? "bookmarked" : ""
                }" onclick="toggleBookmark('${postIdStr}')" title="收藏">
                  ${bookmarked ? "🔖" : "📑"}
                </button>
              </div>
              ${likesHtml}
              ${
                comments.length > 2
                  ? `<div class="ig-view-comments" onclick="openComments('${postIdStr}')">查看全部 ${comments.length} 条评论</div>`
                  : ""
              }
              ${commentsHtml}
            </div>
          </div>
        `;
      }

      // 格式化时间
      function formatPostTime(timestamp) {
        const now = Date.now();
        const diff = now - timestamp;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return "刚刚";
        if (minutes < 60) return `${minutes} 分钟前`;
        if (hours < 24) return `${hours} 小时前`;
        if (days < 7) return `${days} 天前`;
        return new Date(timestamp).toLocaleDateString("zh-CN");
      }

      // 打开发布弹窗
      // 当前选中的可见范围
      var selectedVisibility = "all";
      var selectedVisibilityGroups = [];

      function openPostModal() {
        document.getElementById("igPostModal").classList.add("active");
        document.getElementById("igPostText").value = "";
        document.getElementById("igTextImgInput").value = "";
        document.getElementById("igTextImgInput").classList.remove("visible");
        document.getElementById("igImagePreview").classList.remove("visible");
        document.getElementById("imgOptionAlbum").classList.remove("selected");
        document.getElementById("imgOptionText").classList.remove("selected");
        window.selectedPostImage = null;

        // 初始化可见范围选择
        selectedVisibility = "all";
        selectedVisibilityGroups = [];
        renderVisibilityOptions();

        checkPostValid();
      }

      // 渲染可见范围选项
      function renderVisibilityOptions() {
        const container = document.getElementById("visibilityOptions");
        if (!container) return;

        // 获取所有分组
        const groups = new Set();
        characters.forEach((char) => {
          const settings = chatSettings[char.id] || {};
          if (settings.group && settings.group !== "none") {
            groups.add(settings.group);
          }
        });

        let html = `<div class="ig-visibility-option ${
          selectedVisibility === "all" ? "selected" : ""
        }" data-value="all" onclick="selectVisibility('all', this)">
          <span class="check-icon">✓</span> 公开
        </div>`;

        groups.forEach((group) => {
          const isSelected = selectedVisibilityGroups.includes(group);
          html += `<div class="ig-visibility-option ${
            isSelected ? "selected" : ""
          }" data-value="${group}" onclick="toggleVisibilityGroup('${group}', this)">
            <span class="check-icon">✓</span> ${group}
          </div>`;
        });

        container.innerHTML = html;
      }

      // 选择可见范围
      function selectVisibility(value, el) {
        if (value === "all") {
          selectedVisibility = "all";
          selectedVisibilityGroups = [];
          // 取消所有其他选中
          document.querySelectorAll(".ig-visibility-option").forEach((opt) => {
            opt.classList.remove("selected");
          });
          el.classList.add("selected");
        }
      }

      // 切换分组可见
      function toggleVisibilityGroup(group, el) {
        // 取消"公开"的选中
        const allOption = document.querySelector(
          '.ig-visibility-option[data-value="all"]'
        );
        if (allOption) allOption.classList.remove("selected");
        selectedVisibility = "groups";

        if (selectedVisibilityGroups.includes(group)) {
          selectedVisibilityGroups = selectedVisibilityGroups.filter(
            (g) => g !== group
          );
          el.classList.remove("selected");

          // 如果没有选中任何分组，默认回到公开
          if (selectedVisibilityGroups.length === 0) {
            selectedVisibility = "all";
            if (allOption) allOption.classList.add("selected");
          }
        } else {
          selectedVisibilityGroups.push(group);
          el.classList.add("selected");
        }
      }

      // 关闭发布弹窗
      function closePostModal() {
        document.getElementById("igPostModal").classList.remove("active");
      }

      // 选择图片选项
      function selectImageOption(type) {
        if (type === "album") {
          document.getElementById("igImageInput").click();
          document.getElementById("imgOptionAlbum").classList.add("selected");
          document.getElementById("imgOptionText").classList.remove("selected");
          document.getElementById("igTextImgInput").classList.remove("visible");
        } else {
          document.getElementById("imgOptionText").classList.add("selected");
          document
            .getElementById("imgOptionAlbum")
            .classList.remove("selected");
          document.getElementById("igTextImgInput").classList.add("visible");
          document.getElementById("igImagePreview").classList.remove("visible");
          window.selectedPostImage = null;
        }
      }

      // 处理图片选择
      function handleImageSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          window.selectedPostImage = e.target.result;
          document.getElementById("igPreviewImg").src = e.target.result;
          document.getElementById("igImagePreview").classList.add("visible");
          document.getElementById("igTextImgInput").classList.remove("visible");
          checkPostValid();
        };
        reader.readAsDataURL(file);
      }

      // 移除图片
      function removeImage() {
        window.selectedPostImage = null;
        document.getElementById("igImagePreview").classList.remove("visible");
        document.getElementById("imgOptionAlbum").classList.remove("selected");
        document.getElementById("igImageInput").value = "";
        checkPostValid();
      }

      // 检查是否可以发布
      function checkPostValid() {
        const text = document.getElementById("igPostText").value.trim();
        const textImg = document.getElementById("igTextImgInput").value.trim();
        const hasImage = window.selectedPostImage;

        const valid = text.length > 0 || textImg.length > 0 || hasImage;
        document.getElementById("igPostSubmit").disabled = !valid;
      }

      // 发布动态
      async function submitPost() {
        const text = document.getElementById("igPostText").value.trim();
        const textImg = document.getElementById("igTextImgInput").value.trim();

        const post = {
          id: Date.now(),
          content: text,
          image: window.selectedPostImage || null,
          textImage: textImg || null,
          timestamp: Date.now(),
          isUser: true,
          authorId: "user",
          likes: [],
          comments: [],
          // 可见范围
          visibility: selectedVisibility,
          visibleGroups:
            selectedVisibility === "groups"
              ? [...selectedVisibilityGroups]
              : [],
        };

        window.momentsData.posts.unshift(post);
        await localforage.setItem("momentsData", window.momentsData);

        closePostModal();
        renderMomentsUI();
        showToast("★ 动态发布成功！");

        // AI角色会来互动 - 根据可见范围筛选
        setTimeout(() => {
          aiInteractWithPost(post);
        }, 2000 + Math.random() * 2000);
      }

      // AI与用户动态互动 - 使用API生成符合人设的评论
      async function aiInteractWithPost(post) {
        if (!window.characters || window.characters.length === 0) {
          console.log("没有角色，跳过AI互动");
          return;
        }

        console.log("开始AI互动，角色数量:", window.characters.length);

        // 根据可见范围筛选可以看到动态的AI
        let eligibleChars = [...window.characters];

        if (
          post.visibility === "groups" &&
          post.visibleGroups &&
          post.visibleGroups.length > 0
        ) {
          // 只有指定分组的AI可以看到
          eligibleChars = window.characters.filter((char) => {
            const settings = chatSettings[char.id] || {};
            return post.visibleGroups.includes(settings.group);
          });
          console.log(
            "可见分组:",
            post.visibleGroups,
            "符合条件的AI:",
            eligibleChars.map((c) => c.name)
          );
        }

        if (eligibleChars.length === 0) {
          console.log("没有符合条件的AI可以看到这条动态");
          return;
        }

        // 所有符合条件的AI都会来互动（100%）
        for (const char of eligibleChars) {
          await new Promise((resolve) =>
            setTimeout(resolve, 1500 + Math.random() * 2000)
          );

          // 100% 点赞
          const postIndex = window.momentsData.posts.findIndex(
            (p) => p.id === post.id
          );
          if (
            postIndex !== -1 &&
            !window.momentsData.posts[postIndex].likes.includes(String(char.id))
          ) {
            window.momentsData.posts[postIndex].likes.push(String(char.id));
            await localforage.setItem("momentsData", window.momentsData);
            renderMomentsUI();
            console.log(char.name, "点赞了");
          }

          // 100% 评论
          console.log(char.name, "准备评论，开始调用API...");
          try {
            console.log(char.name, "正在生成评论...");
            const comment = await generateAiCommentWithAPI(char, post);
            console.log(char.name, "API返回评论:", comment);
            if (comment) {
              const postIndex = window.momentsData.posts.findIndex(
                (p) => p.id === post.id
              );
              if (postIndex !== -1) {
                window.momentsData.posts[postIndex].comments.push({
                  id: Date.now(),
                  authorId: String(char.id),
                  authorName: char.note || char.name,
                  authorAvatar: char.avatar || "AI",
                  content: comment,
                  timestamp: Date.now(),
                  replyTo: null,
                });
                await localforage.setItem("momentsData", window.momentsData);
                renderMomentsUI();
                console.log(char.name, "评论成功:", comment);

                // 增加朋友圈未读提醒
                addUnreadMoment();
              }
            } else {
              console.log(char.name, "评论内容为空");
            }
          } catch (e) {
            console.error("AI评论生成失败:", e);
          }
        }
      }

      // 使用API生成AI评论 - 符合角色人设
      async function generateAiCommentWithAPI(char, post) {
        // 获取当前激活的API配置，优先使用角色设置的API，否则用全局激活的
        const charSettings = chatSettings[char.id] || {};
        let apiConfigToUse = null;

        if (charSettings.apiPreset) {
          apiConfigToUse = apiPresets.find(
            (p) => p.id === charSettings.apiPreset
          );
        }
        if (!apiConfigToUse) {
          apiConfigToUse = apiPresets.find((p) => p.id === activePresetId);
        }
        if (!apiConfigToUse && apiPresets.length > 0) {
          apiConfigToUse = apiPresets[0];
        }

        if (!apiConfigToUse || !apiConfigToUse.key) {
          console.log("没有可用的API配置，跳过AI评论");
          return null;
        }

        console.log("使用API配置:", apiConfigToUse.name, apiConfigToUse.model);

        // 构建动态内容描述
        let postDescription = "";
        if (post.content) {
          postDescription += `动态文字内容: "${post.content}"`;
        }
        if (post.textImage) {
          postDescription += `${postDescription ? "\n" : ""}动态配图描述: "${
            post.textImage
          }"`;
        }
        if (post.image) {
          postDescription += `${postDescription ? "\n" : ""}(动态包含一张图片)`;
        }

        const userName = window.momentsData.userProfile.name || "用户";

        // 获取角色人设
        const persona = charSettings.persona || char.description || "";

        // 构建系统提示词
        const systemPrompt = `你是${
          char.note || char.name
        }，正在社交媒体上看到${userName}发布的一条动态。
${persona ? `你的人设: ${persona}` : ""}

请根据你的性格和人设，对这条动态写一条简短的评论回复。

要求:
1. 评论要简短自然，像真人在社交媒体上的评论一样，通常1-2句话
2. 要符合你的人设和说话风格
3. 要针对动态的具体内容进行评论，不要泛泛而谈
4. 可以适当使用表情符号
5. 直接输出评论内容，不要有任何前缀或解释`;

        const userPrompt = `${userName}发布了一条动态:\n${postDescription}\n\n请写一条评论:`;

        try {
          // 确保URL格式正确 - 以/chat/completions结尾
          let apiUrl = apiConfigToUse.url.replace(/\/$/, "");
          if (!apiUrl.endsWith("/chat/completions")) {
            if (apiUrl.endsWith("/v1")) {
              apiUrl += "/chat/completions";
            } else if (apiUrl.includes("/v1/")) {
              if (!apiUrl.includes("/chat/completions")) {
                apiUrl += "/chat/completions";
              }
            } else {
              apiUrl += "/v1/chat/completions";
            }
          }

          console.log("AI评论API调用:", apiUrl, apiConfigToUse.model);

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${apiConfigToUse.key}`,
            },
            body: JSON.stringify({
              model: apiConfigToUse.model,
              messages: [
                { role: "system", content: systemPrompt },
                { role: "user", content: userPrompt },
              ],
              temperature: 0.8,
              stream: false,
            }),
          });

          if (!response.ok) {
            const errText = await response.text();
            console.error(`API请求失败: ${response.status}`, errText);
            throw new Error(`API请求失败: ${response.status}`);
          }

          const data = await response.json();
          console.log("评论API完整返回:", JSON.stringify(data));

          // 兼容不同模型的返回格式
          const choice = data.choices?.[0];
          let comment = choice?.message?.content?.trim();

          // 如果content为空，尝试其他可能的字段
          if (!comment && choice?.message?.reasoning_content) {
            comment = choice.message.reasoning_content.trim();
          }
          if (!comment && choice?.message?.reasoning) {
            comment = choice.message.reasoning.trim();
          }
          if (!comment && choice?.text) {
            comment = choice.text.trim();
          }
          if (!comment && choice?.delta?.content) {
            comment = choice.delta.content.trim();
          }

          // 如果还是空的，检测是否是推理模型问题
          if (!comment) {
            const hasReasoningTokens =
              data.usage?.reasoning_tokens > 0 ||
              data.usage?.completion_tokens_details?.reasoning_tokens > 0;
            if (hasReasoningTokens) {
              console.warn("检测到推理模型返回空内容，跳过评论");
              return null;
            }
          }

          // 如果还是空的，用简化prompt重试
          if (!comment) {
            console.log("评论为空，尝试简化prompt重试");
            const simplePrompt = `看到朋友发的动态："${
              post.content || "(图片)"
            }"，写一句简短评论（10字以内），直接输出评论内容：`;

            const retryResponse = await fetch(apiUrl, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${apiConfigToUse.key}`,
              },
              body: JSON.stringify({
                model: apiConfigToUse.model,
                messages: [{ role: "user", content: simplePrompt }],
                max_tokens: 50,
                temperature: 0.7,
              }),
            });

            if (retryResponse.ok) {
              const retryData = await retryResponse.json();
              console.log("重试API返回:", JSON.stringify(retryData));
              comment = retryData.choices?.[0]?.message?.content?.trim();
            }
          }

          console.log("AI评论最终结果:", comment);
          return comment || null;
        } catch (e) {
          console.error("API调用失败:", e);
          return null;
        }
      }

      // AI角色发布动态 - 使用API生成符合人设的动态内容
      async function generateAiPosts() {
        // 不再自动生成内置动态，改为用户手动触发或其他条件触发
        // 这个函数保留但不再自动执行内置内容
        return;
      }

      // 点赞/取消点赞
      async function toggleLike(postId) {
        const postIndex = window.momentsData.posts.findIndex(
          (p) => String(p.id) === String(postId)
        );
        if (postIndex === -1) return;

        const post = window.momentsData.posts[postIndex];
        const userIndex = post.likes.indexOf("user");

        if (userIndex === -1) {
          post.likes.push("user");
        } else {
          post.likes.splice(userIndex, 1);
        }

        await localforage.setItem("momentsData", window.momentsData);
        renderMomentsUI();
      }

      // 当前评论的动态ID
      let currentCommentPostId = null;
      let replyToComment = null; // 当前回复的评论

      // 打开评论弹窗
      function openComments(postId) {
        currentCommentPostId = postId;
        replyToComment = null;
        const post = window.momentsData.posts.find(
          (p) => String(p.id) === String(postId)
        );
        if (!post) return;

        const container = document.getElementById("igCommentsList");
        const comments = post.comments || [];

        if (comments.length === 0) {
          container.innerHTML =
            '<div style="text-align:center;color:#8e8e8e;padding:40px;">还没有评论，来说点什么吧~</div>';
        } else {
          container.innerHTML = comments
            .map((c) => {
              const char = window.characters?.find(
                (ch) => String(ch.id) === c.authorId
              );
              const avatarImg =
                c.authorId === "user"
                  ? window.momentsData.userProfile.avatarImg
                  : char?.avatar;
              const avatar =
                c.authorId === "user"
                  ? window.momentsData.userProfile.avatar
                  : "AI";

              // 回复标记
              let replyHtml = "";
              if (c.replyTo) {
                replyHtml = `<span class="ig-reply-tag">回复 @${c.replyTo}</span> `;
              }

              return `
              <div class="ig-full-comment" data-comment-id="${
                c.id
              }" data-author-id="${c.authorId}" data-author-name="${
                c.authorName
              }">
                <div class="ig-full-comment-avatar">
                  ${avatarImg ? `<img src="${avatarImg}" alt="">` : avatar}
                </div>
                <div class="ig-full-comment-content">
                  <div class="ig-full-comment-user">${c.authorName}</div>
                  <div class="ig-full-comment-text">${replyHtml}${
                c.content
              }</div>
                  <div class="ig-full-comment-actions">
                    <span class="ig-full-comment-time">${formatPostTime(
                      c.timestamp
                    )}</span>
                    <span class="ig-reply-btn" onclick="setReplyTo('${
                      c.id
                    }', '${c.authorName}', '${c.authorId}')">回复</span>
                  </div>
                </div>
              </div>
            `;
            })
            .join("");
        }

        document.getElementById("igCommentsModal").classList.add("active");
        document.getElementById("igCommentInput").value = "";
        document.getElementById("igCommentInput").placeholder = "添加评论...";
      }

      // 设置回复目标
      function setReplyTo(commentId, authorName, authorId) {
        replyToComment = {
          id: commentId,
          name: authorName,
          authorId: authorId,
        };
        const input = document.getElementById("igCommentInput");
        input.placeholder = `回复 @${authorName}...`;
        input.focus();
      }

      // 关闭评论弹窗
      function closeCommentsModal() {
        document.getElementById("igCommentsModal").classList.remove("active");
        currentCommentPostId = null;
        replyToComment = null;
      }

      // 发送评论
      async function sendComment() {
        if (!currentCommentPostId) return;

        const input = document.getElementById("igCommentInput");
        const content = input.value.trim();
        if (!content) return;

        const postIndex = window.momentsData.posts.findIndex(
          (p) => String(p.id) === String(currentCommentPostId)
        );
        if (postIndex === -1) return;

        const profile = window.momentsData.userProfile;
        const newComment = {
          id: Date.now(),
          authorId: "user",
          authorName: profile.name,
          authorAvatar: profile.avatarImg || profile.avatar,
          content: content,
          timestamp: Date.now(),
          replyTo: replyToComment ? replyToComment.name : null,
        };

        window.momentsData.posts[postIndex].comments.push(newComment);
        await localforage.setItem("momentsData", window.momentsData);

        // 保存回复目标用于AI回复
        const replyTarget = replyToComment;

        // 清空回复状态
        replyToComment = null;
        input.value = "";
        input.placeholder = "添加评论...";

        // 重新打开评论弹窗刷新
        openComments(currentCommentPostId);
        renderMomentsUI();

        // 如果是回复AI的评论，AI会回复
        if (replyTarget && replyTarget.authorId !== "user") {
          const char = window.characters?.find(
            (c) => String(c.id) === replyTarget.authorId
          );
          if (char) {
            setTimeout(async () => {
              const post = window.momentsData.posts[postIndex];
              const reply = await generateAiReplyWithAPI(char, content, post);
              if (reply) {
                window.momentsData.posts[postIndex].comments.push({
                  id: Date.now(),
                  authorId: String(char.id),
                  authorName: char.note || char.name,
                  authorAvatar: char.avatar || "AI",
                  content: reply,
                  timestamp: Date.now(),
                  replyTo: profile.name,
                });
                await localforage.setItem("momentsData", window.momentsData);
                if (currentCommentPostId === String(post.id)) {
                  openComments(currentCommentPostId);
                }
                renderMomentsUI();
              }
            }, 2000 + Math.random() * 3000);
          }
        }
        // 如果是在AI的动态下评论（非回复），AI也可能会回复
        else {
          const post = window.momentsData.posts[postIndex];
          if (!post.isUser && window.characters) {
            const char = window.characters.find(
              (c) => String(c.id) === post.authorId
            );
            if (char && Math.random() > 0.3) {
              // 70% 概率回复
              setTimeout(async () => {
                const reply = await generateAiReplyWithAPI(char, content, post);
                if (reply) {
                  window.momentsData.posts[postIndex].comments.push({
                    id: Date.now(),
                    authorId: String(char.id),
                    authorName: char.note || char.name,
                    authorAvatar: char.avatar || "AI",
                    content: reply,
                    timestamp: Date.now(),
                    replyTo: profile.name,
                  });
                  await localforage.setItem("momentsData", window.momentsData);
                  if (currentCommentPostId === String(post.id)) {
                    openComments(currentCommentPostId);
                  }
                  renderMomentsUI();
                }
              }, 2000 + Math.random() * 3000);
            }
          }
        }
      }

      // 使用API生成AI回复评论
      async function generateAiReplyWithAPI(char, userComment, post) {
        // 获取当前激活的API配置
        const charSettings = chatSettings[char.id] || {};
        let apiConfig = null;

        if (charSettings.apiPreset) {
          apiConfig = apiPresets.find((p) => p.id === charSettings.apiPreset);
        }
        if (!apiConfig) {
          apiConfig = apiPresets.find((p) => p.id === activePresetId);
        }
        if (!apiConfig && apiPresets.length > 0) {
          apiConfig = apiPresets[0];
        }

        if (!apiConfig || !apiConfig.key) {
          console.log("没有可用的API配置，跳过AI回复");
          return null;
        }

        const userName = window.momentsData.userProfile.name || "用户";
        const persona = charSettings.persona || char.description || "";

        // 构建动态内容描述
        let postDescription = "";
        if (post.content) {
          postDescription += `动态内容: "${post.content}"`;
        }
        if (post.textImage) {
          postDescription += `${postDescription ? ", " : ""}配图: "${
            post.textImage
          }"`;
        }

        const systemPrompt = `你是${char.note || char.name}。
${persona ? `你的人设: ${persona}` : ""}

${userName}在你的动态下留言了，你需要回复。

你的动态: ${postDescription || "(一条动态)"}

要求:
1. 回复要简短自然，像真人聊天一样，1-2句话即可
2. 要符合你的人设和说话风格
3. 要针对对方评论的内容进行回复
4. 可以适当使用表情符号
5. 直接输出回复内容，不要有任何前缀或解释`;

        const userPrompt = `${userName}的评论: "${userComment}"\n\n请回复:`;

        try {
          // 处理API URL
          let apiUrl = apiConfig.url.replace(/\/$/, "");
          if (!apiUrl.endsWith("/chat/completions")) {
            if (apiUrl.endsWith("/v1")) {
              apiUrl += "/chat/completions";
            } else if (apiUrl.includes("/v1/")) {
              if (!apiUrl.includes("/chat/completions")) {
                apiUrl += "/chat/completions";
              }
            } else {
              apiUrl += "/v1/chat/completions";
            }
          }

          console.log("AI回复评论API调用:", apiUrl);

          const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${apiConfig.key}`,
            },
            body: JSON.stringify({
              model: apiConfig.model,
              messages: [
                { role: "system", content: systemPrompt },
                { role: "user", content: userPrompt },
              ],
              temperature: 0.8,
              stream: false,
            }),
          });

          if (!response.ok) {
            const errText = await response.text();
            console.error(`API请求失败: ${response.status}`, errText);
            throw new Error(`API请求失败: ${response.status}`);
          }

          const data = await response.json();
          console.log("AI回复评论返回:", JSON.stringify(data));
          const reply = data.choices?.[0]?.message?.content?.trim();
          return reply || null;
        } catch (e) {
          console.error("API调用失败:", e);
          return null;
        }
      }

      // 当前操作的动态ID
      let currentMenuPostId = null;

      // 打开动态菜单
      function openPostMenu(postId) {
        currentMenuPostId = postId;
        document.getElementById("igPostMenu").classList.add("active");
      }

      // 关闭动态菜单
      function closePostMenu() {
        document.getElementById("igPostMenu").classList.remove("active");
        currentMenuPostId = null;
      }

      // 删除动态
      async function deletePost() {
        if (!currentMenuPostId) return;

        if (!confirm("确定要删除这条动态吗？")) {
          closePostMenu();
          return;
        }

        window.momentsData.posts = window.momentsData.posts.filter(
          (p) => String(p.id) !== String(currentMenuPostId)
        );
        await localforage.setItem("momentsData", window.momentsData);

        closePostMenu();
        renderMomentsUI();
        showToast("动态已删除");
      }

      // 确认删除动态（直接从卡片按钮调用）
      window.confirmDeletePost = async function (postId) {
        console.log("删除动态:", postId);
        if (!confirm("确定要删除这条动态吗？")) {
          return;
        }

        window.momentsData.posts = window.momentsData.posts.filter(
          (p) => String(p.id) !== String(postId)
        );
        await localforage.setItem("momentsData", window.momentsData);

        renderMomentsUI();
        showToast("✕ 动态已删除");
      };

      // 当前要转发的动态ID
      let currentSharePostId = null;

      // 打开转发选择弹窗
      window.sharePostToChat = function (postId) {
        console.log("打开转发弹窗:", postId);
        currentSharePostId = postId;

        const post = window.momentsData.posts.find(
          (p) => String(p.id) === String(postId)
        );
        if (!post) {
          showToast("✕ 找不到这条动态");
          return;
        }

        // 渲染角色列表
        const container = document.getElementById("igShareList");
        if (!window.characters || window.characters.length === 0) {
          container.innerHTML =
            '<div class="ig-share-empty">还没有添加好友哦~</div>';
        } else {
          container.innerHTML = window.characters
            .map(
              (char) => `
            <div class="ig-share-item" onclick="confirmShareToChat('${
              char.id
            }')">
              <div class="ig-share-avatar">
                ${char.avatar ? `<img src="${char.avatar}" alt="">` : "AI"}
              </div>
              <div class="ig-share-info">
                <div class="ig-share-name">${char.note || char.name}</div>
                <div class="ig-share-desc">点击转发给TA</div>
              </div>
              <button class="ig-share-btn">转发</button>
            </div>
          `
            )
            .join("");
        }

        document.getElementById("igShareModal").classList.add("active");
      };

      // 关闭转发弹窗
      window.closeShareModal = function () {
        document.getElementById("igShareModal").classList.remove("active");
        currentSharePostId = null;
      };

      // 确认转发给指定角色
      window.confirmShareToChat = function (charId) {
        console.log("转发给角色:", charId);
        const post = window.momentsData.posts.find(
          (p) => String(p.id) === String(currentSharePostId)
        );
        if (!post) {
          showToast("✕ 找不到这条动态");
          closeShareModal();
          return;
        }

        const char = window.characters?.find(
          (c) => String(c.id) === String(charId)
        );
        if (!char) {
          showToast("✕ 找不到这个角色");
          closeShareModal();
          return;
        }

        // 获取动态作者信息
        let authorName, authorAvatar, authorAvatarImg;
        if (post.isUser) {
          authorName = window.momentsData.userProfile.name || "我";
          authorAvatar = window.momentsData.userProfile.avatar || "A";
          authorAvatarImg = window.momentsData.userProfile.avatarImg;
        } else {
          const postChar = window.characters?.find(
            (c) => String(c.id) === post.authorId
          );
          authorName = postChar ? postChar.note || postChar.name : "未知用户";
          authorAvatar = "🤖";
          authorAvatarImg = postChar?.avatar;
        }

        // 格式化时间
        const postTime = new Date(post.timestamp);
        const timeStr = `${
          postTime.getMonth() + 1
        }月${postTime.getDate()}日 ${postTime.getHours()}:${String(
          postTime.getMinutes()
        ).padStart(2, "0")}`;

        // 构建图片HTML
        let imageHtml = "";
        if (post.image) {
          imageHtml = `<img class="shared-post-image" src="${post.image}" alt="">`;
        } else if (post.textImage) {
          const bgStyles = [
            { bg: "linear-gradient(135deg, #667eea, #764ba2)", emoji: "★" },
            { bg: "linear-gradient(135deg, #f093fb, #f5576c)", emoji: "○" },
            { bg: "linear-gradient(135deg, #4facfe, #00f2fe)", emoji: "◇" },
            { bg: "linear-gradient(135deg, #43e97b, #38f9d7)", emoji: "🌿" },
          ];
          const style = bgStyles[Math.floor(post.id) % bgStyles.length];
          imageHtml = `<div class="shared-post-text-img" style="background:${style.bg}"><span>${post.textImage}</span></div>`;
        }

        // 构建精致转发卡片HTML
        const cardHtml = `
          <div class="shared-post-card">
            <div class="shared-post-header">
              <div class="shared-post-avatar">
                ${
                  authorAvatarImg
                    ? `<img src="${authorAvatarImg}" alt="">`
                    : authorAvatar
                }
              </div>
              <div class="shared-post-meta">
                <span class="shared-post-author">${authorName}</span>
                <span class="shared-post-time">${timeStr}</span>
              </div>
              <span class="shared-post-label">动态</span>
            </div>
            <div class="shared-post-body">
              ${
                post.content
                  ? `<div class="shared-post-content">${post.content}</div>`
                  : ""
              }
              ${imageHtml}
            </div>
            <div class="shared-post-footer">
              <span class="shared-post-footer-text">
                <span class="shared-post-footer-icon">↑</span> 转发的动态
              </span>
              <span class="shared-post-interact">点击查看 ›</span>
            </div>
          </div>
        `;

        // 关闭弹窗
        closeShareModal();

        // 切换到该角色的聊天
        if (typeof openChat === "function") {
          openChat(charId);
        } else {
          currentChatCharId = String(charId);
        }

        // 切换到聊天页面
        switchChatTab("messages");

        // 延迟发送消息
        setTimeout(() => {
          // 确保chatHistories存在
          if (!chatHistories[charId]) {
            chatHistories[charId] = [];
          }

          // 添加消息
          const msgObj = {
            role: "user",
            content: cardHtml,
            time: new Date().toLocaleTimeString("zh-CN", {
              hour: "2-digit",
              minute: "2-digit",
            }),
            isHtml: true,
          };

          chatHistories[charId].push(msgObj);
          localforage.setItem("chatHistories", chatHistories);

          // 重新渲染对话
          if (typeof renderConversation === "function") {
            renderConversation();
          }

          // 更新最后消息
          if (typeof updateCharacterLastMessage === "function") {
            updateCharacterLastMessage(
              charId,
              `[转发动态] ${post.content || "图片"}`
            );
          }

          showToast(`↑ 已转发给 ${char.note || char.name}`);
        }, 300);
      };

      // 切换收藏状态
      window.toggleBookmark = async function (postId) {
        console.log("收藏动态:", postId);
        const postIndex = window.momentsData.posts.findIndex(
          (p) => String(p.id) === String(postId)
        );
        if (postIndex === -1) return;

        const post = window.momentsData.posts[postIndex];
        if (!post.bookmarks) {
          post.bookmarks = [];
        }

        const userIndex = post.bookmarks.indexOf("user");
        if (userIndex === -1) {
          post.bookmarks.push("user");
          showToast("🔖 已收藏");
        } else {
          post.bookmarks.splice(userIndex, 1);
          showToast("📑 已取消收藏");
        }

        await localforage.setItem("momentsData", window.momentsData);
        renderMomentsUI();
      };

      // 打开个人资料编辑弹窗
      function openProfileModal() {
        const profile = window.momentsData.userProfile;

        // 设置预览头像
        const preview = document.getElementById("igAvatarPreview");
        if (profile.avatarImg) {
          preview.innerHTML = `<img src="${profile.avatarImg}" alt="">`;
        } else {
          preview.innerHTML = profile.avatar || "A";
        }

        document.getElementById("igEditName").value = profile.name || "";
        document.getElementById("igEditHandle").value = profile.handle || "";
        document.getElementById("igEditBio").value = profile.bio || "";

        document.getElementById("igProfileModal").classList.add("active");
      }

      // 关闭个人资料编辑弹窗
      function closeProfileModal() {
        document.getElementById("igProfileModal").classList.remove("active");
      }

      // 处理头像选择
      function handleAvatarSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          window.momentsData.userProfile.avatarImg = e.target.result;
          window.momentsData.userProfile.avatar = null;
          document.getElementById(
            "igAvatarPreview"
          ).innerHTML = `<img src="${e.target.result}" alt="">`;
        };
        reader.readAsDataURL(file);
      }

      // 打开表情选择器
      function openEmojiPicker() {
        const emojis = [
          "我",
          "😎",
          "🥰",
          "😇",
          "🤗",
          "😋",
          "A",
          "B",
          "C",
          "D",
          "E",
          "F",
          "○",
          "🌺",
          "🌻",
          "○",
          "☆",
          "◇",
          "🎀",
          "♡",
        ];
        const emoji = prompt("选择一个表情作为头像：\n" + emojis.join(" "));
        if (emoji && emojis.includes(emoji)) {
          window.momentsData.userProfile.avatar = emoji;
          window.momentsData.userProfile.avatarImg = null;
          document.getElementById("igAvatarPreview").innerHTML = emoji;
        }
      }

      // 保存个人资料
      async function saveProfile() {
        const name = document.getElementById("igEditName").value.trim();
        const handle = document.getElementById("igEditHandle").value.trim();
        const bio = document.getElementById("igEditBio").value.trim();

        window.momentsData.userProfile.name = name || "我的昵称";
        window.momentsData.userProfile.handle = handle || "@username";
        window.momentsData.userProfile.bio = bio || "";

        await localforage.setItem("momentsData", window.momentsData);

        closeProfileModal();
        renderMomentsUI();
        renderStoriesBar();
        showToast("个人资料已保存 ★");
      }

      // 显示某个角色的动态
      function showCharacterPosts(charId) {
        const char = window.characters?.find(
          (c) => String(c.id) === String(charId)
        );
        if (!char) return;

        const charPosts = window.momentsData.posts.filter(
          (p) => p.authorId === String(charId)
        );
        if (charPosts.length === 0) {
          showToast(`${char.note || char.name} 还没有发布动态~`);
          return;
        }

        // 滚动到该角色的第一条动态
        const container = document.getElementById("igFeed");
        const firstPost = container.querySelector(
          `[data-post-id="${charPosts[0].id}"]`
        );
        if (firstPost) {
          firstPost.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      }

      // 生成动态相关的AI提示词
      function generateMomentsPromptForAi(charId) {
        // 如果没有传入charId，使用当前聊天的角色ID
        const targetCharId = charId || currentChatCharId;
        if (!targetCharId) return "";

        // 获取当前AI角色的分组信息
        const charSettings = chatSettings[targetCharId] || {};
        const charGroup = charSettings.group;

        // 筛选当前AI角色可以看到的用户动态
        const visiblePosts = window.momentsData.posts.filter((p) => {
          if (!p.isUser) return false;

          // 如果是公开动态（visibility === "all" 或 undefined）
          if (!p.visibility || p.visibility === "all") {
            return true;
          }

          // 如果是分组可见的动态
          if (
            p.visibility === "groups" &&
            p.visibleGroups &&
            p.visibleGroups.length > 0
          ) {
            // 只有当前AI的分组在可见分组列表中才能看到
            return charGroup && p.visibleGroups.includes(charGroup);
          }

          return false;
        });

        if (visiblePosts.length === 0) return "";

        // 获取最近的3条可见动态
        const recentPosts = visiblePosts.slice(0, 3);
        let prompt =
          "\n\n【用户最近的动态】以下是用户在社交动态中分享的内容，你可以在对话中自然地提及或询问相关话题：\n";

        recentPosts.forEach((post, index) => {
          const timeStr = formatPostTime(post.timestamp);
          prompt += `${index + 1}. ${timeStr}: "${post.content}"`;
          if (post.textImage) {
            prompt += ` [配图描述: ${post.textImage}]`;
          }
          prompt += "\n";
        });

        prompt +=
          '你可以自然地在对话中提到这些动态，比如"我看到你发的动态了..."或者询问相关的话题，但不要显得太刻意。';
        return prompt;
      }

      // 页面加载时初始化动态系统
      document.addEventListener("DOMContentLoaded", function () {
        setTimeout(() => {
          initTodoSystem();
          initPeriodSystem();
          initMomentsSystem();
        }, 500);
      });

      // ==================== 外观设置功能 ====================
      // 外观设置数据
      window.appearanceSettings = {
        wallpaper: null,
        fontColor: "#37474f",
        apps: {
          chat: { name: "聊天", icon: null },
          worldbook: { name: "世界书", icon: null },
          preset: { name: "预设", icon: null },
          forum: { name: "论坛", icon: null },
          api: { name: "API设置", icon: null },
          font: { name: "字体", icon: null },
          appearance: { name: "外观设置", icon: null },
        },
      };

      // 加载外观设置
      async function loadAppearanceSettings() {
        try {
          const saved = await safeLocalforageGet("appearanceSettings");
          if (saved) {
            window.appearanceSettings = saved;
            applyAppearanceSettings();
          }
        } catch (e) {
          console.error("加载外观设置失败:", e);
        }
      }

      // 应用外观设置
      function applyAppearanceSettings() {
        const settings = window.appearanceSettings;

        // 应用壁纸
        if (settings.wallpaper) {
          document.querySelector(
            ".phone-container"
          ).style.backgroundImage = `url(${settings.wallpaper})`;
          document.querySelector(".phone-container").style.backgroundSize =
            "cover";
          document.querySelector(".phone-container").style.backgroundPosition =
            "center";
        }

        // 应用字体颜色
        document.documentElement.style.setProperty(
          "--text-primary",
          settings.fontColor
        );
        document
          .querySelectorAll(".app-name, .profile-name, .dock-label")
          .forEach((el) => {
            el.style.color = settings.fontColor;
          });

        // 应用APP名称和图标 (love-widget是第1个子元素，所以app从第2个开始)
        const appMappings = {
          chat: {
            iconSelector: ".apps-grid > .app-item:nth-child(2) .app-icon",
            nameSelector: ".apps-grid > .app-item:nth-child(2) .app-name",
          },
          worldbook: {
            iconSelector: ".apps-grid > .app-item:nth-child(3) .app-icon",
            nameSelector: ".apps-grid > .app-item:nth-child(3) .app-name",
          },
          preset: {
            iconSelector: ".apps-grid > .app-item:nth-child(4) .app-icon",
            nameSelector: ".apps-grid > .app-item:nth-child(4) .app-name",
          },
          forum: {
            iconSelector: ".apps-grid > .app-item:nth-child(5) .app-icon",
            nameSelector: ".apps-grid > .app-item:nth-child(5) .app-name",
          },
          api: {
            iconSelector: ".dock .dock-item:nth-child(1) .dock-icon",
            nameSelector: ".dock .dock-item:nth-child(1) .dock-label",
          },
          font: {
            iconSelector: ".dock .dock-item:nth-child(2) .dock-icon",
            nameSelector: ".dock .dock-item:nth-child(2) .dock-label",
          },
          appearance: {
            iconSelector: ".dock .dock-item:nth-child(3) .dock-icon",
            nameSelector: ".dock .dock-item:nth-child(3) .dock-label",
          },
        };

        Object.keys(settings.apps).forEach((appKey) => {
          const app = settings.apps[appKey];
          const mapping = appMappings[appKey];
          if (mapping) {
            const iconEl = document.querySelector(mapping.iconSelector);
            const nameEl = document.querySelector(mapping.nameSelector);
            if (iconEl && app.icon) {
              iconEl.innerHTML = `<img src="${app.icon}" style="width:100%;height:100%;object-fit:cover;border-radius:inherit;">`;
            } else if (iconEl && app.name) {
              iconEl.textContent = app.name;
            }
            if (nameEl) {
              nameEl.textContent = app.name;
            }
          }
        });
      }

      // 预览壁纸
      function previewWallpaper(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const preview = document.getElementById("wallpaperPreview");
            preview.innerHTML = `<img src="${e.target.result}">`;
            window.appearanceSettings.wallpaper = e.target.result;
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      // 重置壁纸
      function resetWallpaper() {
        const preview = document.getElementById("wallpaperPreview");
        preview.innerHTML =
          '<div class="wallpaper-placeholder">点击更换壁纸</div>';
        window.appearanceSettings.wallpaper = null;
      }

      // 设置字体颜色
      function setFontColor(color) {
        window.appearanceSettings.fontColor = color;
        // 更新选中状态
        document.querySelectorAll(".color-option").forEach((el) => {
          el.classList.remove("selected");
          if (el.dataset.color === color) {
            el.classList.add("selected");
          }
        });
        // 移除自定义颜色选项的选中状态
        const customOption = document.getElementById("customColorOption");
        if (customOption) {
          customOption.classList.remove("selected");
        }
      }

      // 打开自定义颜色选择器
      function openCustomColorPicker() {
        const colorInput = document.getElementById("customColorInput");
        if (colorInput) {
          colorInput.click();
        }
      }

      // 应用自定义字体颜色
      function applyCustomFontColor(color) {
        window.appearanceSettings.fontColor = color;
        // 清除所有预设颜色的选中状态
        document.querySelectorAll(".color-option").forEach((el) => {
          el.classList.remove("selected");
        });
        // 选中自定义颜色按钮并更新其背景色
        const customOption = document.getElementById("customColorOption");
        if (customOption) {
          customOption.classList.add("selected");
          customOption.style.background = color;
          customOption.innerHTML =
            '<span style="color:white;text-shadow:0 1px 2px rgba(0,0,0,0.3);">✓</span>';
        }
      }

      // 预览APP图标
      function previewAppIcon(appKey, input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const iconEl = document.getElementById(`customIcon_${appKey}`);
            iconEl.innerHTML = `<img src="${e.target.result}">`;
            window.appearanceSettings.apps[appKey].icon = e.target.result;
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      // 保存外观设置
      async function saveAppearanceSettings() {
        // 收集APP名称
        Object.keys(window.appearanceSettings.apps).forEach((appKey) => {
          const nameInput = document.getElementById(`customName_${appKey}`);
          if (nameInput) {
            window.appearanceSettings.apps[appKey].name =
              nameInput.value || appKey;
          }
        });

        try {
          await localforage.setItem(
            "appearanceSettings",
            window.appearanceSettings
          );
          applyAppearanceSettings();
          showToast("外观设置已保存 ★");
        } catch (e) {
          console.error("保存外观设置失败:", e);
          showToast("保存失败，请重试");
        }
      }

      // ==================== 分组管理功能 ====================
      window.customGroups = [];

      // 加载分组
      async function loadCustomGroups() {
        try {
          const saved = await safeLocalforageGet("customGroups");
          window.customGroups = saved || [];
          updateGroupSelect();
        } catch (e) {
          console.error("加载分组失败:", e);
        }
      }

      // 更新分组下拉框
      function updateGroupSelect() {
        const select = document.getElementById("settingsGroup");
        if (!select) return;
        select.innerHTML = '<option value="none">未分组</option>';
        window.customGroups.forEach((group) => {
          const option = document.createElement("option");
          option.value = group;
          option.textContent = group;
          select.appendChild(option);
        });
      }

      // 打开分组管理
      function openGroupManager() {
        renderGroupList();
        document.getElementById("groupManagerModal").classList.add("active");
      }

      // 关闭分组管理
      function closeGroupManager() {
        document.getElementById("groupManagerModal").classList.remove("active");
      }

      // 渲染分组列表
      function renderGroupList() {
        const container = document.getElementById("groupList");
        container.innerHTML = window.customGroups
          .map(
            (group, index) => `
          <div class="group-item">
            <span class="group-item-name">${group}</span>
            <button class="group-item-delete" onclick="deleteGroup(${index})">✕</button>
          </div>
        `
          )
          .join("");
      }

      // 添加新分组
      async function addNewGroup() {
        const input = document.getElementById("newGroupInput");
        const name = input.value.trim();
        if (!name) return;
        if (window.customGroups.includes(name)) {
          showToast("分组已存在");
          return;
        }
        window.customGroups.push(name);
        await localforage.setItem("customGroups", window.customGroups);
        input.value = "";
        renderGroupList();
        updateGroupSelect();
        showToast("分组添加成功");
      }

      // 删除分组
      async function deleteGroup(index) {
        window.customGroups.splice(index, 1);
        await localforage.setItem("customGroups", window.customGroups);
        renderGroupList();
        updateGroupSelect();
        showToast("分组已删除");
      }

      // 置顶联系人切换
      function togglePinContact() {
        // 这个会在saveChatSettings时保存
      }

      // 设置用户气泡颜色
      function setUserBubbleColor(color) {
        document.getElementById("settingsUserBubbleColor").value = color;
        // 更新选中状态
        document
          .querySelectorAll("#userColorGrid .color-preset")
          .forEach((el) => {
            el.classList.remove("selected");
            if (
              el.style.background === color ||
              el.style.backgroundColor === color
            ) {
              el.classList.add("selected");
            }
          });
      }

      // 设置AI气泡颜色
      function setAiBubbleColor(color) {
        document.getElementById("settingsAiBubbleColor").value = color;
        // 更新选中状态
        document
          .querySelectorAll("#aiColorGrid .color-preset")
          .forEach((el) => {
            el.classList.remove("selected");
            if (
              el.style.background === color ||
              el.style.backgroundColor === color
            ) {
              el.classList.add("selected");
            }
          });
      }

      // ==================== 聊天记录搜索功能 ====================
      function searchChatHistory(keyword) {
        const resultsContainer = document.getElementById("searchResults");
        const messageList = document.getElementById("messageList");

        if (!keyword || keyword.trim().length < 1) {
          resultsContainer.classList.remove("active");
          resultsContainer.innerHTML = "";
          messageList.style.display = "block";
          return;
        }

        keyword = keyword.trim().toLowerCase();
        const results = [];

        // 搜索所有聊天记录 - 使用window上的变量确保能访问
        const histories = window.chatHistories || chatHistories || {};
        const chars = window.characters || characters || [];

        Object.keys(histories).forEach((charId) => {
          const history = histories[charId] || [];
          const char = chars.find((c) => c.id == charId);
          if (!char) return;

          history.forEach((msg, index) => {
            const content = msg.content || "";
            if (content.toLowerCase().includes(keyword)) {
              results.push({
                charId,
                charName: char.name,
                charAvatar: char.avatar,
                content: content,
                index,
              });
            }
          });
        });

        if (results.length === 0) {
          resultsContainer.innerHTML =
            '<div style="padding: 20px; text-align: center; color: #999;">没有找到相关记录</div>';
        } else {
          resultsContainer.innerHTML = results
            .slice(0, 20)
            .map((r) => {
              // 截取关键词周围的内容
              const lowerContent = r.content.toLowerCase();
              const keywordIndex = lowerContent.indexOf(keyword);
              let displayContent = r.content;
              if (r.content.length > 60) {
                const start = Math.max(0, keywordIndex - 20);
                const end = Math.min(
                  r.content.length,
                  keywordIndex + keyword.length + 40
                );
                displayContent =
                  (start > 0 ? "..." : "") +
                  r.content.substring(start, end) +
                  (end < r.content.length ? "..." : "");
              }

              const highlighted = displayContent.replace(
                new RegExp(
                  keyword.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"),
                  "gi"
                ),
                (match) => `<mark>${match}</mark>`
              );
              return `
              <div class="search-result-item" onclick="openConversation(${r.charId}); document.getElementById('chatSearchInput').value=''; searchChatHistory('');">
                <div class="search-result-char">${r.charName}</div>
                <div class="search-result-content">${highlighted}</div>
              </div>
            `;
            })
            .join("");
        }

        resultsContainer.classList.add("active");
        messageList.style.display = "none";
      }

      // 初始化加载分组
      document.addEventListener("DOMContentLoaded", function () {
        loadCustomGroups();
      });

      // 初始化外观设置页面
      function initAppearancePage() {
        const settings = window.appearanceSettings;

        // 显示当前壁纸
        if (settings.wallpaper) {
          document.getElementById(
            "wallpaperPreview"
          ).innerHTML = `<img src="${settings.wallpaper}">`;
        }

        // 显示当前字体颜色
        document.querySelectorAll(".color-option").forEach((el) => {
          if (el.dataset.color === settings.fontColor) {
            el.classList.add("selected");
          }
        });

        // 显示当前APP设置
        Object.keys(settings.apps).forEach((appKey) => {
          const app = settings.apps[appKey];
          const nameInput = document.getElementById(`customName_${appKey}`);
          const iconEl = document.getElementById(`customIcon_${appKey}`);
          if (nameInput) nameInput.value = app.name;
          if (iconEl && app.icon) {
            iconEl.innerHTML = `<img src="${app.icon}">`;
          }
        });
      }

      // 页面加载时初始化
      document.addEventListener("DOMContentLoaded", function () {
        loadAppearanceSettings();
      });

      // 打开外观设置页面时初始化
      const originalOpenPage = window.openPage || function () {};
      window.openPage = function (pageId) {
        originalOpenPage(pageId);
        if (pageId === "appearancePage") {
          initAppearancePage();
        }
        // 【修复】打开字体设置页面时渲染字体预设列表
        if (pageId === "fontPage") {
          renderFontPresets();
        }
        // 打开世界书页面时渲染世界书列表
        if (pageId === "worldbookPage") {
          renderWorldbooks();
          renderWorldbookTabs();
        }
      };

      // ==================== 世界书系统 ====================

      // 渲染世界书列表
      function renderWorldbooks() {
        const listEl = document.getElementById("worldbookList");
        const emptyEl = document.getElementById("worldbookEmpty");

        // 筛选世界书
        let filteredBooks = worldbooks;
        if (currentWorldbookFilter !== "all") {
          filteredBooks = worldbooks.filter(
            (wb) => wb.group === currentWorldbookFilter
          );
        }

        if (filteredBooks.length === 0) {
          listEl.innerHTML = "";
          emptyEl.style.display = "block";
          return;
        }

        emptyEl.style.display = "none";

        listEl.innerHTML = filteredBooks
          .map((wb) => {
            const isSelected = worldbookSelectedIds.has(wb.id);
            const entryCount = wb.entries ? wb.entries.length : 0;
            const activeEntries = wb.entries
              ? wb.entries.filter((e) => e.enabled !== false).length
              : 0;
            const groupName =
              worldbookGroups.find((g) => g.id === wb.group)?.name || "";

            return `
            <div class="worldbook-item ${
              isSelected ? "selected" : ""
            }" data-id="${wb.id}" onclick="handleWorldbookItemClick('${
              wb.id
            }', event)">
              <div class="worldbook-item-header">
                <div class="worldbook-item-checkbox" onclick="toggleWorldbookSelect('${
                  wb.id
                }', event)"></div>
                <div class="worldbook-item-main">
                  <div class="worldbook-item-title">
                    ${escapeHtml(wb.name)}
                    ${
                      groupName
                        ? `<span class="worldbook-item-tag">${escapeHtml(
                            groupName
                          )}</span>`
                        : ""
                    }
                  </div>
                  <div class="worldbook-item-desc">${escapeHtml(
                    wb.description || "暂无描述"
                  )}</div>
                  <div class="worldbook-item-meta">
                    <div class="worldbook-item-meta-item">📑 ${entryCount} 条目</div>
                    <div class="worldbook-item-meta-item">✓ ${activeEntries} 启用</div>
                    <div class="worldbook-item-meta-item">□ ${
                      wb.updateTime || "刚刚"
                    }</div>
                  </div>
                </div>
                <div class="worldbook-item-actions">
                  <button class="worldbook-item-btn" onclick="editWorldbook('${
                    wb.id
                  }', event)" title="编辑">✏️</button>
                  <button class="worldbook-item-btn delete" onclick="deleteWorldbook('${
                    wb.id
                  }', event)" title="删除">✕</button>
                  <div class="worldbook-item-toggle ${
                    wb.enabled !== false ? "active" : ""
                  }" onclick="toggleWorldbookEnabled('${
              wb.id
            }', event)" title="启用/禁用"></div>
                </div>
              </div>
            </div>
          `;
          })
          .join("");

        // 更新统计
        document.getElementById("wbCountAll").textContent = worldbooks.length;
      }

      // 渲染分组标签
      function renderWorldbookTabs() {
        const tabsEl = document.getElementById("worldbookTabs");

        let html = `
          <div class="worldbook-tab ${
            currentWorldbookFilter === "all" ? "active" : ""
          }" data-group="all" onclick="filterWorldbookByGroup('all')">
            全部 <span class="worldbook-tab-count">${worldbooks.length}</span>
          </div>
        `;

        worldbookGroups.forEach((group) => {
          const count = worldbooks.filter((wb) => wb.group === group.id).length;
          html += `
            <div class="worldbook-tab ${
              currentWorldbookFilter === group.id ? "active" : ""
            }" data-group="${group.id}" onclick="filterWorldbookByGroup('${
            group.id
          }')">
              ${escapeHtml(
                group.name
              )} <span class="worldbook-tab-count">${count}</span>
            </div>
          `;
        });

        tabsEl.innerHTML = html;
      }

      // 按分组筛选
      function filterWorldbookByGroup(groupId) {
        currentWorldbookFilter = groupId;
        renderWorldbookTabs();
        renderWorldbooks();
      }

      // 处理世界书项点击
      function handleWorldbookItemClick(id, event) {
        if (worldbookBatchMode) {
          toggleWorldbookSelect(id, event);
        } else {
          editWorldbook(id, event);
        }
      }

      // 切换批量操作模式
      function toggleWorldbookBatchMode() {
        worldbookBatchMode = !worldbookBatchMode;
        worldbookSelectedIds.clear();

        const batchBar = document.getElementById("worldbookBatchBar");
        if (worldbookBatchMode) {
          batchBar.classList.add("active");
        } else {
          batchBar.classList.remove("active");
        }

        renderWorldbooks();
        updateWorldbookBatchInfo();
      }

      // 取消批量操作
      function cancelWorldbookBatch() {
        worldbookBatchMode = false;
        worldbookSelectedIds.clear();
        document.getElementById("worldbookBatchBar").classList.remove("active");
        renderWorldbooks();
      }

      // 切换世界书选中状态
      function toggleWorldbookSelect(id, event) {
        if (event) event.stopPropagation();

        if (worldbookSelectedIds.has(id)) {
          worldbookSelectedIds.delete(id);
        } else {
          worldbookSelectedIds.add(id);
        }

        renderWorldbooks();
        updateWorldbookBatchInfo();
      }

      // 更新批量操作信息
      function updateWorldbookBatchInfo() {
        document.getElementById("worldbookSelectedCount").textContent =
          worldbookSelectedIds.size;
      }

      // 批量删除
      function deleteSelectedWorldbooks() {
        if (worldbookSelectedIds.size === 0) {
          showToast("请先选择要删除的世界书");
          return;
        }

        if (
          !confirm(`确定要删除选中的 ${worldbookSelectedIds.size} 本世界书吗？`)
        )
          return;

        worldbooks = worldbooks.filter(
          (wb) => !worldbookSelectedIds.has(wb.id)
        );
        localforage.setItem("worldbooks", worldbooks);

        showToast(`已删除 ${worldbookSelectedIds.size} 本世界书`);
        cancelWorldbookBatch();
      }

      // 打开移动分组弹窗
      function openWorldbookMoveModal() {
        if (worldbookSelectedIds.size === 0) {
          showToast("请先选择要移动的世界书");
          return;
        }

        const listEl = document.getElementById("worldbookMoveList");

        let html = `
          <div class="worldbook-move-item" onclick="moveWorldbooksToGroup('')">
            📂 未分组
          </div>
        `;

        worldbookGroups.forEach((group) => {
          html += `
            <div class="worldbook-move-item" onclick="moveWorldbooksToGroup('${
              group.id
            }')">
              📁 ${escapeHtml(group.name)}
            </div>
          `;
        });

        listEl.innerHTML = html;
        document.getElementById("worldbookMoveModal").classList.add("active");
      }

      // 关闭移动分组弹窗
      function closeWorldbookMoveModal() {
        document
          .getElementById("worldbookMoveModal")
          .classList.remove("active");
      }

      // 移动世界书到分组
      function moveWorldbooksToGroup(groupId) {
        worldbookSelectedIds.forEach((id) => {
          const wb = worldbooks.find((w) => w.id === id);
          if (wb) wb.group = groupId;
        });

        localforage.setItem("worldbooks", worldbooks);
        showToast(`已移动 ${worldbookSelectedIds.size} 本世界书`);

        closeWorldbookMoveModal();
        cancelWorldbookBatch();
        renderWorldbookTabs();
      }

      // 打开世界书编辑弹窗
      function openWorldbookModal(id = null) {
        editingWorldbookId = id;
        tempWorldbookEntries = [];

        // 更新分组下拉
        const groupSelect = document.getElementById("worldbookGroupSelect");
        groupSelect.innerHTML = '<option value="">未分组</option>';
        worldbookGroups.forEach((group) => {
          groupSelect.innerHTML += `<option value="${group.id}">${escapeHtml(
            group.name
          )}</option>`;
        });

        if (id) {
          // 编辑模式
          const wb = worldbooks.find((w) => w.id === id);
          if (wb) {
            document.getElementById("worldbookModalTitle").textContent =
              "编辑世界书";
            document.getElementById("worldbookNameInput").value = wb.name || "";
            document.getElementById("worldbookGroupSelect").value =
              wb.group || "";
            document.getElementById("worldbookDescInput").value =
              wb.description || "";
            tempWorldbookEntries = JSON.parse(JSON.stringify(wb.entries || []));
          }
        } else {
          // 新建模式
          document.getElementById("worldbookModalTitle").textContent =
            "新建世界书";
          document.getElementById("worldbookNameInput").value = "";
          document.getElementById("worldbookGroupSelect").value = "";
          document.getElementById("worldbookDescInput").value = "";
          tempWorldbookEntries = [];
        }

        renderWorldbookEntries();
        document.getElementById("worldbookModal").classList.add("active");
      }

      // 关闭世界书编辑弹窗
      function closeWorldbookModal() {
        document.getElementById("worldbookModal").classList.remove("active");
        editingWorldbookId = null;
        tempWorldbookEntries = [];
      }

      // 编辑世界书
      function editWorldbook(id, event) {
        if (event) event.stopPropagation();
        openWorldbookModal(id);
      }

      // 删除世界书
      function deleteWorldbook(id, event) {
        if (event) event.stopPropagation();

        const wb = worldbooks.find((w) => w.id === id);
        if (!wb) return;

        if (!confirm(`确定要删除世界书"${wb.name}"吗？`)) return;

        worldbooks = worldbooks.filter((w) => w.id !== id);
        localforage.setItem("worldbooks", worldbooks);

        showToast("世界书已删除");
        renderWorldbooks();
        renderWorldbookTabs();
      }

      // 切换世界书启用状态
      function toggleWorldbookEnabled(id, event) {
        if (event) event.stopPropagation();

        const wb = worldbooks.find((w) => w.id === id);
        if (wb) {
          wb.enabled = wb.enabled === false ? true : false;
          localforage.setItem("worldbooks", worldbooks);
          renderWorldbooks();
        }
      }

      // 保存世界书
      function saveWorldbook() {
        const name = document.getElementById("worldbookNameInput").value.trim();
        const group = document.getElementById("worldbookGroupSelect").value;
        const description = document
          .getElementById("worldbookDescInput")
          .value.trim();

        if (!name) {
          showToast("请输入世界书名称");
          return;
        }

        const now = new Date().toLocaleString("zh-CN", {
          month: "numeric",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });

        if (editingWorldbookId) {
          // 更新
          const wb = worldbooks.find((w) => w.id === editingWorldbookId);
          if (wb) {
            wb.name = name;
            wb.group = group;
            wb.description = description;
            wb.entries = tempWorldbookEntries;
            wb.updateTime = now;
          }
        } else {
          // 新建
          const newWb = {
            id: "wb_" + Date.now(),
            name: name,
            group: group,
            description: description,
            entries: tempWorldbookEntries,
            enabled: true,
            createTime: now,
            updateTime: now,
          };
          worldbooks.push(newWb);
        }

        localforage.setItem("worldbooks", worldbooks);
        showToast("世界书已保存");
        closeWorldbookModal();
        renderWorldbooks();
        renderWorldbookTabs();
      }

      // 渲染条目列表
      function renderWorldbookEntries() {
        const container = document.getElementById("worldbookEntries");

        if (tempWorldbookEntries.length === 0) {
          container.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #999; font-size: 0.9rem;">暂无条目，点击下方按钮添加</div>';
          return;
        }

        container.innerHTML = tempWorldbookEntries
          .map((entry, index) => {
            const keywords = entry.keywords
              ? entry.keywords
                  .split(",")
                  .map((k) => k.trim())
                  .filter((k) => k)
              : [];

            return `
            <div class="worldbook-entry">
              <div class="worldbook-entry-header">
                <div class="worldbook-entry-toggle ${
                  entry.enabled !== false ? "active" : ""
                }" onclick="toggleEntryEnabled(${index})"></div>
                <div class="worldbook-entry-actions">
                  <button class="worldbook-entry-btn" onclick="editWorldbookEntry(${index})">✏️</button>
                  <button class="worldbook-entry-btn delete" onclick="deleteWorldbookEntry(${index})">✕</button>
                </div>
              </div>
              ${
                entry.comment
                  ? `<div style="font-size: 0.8rem; color: #666; margin-bottom: 6px;">📝 ${escapeHtml(
                      entry.comment
                    )}</div>`
                  : ""
              }
              <div class="worldbook-entry-keywords">
                ${
                  keywords.length > 0
                    ? keywords
                        .map(
                          (k) =>
                            `<span class="worldbook-entry-keyword">${escapeHtml(
                              k
                            )}</span>`
                        )
                        .join("")
                    : '<span style="color: #999; font-size: 0.8rem;">无关键词（始终触发）</span>'
                }
              </div>
              <div class="worldbook-entry-content">${escapeHtml(
                entry.content || ""
              )}</div>
            </div>
          `;
          })
          .join("");
      }

      // 添加条目
      function addWorldbookEntry() {
        editingEntryIndex = null;
        document.getElementById("worldbookEntryModalTitle").textContent =
          "添加条目";
        document.getElementById("entryCommentInput").value = "";
        document.getElementById("entryKeywordsInput").value = "";
        document.getElementById("entryContentInput").value = "";
        document.getElementById("worldbookEntryModal").classList.add("active");
      }

      // 编辑条目
      function editWorldbookEntry(index) {
        editingEntryIndex = index;
        const entry = tempWorldbookEntries[index];

        document.getElementById("worldbookEntryModalTitle").textContent =
          "编辑条目";
        document.getElementById("entryCommentInput").value =
          entry.comment || "";
        document.getElementById("entryKeywordsInput").value =
          entry.keywords || "";
        document.getElementById("entryContentInput").value =
          entry.content || "";
        document.getElementById("worldbookEntryModal").classList.add("active");
      }

      // 关闭条目编辑弹窗
      function closeWorldbookEntryModal() {
        document
          .getElementById("worldbookEntryModal")
          .classList.remove("active");
        editingEntryIndex = null;
      }

      // 保存条目
      function saveWorldbookEntry() {
        const comment = document
          .getElementById("entryCommentInput")
          .value.trim();
        const keywords = document
          .getElementById("entryKeywordsInput")
          .value.trim();
        const content = document
          .getElementById("entryContentInput")
          .value.trim();

        if (!content) {
          showToast("请输入条目内容");
          return;
        }

        const entry = {
          comment: comment,
          keywords: keywords,
          content: content,
          enabled: true,
        };

        if (editingEntryIndex !== null) {
          tempWorldbookEntries[editingEntryIndex] = entry;
        } else {
          tempWorldbookEntries.push(entry);
        }

        closeWorldbookEntryModal();
        renderWorldbookEntries();
      }

      // 删除条目
      function deleteWorldbookEntry(index) {
        if (!confirm("确定要删除这个条目吗？")) return;
        tempWorldbookEntries.splice(index, 1);
        renderWorldbookEntries();
      }

      // 切换条目启用状态
      function toggleEntryEnabled(index) {
        tempWorldbookEntries[index].enabled =
          tempWorldbookEntries[index].enabled === false ? true : false;
        renderWorldbookEntries();
      }

      // 分组管理
      function openWorldbookGroupManager() {
        renderWorldbookGroupList();
        document.getElementById("worldbookGroupModal").classList.add("active");
      }

      function closeWorldbookGroupManager() {
        document
          .getElementById("worldbookGroupModal")
          .classList.remove("active");
      }

      function renderWorldbookGroupList() {
        const listEl = document.getElementById("worldbookGroupList");

        if (worldbookGroups.length === 0) {
          listEl.innerHTML =
            '<div style="text-align: center; padding: 20px; color: #999;">暂无分组</div>';
          return;
        }

        listEl.innerHTML = worldbookGroups
          .map(
            (group) => `
          <div class="worldbook-group-item">
            <span class="worldbook-group-item-name">📁 ${escapeHtml(
              group.name
            )}</span>
            <button class="worldbook-group-item-delete" onclick="deleteWorldbookGroup('${
              group.id
            }')">✕</button>
          </div>
        `
          )
          .join("");
      }

      function addWorldbookGroup() {
        const input = document.getElementById("worldbookNewGroupInput");
        const name = input.value.trim();

        if (!name) {
          showToast("请输入分组名称");
          return;
        }

        if (worldbookGroups.some((g) => g.name === name)) {
          showToast("分组名称已存在");
          return;
        }

        worldbookGroups.push({
          id: "wbg_" + Date.now(),
          name: name,
        });

        localforage.setItem("worldbookGroups", worldbookGroups);
        input.value = "";
        renderWorldbookGroupList();
        renderWorldbookTabs();
        showToast("分组已添加");
      }

      function deleteWorldbookGroup(id) {
        const group = worldbookGroups.find((g) => g.id === id);
        if (!group) return;

        if (
          !confirm(
            `确定要删除分组"${group.name}"吗？\n该分组下的世界书将变为未分组。`
          )
        )
          return;

        // 将该分组下的世界书移到未分组
        worldbooks.forEach((wb) => {
          if (wb.group === id) wb.group = "";
        });

        worldbookGroups = worldbookGroups.filter((g) => g.id !== id);

        localforage.setItem("worldbookGroups", worldbookGroups);
        localforage.setItem("worldbooks", worldbooks);

        renderWorldbookGroupList();
        renderWorldbookTabs();
        renderWorldbooks();
        showToast("分组已删除");
      }

      // 聊天设置中渲染世界书选择列表
      function renderWorldbookSelectList(selectedIds = []) {
        const container = document.getElementById("settingsWorldbookArea");

        if (worldbooks.length === 0) {
          container.innerHTML =
            '<div class="worldbook-select-empty">还没有世界书，去创建一本吧~</div>';
          return;
        }

        // 只显示启用的世界书
        const enabledBooks = worldbooks.filter((wb) => wb.enabled !== false);

        if (enabledBooks.length === 0) {
          container.innerHTML =
            '<div class="worldbook-select-empty">没有可用的世界书</div>';
          return;
        }

        container.innerHTML = enabledBooks
          .map((wb) => {
            const isSelected = selectedIds.includes(wb.id);
            const entryCount = wb.entries
              ? wb.entries.filter((e) => e.enabled !== false).length
              : 0;

            return `
            <div class="worldbook-select-item ${
              isSelected ? "selected" : ""
            }" onclick="toggleWorldbookInSettings('${wb.id}')">
              <div class="worldbook-select-checkbox"></div>
              <div class="worldbook-select-info">
                <div class="worldbook-select-name">≡ ${escapeHtml(
                  wb.name
                )}</div>
                <div class="worldbook-select-desc">${entryCount} 条启用条目 · ${escapeHtml(
              wb.description || "暂无描述"
            )}</div>
              </div>
            </div>
          `;
          })
          .join("");
      }

      // 切换聊天设置中的世界书选中状态
      function toggleWorldbookInSettings(id) {
        const input = document.getElementById("settingsWorldbook");
        let selectedIds = input.value
          ? input.value.split(",").filter((s) => s)
          : [];

        if (selectedIds.includes(id)) {
          selectedIds = selectedIds.filter((s) => s !== id);
        } else {
          selectedIds.push(id);
        }

        input.value = selectedIds.join(",");
        renderWorldbookSelectList(selectedIds);
      }

      // 获取世界书内容用于AI（核心功能）
      function getWorldbookContentForAI(worldbookIds, chatContent) {
        if (!worldbookIds || worldbookIds.length === 0) return "";

        const contentParts = [];

        worldbookIds.forEach((wbId) => {
          const wb = worldbooks.find(
            (w) => w.id === wbId && w.enabled !== false
          );
          if (!wb || !wb.entries) return;

          wb.entries.forEach((entry) => {
            if (entry.enabled === false) return;

            // 检查关键词是否匹配
            if (entry.keywords && entry.keywords.trim()) {
              const keywords = entry.keywords
                .split(",")
                .map((k) => k.trim().toLowerCase())
                .filter((k) => k);
              const chatLower = chatContent.toLowerCase();

              // 检查是否有任何关键词出现在聊天内容中
              const matched = keywords.some((kw) => chatLower.includes(kw));
              if (!matched) return;
            }

            // 没有关键词或关键词匹配，加入内容
            if (entry.content) {
              contentParts.push(entry.content);
            }
          });
        });

        if (contentParts.length === 0) return "";

        return `\n[World Book / Lore]:\n${contentParts.join("\n\n")}\n`;
      }

      // ==================== 将所有onclick需要的函数挂载到window ====================
      Object.assign(window, {
        // 页面导航
        openPage,
        closePage,
        // 编辑模态框
        openEditModal,
        closeEditModal,
        saveEdit,
        // 标签编辑
        openTagEditModal,
        closeTagEditModal,
        saveTagEdit,
        // 恋爱纪念组件
        openLoveEditModal,
        closeLoveEditModal,
        saveLoveEdit,
        handleLoveAvatarUpload,
        handleLoveWidgetClick,
        handleLoveWidgetBgUpload,
        closeLoveWidgetOptionsModal,
        triggerLoveWidgetBgUpload,
        setLoveWidgetTextColor,
        // 聊天标签切换
        switchChatTab,
        handleHeaderBtn,
        // 角色管理
        openCreateCharModal,
        closeCreateCharModal,
        createCharacter,
        openConversation,
        closeConversation,
        deleteCharacter,
        blockCharacter,
        // API设置
        openApiPresetModal,
        closeApiPresetModal,
        selectApiPreset,
        editApiPreset,
        saveApiPreset,
        deleteApiPreset,
        togglePresetKeyVisibility,
        selectPresetModel,
        renderModelDropdown,
        // 聊天设置
        openChatSettings,
        closeChatSettings,
        saveChatSettings,
        toggleAvatarDisplay,
        updateAvatarSizePreview,
        saveAvatarSize,
        applyAvatarSize,
        applyAvatarVisibility,
        // 分组管理
        openGroupManager,
        closeGroupManager,
        addNewGroup,
        deleteGroup,
        toggleGroup,
        togglePinContact,
        // 气泡颜色选择
        setUserBubbleColor,
        setAiBubbleColor,
        // 聊天搜索
        searchChatHistory,
        clearSettingsAvatar,
        selectRadio,
        showToast,
        // 新消息通知系统
        showMessageNotification,
        handleNotificationClick,
        addUnreadMessage,
        clearUnreadForChar,
        updateMessagesBadge,
        addUnreadMoment,
        clearUnreadMoments,
        updateMomentsBadge,
        // 聊天功能
        sendUserMessage,
        clearChatHistory,
        clearChatHistoryFromSettings,
        // 气泡和消息操作
        handleBubbleClick,
        handleWrapperClick,
        handleCopyMsg,
        handleQuoteMsg,
        cancelQuote,
        handleRecallMsg,
        handleDeleteMsg,
        handleEditMsg,
        hideContextMenu,
        deleteSelectedMessages,
        exitSelectionMode,
        handleMultiSelect,
        showRecalledContent,
        // 气泡间距
        updateBubbleGapPreview,
        saveBubbleGap,
        applyBubbleGap,
        // 摘要功能
        triggerManualSummary,
        viewSummaries,
        startEditSummary,
        cancelEditSummary,
        saveSummaryEdit,
        closeSummaryModal,
        // 字体设置
        switchFontSource,
        previewCustomFont,
        saveFontPreset,
        activateFont,
        applySystemFont,
        deleteFontPreset,
        // 气泡样式
        manageBubbleStyles,
        exportBubbleStyle,
        importBubbleStyle,
        resetCustomCSS,
        // 聊天历史导入导出
        importChatHistory,
        exportChatHistory,
        // 好友分组
        manageFriendGroups,
        // 用户人设预设
        saveUserPersonaPreset,
        // 语音功能
        switchVoiceUrl,
        saveVoiceConfig,
        toggleVoiceText,
        playVoiceMessage,
        playInlineVoice,
        handleVoiceBubbleTouchStart,
        handleVoiceBubbleTouchEnd,
        // 聊天面板
        toggleChatPanel,
        closeChatPanel,
        // 多媒体消息
        sendRedPacket,
        sendNudge,
        handleCameraAction,
        sendFakeLocation,
        showFullImage,
        // 位置功能
        closeLocationModal,
        confirmSendLocation,
        aiSendLocation,
        // 钱包功能
        initWalletData,
        saveWalletData,
        updateWalletDisplay,
        openWalletPage,
        closeWalletPage,
        renderWalletHistoryPage,
        openRechargeModal,
        closeRechargeModal,
        selectRechargeAmount,
        clearRechargeSelection,
        confirmRecharge,
        // 转账功能
        openTransferModal,
        closeTransferModal,
        confirmTransfer,
        updateUserTransferStatus,
        acceptAITransfer,
        rejectAITransfer,
        // 重Roll功能
        rerollAIReply,
        // 通话功能
        startVoiceCall,
        startVideoCall,
        endCall,
        acceptCall,
        declineCall,
        toggleSpeaker,
        saveCallSettings,
        aiInitiateCall,
        acceptIncomingCall,
        declineIncomingCall,
        sendCallMessage,
        handleCallInputKeydown,
        toggleVideoSelf,
        handleVideoCallImageUpload,
        clearVideoCallImage,
        minimizeCall,
        restoreCall,
        showCallTypingIndicator,
        rerollCallResponse,
        previewCallBubbleColor,
        applyCallBubbleColors,
        loadCallBubbleColors,
        // 触摸处理
        handleTouchStart,
        handleTouchMove,
        handleTouchEnd,
        handleMouseDown,
        handleMouseUp,
        // 一起读书
        openReadTogether,
        closeReadTogether,
        handleBookImport,
        readPrevSection,
        readNextSection,
        jumpToSection,
        selectBook,
        startReading,
        stopCurrentReading,
        deleteBook,
        startFloatingMode,
        showFloatingBtn,
        hideFloatingBtn,
        toggleFloatingPanel,
        hideFloatingPanel,
        updateFloatingPanel,
        getCurrentReadingContent,
        advanceReadingProgress,
        // AI表情包绑定
        openAiBindModal,
        closeAiBindModal,
        toggleAiBindCategory,
        saveAiBindings,
        // 待办事项
        openTodoModal,
        closeTodoModal,
        saveTodoItem,
        toggleTodoDone,
        notifyAiTodoCompleted,
        deleteTodoItem,
        filterTodos,
        selectTodoTag,
        toggleTodoAiBinding,
        aiGreetForTodoBinding,
        renderTodoAiCharList,
        renderTodoTagSelect,
        // 待办设置
        openTodoSettingsModal,
        closeTodoSettingsModal,
        saveTodoSettings,
        addTodoCategory,
        deleteTodoCategory,
        loadGreetingForEdit,
        saveGreeting,
        // 经期记录
        openPeriodModal,
        closePeriodModal,
        savePeriodSettings,
        recordPeriodStart,
        // Instagram动态系统
        initMomentsSystem,
        renderMomentsUI,
        renderStoriesBar,
        renderFeed,
        openPostModal,
        closePostModal,
        selectImageOption,
        handleImageSelect,
        removeImage,
        checkPostValid,
        submitPost,
        renderVisibilityOptions,
        selectVisibility,
        toggleVisibilityGroup,
        toggleLike,
        toggleBookmark,
        openComments,
        closeCommentsModal,
        sendComment,
        setReplyTo,
        openPostMenu,
        closePostMenu,
        deletePost,
        confirmDeletePost,
        sharePostToChat,
        closeShareModal,
        confirmShareToChat,
        openProfileModal,
        closeProfileModal,
        handleAvatarSelect,
        openEmojiPicker,
        saveProfile,
        showCharacterPosts,
        generateMomentsPromptForAi,
        // 外观设置
        previewWallpaper,
        resetWallpaper,
        setFontColor,
        previewAppIcon,
        saveAppearanceSettings,
        loadAppearanceSettings,
        applyAppearanceSettings,
        initAppearancePage,
        // 世界书系统
        renderWorldbooks,
        renderWorldbookTabs,
        filterWorldbookByGroup,
        handleWorldbookItemClick,
        toggleWorldbookBatchMode,
        cancelWorldbookBatch,
        toggleWorldbookSelect,
        deleteSelectedWorldbooks,
        openWorldbookMoveModal,
        closeWorldbookMoveModal,
        moveWorldbooksToGroup,
        openWorldbookModal,
        closeWorldbookModal,
        editWorldbook,
        deleteWorldbook,
        toggleWorldbookEnabled,
        saveWorldbook,
        renderWorldbookEntries,
        addWorldbookEntry,
        editWorldbookEntry,
        closeWorldbookEntryModal,
        saveWorldbookEntry,
        deleteWorldbookEntry,
        toggleEntryEnabled,
        openWorldbookGroupManager,
        closeWorldbookGroupManager,
        addWorldbookGroup,
        deleteWorldbookGroup,
        renderWorldbookSelectList,
        toggleWorldbookInSettings,
        getWorldbookContentForAI,
        // 预设系统
        initPresetSystem,
        renderPresets,
        switchPresetTab,
        openPresetModal,
        closePresetModal,
        savePreset,
        editPreset,
        deleteSinglePreset,
        exportPreset,
        handlePresetClick,
        startPresetBatchMode,
        togglePresetSelect,
        cancelPresetBatch,
        deleteSelectedPresets,
        openPresetImportModal,
        closePresetImportModal,
        importPresetFromFile,
        handlePresetFileImport,
        importPresetFromClipboard,
        importPresetData,
        toggleOfflineSettings,
        updateOfflinePresetDropdown,
        onOfflinePresetChange,
        // 预设条目相关
        renderPresetEntries,
        addPresetEntry,
        togglePresetEntry,
        updatePresetEntry,
        deletePresetEntry,
        toggleEntryContent,
        presetEscapeHtml,
        loadMorePresetEntries,
      });
      console.log("✓ 所有函数已挂载到window");
      // 🆕 智能解析文本：自动识别 "关键词：URL" 格式
      function parseStickersFromText(text) {
        const lines = text.split(/\r?\n/); // 按行分割
        const results = [];

        // 匹配 URL 的正则
        const urlRegex = /(https?:\/\/[^\s"']+)/;

        lines.forEach((line) => {
          line = line.trim();
          if (!line) return;

          // 1. 先找有没有 URL
          const urlMatch = line.match(urlRegex);
          if (urlMatch) {
            const url = urlMatch[0];
            let desc = ""; // 默认空，稍后处理

            // 2. 找分隔符 (中文冒号 或 英文冒号)
            // 也就是找 URL 前面的部分
            const sepRegex = /[:：]/;
            const match = line.match(sepRegex);

            if (match && match.index < line.indexOf("http")) {
              // 如果冒号在 http 之前，说明冒号前是描述
              desc = line.substring(0, match.index).trim();
            }

            // 3. 存入结果
            results.push({
              src: url,
              desc: desc, // 如果没找到冒号，这里就是空字符串
            });
          }
        });

        return results;
      }
    </script>
    <div
      class="context-menu-overlay"
      id="contextMenuOverlay"
      onclick="hideContextMenu()"
    >
      <div class="context-menu" id="contextMenu"></div>
    </div>

    <div class="selection-footer" id="selectionFooter">
      <button class="selection-btn cancel" onclick="exitSelectionMode()">
        取消
      </button>
      <span
        style="font-size: 1rem; font-weight: 600; color: #333"
        id="selectionCount"
        >已选 0 条</span
      >
      <button
        class="selection-btn delete"
        id="multiDeleteBtn"
        onclick="deleteSelectedMessages()"
      >
        ✕ 删除
      </button>
    </div>

    <!-- 新消息通知弹窗 -->
    <div
      class="message-notification"
      id="messageNotification"
      onclick="handleNotificationClick()"
    >
      <div class="notification-avatar" id="notificationAvatar">AI</div>
      <div class="notification-content">
        <div class="notification-name" id="notificationName">角色名</div>
        <div class="notification-text" id="notificationText">消息内容</div>
      </div>
      <div class="notification-time" id="notificationTime">刚刚</div>
    </div>

    <!-- 钱包详情页 -->
    <div class="wallet-page" id="walletPage">
      <div class="wallet-page-header">
        <button class="wallet-page-back" onclick="closeWalletPage()">‹</button>
        <span>我的钱包</span>
        <span style="width: 30px"></span>
      </div>
      <div class="wallet-page-content">
        <div class="wallet-balance-card">
          <div class="wallet-balance-label">账户余额（元）</div>
          <div class="wallet-balance-value" id="walletBalanceDisplay">0.00</div>
          <div class="wallet-balance-actions">
            <button class="wallet-action-btn" onclick="openRechargeModal()">
              <span>💳</span>
              <span>充值</span>
            </button>
          </div>
        </div>
        <div class="wallet-history-section">
          <div class="wallet-history-title">交易记录</div>
          <div class="wallet-history-list" id="walletHistoryListPage">
            <div class="wallet-history-empty">暂无交易记录</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 充值弹窗 -->
    <div
      class="recharge-modal"
      id="rechargeModal"
      onclick="if(event.target===this)closeRechargeModal()"
    >
      <div class="recharge-modal-content">
        <div class="recharge-modal-title">¥ 钱包充值</div>
        <div class="recharge-amount-grid">
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(10)"
          >
            ¥10
          </button>
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(50)"
          >
            ¥50
          </button>
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(100)"
          >
            ¥100
          </button>
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(200)"
          >
            ¥200
          </button>
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(500)"
          >
            ¥500
          </button>
          <button
            class="recharge-amount-btn"
            onclick="selectRechargeAmount(1000)"
          >
            ¥1000
          </button>
        </div>
        <input
          type="number"
          class="recharge-custom-input"
          id="rechargeCustomAmount"
          placeholder="自定义金额"
          oninput="clearRechargeSelection()"
        />
        <div class="recharge-modal-btns">
          <button
            class="recharge-modal-btn cancel"
            onclick="closeRechargeModal()"
          >
            取消
          </button>
          <button
            class="recharge-modal-btn confirm"
            onclick="confirmRecharge()"
          >
            确认充值
          </button>
        </div>
      </div>
    </div>

    <!-- 转账弹窗 -->
    <div
      class="send-transfer-modal"
      id="sendTransferModal"
      onclick="if(event.target===this)closeTransferModal()"
    >
      <div class="send-transfer-modal-content">
        <div class="send-transfer-title">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="vertical-align: middle; margin-right: 6px"
          >
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path
              d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
            ></path></svg
          >转账给TA
        </div>
        <div class="send-transfer-to" id="transferToName">转给：角色名</div>
        <!-- 群聊成员选择列表 -->
        <div
          id="transferMemberSelect"
          style="
            display: none;
            margin: 12px 0;
            max-height: 150px;
            overflow-y: auto;
          "
        ></div>
        <input
          type="number"
          class="send-transfer-input"
          id="transferAmountInput"
          placeholder="0.00"
        />
        <div class="send-transfer-balance" id="transferBalanceHint">
          可用余额：¥0.00
        </div>
        <input
          type="text"
          class="send-transfer-note-input"
          id="transferNoteInput"
          placeholder="添加转账说明（可选）"
        />
        <div class="recharge-modal-btns">
          <button
            class="recharge-modal-btn cancel"
            onclick="closeTransferModal()"
          >
            取消
          </button>
          <button
            class="recharge-modal-btn confirm"
            onclick="confirmTransfer()"
          >
            确认转账
          </button>
        </div>
      </div>
    </div>

    <!-- 位置选择弹窗 -->
    <div
      class="send-transfer-modal"
      id="locationModal"
      onclick="if(event.target===this)closeLocationModal()"
    >
      <div class="send-transfer-modal-content">
        <div class="send-transfer-title">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="vertical-align: middle; margin-right: 6px"
          >
            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
            <circle cx="12" cy="10" r="3"></circle></svg
          >发送位置
        </div>
        <div style="margin-bottom: 16px">
          <input
            type="text"
            class="send-transfer-note-input"
            id="locationNameInput"
            placeholder="位置名称，如：星巴克咖啡"
            style="margin-bottom: 8px"
          />
          <input
            type="text"
            class="send-transfer-note-input"
            id="locationAddressInput"
            placeholder="详细地址（可选）"
          />
        </div>
        <div class="recharge-modal-btns">
          <button
            class="recharge-modal-btn cancel"
            onclick="closeLocationModal()"
          >
            取消
          </button>
          <button
            class="recharge-modal-btn confirm"
            onclick="confirmSendLocation()"
          >
            发送位置
          </button>
        </div>
      </div>
    </div>

    <!-- 通话悬浮球 -->
    <div
      class="call-floating-bubble"
      id="callFloatingBubble"
      onclick="restoreCall()"
    >
      <span id="floatingBubbleAvatar"
        ><svg
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path
            d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
          ></path></svg
      ></span>
      <img id="floatingBubbleImg" src="" style="display: none" />
    </div>

    <!-- 通话界面 -->
    <div class="call-overlay voice-call" id="callOverlay">
      <!-- 视频通话 - 对方画面（全屏） -->
      <div class="video-main" id="videoMain" onclick="toggleVideoSelf()">
        <img id="videoMainImg" src="" style="display: none" />
        <div class="video-main-placeholder" id="videoMainPlaceholder">
          <div class="avatar-large">
            <span id="videoMainAvatarPlaceholder">AI</span>
            <img id="videoMainAvatarImg" src="" style="display: none" />
          </div>
          <span id="videoMainName">等待接通...</span>
        </div>
      </div>

      <!-- 视频通话 - 我的画面（小窗口，可点击切换） -->
      <div class="video-self" id="videoSelf" onclick="toggleVideoSelf()">
        <img id="videoSelfImg" src="" style="display: none" />
        <div class="video-self-placeholder" id="videoSelfPlaceholder">我</div>
      </div>

      <!-- 新的顶部栏 - 左边最小化按钮，中间头像+名字+时间 -->
      <div class="call-top-bar" id="callTopBar">
        <button
          class="call-minimize-btn"
          onclick="minimizeCall()"
          title="最小化"
        >
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="4 14 10 14 10 20"></polyline>
            <polyline points="20 10 14 10 14 4"></polyline>
            <line x1="14" y1="10" x2="21" y2="3"></line>
            <line x1="3" y1="21" x2="10" y2="14"></line>
          </svg>
        </button>
        <div class="call-top-info">
          <div class="call-top-avatar" id="callTopAvatar">
            <span id="callTopAvatarPlaceholder">AI</span>
            <img id="callTopAvatarImg" src="" style="display: none" />
          </div>
          <div class="call-top-name" id="callTopName">角色名</div>
          <div class="call-top-timer" id="callTopTimer">正在呼叫...</div>
        </div>
      </div>

      <!-- 旧的头像区域（隐藏） -->
      <div
        class="call-avatar-section"
        id="callAvatarSection"
        style="display: none"
      >
        <div class="call-avatar" id="callAvatar">
          <span id="callAvatarPlaceholder">AI</span>
          <img id="callAvatarImg" src="" style="display: none" />
        </div>
        <div class="call-name" id="callName">角色名</div>
        <div class="call-status" id="callStatus">正在呼叫...</div>
        <div class="call-timer" id="callTimer" style="display: none">00:00</div>
      </div>

      <!-- 隐藏的兼容元素 -->
      <span id="videoCallTimer" style="display: none">00:00</span>
      <span id="videoCallName" style="display: none"></span>

      <!-- 对话区域 -->
      <div class="call-conversation" id="callConversation">
        <div class="call-messages-wrapper" id="callMessagesWrapper">
          <!-- 消息会动态添加到这里 -->
        </div>
        <!-- AI正在输入指示器 -->
        <div class="call-typing-indicator" id="callTypingIndicator">
          <span></span><span></span><span></span>
        </div>
      </div>

      <!-- 输入区域 -->
      <div class="call-input-area" id="callInputArea">
        <div class="call-input-row">
          <textarea
            class="call-input"
            id="callInput"
            placeholder="说点什么..."
            rows="1"
            onkeydown="handleCallInputKeydown(event)"
          ></textarea>
          <button class="call-send-btn" onclick="sendCallMessage()">
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </div>
      </div>

      <!-- 按钮区域 -->
      <div class="call-buttons-area">
        <!-- 呼叫中的按钮 -->
        <div class="call-buttons" id="callCallingBtns">
          <button class="call-btn end-call" onclick="endCall()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
        </div>

        <!-- 来电的按钮 -->
        <div
          class="call-incoming-buttons"
          id="callIncomingBtns"
          style="display: none"
        >
          <button class="call-btn end-call" onclick="declineCall()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
          <button class="call-btn accept-call" onclick="acceptCall()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
        </div>

        <!-- 通话中的按钮 - 重回、挂断、扬声器 -->
        <div class="call-buttons" id="callInCallBtns" style="display: none">
          <button
            class="call-btn reroll-btn"
            onclick="rerollCallResponse()"
            title="重新回复"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="23 4 23 10 17 10"></polyline>
              <polyline points="1 20 1 14 7 14"></polyline>
              <path
                d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
              ></path>
            </svg>
          </button>
          <button class="call-btn end-call" onclick="endCall()">
            <svg
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
          <button
            class="call-btn speaker-btn"
            id="speakerBtn"
            onclick="toggleSpeaker()"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
              <path
                d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- 来电全屏界面 -->
    <div class="incoming-call-overlay" id="incomingCallOverlay">
      <div class="incoming-call-top">
        <div class="incoming-call-label">来电</div>
        <div class="incoming-call-avatar-wrap">
          <div class="incoming-call-ring"></div>
          <div class="incoming-call-ring"></div>
          <div class="incoming-call-ring"></div>
          <div class="incoming-call-avatar" id="incomingCallAvatar">
            <span id="incomingCallAvatarPlaceholder">AI</span>
            <img id="incomingCallAvatarImg" src="" style="display: none" />
          </div>
        </div>
        <div class="incoming-call-name" id="incomingCallName">角色名</div>
        <div class="incoming-call-type" id="incomingCallType">
          <span class="incoming-call-type-icon" id="incomingCallTypeIcon"
            ><svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path></svg
          ></span>
          <span id="incomingCallTypeText">语音通话</span>
        </div>
      </div>

      <div class="incoming-call-actions">
        <div class="incoming-call-btn-wrap">
          <button
            class="incoming-call-btn decline"
            onclick="declineIncomingCall()"
          >
            <svg
              width="28"
              height="28"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
          <span class="incoming-call-btn-label">拒绝</span>
        </div>
        <div class="incoming-call-btn-wrap">
          <button
            class="incoming-call-btn accept"
            onclick="acceptIncomingCall()"
          >
            <svg
              width="28"
              height="28"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path
                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
              ></path>
            </svg>
          </button>
          <span class="incoming-call-btn-label">接听</span>
        </div>
      </div>
    </div>

    <!-- 发送图片选择弹窗 -->
    <div
      class="send-image-modal"
      id="sendImageModal"
      onclick="if(event.target===this)closeSendImageModal()"
    >
      <div class="send-image-options">
        <div class="send-image-title">发送图片</div>
        <div class="send-image-grid two-cols">
          <div class="send-image-item" onclick="selectRealImage()">
            <div class="send-image-icon album">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
            </div>
            <span class="send-image-label">选择图片</span>
            <span class="send-image-hint">相册/拍照/文件</span>
          </div>
          <div class="send-image-item" onclick="openDescImageModal()">
            <div class="send-image-icon desc">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path
                  d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                ></path>
                <path
                  d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                ></path>
              </svg>
            </div>
            <span class="send-image-label">描述图</span>
            <span class="send-image-hint">用文字描述图片</span>
          </div>
        </div>
        <button class="send-image-cancel" onclick="closeSendImageModal()">
          取消
        </button>
      </div>
    </div>

    <!-- 图片描述查看/编辑弹窗 -->
    <div
      class="image-desc-modal"
      id="imageDescModal"
      onclick="if(event.target===this)closeImageDescModal()"
    >
      <div class="image-desc-content">
        <div class="image-desc-header">
          <span class="image-desc-title" id="imageDescTitle">图片描述</span>
          <button class="image-desc-close" onclick="closeImageDescModal()">
            ✕
          </button>
        </div>
        <div class="image-desc-body">
          <div class="image-desc-preview" id="imageDescPreview">
            <div class="image-desc-preview-icon">
              <svg
                width="40"
                height="40"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
              </svg>
              <span style="font-size: 0.8rem">点击查看描述</span>
            </div>
          </div>
          <!-- 查看模式 -->
          <div
            class="image-desc-text"
            id="imageDescText"
            style="display: none"
          ></div>
          <!-- 编辑模式 -->
          <textarea
            class="image-desc-input"
            id="imageDescInput"
            placeholder="描述这张图片的内容...&#10;例如：一张夕阳下海边的照片，金色的阳光洒在海面上..."
            style="display: none"
          ></textarea>
        </div>
        <div
          class="image-desc-footer"
          id="imageDescFooter"
          style="display: none"
        >
          <button class="image-desc-btn cancel" onclick="closeImageDescModal()">
            取消
          </button>
          <button
            class="image-desc-btn confirm"
            onclick="confirmSendDescImage()"
          >
            发送
          </button>
        </div>
      </div>
    </div>

    <!-- 图片查看弹窗 -->
    <div
      class="image-desc-modal"
      id="imageViewModal"
      onclick="closeImageViewModal()"
    >
      <div style="max-width: 90%; max-height: 80vh">
        <img
          id="imageViewImg"
          src=""
          style="max-width: 100%; max-height: 80vh; border-radius: 12px"
        />
      </div>
    </div>

    <!-- 隐藏的图片输入 -->
    <input
      type="file"
      id="realImageInput"
      hidden
      accept="image/*"
      onchange="handleRealImageSelect(this)"
    />
  </body>
</html>
